---
description: Obtenga información acerca de cómo evitar bloqueos en aplicaciones Windows para plataformas Windows 7 y Windows Server 2008 R2.
ms.assetid: 698a046b-1934-49cd-a717-d61e7e1ec534
title: Prevención de bloqueos en aplicaciones de Windows
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 35a2d8fac95039f20c8c684c50138933c54750c3
ms.sourcegitcommit: af9983bab40fe0b042f177ce7ca79f2eb0f9d0e8
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 02/06/2021
ms.locfileid: "104083526"
---
# <a name="preventing-hangs-in-windows-applications"></a><span data-ttu-id="2dcb6-103">Prevención de bloqueos en aplicaciones de Windows</span><span class="sxs-lookup"><span data-stu-id="2dcb6-103">Preventing Hangs in Windows Applications</span></span>

## <a name="affected-platforms"></a><span data-ttu-id="2dcb6-104">Plataformas afectadas</span><span class="sxs-lookup"><span data-stu-id="2dcb6-104">Affected Platforms</span></span>

<span data-ttu-id="2dcb6-105">**Clientes** : Windows 7</span><span class="sxs-lookup"><span data-stu-id="2dcb6-105">**Clients** - Windows 7</span></span>  
<span data-ttu-id="2dcb6-106">**Servidores** : Windows Server 2008 R2</span><span class="sxs-lookup"><span data-stu-id="2dcb6-106">**Servers** - Windows Server 2008 R2</span></span>  









## <a name="description"></a><span data-ttu-id="2dcb6-107">Descripción</span><span class="sxs-lookup"><span data-stu-id="2dcb6-107">Description</span></span>

<span data-ttu-id="2dcb6-108">**Bloqueos: perspectiva del usuario**</span><span class="sxs-lookup"><span data-stu-id="2dcb6-108">**Hangs - User Perspective**</span></span>

<span data-ttu-id="2dcb6-109">Usuarios como aplicaciones con capacidad de respuesta.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-109">Users like responsive applications.</span></span> <span data-ttu-id="2dcb6-110">Cuando hacen clic en un menú, quieren que la aplicación reaccione al instante, incluso si está imprimiendo su trabajo en ese momento.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-110">When they click a menu, they want the application to react instantly, even if it is currently printing their work.</span></span> <span data-ttu-id="2dcb6-111">Cuando guardan un documento largo en su procesador de textos favorito, quieren seguir escribiendo mientras el disco sigue girando.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-111">When they save a lengthy document in their favorite word processor, they want to continue typing while the disk is still spinning.</span></span> <span data-ttu-id="2dcb6-112">Los usuarios reciben un poco más rápido cuando la aplicación no reacciona de manera oportuna a su entrada.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-112">Users get impatient rather quickly when the application does not react in a timely fashion to their input.</span></span>

<span data-ttu-id="2dcb6-113">Un programador podría reconocer muchas razones legítimas para que una aplicación no responda instantáneamente a los datos proporcionados por el usuario.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-113">A programmer might recognize many legitimate reasons for an application not to instantly respond to user input.</span></span> <span data-ttu-id="2dcb6-114">Es posible que la aplicación esté ocupada recalculando algunos datos o simplemente esperando a que se complete la e/s de disco.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-114">The application might be busy recalculating some data, or simply waiting for its disk I/O to complete.</span></span> <span data-ttu-id="2dcb6-115">Sin embargo, a partir de la investigación del usuario, sabemos que los usuarios se sienten molestados y frustrados después de un par de segundos de falta de respuesta.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-115">However, from user research, we know that users get annoyed and frustrated after just a couple of seconds of unresponsiveness.</span></span> <span data-ttu-id="2dcb6-116">Después de 5 segundos, intentarán terminar una aplicación bloqueada.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-116">After 5 seconds, they will try to terminate a hung application.</span></span> <span data-ttu-id="2dcb6-117">Junto a bloqueos, la aplicación deja de responder a la causa más común de la interrupción del usuario cuando se trabaja con aplicaciones Win32.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-117">Next to crashes, application hangs are the most common source of user disruption when working with Win32 applications.</span></span>

<span data-ttu-id="2dcb6-118">Hay muchas causas raíz diferentes para los bloqueos de la aplicación y no todas ellas se manifiestan en una interfaz de usuario que no responde.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-118">There are many different root causes for application hangs, and not all of them manifest themselves in an unresponsive UI.</span></span> <span data-ttu-id="2dcb6-119">Sin embargo, una interfaz de usuario que no responde es una de las experiencias más comunes de bloqueo, y este escenario recibe actualmente la mayor parte de la compatibilidad con el sistema operativo para la detección y la recuperación.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-119">However, an unresponsive UI is one of the most common hang experiences, and this scenario currently receives the most operating system support for both detection as well as recovery.</span></span> <span data-ttu-id="2dcb6-120">Windows detecta automáticamente, recopila información de depuración y, opcionalmente, finaliza o reinicia las aplicaciones bloqueadas.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-120">Windows automatically detects, collects debug information, and optionally terminates or restarts hung applications.</span></span> <span data-ttu-id="2dcb6-121">De lo contrario, es posible que el usuario tenga que reiniciar el equipo para recuperar una aplicación bloqueada.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-121">Otherwise, the user might have to restart the machine in order to recover a hung application.</span></span>

<span data-ttu-id="2dcb6-122">**Se bloquea: perspectiva del sistema operativo**</span><span class="sxs-lookup"><span data-stu-id="2dcb6-122">**Hangs - Operating System Perspective**</span></span>

<span data-ttu-id="2dcb6-123">Cuando una aplicación (o más concretamente, un subproceso) crea una ventana en el escritorio, entra en un contrato implícito con el Administrador de ventanas de escritorio (DWM) para procesar los mensajes de la ventana de manera oportuna.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-123">When an application (or more accurately, a thread) creates a window on the desktop, it enters into an implicit contract with the Desktop Window Manager (DWM) to process window messages in a timely fashion.</span></span> <span data-ttu-id="2dcb6-124">DWM envía mensajes (entrada de teclado/mouse y mensajes desde otras ventanas, así como a sí mismos) en la cola de mensajes específica del subproceso.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-124">The DWM posts messages (keyboard/mouse input and messages from other windows, as well as itself) into the thread-specific message queue.</span></span> <span data-ttu-id="2dcb6-125">El subproceso recupera y envía los mensajes a través de su cola de mensajes.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-125">The thread retrieves and dispatches those messages via its message queue.</span></span> <span data-ttu-id="2dcb6-126">Si el subproceso no presta servicio a la cola mediante una llamada a GetMessage (), los mensajes no se procesan y la ventana se bloquea: no puede volver a dibujar ni aceptar la entrada del usuario.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-126">If the thread does not service the queue by calling GetMessage(), messages are not processed, and the window hangs: it can neither redraw nor can it accept input from the user.</span></span> <span data-ttu-id="2dcb6-127">El sistema operativo detecta este estado adjuntando un temporizador a los mensajes pendientes en la cola de mensajes.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-127">The operating system detects this state by attaching a timer to pending messages in the message queue.</span></span> <span data-ttu-id="2dcb6-128">Si un mensaje no se ha recuperado en un plazo de 5 segundos, el DWM declara que la ventana está bloqueada.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-128">If a message has not been retrieved within 5 seconds, the DWM declares the window to be hung.</span></span> <span data-ttu-id="2dcb6-129">Puede consultar este estado de ventana concreto a través de la API IsHungAppWindow ().</span><span class="sxs-lookup"><span data-stu-id="2dcb6-129">You can query this particular window state via the IsHungAppWindow() API.</span></span>

<span data-ttu-id="2dcb6-130">La detección es solo el primer paso.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-130">Detection is only the first step.</span></span> <span data-ttu-id="2dcb6-131">En este momento, el usuario todavía no puede incluso terminar la aplicación: al hacer clic en el botón X (cerrar) se produciría un \_ mensaje de cierre de WM, que se bloquearía en la cola de mensajes como cualquier otro mensaje.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-131">At this point, the user still cannot even terminate the application - clicking the X (Close) button would result in a WM\_CLOSE message, which would be stuck in the message queue just like any other message.</span></span> <span data-ttu-id="2dcb6-132">El Administrador de ventanas de escritorio ayuda a ocultar sin problemas y, a continuación, reemplazar la ventana de bloqueo con una copia "fantasma" que muestra un mapa de bits del área cliente anterior de la ventana original (y la adición de "no responde" a la barra de título).</span><span class="sxs-lookup"><span data-stu-id="2dcb6-132">The Desktop Window Manager assists by seamlessly hiding and then replacing the hung window with a 'ghost' copy displaying a bitmap of the original window's previous client area (and adding "Not Responding" to the title bar).</span></span> <span data-ttu-id="2dcb6-133">Siempre que el subproceso de la ventana original no recupere los mensajes, DWM administra ambas ventanas simultáneamente, pero permite que el usuario interactúe solo con la copia fantasma.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-133">As long as the original window's thread does not retrieve messages, the DWM manages both windows simultaneously, but allows the user to interact only with the ghost copy.</span></span> <span data-ttu-id="2dcb6-134">Con esta ventana fantasma, el usuario solo puede moverse, minimizar y, lo que es más importante, cerrar la aplicación que no responde, pero no cambiar su estado interno.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-134">Using this ghost window, the user can only move, minimize, and - most importantly - close the unresponsive application, but not change its internal state.</span></span>

<span data-ttu-id="2dcb6-135">Toda la experiencia de Ghost tiene el siguiente aspecto:</span><span class="sxs-lookup"><span data-stu-id="2dcb6-135">The whole ghost experience looks like this:</span></span>

![Captura de pantalla que muestra el cuadro de diálogo "el Bloc de notas no responde".](images/preventinghangs-ghostwindow.gif)

<span data-ttu-id="2dcb6-137">El Administrador de ventanas de escritorio hace lo último; se integra con Informe de errores de Windows, lo que permite que el usuario no solo cierre y, opcionalmente, reinicie la aplicación, sino que también envíe datos de depuración valiosos a Microsoft.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-137">The Desktop Window Manager does one last thing; it integrates with Windows Error Reporting, allowing the user to not only close and optionally restart the application, but also send valuable debugging data back to Microsoft.</span></span> <span data-ttu-id="2dcb6-138">Puede obtener estos datos de bloqueo para sus propias aplicaciones. para ello, Regístrese en el sitio web de WinQual.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-138">You can get this hang data for your own applications by signing up at the Winqual website.</span></span>

<span data-ttu-id="2dcb6-139">Windows 7 ha agregado una nueva característica a esta experiencia.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-139">Windows 7 added one new feature to this experience.</span></span> <span data-ttu-id="2dcb6-140">El sistema operativo analiza la aplicación bloqueada y, en determinadas circunstancias, proporciona al usuario la opción de cancelar una operación de bloqueo y hacer que la aplicación responda de nuevo.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-140">The operating system analyzes the hung application and, under certain circumstances, gives the user the option to cancel a blocking operation and make the application responsive again.</span></span> <span data-ttu-id="2dcb6-141">La implementación actual admite la cancelación de llamadas de socket de bloqueo. en futuras versiones se podrán cancelar más operaciones por el usuario.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-141">The current implementation supports cancellation of blocking Socket calls; more operations will be user-cancelable in future releases.</span></span>

<span data-ttu-id="2dcb6-142">Para integrar la aplicación con la experiencia de recuperación de bloqueo y sacar el máximo partido de los datos disponibles, siga estos pasos:</span><span class="sxs-lookup"><span data-stu-id="2dcb6-142">To integrate your application with the hang recovery experience and to make the most out of the available data, follow these steps:</span></span>

-   <span data-ttu-id="2dcb6-143">Asegúrese de que la aplicación se registra para el reinicio y la recuperación, lo que permite que el usuario se bloquee de forma tan sencilla como sea posible.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-143">Ensure that your application registers for restart and recovery, making a hang as pain-free as possible to the user.</span></span> <span data-ttu-id="2dcb6-144">Una aplicación correctamente registrada puede reiniciarse automáticamente con la mayoría de los datos no guardados intactos.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-144">A properly registered application can automatically restart with most of its unsaved data intact.</span></span> <span data-ttu-id="2dcb6-145">Esto funciona para los bloqueos y bloqueos de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-145">This works for both application hangs and crashes.</span></span>
-   <span data-ttu-id="2dcb6-146">Obtenga información sobre la frecuencia y depure datos de las aplicaciones bloqueadas y bloqueadas desde el sitio web de WinQual.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-146">Get frequency information as well as debugging data for your hung and crashed applications from the Winqual website.</span></span> <span data-ttu-id="2dcb6-147">Puede usar esta información incluso durante la versión beta para mejorar el código.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-147">You can use this information even during your Beta to improve your code.</span></span> <span data-ttu-id="2dcb6-148">Consulte "Introducing Informe de errores de Windows" para obtener una breve introducción.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-148">See "Introducing Windows Error Reporting" for a brief overview.</span></span>
-   <span data-ttu-id="2dcb6-149">Puede deshabilitar la característica de Ghost en la aplicación a través de una llamada a DisableProcessWindowsGhosting ().</span><span class="sxs-lookup"><span data-stu-id="2dcb6-149">You can disable the ghosting feature in your application via a call to DisableProcessWindowsGhosting ().</span></span> <span data-ttu-id="2dcb6-150">Sin embargo, esto impide que el usuario medio cierre y reinicie una aplicación bloqueada y, a menudo, termina en un reinicio.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-150">However, this prevents the average user from closing and restarting a hung application and often ends in a reboot.</span></span>

<span data-ttu-id="2dcb6-151">**Hanges: perspectiva para desarrolladores**</span><span class="sxs-lookup"><span data-stu-id="2dcb6-151">**Hangs - Developer Perspective**</span></span>

<span data-ttu-id="2dcb6-152">El sistema operativo define un bloqueo de aplicación como un subproceso de interfaz de usuario que no ha procesado mensajes durante al menos 5 segundos.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-152">The operating system defines an application hang as a UI thread that has not processed messages for at least 5 seconds.</span></span> <span data-ttu-id="2dcb6-153">Los errores obvios producen bloqueos, por ejemplo, un subproceso que espera un evento que nunca se señaliza y dos subprocesos mantienen un bloqueo y intentan adquirir los demás.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-153">Obvious bugs cause some hangs, for example, a thread waiting for an event that is never signaled, and two threads each holding a lock and trying to acquire the others.</span></span> <span data-ttu-id="2dcb6-154">Puede corregir estos errores sin demasiado esfuerzo.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-154">You can fix those bugs without too much effort.</span></span> <span data-ttu-id="2dcb6-155">Sin embargo, muchos bloqueos no son tan claros.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-155">However, many hangs are not so clear.</span></span> <span data-ttu-id="2dcb6-156">Sí, el subproceso de la interfaz de usuario no recupera los mensajes, pero está igualmente ocupado en otros trabajos "importantes" y, finalmente, volverá a procesar los mensajes.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-156">Yes, the UI thread is not retrieving messages - but it is equally busy doing other 'important' work and will eventually come back to processing messages.</span></span>

<span data-ttu-id="2dcb6-157">Sin embargo, el usuario percibe esto como un error.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-157">However, the user perceives this as a bug.</span></span> <span data-ttu-id="2dcb6-158">El diseño debe coincidir con las expectativas del usuario.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-158">The design should match the user's expectations.</span></span> <span data-ttu-id="2dcb6-159">Si el diseño de la aplicación conduce a una aplicación que no responde, el diseño tendrá que cambiar.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-159">If the application's design leads to an unresponsive application, the design will have to change.</span></span> <span data-ttu-id="2dcb6-160">Por último, y esto es importante, no se puede solucionar la falta de respuesta como un error de código. requiere un trabajo inicial durante la fase de diseño.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-160">Finally, and this is important, unresponsiveness cannot be fixed like a code bug; it requires upfront work during the design phase.</span></span> <span data-ttu-id="2dcb6-161">Intentar reajustar la base de código existente de una aplicación para que la interfaz de usuario tenga mayor capacidad de respuesta suele ser demasiado costosa.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-161">Trying to retrofit an application's existing code base to make the UI more responsive is often too expensive.</span></span> <span data-ttu-id="2dcb6-162">Las siguientes directrices de diseño pueden ayudarle.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-162">The following design guidelines might help.</span></span>

-   <span data-ttu-id="2dcb6-163">Haga que la capacidad de respuesta de la interfaz de usuario sea un requisito de nivel superior; el usuario siempre debe sentirse en el control de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-163">Make UI responsiveness a top-level requirement; the user should always feel in control of your application</span></span>
-   <span data-ttu-id="2dcb6-164">Asegúrese de que los usuarios pueden cancelar las operaciones que tardan más de un segundo en completarse y/o que las operaciones se pueden completar en segundo plano. proporcionar la interfaz de usuario de progreso adecuada si es necesario</span><span class="sxs-lookup"><span data-stu-id="2dcb6-164">Ensure that users can cancel operations that take longer than one second to complete and/or that operations can complete in the background; provide appropriate progress UI if necessary</span></span>

![Captura de pantalla que muestra el cuadro de diálogo "copiando elementos".](images/preventinghangs-progressbar.gif)

-   <span data-ttu-id="2dcb6-166">Poner en cola operaciones de ejecución prolongada o de bloqueo como tareas en segundo plano (esto requiere un mecanismo de mensajería bien diseñado para informar al subproceso de la interfaz de usuario cuando se ha completado el trabajo)</span><span class="sxs-lookup"><span data-stu-id="2dcb6-166">Queue long-running or blocking operations as background tasks (this requires a well-thought out messaging mechanism to inform the UI thread when work has been completed)</span></span>
-   <span data-ttu-id="2dcb6-167">Mantenga el código para los subprocesos de interfaz de usuario sencillos; quitar todas las llamadas de API de bloqueo posibles</span><span class="sxs-lookup"><span data-stu-id="2dcb6-167">Keep the code for UI threads simple; remove as many blocking API calls as possible</span></span>
-   <span data-ttu-id="2dcb6-168">Muestre las ventanas y los cuadros de diálogo solo cuando estén listos y totalmente operativos.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-168">Show windows and dialogs only when they are ready and fully operational.</span></span> <span data-ttu-id="2dcb6-169">Si el cuadro de diálogo necesita Mostrar información que requiere demasiado recursos para calcular, muestre primero información genérica y actualícelo sobre la marcha cuando haya más datos disponibles.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-169">If the dialog needs to display information that is too resource-intensive to calculate, show some generic information first and update it on the fly when more data becomes available.</span></span> <span data-ttu-id="2dcb6-170">Un buen ejemplo es el cuadro de diálogo Propiedades de la carpeta del explorador de Windows.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-170">A good example is the folder properties dialog from Windows Explorer.</span></span> <span data-ttu-id="2dcb6-171">Debe mostrar el tamaño total de la carpeta, la información que no está disponible en el sistema de archivos.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-171">It needs to display the folder's total size, information that is not readily available from the file system.</span></span> <span data-ttu-id="2dcb6-172">El cuadro de diálogo se muestra de inmediato y el campo "tamaño" se actualiza desde un subproceso de trabajo:</span><span class="sxs-lookup"><span data-stu-id="2dcb6-172">The dialog shows up right away and the "size" field is updated from a worker thread:</span></span>

![Captura de pantalla que muestra la página ' general ' de las propiedades de Windows con el texto ' tamaño ', ' tamaño en disco ' y ' contiene ' en un círculo.](images/preventinghangs-updatingdialog.gif)

<span data-ttu-id="2dcb6-174">Desafortunadamente, no hay una manera sencilla de diseñar y escribir una aplicación con capacidad de respuesta.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-174">Unfortunately, there is no simple way to design and write a responsive application.</span></span> <span data-ttu-id="2dcb6-175">Windows no proporciona un marco de trabajo asincrónico sencillo que permita la programación sencilla de operaciones de bloqueo o de ejecución prolongada.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-175">Windows does not provide a simple asynchronous framework that would allow for easy scheduling of blocking or long-running operations.</span></span> <span data-ttu-id="2dcb6-176">En las secciones siguientes se presentan algunos de los procedimientos recomendados para evitar bloqueos y resaltar algunos de los errores comunes.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-176">The following sections introduce some of the best practices in preventing hangs and highlight some of the common pitfalls.</span></span>

## <a name="best-practices"></a><span data-ttu-id="2dcb6-177">Prácticas recomendadas</span><span class="sxs-lookup"><span data-stu-id="2dcb6-177">Best Practices</span></span>

<span data-ttu-id="2dcb6-178">**Mantener el subproceso de la interfaz de usuario simple**</span><span class="sxs-lookup"><span data-stu-id="2dcb6-178">**Keep the UI Thread Simple**</span></span>

<span data-ttu-id="2dcb6-179">La responsabilidad principal del subproceso de la interfaz de usuario es recuperar y enviar mensajes.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-179">The UI thread's primary responsibility is to retrieve and dispatch messages.</span></span> <span data-ttu-id="2dcb6-180">Cualquier otro tipo de trabajo presenta el riesgo de que se bloqueen las ventanas que pertenecen a este subproceso.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-180">Any other kind of work introduces the risk of hanging the windows owned by this thread.</span></span>

<span data-ttu-id="2dcb6-181">**No**</span><span class="sxs-lookup"><span data-stu-id="2dcb6-181">**Do:**</span></span>

-   <span data-ttu-id="2dcb6-182">Trasladar algoritmos que consumen muchos recursos o no están enlazados, lo que da lugar a operaciones de larga duración en subprocesos de trabajo</span><span class="sxs-lookup"><span data-stu-id="2dcb6-182">Move resource-intensive or unbounded algorithms that result in long-running operations to worker threads</span></span>
-   <span data-ttu-id="2dcb6-183">Identifique tantas llamadas de función de bloqueo como sea posible e intente moverlas a subprocesos de trabajo. cualquier función que llame a otra DLL debe ser sospechosa</span><span class="sxs-lookup"><span data-stu-id="2dcb6-183">Identify as many blocking function calls as possible and try to move them to worker threads; any function calling into another DLL should be suspicious</span></span>
-   <span data-ttu-id="2dcb6-184">Haga un esfuerzo adicional para quitar todas las llamadas de API de red y de e/s de archivo del subproceso de trabajo.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-184">Make an extra effort to remove all file I/O and networking API calls from your worker thread.</span></span> <span data-ttu-id="2dcb6-185">Estas funciones pueden bloquear muchos segundos si no son minutos.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-185">These functions can block for many seconds if not minutes.</span></span> <span data-ttu-id="2dcb6-186">Si necesita realizar cualquier tipo de e/s en el subproceso de la interfaz de usuario, considere la posibilidad de usar e/s asincrónica</span><span class="sxs-lookup"><span data-stu-id="2dcb6-186">If you need to do any kind of I/O in the UI thread, consider using asynchronous I/O</span></span>
-   <span data-ttu-id="2dcb6-187">Tenga en cuenta que el subproceso de interfaz de usuario también está atendiendo a todos los servidores COM de contenedor uniproceso (STA) hospedados por el proceso. Si realiza una llamada de bloqueo, estos servidores COM dejarán de responder hasta que vuelva a dar servicio a la cola de mensajes</span><span class="sxs-lookup"><span data-stu-id="2dcb6-187">Be aware that your UI thread is also servicing all single-threaded apartment (STA) COM servers hosted by your process; if you make a blocking call, these COM servers will be unresponsive until you service the message queue again</span></span>

<span data-ttu-id="2dcb6-188">**No:**</span><span class="sxs-lookup"><span data-stu-id="2dcb6-188">**Do not:**</span></span>

-   <span data-ttu-id="2dcb6-189">Espere por cualquier objeto de kernel (como evento o exclusión mutua) durante más de un período de tiempo muy breve; Si tiene que esperar, considere la posibilidad de usar MsgWaitForMultipleObjects (), que se desbloqueará cuando llegue un mensaje nuevo.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-189">Wait on any kernel object (like Event or Mutex) for more than a very short amount of time; if you have to wait at all, consider using MsgWaitForMultipleObjects(), which will unblock when a new message arrives</span></span>
-   <span data-ttu-id="2dcb6-190">Compartir la cola de mensajes de ventana de un subproceso con otro subproceso mediante la función AttachThreadInput ().</span><span class="sxs-lookup"><span data-stu-id="2dcb6-190">Share a thread's window message queue with another thread by using the AttachThreadInput() function.</span></span> <span data-ttu-id="2dcb6-191">No solo es extremadamente difícil sincronizar correctamente el acceso a la cola, sino que también puede impedir que el sistema operativo Windows detecte correctamente una ventana de bloqueo</span><span class="sxs-lookup"><span data-stu-id="2dcb6-191">It is not only extremely difficult to properly synchronize access to the queue, it also can prevent the Windows operating system from properly detecting a hung window</span></span>
-   <span data-ttu-id="2dcb6-192">Use TerminateThread () en cualquiera de los subprocesos de trabajo.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-192">Use TerminateThread() on any of your worker threads.</span></span> <span data-ttu-id="2dcb6-193">La finalización de un subproceso de este modo no permitirá liberar bloqueos ni eventos de señal, y puede producir fácilmente objetos de sincronización huérfanos</span><span class="sxs-lookup"><span data-stu-id="2dcb6-193">Terminating a thread in this way will not allow it to release locks or signal events and can easily result in orphaned synchronization objects</span></span>
-   <span data-ttu-id="2dcb6-194">Llame a cualquier código "desconocido" desde el subproceso de la interfaz de usuario.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-194">Call into any 'unknown' code from your UI thread.</span></span> <span data-ttu-id="2dcb6-195">Esto es especialmente cierto si la aplicación tiene un modelo de extensibilidad; no hay ninguna garantía de que el código de terceros siga las directrices de capacidad de respuesta</span><span class="sxs-lookup"><span data-stu-id="2dcb6-195">This is especially true if your application has an extensibility model; there is no guarantee that 3rd-party code follows your responsiveness guidelines</span></span>
-   <span data-ttu-id="2dcb6-196">Realice cualquier tipo de llamada de difusión de bloqueo; SendMessage ( \_ difusión HWND) le pone a merced de cada aplicación mal escrita que se esté ejecutando actualmente</span><span class="sxs-lookup"><span data-stu-id="2dcb6-196">Make any kind of blocking broadcast call; SendMessage(HWND\_BROADCAST) puts you at the mercy of every ill-written application currently running</span></span>

<span data-ttu-id="2dcb6-197">**Implementar patrones asincrónicos**</span><span class="sxs-lookup"><span data-stu-id="2dcb6-197">**Implement Asynchronous Patterns**</span></span>

<span data-ttu-id="2dcb6-198">La eliminación de operaciones de ejecución prolongada o de bloqueo del subproceso de interfaz de usuario requiere la implementación de un marco de trabajo asincrónico que permita descargar esas operaciones en subprocesos de trabajo.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-198">Removing long-running or blocking operations from the UI thread requires implementing an asynchronous framework that allows offloading those operations to worker threads.</span></span>

<span data-ttu-id="2dcb6-199">**No**</span><span class="sxs-lookup"><span data-stu-id="2dcb6-199">**Do:**</span></span>

-   <span data-ttu-id="2dcb6-200">Use las API de mensajes de ventana asincrónica en el subproceso de la interfaz de usuario, especialmente reemplazando SendMessage por uno de sus homólogos sin bloqueo: PostMessage, SendNotifyMessage o SendMessageCallback</span><span class="sxs-lookup"><span data-stu-id="2dcb6-200">Use asynchronous window message APIs in your UI thread, especially by replacing SendMessage with one of its non-blocking peers: PostMessage, SendNotifyMessage, or SendMessageCallback</span></span>
-   <span data-ttu-id="2dcb6-201">Usar subprocesos en segundo plano para ejecutar tareas de ejecución prolongada o de bloqueo.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-201">Use background threads to execute long-running or blocking tasks.</span></span> <span data-ttu-id="2dcb6-202">Uso de la nueva API de grupo de subprocesos para implementar los subprocesos de trabajo</span><span class="sxs-lookup"><span data-stu-id="2dcb6-202">Use the new thread pool API to implement your worker threads</span></span>
-   <span data-ttu-id="2dcb6-203">Proporcionar compatibilidad de cancelación para tareas en segundo plano de ejecución prolongada.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-203">Provide cancellation support for long-running background tasks.</span></span> <span data-ttu-id="2dcb6-204">Para las operaciones de e/s de bloqueo, utilice la cancelación de e/s, pero solo como último recurso. no es fácil cancelar la operación "Right"</span><span class="sxs-lookup"><span data-stu-id="2dcb6-204">For blocking I/O operations, use I/O cancellation, but only as a last resort; it's not easy to cancel the 'right' operation</span></span>
-   <span data-ttu-id="2dcb6-205">Implementar un diseño asincrónico para código administrado mediante el patrón IAsyncResult o mediante eventos</span><span class="sxs-lookup"><span data-stu-id="2dcb6-205">Implement an asynchronous design for managed code by using the IAsyncResult pattern or by using Events</span></span>

<span data-ttu-id="2dcb6-206">**Usar bloqueos de modo inteligente**</span><span class="sxs-lookup"><span data-stu-id="2dcb6-206">**Use Locks Wisely**</span></span>

<span data-ttu-id="2dcb6-207">La aplicación o DLL necesita bloqueos para sincronizar el acceso a sus estructuras de datos internas.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-207">Your application or DLL needs locks to synchronize access to its internal data structures.</span></span> <span data-ttu-id="2dcb6-208">El uso de varios bloqueos aumenta el paralelismo y hace que la aplicación tenga mayor capacidad de respuesta.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-208">Using multiple locks increases parallelism and makes your application more responsive.</span></span> <span data-ttu-id="2dcb6-209">Sin embargo, el uso de varios bloqueos también aumenta la posibilidad de adquirir los bloqueos en distintos pedidos y hacer que los subprocesos se interbloqueen.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-209">However, using multiple locks also increases the chance of acquiring those locks in different orders and causing your threads to deadlock.</span></span> <span data-ttu-id="2dcb6-210">Si cada uno de los subprocesos contiene un bloqueo y, a continuación, intenta adquirir el bloqueo del otro subproceso, sus operaciones formarán una espera circular que bloquea el progreso de los subprocesos.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-210">If two threads each hold a lock and then try to acquire the other thread's lock, their operations will form a circular wait that blocks any forward progress for these threads.</span></span> <span data-ttu-id="2dcb6-211">Puede evitar este interbloqueo solo asegurándose de que todos los subprocesos de la aplicación siempre adquieran todos los bloqueos en el mismo orden.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-211">You can avoid this deadlock only by ensuring that all threads in the application always acquire all locks in the same order.</span></span> <span data-ttu-id="2dcb6-212">Sin embargo, no siempre es fácil adquirir bloqueos en el orden "correcto".</span><span class="sxs-lookup"><span data-stu-id="2dcb6-212">However, it isn't always easy to acquire locks in the 'right' order.</span></span> <span data-ttu-id="2dcb6-213">Los componentes de software pueden estar compuestos, pero las adquisiciones de bloqueos no pueden.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-213">Software components can be composed, but lock acquisitions cannot.</span></span> <span data-ttu-id="2dcb6-214">Si el código llama a algún otro componente, los bloqueos de ese componente pasan a formar parte de su orden de bloqueo implícito, incluso si no tiene visibilidad sobre esos bloqueos.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-214">If your code calls some other component, that component's locks now become part of your implicit lock order - even if you have no visibility into those locks.</span></span>

<span data-ttu-id="2dcb6-215">Las cosas son incluso más difíciles porque las operaciones de bloqueo incluyen mucho más que las funciones habituales en las secciones críticas, exclusiones mutuas y otros bloqueos tradicionales.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-215">Things get even harder because locking operations include far more than the usual functions for Critical Sections, Mutexes, and other traditional locks.</span></span> <span data-ttu-id="2dcb6-216">Cualquier llamada de bloqueo que cruza los límites de subprocesos tiene propiedades de sincronización que pueden producir un interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-216">Any blocking call that crosses thread boundaries has synchronization properties that can result in a deadlock.</span></span> <span data-ttu-id="2dcb6-217">El subproceso que realiza la llamada realiza una operación con la semántica "adquire" y no se puede desbloquear hasta que el subproceso de destino "libera" que llama a.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-217">The calling thread performs an operation with 'acquire' semantics and cannot unblock until the target thread 'releases' that call.</span></span> <span data-ttu-id="2dcb6-218">Algunas funciones user32 (por ejemplo, SendMessage), así como muchas llamadas COM de bloqueo, se encuentran en esta categoría.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-218">Quite a few User32 functions (for example SendMessage), as well as many blocking COM calls fall into this category.</span></span>

<span data-ttu-id="2dcb6-219">Peor aún, el sistema operativo tiene su propio bloqueo interno específico del proceso que a veces se mantiene mientras se ejecuta el código.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-219">Worse yet, the operating system has its own internal process-specific lock that sometimes is held while your code executes.</span></span> <span data-ttu-id="2dcb6-220">Este bloqueo se adquiere cuando los archivos DLL se cargan en el proceso y, por tanto, se denomina "bloqueo del cargador".</span><span class="sxs-lookup"><span data-stu-id="2dcb6-220">This lock is acquired when DLLs are loaded into the process, and is therefore called the 'loader lock.'</span></span> <span data-ttu-id="2dcb6-221">La función DllMain siempre se ejecuta en el bloqueo del cargador. Si adquiere bloqueos en DllMain (y no debería), debe hacer que el cargador del cargador sea parte del orden de bloqueo.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-221">The DllMain function always executes under the loader lock; if you acquire any locks in DllMain (and you should not), you need to make the loader lock part of your lock order.</span></span> <span data-ttu-id="2dcb6-222">Llamar a ciertas API de Win32 también puede adquirir el bloqueo del cargador en sus funciones de nombre, como LoadLibraryEx, GetModuleHandle y, en especial, CoCreateInstance.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-222">Calling certain Win32 APIs might also acquire the loader lock on your behalf - functions like LoadLibraryEx, GetModuleHandle, and especially CoCreateInstance.</span></span>

<span data-ttu-id="2dcb6-223">Para unir todo este conjunto, examine el código de ejemplo siguiente.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-223">To tie all of this together, look at the sample code below.</span></span> <span data-ttu-id="2dcb6-224">Esta función adquiere varios objetos de sincronización y define implícitamente un orden de bloqueo, algo que no es necesariamente obvio en la inspección de cursores.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-224">This function acquires multiple synchronization objects and implicitly defines a lock order, something that is not necessarily obvious on cursory inspection.</span></span> <span data-ttu-id="2dcb6-225">En la entrada de la función, el código adquiere una sección crítica y no la libera hasta salir de la función, lo que lo convierte en el nodo superior de la jerarquía de bloqueos.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-225">On function entry, the code acquires a Critical Section and does not release it until function exit, thereby making it the top node in our lock hierarchy.</span></span> <span data-ttu-id="2dcb6-226">A continuación, el código llama a la función de Win32 LoadIcon (), que, en segundo plano, puede llamar al cargador del sistema operativo para cargar este archivo binario.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-226">The code then calls the Win32 function LoadIcon(), which under the covers might call into the Operating System Loader to load this binary.</span></span> <span data-ttu-id="2dcb6-227">Esta operación adquiriría el bloqueo del cargador, que ahora también forma parte de esta jerarquía de bloqueos (Asegúrese de que la función DllMain no adquiere el \_ bloqueo g CS).</span><span class="sxs-lookup"><span data-stu-id="2dcb6-227">This operation would acquire the loader lock, which now also becomes part of this lock hierarchy (make sure the DllMain function does not acquire the g\_cs lock).</span></span> <span data-ttu-id="2dcb6-228">A continuación, el código llama a SendMessage (), una operación de bloqueo entre subprocesos, que no devolverá a menos que el subproceso de la interfaz de usuario responda.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-228">Next the code calls SendMessage(), a blocking cross-thread operation, which will not return unless the UI thread responds.</span></span> <span data-ttu-id="2dcb6-229">De nuevo, asegúrese de que el subproceso de interfaz de usuario nunca adquiera g \_ CS.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-229">Again, make sure that the UI thread never acquires g\_cs.</span></span>

```
bool foo::bar (char* buffer)  
{  
      EnterCriticalSection(&g_cs);  
      // Get 'new data' icon  
      this.m_Icon = LoadIcon(hInst, MAKEINTRESOURCE(5));  
      // Let UI thread know to update icon SendMessage(hWnd,WM_COMMAND,IDM_ICON,NULL);  
      this.m_Params = GetParams(buffer);  
      LeaveCriticalSection(&g_cs);
      return true;  
}  
```

<span data-ttu-id="2dcb6-230">Si miramos este código, parece evidente que, de forma implícita \_ , el bloqueo de nivel superior de la jerarquía de bloqueos se hizo en g CS, incluso si solo queríamos sincronizar el acceso a las variables de miembro de clase.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-230">Looking at this code it seems clear that we implicitly made g\_cs the top-level lock in our lock hierarchy, even if we only wanted to synchronize access to the class member variables.</span></span>

<span data-ttu-id="2dcb6-231">**No**</span><span class="sxs-lookup"><span data-stu-id="2dcb6-231">**Do:**</span></span>

-   <span data-ttu-id="2dcb6-232">Diseñar una jerarquía de bloqueos y obedecerla.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-232">Design a lock hierarchy and obey it.</span></span> <span data-ttu-id="2dcb6-233">Agregue todos los bloqueos necesarios.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-233">Add all the necessary locks.</span></span> <span data-ttu-id="2dcb6-234">Hay muchas más primitivas de sincronización que simplemente mutex y CriticalSections; todos deben incluirse.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-234">There are many more synchronization primitives than just Mutex and CriticalSections; they all need to be included.</span></span> <span data-ttu-id="2dcb6-235">Incluir el bloqueo del cargador en la jerarquía si se realizan bloqueos en DllMain ()</span><span class="sxs-lookup"><span data-stu-id="2dcb6-235">Include the loader lock in your hierarchy if you take any locks in DllMain()</span></span>
-   <span data-ttu-id="2dcb6-236">Acepte el bloqueo del Protocolo con las dependencias.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-236">Agree on locking protocol with your dependencies.</span></span> <span data-ttu-id="2dcb6-237">Cualquier código que llame a la aplicación o que pueda llamar a la aplicación debe compartir la misma jerarquía de bloqueos.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-237">Any code your application calls or that might call your application needs to share the same lock hierarchy</span></span>
-   <span data-ttu-id="2dcb6-238">Las estructuras de datos de bloqueo no funcionan.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-238">Lock data structures not functions.</span></span> <span data-ttu-id="2dcb6-239">Mueva las adquisiciones de bloqueos fuera de los puntos de entrada de función y proteja únicamente el acceso a los datos con bloqueos.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-239">Move lock acquisitions away from function entry points and guard only data access with locks.</span></span> <span data-ttu-id="2dcb6-240">Si hay menos código que funciona bajo un bloqueo, es menos probable que se produzcan interbloqueos.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-240">If less code operates under a lock, there is less of a chance for deadlocks</span></span>
-   <span data-ttu-id="2dcb6-241">Analice las adquisiciones y versiones de bloqueo en el código de control de errores.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-241">Analyze lock acquisitions and releases in your error handling code.</span></span> <span data-ttu-id="2dcb6-242">A menudo, la jerarquía de bloqueo si se olvida al intentar recuperarse de una condición de error</span><span class="sxs-lookup"><span data-stu-id="2dcb6-242">Often the lock hierarchy if forgotten when trying to recover from an error condition</span></span>
-   <span data-ttu-id="2dcb6-243">Reemplace los bloqueos anidados por contadores de referencia, no pueden interbloqueos.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-243">Replace nested locks with reference counters - they cannot deadlock.</span></span> <span data-ttu-id="2dcb6-244">Los elementos bloqueados individualmente en listas y tablas son buenos candidatos</span><span class="sxs-lookup"><span data-stu-id="2dcb6-244">Individually locked elements in lists and tables are good candidates</span></span>
-   <span data-ttu-id="2dcb6-245">Tenga cuidado al esperar en un identificador de subproceso de un archivo DLL.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-245">Be careful when waiting on a thread handle from a DLL.</span></span> <span data-ttu-id="2dcb6-246">Asuma siempre que se puede llamar al código bajo el bloqueo del cargador.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-246">Always assume that your code could be called under the loader lock.</span></span> <span data-ttu-id="2dcb6-247">Es mejor recuento de referencias de los recursos y permitir que el subproceso de trabajo realice su propia limpieza (y, a continuación, use FreeLibraryAndExitThread para finalizar la limpieza)</span><span class="sxs-lookup"><span data-stu-id="2dcb6-247">It's better to reference-count your resources and let the worker thread do its own cleanup (and then use FreeLibraryAndExitThread to terminate cleanly)</span></span>
-   <span data-ttu-id="2dcb6-248">Use la API de recorrido de la cadena de espera Si desea diagnosticar sus propios interbloqueos.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-248">Use the Wait Chain Traversal API if you want to diagnose your own deadlocks</span></span>

<span data-ttu-id="2dcb6-249">**No:**</span><span class="sxs-lookup"><span data-stu-id="2dcb6-249">**Do not:**</span></span>

-   <span data-ttu-id="2dcb6-250">Haga algo que no sea un trabajo de inicialización muy simple en la función DllMain ().</span><span class="sxs-lookup"><span data-stu-id="2dcb6-250">Do anything other than very simple initialization work in your DllMain() function.</span></span> <span data-ttu-id="2dcb6-251">Vea la función de devolución de llamada DllMain para obtener más detalles.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-251">See DllMain Callback Function for more details.</span></span> <span data-ttu-id="2dcb6-252">En especial, no se llama a LoadLibraryEx o CoCreateInstance</span><span class="sxs-lookup"><span data-stu-id="2dcb6-252">Especially do not call LoadLibraryEx or CoCreateInstance</span></span>
-   <span data-ttu-id="2dcb6-253">Escriba sus propias primitivas de bloqueo.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-253">Write your own locking primitives.</span></span> <span data-ttu-id="2dcb6-254">El código de sincronización personalizado puede introducir fácilmente errores sutiles en el código base.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-254">Custom synchronization code can easily introduce subtle bugs into your code base.</span></span> <span data-ttu-id="2dcb6-255">En su lugar, use la amplia selección de objetos de sincronización de sistema operativo.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-255">Use the rich selection of operating system synchronization objects instead</span></span>
-   <span data-ttu-id="2dcb6-256">Realizar cualquier trabajo en los constructores y destructores para las variables globales, se ejecutan bajo el bloqueo del cargador</span><span class="sxs-lookup"><span data-stu-id="2dcb6-256">Do any work in the constructors and destructors for global variables, they are executed under the loader lock</span></span>

<span data-ttu-id="2dcb6-257">**Tenga cuidado con las excepciones**</span><span class="sxs-lookup"><span data-stu-id="2dcb6-257">**Be Careful with Exceptions**</span></span>

<span data-ttu-id="2dcb6-258">Las excepciones permiten separar el flujo normal del programa y el control de errores.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-258">Exceptions allow the separation of normal program flow and error handling.</span></span> <span data-ttu-id="2dcb6-259">Debido a esta separación, puede ser difícil conocer el estado exacto del programa antes de la excepción y el controlador de excepción podría pasar por alto pasos fundamentales para restaurar un estado válido.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-259">Because of this separation, it can be difficult to know the precise state of the program prior to the exception and the exception handler might miss crucial steps in restoring a valid state.</span></span> <span data-ttu-id="2dcb6-260">Esto es especialmente cierto para las adquisiciones de bloqueos que deben liberarse en el controlador para evitar interbloqueos en el futuro.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-260">This is especially true for lock acquisitions that need to be released in the handler to prevent future deadlocks.</span></span>

<span data-ttu-id="2dcb6-261">En el código de ejemplo siguiente se muestra este problema.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-261">The sample code below illustrates this issue.</span></span> <span data-ttu-id="2dcb6-262">En ocasiones, el acceso sin enlazar a la variable "buffer" producirá una infracción de acceso (AV).</span><span class="sxs-lookup"><span data-stu-id="2dcb6-262">The unbounded access to the "buffer" variable will occasionally result in an access violation (AV).</span></span> <span data-ttu-id="2dcb6-263">Este antivirus lo detecta el controlador de excepciones nativas, pero no tiene una forma sencilla de determinar si la sección crítica ya se adquirió en el momento de la excepción (es posible que incluso haya tenido lugar en alguna parte del código de EnterCriticalSection).</span><span class="sxs-lookup"><span data-stu-id="2dcb6-263">This AV is caught by the native exception handler, but it has no easy way of determining if the critical section was already acquired at the time of the exception (the AV could even have taken place somewhere in the EnterCriticalSection code).</span></span>

```
 BOOL bar (char* buffer)  
{  
   BOOL rc = FALSE;  
   __try {  
      EnterCriticalSection(&cs);  
      while (*buffer++ != '&') ;  
      rc = GetParams(buffer);  
      LeaveCriticalSection(&cs);  
   } __except (EXCEPTION_EXECUTE_HANDLER)  
   {  
      return FALSE;  
   } 
   return rc;  
}  
```

<span data-ttu-id="2dcb6-264">**No**</span><span class="sxs-lookup"><span data-stu-id="2dcb6-264">**Do:**</span></span>

-   <span data-ttu-id="2dcb6-265">Quitar \_ \_ try/ \_ \_ Except siempre que sea posible; no use SetUnhandledExceptionFilter</span><span class="sxs-lookup"><span data-stu-id="2dcb6-265">Remove \_\_try/\_\_except whenever possible; do not use SetUnhandledExceptionFilter</span></span>
-   <span data-ttu-id="2dcb6-266">Ajuste los bloqueos en \_ plantillas personalizadas de tipo PTR automáticas si utiliza excepciones de C++.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-266">Wrap your locks in custom auto\_ptr-like templates if you use C++ exceptions.</span></span> <span data-ttu-id="2dcb6-267">El bloqueo debe liberarse en el destructor.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-267">The lock should be released in the destructor.</span></span> <span data-ttu-id="2dcb6-268">Para las excepciones nativas, libere los bloqueos en la \_ \_ instrucción Finally</span><span class="sxs-lookup"><span data-stu-id="2dcb6-268">For native exceptions release the locks in your \_\_finally statement</span></span>
-   <span data-ttu-id="2dcb6-269">Tenga cuidado con el código que se ejecuta en un controlador de excepciones nativo; es posible que la excepción haya filtrado muchos bloqueos, por lo que el controlador no debe adquirir ningún</span><span class="sxs-lookup"><span data-stu-id="2dcb6-269">Be careful with the code executing in a native exception handler; the exception might have leaked many locks, so your handler should not acquire any</span></span>

<span data-ttu-id="2dcb6-270">**No:**</span><span class="sxs-lookup"><span data-stu-id="2dcb6-270">**Do not:**</span></span>

-   <span data-ttu-id="2dcb6-271">Controle las excepciones nativas si no las necesita o las API de Win32.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-271">Handle native exceptions if not necessary or required by the Win32 APIs.</span></span> <span data-ttu-id="2dcb6-272">Si usa controladores de excepciones nativas para la recuperación de datos o de informes después de errores catastróficos, considere la posibilidad de usar en su lugar el mecanismo de sistema operativo predeterminado de Informe de errores de Windows</span><span class="sxs-lookup"><span data-stu-id="2dcb6-272">If you use native exception handlers for reporting or data recovery after catastrophic failures, consider using the default operating system mechanism of Windows Error Reporting instead</span></span>
-   <span data-ttu-id="2dcb6-273">Usar excepciones de C++ con cualquier tipo de código de interfaz de usuario (user32); una excepción que se produce en una devolución de llamada viaja a través de las capas de código C proporcionadas por el sistema operativo.</span><span class="sxs-lookup"><span data-stu-id="2dcb6-273">Use C++ exceptions with any kind of UI (user32) code; an exception thrown in a callback will travel through layers of C code provided by the operating system.</span></span> <span data-ttu-id="2dcb6-274">Ese código no conoce la semántica de deshacer de C++</span><span class="sxs-lookup"><span data-stu-id="2dcb6-274">That code does not know about C++ unroll semantics</span></span>

## <a name="links-to-resources"></a><span data-ttu-id="2dcb6-275">Vínculos a recursos</span><span class="sxs-lookup"><span data-stu-id="2dcb6-275">Links to Resources</span></span>

-   [<span data-ttu-id="2dcb6-276">Informe de errores de Windows</span><span class="sxs-lookup"><span data-stu-id="2dcb6-276">Windows Error Reporting</span></span>](../wer/windows-error-reporting.md)
-   <span data-ttu-id="2dcb6-277">[Diseño asincrónico](https://msdn.microsoft.com/library/ms228969(v=VS.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="2dcb6-277">[Asynchronous Design](https://msdn.microsoft.com/library/ms228969(v=VS.80).aspx)</span></span>
-   [<span data-ttu-id="2dcb6-278">E/s asincrónica</span><span class="sxs-lookup"><span data-stu-id="2dcb6-278">Asynchronous I/O</span></span>](../fileio/synchronous-and-asynchronous-i-o.md)
-   [<span data-ttu-id="2dcb6-279">**AttachThreadInput función)**</span><span class="sxs-lookup"><span data-stu-id="2dcb6-279">**AttachThreadInput Function**</span></span>](/windows/win32/api/winuser/nf-winuser-attachthreadinput)
-   <span data-ttu-id="2dcb6-280">[**auto- \_ ptr (clase)**](https://msdn.microsoft.com/library/ew3fk483(v=VS.71).aspx)</span><span class="sxs-lookup"><span data-stu-id="2dcb6-280">[**auto\_ptr Class**](https://msdn.microsoft.com/library/ew3fk483(v=VS.71).aspx)</span></span>
-   [<span data-ttu-id="2dcb6-281">**DisableProcessWindowsGhosting función)**</span><span class="sxs-lookup"><span data-stu-id="2dcb6-281">**DisableProcessWindowsGhosting Function**</span></span>](/windows/win32/api/winuser/nf-winuser-disableprocesswindowsghosting)
-   [<span data-ttu-id="2dcb6-282">**Función de devolución de llamada DllMain**</span><span class="sxs-lookup"><span data-stu-id="2dcb6-282">**DllMain Callback Function**</span></span>](../dlls/dllmain.md)
-   <span data-ttu-id="2dcb6-283">[Eventos](https://msdn.microsoft.com/library/wewwczdw(v=VS.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="2dcb6-283">[Events](https://msdn.microsoft.com/library/wewwczdw(v=VS.80).aspx)</span></span>
-   [<span data-ttu-id="2dcb6-284">**GetMessage (función)**</span><span class="sxs-lookup"><span data-stu-id="2dcb6-284">**GetMessage Function**</span></span>](/windows/win32/api/winuser/nf-winuser-getmessage)
-   [<span data-ttu-id="2dcb6-285">Cancelación de e/s</span><span class="sxs-lookup"><span data-stu-id="2dcb6-285">I/O cancellation</span></span>](../fileio/canceling-pending-i-o-operations.md)
-   [<span data-ttu-id="2dcb6-286">**IsHungAppWindow función)**</span><span class="sxs-lookup"><span data-stu-id="2dcb6-286">**IsHungAppWindow Function**</span></span>](/windows/win32/api/winuser/nf-winuser-ishungappwindow)
-   [<span data-ttu-id="2dcb6-287">Cola de mensajes</span><span class="sxs-lookup"><span data-stu-id="2dcb6-287">Message Queue</span></span>](../winmsg/using-messages-and-message-queues.md)
-   [<span data-ttu-id="2dcb6-288">**MsgWaitForMultipleObjects función)**</span><span class="sxs-lookup"><span data-stu-id="2dcb6-288">**MsgWaitForMultipleObjects Function**</span></span>](/windows/win32/api/winuser/nf-winuser-msgwaitformultipleobjects)
-   [<span data-ttu-id="2dcb6-289">Nueva API de grupo de subprocesos</span><span class="sxs-lookup"><span data-stu-id="2dcb6-289">New Thread Pool API</span></span>](../procthread/thread-pool-api.md)
-   [<span data-ttu-id="2dcb6-290">**Función PostMessage**</span><span class="sxs-lookup"><span data-stu-id="2dcb6-290">**PostMessage Function**</span></span>](/windows/win32/api/winuser/nf-winuser-postmessagea)
-   [<span data-ttu-id="2dcb6-291">Reiniciar y recuperar</span><span class="sxs-lookup"><span data-stu-id="2dcb6-291">Restart and Recovery</span></span>](../recovery/registering-for-application-restart.md)
-   [<span data-ttu-id="2dcb6-292">**SendMessageCallback función)**</span><span class="sxs-lookup"><span data-stu-id="2dcb6-292">**SendMessageCallback Function**</span></span>](/windows/win32/api/winuser/nf-winuser-sendmessagecallbacka)
-   [<span data-ttu-id="2dcb6-293">**SendNotifyMessage función)**</span><span class="sxs-lookup"><span data-stu-id="2dcb6-293">**SendNotifyMessage Function**</span></span>](/windows/win32/api/winuser/nf-winuser-sendnotifymessagea)
-   [<span data-ttu-id="2dcb6-294">Objetos de sincronización</span><span class="sxs-lookup"><span data-stu-id="2dcb6-294">Synchronization Objects</span></span>](../sync/about-synchronization.md)
-   [<span data-ttu-id="2dcb6-295">**TerminateThread (función)**</span><span class="sxs-lookup"><span data-stu-id="2dcb6-295">**TerminateThread Function**</span></span>](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminatethread)
-   [<span data-ttu-id="2dcb6-296">Informe de errores de Windows</span><span class="sxs-lookup"><span data-stu-id="2dcb6-296">Windows Error Reporting</span></span>](../wer/windows-error-reporting.md)
-   [<span data-ttu-id="2dcb6-297">WinQual</span><span class="sxs-lookup"><span data-stu-id="2dcb6-297">Winqual</span></span>](/windows-hardware/drivers/dashboard/winqual-submission-tool--winqualexe-)

 

 
