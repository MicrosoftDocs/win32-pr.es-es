---
description: Describe el procedimiento para codificar un mensaje firmado.
ms.assetid: 40d1c417-6d88-4421-920f-8b40d88d28ce
title: Codificar datos firmados
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: be4a542fe0890a6ee9d51ebc1a5ee6b98bab4242
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/08/2021
ms.locfileid: "104278239"
---
# <a name="encoding-signed-data"></a><span data-ttu-id="4afda-103">Codificar datos firmados</span><span class="sxs-lookup"><span data-stu-id="4afda-103">Encoding Signed Data</span></span>

<span data-ttu-id="4afda-104">Los [*datos firmados*](../secgloss/s-gly.md) constan de contenido de cualquier tipo y [*hash*](../secgloss/h-gly.md) de mensaje cifrado del contenido por cero o más firmantes.</span><span class="sxs-lookup"><span data-stu-id="4afda-104">[*Signed data*](../secgloss/s-gly.md) consists of content of any type and encrypted message [*hashes*](../secgloss/h-gly.md) of the content by zero or more signers.</span></span> <span data-ttu-id="4afda-105">El hash resultante puede confirmar que el mensaje original no se ha modificado desde la firma y que determinadas personas o entidades firmaron los datos.</span><span class="sxs-lookup"><span data-stu-id="4afda-105">The resulting hash can confirm that the original message has not been modified since signing and that particular persons or entities signed the data.</span></span>

<span data-ttu-id="4afda-106">En la ilustración siguiente se muestra el procedimiento para codificar un mensaje firmado.</span><span class="sxs-lookup"><span data-stu-id="4afda-106">The following illustration depicts the procedure for encoding a signed message.</span></span> <span data-ttu-id="4afda-107">En la lista siguiente se describen los pasos.</span><span class="sxs-lookup"><span data-stu-id="4afda-107">The list following the illustration describes the steps.</span></span>

<span data-ttu-id="4afda-108">Un mensaje puede tener varios firmadores, algoritmos hash y certificados.</span><span class="sxs-lookup"><span data-stu-id="4afda-108">A message may have multiple signers, hashing algorithms, and certificates.</span></span> <span data-ttu-id="4afda-109">Mientras que la ilustración solo muestra certificados, [*CRL*](../secgloss/c-gly.md)y [*CTL*](../secgloss/c-gly.md) , puede usar el mismo proceso.</span><span class="sxs-lookup"><span data-stu-id="4afda-109">While the illustration shows only certificates, [*CRLs*](../secgloss/c-gly.md), and [*CTLs*](../secgloss/c-gly.md) can use the same process.</span></span> <span data-ttu-id="4afda-110">Caben en la ilustración siempre que se muestren los certificados.</span><span class="sxs-lookup"><span data-stu-id="4afda-110">They would fit into the illustration wherever certificates are shown.</span></span>

![codificar un mensaje firmado](images/signmsg2.png)

<span data-ttu-id="4afda-112">El proceso general para codificar los [*datos firmados*](../secgloss/s-gly.md) es el siguiente.</span><span class="sxs-lookup"><span data-stu-id="4afda-112">The general process for encoding [*Signed data*](../secgloss/s-gly.md) is as follows.</span></span>

<span data-ttu-id="4afda-113">**Para codificar datos firmados**</span><span class="sxs-lookup"><span data-stu-id="4afda-113">**To encode signed data**</span></span>

1.  <span data-ttu-id="4afda-114">Los datos se crean (si es necesario) y se recupera un puntero a él.</span><span class="sxs-lookup"><span data-stu-id="4afda-114">The data is created (if necessary), and a pointer to it is retrieved.</span></span>
2.  <span data-ttu-id="4afda-115">Se abre un [*almacén de certificados*](../secgloss/c-gly.md) que contiene el certificado del firmante.</span><span class="sxs-lookup"><span data-stu-id="4afda-115">A [*certificate store*](../secgloss/c-gly.md) is opened that contains the signer's certificate.</span></span>
3.  <span data-ttu-id="4afda-116">Se recupera la clave privada para el certificado.</span><span class="sxs-lookup"><span data-stu-id="4afda-116">The private key for the certificate is retrieved.</span></span> <span data-ttu-id="4afda-117">Hay dos propiedades que se deben establecer en el certificado antes de usarlas.</span><span class="sxs-lookup"><span data-stu-id="4afda-117">There are two properties that must be set on the certificate before using it.</span></span> <span data-ttu-id="4afda-118">Una se usa para asociar un certificado a un CSP determinado y, dentro de ese CSP, a un [*contenedor de claves*](../secgloss/k-gly.md)privadas determinado.</span><span class="sxs-lookup"><span data-stu-id="4afda-118">One is used to tie a certificate to a particular CSP and, within that CSP, to a particular private [*key container*](../secgloss/k-gly.md).</span></span> <span data-ttu-id="4afda-119">El otro se usa para indicar qué algoritmo hash se va a utilizar cuando se llama a una operación [*hash*](../secgloss/h-gly.md) .</span><span class="sxs-lookup"><span data-stu-id="4afda-119">The other is used to indicate which hashing algorithm is to be used when a [*hash*](../secgloss/h-gly.md) operation is called.</span></span> <span data-ttu-id="4afda-120">Solo se deben establecer una vez.</span><span class="sxs-lookup"><span data-stu-id="4afda-120">These need only be set once.</span></span>
4.  <span data-ttu-id="4afda-121">La propiedad de un certificado determina el algoritmo hash.</span><span class="sxs-lookup"><span data-stu-id="4afda-121">A certificate's property determines the hash algorithm.</span></span>
5.  <span data-ttu-id="4afda-122">Un hash de los datos se crea mediante el envío de los datos a través de la función hash.</span><span class="sxs-lookup"><span data-stu-id="4afda-122">A hash of the data is created by sending the data through the hashing function.</span></span>
6.  <span data-ttu-id="4afda-123">La firma se crea mediante el cifrado del hash mediante la clave privada, obtenida a través de una propiedad en el certificado.</span><span class="sxs-lookup"><span data-stu-id="4afda-123">The signature is created by encrypting the hash using the private key, obtained through a property on the certificate.</span></span>
7.  <span data-ttu-id="4afda-124">Los datos siguientes se incluyen en el mensaje finalizado firmado:</span><span class="sxs-lookup"><span data-stu-id="4afda-124">The following data is included in the finished, signed message:</span></span>
    -   <span data-ttu-id="4afda-125">Los datos originales que se van a firmar.</span><span class="sxs-lookup"><span data-stu-id="4afda-125">The original data to be signed</span></span>
    -   <span data-ttu-id="4afda-126">Algoritmos hash</span><span class="sxs-lookup"><span data-stu-id="4afda-126">The hash algorithms</span></span>
    -   <span data-ttu-id="4afda-127">Las firmas</span><span class="sxs-lookup"><span data-stu-id="4afda-127">The signatures</span></span>
    -   <span data-ttu-id="4afda-128">Las estructuras de información del firmante, que incluye el identificador del firmante (emisor de certificados y número de serie)</span><span class="sxs-lookup"><span data-stu-id="4afda-128">The signer info structures, which includes the signer identifier (certificate issuer and serial number)</span></span>
    -   <span data-ttu-id="4afda-129">Los certificados del firmante (opcional)</span><span class="sxs-lookup"><span data-stu-id="4afda-129">The signer's certificates (optional)</span></span>

<span data-ttu-id="4afda-130">En este procedimiento se ilustra un caso sencillo.</span><span class="sxs-lookup"><span data-stu-id="4afda-130">This procedure illustrates a simple case.</span></span> <span data-ttu-id="4afda-131">Los casos más complejos implican atributos autenticados incluidos en el mensaje.</span><span class="sxs-lookup"><span data-stu-id="4afda-131">More complex cases involve authenticated attributes included in the message.</span></span> <span data-ttu-id="4afda-132">Cuando el tipo de contenido es cualquier cosa excepto una cadena de **bytes** , o hay al menos un atributo autenticado junto con cualquier tipo de datos, se requieren dos atributos estándar autenticados: el tipo de contenido (datos) y el hash del contenido.</span><span class="sxs-lookup"><span data-stu-id="4afda-132">When the content type is anything but a **BYTE** string, or there is at least one authenticated attribute along with any data type, there are two standard authenticated attributes required: the content (data) type, and the hash of the content.</span></span> <span data-ttu-id="4afda-133">En estas circunstancias, [*CryptoAPI*](../secgloss/c-gly.md) proporciona automáticamente estos dos atributos necesarios.</span><span class="sxs-lookup"><span data-stu-id="4afda-133">Under these circumstances, the [*CryptoAPI*](../secgloss/c-gly.md) automatically provides these two required attributes.</span></span> <span data-ttu-id="4afda-134">Las funciones de mensaje de bajo nivel aplican un algoritmo hash a los atributos autenticados, cifran el hash con la clave privada y lo proporcionan como firma.</span><span class="sxs-lookup"><span data-stu-id="4afda-134">The low-level message functions hash the authenticated attributes, encrypt the hash with the private key, and provide this as the signature.</span></span>

<span data-ttu-id="4afda-135">Utilice las funciones de mensaje de bajo nivel para realizar las tareas que se acaban de enumerar mediante el procedimiento siguiente.</span><span class="sxs-lookup"><span data-stu-id="4afda-135">Use the low-level message functions to accomplish the tasks just listed, by using the following procedure.</span></span>

<span data-ttu-id="4afda-136">**Para codificar un mensaje firmado**</span><span class="sxs-lookup"><span data-stu-id="4afda-136">**To encode a signed message**</span></span>

1.  <span data-ttu-id="4afda-137">Cree o recupere el contenido.</span><span class="sxs-lookup"><span data-stu-id="4afda-137">Create or retrieve the content.</span></span>
2.  <span data-ttu-id="4afda-138">Obtener un proveedor de servicios criptográficos.</span><span class="sxs-lookup"><span data-stu-id="4afda-138">Get a cryptographic provider.</span></span>
3.  <span data-ttu-id="4afda-139">Obtener los certificados del firmante.</span><span class="sxs-lookup"><span data-stu-id="4afda-139">Get the signer certificates.</span></span>
4.  <span data-ttu-id="4afda-140">Inicializa la estructura de [**\_ \_ \_ información de codificador de CMSG**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signer_encode_info) .</span><span class="sxs-lookup"><span data-stu-id="4afda-140">Initialize the [**CMSG\_SIGNER\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signer_encode_info) structure.</span></span>
5.  <span data-ttu-id="4afda-141">Inicialice la estructura de [**\_ \_ \_ información de codificación firmada CMSG**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signed_encode_info) .</span><span class="sxs-lookup"><span data-stu-id="4afda-141">Initialize the [**CMSG\_SIGNED\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signed_encode_info) structure.</span></span>
6.  <span data-ttu-id="4afda-142">Llame a [**CryptMsgCalculateEncodedLength**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength) para obtener el tamaño del BLOB del mensaje codificado.</span><span class="sxs-lookup"><span data-stu-id="4afda-142">Call [**CryptMsgCalculateEncodedLength**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength) to get the size of the encoded message BLOB.</span></span> <span data-ttu-id="4afda-143">Asigne memoria.</span><span class="sxs-lookup"><span data-stu-id="4afda-143">Allocate memory for it.</span></span>
7.  <span data-ttu-id="4afda-144">Llame a [**CryptMsgOpenToEncode**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), pasando CMSG \_ signed para *dwMsgType* y un puntero a [**CMSG \_ \_ \_ información de codificación firmada**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signed_encode_info) para *pvMsgEncodeInfo* para obtener un identificador del mensaje abierto.</span><span class="sxs-lookup"><span data-stu-id="4afda-144">Call [**CryptMsgOpenToEncode**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), passing in CMSG\_SIGNED for *dwMsgType* and a pointer to [**CMSG\_SIGNED\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signed_encode_info) for *pvMsgEncodeInfo* to get a handle to the opened message.</span></span>
8.  <span data-ttu-id="4afda-145">Llame a [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate), pasando el identificador recuperado en el paso 7 y un puntero a los datos que se van a firmar y codificar.</span><span class="sxs-lookup"><span data-stu-id="4afda-145">Call [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate), passing in the handle retrieved in step 7, and a pointer to the data that is to be signed and encoded.</span></span> <span data-ttu-id="4afda-146">Se puede llamar a esta función tantas veces como sea necesario para completar el proceso de codificación.</span><span class="sxs-lookup"><span data-stu-id="4afda-146">This function can be called as many times as necessary to complete the encoding process.</span></span>
9.  <span data-ttu-id="4afda-147">Llame a [**CryptMsgGetParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam), pasando el identificador recuperado en el paso 7 y los tipos de parámetro adecuados para tener acceso a los datos codificados deseados.</span><span class="sxs-lookup"><span data-stu-id="4afda-147">Call [**CryptMsgGetParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam), passing in the handle retrieved in step 7 and the appropriate parameter types to access the desired, encoded data.</span></span> <span data-ttu-id="4afda-148">Por ejemplo, pase \_ el parámetro de contenido CMSG \_ para obtener un puntero al mensaje [*PKCS \# 7*](../secgloss/p-gly.md) completo.</span><span class="sxs-lookup"><span data-stu-id="4afda-148">For example, pass in CMSG\_CONTENT\_PARAM to get a pointer to the entire [*PKCS \#7*](../secgloss/p-gly.md) message.</span></span>

    <span data-ttu-id="4afda-149">Si el resultado de esta codificación se va a usar como [*datos internos*](../secgloss/i-gly.md) de otro mensaje codificado, como un mensaje con doble cifrado, \_ \_ \_ se debe pasar el parámetro de parámetro CMSG de código sin sistema operativo.</span><span class="sxs-lookup"><span data-stu-id="4afda-149">If the result of this encoding is to be used as the [*inner data*](../secgloss/i-gly.md) for another encoded message, such as an enveloped message, the CMSG\_BARE\_CONTENT\_PARAM parameter must be passed.</span></span> <span data-ttu-id="4afda-150">Para ver un ejemplo que muestra esto, consulte el [código alternativo para codificar un mensaje con doble cifrado](alternate-code-for-encoding-an-enveloped-message.md).</span><span class="sxs-lookup"><span data-stu-id="4afda-150">For an example showing this, see [Alternate Code for Encoding an Enveloped Message](alternate-code-for-encoding-an-enveloped-message.md).</span></span>

10. <span data-ttu-id="4afda-151">Cierre el mensaje mediante una llamada a [**CryptMsgClose**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose).</span><span class="sxs-lookup"><span data-stu-id="4afda-151">Close the message by calling [**CryptMsgClose**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose).</span></span>

<span data-ttu-id="4afda-152">El resultado de este procedimiento es un mensaje codificado que contiene los datos originales, el hash cifrado de los datos (firma) y la información del firmante.</span><span class="sxs-lookup"><span data-stu-id="4afda-152">The result of this procedure is an encoded message that contains the original data, the encrypted hash of that data (signature), and the signer information.</span></span> <span data-ttu-id="4afda-153">También hay un puntero al BLOB codificado deseado.</span><span class="sxs-lookup"><span data-stu-id="4afda-153">There is also a pointer to the desired, encoded BLOB.</span></span>

<span data-ttu-id="4afda-154">Para obtener información detallada sobre la codificación en C, vea [ejemplo de programa c: firma, codificación, descodificación y comprobación de un mensaje](example-c-program-signing-encoding-decoding-and-verifying-a-message.md).</span><span class="sxs-lookup"><span data-stu-id="4afda-154">For C coding details, see [Example C Program: Signing, Encoding, Decoding, and Verifying a Message](example-c-program-signing-encoding-decoding-and-verifying-a-message.md).</span></span>

 

 
