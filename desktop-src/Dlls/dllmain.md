---
description: Un punto de entrada opcional en una biblioteca de vínculos dinámicos (DLL). Cuando el sistema inicia o finaliza un proceso o subproceso, llama a la función de punto de entrada para cada DLL cargada mediante el primer subproceso del proceso.
ms.assetid: 0c3e3083-9297-4626-b2a7-0062d1c2cf9e
title: Punto de entrada de DllMain (Process. h)
ms.topic: reference
ms.date: 07/22/2020
topic_type:
- APIRef
- kbSyntax
api_name:
- DllMain
api_type:
- UserDefined
api_location:
- process.h
ms.openlocfilehash: ee182fd54f11909e54e98f827904f1da5e46f557
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/08/2021
ms.locfileid: "105667634"
---
# <a name="dllmain-entry-point"></a><span data-ttu-id="d4eeb-104">Punto de entrada de DllMain</span><span class="sxs-lookup"><span data-stu-id="d4eeb-104">DllMain entry point</span></span>

<span data-ttu-id="d4eeb-105">Un punto de entrada opcional en una biblioteca de vínculos dinámicos (DLL).</span><span class="sxs-lookup"><span data-stu-id="d4eeb-105">An optional entry point into a dynamic-link library (DLL).</span></span> <span data-ttu-id="d4eeb-106">Cuando el sistema inicia o finaliza un proceso o subproceso, llama a la función de punto de entrada para cada DLL cargada mediante el primer subproceso del proceso.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-106">When the system starts or terminates a process or thread, it calls the entry-point function for each loaded DLL using the first thread of the process.</span></span> <span data-ttu-id="d4eeb-107">El sistema también llama a la función de punto de entrada de un archivo DLL cuando se carga o descarga mediante las funciones [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) y [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) .</span><span class="sxs-lookup"><span data-stu-id="d4eeb-107">The system also calls the entry-point function for a DLL when it is loaded or unloaded using the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) and [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) functions.</span></span>

## <a name="example"></a><span data-ttu-id="d4eeb-108">Ejemplo</span><span class="sxs-lookup"><span data-stu-id="d4eeb-108">Example</span></span>

```cpp
BOOL WINAPI DllMain(
    HINSTANCE hinstDLL,  // handle to DLL module
    DWORD fdwReason,     // reason for calling function
    LPVOID lpReserved )  // reserved
{
    // Perform actions based on the reason for calling.
    switch( fdwReason ) 
    { 
        case DLL_PROCESS_ATTACH:
         // Initialize once for each new process.
         // Return FALSE to fail DLL load.
            break;

        case DLL_THREAD_ATTACH:
         // Do thread-specific initialization.
            break;

        case DLL_THREAD_DETACH:
         // Do thread-specific cleanup.
            break;

        case DLL_PROCESS_DETACH:
         // Perform any necessary cleanup.
            break;
    }
    return TRUE;  // Successful DLL_PROCESS_ATTACH.
}
```

<span data-ttu-id="d4eeb-109">Este es un ejemplo de la [biblioteca de vínculos dinámicos Entry-Point función](dynamic-link-library-entry-point-function.md).</span><span class="sxs-lookup"><span data-stu-id="d4eeb-109">This is an example from the [Dynamic-Link Library Entry-Point Function](dynamic-link-library-entry-point-function.md).</span></span>


> [!WARNING]
> <span data-ttu-id="d4eeb-110">Hay límites importantes sobre lo que se puede hacer de forma segura en un punto de entrada del archivo DLL.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-110">There are significant limits on what you can safely do in a DLL entry point.</span></span> <span data-ttu-id="d4eeb-111">Vea las [prácticas recomendadas generales](dynamic-link-library-best-practices.md) para las API de Windows específicas que no se pueden llamar en DllMain.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-111">See [General Best Practices](dynamic-link-library-best-practices.md) for specific Windows APIs that are unsafe to call in DllMain.</span></span> <span data-ttu-id="d4eeb-112">Si necesita algo más que la inicialización más sencilla, puede hacerlo en una función de inicialización para el archivo DLL.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-112">If you need anything but the simplest initialization then do that in an initialization function for the DLL.</span></span> <span data-ttu-id="d4eeb-113">Puede requerir que las aplicaciones llamen a la función de inicialización después de que se haya ejecutado DllMain y antes de llamar a otras funciones del archivo DLL.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-113">You can require applications to call the initialization function after DllMain has run and before they call any other functions in the DLL.</span></span>

 

## <a name="syntax"></a><span data-ttu-id="d4eeb-114">Sintaxis</span><span class="sxs-lookup"><span data-stu-id="d4eeb-114">Syntax</span></span>


```C++
BOOL WINAPI DllMain(
  _In_ HINSTANCE hinstDLL,
  _In_ DWORD     fdwReason,
  _In_ LPVOID    lpvReserved
);
```



## <a name="parameters"></a><span data-ttu-id="d4eeb-115">Parámetros</span><span class="sxs-lookup"><span data-stu-id="d4eeb-115">Parameters</span></span>

<dl> <dt>

<span data-ttu-id="d4eeb-116">*hinstDLL* \[ de\]</span><span class="sxs-lookup"><span data-stu-id="d4eeb-116">*hinstDLL* \[in\]</span></span>
</dt> <dd>

<span data-ttu-id="d4eeb-117">Identificador del módulo DLL.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-117">A handle to the DLL module.</span></span> <span data-ttu-id="d4eeb-118">El valor es la dirección base del archivo DLL.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-118">The value is the base address of the DLL.</span></span> <span data-ttu-id="d4eeb-119">El **hInstance** de un archivo dll es el mismo que el **HMODULE** del archivo dll, por lo que *hinstDLL* se puede usar en llamadas a funciones que requieren un identificador de módulo.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-119">The **HINSTANCE** of a DLL is the same as the **HMODULE** of the DLL, so *hinstDLL* can be used in calls to functions that require a module handle.</span></span>

</dd> <dt>

<span data-ttu-id="d4eeb-120">*fdwReason* \[ de\]</span><span class="sxs-lookup"><span data-stu-id="d4eeb-120">*fdwReason* \[in\]</span></span>
</dt> <dd>

<span data-ttu-id="d4eeb-121">Código de motivo que indica por qué se llama a la función de punto de entrada del archivo DLL.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-121">The reason code that indicates why the DLL entry-point function is being called.</span></span> <span data-ttu-id="d4eeb-122">Este parámetro puede ser uno de los valores siguientes.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-122">This parameter can be one of the following values.</span></span>



| <span data-ttu-id="d4eeb-123">Valor</span><span class="sxs-lookup"><span data-stu-id="d4eeb-123">Value</span></span>                                                                                                                                                                                                                                | <span data-ttu-id="d4eeb-124">Significado</span><span class="sxs-lookup"><span data-stu-id="d4eeb-124">Meaning</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span id="DLL_PROCESS_ATTACH"></span><span id="dll_process_attach"></span><dl> <span data-ttu-id="d4eeb-125"><dt>**Archivo dll \_ PROCESO de \_ Asociación**</dt> <dt>1</dt></span><span class="sxs-lookup"><span data-stu-id="d4eeb-125"><dt>**DLL\_PROCESS\_ATTACH**</dt> <dt>1</dt></span></span> </dl> | <span data-ttu-id="d4eeb-126">El archivo DLL se carga en el espacio de direcciones virtuales del proceso actual como resultado del inicio del proceso o como resultado de una llamada a [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya).</span><span class="sxs-lookup"><span data-stu-id="d4eeb-126">The DLL is being loaded into the virtual address space of the current process as a result of the process starting up or as a result of a call to [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya).</span></span> <span data-ttu-id="d4eeb-127">Los archivos dll pueden utilizar esta oportunidad para inicializar los datos de una instancia o utilizar la función [**TlsAlloc**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsalloc) para asignar un índice de almacenamiento local de subprocesos (TLS).</span><span class="sxs-lookup"><span data-stu-id="d4eeb-127">DLLs can use this opportunity to initialize any instance data or to use the [**TlsAlloc**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsalloc) function to allocate a thread local storage (TLS) index.</span></span><br/> <span data-ttu-id="d4eeb-128">El parámetro *lpReserved* indica si el archivo dll se carga de forma estática o dinámica.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-128">The *lpReserved* parameter indicates whether the DLL is being loaded statically or dynamically.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| <span id="DLL_PROCESS_DETACH"></span><span id="dll_process_detach"></span><dl> <span data-ttu-id="d4eeb-129"><dt>**Archivo dll \_ \_Desasociar proceso**</dt> <dt>0</dt></span><span class="sxs-lookup"><span data-stu-id="d4eeb-129"><dt>**DLL\_PROCESS\_DETACH**</dt> <dt>0</dt></span></span> </dl> | <span data-ttu-id="d4eeb-130">La DLL se está descargando del espacio de direcciones virtuales del proceso que realiza la llamada porque se cargó sin éxito o hasta que el recuento de referencias ha alcanzado cero (los procesos han terminado o llamado a [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) una vez por cada vez que llamó a [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span><span class="sxs-lookup"><span data-stu-id="d4eeb-130">The DLL is being unloaded from the virtual address space of the calling process because it was loaded unsuccessfully or the reference count has reached zero (the processes has either terminated or called [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) one time for each time it called [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span></span><br/> <span data-ttu-id="d4eeb-131">El parámetro *lpReserved* indica si se está descargando el archivo dll como resultado de una llamada a [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) , un error de carga o la terminación del proceso.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-131">The *lpReserved* parameter indicates whether the DLL is being unloaded as a result of a [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) call, a failure to load, or process termination.</span></span><br/> <span data-ttu-id="d4eeb-132">El archivo DLL puede utilizar esta oportunidad para llamar a la función [**TlsFree**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsfree) para liberar los índices TLS asignados mediante [**TlsAlloc**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsalloc) y liberar los datos locales del subproceso.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-132">The DLL can use this opportunity to call the [**TlsFree**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsfree) function to free any TLS indices allocated by using [**TlsAlloc**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsalloc) and to free any thread local data.</span></span><br/> <span data-ttu-id="d4eeb-133">Tenga en cuenta que el subproceso que recibe la notificación de **\_ \_ desasociación del proceso dll** no es necesariamente el mismo subproceso que recibió la notificación de **\_ \_ Asociación del proceso dll** .</span><span class="sxs-lookup"><span data-stu-id="d4eeb-133">Note that the thread that receives the **DLL\_PROCESS\_DETACH** notification is not necessarily the same thread that received the **DLL\_PROCESS\_ATTACH** notification.</span></span><br/> |
| <span id="DLL_THREAD_ATTACH"></span><span id="dll_thread_attach"></span><dl> <span data-ttu-id="d4eeb-134"><dt>**Archivo dll \_ \_Conexión de subproceso**</dt> <dt>2</dt></span><span class="sxs-lookup"><span data-stu-id="d4eeb-134"><dt>**DLL\_THREAD\_ATTACH**</dt> <dt>2</dt></span></span> </dl>    | <span data-ttu-id="d4eeb-135">El proceso actual está creando un nuevo subproceso.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-135">The current process is creating a new thread.</span></span> <span data-ttu-id="d4eeb-136">Cuando esto ocurre, el sistema llama a la función de punto de entrada de todos los archivos dll asociados actualmente al proceso.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-136">When this occurs, the system calls the entry-point function of all DLLs currently attached to the process.</span></span> <span data-ttu-id="d4eeb-137">La llamada se realiza en el contexto del nuevo subproceso.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-137">The call is made in the context of the new thread.</span></span> <span data-ttu-id="d4eeb-138">Los archivos dll pueden utilizar esta oportunidad para inicializar una ranura TLS para el subproceso.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-138">DLLs can use this opportunity to initialize a TLS slot for the thread.</span></span> <span data-ttu-id="d4eeb-139">Un subproceso que llama a la función de punto de entrada de DLL con la **\_ \_ Asociación de proceso de dll** no llama a la función de punto de entrada de dll con la **\_ \_ Asociación de subprocesos de dll**.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-139">A thread calling the DLL entry-point function with **DLL\_PROCESS\_ATTACH** does not call the DLL entry-point function with **DLL\_THREAD\_ATTACH**.</span></span> <br/> <span data-ttu-id="d4eeb-140">Tenga en cuenta que el proceso de llama a la función de punto de entrada de un archivo DLL solo con este valor.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-140">Note that a DLL's entry-point function is called with this value only by threads created after the DLL is loaded by the process.</span></span> <span data-ttu-id="d4eeb-141">Cuando se carga un archivo DLL mediante [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya), los subprocesos existentes no llaman a la función de punto de entrada del archivo dll recién cargado.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-141">When a DLL is loaded using [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya), existing threads do not call the entry-point function of the newly loaded DLL.</span></span><br/>                                                                                                                                                                       |
| <span id="DLL_THREAD_DETACH"></span><span id="dll_thread_detach"></span><dl> <span data-ttu-id="d4eeb-142"><dt>**Archivo dll \_ \_Desasociación de SUBprocesos**</dt> <dt>3</dt></span><span class="sxs-lookup"><span data-stu-id="d4eeb-142"><dt>**DLL\_THREAD\_DETACH**</dt> <dt>3</dt></span></span> </dl>    | <span data-ttu-id="d4eeb-143">Un subproceso se está cerrando correctamente.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-143">A thread is exiting cleanly.</span></span> <span data-ttu-id="d4eeb-144">Si el archivo DLL ha almacenado un puntero a la memoria asignada en una ranura TLS, debe utilizar esta oportunidad para liberar memoria.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-144">If the DLL has stored a pointer to allocated memory in a TLS slot, it should use this opportunity to free the memory.</span></span> <span data-ttu-id="d4eeb-145">El sistema llama a la función de punto de entrada de todos los archivos dll cargados actualmente con este valor.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-145">The system calls the entry-point function of all currently loaded DLLs with this value.</span></span> <span data-ttu-id="d4eeb-146">La llamada se realiza en el contexto del subproceso de salida.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-146">The call is made in the context of the exiting thread.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |



 

</dd> <dt>

<span data-ttu-id="d4eeb-147">*lpvReserved* \[ de\]</span><span class="sxs-lookup"><span data-stu-id="d4eeb-147">*lpvReserved* \[in\]</span></span>
</dt> <dd>

<span data-ttu-id="d4eeb-148">Si *fdwReason* es **un \_ proceso dll \_ Attach**, *lpvReserved* es **null** para cargas dinámicas y no NULL para cargas estáticas.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-148">If *fdwReason* is **DLL\_PROCESS\_ATTACH**, *lpvReserved* is **NULL** for dynamic loads and non-NULL for static loads.</span></span>

<span data-ttu-id="d4eeb-149">Si *fdwReason* es **una \_ \_ desasociación del proceso de dll**, *lpvReserved* es **null** si se ha llamado a [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) o si se ha producido un error en la carga de dll y no es **null** si el proceso está finalizando.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-149">If *fdwReason* is **DLL\_PROCESS\_DETACH**, *lpvReserved* is **NULL** if [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) has been called or the DLL load failed and non-**NULL** if the process is terminating.</span></span>

</dd> </dl>

## <a name="return-value"></a><span data-ttu-id="d4eeb-150">Valor devuelto</span><span class="sxs-lookup"><span data-stu-id="d4eeb-150">Return value</span></span>

<span data-ttu-id="d4eeb-151">Cuando el sistema llama a la función **DllMain** con el valor **\_ \_ Attach del proceso dll** , la función devuelve **true** si se ejecuta correctamente o **false** si se produce un error de inicialización.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-151">When the system calls the **DllMain** function with the **DLL\_PROCESS\_ATTACH** value, the function returns **TRUE** if it succeeds or **FALSE** if initialization fails.</span></span> <span data-ttu-id="d4eeb-152">Si el valor devuelto es **false** cuando se llama a **DllMain** porque el proceso utiliza la función [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) , **LoadLibrary** devuelve NULL.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-152">If the return value is **FALSE** when **DllMain** is called because the process uses the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) function, **LoadLibrary** returns NULL.</span></span> <span data-ttu-id="d4eeb-153">(El sistema llama inmediatamente a la función de punto de entrada con la **\_ \_ desasociación del proceso de dll** y descarga el archivo dll). Si el valor devuelto es **false** cuando se llama a **DllMain** durante la inicialización del proceso, el proceso finaliza con un error.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-153">(The system immediately calls your entry-point function with **DLL\_PROCESS\_DETACH** and unloads the DLL.) If the return value is **FALSE** when **DllMain** is called during process initialization, the process terminates with an error.</span></span> <span data-ttu-id="d4eeb-154">Para obtener información de error extendida, llame a [**GetLastError**](/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror).</span><span class="sxs-lookup"><span data-stu-id="d4eeb-154">To get extended error information, call [**GetLastError**](/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror).</span></span>

<span data-ttu-id="d4eeb-155">Cuando el sistema llama a la función **DllMain** con cualquier valor distinto **de \_ \_ Attach del proceso dll**, se omite el valor devuelto.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-155">When the system calls the **DllMain** function with any value other than **DLL\_PROCESS\_ATTACH**, the return value is ignored.</span></span>

## <a name="remarks"></a><span data-ttu-id="d4eeb-156">Observaciones</span><span class="sxs-lookup"><span data-stu-id="d4eeb-156">Remarks</span></span>

<span data-ttu-id="d4eeb-157">**DllMain** es un marcador de posición para el nombre de la función definida por la biblioteca.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-157">**DllMain** is a placeholder for the library-defined function name.</span></span> <span data-ttu-id="d4eeb-158">Debe especificar el nombre real que utilizará al compilar el archivo DLL.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-158">You must specify the actual name you use when you build your DLL.</span></span> <span data-ttu-id="d4eeb-159">Para obtener más información, consulte la documentación que se incluye con las herramientas de desarrollo.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-159">For more information, see the documentation included with your development tools.</span></span>

<span data-ttu-id="d4eeb-160">Durante el inicio del proceso inicial o después de una llamada a [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya), el sistema examina la lista de archivos dll cargados para el proceso.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-160">During initial process startup or after a call to [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya), the system scans the list of loaded DLLs for the process.</span></span> <span data-ttu-id="d4eeb-161">Para cada DLL que todavía no se ha llamado con el **valor \_ \_ Attach del proceso de dll** , el sistema llama a la función de punto de entrada del archivo dll.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-161">For each DLL that has not already been called with the **DLL\_PROCESS\_ATTACH** value, the system calls the DLL's entry-point function.</span></span> <span data-ttu-id="d4eeb-162">Esta llamada se realiza en el contexto del subproceso que provocó el cambio del espacio de direcciones de proceso, como el subproceso principal del proceso o el subproceso que llamó a **LoadLibrary**.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-162">This call is made in the context of the thread that caused the process address space to change, such as the primary thread of the process or the thread that called **LoadLibrary**.</span></span> <span data-ttu-id="d4eeb-163">El sistema serializa el acceso al punto de entrada en todo el proceso.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-163">Access to the entry point is serialized by the system on a process-wide basis.</span></span> <span data-ttu-id="d4eeb-164">Los subprocesos de *DllMain* mantienen el bloqueo del cargador, por lo que no se puede cargar ni inicializar de forma dinámica ningún dll adicional.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-164">Threads in *DllMain* hold the loader lock so no additional DLLs can be dynamically loaded or initialized.</span></span>

<span data-ttu-id="d4eeb-165">Si la función de punto de entrada del archivo DLL devuelve FALSE después de una notificación de **\_ \_ Asociación de proceso de dll** , recibe una notificación de **\_ \_ desasociación de proceso de dll** y la dll se descarga inmediatamente.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-165">If the DLL's entry-point function returns FALSE following a **DLL\_PROCESS\_ATTACH** notification, it receives a **DLL\_PROCESS\_DETACH** notification and the DLL is unloaded immediately.</span></span> <span data-ttu-id="d4eeb-166">Sin embargo, si el código para **\_ \_ adjuntar el proceso dll** produce una excepción, la función de punto de entrada no recibirá la notificación de **\_ \_ desasociación del proceso dll** .</span><span class="sxs-lookup"><span data-stu-id="d4eeb-166">However, if the **DLL\_PROCESS\_ATTACH** code throws an exception, the entry-point function will not receive the **DLL\_PROCESS\_DETACH** notification.</span></span>

<span data-ttu-id="d4eeb-167">Hay casos en los que se llama a la función de punto de entrada para un subproceso de terminación aunque la función de punto de entrada nunca se llamara con la **\_ \_ Asociación de subprocesos de dll** para el subproceso:</span><span class="sxs-lookup"><span data-stu-id="d4eeb-167">There are cases in which the entry-point function is called for a terminating thread even if the entry-point function was never called with **DLL\_THREAD\_ATTACH** for the thread:</span></span>

-   <span data-ttu-id="d4eeb-168">El subproceso era el subproceso inicial en el proceso, por lo que el sistema llamó a la función de punto de entrada con el valor **\_ \_ Attach del proceso de dll** .</span><span class="sxs-lookup"><span data-stu-id="d4eeb-168">The thread was the initial thread in the process, so the system called the entry-point function with the **DLL\_PROCESS\_ATTACH** value.</span></span>
-   <span data-ttu-id="d4eeb-169">El subproceso ya se estaba ejecutando cuando se realizó una llamada a la función [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) , por lo que el sistema nunca llamó a la función de punto de entrada para él.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-169">The thread was already running when a call to the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) function was made, so the system never called the entry-point function for it.</span></span>

<span data-ttu-id="d4eeb-170">Cuando se descarga un archivo DLL de un proceso como resultado de una carga incorrecta del archivo DLL, la finalización del proceso o una llamada a [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary), el sistema no llama a la función de punto de entrada del archivo dll con el valor de **\_ \_ desasociación del subproceso dll** para los subprocesos individuales del proceso.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-170">When a DLL is unloaded from a process as a result of an unsuccessful load of the DLL, termination of the process, or a call to [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary), the system does not call the DLL's entry-point function with the **DLL\_THREAD\_DETACH** value for the individual threads of the process.</span></span> <span data-ttu-id="d4eeb-171">Solo se envía una notificación de **\_ \_ desasociación de proceso de DLL** a la dll.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-171">The DLL is only sent a **DLL\_PROCESS\_DETACH** notification.</span></span> <span data-ttu-id="d4eeb-172">Los archivos dll pueden tomar esta oportunidad para limpiar todos los recursos de todos los subprocesos que conoce el archivo DLL.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-172">DLLs can take this opportunity to clean up all resources for all threads known to the DLL.</span></span>

<span data-ttu-id="d4eeb-173">Al controlar **la \_ \_ desasociación de procesos DLL**, un archivo DLL debe liberar recursos como la memoria del montón solo si el archivo dll se descarga dinámicamente (el parámetro *lpReserved* es **null**).</span><span class="sxs-lookup"><span data-stu-id="d4eeb-173">When handling **DLL\_PROCESS\_DETACH**, a DLL should free resources such as heap memory only if the DLL is being unloaded dynamically (the *lpReserved* parameter is **NULL**).</span></span> <span data-ttu-id="d4eeb-174">Si el proceso está finalizando (el parámetro *lpvReserved* no es **null**), todos los subprocesos del proceso, excepto el subproceso actual, ya han salido o se han terminado explícitamente mediante una llamada a la función [**ExitProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-exitprocess) , lo que podría dejar algunos recursos de proceso, como los montones en un estado incoherente.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-174">If the process is terminating (the *lpvReserved* parameter is non-**NULL**), all threads in the process except the current thread either have exited already or have been explicitly terminated by a call to the [**ExitProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-exitprocess) function, which might leave some process resources such as heaps in an inconsistent state.</span></span> <span data-ttu-id="d4eeb-175">En este caso, no es seguro que el archivo DLL Limpie los recursos.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-175">In this case, it is not safe for the DLL to clean up the resources.</span></span> <span data-ttu-id="d4eeb-176">En su lugar, el archivo DLL debe permitir que el sistema operativo reclame la memoria.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-176">Instead, the DLL should allow the operating system to reclaim the memory.</span></span>

<span data-ttu-id="d4eeb-177">Si finaliza un proceso mediante una llamada a [**TerminateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess) o [**TerminateJobObject**](/windows/desktop/api/jobapi2/nf-jobapi2-terminatejobobject), los archivos dll de ese proceso no reciben las notificaciones de **\_ \_ desasociación del proceso dll** .</span><span class="sxs-lookup"><span data-stu-id="d4eeb-177">If you terminate a process by calling [**TerminateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess) or [**TerminateJobObject**](/windows/desktop/api/jobapi2/nf-jobapi2-terminatejobobject), the DLLs of that process do not receive **DLL\_PROCESS\_DETACH** notifications.</span></span> <span data-ttu-id="d4eeb-178">Si finaliza un subproceso llamando a [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread), los archivos dll de ese subproceso no recibirán notificaciones de **\_ \_ desasociación de subprocesos dll** .</span><span class="sxs-lookup"><span data-stu-id="d4eeb-178">If you terminate a thread by calling [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread), the DLLs of that thread do not receive **DLL\_THREAD\_DETACH** notifications.</span></span>

<span data-ttu-id="d4eeb-179">La función de punto de entrada solo debe realizar tareas simples de inicialización o finalización.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-179">The entry-point function should perform only simple initialization or termination tasks.</span></span> <span data-ttu-id="d4eeb-180">No debe llamar a la función [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) o [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) (o a una función que llama a estas funciones), ya que esto puede crear bucles de dependencia en el orden de carga de dll.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-180">It must not call the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) or [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) function (or a function that calls these functions), because this may create dependency loops in the DLL load order.</span></span> <span data-ttu-id="d4eeb-181">Esto puede dar lugar a que se utilice un archivo DLL antes de que el sistema ejecute su código de inicialización.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-181">This can result in a DLL being used before the system has executed its initialization code.</span></span> <span data-ttu-id="d4eeb-182">Del mismo modo, la función de punto de entrada no debe llamar a la función [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) (o una función que llame a **FreeLibrary**) durante la terminación del proceso, ya que esto puede dar lugar a que se use un archivo dll después de que el sistema haya ejecutado su código de finalización.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-182">Similarly, the entry-point function must not call the [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) function (or a function that calls **FreeLibrary**) during process termination, because this can result in a DLL being used after the system has executed its termination code.</span></span>

<span data-ttu-id="d4eeb-183">Dado que se garantiza la carga de Kernel32.dll en el espacio de direcciones de proceso cuando se llama a la función de punto de entrada, al llamar a funciones en Kernel32.dll no se usa el archivo DLL antes de que se haya ejecutado el código de inicialización.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-183">Because Kernel32.dll is guaranteed to be loaded in the process address space when the entry-point function is called, calling functions in Kernel32.dll does not result in the DLL being used before its initialization code has been executed.</span></span> <span data-ttu-id="d4eeb-184">Por consiguiente, la función de punto de entrada puede llamar a funciones de Kernel32.dll que no cargan otros archivos dll.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-184">Therefore, the entry-point function can call functions in Kernel32.dll that do not load other DLLs.</span></span> <span data-ttu-id="d4eeb-185">Por ejemplo, *DllMain* puede crear [objetos de sincronización](/windows/desktop/Sync/synchronization-objects) , como secciones críticas y exclusiones mutuas, y usar TLS.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-185">For example, *DllMain* can create [synchronization objects](/windows/desktop/Sync/synchronization-objects) such as critical sections and mutexes, and use TLS.</span></span> <span data-ttu-id="d4eeb-186">Desafortunadamente, no hay una lista completa de funciones seguras en Kernel32.dll.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-186">Unfortunately, there is not a comprehensive list of safe functions in Kernel32.dll.</span></span>

<span data-ttu-id="d4eeb-187">Llamar a funciones que requieren archivos dll distintos de Kernel32.dll puede producir problemas difíciles de diagnosticar.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-187">Calling functions that require DLLs other than Kernel32.dll may result in problems that are difficult to diagnose.</span></span> <span data-ttu-id="d4eeb-188">Por ejemplo, llamar a funciones de usuario, Shell y COM puede provocar errores de infracción de acceso, ya que algunas funciones cargan otros componentes del sistema.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-188">For example, calling User, Shell, and COM functions can cause access violation errors, because some functions load other system components.</span></span> <span data-ttu-id="d4eeb-189">Por el contrario, llamar a funciones como estas durante la terminación puede provocar errores de infracción de acceso porque es posible que el componente correspondiente ya se haya descargado o no inicializado.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-189">Conversely, calling functions such as these during termination can cause access violation errors because the corresponding component may already have been unloaded or uninitialized.</span></span>

<span data-ttu-id="d4eeb-190">Dado que las notificaciones de DLL se serializan, las funciones de punto de entrada no deben intentar comunicarse con otros subprocesos o procesos.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-190">Because DLL notifications are serialized, entry-point functions should not attempt to communicate with other threads or processes.</span></span> <span data-ttu-id="d4eeb-191">Como resultado, pueden producirse interbloqueos.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-191">Deadlocks may occur as a result.</span></span>

<span data-ttu-id="d4eeb-192">Para obtener información acerca de los procedimientos recomendados para escribir un archivo DLL, vea https://docs.microsoft.com/windows/win32/dlls/dynamic-link-library-best-practices .</span><span class="sxs-lookup"><span data-stu-id="d4eeb-192">For information on best practices when writing a DLL, see https://docs.microsoft.com/windows/win32/dlls/dynamic-link-library-best-practices.</span></span>

<span data-ttu-id="d4eeb-193">Si el archivo DLL se vincula con la biblioteca en tiempo de ejecución de C (CRT), el punto de entrada proporcionado por CRT llama a los constructores y destructores para los objetos de C++ globales y estáticos.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-193">If your DLL is linked with the C run-time library (CRT), the entry point provided by the CRT calls the constructors and destructors for global and static C++ objects.</span></span> <span data-ttu-id="d4eeb-194">Por lo tanto, estas restricciones de *DllMain* también se aplican a los constructores y destructores y al código al que se llama desde ellos.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-194">Therefore, these restrictions for *DllMain* also apply to constructors and destructors and any code that is called from them.</span></span>

<span data-ttu-id="d4eeb-195">Considere la posibilidad de llamar a [**DisableThreadLibraryCalls**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) al recibir la **\_ \_ Asociación del proceso dll**, a menos que el archivo dll esté vinculado con la biblioteca en tiempo de ejecución de C (CRT) estática.</span><span class="sxs-lookup"><span data-stu-id="d4eeb-195">Consider calling [**DisableThreadLibraryCalls**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) when receiving **DLL\_PROCESS\_ATTACH**, unless your DLL is linked with static C run-time library (CRT).</span></span>


## <a name="requirements"></a><span data-ttu-id="d4eeb-196">Requisitos</span><span class="sxs-lookup"><span data-stu-id="d4eeb-196">Requirements</span></span>



| <span data-ttu-id="d4eeb-197">Requisito</span><span class="sxs-lookup"><span data-stu-id="d4eeb-197">Requirement</span></span> | <span data-ttu-id="d4eeb-198">Value</span><span class="sxs-lookup"><span data-stu-id="d4eeb-198">Value</span></span> |
|-------------------------------------|--------------------------------------------------------------------------------------|
| <span data-ttu-id="d4eeb-199">Cliente mínimo compatible</span><span class="sxs-lookup"><span data-stu-id="d4eeb-199">Minimum supported client</span></span><br/> | <span data-ttu-id="d4eeb-200">Solo aplicaciones de escritorio de Windows XP \[\]</span><span class="sxs-lookup"><span data-stu-id="d4eeb-200">Windows XP \[desktop apps only\]</span></span><br/>                                          |
| <span data-ttu-id="d4eeb-201">Servidor mínimo compatible</span><span class="sxs-lookup"><span data-stu-id="d4eeb-201">Minimum supported server</span></span><br/> | <span data-ttu-id="d4eeb-202">Solo aplicaciones de escritorio de Windows Server 2003 \[\]</span><span class="sxs-lookup"><span data-stu-id="d4eeb-202">Windows Server 2003 \[desktop apps only\]</span></span><br/>                                 |
| <span data-ttu-id="d4eeb-203">Encabezado</span><span class="sxs-lookup"><span data-stu-id="d4eeb-203">Header</span></span><br/>                   | <dl> <span data-ttu-id="d4eeb-204"><dt>Process. h</dt></span><span class="sxs-lookup"><span data-stu-id="d4eeb-204"><dt>Process.h</dt></span></span> </dl> |



## <a name="see-also"></a><span data-ttu-id="d4eeb-205">Vea también</span><span class="sxs-lookup"><span data-stu-id="d4eeb-205">See also</span></span>

<dl> <dt>

[<span data-ttu-id="d4eeb-206">Función Entry-Point de la biblioteca de vínculos dinámicos</span><span class="sxs-lookup"><span data-stu-id="d4eeb-206">Dynamic-Link Library Entry-Point Function</span></span>](dynamic-link-library-entry-point-function.md)
</dt> <dt>

[<span data-ttu-id="d4eeb-207">Funciones de la biblioteca de vínculos dinámicos</span><span class="sxs-lookup"><span data-stu-id="d4eeb-207">Dynamic-Link Library Functions</span></span>](dynamic-link-library-functions.md)
</dt> <dt>

[<span data-ttu-id="d4eeb-208">**FreeLibrary**</span><span class="sxs-lookup"><span data-stu-id="d4eeb-208">**FreeLibrary**</span></span>](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary)
</dt> <dt>

[<span data-ttu-id="d4eeb-209">**GetModuleFileName**</span><span class="sxs-lookup"><span data-stu-id="d4eeb-209">**GetModuleFileName**</span></span>](/windows/win32/api/libloaderapi/nf-libloaderapi-getmodulefilenamea)
</dt> <dt>

[<span data-ttu-id="d4eeb-210">**LoadLibrary**</span><span class="sxs-lookup"><span data-stu-id="d4eeb-210">**LoadLibrary**</span></span>](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)
</dt> <dt>

[<span data-ttu-id="d4eeb-211">**TlsAlloc**</span><span class="sxs-lookup"><span data-stu-id="d4eeb-211">**TlsAlloc**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsalloc)
</dt> <dt>

[<span data-ttu-id="d4eeb-212">**TlsFree**</span><span class="sxs-lookup"><span data-stu-id="d4eeb-212">**TlsFree**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsfree)
</dt> <dt>

[<span data-ttu-id="d4eeb-213">**DisableThreadLibraryCalls**</span><span class="sxs-lookup"><span data-stu-id="d4eeb-213">**DisableThreadLibraryCalls**</span></span>](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls)





</dt> </dl>
