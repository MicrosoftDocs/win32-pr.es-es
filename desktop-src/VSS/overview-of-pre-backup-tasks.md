---
description: Las tareas anteriores a la copia de seguridad en VSS se centran en crear una instantánea de los volúmenes que contienen datos para la copia de seguridad.
ms.assetid: e6b082af-719b-4426-8217-0fc940f5884d
title: Información general de las tareas anteriores a la copia de seguridad
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 709345b8aa0421699efe26ad2901cc497b7d4ac0
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/07/2021
ms.locfileid: "105696990"
---
# <a name="overview-of-pre-backup-tasks"></a>Información general de las tareas anteriores a la copia de seguridad

Las tareas anteriores a la copia de seguridad en VSS se centran en crear una instantánea de los volúmenes que contienen datos para la copia de seguridad. La aplicación de copia de seguridad guardará los datos de la instantánea, no del volumen real. Para obtener más información, vea [información general sobre el procesamiento de una copia de seguridad en VSS](overview-of-processing-a-backup-under-vss.md).

Los solicitantes suelen esperar a que los escritores se preparen para la copia de seguridad y la creación de la instantánea. El escritor debe determinar si va a participar en la copia de seguridad y, si es así, configurar sus archivos y para que estén listos para la copia de seguridad y la instantánea. En la tabla siguiente se muestra la secuencia de acciones y eventos necesarios para preparar una operación de copia de seguridad.



| Acción del solicitante                                                                                                                                                                                                                                                                                                            | Evento                                                                      | Acción del escritor                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| El solicitante puede establecer las opciones de copia de seguridad (vea [**IVssBackupComponents:: SetBackupOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupoptions)).                                                                                                                                                                                          | None                                                                       | None                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Se admiten las operaciones de copia de seguridad incrementales y diferenciales mediante el examen de las marcas de copia de seguridad almacenadas (vea [**IVssComponent:: GetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupstamp), [**IVssBackupComponents:: SetPreviousBackupStamp).**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp)                                               | None                                                                       | None                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Notificar a los escritores que se preparen para una operación de copia de seguridad mediante [ **IVssBackupComponents::P repareforbackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup)                                                                                                                                                                              | [*PrepareForBackup*](vssgloss-p.md)  | Los preparativos del escritor incluyen la determinación de si se debe hacer una copia de seguridad de los archivos, si el escritor participará en la inmovilización de instantáneas, así como para crear metadatos específicos del escritor (vea [**CVssWriter:: OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup), [**CVssWriter:: IsPathAffected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispathaffected), [**IVssWriterComponents**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents), [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent), [**IVssComponent:: GetBackupOptions**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupoptions), [**CVssWriter:: AreComponentsSelected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-arecomponentsselected), [**IVssComponent:: SetBackupMetadata**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupmetadata)y [**IVssComponent:**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp) |
| El solicitante espera a que los escritores se configuren para la copia de seguridad mediante [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync). También debe comprobar el estado del escritor (consulte [**IVssBackupComponents:: GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**IVssBackupComponents:: GetWriterStatus).**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus)     | None                                                                       | None                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| El solicitante solicita una instantánea mediante [ **IVssBackupComponents::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset)                                                                                                                                                                                                    | None                                                                       | None                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| None                                                                                                                                                                                                                                                                                                                        | [*PrepareForSnapshot*](vssgloss-p.md) | [**CVssWriter:: OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot): pone el escritor en un estado listo para la instantánea.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| None                                                                                                                                                                                                                                                                                                                        | [*Inmovilizar*](vssgloss-f.md)                      | [**CVssWriter:: alfreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze): configuración final antes de la instantánea.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| None                                                                                                                                                                                                                                                                                                                        | [*Reanudar*](vssgloss-t.md)                          | [**CVssWriter:: Alreanudar**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw): el funcionamiento normal (incluida la e/s) se puede reanudar.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| None                                                                                                                                                                                                                                                                                                                        | [*Instantánea*](vssgloss-p.md)          | [**CVssWriter:: OnPostSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot): limpiezas finales de los preparados de instantáneas. Vea [**IVssComponent:: AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime) y [**IVssComponent:: SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp).<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| El solicitante espera la finalización de la instantánea mediante: [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync), también debe comprobar el estado del escritor (consulte [**IVssBackupComponents:: GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**IVssBackupComponents:: GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus)<br/> | None                                                                       | None                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |



 

## <a name="requester-pre-backup-tasks"></a>Tareas anteriores a la copia de seguridad del solicitante

Además, antes de crear un evento [**IVssBackupComponents::P repareforbackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) , un solicitante también puede establecer opciones de copia de seguridad para escritores individuales mediante [**IVssBackupComponents:: SetBackupOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupoptions) en función de los detalles de cada escritor y de si un solicitante es consciente de ellos.

Para admitir operaciones incrementales y diferenciales, los solicitantes pueden en este momento examinar los componentes para las marcas de tiempo de la operación de copia de seguridad anterior (mediante [**IVssComponent:: GetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupstamp)) y usar esa información para establecer una marca de tiempo anterior para que un escritor lo procese (mediante [**IVssBackupComponents:: SetPreviousBackupStamp**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp)). Para obtener más información [, vea copias de seguridad incrementales y diferenciales](incremental-and-differential-backups.md) .

Ahora, un solicitante puede dirigir los escritores del sistema para completar los preparativos de la copia de seguridad y controlar la creación de una instantánea.

En primer lugar, el solicitante genera un evento [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) llamando a [**IVssBackupComponents::P repareforbackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup).

Después de que todos los escritores participantes devuelvan el control del evento [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) (que un solicitante determina mediante la instancia de la interfaz [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync) devuelta por **PrepareForBackup**), el solicitante puede iniciar la instantánea llamando a [**IVssBackupComponents::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset), que, a medida que progresa, generará [*PrepareForSnapshot*](vssgloss-p.md), [*Freeze*](vssgloss-f.md), [*reanudar*](vssgloss-t.md)y [*postsnapshot*](vssgloss-p.md) eventos para que los escritores los controlen.

Hay algunos casos en los que es posible que un solicitante no necesite crear una instantánea. En concreto, cada [*conjunto de archivos*](vssgloss-f.md) administrado por uno de los componentes de un escritor determinado tiene una máscara de copia de seguridad de especificación de archivo (indicada por una operación OR bit a bit de los valores del tipo de copia de seguridad de la especificación de [**\_ archivo \_ \_ \_ VSS**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type) ) establecida durante el evento de [*identificación*](vssgloss-i.md) . Esta máscara especifica, entre otras cosas, si un conjunto de archivos requiere que se realice una copia sombra del sistema antes de realizar la copia de seguridad.

Si no es necesario realizar una copia de seguridad de los conjuntos de archivos de los que se va a hacer una copia de seguridad en los volúmenes, no es necesario llamar a [**IVssBackupComponents::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) .

## <a name="writer-pre-backup-tasks"></a>Tareas de copia de seguridad previa del escritor

Al controlar el evento [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) , VSS llamará al método [**CVssWriter:: OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) de cada redactor, un método virtual, que, de forma predeterminada, simplemente devuelve true.

Los escritores pueden invalidar esta implementación predeterminada y usar el control para buscar información acerca de la próxima copia de seguridad y tomar medidas.

Un escritor puede determinar la información sobre el tipo de operación de copia de seguridad conformada mediante los siguientes métodos:

1.  [**CVssWriter::GetBackupType**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-getbackuptype)
2.  [**CVssWriter::IsBootableStateBackedUp**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-isbootablesystemstatebackedup)
3.  [**CVssWriter::AreComponentsSelected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-arecomponentsselected)

Un escritor determina si los archivos que administra estarán implicados en la instantánea mediante [**CVssWriter:: IsPathAffected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispathaffected).

Lo que es más importante, cuando VSS llama al método [**CVssWriter:: OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) , pasa una instancia de la interfaz [**IVssWriterComponents**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents) , que permite el acceso directo a través de la interfaz [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) a los de sus componentes [*incluidos explícitamente*](vssgloss-e.md) en el documento de componentes de copia de seguridad del solicitante. El escritor usaba las instancias de la interfaz **IVssComponent** que definen los conjuntos de componentes para obtener acceso a su componente *incluido implícitamente* (consulte [seleccionar y trabajar con propiedades de componentes](selectability-and-working-with-component-properties.md)).

Durante el control del evento [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) , los escritores usan la interfaz [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) para realizar operaciones componente a componente (o conjunto de componentes por conjunto de componentes), incluidas las siguientes:

1.  Agregar [*archivos parciales*](vssgloss-p.md) (si se admiten) mediante una llamada a [**IVssComponent:: AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile).
2.  Establecer los metadatos privados que el escritor deberá controlar la restauración.
3.  Si el escritor admite copias de seguridad incrementales y diferenciales (vea [copias de seguridad incrementales y diferenciales](incremental-and-differential-backups.md)), haga lo siguiente:
    -   Comprobando las marcas de tiempo de copia de seguridad anteriores mediante una llamada a [**IVssComponent:: GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp).
    -   Agregar los [*archivos de diferencias*](vssgloss-d.md) necesarios llamando a [**IVssComponent:: AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime).
    -   Si el escritor admite el esquema de marca de tiempo de **VSS \_ BS \_** , agrega cadenas de marca de tiempo de copia de seguridad en el propio formato del escritor mediante [**IVssComponent:: SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp).
4.  Iniciar operaciones asincrónicas que consumen mucho tiempo, como la sincronización de datos en varios discos. Esto permitirá que el escritor siga funcionando mientras se procesa la operación, incluido el control de otros eventos de VSS. Estas operaciones deben finalizar antes del evento [*Freeze*](vssgloss-f.md) .

La llamada del solicitante a [**IVssBackupComponents::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) inicia la instantánea y genera los siguientes eventos para que los escritores los controlen:

-   [*PrepareForSnapshot*](vssgloss-p.md)
-   [*Inmovilizar*](vssgloss-f.md)
-   [*Reanudar*](vssgloss-t.md)
-   [*Instantánea*](vssgloss-p.md)

Tres de los controladores del escritor ([**CVssWriter:: OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot), [**CVssWriter:: alfreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze)y [**CVssWriter:: alreanudar**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw)) son métodos virtuales puros y cada escritor debe implementarlos en lugar de confiar en los valores predeterminados. Dependiendo de las necesidades de un escritor, se pueden codificar como métodos ficticios, simplemente devolviendo **true**.

Dado que normalmente hay un período de tiempo limitado entre la emisión de un evento [*Freeze*](vssgloss-f.md) y la emisión de un evento [*procongelar*](vssgloss-t.md) , la mayor parte del trabajo principal en la preparación de la instantánea, como el apagado de procesos, la creación de archivos temporales o la purga de colas de e/s, se administraría en [**CVssWriter:: OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot).

Cómo un escritor podría usar [**CVssWriter:: OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) para controlar su e/s antes de que la creación de una instantánea dependa en gran medida de la arquitectura del escritor.

Los escritores que pueden permitirse mantener todas las escrituras y mantener los datos en un estado coherente absoluto antes de la [*inmovilización*](vssgloss-f.md)deben hacerlo.

Si el escritor no puede inmovilizar su e/s, debe tomar medidas para crear un origen estable para la copia de seguridad y reducir el tiempo de recuperación de una instantánea. Ejemplos de esto pueden incluir solicitudes de e/s de entrada en cola o generar un conjunto duplicado de archivos en una [*ruta de acceso alternativa*](vssgloss-a.md) que se utilizará como origen de una copia de seguridad.

El método [**CVssWriter:: alfreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze) realiza tareas simples y cortas, como comprobar que la e/s izquierda [**CVssWriter:: OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) en el estado correcto y que las tareas asincrónicas iniciadas por [**CVssWriter:: OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) se han completado. Este método es la última oportunidad de un escritor de vetar una instantánea si hay problemas (vea los [errores y vetos del escritor](writer-errors-and-vetoes.md)).

Por lo general, es posible que un escritor reanude la operación normal después de un evento de [*reanudación*](vssgloss-t.md) : es posible que una instantánea no esté lista inmediatamente para la copia de seguridad después de la reanudación, pero un escritor debe ser capaz de reanudar el funcionamiento normal. Por lo tanto, los escritores usan normalmente [**CVssWriter:: Alreanudar**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) para volver a un estado de precongelación. Sin embargo, los archivos temporales creados para admitir la instantánea deben dejarse en vigor hasta el evento [*postsnapshot*](vssgloss-p.md) . Normalmente, se usaría [**CVssWriter:: OnPostSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot) para este tipo de limpieza. Dado que muchas aplicaciones no requieren este tipo de limpieza, **CVssWriter:: OnPostSnapshot** es un método virtual con una implementación predeterminada que simplemente devuelve **true**. Si se realiza una copia de seguridad incremental o diferencial, el escritor puede llamar a [**IVssComponent:: GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp) y [**IVssComponent:: SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp). Para obtener más información, consulte [rol de escritor en copias de seguridad de almacenes complejos](writer-role-in-backing-up-complex-stores.md). Otro método al que se puede llamar en este momento es [**IVssComponent:: AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime).

 

 




