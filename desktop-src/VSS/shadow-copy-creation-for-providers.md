---
description: Creación de instantáneas para proveedores
ms.assetid: d5042945-ba81-40d0-b204-1f08d153a788
title: Creación de instantáneas para proveedores
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 91cc7306e7a13ef8e96ab032016a922411a70f95
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/07/2021
ms.locfileid: "104082478"
---
# <a name="shadow-copy-creation-for-providers"></a><span data-ttu-id="a01bf-103">Creación de instantáneas para proveedores</span><span class="sxs-lookup"><span data-stu-id="a01bf-103">Shadow Copy Creation for Providers</span></span>

## <a name="the-shadow-copy-creation-process"></a><span data-ttu-id="a01bf-104">Proceso de creación de instantáneas</span><span class="sxs-lookup"><span data-stu-id="a01bf-104">The Shadow Copy Creation Process</span></span>

<span data-ttu-id="a01bf-105">Un solicitante es la aplicación que inicia la solicitud para crear una instantánea.</span><span class="sxs-lookup"><span data-stu-id="a01bf-105">A requester is the application that initiates the request to create a shadow copy.</span></span> <span data-ttu-id="a01bf-106">Normalmente, el solicitante es una aplicación de copia de seguridad.</span><span class="sxs-lookup"><span data-stu-id="a01bf-106">Typically the requester is a backup application.</span></span> <span data-ttu-id="a01bf-107">Según sea necesario, VSS llamará a los proveedores implicados.</span><span class="sxs-lookup"><span data-stu-id="a01bf-107">As necessary, VSS will call the providers involved.</span></span> <span data-ttu-id="a01bf-108">La mayoría de los proveedores están interesados en tres solicitudes específicas del solicitante.</span><span class="sxs-lookup"><span data-stu-id="a01bf-108">Most providers are interested in three specific requests from the requester.</span></span>

1.  <span data-ttu-id="a01bf-109">El solicitante comienza la actividad de creación de instantáneas con una llamada a [**IVssBackupComponents:: StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset).</span><span class="sxs-lookup"><span data-stu-id="a01bf-109">The requester begins the shadow copy creation activity with a call to [**IVssBackupComponents::StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset).</span></span> <span data-ttu-id="a01bf-110">Esto genera un **GUID** de tipo **\_ ID de VSS** que identifica de forma única este conjunto de instantáneas específico: SnapshotSetId.</span><span class="sxs-lookup"><span data-stu-id="a01bf-110">This generates a **GUID** of type **VSS\_ID** that uniquely identifies this specific shadow copy set - the SnapshotSetId.</span></span> <span data-ttu-id="a01bf-111">El proveedor no está implicado en este paso, pero el SnapshotSetId se usa en todos los pasos siguientes.</span><span class="sxs-lookup"><span data-stu-id="a01bf-111">The provider is not involved in this step, but the SnapshotSetId is used extensively in all subsequent steps.</span></span>
2.  <span data-ttu-id="a01bf-112">Para cada volumen que desea incluir en este conjunto de instantáneas, el solicitante llama a [**IVssBackupComponents:: AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset).</span><span class="sxs-lookup"><span data-stu-id="a01bf-112">For each volume it wishes to include in this shadow copy set, the requester calls [**IVssBackupComponents::AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset).</span></span> <span data-ttu-id="a01bf-113">VSS determina qué proveedor se usará para realizar la instantánea del volumen.</span><span class="sxs-lookup"><span data-stu-id="a01bf-113">VSS determines which provider will be used to shadow copy the volume.</span></span>
    -   <span data-ttu-id="a01bf-114">Varios proveedores pueden participar en un conjunto de instantáneas.</span><span class="sxs-lookup"><span data-stu-id="a01bf-114">Multiple providers may participate in a shadow copy set.</span></span> <span data-ttu-id="a01bf-115">Por ejemplo, si el volumen del sistema y un volumen de datos forman parte del mismo conjunto de instantáneas, es posible que el proveedor del sistema sirva como proveedor de instantáneas para el volumen del sistema, mientras que un proveedor de hardware puede actuar como proveedor de instantáneas para el volumen de datos.</span><span class="sxs-lookup"><span data-stu-id="a01bf-115">For example, if the system volume and a data volume are part of the same shadow copy set, the system provider may serve as the shadow copy provider for the system volume while a hardware provider may serve as the shadow copy provider for the data volume.</span></span> <span data-ttu-id="a01bf-116">Ambos proveedores formarían parte del mismo conjunto de instantáneas y el usuario esperaría la misma coherencia a un momento dado en ambos volúmenes.</span><span class="sxs-lookup"><span data-stu-id="a01bf-116">Both providers would be part of the same shadow copy set and the user would expect the same point-in-time consistency across both volumes.</span></span>
    -   <span data-ttu-id="a01bf-117">Para que se seleccione un proveedor de hardware, el proveedor de hardware debe ser capaz de admitir todos los LUN que contribuyan al volumen especificado.</span><span class="sxs-lookup"><span data-stu-id="a01bf-117">For a hardware provider to be selected, the hardware provider must be able to support all LUNs contributing to the specified volume.</span></span>
    -   <span data-ttu-id="a01bf-118">A todos los proveedores registrados se les da la oportunidad de indicar compatibilidad con un volumen determinado durante la creación de la instantánea.</span><span class="sxs-lookup"><span data-stu-id="a01bf-118">All registered providers are given the opportunity to indicate support for a given volume during shadow copy creation.</span></span> <span data-ttu-id="a01bf-119">Si hay más de un proveedor que indica compatibilidad, VSS usará primero los proveedores de hardware, los proveedores de software y, por último, el proveedor del sistema (si ningún otro proveedor indica compatibilidad con ese volumen).</span><span class="sxs-lookup"><span data-stu-id="a01bf-119">If more than one provider indicates support, VSS will first default to hardware providers, then software providers, and finally the system provider (if no other provider indicates support for that volume).</span></span>
    -   <span data-ttu-id="a01bf-120">Un solicitante puede invalidar este orden predeterminado indicando explícitamente el proveedor que necesita para crear la instantánea.</span><span class="sxs-lookup"><span data-stu-id="a01bf-120">A requester may override this default order by explicitly indicating the provider it requires to create the shadow copy.</span></span>
    -   <span data-ttu-id="a01bf-121">Si hay varios proveedores de hardware que admiten un volumen determinado, no hay ninguna garantía sobre el orden en el que se llamará a los proveedores de hardware.</span><span class="sxs-lookup"><span data-stu-id="a01bf-121">If there are multiple hardware providers that support a given volume, there is no guarantee to the order in which the hardware providers will be called.</span></span>
3.  <span data-ttu-id="a01bf-122">Después de una o varias llamadas a [**AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset), el solicitante puede solicitar que se cree la instantánea con el método [**IVssBackupComponents::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) .</span><span class="sxs-lookup"><span data-stu-id="a01bf-122">After one or more calls to [**AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset), the requester can ask for the shadow copy to be created by using the [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) method.</span></span> <span data-ttu-id="a01bf-123">A continuación, VSS funciona con el sistema para crear la instantánea.</span><span class="sxs-lookup"><span data-stu-id="a01bf-123">VSS then works with the system to create the shadow copy.</span></span> <span data-ttu-id="a01bf-124">El método **DoSnapshotSet** realiza este trabajo de forma asincrónica y el solicitante puede sondear o esperar a que se complete el proceso de creación de instantáneas.</span><span class="sxs-lookup"><span data-stu-id="a01bf-124">The **DoSnapshotSet** method performs this work asynchronously, and the requester can either poll or wait for the shadow copy creation process to complete.</span></span>

<span data-ttu-id="a01bf-125">En este diagrama se muestran las interacciones entre el solicitante, el servicio VSS, la compatibilidad con el kernel de VSS, cualquier Escritor VSS implicado y cualquier proveedor de hardware VSS.</span><span class="sxs-lookup"><span data-stu-id="a01bf-125">This diagram shows the interactions between the requester, the VSS service, the VSS kernel support, any VSS writers involved, and any VSS hardware providers.</span></span> <span data-ttu-id="a01bf-126">Vea [el proceso de creación de instantáneas](the-shadow-copy-creation-process.md) para obtener una descripción detallada de estas interacciones.</span><span class="sxs-lookup"><span data-stu-id="a01bf-126">See [The Shadow Copy Creation Process](the-shadow-copy-creation-process.md) for a detailed description of these interactions.</span></span>

![interacciones entre el solicitante, los componentes de copia de seguridad, los escritores y los proveedores](images/vssimpl.png)

<span data-ttu-id="a01bf-128">Una vez completado el proceso de creación de la instantánea, el solicitante puede determinar si la creación de la instantánea se ha realizado correctamente y, si no es así, determinar el origen del error.</span><span class="sxs-lookup"><span data-stu-id="a01bf-128">When the shadow copy creation process is complete, the requester can determine if the shadow copy creation was successful, and if not, determine the source of the failure.</span></span>

<span data-ttu-id="a01bf-129">Se debe minimizar el intervalo de tiempo entre la inmovilización y la reanudación de las aplicaciones del escritor.</span><span class="sxs-lookup"><span data-stu-id="a01bf-129">The time interval between the freeze and thaw of the writer applications must be minimized.</span></span> <span data-ttu-id="a01bf-130">El proveedor debe iniciar de forma asincrónica todo el trabajo de preparación relacionado con la instantánea (por ejemplo, un proveedor de hardware que usa complejos que inician la sincronización) en el método [**IVssHardwareSnapshotProvider:: BeginPrepareSnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot) y, a continuación, esperar las finalizaciones en el método [**IVssProviderCreateSnapshotSet:: EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots) .</span><span class="sxs-lookup"><span data-stu-id="a01bf-130">Provider must asynchronously start all preparation work related to the shadow copy (such as a hardware provider that uses plexes starting the synchronization) in the [**IVssHardwareSnapshotProvider::BeginPrepareSnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot) method, and then wait for the completions in the [**IVssProviderCreateSnapshotSet::EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots) method.</span></span>

<span data-ttu-id="a01bf-131">Hay varias ventanas de límite de tiempo que deben seguir los proveedores.</span><span class="sxs-lookup"><span data-stu-id="a01bf-131">There are multiple timing limit windows that providers must follow.</span></span> <span data-ttu-id="a01bf-132">Como resultado, los proveedores con un comportamiento correcto realizarán todo el procesamiento innecesario antes de [**IVssProviderCreateSnapshotSet::P recommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) y después de [**IVssProviderCreateSnapshotSet::P ostcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots).</span><span class="sxs-lookup"><span data-stu-id="a01bf-132">As a result, well-behaved providers will perform all unnecessary processing before [**IVssProviderCreateSnapshotSet::PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) and after [**IVssProviderCreateSnapshotSet::PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots).</span></span>

<span data-ttu-id="a01bf-133">El conjunto de instantáneas se fija cuando se llama a [**DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) .</span><span class="sxs-lookup"><span data-stu-id="a01bf-133">The shadow copy set is fixed when [**DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) is called.</span></span> <span data-ttu-id="a01bf-134">Los volúmenes adicionales no se pueden agregar más adelante, ya que los volúmenes adicionales no compartirán el mismo momento en el tiempo.</span><span class="sxs-lookup"><span data-stu-id="a01bf-134">Additional volumes cannot be added later because the additional volumes would not share the same point-in-time.</span></span>

<span data-ttu-id="a01bf-135">Hay un límite de 64 volúmenes en el conjunto de instantáneas.</span><span class="sxs-lookup"><span data-stu-id="a01bf-135">There is a limit of 64 volumes in the shadow copy set.</span></span> <span data-ttu-id="a01bf-136">Un volumen específico puede asignarse a un LUN completo, a una parte de un LUN o a partes de varios LUN.</span><span class="sxs-lookup"><span data-stu-id="a01bf-136">A specific volume may map to an entire LUN, a portion of a LUN, or portions of multiple LUNs.</span></span> <span data-ttu-id="a01bf-137">La mayoría de las configuraciones tendrán un volumen por LUN, aunque es posible realizar asignaciones arbitrarias.</span><span class="sxs-lookup"><span data-stu-id="a01bf-137">Most configurations will have one volume per LUN, although arbitrary mappings are possible.</span></span>

<span data-ttu-id="a01bf-138">No hay ningún límite en el número de conjuntos de instantáneas o en el número de conjuntos de instantáneas de un volumen original.</span><span class="sxs-lookup"><span data-stu-id="a01bf-138">There is no limit on the number of shadow copy sets or the number of shadow copy sets of an original volume.</span></span> <span data-ttu-id="a01bf-139">Un proveedor puede definir límites específicos o limitar de forma dinámica en función de los recursos de hardware disponibles.</span><span class="sxs-lookup"><span data-stu-id="a01bf-139">A provider may define specific limits, or dynamically limit based on hardware resources available.</span></span>

### <a name="point-in-time-for-writerless-applications"></a><span data-ttu-id="a01bf-140">A un momento dado para aplicaciones no de escritura</span><span class="sxs-lookup"><span data-stu-id="a01bf-140">Point-in-time for Writerless Applications</span></span>

<span data-ttu-id="a01bf-141">VSS incluye una compatibilidad especial que define el momento dado que es común para todos los volúmenes de un conjunto de instantáneas.</span><span class="sxs-lookup"><span data-stu-id="a01bf-141">VSS includes special support that defines the point-in-time that is common for all volumes in a shadow copy set.</span></span> <span data-ttu-id="a01bf-142">Los proveedores de hardware no necesitan interactuar directamente con estas tecnologías de kernel, ya que se invocan como parte del procesamiento normal de la confirmación de la instantánea.</span><span class="sxs-lookup"><span data-stu-id="a01bf-142">Hardware providers do not need to directly interface with these kernel technologies, since they are invoked as part of the normal shadow copy commit processing.</span></span> <span data-ttu-id="a01bf-143">Sin embargo, resulta útil comprender los mecanismos que se usan, ya que explica la definición de "un momento dado" para las aplicaciones sin escritor (aplicaciones que no han expuesto una interfaz VSS Writer y, por tanto, no participan en el proceso de creación de instantáneas de volumen).</span><span class="sxs-lookup"><span data-stu-id="a01bf-143">However, it is useful to understand the mechanisms used because it explains the definition of 'point-in-time' for writerless applications (applications that have not exposed a VSS Writer interface and therefore do not participate in the volume shadow copy creation process.)</span></span>

<span data-ttu-id="a01bf-144">Esta compatibilidad con el kernel de VSS para un momento dado se distribuye entre el VolSnap.sys controlador, los sistemas de archivos y VSS.</span><span class="sxs-lookup"><span data-stu-id="a01bf-144">This VSS kernel support for common point-in-time is distributed between the VolSnap.sys driver, the file systems, and VSS.</span></span>

1.  <span data-ttu-id="a01bf-145">Antes de que se invoque la compatibilidad con el kernel de VSS, VSS ya ha:</span><span class="sxs-lookup"><span data-stu-id="a01bf-145">Before the VSS kernel support is invoked, VSS has already:</span></span>
    1.  <span data-ttu-id="a01bf-146">Determine qué volúmenes van a participar en la instantánea.</span><span class="sxs-lookup"><span data-stu-id="a01bf-146">Determined which volumes are to be involved in the shadow copy.</span></span>
    2.  <span data-ttu-id="a01bf-147">Determina qué proveedor se va a usar en cada volumen.</span><span class="sxs-lookup"><span data-stu-id="a01bf-147">Determined which provider is to be used on each volume.</span></span>
    3.  <span data-ttu-id="a01bf-148">Aplicaciones inmovilizadas que aceptan mensajes de inmovilización/reanudación.</span><span class="sxs-lookup"><span data-stu-id="a01bf-148">Frozen applications that are accepting freeze/thaw messages.</span></span>
    4.  <span data-ttu-id="a01bf-149">Se han preparado los proveedores para la instantánea mediante una llamada a los métodos [**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) .</span><span class="sxs-lookup"><span data-stu-id="a01bf-149">Prepared the providers for the shadow copy by calling the [**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) methods.</span></span> <span data-ttu-id="a01bf-150">Ahora todos los proveedores están esperando para realizar la creación de instantáneas real.</span><span class="sxs-lookup"><span data-stu-id="a01bf-150">All providers are now waiting to do the actual shadow copy creation.</span></span>
2.  <span data-ttu-id="a01bf-151">A continuación, se crea el momento dado.</span><span class="sxs-lookup"><span data-stu-id="a01bf-151">The point-in-time is then created.</span></span> <span data-ttu-id="a01bf-152">VSS vacía los sistemas de archivos de forma simultánea en todos los volúmenes de los que se van a realizar instantáneas.</span><span class="sxs-lookup"><span data-stu-id="a01bf-152">VSS concurrently flushes the file systems on all of the volumes that are to be shadow copied.</span></span>
    1.  <span data-ttu-id="a01bf-153">VSS emite un \_ \_ \_ \_ \_ comando de control de escritura de los archivos de escritura de ioctl VOLSNAP y en cada volumen que vacía los sistemas de archivos.</span><span class="sxs-lookup"><span data-stu-id="a01bf-153">VSS issues an IOCTL\_VOLSNAP\_FLUSH\_AND\_HOLD\_WRITES control command on each volume that flushes the file systems.</span></span> <span data-ttu-id="a01bf-154">Ese IOCTL se pasa a la pila de almacenamiento hacia VolSnap.sys.</span><span class="sxs-lookup"><span data-stu-id="a01bf-154">That IOCTL is passed down the storage stack to VolSnap.sys.</span></span> <span data-ttu-id="a01bf-155">A continuación, VolSnap.sys contiene todas las IRP de escritura hasta el paso 4 a continuación.</span><span class="sxs-lookup"><span data-stu-id="a01bf-155">VolSnap.sys then holds all write IRPs until step 4 below.</span></span> <span data-ttu-id="a01bf-156">Cualquier sistema de archivos (como RAW) sin soporte técnico para este nuevo IOCTL pasa el IOCTL desconocido hacia abajo, donde se vuelve a almacenar en VolSnap.sys.</span><span class="sxs-lookup"><span data-stu-id="a01bf-156">Any file system (such as RAW) without support for this new IOCTL passes the unknown IOCTL down—where it is again held by VolSnap.sys.</span></span> <span data-ttu-id="a01bf-157">En volúmenes NTFS, el vaciado también confirma el registro de NTFS.</span><span class="sxs-lookup"><span data-stu-id="a01bf-157">On NTFS volumes, the flush also commits the NTFS log.</span></span>
    2.  <span data-ttu-id="a01bf-158">Esto suspende toda la actividad de metadatos de NTFS/FAT; los metadatos del sistema de archivos se confirman correctamente.</span><span class="sxs-lookup"><span data-stu-id="a01bf-158">This suspends all NTFS/FAT metadata activity; the file system metadata is cleanly committed.</span></span>
    3.  <span data-ttu-id="a01bf-159">Instantánea: VolSnap.sys hace que todos los IRP de escritura posteriores se coqueuen en todos los volúmenes de los que se va a realizar la instantánea.</span><span class="sxs-lookup"><span data-stu-id="a01bf-159">The shadow copy instant: VolSnap.sys causes all subsequent write IRPs to be queued on all of the volumes that are to be shadow copied.</span></span>
    4.  <span data-ttu-id="a01bf-160">VolSnap.sys espera a que se completen todas las escrituras pendientes en los volúmenes de instantáneas.</span><span class="sxs-lookup"><span data-stu-id="a01bf-160">VolSnap.sys waits for all pending writes on the shadow copied volumes to complete.</span></span> <span data-ttu-id="a01bf-161">Los volúmenes están ahora inactivos con respecto a las escrituras y estaban inactivos exactamente en el mismo momento en cada volumen.</span><span class="sxs-lookup"><span data-stu-id="a01bf-161">The volumes are now quiescent with respect to writes, and were quiescent at exactly the same moment on each volume.</span></span> <span data-ttu-id="a01bf-162">No hay ninguna garantía sobre las escrituras en secciones asignadas por el usuario o escrituras emitidas entre (a) y (b) en sistemas de archivos que no implementan el IOCTL de vaciado (por ejemplo, sin formato).</span><span class="sxs-lookup"><span data-stu-id="a01bf-162">There are no guarantees about writes to user mapped sections or writes issued between (a) and (b) on file systems that do not implement the flush IOCTL (e.g. RAW).</span></span>
3.  <span data-ttu-id="a01bf-163">VSS indica a cada proveedor que realice la instantánea mediante una llamada a los métodos [**IVssProviderCreateSnapshotSet:: CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) .</span><span class="sxs-lookup"><span data-stu-id="a01bf-163">VSS instructs each provider to take in the shadow copy by calling the [**IVssProviderCreateSnapshotSet::CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) methods.</span></span> <span data-ttu-id="a01bf-164">Los proveedores deben tener toda la preparación para que se realice una operación rápida.</span><span class="sxs-lookup"><span data-stu-id="a01bf-164">The providers should have all preparation done so that this is a quick operation.</span></span>

    <span data-ttu-id="a01bf-165">Tenga en cuenta que el sistema de e/s solo está inactivo mientras se ejecutan estos métodos [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) .</span><span class="sxs-lookup"><span data-stu-id="a01bf-165">Note that the I/O system is quiescent only while these [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) methods are executing.</span></span> <span data-ttu-id="a01bf-166">Si un proveedor realiza cualquier sincronización de los LUN de origen y de instantáneas, esta sincronización se debe completar antes de que se devuelva el método **CommitSnapshots** del proveedor.</span><span class="sxs-lookup"><span data-stu-id="a01bf-166">If a provider performs any synchronization of the source and shadow copy LUNs, this synchronization must be completed before the provider's **CommitSnapshots** method returns.</span></span> <span data-ttu-id="a01bf-167">No se puede realizar de forma asincrónica.</span><span class="sxs-lookup"><span data-stu-id="a01bf-167">It cannot be performed asynchronously.</span></span>

4.  <span data-ttu-id="a01bf-168">Inmediatamente después de que el método [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) del último proveedor vuelva, VSS libera todas las IRP de escritura pendientes (incluidas las IRP que estaban bloqueando los sistemas de archivos al concluir sus rutas de confirmación) mediante la invocación de otro IRP pasado a VolSnap.sys.</span><span class="sxs-lookup"><span data-stu-id="a01bf-168">Immediately after the last provider's [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) method returns, VSS releases all pending write IRPs (including the IRPs that were blocking the file systems at the conclusion of their commit paths) by invoking another IRP passed to VolSnap.sys.</span></span>
5.  <span data-ttu-id="a01bf-169">Si el proceso de instantáneas se realizó correctamente, entonces VSS ahora:</span><span class="sxs-lookup"><span data-stu-id="a01bf-169">If the shadow copy process was successful, then VSS now:</span></span>
    1.  <span data-ttu-id="a01bf-170">Llama a [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) para los proveedores implicados.</span><span class="sxs-lookup"><span data-stu-id="a01bf-170">Calls [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) for the providers involved.</span></span>
    2.  <span data-ttu-id="a01bf-171">Llama a [**CVssWriter:: Alcongelar**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) para los escritores implicados.</span><span class="sxs-lookup"><span data-stu-id="a01bf-171">Calls [**CVssWriter::OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) for the writers involved.</span></span>
    3.  <span data-ttu-id="a01bf-172">Informa al solicitante de que se ha completado el proceso de instantáneas.</span><span class="sxs-lookup"><span data-stu-id="a01bf-172">Informs the requester that the shadow copy process has completed.</span></span>

<span data-ttu-id="a01bf-173">[**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots), [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), a [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) son siempre críticos.</span><span class="sxs-lookup"><span data-stu-id="a01bf-173">[**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots), [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), to [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) are all time critical.</span></span> <span data-ttu-id="a01bf-174">Todas las e/s de las aplicaciones con escritores se inmovilizan de **PreCommitSnapshots** a **PostCommitSnapshots**. los retrasos afectan a la disponibilidad de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="a01bf-174">All I/O from applications with writers is frozen from **PreCommitSnapshots** to **PostCommitSnapshots**; any delays affect application availability.</span></span> <span data-ttu-id="a01bf-175">Toda la e/s de archivos, incluida la e/s de aplicación no escritor, se suspende durante **CommitSnapshots**.</span><span class="sxs-lookup"><span data-stu-id="a01bf-175">All file I/O, including writerless application I/O, is suspended during **CommitSnapshots**.</span></span>

<span data-ttu-id="a01bf-176">Los proveedores deben completar todo el trabajo crítico en cuanto al tiempo antes de devolver desde [**EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots).</span><span class="sxs-lookup"><span data-stu-id="a01bf-176">Providers should complete all time-critical work prior to returning from [**EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots).</span></span>

-   <span data-ttu-id="a01bf-177">[**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) debe devolverse en cuestión de segundos.</span><span class="sxs-lookup"><span data-stu-id="a01bf-177">[**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) should be returned within seconds.</span></span> <span data-ttu-id="a01bf-178">La fase **CommitSnapshots** se encuentra en la ventana vaciar y mantener.</span><span class="sxs-lookup"><span data-stu-id="a01bf-178">The **CommitSnapshots** phase is located within the Flush and Hold window.</span></span> <span data-ttu-id="a01bf-179">La compatibilidad con el kernel de VSS cancelará el vaciado y la suspensión que contiene la e/s si la versión posterior no se recibe en 10 segundos y VSS producirá un error en el proceso de creación de la instantánea.</span><span class="sxs-lookup"><span data-stu-id="a01bf-179">VSS kernel support will cancel the Flush and Hold that is holding the I/O if the subsequent release is not received within 10 seconds, and VSS will fail the shadow copy creation process.</span></span> <span data-ttu-id="a01bf-180">Se producirán otras actividades en el sistema, por lo que un proveedor no debe confiar en tener un máximo de 10 segundos.</span><span class="sxs-lookup"><span data-stu-id="a01bf-180">Other activities will be happening on the system, so a provider should not rely on having the full 10 seconds.</span></span> <span data-ttu-id="a01bf-181">El proveedor no debe llamar a las API de Win32 durante la confirmación, ya que muchos darán lugar a Escrituras y bloqueos inesperados.</span><span class="sxs-lookup"><span data-stu-id="a01bf-181">The provider should not call Win32 APIs during commit as many will result in unexpected writes and block.</span></span> <span data-ttu-id="a01bf-182">Si el proveedor tarda más de unos segundos en completar la llamada, hay una alta probabilidad de que se produzca un error.</span><span class="sxs-lookup"><span data-stu-id="a01bf-182">If the provider takes more than a few seconds to complete the call, there is a high probability that this will fail.</span></span>
-   <span data-ttu-id="a01bf-183">La secuencia completa de [**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) al valor devuelto de [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) se asigna a la ventana entre escritores que reciben los eventos Freeze y procongele.</span><span class="sxs-lookup"><span data-stu-id="a01bf-183">The full sequence from [**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) to the return of [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) maps to the window between writers receiving the Freeze and Thaw events.</span></span> <span data-ttu-id="a01bf-184">El valor predeterminado del escritor para esta ventana es de 60 segundos, pero un escritor puede invalidar este valor con un tiempo de espera menor.</span><span class="sxs-lookup"><span data-stu-id="a01bf-184">The writer default for this window is 60 seconds, but a writer may override this value with a smaller timeout.</span></span> <span data-ttu-id="a01bf-185">Por ejemplo, el escritor de Microsoft Exchange Server cambia el tiempo de espera a 20 segundos.</span><span class="sxs-lookup"><span data-stu-id="a01bf-185">For example, the Microsoft Exchange Server writer changes the timeout to 20 seconds.</span></span> <span data-ttu-id="a01bf-186">Los proveedores no deben gastar más de un segundo o dos en este método.</span><span class="sxs-lookup"><span data-stu-id="a01bf-186">Providers should not spend more than a second or two in this method.</span></span>

<span data-ttu-id="a01bf-187">Durante la [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) , el proveedor debe evitar cualquier e/s de archivo que no sea de paginación. Esta e/s tiene una probabilidad muy alta de interbloqueos.</span><span class="sxs-lookup"><span data-stu-id="a01bf-187">During [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) the provider must avoid any non-paging file I/O; such I/O has a very high probability of deadlocking.</span></span> <span data-ttu-id="a01bf-188">En concreto, el proveedor no debe escribir sincrónicamente ningún registro de depuración o de seguimiento.</span><span class="sxs-lookup"><span data-stu-id="a01bf-188">In particular, the provider should not synchronously write any debug or trace logs.</span></span>

 

 



