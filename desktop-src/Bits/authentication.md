---
title: Autenticación (BITS)
description: BITS admite la autenticación básica, la autenticación de Passport y varios esquemas de autenticación de desafío/respuesta.
ms.assetid: cfd4aec3-79d0-4971-93f8-df797e5c0f75
ms.topic: article
ms.date: 10/09/2018
ms.openlocfilehash: 5d970956676a3348dd4b8c4b420e044bd4714775
ms.sourcegitcommit: 8fa6614b715bddf14648cce36d2df22e5232801a
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 12/10/2020
ms.locfileid: "103995832"
---
# <a name="authentication-bits"></a><span data-ttu-id="13311-103">Autenticación (BITS)</span><span class="sxs-lookup"><span data-stu-id="13311-103">Authentication (BITS)</span></span>

<span data-ttu-id="13311-104">BITS admite la autenticación básica, la autenticación de Passport y varios esquemas de autenticación de desafío/respuesta.</span><span class="sxs-lookup"><span data-stu-id="13311-104">BITS supports Basic authentication, Passport authentication, and several challenge/response authentication schemes.</span></span> <span data-ttu-id="13311-105">Si el servidor o proxy requiere autenticación de usuario, use la función [**IBackgroundCopyJob2:: SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) para especificar las credenciales del usuario.</span><span class="sxs-lookup"><span data-stu-id="13311-105">If the server or proxy requires user authentication, use the [**IBackgroundCopyJob2::SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) function to specify the user's credentials.</span></span> <span data-ttu-id="13311-106">BITS usa [CryptoAPI](/windows/desktop/SecCrypto/cryptography-portal) para proteger las credenciales.</span><span class="sxs-lookup"><span data-stu-id="13311-106">BITS uses the [CryptoAPI](/windows/desktop/SecCrypto/cryptography-portal) to protect the credentials.</span></span>

<span data-ttu-id="13311-107">Para establecer credenciales para la autenticación básica, use la función [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) para especificar el nombre de usuario y la contraseña.</span><span class="sxs-lookup"><span data-stu-id="13311-107">To set credentials for Basic authentication use the [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) function to specify the user name and password.</span></span> <span data-ttu-id="13311-108">Solo debe usar la autenticación básica con sitios Web seguros protegidos mediante https://. de lo contrario, el nombre de usuario y la contraseña serán visibles para los usuarios.</span><span class="sxs-lookup"><span data-stu-id="13311-108">You should only use Basic authentication with https:// protected secure websites; otherwise the username and password will be visible to users.</span></span> 

<span data-ttu-id="13311-109">Es posible insertar el nombre de usuario y la contraseña en la dirección URL.</span><span class="sxs-lookup"><span data-stu-id="13311-109">It's possible to embed the user name and password in the URL.</span></span> <span data-ttu-id="13311-110">Esto no se considera una buena práctica de seguridad y quedó en desuso en RFC 3986 (sección 3.2.1).</span><span class="sxs-lookup"><span data-stu-id="13311-110">This is not considered a good security practice, and is deprecated in RFC 3986 (section 3.2.1).</span></span>

<span data-ttu-id="13311-111">Para la autenticación de [Passport](/windows/desktop/WinHttp/passport-authentication-in-winhttp) , bits solo admite credenciales explícitas, no credenciales implícitas asociadas a la cuenta.</span><span class="sxs-lookup"><span data-stu-id="13311-111">For [Passport](/windows/desktop/WinHttp/passport-authentication-in-winhttp) authentication, BITS supports explicit credentials only, not implicit credentials tied to the account.</span></span>

<span data-ttu-id="13311-112">Para la autenticación de desafío/respuesta, BITS suplanta al usuario y usa [Snego](../com/snego.md) para determinar la autenticación de desafío/respuesta que se va a usar, como NTLM o el protocolo Kerberos.</span><span class="sxs-lookup"><span data-stu-id="13311-112">For challenge/response authentication, BITS impersonates the user and uses [Snego](../com/snego.md) to determine which challenge/response authentication to use, such as NTLM or the Kerberos protocol.</span></span> <span data-ttu-id="13311-113">Para obtener una lista de esquemas de desafío/respuesta compatibles con BITS, consulte el [**\_ \_ esquema de autenticación de BG**](/windows/desktop/api/Bits1_5/ne-bits1_5-bg_auth_scheme).</span><span class="sxs-lookup"><span data-stu-id="13311-113">For a list of challenge/response schemes that BITS supports, see [**BG\_AUTH\_SCHEME**](/windows/desktop/api/Bits1_5/ne-bits1_5-bg_auth_scheme).</span></span>

<span data-ttu-id="13311-114">Los trabajos de BITS pueden producir un error si el directorio virtual del servidor tiene autenticación anónima y otro esquema de autenticación habilitado y si las ACL protegen el directorio virtual o los archivos de descarga.</span><span class="sxs-lookup"><span data-stu-id="13311-114">BITS jobs can fail if the virtual directory on the server has anonymous authentication and another authentication scheme enabled and if ACLs protect the virtual directory or download files.</span></span> <span data-ttu-id="13311-115">Por ejemplo, se produce un error en un trabajo con "acceso denegado" si el directorio virtual tiene habilitada la autenticación anónima e integrada, y el archivo contiene una ACL que solo permite a Ben leer el archivo.</span><span class="sxs-lookup"><span data-stu-id="13311-115">For example, a job fails with "access denied" if the virtual directory has anonymous and integrated authentication enabled and the file contains an ACL that allows only Ben to read the file.</span></span> <span data-ttu-id="13311-116">Esto se debe a que el directorio virtual permite el acceso anónimo, por lo que IIS no autentica explícitamente Ben (las credenciales de Ben no se usan para tener acceso al archivo y se deniega el acceso).</span><span class="sxs-lookup"><span data-stu-id="13311-116">This occurs because the virtual directory allows anonymous access, so IIS does not explicitly authenticate Ben (Ben's credentials are not used to access the file and access is denied).</span></span>

## <a name="using-implicit-credentials"></a><span data-ttu-id="13311-117">Usar credenciales IMPLÍCITAS</span><span class="sxs-lookup"><span data-stu-id="13311-117">Using implicit credentials</span></span>

<span data-ttu-id="13311-118">Para usar las credenciales IMPLÍCITAS (inicio de sesión) del usuario para la autenticación NTLM o Kerberos, llame al método [**IBackgroundCopyJob2:: SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) y establezca los miembros de **nombre de usuario** y **contraseña** de la estructura [**BG \_ Basic \_ Credentials**](/windows/desktop/api/Bits1_5/ns-bits1_5-bg_basic_credentials) en **null**.</span><span class="sxs-lookup"><span data-stu-id="13311-118">To use the user's implicit (logon) credentials for NTLM or Kerberos authentication, call the [**IBackgroundCopyJob2::SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method and set the **UserName** and **Password** members of the [**BG\_BASIC\_CREDENTIALS**](/windows/desktop/api/Bits1_5/ns-bits1_5-bg_basic_credentials) structure to **NULL**.</span></span> <span data-ttu-id="13311-119">Si especifica credenciales implícitas para un proxy, BITS también usará las credenciales implícitas para la autenticación de servidor a menos que especifique las credenciales de servidor explícitas.</span><span class="sxs-lookup"><span data-stu-id="13311-119">If you specify implicit credentials for a proxy, BITS will also use the implicit credentials for server authentication unless you specify explicit server credentials.</span></span>

<span data-ttu-id="13311-120">Para obtener información adicional acerca de los servicios, consulte [cuentas de servicio y bits](service-accounts-and-bits.md).</span><span class="sxs-lookup"><span data-stu-id="13311-120">For additional information for services, see [Service Accounts and BITS](service-accounts-and-bits.md).</span></span>

<span data-ttu-id="13311-121">También puede cambiar el valor del registro **LMCompatibilityLevel** o **UseLMCompat** ; sin embargo, solo debe cambiar estos valores si tiene una aplicación existente que no se puede cambiar para llamar al método [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) .</span><span class="sxs-lookup"><span data-stu-id="13311-121">You could also change the **LMCompatibilityLevel** or **UseLMCompat** registry value; however, you should change these values only if you have an existing application that cannot be changed to call the [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method.</span></span>

<span data-ttu-id="13311-122">BITS usará credenciales implícitas para la autenticación si el valor del registro **LMCompatibilityLevel** es dos o más, y no se ha llamado al método [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) .</span><span class="sxs-lookup"><span data-stu-id="13311-122">BITS will use implicit credentials for authentication if the **LMCompatibilityLevel** registry value is two or greater, and you have not called the [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method.</span></span> <span data-ttu-id="13311-123">La ruta de acceso completa al valor del registro **LMCompatibilityLevel** es **HKEY \_ local \_ Machine** \\ **System** \\ **CurrentControlSet** \\ **control** \\ **LSA** \\ **LMCompatibilityLevel**.</span><span class="sxs-lookup"><span data-stu-id="13311-123">The full path to the **LMCompatibilityLevel** registry value is **HKEY\_LOCAL\_MACHINE**\\**System**\\**CurrentControlSet**\\**Control**\\**LSA**\\**LmCompatibilityLevel**.</span></span>

<span data-ttu-id="13311-124">Tenga en cuenta que el cambio del valor del registro **LMCompatibilityLevel** puede afectar a otras aplicaciones y servicios que se ejecutan en el equipo.</span><span class="sxs-lookup"><span data-stu-id="13311-124">Note that changing the **LMCompatibilityLevel** registry value can affect other applications and services running on the computer.</span></span> <span data-ttu-id="13311-125">Para obtener más información acerca del uso del valor del registro **LMCompatibilityLevel** , vea [KB147706](https://support.microsoft.com/kb/147706).</span><span class="sxs-lookup"><span data-stu-id="13311-125">For more information about using the **LMCompatibilityLevel** registry value, see [KB147706](https://support.microsoft.com/kb/147706).</span></span>

<span data-ttu-id="13311-126">Si establecer el valor del registro **LMCompatibilityLevel** es un problema, puede crear el valor del registro **UseLMCompat** en **HKEY \_ local \_ Machine** \\ **software** \\ **Microsoft** \\ **Windows** \\ **CurrentVersion** \\ **bits**.</span><span class="sxs-lookup"><span data-stu-id="13311-126">If setting the **LMCompatibilityLevel** registry value is an issue, you can create the **UseLMCompat** registry value under **HKEY\_LOCAL\_MACHINE**\\**Software**\\**Microsoft**\\**Windows**\\**CurrentVersion**\\**BITS**.</span></span> <span data-ttu-id="13311-127">El valor del registro es un valor DWORD.</span><span class="sxs-lookup"><span data-stu-id="13311-127">The registry value is a DWORD.</span></span> <span data-ttu-id="13311-128">En la tabla siguiente se enumeran los posibles valores para **UseLMCompat**:</span><span class="sxs-lookup"><span data-stu-id="13311-128">The following table lists the possible values for **UseLMCompat**:</span></span>

|<span data-ttu-id="13311-129">Value</span><span class="sxs-lookup"><span data-stu-id="13311-129">Value</span></span>|<span data-ttu-id="13311-130">Descripción</span><span class="sxs-lookup"><span data-stu-id="13311-130">Description</span></span>|
|-|-|
| <span data-ttu-id="13311-131">0</span><span class="sxs-lookup"><span data-stu-id="13311-131">0</span></span>     | <span data-ttu-id="13311-132">BITS enviará credenciales implícitas siempre que el servidor solicite las credenciales NTLM o Kerberos.</span><span class="sxs-lookup"><span data-stu-id="13311-132">BITS will send implicit credentials whenever the server prompts for NTLM or Kerberos credentials.</span></span>                                                                                           |
| <span data-ttu-id="13311-133">1</span><span class="sxs-lookup"><span data-stu-id="13311-133">1</span></span>     | <span data-ttu-id="13311-134">BITS enviará credenciales implícitas solo si el valor del registro **LMCompatibilityLevel** del equipo cliente es mayor o igual que 2.</span><span class="sxs-lookup"><span data-stu-id="13311-134">BITS will send implicit credentials only if the client computer's **LMCompatibilityLevel** registry value is greater than or equal to 2.</span></span><br/>     |
| <span data-ttu-id="13311-135">2</span><span class="sxs-lookup"><span data-stu-id="13311-135">2</span></span>     | <span data-ttu-id="13311-136">BITS enviará credenciales implícitas solo si la aplicación llamó al método [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) .</span><span class="sxs-lookup"><span data-stu-id="13311-136">BITS will send implicit credentials only if the application called the [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method.</span></span><br/> |

<span data-ttu-id="13311-137">BITS usará un valor predeterminado de "2" para el valor del registro **UseLMCompat** si el valor del registro no existe.</span><span class="sxs-lookup"><span data-stu-id="13311-137">BITS will use a default value of "2" for the **UseLMCompat** registry value if the registry value does not exist.</span></span>

## <a name="using-certificates-for-clientserver-authentication"></a><span data-ttu-id="13311-138">Uso de certificados para la autenticación de cliente/servidor</span><span class="sxs-lookup"><span data-stu-id="13311-138">Using certificates for client/server authentication</span></span>

<span data-ttu-id="13311-139">En la comunicación segura entre cliente y servidor, los clientes y servidores pueden usar certificados digitales para autenticarse mutuamente entre sí.</span><span class="sxs-lookup"><span data-stu-id="13311-139">In secure client/server communication, clients and servers can use digital certificates to mutually authenticate each other.</span></span> <span data-ttu-id="13311-140">BITS admite automáticamente la autenticación de servidor basada en certificados para transportes HTTP seguros.</span><span class="sxs-lookup"><span data-stu-id="13311-140">BITS automatically supports certificate-based server authentication for secure HTTP transports.</span></span> <span data-ttu-id="13311-141">Para proporcionar BITS al certificado de cliente necesario para la autenticación mutua, llame al método [**IBackgroundCopyJobHttpOptions:: SetClientCertificateByID**](/windows/desktop/api/Bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyid) o [**IBackgroundCopyJobHttpOptions:: SetClientCertificateByName**](/windows/desktop/api/Bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyname) .</span><span class="sxs-lookup"><span data-stu-id="13311-141">To provide BITS the client certificate needed for mutual authentication, call either the [**IBackgroundCopyJobHttpOptions::SetClientCertificateByID**](/windows/desktop/api/Bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyid) or [**IBackgroundCopyJobHttpOptions::SetClientCertificateByName**](/windows/desktop/api/Bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyname) method.</span></span>

<span data-ttu-id="13311-142">Cuando un sitio web acepta pero no requiere un certificado de cliente SSL y el trabajo de BITS no especifica un certificado de cliente, se producirá un error en el trabajo con el **error \_ WinHTTP \_ Client \_ auth \_ CERT \_** (0x80072f0c).</span><span class="sxs-lookup"><span data-stu-id="13311-142">When a website accepts but does not require an SSL client certificate, and the BITS job does not specify a client certificate, the job will fail with **ERROR\_WINHTTP\_CLIENT\_AUTH\_CERT\_NEEDED** (0x80072f0c).</span></span>

## <a name="how-to-handle-authenticated-proxy-scenarios-that-require-user-specific-settings"></a><span data-ttu-id="13311-143">Cómo controlar los escenarios de proxy autenticados que requieren una configuración específica del usuario</span><span class="sxs-lookup"><span data-stu-id="13311-143">How to handle authenticated proxy scenarios that require user-specific settings</span></span>

<span data-ttu-id="13311-144">Si usa BITS en un entorno que requiere autenticación de proxy mientras se ejecuta como una cuenta sin credenciales NTLM o Kerberos que se pueden usar en el dominio de red del equipo, debe realizar pasos adicionales para autenticarse correctamente mediante el uso de las credenciales de otra cuenta de usuario que tenga credenciales en el dominio.</span><span class="sxs-lookup"><span data-stu-id="13311-144">If you are using BITS in an environment that requires proxy authentication while running as an account without usable NTLM or Kerberos credentials in the machine's network domain, you must take extra steps to authenticate properly by using the credentials of another user account that does have credentials on the domain.</span></span> <span data-ttu-id="13311-145">Se trata de un escenario típico en el que el código BITS se ejecuta como un servicio del sistema como LocalService, NetworkService o LocalSystem, ya que esas cuentas no tienen credenciales NTLM o Kerberos que se puedan usar.</span><span class="sxs-lookup"><span data-stu-id="13311-145">This is a typical scenario when your BITS code is running as a system service such as LocalService, NetworkService, or LocalSystem, as those accounts do not have usable NTLM or Kerberos credentials.</span></span>

<span data-ttu-id="13311-146">La lógica de detección de proxy utilizada en BITS hace lo siguiente cuando se establece un token de aplicación auxiliar de red ( \_ red de tokens BG \_ ):</span><span class="sxs-lookup"><span data-stu-id="13311-146">The proxy detection logic used in BITS does the following when a network helper token (BG\_TOKEN\_NETWORK) is set:</span></span>

-   <span data-ttu-id="13311-147">Si se llamó a [**IBackgroundCopyJob:: SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) con la configuración de uso del proxy de trabajo de BG, lea configuración de proxy de IE local mediante la suplantación del contexto del token del propietario del trabajo a través de [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser). **\_ \_ \_ \_**</span><span class="sxs-lookup"><span data-stu-id="13311-147">If [**IBackgroundCopyJob::SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) was called with **BG\_JOB\_PROXY\_USAGE\_PRECONFIG**, then read local IE proxy settings using job owner token context impersonation via [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span></span> <span data-ttu-id="13311-148">A partir de Windows 10, versión 1809 (10,0; Compilación 17763), se usa la identidad del token auxiliar para este paso.</span><span class="sxs-lookup"><span data-stu-id="13311-148">Starting in Windows 10, version 1809 (10.0; Build 17763), the helper token identity is used for this step.</span></span>
-   <span data-ttu-id="13311-149">Si se llamó a [**IBackgroundCopyJob:: SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) con la detección automática del uso del proxy de BG o si la configuración de IE del caso de **\_ \_ \_ \_ preconfiguración de uso del proxy del trabajo de BG** especifica detección automática o una dirección URL de configuración automática, realice la detección de proxy automático o el protocolo de detección automática de proxy web (WPAD) mediante la suplantación de token de aplicación auxiliar mediante [**WinHttpGetProxyForUrl**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetproxyforurl). **\_ \_ \_**</span><span class="sxs-lookup"><span data-stu-id="13311-149">If [**IBackgroundCopyJob::SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) was called with **BG\_PROXY\_USAGE\_AUTODETECT** or if the IE settings from the **BG\_JOB\_PROXY\_USAGE\_PRECONFIG** case specify auto-detect or an auto-config URL, then conduct auto-proxy detection, or Web Proxy Autodiscovery Protocol (WPAD), using helper token impersonation via [**WinHttpGetProxyForUrl**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetproxyforurl).</span></span>

<span data-ttu-id="13311-150">Después de eso, la suplantación de tokens auxiliares se utiliza para la autenticación de servidor o proxy en todo.</span><span class="sxs-lookup"><span data-stu-id="13311-150">After that, helper token impersonation is used for proxy or server authentication throughout.</span></span>

<span data-ttu-id="13311-151">A partir de Windows 10, versión 1809 (10,0; Compilación 17763), se simplifica el escenario de proxy autenticado con credenciales específicas del usuario.</span><span class="sxs-lookup"><span data-stu-id="13311-151">Starting in Windows 10, version 1809 (10.0; Build 17763), the authenticated proxy scenario with user-specific credentials is simplified.</span></span>

1.  <span data-ttu-id="13311-152">Llame al método [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) del trabajo de bits con el **esquema de \_ autenticación BG \_ \_ Negotiate**, el *nombre de usuario* establecido en **null**, la *contraseña* establecida en **null** y el *destino* establecido en proxy de **\_ \_ destino \_ de autenticación BG**.</span><span class="sxs-lookup"><span data-stu-id="13311-152">Call the BITS job's [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method with **BG\_AUTH\_SCHEME\_NEGOTIATE**, *UserName* set to **NULL**, *Password* set to **NULL**, and *Target* set to **BG\_AUTH\_TARGET\_PROXY**.</span></span> <span data-ttu-id="13311-153">Esto hace que se usen las credenciales implícitas de la cuenta de usuario para la autenticación NTLM y Kerberos con el proxy y el servidor.</span><span class="sxs-lookup"><span data-stu-id="13311-153">This causes the user account's implicit credentials to be used for NTLM and Kerberos authentication with the proxy and server.</span></span>
2.  <span data-ttu-id="13311-154">Llame a [**IBackgroundCopyJob:: SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) con la configuración de uso del proxy de trabajo de **BG \_ \_ \_ \_**.</span><span class="sxs-lookup"><span data-stu-id="13311-154">Call [**IBackgroundCopyJob::SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) with **BG\_JOB\_PROXY\_USAGE\_PRECONFIG**.</span></span>
3.  <span data-ttu-id="13311-155">QueryInterface para [**IBitsTokenOptions**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).</span><span class="sxs-lookup"><span data-stu-id="13311-155">QueryInterface for [**IBitsTokenOptions**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).</span></span>
4.  <span data-ttu-id="13311-156">Suplantar la cuenta de usuario que está usando para las credenciales de NTLM/Kerberos.</span><span class="sxs-lookup"><span data-stu-id="13311-156">Impersonate the user account you're using for NTLM/Kerberos credentials.</span></span>
5.  <span data-ttu-id="13311-157">Llame a [**SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken).</span><span class="sxs-lookup"><span data-stu-id="13311-157">Call [**SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken).</span></span>
6. <span data-ttu-id="13311-158">Llame a [**SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) con la **\_ \_ red de tokens BG**.</span><span class="sxs-lookup"><span data-stu-id="13311-158">Call [**SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) with **BG\_TOKEN\_NETWORK**.</span></span>
7. <span data-ttu-id="13311-159">Revertir la suplantación.</span><span class="sxs-lookup"><span data-stu-id="13311-159">Revert impersonation.</span></span>
8. <span data-ttu-id="13311-160">Continúe con la configuración del trabajo.</span><span class="sxs-lookup"><span data-stu-id="13311-160">Continue job setup.</span></span>
9. <span data-ttu-id="13311-161">Llame a [**resume**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume) en el trabajo.</span><span class="sxs-lookup"><span data-stu-id="13311-161">Call [**Resume**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume) on the job.</span></span>

<span data-ttu-id="13311-162">Antes de Windows 10, versión 1809 (10,0; Compilación 17763), la identidad de usuario correcta (la identidad del token auxiliar) se usa para la detección de proxy basada en red (WPAD) y para la autenticación de proxy, pero la detección real de la configuración de proxy local (IE) siempre se realiza mediante el token del propietario del trabajo, incluso cuando se configura un token auxiliar.</span><span class="sxs-lookup"><span data-stu-id="13311-162">Before Windows 10, version 1809 (10.0; Build 17763), the correct user identity (the helper token's identity) is used for network-based proxy detection (WPAD) and for proxy authentication, but the actual detection of local (IE) proxy settings is always done using the job owner's token, even when a helper token is configured.</span></span> <span data-ttu-id="13311-163">Para solucionar este defecto, puede seguir estos pasos.</span><span class="sxs-lookup"><span data-stu-id="13311-163">To work around this shortcoming, you can follow these steps.</span></span>

1.  <span data-ttu-id="13311-164">Suplantar la cuenta de usuario que está usando para las credenciales de NTLM/Kerberos.</span><span class="sxs-lookup"><span data-stu-id="13311-164">Impersonate the user account you're using for NTLM/Kerberos credentials.</span></span>
2.  <span data-ttu-id="13311-165">Recupere la configuración del proxy de IE de la cuenta de usuario mediante una llamada a [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span><span class="sxs-lookup"><span data-stu-id="13311-165">Retrieve the user account's IE proxy settings by calling [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span></span>
3.  <span data-ttu-id="13311-166">Revertir la suplantación.</span><span class="sxs-lookup"><span data-stu-id="13311-166">Revert impersonation.</span></span>
4.  <span data-ttu-id="13311-167">Llame al método [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) del trabajo de bits con el **esquema de \_ autenticación BG \_ \_ Negotiate**, el *nombre de usuario* establecido en **null**, la *contraseña* establecida en **null** y el *destino* establecido en proxy de **\_ \_ destino \_ de autenticación BG**.</span><span class="sxs-lookup"><span data-stu-id="13311-167">Call the BITS job's [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method with **BG\_AUTH\_SCHEME\_NEGOTIATE**, *UserName* set to **NULL**, *Password* set to **NULL**, and *Target* set to **BG\_AUTH\_TARGET\_PROXY**.</span></span> <span data-ttu-id="13311-168">Esto hace que se usen las credenciales implícitas de la cuenta de usuario para la autenticación NTLM y Kerberos con el proxy y el servidor.</span><span class="sxs-lookup"><span data-stu-id="13311-168">This causes the user account's implicit credentials to be used for NTLM and Kerberos authentication with the proxy and server.</span></span>
5.  <span data-ttu-id="13311-169">Si el paso 2 produce una configuración de proxy específica del usuario (es decir, *lpszProxy* o *LpszProxyBypass* no son **null**), establezca la configuración de trabajo correspondiente manualmente, usando [**SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) con la configuración de **\_ \_ \_ \_ invalidación de uso del proxy del trabajo de BG** .</span><span class="sxs-lookup"><span data-stu-id="13311-169">If step 2 yielded any user-specific proxy settings (i.e. *lpszProxy* or *lpszProxyBypass* are not **NULL**), set the corresponding job settings manually, using [**SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) with the **BG\_JOB\_PROXY\_USAGE\_OVERRIDE** setting.</span></span>
6.  <span data-ttu-id="13311-170">Si el paso 2 no produjo ninguna configuración de proxy específica del usuario, llame a [**SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) con la **configuración de uso del trabajo de BG \_ \_ \_**.</span><span class="sxs-lookup"><span data-stu-id="13311-170">If step 2 did not yield any user-specific proxy settings, call [**SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) with **BG\_JOB\_USAGE\_PRECONFIG**.</span></span>
7.  <span data-ttu-id="13311-171">QueryInterface para [**IBitsTokenOptions**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).</span><span class="sxs-lookup"><span data-stu-id="13311-171">QueryInterface for [**IBitsTokenOptions**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).</span></span>
8.  <span data-ttu-id="13311-172">Vuelva a suplantar la cuenta de usuario.</span><span class="sxs-lookup"><span data-stu-id="13311-172">Impersonate the user account again.</span></span>
9.  <span data-ttu-id="13311-173">Llame a [**SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken).</span><span class="sxs-lookup"><span data-stu-id="13311-173">Call [**SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken).</span></span>
10. <span data-ttu-id="13311-174">Llame a [**SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) con la **\_ \_ red de tokens BG**.</span><span class="sxs-lookup"><span data-stu-id="13311-174">Call [**SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) with **BG\_TOKEN\_NETWORK**.</span></span>
11. <span data-ttu-id="13311-175">Revertir la suplantación.</span><span class="sxs-lookup"><span data-stu-id="13311-175">Revert impersonation.</span></span>
12. <span data-ttu-id="13311-176">Continúe con la configuración del trabajo.</span><span class="sxs-lookup"><span data-stu-id="13311-176">Continue job setup.</span></span>
13. <span data-ttu-id="13311-177">Llame a [**resume**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume) en el trabajo.</span><span class="sxs-lookup"><span data-stu-id="13311-177">Call [**Resume**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume) on the job.</span></span>
