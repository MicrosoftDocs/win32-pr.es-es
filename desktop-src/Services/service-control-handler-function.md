---
description: Cada servicio tiene un controlador de control, la función de controlador, que invoca el distribuidor del control cuando el proceso de servicio recibe una solicitud de control de un programa de control de servicios.
ms.assetid: 437334ed-05fa-4ab6-aab3-dc2739113e19
title: Función de controlador de control de servicio
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 1303bff45421ee7206d02be9ee30066324648823
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/07/2021
ms.locfileid: "105666448"
---
# <a name="service-control-handler-function"></a><span data-ttu-id="4b5ee-103">Función de controlador de control de servicio</span><span class="sxs-lookup"><span data-stu-id="4b5ee-103">Service Control Handler Function</span></span>

<span data-ttu-id="4b5ee-104">Cada servicio tiene un controlador de control, la función de [**controlador**](/windows/desktop/api/Winsvc/nc-winsvc-lphandler_function) , que invoca el distribuidor del control cuando el proceso de servicio recibe una solicitud de control de un programa de control de servicios.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-104">Each service has a control handler, the [**Handler**](/windows/desktop/api/Winsvc/nc-winsvc-lphandler_function) function, that is invoked by the control dispatcher when the service process receives a control request from a service control program.</span></span> <span data-ttu-id="4b5ee-105">Por lo tanto, esta función se ejecuta en el contexto del distribuidor del control.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-105">Therefore, this function executes in the context of the control dispatcher.</span></span> <span data-ttu-id="4b5ee-106">Para obtener un ejemplo, vea [escribir una función de controlador de control](writing-a-control-handler-function.md).</span><span class="sxs-lookup"><span data-stu-id="4b5ee-106">For an example, see [Writing a Control Handler Function](writing-a-control-handler-function.md).</span></span>

<span data-ttu-id="4b5ee-107">Un servicio llama a la función [**RegisterServiceCtrlHandler**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlera) o [**RegisterServiceCtrlHandlerEx**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlerexa) para registrar su función de controlador de control de servicio.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-107">A service calls the [**RegisterServiceCtrlHandler**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlera) or [**RegisterServiceCtrlHandlerEx**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlerexa) function to register its service control handler function.</span></span>

<span data-ttu-id="4b5ee-108">Cuando se invoca el controlador de control de servicio, el servicio debe llamar a la función [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) para notificar su estado al SCM solo si el control del código de control hace que el estado del servicio cambie.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-108">When the service control handler is invoked, the service must call the [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) function to report its status to the SCM only if handling the control code causes the service status to change.</span></span> <span data-ttu-id="4b5ee-109">Si el control del código de control no hace que cambie el estado del servicio, no es necesario llamar a **SetServiceStatus**.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-109">If handling the control code does not cause the service status to change, it is not necessary to call **SetServiceStatus**.</span></span>

<span data-ttu-id="4b5ee-110">Un programa de control de servicios puede enviar solicitudes de control mediante la función [**ControlService**](/windows/desktop/api/Winsvc/nf-winsvc-controlservice) .</span><span class="sxs-lookup"><span data-stu-id="4b5ee-110">A service control program can send control requests using the [**ControlService**](/windows/desktop/api/Winsvc/nf-winsvc-controlservice) function.</span></span> <span data-ttu-id="4b5ee-111">Todos los servicios deben aceptar y procesar el código de control de **\_ \_ interrogación de control de servicio** .</span><span class="sxs-lookup"><span data-stu-id="4b5ee-111">All services must accept and process the **SERVICE\_CONTROL\_INTERROGATE** control code.</span></span> <span data-ttu-id="4b5ee-112">Puede habilitar o deshabilitar la aceptación de los otros códigos de control llamando a [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus).</span><span class="sxs-lookup"><span data-stu-id="4b5ee-112">You can enable or disable acceptance of the other control codes by calling [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus).</span></span> <span data-ttu-id="4b5ee-113">Para recibir el código de control **\_ \_ DEVICEEVENT de control de servicio** , debe llamar a la función [**RegisterDeviceNotification**](/windows/desktop/api/winuser/nf-winuser-registerdevicenotificationa) .</span><span class="sxs-lookup"><span data-stu-id="4b5ee-113">To receive the **SERVICE\_CONTROL\_DEVICEEVENT** control code, you must call the [**RegisterDeviceNotification**](/windows/desktop/api/winuser/nf-winuser-registerdevicenotificationa) function.</span></span> <span data-ttu-id="4b5ee-114">Los servicios también pueden controlar códigos de control adicionales definidos por el usuario.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-114">Services can also handle additional user-defined control codes.</span></span>

<span data-ttu-id="4b5ee-115">Si un servicio acepta el código de control de **\_ \_ detención del control de servicio** , debe detenerse tras la recepción, pasando al estado de servicio **\_ \_ pendiente o detención** del servicio. **\_**</span><span class="sxs-lookup"><span data-stu-id="4b5ee-115">If a service accepts the **SERVICE\_CONTROL\_STOP** control code, it must stop upon receipt, going to either the **SERVICE\_STOP\_PENDING** or **SERVICE\_STOPPED** state.</span></span> <span data-ttu-id="4b5ee-116">Una vez que el SCM envía este código de control, no enviará otros códigos de control.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-116">After the SCM sends this control code, it will not send other control codes.</span></span>

<span data-ttu-id="4b5ee-117">**Windows XP:** Si el servicio **no devuelve ningún \_ error** y continúa ejecutándose, sigue recibiendo códigos de control.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-117">**Windows XP:** If the service returns **NO\_ERROR** and continues to run, it continues to receive control codes.</span></span> <span data-ttu-id="4b5ee-118">Este comportamiento ha cambiado a partir de Windows Server 2003 y Windows XP con Service Pack 2 (SP2).</span><span class="sxs-lookup"><span data-stu-id="4b5ee-118">This behavior changed starting with Windows Server 2003 and Windows XP with Service Pack 2 (SP2).</span></span>

<span data-ttu-id="4b5ee-119">El controlador de control debe volver en un plazo de 30 segundos o el SCM devuelve un error.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-119">The control handler must return within 30 seconds, or the SCM returns an error.</span></span> <span data-ttu-id="4b5ee-120">Si un servicio debe realizar un procesamiento largo cuando el servicio está ejecutando el controlador de control, debe crear un subproceso secundario para realizar el procesamiento prolongado y, a continuación, volver del controlador de control.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-120">If a service must do lengthy processing when the service is executing the control handler, it should create a secondary thread to perform the lengthy processing, and then return from the control handler.</span></span> <span data-ttu-id="4b5ee-121">Esto evita que el servicio entre en el distribuidor de control.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-121">This prevents the service from tying up the control dispatcher.</span></span> <span data-ttu-id="4b5ee-122">Por ejemplo, al controlar la solicitud de detención de un servicio que tarda mucho tiempo, cree otro subproceso para controlar el proceso de detención.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-122">For example, when handling the stop request for a service that takes a long time, create another thread to handle the stop process.</span></span> <span data-ttu-id="4b5ee-123">El controlador de control solo debe llamar a [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) con el mensaje **\_ Stop \_ Pending** Message y devolverlo.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-123">The control handler should simply call [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) with the **SERVICE\_STOP\_PENDING** message and return.</span></span>

<span data-ttu-id="4b5ee-124">Cuando el usuario cierra el sistema, todos los controladores de control que han llamado a [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) con el servicio aceptan el código de control de **\_ \_ preapagado** reciben el código de control de **\_ \_ cierre del control de servicio** .</span><span class="sxs-lookup"><span data-stu-id="4b5ee-124">When the user shuts down the system, all control handlers that have called [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) with the **SERVICE\_ACCEPT\_PRESHUTDOWN** control code receive the **SERVICE\_CONTROL\_PRESHUTDOWN** control code.</span></span> <span data-ttu-id="4b5ee-125">El administrador de control de servicios espera hasta que el servicio se detenga o expire el valor de tiempo de espera de preapagado especificado (este valor se puede establecer con la función [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) ).</span><span class="sxs-lookup"><span data-stu-id="4b5ee-125">The service control manager waits until the service stops or the specified preshutdown time-out value expires (this value can be set with the [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) function).</span></span> <span data-ttu-id="4b5ee-126">Este código de control solo debe usarse en circunstancias especiales, ya que un servicio que administra esta notificación bloquea el cierre del sistema hasta que el servicio se detiene o hasta que expira el intervalo de tiempo de espera de cierre.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-126">This control code should be used only in special circumstances, because a service that handles this notification blocks system shutdown until the service stops or the preshutdown time-out interval expires.</span></span>

<span data-ttu-id="4b5ee-127">Una vez completadas las notificaciones de cierre, todos los controladores de control que han llamado [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) con el servicio aceptan el código de control de **\_ \_ cierre** reciben el código de control de **\_ \_ cierre del control de servicio** .</span><span class="sxs-lookup"><span data-stu-id="4b5ee-127">After the preshutdown notifications have been completed, all control handlers that have called [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) with the **SERVICE\_ACCEPT\_SHUTDOWN** control code receive the **SERVICE\_CONTROL\_SHUTDOWN** control code.</span></span> <span data-ttu-id="4b5ee-128">Se notifican en el orden en que aparecen en la base de datos de servicios instalados.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-128">They are notified in the order that they appear in the database of installed services.</span></span> <span data-ttu-id="4b5ee-129">De forma predeterminada, un servicio tiene aproximadamente 20 segundos para realizar tareas de limpieza antes de que se cierre el sistema.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-129">By default, a service has approximately 20 seconds to perform cleanup tasks before the system shuts down.</span></span> <span data-ttu-id="4b5ee-130">Después de que expire este tiempo, el cierre del sistema se reanuda independientemente de si se ha completado el cierre del servicio.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-130">After this time expires, system shutdown proceeds regardless of whether service shutdown is complete.</span></span> <span data-ttu-id="4b5ee-131">Tenga en cuenta que si el sistema se queda en el estado de apagado (no reiniciado o apagado), el servicio continúa ejecutándose.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-131">Note that if the system is left in the shutdown state (not restarted or powered down), the service continues to run.</span></span>

<span data-ttu-id="4b5ee-132">Si el servicio requiere más tiempo para la limpieza, envía mensajes de estado de **detención \_ pendiente** , junto con una sugerencia de espera, por lo que el controlador de servicio sabe cuánto tiempo hay que esperar antes de informar al sistema de que se ha completado el cierre del servicio.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-132">If the service requires more time to cleanup, it sends **STOP\_PENDING** status messages, along with a wait hint, so the service controller knows how long to wait before reporting to the system that service shutdown is complete.</span></span> <span data-ttu-id="4b5ee-133">Sin embargo, para evitar que un servicio detenga el apagado, existe un límite en cuanto al tiempo que espera el controlador de servicio.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-133">However, to prevent a service from stopping shutdown, there is a limit to how long the service controller waits.</span></span> <span data-ttu-id="4b5ee-134">Si el servicio se está cerrando a través del complemento Servicios, el límite es de 125 segundos o 125.000 milisegundos.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-134">If the service is being shut down through the Services snap-in, the limit is 125 seconds, or 125,000 milliseconds.</span></span> <span data-ttu-id="4b5ee-135">Si el sistema operativo se está reiniciando, el límite de tiempo se especifica en el valor **WaitToKillServiceTimeout** (en milisegundos) de la siguiente clave del registro:</span><span class="sxs-lookup"><span data-stu-id="4b5ee-135">If the operating system is rebooting, the time limit is specified in the **WaitToKillServiceTimeout** value (in milliseconds) of the following registry key:</span></span>

<span data-ttu-id="4b5ee-136">**HKEY \_ local \_ Machine \\ System \\ CurrentControlSet \\ control**</span><span class="sxs-lookup"><span data-stu-id="4b5ee-136">**HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control**</span></span>

> [!IMPORTANT]
> <span data-ttu-id="4b5ee-137">Un servicio no debe intentar aumentar el límite de tiempo mediante la modificación de este valor.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-137">A service should not attempt to increase the time limit by modifying this value.</span></span> <span data-ttu-id="4b5ee-138">Si necesita establecer **WaitToKillServiceTimeout** manualmente, el valor debe estar en milisegundos.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-138">If you do need to set **WaitToKillServiceTimeout** by hand, the value should be in milliseconds.</span></span>

<span data-ttu-id="4b5ee-139">Los clientes requieren un apagado rápido del sistema operativo.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-139">Customers require fast shutdown of the operating system.</span></span> <span data-ttu-id="4b5ee-140">Por ejemplo, si un equipo que ejecuta la alimentación de UPS no puede completar el apagado antes de que el SAI quede sin alimentación, se pueden perder datos.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-140">For example, if a computer running on UPS power cannot complete shutdown before the UPS runs out of power, data can be lost.</span></span> <span data-ttu-id="4b5ee-141">Por lo tanto, los servicios deben completar las tareas de limpieza lo más rápido posible.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-141">Therefore, services should complete their cleanup tasks as quickly as possible.</span></span> <span data-ttu-id="4b5ee-142">Es recomendable minimizar los datos no guardados guardando los datos periódicamente, realizando un seguimiento de los datos que se guardan en el disco y guardando los datos no guardados en el apagado.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-142">It is a good practice to minimize unsaved data by saving data on a regular basis, keeping track of the data that is saved to disk, and only saving your unsaved data on shutdown.</span></span> <span data-ttu-id="4b5ee-143">Dado que el equipo se está apagando, no dedique tiempo a liberar memoria asignada u otros recursos del sistema.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-143">Because the computer is being shut down, do not spend time releasing allocated memory or other system resources.</span></span> <span data-ttu-id="4b5ee-144">Si necesita notificar a un servidor que está saliendo, minimice el tiempo invertido en esperar una respuesta, ya que los problemas de red pueden retrasar el cierre del servicio.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-144">If you need to notify a server that you are exiting, minimize the time spent waiting for a reply, because network problems could delay the shutdown of your service.</span></span>

<span data-ttu-id="4b5ee-145">Tenga en cuenta que durante el cierre del servicio, de forma predeterminada, el SCM no tiene en cuenta las dependencias.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-145">Note that during service shutdown, by default, the SCM does not take dependencies into consideration.</span></span> <span data-ttu-id="4b5ee-146">El SCM enumera la lista de servicios en ejecución y envía el comando de **\_ \_ cierre del control de servicio** .</span><span class="sxs-lookup"><span data-stu-id="4b5ee-146">The SCM enumerates the list of running services and sends the **SERVICE\_CONTROL\_SHUTDOWN** command.</span></span> <span data-ttu-id="4b5ee-147">Por lo tanto, se puede producir un error en un servicio porque ya se ha detenido otro servicio del que depende.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-147">Therefore, a service may fail because another service it depends on has already stopped.</span></span>

<span data-ttu-id="4b5ee-148">Para establecer manualmente el orden de cierre de los servicios, cree un valor del registro de multicadena que contenga los nombres de servicio en el orden en que deben cerrarse y asígnelo al valor **PreshutdownOrder** de la clave de control, como se indica a continuación:</span><span class="sxs-lookup"><span data-stu-id="4b5ee-148">To set the shutdown order of services manually, create a multistring registry value that contains the service names in the order in which they should be shut down and assign it to the Control key's **PreshutdownOrder** value, as follows:</span></span>

<span data-ttu-id="4b5ee-149">**HKEY \_ local \_ Machine \\ System \\ CurrentControlSet \\ control \\ PreshutdownOrder = "orden de cierre"**</span><span class="sxs-lookup"><span data-stu-id="4b5ee-149">**HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\PreshutdownOrder="Shutdown Order"**</span></span>

<span data-ttu-id="4b5ee-150">Para establecer el orden de cierre de los servicios dependientes de la aplicación, utilice la función [**SetProcessShutdownParameters**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setprocessshutdownparameters) .</span><span class="sxs-lookup"><span data-stu-id="4b5ee-150">To set the shutdown order of dependent services from your application, use the [**SetProcessShutdownParameters**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setprocessshutdownparameters) function.</span></span> <span data-ttu-id="4b5ee-151">El SCM usa esta función para proporcionar a su controlador prioridad 0x1E0.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-151">The SCM uses this function to give its handler 0x1E0 priority.</span></span> <span data-ttu-id="4b5ee-152">El SCM envía notificaciones de **\_ \_ cierre del control de servicio** cuando se llama a su controlador de control y espera a que los servicios salgan antes de volver de su controlador de control.</span><span class="sxs-lookup"><span data-stu-id="4b5ee-152">The SCM sends **SERVICE\_CONTROL\_SHUTDOWN** notifications when its control handler is called and waits for the services to exit before returning from its control handler.</span></span>

## <a name="related-topics"></a><span data-ttu-id="4b5ee-153">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="4b5ee-153">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="4b5ee-154">Escribir una función de controlador de control</span><span class="sxs-lookup"><span data-stu-id="4b5ee-154">Writing a Control Handler Function</span></span>](writing-a-control-handler-function.md)
</dt> </dl>

 

 
