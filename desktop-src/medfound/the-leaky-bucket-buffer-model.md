---
description: El &\# 0034; depósito de fugas&\# 0034; modelo es una forma de modelar los requisitos de almacenamiento en búfer para la reproducción fluida.
ms.assetid: 2f7f80d6-3abb-462f-a571-b223a1d59da6
title: El modelo de búfer de depósito con fugas (Microsoft Media Foundation)
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 0f5a99932fb121808f6a49323360c47c09d0acbb
ms.sourcegitcommit: de72a1294df274b0a71dc0fdc42d757e5f6df0f3
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 03/05/2021
ms.locfileid: "105717413"
---
# <a name="the-leaky-bucket-buffer-model-microsoft-media-foundation"></a><span data-ttu-id="e4416-103">El modelo de búfer de depósito con fugas (Microsoft Media Foundation)</span><span class="sxs-lookup"><span data-stu-id="e4416-103">The Leaky Bucket Buffer Model (Microsoft Media Foundation)</span></span>

<span data-ttu-id="e4416-104">Al transmitir por secuencias contenido multimedia a través de una red, el descodificador recibe datos codificados en una velocidad teóricamente constante (la velocidad de transmisión).</span><span class="sxs-lookup"><span data-stu-id="e4416-104">When you stream media over a network, the decoder receives encoded data at a theoretically constant rate (the transmission rate).</span></span> <span data-ttu-id="e4416-105">El descodificador consume estos datos para generar una salida descodificada.</span><span class="sxs-lookup"><span data-stu-id="e4416-105">The decoder consumes this data to produce decoded output.</span></span> <span data-ttu-id="e4416-106">Sin embargo, en el caso general, el descodificador consume los datos a una velocidad *variable* , ya que el codificador puede usar una velocidad de codificación variable.</span><span class="sxs-lookup"><span data-stu-id="e4416-106">In the general case, however, the decoder consumes the data at a *variable* rate, because then encoder can use a variable encoding rate.</span></span>

<span data-ttu-id="e4416-107">El modelo de "depósito de fugas" es una manera de modelar los requisitos de almacenamiento en búfer para la reproducción fluida.</span><span class="sxs-lookup"><span data-stu-id="e4416-107">The "leaky bucket" model is a way to model the buffering requirements for smooth playback.</span></span> <span data-ttu-id="e4416-108">En este modelo, el descodificador mantiene un búfer.</span><span class="sxs-lookup"><span data-stu-id="e4416-108">In this model, the decoder maintains a buffer.</span></span> <span data-ttu-id="e4416-109">Los datos codificados van de la red al búfer y del búfer al descodificador.</span><span class="sxs-lookup"><span data-stu-id="e4416-109">Encoded data goes from the network into the buffer, and from the buffer into the decoder.</span></span> <span data-ttu-id="e4416-110">Si el búfer se desborda, significa que el descodificador está quitando datos del búfer más rápidamente de lo que la red lo está entregando.</span><span class="sxs-lookup"><span data-stu-id="e4416-110">If the buffer underflows, it means the decoder is removing data from the buffer faster than the network is delivering it.</span></span> <span data-ttu-id="e4416-111">Si el búfer se desborda, significa que la red está entregando datos más rápido de lo que el descodificador lo consume.</span><span class="sxs-lookup"><span data-stu-id="e4416-111">If the buffer overflows, it means the network is delivering data faster than the decoder consumes it.</span></span>

<span data-ttu-id="e4416-112">En este tema se describe el modelo de "depósito de fugas" de búferes para la codificación y la descodificación.</span><span class="sxs-lookup"><span data-stu-id="e4416-112">This topic describes the "leaky bucket" model of buffers for encoding and decoding.</span></span>

-   [<span data-ttu-id="e4416-113">El depósito de fugas</span><span class="sxs-lookup"><span data-stu-id="e4416-113">The Leaky Bucket</span></span>](#the-leaky-bucket)
-   [<span data-ttu-id="e4416-114">El depósito en uso</span><span class="sxs-lookup"><span data-stu-id="e4416-114">The Bucket in Use</span></span>](#the-bucket-in-use)
-   [<span data-ttu-id="e4416-115">Establecimiento de valores de cubo con fugas para secuencias ASF</span><span class="sxs-lookup"><span data-stu-id="e4416-115">Setting Leaky Bucket Values for ASF Streams</span></span>](#setting-leaky-bucket-values-for-asf-streams)
-   [<span data-ttu-id="e4416-116">Valores de depósito con fugas en el multiplexor ASF</span><span class="sxs-lookup"><span data-stu-id="e4416-116">Leaky Bucket Values in the ASF Multiplexer</span></span>](#leaky-bucket-values-in-the-asf-multiplexer)
-   [<span data-ttu-id="e4416-117">Actualización de valores de cubo con fugas en el receptor de medios ASF</span><span class="sxs-lookup"><span data-stu-id="e4416-117">Updating Leaky Bucket Values in the ASF Media Sink</span></span>](#updating-leaky-bucket-values-in-the-asf-media-sink)
-   [<span data-ttu-id="e4416-118">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="e4416-118">Related topics</span></span>](#related-topics)

## <a name="the-leaky-bucket"></a><span data-ttu-id="e4416-119">El depósito de fugas</span><span class="sxs-lookup"><span data-stu-id="e4416-119">The Leaky Bucket</span></span>

<span data-ttu-id="e4416-120">Para entender el modelo de depósito con fugas, considere la posibilidad de un cubo con un pequeño orificio en la parte inferior.</span><span class="sxs-lookup"><span data-stu-id="e4416-120">To understand the leaky bucket model, consider a bucket with a small hole at the bottom.</span></span> <span data-ttu-id="e4416-121">Tres parámetros definen el cubo:</span><span class="sxs-lookup"><span data-stu-id="e4416-121">Three parameters define the bucket:</span></span>

-   <span data-ttu-id="e4416-122">La capacidad (B)</span><span class="sxs-lookup"><span data-stu-id="e4416-122">The capacity (B)</span></span>
-   <span data-ttu-id="e4416-123">La velocidad a la que el agua fluye fuera del depósito (R)</span><span class="sxs-lookup"><span data-stu-id="e4416-123">The rate at which water flows out of the bucket (R)</span></span>
-   <span data-ttu-id="e4416-124">El llenado inicial del depósito (F)</span><span class="sxs-lookup"><span data-stu-id="e4416-124">The initial fullness of the bucket (F)</span></span>

<span data-ttu-id="e4416-125">En esta metáfora, el cubo es el búfer:</span><span class="sxs-lookup"><span data-stu-id="e4416-125">In this metaphor, the bucket is the buffer:</span></span>

![Ilustración en la que se muestra un búfer como un depósito, la velocidad de entrada como agua que entra en el depósito y la tasa de salida como agua que sale por un orificio en el depósito](images/asf-components03.png)

<span data-ttu-id="e4416-127">Si el agua se vierten en el depósito con la velocidad *R* exactamente, el cubo permanecerá en F, ya que la tasa de entrada es igual a la tasa de salida.</span><span class="sxs-lookup"><span data-stu-id="e4416-127">If water is poured into the bucket at exactly rate *R*, the bucket will remain at F, because the input rate equals the output rate.</span></span> <span data-ttu-id="e4416-128">Si la velocidad de entrada aumenta mientras *R* permanece constante, el depósito acumula agua.</span><span class="sxs-lookup"><span data-stu-id="e4416-128">If the input rate increases while *R* remains constant, the bucket accumulates water.</span></span> <span data-ttu-id="e4416-129">Si la velocidad de entrada es mayor que *R* durante un período sostenido, el cubo se desborda.</span><span class="sxs-lookup"><span data-stu-id="e4416-129">If the input rate is larger than *R* for a sustained period, eventually the bucket overflows.</span></span> <span data-ttu-id="e4416-130">Sin embargo, la velocidad de entrada puede variar en torno a *R* sin desbordar el cubo, siempre que la tasa de entrada promedio no supere la capacidad del depósito.</span><span class="sxs-lookup"><span data-stu-id="e4416-130">However, the input rate can vary around *R* without overflowing the bucket, as long as the average input rate does not exceed the capacity of the bucket.</span></span> <span data-ttu-id="e4416-131">Cuanto mayor sea la capacidad, más la velocidad de entrada puede variar dentro de un período de tiempo determinado.</span><span class="sxs-lookup"><span data-stu-id="e4416-131">The larger the capacity, the more the input rate can vary within a given window of time.</span></span>

<span data-ttu-id="e4416-132">En ASF, el depósito de fugas se define mediante tres parámetros:</span><span class="sxs-lookup"><span data-stu-id="e4416-132">In ASF, the leaky bucket is defined by three parameters:</span></span>

-   <span data-ttu-id="e4416-133">La velocidad de bits promedio, en bytes por segundo, que corresponde a la tasa de salida (*R*)</span><span class="sxs-lookup"><span data-stu-id="e4416-133">The average bit rate, in bytes per second, which corresponds to the output rate (*R*)</span></span>
-   <span data-ttu-id="e4416-134">La ventana de búfer, medida en milisegundos, que corresponde a la capacidad de depósito (*B*).</span><span class="sxs-lookup"><span data-stu-id="e4416-134">The buffer window, measured in milliseconds, which corresponds to the bucket capacity (*B*).</span></span>
-   <span data-ttu-id="e4416-135">El llenado inicial del búfer, que normalmente se establece en cero.</span><span class="sxs-lookup"><span data-stu-id="e4416-135">The initial buffer fullness, which is generally set to zero.</span></span>

<span data-ttu-id="e4416-136">La velocidad de bits mide el promedio de bits por segundo en el flujo codificado.</span><span class="sxs-lookup"><span data-stu-id="e4416-136">The bit rate measures the average number of bits per second in the encoded stream.</span></span> <span data-ttu-id="e4416-137">La ventana de búfer mide el número de milisegundos de datos a la velocidad de bits que pueden caber en el búfer.</span><span class="sxs-lookup"><span data-stu-id="e4416-137">The buffer window measures the number of milliseconds of data at that bit rate that can fit in the buffer.</span></span> <span data-ttu-id="e4416-138">El tamaño del búfer en bits es igual a R \* (B/1000).</span><span class="sxs-lookup"><span data-stu-id="e4416-138">The size of the buffer in bits is equal to R \* (B / 1000).</span></span>

<span data-ttu-id="e4416-139">Los datos de carga de ASF pueden entrar en el depósito de fugas en momentos irregulares y en cantidades irregulares, pero deben dejar el depósito en una velocidad de bits positivo constante.</span><span class="sxs-lookup"><span data-stu-id="e4416-139">ASF payload data may enter the leaky bucket at irregular times and in irregular amounts, but must leave the bucket at a constant positive bit rate.</span></span> <span data-ttu-id="e4416-140">Debido a la ventana de búfer, existe un posible retraso entre el momento en que la carga entra en el cubo y el momento en que lo abandona.</span><span class="sxs-lookup"><span data-stu-id="e4416-140">Because of the buffer window, there is a possible delay between the time that payload enters the bucket and when it leaves.</span></span> <span data-ttu-id="e4416-141">El retraso máximo que se puede producir es *B* / *R*.</span><span class="sxs-lookup"><span data-stu-id="e4416-141">The maximum delay that can occur is *B*/*R*.</span></span> <span data-ttu-id="e4416-142">Los datos de carga que entran en el depósito están según el tiempo de presentación y nunca deben desbordar el depósito.</span><span class="sxs-lookup"><span data-stu-id="e4416-142">The payload data that enters into the bucket is according to the presentation time and must never overflow the bucket.</span></span> <span data-ttu-id="e4416-143">Además del tiempo de presentación, cada carga también tiene un tiempo de envío, es decir, la hora a la que los datos de carga salen del cubo según la velocidad de bits.</span><span class="sxs-lookup"><span data-stu-id="e4416-143">In addition to the presentation time, each payload also has a send time—the time at which the payload data leaves the bucket according to the bit rate.</span></span> <span data-ttu-id="e4416-144">La hora de envío debe ser anterior al tiempo de presentación para asegurarse de que, cuando el depósito de fugas esté cerca de estar lleno, cada carga deja el cubo antes o en el momento de la presentación.</span><span class="sxs-lookup"><span data-stu-id="e4416-144">Send time must be earlier than the presentation time to ensure that, when the leaky bucket gets close to being full, every payload leaves the bucket before or at its presentation time.</span></span> <span data-ttu-id="e4416-145">Para ello, los tiempos de presentación se desplazan hacia arriba *por el* / valor de *R* (el *predesplazamiento*) y los tiempos de envío obtienen un encabezado empiece a partir de cero.</span><span class="sxs-lookup"><span data-stu-id="e4416-145">To accomplish this, the presentation times are shifted ahead by the *B*/*R* value (the *preroll*), and the send times get a head start starting at zero.</span></span> <span data-ttu-id="e4416-146">La hora de envío no debe ser posterior a la hora de presentación, ya que esto indicaría que la carga entró en el depósito demasiado tarde y no se puede incluir en el objeto de datos.</span><span class="sxs-lookup"><span data-stu-id="e4416-146">The send time must be no later than the presentation time because that would indicate that the payload entered the bucket too late and cannot be included in the data object.</span></span> <span data-ttu-id="e4416-147">El valor de reversión se incluye en el [objeto de encabezado ASF](asf-file-structure.md) .</span><span class="sxs-lookup"><span data-stu-id="e4416-147">The preroll value is included in the [ASF Header Object](asf-file-structure.md) .</span></span>

<span data-ttu-id="e4416-148">Para el streaming sin problemas a través de la red, las secuencias comprimidas dentro del contenido multimedia deben mantener una velocidad de bits constante a lo largo de la duración de la reproducción.</span><span class="sxs-lookup"><span data-stu-id="e4416-148">For glitch-free streaming over the network, compressed streams within the media content must maintain a constant bit rate throughout the playback duration.</span></span> <span data-ttu-id="e4416-149">El modelo de depósito de fugas ASF garantiza que los datos multimedia se envíen a través de la red a una velocidad de bits constante.</span><span class="sxs-lookup"><span data-stu-id="e4416-149">The ASF leaky bucket model ensures that media data is sent across the network at a constant bit rate.</span></span> <span data-ttu-id="e4416-150">Los parámetros del depósito de fuga se especifican en el objeto Extended Stream Properties del [objeto de encabezado ASF](asf-file-structure.md).</span><span class="sxs-lookup"><span data-stu-id="e4416-150">The parameters of the leaky bucket are specified in the Extended Stream Properties Object of the [ASF Header Object](asf-file-structure.md).</span></span> <span data-ttu-id="e4416-151">En Microsoft Media Foundation, se establecen como atributos en el tipo de medio que representa la secuencia.</span><span class="sxs-lookup"><span data-stu-id="e4416-151">In Microsoft Media Foundation, they are set as attributes on the media type that represents the stream.</span></span>

<span data-ttu-id="e4416-152">Los valores del depósito con fugas se definen tanto en el receptor de archivos ASF como en el objeto multiplexor ASF subyacente, y en el codificador de Windows Media.</span><span class="sxs-lookup"><span data-stu-id="e4416-152">The leaky bucket values are defined both in the ASF file sink and the underlying ASF multiplexer object, and the Windows Media encoder.</span></span> <span data-ttu-id="e4416-153">Estos valores pueden ser iguales o diferentes.</span><span class="sxs-lookup"><span data-stu-id="e4416-153">These values could be same or different.</span></span> <span data-ttu-id="e4416-154">Por ejemplo, considere un escenario de streaming, que requiere que las muestras de audio se entreguen después de los ejemplos de vídeo para que el archivo se pueda transmitir sin latencia.</span><span class="sxs-lookup"><span data-stu-id="e4416-154">For example, consider a streaming scenario, which requires the audio samples to be delivered later than the video samples so that the file can be streamed without latency.</span></span> <span data-ttu-id="e4416-155">Para ello, el depósito de fugas del flujo de audio del receptor de medios se puede establecer en un valor mayor que el valor establecido en el codificador de audio de Windows Media.</span><span class="sxs-lookup"><span data-stu-id="e4416-155">To achieve this, the audio stream's leaky bucket in the media sink can be set to a value higher than the value set in the Windows Media audio encoder.</span></span>

<span data-ttu-id="e4416-156">Para establecer los valores de B/R en el codificador, la aplicación debe establecer las propiedades [**MFPKEY \_ RAVG**](mfpkey-ravgproperty.md), [**MFPKEY \_ BAVG**](mfpkey-bavgproperty.md), [**MFPKEY \_ RMAX**](mfpkey-rmaxproperty.md)y [**MFPKEY \_ Bmax**](mfpkey-bmaxproperty.md) .</span><span class="sxs-lookup"><span data-stu-id="e4416-156">To set B/R values in the encoder, the application must set the [**MFPKEY\_RAVG**](mfpkey-ravgproperty.md), [**MFPKEY\_BAVG**](mfpkey-bavgproperty.md), [**MFPKEY\_RMAX**](mfpkey-rmaxproperty.md), and [**MFPKEY\_BMAX**](mfpkey-bmaxproperty.md) properties.</span></span> <span data-ttu-id="e4416-157">Para obtener información sobre cómo establecer las propiedades del codificador, consulte [propiedades de codificación](configuring-the-encoder.md).</span><span class="sxs-lookup"><span data-stu-id="e4416-157">For information about setting properties in the encoder, see [Encoding Properties](configuring-the-encoder.md).</span></span>

## <a name="the-bucket-in-use"></a><span data-ttu-id="e4416-158">El depósito en uso</span><span class="sxs-lookup"><span data-stu-id="e4416-158">The Bucket in Use</span></span>

<span data-ttu-id="e4416-159">El objetivo de un codificador es asegurarse de que el contenido nunca desborda el búfer.</span><span class="sxs-lookup"><span data-stu-id="e4416-159">The goal of an encoder is to ensure that the content never overflows the buffer.</span></span> <span data-ttu-id="e4416-160">El codificador usa los valores de velocidad de bits y de la ventana de búfer como guías.</span><span class="sxs-lookup"><span data-stu-id="e4416-160">The encoder uses the bit rate and buffer window values as guides.</span></span> <span data-ttu-id="e4416-161">El número real de bits pasados a lo largo de un período de tiempo igual a la ventana de búfer nunca puede ser mayor que el doble del tamaño del búfer.</span><span class="sxs-lookup"><span data-stu-id="e4416-161">The actual number of bits passed over any period of time equal to the buffer window can never be greater than twice the size of the buffer.</span></span>

<span data-ttu-id="e4416-162">Considere el ejemplo siguiente: tiene un depósito de 3 litros con un orificio en él a través del cual 1 galones puede fluir por minuto.</span><span class="sxs-lookup"><span data-stu-id="e4416-162">Consider the following example: You have a 3-gallon bucket with a hole in it through which 1 gallon can flow per minute.</span></span> <span data-ttu-id="e4416-163">Coloque el depósito en una spigot y abra la válvula para dejar agua a una velocidad de 1 galón por minuto.</span><span class="sxs-lookup"><span data-stu-id="e4416-163">You put the bucket under a spigot and open the valve to let out water at a rate of 1 gallon per minute.</span></span> <span data-ttu-id="e4416-164">El agua fluye fuera del cubo tan pronto como entra, sin dejar ningún extra en el cubo.</span><span class="sxs-lookup"><span data-stu-id="e4416-164">The water flows out of the bucket as quickly as it enters, leaving no extra in the bucket.</span></span> <span data-ttu-id="e4416-165">A continuación, se aumenta el flujo de spigot a 2 galones por minuto.</span><span class="sxs-lookup"><span data-stu-id="e4416-165">Then you increase the flow from the spigot to 2 gallons per minute.</span></span> <span data-ttu-id="e4416-166">Cada minuto que el agua fluye a esta velocidad, 2 litros entran en el depósito y 1 galones se filtran, lo que sale de 1 galones en el cubo.</span><span class="sxs-lookup"><span data-stu-id="e4416-166">Each minute that the water flows at this rate, 2 gallons go into the bucket and 1 gallon leaks out, leaving 1 gallon in the bucket.</span></span> <span data-ttu-id="e4416-167">Al final de 3 minutos, se han desplazado 6 litros de agua en el depósito, se han perdido 3 galones y el cubo está lleno.</span><span class="sxs-lookup"><span data-stu-id="e4416-167">At the end of 3 minutes, 6 gallons of water have gone into the bucket, 3 gallons have leaked out, and the bucket is full.</span></span>

<span data-ttu-id="e4416-168">En la práctica, nunca se consigue la velocidad de datos máxima teórica a lo largo de un intervalo igual a la ventana del búfer.</span><span class="sxs-lookup"><span data-stu-id="e4416-168">In practice, the theoretical maximum data rate over an interval equal to the buffer window is never achieved.</span></span> <span data-ttu-id="e4416-169">En el ejemplo anterior se presupone una velocidad de datos constante.</span><span class="sxs-lookup"><span data-stu-id="e4416-169">The previous example assumed a constant data rate.</span></span> <span data-ttu-id="e4416-170">Dado el mismo depósito de 3 litros, podría aumentar la velocidad de flujo de spigot a 6 galones por minuto durante un minuto y, a continuación, desactivar el spigot durante dos minutos.</span><span class="sxs-lookup"><span data-stu-id="e4416-170">Given the same 3-gallon bucket, you could increase the flow rate from the spigot to 6 gallons per minute for one minute and then turn the spigot off for two minutes.</span></span> <span data-ttu-id="e4416-171">Aunque la cantidad total de agua que se coloca en el depósito está dentro del máximo teórico de la ventana de búfer, la concentración de esa cantidad en una parte de la ventana provoca el desbordamiento del cubo.</span><span class="sxs-lookup"><span data-stu-id="e4416-171">Even though the total amount of water put into the bucket is within the theoretical maximum for the buffer window, the concentration of that amount into one part of the window causes the bucket to overflow.</span></span> <span data-ttu-id="e4416-172">A 6 galones por minuto, el depósito de 3 litros se desborda poco después de pasar 30 segundos.</span><span class="sxs-lookup"><span data-stu-id="e4416-172">At 6 gallons per minute, the 3-gallon bucket overflows shortly after 30 seconds pass.</span></span> <span data-ttu-id="e4416-173">Por lo tanto, la cantidad de datos máxima real que se puede entregar al búfer a lo largo de un intervalo igual a la configuración de la ventana de búfer depende del tamaño de cada uno de los ejemplos y del momento en que se entregan.</span><span class="sxs-lookup"><span data-stu-id="e4416-173">Therefore, the actual maximum amount of data that can be delivered to the buffer over the duration of any interval equal to the buffer window setting depends upon the size of individual samples and when they are delivered.</span></span>

<span data-ttu-id="e4416-174">Hasta ahora, los ejemplos solo han analizado el búfer usado por el descodificador, pero el codificador que crea el contenido comprimido también usa un búfer de cubo de pérdida de memoria.</span><span class="sxs-lookup"><span data-stu-id="e4416-174">So far the examples have only discussed the buffer used by the decoder, but a leaky bucket buffer is also used by the encoder which creates the compressed content.</span></span> <span data-ttu-id="e4416-175">El codificador realiza los ajustes necesarios en los algoritmos de compresión para mantener la velocidad de bits de los ejemplos comprimidos dentro de los límites descritos por la ventana velocidad de bits y búfer, suponiendo que los ejemplos se entreguen al descodificador a una velocidad constante.</span><span class="sxs-lookup"><span data-stu-id="e4416-175">The encoder makes whatever adjustments are necessary to the compression algorithms to keep the bit rate of the compressed samples within the boundaries described by the bit rate and buffer window, assuming that the samples will be delivered to the decoder at a constant rate.</span></span> <span data-ttu-id="e4416-176">Puede pensar en el cubo del codificador como la creación de reflejo del cubo del descodificador.</span><span class="sxs-lookup"><span data-stu-id="e4416-176">You can think of the encoder bucket as mirroring the decoder bucket.</span></span> <span data-ttu-id="e4416-177">El depósito del codificador se rellena a una velocidad variable determinada por el tamaño de las muestras individuales y las pérdidas a una velocidad constante igual a la velocidad de bits promedio.</span><span class="sxs-lookup"><span data-stu-id="e4416-177">The encoder bucket is filled at a variable rate determined by the size of the individual samples and leaks at a constant rate equal to the average bit rate.</span></span>

<span data-ttu-id="e4416-178">Considere el ejemplo siguiente de un codificador y un descodificador conectados juntos a través de una red.</span><span class="sxs-lookup"><span data-stu-id="e4416-178">Consider the following example of an encoder and decoder connected together over a network.</span></span> <span data-ttu-id="e4416-179">Codifica un archivo de vídeo en 30 fotogramas por segundo con una velocidad de bits de 6.000 bits por segundo y una ventana de búfer de 3 segundos (un tamaño de búfer total de 18.000 bits).</span><span class="sxs-lookup"><span data-stu-id="e4416-179">You encode a video file at 30 frames per second with a bit rate of 6,000 bits per second and a buffer window of 3 seconds (a total buffer size of 18,000 bits).</span></span> <span data-ttu-id="e4416-180">La primera muestra se codifica como un fotograma clave y ocupa 7.000 bits.</span><span class="sxs-lookup"><span data-stu-id="e4416-180">The first sample is encoded as a key frame and takes up 7,000 bits.</span></span> <span data-ttu-id="e4416-181">El búfer del codificador ahora contiene 7.000 bits.</span><span class="sxs-lookup"><span data-stu-id="e4416-181">The encoder buffer now contains 7,000 bits.</span></span> <span data-ttu-id="e4416-182">Los 29 fotogramas siguientes son todos fotogramas Delta que tienen un total de 3.000 bits.</span><span class="sxs-lookup"><span data-stu-id="e4416-182">The next 29 frames are all delta frames that total 3,000 bits.</span></span> <span data-ttu-id="e4416-183">Por lo tanto, el primer segundo de contenido (30 fotogramas) pondría el llenado de búfer en 10.000 bits si no se ha perdido nada. Sabemos que la velocidad de bits de la secuencia es 6.000 bits por segundo, por lo que, una vez que el primer segundo del contenido codificado se coloca en el búfer del codificador, el llenado desciende hasta 4.000 bits.</span><span class="sxs-lookup"><span data-stu-id="e4416-183">So the first second of content (30 frames) would put the buffer fullness at 10,000 bits if nothing were leaking out. We know that the bit rate of the stream is 6,000 bits per second, so after the first second of encoded content is put in the encoder buffer, the fullness drops to 4,000 bits.</span></span> <span data-ttu-id="e4416-184">En la aplicación de descodificación, esta secuencia se entrega al búfer del descodificador en 6.000 bits por segundo.</span><span class="sxs-lookup"><span data-stu-id="e4416-184">In the decoding application, this stream is delivered to the decoder buffer at 6,000 bits per second.</span></span> <span data-ttu-id="e4416-185">Después de un segundo, el búfer contiene 6.000 bits.</span><span class="sxs-lookup"><span data-stu-id="e4416-185">After one second, the buffer contains 6,000 bits.</span></span> <span data-ttu-id="e4416-186">El primer ejemplo contiene 7.000 bits, por lo que el búfer del descodificador debe rellenarse más antes de que el descodificador comience a quitar ejemplos.</span><span class="sxs-lookup"><span data-stu-id="e4416-186">The first sample contains 7,000 bits, so the decoder buffer must be filled more before the decoder begins removing samples.</span></span>

## <a name="setting-leaky-bucket-values-for-asf-streams"></a><span data-ttu-id="e4416-187">Establecimiento de valores de cubo con fugas para secuencias ASF</span><span class="sxs-lookup"><span data-stu-id="e4416-187">Setting Leaky Bucket Values for ASF Streams</span></span>

<span data-ttu-id="e4416-188">En un escenario de codificación de archivos, una aplicación puede establecer los valores del depósito de fugas mientras se configuran las secuencias en el [perfil ASF](asf-profile.md).</span><span class="sxs-lookup"><span data-stu-id="e4416-188">In a file-encoding scenario, an application can set the leaky bucket values while configuring the streams in the [ASF Profile](asf-profile.md).</span></span>

<span data-ttu-id="e4416-189">Después de crear la secuencia y tener una referencia a la interfaz [**IMFASFStreamConfig**](/windows/desktop/api/wmcontainer/nn-wmcontainer-imfasfstreamconfig) de la secuencia, puede establecer los valores con los siguientes atributos:</span><span class="sxs-lookup"><span data-stu-id="e4416-189">After you have created the stream and have a reference to the stream's [**IMFASFStreamConfig**](/windows/desktop/api/wmcontainer/nn-wmcontainer-imfasfstreamconfig) interface, you can set the values by using the following attributes:</span></span>

-   <span data-ttu-id="e4416-190">[**MF \_ ASFSTREAMCONFIG \_ LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) (valores de cubo de fugas promedio)</span><span class="sxs-lookup"><span data-stu-id="e4416-190">[**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) (average leaky bucket values)</span></span>
-   <span data-ttu-id="e4416-191">[**MF \_ ASFSTREAMCONFIG \_ LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) (valores de depósito máximo de fugas)</span><span class="sxs-lookup"><span data-stu-id="e4416-191">[**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) (maximum leaky bucket values)</span></span>

<span data-ttu-id="e4416-192">Para obtener información sobre cómo agregar secuencias y obtener el puntero **IMFASFStreamConfig** , consulte [Agregar información de secuencias al receptor de archivos ASF](adding-stream-information-to-the-asf-file-sink.md).</span><span class="sxs-lookup"><span data-stu-id="e4416-192">For information about adding streams and getting the **IMFASFStreamConfig** pointer, see [Adding Stream Information to the ASF File Sink](adding-stream-information-to-the-asf-file-sink.md).</span></span>

<span data-ttu-id="e4416-193">Estos valores contienen el siguiente conjunto de información:</span><span class="sxs-lookup"><span data-stu-id="e4416-193">These values contain the following set of information:</span></span>

-   <span data-ttu-id="e4416-194">Velocidad de bits media: obtiene la velocidad de bits media del tipo de medio de salida que se selecciona durante la negociación del tipo de medio.</span><span class="sxs-lookup"><span data-stu-id="e4416-194">Average bit rate: Get the average bit rate from the output media type that is selected during media type negotiation.</span></span> <span data-ttu-id="e4416-195">Use el atributo [**MF \_ MT \_ audio \_ AVG \_ bytes \_ por \_ segundo**](mf-mt-audio-avg-bytes-per-second-attribute.md) (para secuencias de audio) o el atributo de velocidad de [**\_ \_ \_ bits media MF MT**](mf-mt-avg-bitrate-attribute.md) (para secuencias de vídeo).</span><span class="sxs-lookup"><span data-stu-id="e4416-195">Use the [**MF\_MT\_AUDIO\_AVG\_BYTES\_PER\_SECOND**](mf-mt-audio-avg-bytes-per-second-attribute.md) attribute (for audio streams) or the [**MF\_MT\_AVG\_BITRATE**](mf-mt-avg-bitrate-attribute.md) attribute (for video streams).</span></span>
-   <span data-ttu-id="e4416-196">Ventana de búfer: Si tiene una instancia del codificador y ha negociado tipos de medios de salida, puede actualizar este valor más adelante consultando el codificador para la interfaz [**IWMCodecLeakyBucket**](/windows/desktop/api/wmcodecdsp/nn-wmcodecdsp-iwmcodecleakybucket) y llamando a [**IWMCodecLeakyBucket:: GetBufferSizeBits**](../wmformat/iwmcodecleakybucket-getbuffersizebits.md) (wmcodecifaces. h, wmcodecdspuuid. lib).</span><span class="sxs-lookup"><span data-stu-id="e4416-196">Buffer window: If you have an instance of the encoder and have negotiated output media types, you can update this value later by querying the encoder for the [**IWMCodecLeakyBucket**](/windows/desktop/api/wmcodecdsp/nn-wmcodecdsp-iwmcodecleakybucket) interface and then calling [**IWMCodecLeakyBucket::GetBufferSizeBits**](../wmformat/iwmcodecleakybucket-getbuffersizebits.md) (wmcodecifaces.h, wmcodecdspuuid.lib).</span></span> <span data-ttu-id="e4416-197">De lo contrario, use el valor predeterminado de 3000 milisegundos.</span><span class="sxs-lookup"><span data-stu-id="e4416-197">Otherwise, Use the default value of 3000 milliseconds.</span></span>
-   <span data-ttu-id="e4416-198">Tamaño de búfer inicial: establézcalo en 0.</span><span class="sxs-lookup"><span data-stu-id="e4416-198">Initial buffer size: Set to 0.</span></span>

<span data-ttu-id="e4416-199">Los valores proporcionados por la aplicación dependen del tipo de codificación y del tipo de medio de la secuencia.</span><span class="sxs-lookup"><span data-stu-id="e4416-199">The values provided by the application depend on the type of encoding and the media type of the stream.</span></span> <span data-ttu-id="e4416-200">Por ejemplo, la [codificación de velocidad de bits constante](constant-bit-rate-encoding.md) requiere una velocidad de bits fija predeterminada y una ventana de búfer.</span><span class="sxs-lookup"><span data-stu-id="e4416-200">For example, [Constant Bit Rate Encoding](constant-bit-rate-encoding.md) requires a predetermined fixed bit rate and a buffer window.</span></span> <span data-ttu-id="e4416-201">La aplicación puede especificar estos valores de depósitos de fugas estableciendo la propiedad de codificación de la [**\_ ventana de videoMFPKEY**](mfpkey-videowindowproperty.md) y el atributo [**MF \_ ASFSTREAMCONFIG \_ LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) en la secuencia.</span><span class="sxs-lookup"><span data-stu-id="e4416-201">The application can specify these leaky bucket values by setting the [**MFPKEY\_VIDEOWINDOW**](mfpkey-videowindowproperty.md) encoding property and the [**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) attribute on the stream.</span></span> <span data-ttu-id="e4416-202">Los valores de la ventana de búfer especificada se utilizan para asegurarse de que el archivo codificado tiene las horas de envío correctas marcadas en los paquetes de datos y el valor de la precodificación aparece en el objeto de encabezado ASF.</span><span class="sxs-lookup"><span data-stu-id="e4416-202">The specified buffer window values are used to make sure that the encoded file has the correct send times marked on the data packets and the preroll value appears in the ASF Header Object.</span></span> <span data-ttu-id="e4416-203">Basta con establecer **MF \_ ASFSTREAMCONFIG \_ LEAKYBUCKET1** porque estos valores especificados se copian en el atributo [**MF \_ ASFSTREAMCONFIG \_ LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) .</span><span class="sxs-lookup"><span data-stu-id="e4416-203">It is sufficient to set **MF\_ASFSTREAMCONFIG\_LEAKYBUCKET1** because these specified values are copied into the [**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) attribute.</span></span>

<span data-ttu-id="e4416-204">En el caso de los modos de codificación de dos pasos, debe establecer ambos atributos para especificar los valores promedio y máximo.</span><span class="sxs-lookup"><span data-stu-id="e4416-204">For 2-pass encoding modes you need to set both of these attributes to specify the average and maximum values.</span></span>

<span data-ttu-id="e4416-205">En el caso de la codificación VBR, la aplicación puede consultar los valores de los depósitos con fugas usados por el codificador solo después de que se complete la fase de codificación.</span><span class="sxs-lookup"><span data-stu-id="e4416-205">For VBR encoding, the application can query for the leaky bucket values used by the encoder only after the encoding pass is complete.</span></span> <span data-ttu-id="e4416-206">Por lo tanto, al configurar el receptor de medios, la aplicación puede elegir no establecer los atributos o propiedades relacionados con los depósitos de fugas.</span><span class="sxs-lookup"><span data-stu-id="e4416-206">Therefore, while configuring the media sink, the application can choose not to set the attributes or properties related to leaky buckets.</span></span> <span data-ttu-id="e4416-207">Después de la codificación, la aplicación debe consultar al codificador las propiedades [**MFPKEY \_ RAVG**](mfpkey-ravgproperty.md), [**MFPKEY \_ BAVG**](mfpkey-bavgproperty.md), [**MFPKEY \_ RMAX**](mfpkey-rmaxproperty.md)y [**MFPKEY \_ Bmax**](mfpkey-bmaxproperty.md) y establecerlas en el receptor de medios para que los valores precisos se reflejen en el objeto de encabezado.</span><span class="sxs-lookup"><span data-stu-id="e4416-207">After encoding, the application must query the encoder for the [**MFPKEY\_RAVG**](mfpkey-ravgproperty.md), [**MFPKEY\_BAVG**](mfpkey-bavgproperty.md), [**MFPKEY\_RMAX**](mfpkey-rmaxproperty.md), and [**MFPKEY\_BMAX**](mfpkey-bmaxproperty.md) properties and set them in the media sink so that the accurate values are reflected in the Header Object.</span></span> <span data-ttu-id="e4416-208">Para obtener un ejemplo de código sobre cómo actualizar los valores de la codificación VBR, vea "actualizar las propiedades de codificación en el receptor de archivos" en el [Tutorial: 1-pasar la codificación de Windows Media](tutorial--1-pass-windows-media-encoding.md).</span><span class="sxs-lookup"><span data-stu-id="e4416-208">For code example about how to update the values for VBR encoding, see "Update Encoding Properties in the File Sink" in [Tutorial: 1-Pass Windows Media Encoding](tutorial--1-pass-windows-media-encoding.md).</span></span>

<span data-ttu-id="e4416-209">Si va a copiar contenido de Windows Media desde el origen al receptor de medios sin codificación, se deben establecer los valores de los depósitos con fugas en el receptor de medios.</span><span class="sxs-lookup"><span data-stu-id="e4416-209">If you are copying Windows Media content from source to media sink without encoding, the leaky bucket values must be set in the media sink.</span></span>

## <a name="leaky-bucket-values-in-the-asf-multiplexer"></a><span data-ttu-id="e4416-210">Valores de depósito con fugas en el multiplexor ASF</span><span class="sxs-lookup"><span data-stu-id="e4416-210">Leaky Bucket Values in the ASF Multiplexer</span></span>

<span data-ttu-id="e4416-211">En Media Foundation, el [multiplexor de ASF](asf-multiplexer.md) usa los valores del depósito de fugas para configurar los valores del cubo de fugas internas que usa para generar paquetes de datos.</span><span class="sxs-lookup"><span data-stu-id="e4416-211">In Media Foundation, the leaky bucket values are used by the [ASF Multiplexer](asf-multiplexer.md) to set up the internal leaky bucket values that it uses to generate data packets.</span></span> <span data-ttu-id="e4416-212">La carga está incluida en un ejemplo multimedia y una serie de ejemplos de medios constituye un paquete de datos ASF.</span><span class="sxs-lookup"><span data-stu-id="e4416-212">The payload is contained within a media sample and a series of media samples constitutes an ASF data packet.</span></span> <span data-ttu-id="e4416-213">En función de los valores del depósito de fugas y el tiempo de presentación, el multiplexor asigna un tiempo de envío para cada ejemplo de medio, de modo que las velocidades de bits de los paquetes que se envían a través de la red estén a una velocidad de bits constante (*R*).</span><span class="sxs-lookup"><span data-stu-id="e4416-213">Based on the leaky bucket values and the presentation time, the multiplexer assigns a send time for each media sample so that the bit rates of the packets being sent across the network is at a constant bit rate (*R*).</span></span>

<span data-ttu-id="e4416-214">Una aplicación no puede establecer valores de cubo con fugas directamente en el multiplexor.</span><span class="sxs-lookup"><span data-stu-id="e4416-214">An application cannot set leaky bucket values in the multiplexer directly.</span></span> <span data-ttu-id="e4416-215">Los valores se deben proporcionar en el receptor de medios ASF, que establece los valores adecuados en el multiplexor.</span><span class="sxs-lookup"><span data-stu-id="e4416-215">The values must be provided on the ASF media sink, which sets the appropriate values on the multiplexer.</span></span> <span data-ttu-id="e4416-216">El multiplexor usa los valores establecidos en [**MF \_ ASFSTREAMCONFIG \_ LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) y [**MF \_ ASFSTREAMCONFIG \_ LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) para validar que las muestras enviadas al receptor de medios ASF se generan usando los valores especificados.</span><span class="sxs-lookup"><span data-stu-id="e4416-216">The values set in [**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) and [**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) are used by the multiplexer to validate the samples sent to the ASF media sink are generated by using the specified values.</span></span>

## <a name="updating-leaky-bucket-values-in-the-asf-media-sink"></a><span data-ttu-id="e4416-217">Actualización de valores de cubo con fugas en el receptor de medios ASF</span><span class="sxs-lookup"><span data-stu-id="e4416-217">Updating Leaky Bucket Values in the ASF Media Sink</span></span>

<span data-ttu-id="e4416-218">Una aplicación puede sobrescribir los valores del cubo de pérdida de nivel de secuencia (establecido en el perfil ASF durante la creación de la secuencia) estableciendo la propiedad [**MFPKEY \_ ASFSTREAMSINK \_ corregida \_ LEAKYBUCKET**](mfpkey-asfstreamsink-corrected-leakybucket-property.md) en el almacén de propiedades del receptor de medios.</span><span class="sxs-lookup"><span data-stu-id="e4416-218">An application can overwrite the stream-level leaky bucket values (set in the ASF profile during stream creation) by setting the [**MFPKEY\_ASFSTREAMSINK\_CORRECTED\_LEAKYBUCKET**](mfpkey-asfstreamsink-corrected-leakybucket-property.md) property in the media sink's property store.</span></span> <span data-ttu-id="e4416-219">Para obtener una referencia al almacén de propiedades, use el objeto ContentInfo implementado por el receptor de medios.</span><span class="sxs-lookup"><span data-stu-id="e4416-219">To get a reference to the property store, use the ContentInfo object implemented by the media sink.</span></span> <span data-ttu-id="e4416-220">Para obtener más información, vea [establecer propiedades en el receptor de archivos](setting-properties-in-the-file-sink.md).</span><span class="sxs-lookup"><span data-stu-id="e4416-220">For more information, see [Setting Properties in the File Sink](setting-properties-in-the-file-sink.md).</span></span>

<span data-ttu-id="e4416-221">**Nota:**  Esta operación solo se permite para secuencias de audio.</span><span class="sxs-lookup"><span data-stu-id="e4416-221">**Note**  This operation is only allowed for audio streams.</span></span>

<span data-ttu-id="e4416-222">Esta propiedad debe establecerse después de haber establecido el tipo de salida en el codificador.</span><span class="sxs-lookup"><span data-stu-id="e4416-222">This property must be set after you have set the output type on the encoder.</span></span> <span data-ttu-id="e4416-223">Según la velocidad de bits establecida en el tipo de medio, el codificador calcula el tamaño del búfer para asegurarse de que los ejemplos de medios generados nunca desbordan el búfer.</span><span class="sxs-lookup"><span data-stu-id="e4416-223">Based on the bit rate set in the media type, the encoder calculates the buffer size to ensure that the generated media samples never overflow the buffer.</span></span> <span data-ttu-id="e4416-224">El codificador realiza los ajustes necesarios durante la compresión para mantener la velocidad de bits de los ejemplos comprimidos dentro de los límites descritos por la ventana de velocidad de bits y de búfer.</span><span class="sxs-lookup"><span data-stu-id="e4416-224">The encoder makes necessary adjustments during compression to keep the bit rate of the compressed samples within the boundaries described by the bit rate and buffer window.</span></span>

<span data-ttu-id="e4416-225">Similar a los atributos de configuración de la secuencia para los depósitos con fugas, establecer la velocidad de bits promedio y el tamaño del búfer, y el llenado inicial del búfer en una matriz de DWORDs.</span><span class="sxs-lookup"><span data-stu-id="e4416-225">Similar to the stream configuration attributes for leaky buckets, set the average bit rate and the buffer size, and the initial buffer fullness in an array of DWORDs.</span></span> <span data-ttu-id="e4416-226">Para obtener más información, consulte la sección "configuración de valores de cubos con fugas para secuencias ASF" en este tema.</span><span class="sxs-lookup"><span data-stu-id="e4416-226">For more information, see "Setting Leaky Bucket Values for ASF Streams" section in this topic.</span></span>

## <a name="related-topics"></a><span data-ttu-id="e4416-227">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="e4416-227">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="e4416-228">Compatibilidad con ASF en Media Foundation</span><span class="sxs-lookup"><span data-stu-id="e4416-228">ASF Support in Media Foundation</span></span>](asf-support-in-media-foundation.md)
</dt> <dt>

[<span data-ttu-id="e4416-229">Códecs de Windows Media</span><span class="sxs-lookup"><span data-stu-id="e4416-229">Windows Media Codecs</span></span>](windows-media-codecs.md)
</dt> </dl>

 

 
