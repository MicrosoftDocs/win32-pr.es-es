---
description: Un proveedor es un archivo DLL de rendimiento que proporciona datos de contador a los consumidores.
ms.assetid: bbb777fe-b97e-4777-b797-ec8525065610
title: Crear un archivo DLL de extensión de rendimiento
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d397f1581454aca1b25c447b35f250eefd215f57
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/07/2021
ms.locfileid: "103909742"
---
# <a name="creating-a-performance-extension-dll"></a><span data-ttu-id="1bbd8-103">Crear un archivo DLL de extensión de rendimiento</span><span class="sxs-lookup"><span data-stu-id="1bbd8-103">Creating a Performance Extension DLL</span></span>

> [!IMPORTANT]
> <span data-ttu-id="1bbd8-104">Debido a las limitaciones de rendimiento y confiabilidad significativas, el método para proporcionar los datos del contador de rendimiento que se describen en este tema puede modificarse o no estar disponible en el futuro.</span><span class="sxs-lookup"><span data-stu-id="1bbd8-104">Due to significant performance and reliability limitations, the method for providing performance counter data that this topic describes may be altered or unavailable in the future.</span></span> <span data-ttu-id="1bbd8-105">En su lugar, Microsoft recomienda usar el método descrito en [proporcionar datos de contadores con la versión 2,0](providing-counter-data-using-version-2-0.md) para crear nuevos contadores de rendimiento y migrar los contadores de rendimiento existentes para usar ese método también.</span><span class="sxs-lookup"><span data-stu-id="1bbd8-105">Instead, Microsoft recommends that you use the method described in [Providing Counter Data Using Version 2.0](providing-counter-data-using-version-2-0.md) for creating new performance counters and that you migrate existing performance counters to use that method as well.</span></span>

<span data-ttu-id="1bbd8-106">Un [proveedor v1](providing-counter-data.md) usa un archivo dll de rendimiento que proporciona datos de contador a los consumidores.</span><span class="sxs-lookup"><span data-stu-id="1bbd8-106">A [V1 provider](providing-counter-data.md) uses a performance DLL that provides counter data to consumers.</span></span> <span data-ttu-id="1bbd8-107">El archivo DLL de rendimiento debe exportar las funciones [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)), [**CollectPerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_collect_proc)y [**ClosePerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) .</span><span class="sxs-lookup"><span data-stu-id="1bbd8-107">The performance DLL must export the [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)), [**CollectPerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_collect_proc), and [**ClosePerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) functions.</span></span> <span data-ttu-id="1bbd8-108">Normalmente, se usa un archivo de definición de módulo (. def) para exportar las funciones del archivo DLL.</span><span class="sxs-lookup"><span data-stu-id="1bbd8-108">Typically, you use a module definition (.def) file to export the functions from the DLL.</span></span> <span data-ttu-id="1bbd8-109">El sistema llama a estas funciones cuando un consumidor consulta los datos de rendimiento.</span><span class="sxs-lookup"><span data-stu-id="1bbd8-109">The system calls these functions when a consumer queries performance data.</span></span>

<span data-ttu-id="1bbd8-110">La primera vez que un consumidor llama a [**RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa), o si el consumidor usa la función [**RegOpenKey**](/windows/desktop/api/winreg/nf-winreg-regopenkeya) o [**RegConnectRegistry**](/windows/desktop/api/winreg/nf-winreg-regconnectregistrya) para abrir `HKEY_PERFORMANCE_DATA` , el sistema llama a la función [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) para cada proveedor [registrado](adding-performance-counters.md) en el equipo.</span><span class="sxs-lookup"><span data-stu-id="1bbd8-110">The first time a consumer calls [**RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa), or if the consumer uses the [**RegOpenKey**](/windows/desktop/api/winreg/nf-winreg-regopenkeya) or [**RegConnectRegistry**](/windows/desktop/api/winreg/nf-winreg-regconnectregistrya) function to open `HKEY_PERFORMANCE_DATA`, the system calls the [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) function for each provider that is [registered](adding-performance-counters.md) on the computer.</span></span> <span data-ttu-id="1bbd8-111">La excepción es si el proveedor especifica la lista de objetos que admite en la `[objects]` sección de. Archivo INI.</span><span class="sxs-lookup"><span data-stu-id="1bbd8-111">The exception is if the provider specifies the list of objects that it supports in the `[objects]` section of the .INI file.</span></span> <span data-ttu-id="1bbd8-112">En este caso, el sistema llama al proveedor solo si uno de los objetos consultados coincide con un objeto de la lista.</span><span class="sxs-lookup"><span data-stu-id="1bbd8-112">In this case, the system calls the provider only if one of the queried objects matches an object from the list.</span></span>

<span data-ttu-id="1bbd8-113">La función [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) proporciona a cada proveedor una oportunidad de inicializar sus estructuras de datos de rendimiento.</span><span class="sxs-lookup"><span data-stu-id="1bbd8-113">The [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) function gives each provider an opportunity to initialize its performance data structures.</span></span> <span data-ttu-id="1bbd8-114">Después, si la función **OpenPerformanceData** se devuelve correctamente, el sistema llama a la función [**CollectPerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_collect_proc) del proveedor.</span><span class="sxs-lookup"><span data-stu-id="1bbd8-114">Then, if the **OpenPerformanceData** function returns successfully, the system calls the provider's [**CollectPerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_collect_proc) function.</span></span> <span data-ttu-id="1bbd8-115">Las llamadas posteriores a [**RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa) hacen que el sistema llame a la función **CollectPerformanceData** .</span><span class="sxs-lookup"><span data-stu-id="1bbd8-115">Subsequent calls to [**RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa) cause the system to call the **CollectPerformanceData** function.</span></span>

<span data-ttu-id="1bbd8-116">Cuando el consumidor termina de recopilar datos de rendimiento, especifica `HKEY_PERFORMANCE_DATA` en una llamada a la función [**RegCloseKey**](/windows/desktop/api/winreg/nf-winreg-regclosekey) .</span><span class="sxs-lookup"><span data-stu-id="1bbd8-116">When the consumer finishes collecting performance data, it specifies `HKEY_PERFORMANCE_DATA` in a call to the [**RegCloseKey**](/windows/desktop/api/winreg/nf-winreg-regclosekey) function.</span></span> <span data-ttu-id="1bbd8-117">Esto hace que el sistema llame a la función [**ClosePerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) para cada proveedor.</span><span class="sxs-lookup"><span data-stu-id="1bbd8-117">This causes the system to call the [**ClosePerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) function for each provider.</span></span> <span data-ttu-id="1bbd8-118">A continuación, se descargan los proveedores.</span><span class="sxs-lookup"><span data-stu-id="1bbd8-118">The providers are then unloaded.</span></span>

<span data-ttu-id="1bbd8-119">Es posible que varios consumidores recopilen datos de rendimiento al mismo tiempo.</span><span class="sxs-lookup"><span data-stu-id="1bbd8-119">It is possible for multiple consumers to collect performance data at the same time.</span></span> <span data-ttu-id="1bbd8-120">El sistema llama a las funciones [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) y [**ClosePerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) solo una vez cada vez que se carga o descarga el archivo dll.</span><span class="sxs-lookup"><span data-stu-id="1bbd8-120">The system calls [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) and [**ClosePerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) functions only once each time the DLL is loaded or unloaded.</span></span>

> [!Note]
> <span data-ttu-id="1bbd8-121">Asegúrese de incluir extern "C" en el código de C++ para evitar que el compilador agregue decoraciones a los nombres de función; de lo contrario, es posible que el sistema no pueda encontrar las funciones.</span><span class="sxs-lookup"><span data-stu-id="1bbd8-121">Be sure to include extern "C" in your C++ code to prevent the compiler from adding decorations to your function names; otherwise, the system may fail to find your functions.</span></span>

> [!Note]
> <span data-ttu-id="1bbd8-122">Si se produce un error mientras se carga el archivo DLL de rendimiento, se buscan las funciones o se llama a las funciones, el sistema deshabilitará el proveedor para las colecciones posteriores en el mismo proceso.</span><span class="sxs-lookup"><span data-stu-id="1bbd8-122">If an error occurs while loading your performance DLL, finding your functions, or calling your functions, the system will disable the provider for subsequent collections within the same process.</span></span> <span data-ttu-id="1bbd8-123">Además, si esto ocurre durante la ejecución en un proceso con privilegios, el sistema agrega un valor **deshabilitar contadores de rendimiento** a la clave de **rendimiento** para evitar que el proveedor se cargue en el futuro.</span><span class="sxs-lookup"><span data-stu-id="1bbd8-123">In addition, if this occurs while running in a privileged process, the system adds a **Disable Performance Counters** value to your **Performance** key to prevent the provider from being loaded in the future.</span></span>

<span data-ttu-id="1bbd8-124">Para obtener más información sobre cómo escribir un archivo DLL de rendimiento, vea los temas siguientes:</span><span class="sxs-lookup"><span data-stu-id="1bbd8-124">For more information on writing a performance DLL, see the following topics:</span></span>

- [<span data-ttu-id="1bbd8-125">Implementación de la función OpenPerformanceData</span><span class="sxs-lookup"><span data-stu-id="1bbd8-125">Implementing the OpenPerformanceData function</span></span>](implementing-openperformancedata.md)
- [<span data-ttu-id="1bbd8-126">Implementación de la función CollectPerformanceData</span><span class="sxs-lookup"><span data-stu-id="1bbd8-126">Implementing the CollectPerformanceData function</span></span>](implementing-collectperformancedata.md)
- [<span data-ttu-id="1bbd8-127">Control de errores en el archivo DLL</span><span class="sxs-lookup"><span data-stu-id="1bbd8-127">Error Handling in the DLL</span></span>](error-handling-in-the-dll.md)
- [<span data-ttu-id="1bbd8-128">Restringir el acceso a los archivos dll de extensión de rendimiento</span><span class="sxs-lookup"><span data-stu-id="1bbd8-128">Restricting Access to Performance Extension DLLs</span></span>](restricting-access-to-performance-extension--dlls.md)
- [<span data-ttu-id="1bbd8-129">Ejemplos de DLL de rendimiento</span><span class="sxs-lookup"><span data-stu-id="1bbd8-129">Performance DLL Samples</span></span>](performance-dll-samples.md)
