---
description: Se puede configurar una entidad de certificación (CA) de Microsoft para archivar y recuperar la clave privada asociada a la clave pública enviada en la solicitud de certificado.
ms.assetid: c6535dbf-c3fe-4f70-9a70-02805253a651
title: Servidor de recuperación de claves
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: b4e9fd60b7ee6596b98953d382978be64695c035
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/07/2021
ms.locfileid: "103909646"
---
# <a name="key-recovery-server"></a><span data-ttu-id="36b17-103">Servidor de recuperación de claves</span><span class="sxs-lookup"><span data-stu-id="36b17-103">Key Recovery Server</span></span>

<span data-ttu-id="36b17-104">Se puede configurar una entidad de certificación (CA) de Microsoft para archivar y recuperar la clave privada asociada a la clave pública enviada en la solicitud de certificado.</span><span class="sxs-lookup"><span data-stu-id="36b17-104">A Microsoft certification authority (CA) can be configured to archive and recover the private key associated with the public key submitted in the certificate request.</span></span> <span data-ttu-id="36b17-105">La recuperación resulta útil si se pierde una clave.</span><span class="sxs-lookup"><span data-stu-id="36b17-105">Recovery is useful if a key is lost.</span></span> <span data-ttu-id="36b17-106">De forma predeterminada, solo se pueden archivar las claves de cifrado.</span><span class="sxs-lookup"><span data-stu-id="36b17-106">By default, only encryption keys can be archived.</span></span> <span data-ttu-id="36b17-107">No es necesario archivar las claves destinadas únicamente a la firma, ya que solo se necesita la clave pública para comprobar una firma si se pierde la clave de firma privada.</span><span class="sxs-lookup"><span data-stu-id="36b17-107">It is not necessary to archive keys intended only for signing because only the public key is needed to verify a signature if the private signing key is lost.</span></span>

<span data-ttu-id="36b17-108">Para archivar una clave, la CA debe estar configurada para emitir certificados del agente de recuperación de claves (KRA) y para que ya haya emitido al menos uno.</span><span class="sxs-lookup"><span data-stu-id="36b17-108">To archive a key, the CA must be configured to issue key recovery agent (KRA) certificates and to have already issued at least one.</span></span> <span data-ttu-id="36b17-109">Un agente de recuperación de claves es un administrador autorizado por una organización para descifrar las claves privadas.</span><span class="sxs-lookup"><span data-stu-id="36b17-109">A key recovery agent is an administrator authorized by an organization to decrypt private keys.</span></span> <span data-ttu-id="36b17-110">Para mejorar la seguridad, se recomienda que el agente de recuperación de claves y los roles de administrador de certificados se asignen a diferentes usuarios, que el administrador de certificados pueda recuperar pero no descifrar las claves archivadas y que el agente de recuperación de claves pueda descifrar las claves pero no recuperarlas.</span><span class="sxs-lookup"><span data-stu-id="36b17-110">To enhance security, we recommend that the key recovery agent and the certificate manager roles be assigned to different individuals, that the certificate manager be permitted to retrieve but not decrypt archived keys, and that the key recovery agent be permitted to decrypt keys but not retrieve them.</span></span>

## <a name="key-archival"></a><span data-ttu-id="36b17-111">Archivo de claves</span><span class="sxs-lookup"><span data-stu-id="36b17-111">Key Archival</span></span>

<span data-ttu-id="36b17-112">Un cliente normalmente solicita un certificado mediante una plantilla.</span><span class="sxs-lookup"><span data-stu-id="36b17-112">A client typically requests a certificate by using a template.</span></span> <span data-ttu-id="36b17-113">Si la plantilla requiere que se Archive la clave privada, el cliente y la CA realizan los siguientes pasos:</span><span class="sxs-lookup"><span data-stu-id="36b17-113">If the template requires that the private key be archived, the following steps are performed by the client and the CA:</span></span>

1.  <span data-ttu-id="36b17-114">El cliente recupera y valida el certificado de intercambio de la entidad de certificación para determinar si se ha firmado con la misma clave que se usó para firmar el certificado de firma de la entidad de certificación.</span><span class="sxs-lookup"><span data-stu-id="36b17-114">The client retrieves and validates the CA exchange certificate to determine whether it has been signed by the same key that was used to sign the CA signing certificate.</span></span> <span data-ttu-id="36b17-115">Esto garantiza que la única CA que puede descifrar la clave privada sea la CA desde la que se solicita un certificado.</span><span class="sxs-lookup"><span data-stu-id="36b17-115">This ensures that the only CA that can decrypt the private key is the CA from which a certificate is being requested.</span></span>
2.  <span data-ttu-id="36b17-116">La clave pública del certificado de intercambio de CA se usa para cifrar la clave privada asociada a la solicitud de certificado y la solicitud se envía a la CA.</span><span class="sxs-lookup"><span data-stu-id="36b17-116">The public key in the CA exchange certificate is used to encrypt the private key associated with the certificate request, and the request is sent to the CA.</span></span>
3.  <span data-ttu-id="36b17-117">La entidad de certificación usa la clave privada asociada con su certificado de Exchange para descifrar la clave privada enviada por el cliente y comprueba que las claves públicas y privadas de la solicitud estén relacionadas.</span><span class="sxs-lookup"><span data-stu-id="36b17-117">The CA uses the private key associated with its exchange certificate to decrypt the private key sent by the client and verifies that the public and private keys in the request are related.</span></span>
4.  <span data-ttu-id="36b17-118">La entidad de certificación cifra la clave privada mediante la clave pública del certificado de KRA.</span><span class="sxs-lookup"><span data-stu-id="36b17-118">The CA encrypts the private key by using the public key in the KRA certificate.</span></span> <span data-ttu-id="36b17-119">Si la CA ha emitido varios certificados de KRA, cifra la clave privada una vez con cada clave pública disponible para que cualquier agente de recuperación de claves autorizado pueda recuperar una clave.</span><span class="sxs-lookup"><span data-stu-id="36b17-119">If the CA has issued multiple KRA certificates, it encrypts the private key once with each available public key so that any authorized key recovery agent can recover a key.</span></span> <span data-ttu-id="36b17-120">Las claves privadas cifradas se almacenan en la base de datos de certificados.</span><span class="sxs-lookup"><span data-stu-id="36b17-120">The encrypted private keys are stored in the certificate database.</span></span>
5.  <span data-ttu-id="36b17-121">La entidad de certificación libera todas las referencias a la clave privada y libera de forma segura y pone a cero toda la memoria que contenía la clave.</span><span class="sxs-lookup"><span data-stu-id="36b17-121">The CA releases all references to the private key and securely frees and zeros all memory that contained the key.</span></span> <span data-ttu-id="36b17-122">Esto garantiza que la CA no tiene más acceso a la clave en formato de texto no cifrado.</span><span class="sxs-lookup"><span data-stu-id="36b17-122">This ensures that the CA has no further access to the key in clear text format.</span></span>

> [!Note]  
> <span data-ttu-id="36b17-123">Solo se puede usar una solicitud CMC para el archivo de claves.</span><span class="sxs-lookup"><span data-stu-id="36b17-123">Only a CMC request can be used for key archival.</span></span> <span data-ttu-id="36b17-124">Las solicitudes CMC se representan mediante la interfaz [**IX509CertificateRequestCmc**](/windows/desktop/api/CertEnroll/nn-certenroll-ix509certificaterequestcmc) .</span><span class="sxs-lookup"><span data-stu-id="36b17-124">CMC requests are represented by the [**IX509CertificateRequestCmc**](/windows/desktop/api/CertEnroll/nn-certenroll-ix509certificaterequestcmc) interface.</span></span>

 

## <a name="key-recovery"></a><span data-ttu-id="36b17-125">Recuperación de claves</span><span class="sxs-lookup"><span data-stu-id="36b17-125">Key Recovery</span></span>

<span data-ttu-id="36b17-126">La recuperación de claves no es compatible directamente con los servicios de Certificate Server de Active Directory o la API de inscripción de certificados.</span><span class="sxs-lookup"><span data-stu-id="36b17-126">Key recovery is not directly supported by Active Directory Certificate Services or the Certificate Enrollment API.</span></span> <span data-ttu-id="36b17-127">Sin embargo, Microsoft no proporciona las siguientes aplicaciones para ayudar con el proceso:</span><span class="sxs-lookup"><span data-stu-id="36b17-127">Microsoft does, however, provide the following applications to help with the process:</span></span>

-   <span data-ttu-id="36b17-128">Certutil.exe es un programa de línea de comandos que se puede usar para recuperar información de configuración de la entidad de certificación, comprobar certificados, pares de claves y cadenas de certificados, así como realizar copias de seguridad y restaurar claves.</span><span class="sxs-lookup"><span data-stu-id="36b17-128">Certutil.exe is a command line program that can be used to retrieve CA configuration information, verify certificates, key pairs, and certificate chains, and back up and restore keys.</span></span> <span data-ttu-id="36b17-129">Se incluye en sistemas operativos de servidor a partir de Windows Server 2003.</span><span class="sxs-lookup"><span data-stu-id="36b17-129">It is included in server operating systems beginning with Windows Server 2003.</span></span>
-   <span data-ttu-id="36b17-130">Krecover.exe es un programa basado en cuadros de diálogo que permite la recuperación de claves.</span><span class="sxs-lookup"><span data-stu-id="36b17-130">Krecover.exe is a dialog box–based program that enables key recovery.</span></span> <span data-ttu-id="36b17-131">Se incluye con el kit de recursos a partir de Windows Server 2003.</span><span class="sxs-lookup"><span data-stu-id="36b17-131">It is included with the Resource Kit beginning with Windows Server 2003.</span></span>

<span data-ttu-id="36b17-132">Los pasos siguientes se realizan para recuperar una clave privada:</span><span class="sxs-lookup"><span data-stu-id="36b17-132">The following steps are performed to recover a private key:</span></span>

1.  <span data-ttu-id="36b17-133">El administrador de certificados localiza los posibles candidatos para la recuperación de claves en la base de datos de certificados mediante el nombre del certificado, el solicitante o el usuario.</span><span class="sxs-lookup"><span data-stu-id="36b17-133">The certificate manager locates potential candidates for key recovery in the certificate database by using the name of the certificate, requester, or user.</span></span> <span data-ttu-id="36b17-134">Para este fin, se puede usar el comando **certutil** **-getKey** .</span><span class="sxs-lookup"><span data-stu-id="36b17-134">The **Certutil** **-getkey** command can be used for this purpose.</span></span>
2.  <span data-ttu-id="36b17-135">Una vez que el administrador de certificados tiene una lista de certificados, se llama de nuevo al comando **-getKey** con un número de serie de certificado específico o una impresión en miniatura para recuperar un \# archivo PKCS 7 que contiene el certificado de Kra, la cadena de certificados de usuario y la clave privada que se cifró durante el archivado mediante la clave pública de Kra.</span><span class="sxs-lookup"><span data-stu-id="36b17-135">Once the certificate manager has a list of certificates, the **-getkey** command is called again with a specific certificate serial number or thumb print to retrieve a PKCS \#7 file that contains the KRA certificate, user certificate chain, and the private key that was encrypted during archival by using the KRA public key.</span></span>
3.  <span data-ttu-id="36b17-136">El administrador de certificados pasa el control del proceso al agente de recuperación de claves cuya clave privada coincide con la clave pública incluida en el certificado de KRA.</span><span class="sxs-lookup"><span data-stu-id="36b17-136">The certificate manager passes control of the process to the key recovery agent whose private key matches the public key contained in the KRA certificate.</span></span>
4.  <span data-ttu-id="36b17-137">El agente de recuperación de claves descifra la clave privada archivada devuelta en el \# archivo PKCS 7 mediante la clave privada de Kra.</span><span class="sxs-lookup"><span data-stu-id="36b17-137">The key recovery agent decrypts the archived private key returned in the PKCS \#7 file by using the KRA private key.</span></span> <span data-ttu-id="36b17-138">Esto puede realizarse mediante el comando **certutil** **-recoverkey** , que coloca la clave en un archivo PKCS 12 protegido con contraseña \# .</span><span class="sxs-lookup"><span data-stu-id="36b17-138">This can be done by using the **Certutil** **-recoverkey** command which places the key in a password-protected PKCS \#12 file.</span></span> <span data-ttu-id="36b17-139">El cliente debe tener la contraseña a través de un mecanismo seguro fuera de banda.</span><span class="sxs-lookup"><span data-stu-id="36b17-139">The client must be given the password through a secure out-of-band mechanism.</span></span>
5.  <span data-ttu-id="36b17-140">El cliente importa el \# archivo PKCS 12 y usa la contraseña para recuperar la clave.</span><span class="sxs-lookup"><span data-stu-id="36b17-140">The client imports the PKCS \#12 file and uses the password to retrieve the key.</span></span>

## <a name="related-topics"></a><span data-ttu-id="36b17-141">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="36b17-141">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="36b17-142">Elementos PKI</span><span class="sxs-lookup"><span data-stu-id="36b17-142">PKI Elements</span></span>](about-pki-components.md)
</dt> </dl>

 

 



