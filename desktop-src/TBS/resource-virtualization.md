---
title: Virtualización de recursos
description: Virtualización de recursos
ms.assetid: ead0e99a-94da-4e80-bb68-d8f4b199173d
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f340b1a1bddfb3fd591452e028c80403b9c7e02f
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 09/16/2019
ms.locfileid: "103777353"
---
# <a name="resource-virtualization"></a><span data-ttu-id="f505b-103">Virtualización de recursos</span><span class="sxs-lookup"><span data-stu-id="f505b-103">Resource Virtualization</span></span>

<span data-ttu-id="f505b-104">La función principal de TBS es compartir eficazmente determinados recursos de TPM limitados: claves, autorización y sesiones de transporte.</span><span class="sxs-lookup"><span data-stu-id="f505b-104">The primary function of the TBS is to efficiently share certain limited TPM resources: keys, authorization, and transport sessions.</span></span>

<span data-ttu-id="f505b-105">Cuando se crea una instancia de uno de estos recursos, el TBS crea una instancia virtual del recurso y devuelve un identificador a esta instancia virtual en la secuencia de comandos de resultados (en lugar de la instancia de identificador real devuelta por el TPM).</span><span class="sxs-lookup"><span data-stu-id="f505b-105">When an instance of one of these resources is created, the TBS creates a virtual instance of the resource, and returns a handle to this virtual instance in the result command stream (rather than the actual handle instance returned by the TPM).</span></span> <span data-ttu-id="f505b-106">TBS mantiene una asignación entre el identificador virtual y el identificador real internamente.</span><span class="sxs-lookup"><span data-stu-id="f505b-106">The TBS maintains a mapping between the virtual handle and the actual handle internally.</span></span> <span data-ttu-id="f505b-107">Si el TPM se queda sin espacio para contener más recursos de un tipo determinado, las instancias existentes del recurso se guardan y se expulsan de manera selectiva hasta que el TPM pueda contener el nuevo recurso.</span><span class="sxs-lookup"><span data-stu-id="f505b-107">If the TPM runs out of space to hold more resources of a given type, existing instances of the resource are selectively saved and evicted until the TPM can hold the new resource.</span></span> <span data-ttu-id="f505b-108">Cuando los recursos antiguos vuelven a ser necesarios, el TBS carga los contextos guardados (guardando y expulsando otros recursos, si es necesario) antes de enviar el comando.</span><span class="sxs-lookup"><span data-stu-id="f505b-108">When the old resources are required again, the TBS loads the saved contexts (saving and evicting other resources if necessary) before submitting the command.</span></span>

<span data-ttu-id="f505b-109">Toda la virtualización en TBS se realiza en nombre de un contexto específico.</span><span class="sxs-lookup"><span data-stu-id="f505b-109">All virtualization in the TBS is performed on behalf of a specific context.</span></span> <span data-ttu-id="f505b-110">Cada contexto solo tiene permiso para acceder a los recursos virtuales creados específicamente en su nombre, así como a los recursos físicos en el TPM que corresponden a esos recursos virtuales.</span><span class="sxs-lookup"><span data-stu-id="f505b-110">Each context is only allowed to access virtual resources created specifically on its behalf, as well as the physical resources on the TPM that corresponds to those virtual resources.</span></span> <span data-ttu-id="f505b-111">De forma predeterminada, el número total de todos los recursos virtualizados está limitado a 500.</span><span class="sxs-lookup"><span data-stu-id="f505b-111">By default, the total number of all virtualized resources is limited to 500.</span></span> <span data-ttu-id="f505b-112">Este número puede modificarse mediante la creación o modificación de un valor del registro **DWORD** denominado **MaxResources** en **HKEY \_ local \_ Machine** \\ **software** \\ **Microsoft** \\ **TPM**.</span><span class="sxs-lookup"><span data-stu-id="f505b-112">This number can be altered by creating or modifying a **DWORD** registry value named **MaxResources** under **HKEY\_LOCAL\_MACHINE**\\**Software**\\**Microsoft**\\**Tpm**.</span></span> <span data-ttu-id="f505b-113">Se puede observar el uso de recursos de TBS en tiempo real mediante la herramienta Monitor de rendimiento para realizar el seguimiento del número de recursos de TBS.</span><span class="sxs-lookup"><span data-stu-id="f505b-113">Real-time TBS resource usage can be observed by using the Performance Monitor tool to track the number of TBS resources.</span></span> <span data-ttu-id="f505b-114">Esta restricción quedó obsoleta en Windows 8 y Windows Server 2012.</span><span class="sxs-lookup"><span data-stu-id="f505b-114">This restriction became obsolete with Windows 8 and Windows Server 2012.</span></span>

<span data-ttu-id="f505b-115">Los recursos de TPM limitados que no están virtualizados por TBS (como los contadores y el almacén NV) deben compartirse de forma cooperativa entre las pilas de software.</span><span class="sxs-lookup"><span data-stu-id="f505b-115">Limited TPM resources that are not virtualized by the TBS (such as counters and NV store) must be cooperatively shared among software stacks.</span></span>

> [!Note]  
> <span data-ttu-id="f505b-116">Este identificador de virtualización hace que se produzca un error en los comandos que incluyen identificadores de clave en el cálculo de parámetros de autorización HMAC.</span><span class="sxs-lookup"><span data-stu-id="f505b-116">This handle virtualization causes commands that include key handles in the calculation of HMAC authorization parameters to fail.</span></span> <span data-ttu-id="f505b-117">Como resultado, el software de la aplicación no puede usar muchos comandos en desuso en la versión 1,2 de TPM en el entorno de TBS.</span><span class="sxs-lookup"><span data-stu-id="f505b-117">As a result, many commands deprecated in TPM version 1.2 cannot be used by application software in the TBS environment.</span></span>

 

## <a name="resource-limits"></a><span data-ttu-id="f505b-118">Límites de recursos</span><span class="sxs-lookup"><span data-stu-id="f505b-118">Resource Limits</span></span>

<span data-ttu-id="f505b-119">El TPM permite a los autores de llamadas consultar sus funciones para determinar cuánto espacio hay disponible para determinados tipos de recursos.</span><span class="sxs-lookup"><span data-stu-id="f505b-119">The TPM enables callers to query its capabilities to determine how much space is available for certain types of resources.</span></span> <span data-ttu-id="f505b-120">Algunos de estos límites de recursos, como la cantidad de espacio disponible para las claves, las sesiones de autorización y las sesiones de transporte, se amplían eficazmente mediante TBS a través de virtualización.</span><span class="sxs-lookup"><span data-stu-id="f505b-120">Some of these resource limits, such as the amount of space available for keys, authorization sessions, and transport sessions, are effectively extended by the TBS through virtualization.</span></span> <span data-ttu-id="f505b-121">Las limitaciones de TBS, que están controladas por la configuración del registro **MaxResources** , suelen ser mucho mayores que las limitaciones reales del hardware TPM subyacente.</span><span class="sxs-lookup"><span data-stu-id="f505b-121">TBS limitations, which are controlled by the **MaxResources** registry setting, are usually far larger than the actual limitations of the underlying TPM hardware.</span></span> <span data-ttu-id="f505b-122">No se proporciona ningún mecanismo para consultar las limitaciones de TBS por separado de los límites de hardware de TPM.</span><span class="sxs-lookup"><span data-stu-id="f505b-122">No mechanism is supplied for querying TBS limitations separately from the TPM hardware limits.</span></span> <span data-ttu-id="f505b-123">Esta limitación de TBS quedó obsoleta en Windows 8 y Windows Server 2012.</span><span class="sxs-lookup"><span data-stu-id="f505b-123">This TBS limitation became obsolete with Windows 8 and Windows Server 2012.</span></span>

## <a name="keys"></a><span data-ttu-id="f505b-124">Claves</span><span class="sxs-lookup"><span data-stu-id="f505b-124">Keys</span></span>

<span data-ttu-id="f505b-125">TBS Virtualiza los identificadores de clave para que las claves se puedan descargar de forma transparente desde el TPM cuando no se usan y se vuelven a cargar en el TPM cuando se necesitan.</span><span class="sxs-lookup"><span data-stu-id="f505b-125">The TBS virtualizes key handles so that keys can be transparently unloaded from the TPM when they are not being used and loaded back onto the TPM when they are needed.</span></span> <span data-ttu-id="f505b-126">Cuando se crea una clave, TBS asocia un identificador virtual a la clave cargada.</span><span class="sxs-lookup"><span data-stu-id="f505b-126">When a key is created, the TBS associates a virtual handle with the loaded key.</span></span> <span data-ttu-id="f505b-127">Se utiliza el mismo identificador virtual para la duración del recurso.</span><span class="sxs-lookup"><span data-stu-id="f505b-127">The same virtual handle is used for the lifetime of the resource.</span></span> <span data-ttu-id="f505b-128">Los identificadores de clave virtual solo son válidos en el contexto que los creó y los recursos asociados no se conservan más allá de la vida del contexto.</span><span class="sxs-lookup"><span data-stu-id="f505b-128">Virtual key handles are only valid in the context that created them, and the associated resources are not preserved beyond the life of the context.</span></span>

-   <span data-ttu-id="f505b-129">Crear claves con LoadKey2 de TPM \_</span><span class="sxs-lookup"><span data-stu-id="f505b-129">Creating Keys with TPM\_LoadKey2</span></span>

    <span data-ttu-id="f505b-130">Si se crea una clave mediante el \_ comando LoadKey2 de TPM, TPM2 \_ CREATEPRIMARY, TPM2 \_ Load o TPM2 \_ LoadExternal, TBS reemplaza el identificador de la secuencia de bytes devuelta por un identificador de clave virtual de su elección.</span><span class="sxs-lookup"><span data-stu-id="f505b-130">If a key is created by using the TPM\_LoadKey2, TPM2\_CreatePrimary, TPM2\_Load, or TPM2\_LoadExternal command, the TBS replaces the handle in the return byte stream with a virtual key handle of its choosing.</span></span> <span data-ttu-id="f505b-131">Como resultado, el TBS garantiza que cada identificador virtual sea único.</span><span class="sxs-lookup"><span data-stu-id="f505b-131">As a result, the TBS ensures that each virtual handle is unique.</span></span> <span data-ttu-id="f505b-132">Si el TBS detecta una colisión (un evento extremadamente improbable), el TBS descarga la clave de TPM e informa al software que realiza la llamada.</span><span class="sxs-lookup"><span data-stu-id="f505b-132">If the TBS detects a collision (an extremely unlikely event), the TBS unloads the key from the TPM and informs the calling software.</span></span> <span data-ttu-id="f505b-133">Después, el software puede volver a enviar la operación.</span><span class="sxs-lookup"><span data-stu-id="f505b-133">The software can then resubmit the operation.</span></span> <span data-ttu-id="f505b-134">Este proceso puede repetirse hasta que el TBS obtenga un identificador de clave único.</span><span class="sxs-lookup"><span data-stu-id="f505b-134">This process can be repeated until the TBS gets a unique key handle.</span></span>

-   <span data-ttu-id="f505b-135">Borrar claves</span><span class="sxs-lookup"><span data-stu-id="f505b-135">Clearing Keys</span></span>

    <span data-ttu-id="f505b-136">TBS invalida el identificador de la clave virtual cuando recibe un \_ mensaje FlushSpecific de TPM o TPM2 \_ FlushContext para ese identificador virtual desde el contexto del cliente.</span><span class="sxs-lookup"><span data-stu-id="f505b-136">The TBS invalidates the virtual key handle when it receives a TPM\_FlushSpecific or TPM2\_FlushContext message for that virtual handle from the client context.</span></span> <span data-ttu-id="f505b-137">Si la clave está físicamente presente en el TPM cuando se recibe el mensaje de vaciado, el TBS vacía la clave del TPM en ese momento.</span><span class="sxs-lookup"><span data-stu-id="f505b-137">If the key is physically present on the TPM when the flush message is received, the TBS flushes the key from the TPM at that time.</span></span>

-   <span data-ttu-id="f505b-138">Quitar claves temporalmente</span><span class="sxs-lookup"><span data-stu-id="f505b-138">Temporarily Removing Keys</span></span>

    <span data-ttu-id="f505b-139">Al expulsar una clave de TPM para dejar espacio para un nuevo elemento, TBS ejecuta un \_ comando SaveContext de TPM o TPM2 \_ ContextSave en la clave antes de expulsarlo.</span><span class="sxs-lookup"><span data-stu-id="f505b-139">When evicting a key from the TPM to make room for a new item, the TBS executes a TPM\_SaveContext or TPM2\_ContextSave command on the key before evicting it.</span></span>

-   <span data-ttu-id="f505b-140">Restaurar claves</span><span class="sxs-lookup"><span data-stu-id="f505b-140">Restoring Keys</span></span>

    <span data-ttu-id="f505b-141">Cuando un comando que hace referencia a una clave cargada se envía a TBS, garantiza que la clave está físicamente presente en el TPM.</span><span class="sxs-lookup"><span data-stu-id="f505b-141">When a command that references a loaded key is submitted to the TBS, it ensures that the key is physically present on the TPM.</span></span> <span data-ttu-id="f505b-142">Si la clave no está presente, TBS la restaura con una llamada a LoadContext de TPM \_ o a TPM2 \_ ContextLoad.</span><span class="sxs-lookup"><span data-stu-id="f505b-142">If the key is not present, the TBS restores it with a call to TPM\_LoadContext or TPM2\_ContextLoad.</span></span> <span data-ttu-id="f505b-143">Si no se puede restaurar una clave en el TPM, el TBS devuelve \_ el \_ KEYHANDLE no válido de TPM \_ como resultado del TPM.</span><span class="sxs-lookup"><span data-stu-id="f505b-143">If a key cannot be restored to the TPM, the TBS returns TPM\_E\_INVALID\_KEYHANDLE as the TPM result.</span></span>

<span data-ttu-id="f505b-144">TBS reemplaza cada identificador virtual asociado a una clave en una secuencia de comandos con el identificador físico de la clave cargada en el TPM.</span><span class="sxs-lookup"><span data-stu-id="f505b-144">The TBS replaces each virtual handle associated with a key in a command stream with the physical handle of the key loaded on the TPM.</span></span> <span data-ttu-id="f505b-145">Si un comando se envía con un identificador virtual que no es reconocido por TBS en el contexto del autor de la llamada, TBS da formato a una secuencia de error para el autor de la llamada con el TPM \_ E \_ KEYHANDLE no válidos \_ .</span><span class="sxs-lookup"><span data-stu-id="f505b-145">If a command is submitted with a virtual handle that is not recognized by the TBS in the context of the caller, the TBS formats an error stream for the caller with TPM\_E\_INVALID\_KEYHANDLE.</span></span>

## <a name="authorization-sessions"></a><span data-ttu-id="f505b-146">Sesiones de autorización</span><span class="sxs-lookup"><span data-stu-id="f505b-146">Authorization Sessions</span></span>

<span data-ttu-id="f505b-147">Las sesiones de autorización se crean mediante una llamada a \_ OIAP de TPM, TPM \_ OSAP o TPM \_ DSAP.</span><span class="sxs-lookup"><span data-stu-id="f505b-147">Authorization sessions are created by calling TPM\_OIAP, TPM\_OSAP, or TPM\_DSAP.</span></span> <span data-ttu-id="f505b-148">En cada caso, la secuencia de bytes devuelta contiene el identificador de TPM físico de la sesión de autorización recién creada.</span><span class="sxs-lookup"><span data-stu-id="f505b-148">In each case, the return byte stream contains the physical TPM handle of the newly created authorization session.</span></span> <span data-ttu-id="f505b-149">TBS lo reemplaza por un identificador virtual.</span><span class="sxs-lookup"><span data-stu-id="f505b-149">The TBS replaces this with a virtual handle.</span></span> <span data-ttu-id="f505b-150">Cuando se hace referencia a la sesión de autorización posteriormente, el TBS reemplaza el identificador virtual en la secuencia de comandos con el identificador físico de la sesión de autorización.</span><span class="sxs-lookup"><span data-stu-id="f505b-150">When the authorization session is subsequently referenced, the TBS replaces the virtual handle in the command stream with the physical handle of the authorization session.</span></span> <span data-ttu-id="f505b-151">El TBS garantiza que la duración de la sesión de autorización virtual coincide con la de la sesión de autorización física.</span><span class="sxs-lookup"><span data-stu-id="f505b-151">The TBS ensures that the lifetime of the virtual authorization session matches that of the physical authorization session.</span></span> <span data-ttu-id="f505b-152">Si un cliente intenta usar un identificador virtual expirado, TBS da formato a una secuencia de error con el error TPM \_ INVALIDAUTHHANDLE.</span><span class="sxs-lookup"><span data-stu-id="f505b-152">If a client attempts to use an expired virtual handle, the TBS formats an error stream with error TPM\_INVALIDAUTHHANDLE.</span></span>

<span data-ttu-id="f505b-153">Las ranuras de sesión están limitadas y es posible que se agoten las ranuras externas en las que se guardan los contextos de la sesión de autorización.</span><span class="sxs-lookup"><span data-stu-id="f505b-153">Session slots are limited, and the TBS may run out of external slots in which to save authorization session contexts.</span></span> <span data-ttu-id="f505b-154">Si esto ocurre, el TBS elige una sesión de autorización para invalidar de modo que el nuevo contexto se pueda guardar correctamente.</span><span class="sxs-lookup"><span data-stu-id="f505b-154">If this happens, the TBS chooses an authorization session to invalidate so that the new context can be successfully saved.</span></span> <span data-ttu-id="f505b-155">Una aplicación que intente usar el contexto anterior tendrá que volver a crear la sesión de autorización.</span><span class="sxs-lookup"><span data-stu-id="f505b-155">An application that attempts to use the old context will need to re-create the authorization session.</span></span>

<span data-ttu-id="f505b-156">El TBS invalida la sesión de autorización virtual cuando se produce cualquiera de los siguientes casos:</span><span class="sxs-lookup"><span data-stu-id="f505b-156">The TBS invalidates the virtual authorization session when any of the following cases occur:</span></span>

-   <span data-ttu-id="f505b-157">La marca de uso continuado asociada a la sesión de autorización en la secuencia de comandos devuelta desde el TPM es **falsa**.</span><span class="sxs-lookup"><span data-stu-id="f505b-157">The continue-use flag associated with the authorization session in the returned command stream from the TPM is **FALSE**.</span></span>
-   <span data-ttu-id="f505b-158">Se produce un error en un comando que usa una sesión de autorización.</span><span class="sxs-lookup"><span data-stu-id="f505b-158">A command that uses an authorization session fails.</span></span>
-   <span data-ttu-id="f505b-159">Se ejecuta un comando que invalida la sesión de autorización asociada al comando (como CreateWrapKey de TPM \_ ).</span><span class="sxs-lookup"><span data-stu-id="f505b-159">A command is executed that invalidates the authorization session associated with the command (such as TPM\_CreateWrapKey).</span></span>
-   <span data-ttu-id="f505b-160">Una clave asociada a una sesión de OSAP o DSAP se expulsa del TPM con una llamada a TPM \_ FlushSpecific o TPM2 \_ FlushContext (sin tener en cuenta si este comando se originó con TBS o con software de nivel superior).</span><span class="sxs-lookup"><span data-stu-id="f505b-160">A key associated with an OSAP or DSAP session is evicted from the TPM with a call to TPM\_FlushSpecific or TPM2\_FlushContext (without regard to whether this command originated with the TBS or with higher-level software).</span></span>

    <span data-ttu-id="f505b-161">Los TBS volverán a sincronizar automáticamente las sesiones de autorización después de la ejecución correcta de determinados comandos no deterministas para asegurarse de que el estado de TBS sigue siendo coherente con el estado de TPM.</span><span class="sxs-lookup"><span data-stu-id="f505b-161">The TBS will automatically resynchronize the authorization sessions after successful execution of certain nondeterministic commands to ensure that the TBS state remains consistent with the TPM state.</span></span> <span data-ttu-id="f505b-162">Los comandos afectados son:</span><span class="sxs-lookup"><span data-stu-id="f505b-162">The affected commands are:</span></span>

    -   <span data-ttu-id="f505b-163">\_Administración de \_ delegado de Ord de TPM \_</span><span class="sxs-lookup"><span data-stu-id="f505b-163">TPM\_ORD\_Delegate\_Manage</span></span>
    -   <span data-ttu-id="f505b-164">\_ \_ CreateOwnerDelegation delegado de Ord de TPM \_</span><span class="sxs-lookup"><span data-stu-id="f505b-164">TPM\_ORD\_Delegate\_CreateOwnerDelegation</span></span>
    -   <span data-ttu-id="f505b-165">\_ \_ LoadOwnerDelegation delegado de Ord de TPM \_</span><span class="sxs-lookup"><span data-stu-id="f505b-165">TPM\_ORD\_Delegate\_LoadOwnerDelegation</span></span>

<span data-ttu-id="f505b-166">En cada uno de los casos siguientes, el TPM vacía automáticamente la sesión de autorización en el TPM:</span><span class="sxs-lookup"><span data-stu-id="f505b-166">In each of the following cases the authorization session on the TPM is flushed automatically by the TPM:</span></span>

-   <span data-ttu-id="f505b-167">Crear sesiones de autorización</span><span class="sxs-lookup"><span data-stu-id="f505b-167">Creating Authorization Sessions</span></span>

    <span data-ttu-id="f505b-168">Los identificadores de sesión de autorización virtual solo son válidos en el contexto que los creó y los recursos asociados no se conservan más allá de la duración del contexto asociado.</span><span class="sxs-lookup"><span data-stu-id="f505b-168">Virtual authorization session handles are only valid in the context that created them, and the associated resources are not preserved beyond the life of the associated context.</span></span>

-   <span data-ttu-id="f505b-169">Borrar sesiones de autorización</span><span class="sxs-lookup"><span data-stu-id="f505b-169">Clearing Authorization Sessions</span></span>

    <span data-ttu-id="f505b-170">El TBS invalida la sesión de autorización virtual si recibe un \_ comando FlushSpecific de TPM o TPM2 \_ FlushContext para el identificador virtual desde el contexto del cliente.</span><span class="sxs-lookup"><span data-stu-id="f505b-170">The TBS invalidates the virtual authorization session if it receives a TPM\_FlushSpecific or TPM2\_FlushContext command for the virtual handle from the client context.</span></span> <span data-ttu-id="f505b-171">Si la sesión de autorización está físicamente presente en el TPM cuando se recibe el comando de vaciado, el TBS vacía inmediatamente la sesión física desde el TPM.</span><span class="sxs-lookup"><span data-stu-id="f505b-171">If the authorization session is physically present on the TPM when the flush command is received, the TBS flushes the physical session from the TPM immediately.</span></span>

-   <span data-ttu-id="f505b-172">Quitar temporalmente sesiones de autorización</span><span class="sxs-lookup"><span data-stu-id="f505b-172">Temporarily Removing Authorization Sessions</span></span>

    <span data-ttu-id="f505b-173">Al expulsar una sesión de autorización del TPM para dejar espacio para una nueva entidad, TBS ejecuta SaveContext de TPM \_ o TPM2 \_ ContextSave en esa sesión de autorización.</span><span class="sxs-lookup"><span data-stu-id="f505b-173">When evicting an authorization session from the TPM to make room for a new entity, the TBS executes TPM\_SaveContext or TPM2\_ContextSave on that authorization session.</span></span>

-   <span data-ttu-id="f505b-174">Restaurar sesiones de autorización</span><span class="sxs-lookup"><span data-stu-id="f505b-174">Restoring Authorization Sessions</span></span>

    <span data-ttu-id="f505b-175">Cuando se envía un comando de TPM autorizado a TBS, el TBS garantiza que todas las sesiones de autorización virtual a las que se hace referencia en el comando estén físicamente presentes en el TPM.</span><span class="sxs-lookup"><span data-stu-id="f505b-175">When an authorized TPM command is submitted to the TBS, the TBS ensures that all virtual authorization sessions referred to in the command are physically present on the TPM.</span></span> <span data-ttu-id="f505b-176">Si alguna de las sesiones de autorización no está presente, TBS las restaura con una llamada a \_ LoadContext o TPM2 ContextLoad de TPM \_ .</span><span class="sxs-lookup"><span data-stu-id="f505b-176">If any of the authorization sessions are not present, the TBS restores them with a call to TPM\_LoadContext or TPM2\_ContextLoad.</span></span> <span data-ttu-id="f505b-177">Si no se puede restaurar una sesión de autorización en el TPM, el TBS devuelve un \_ \_ identificador no válido de TPM \_ como resultado de TPM.</span><span class="sxs-lookup"><span data-stu-id="f505b-177">If an authorization session cannot be restored to the TPM, the TBS returns TPM\_E\_INVALID\_HANDLE as the TPM result.</span></span>

<span data-ttu-id="f505b-178">TBS reemplaza cada identificador virtual asociado a una sesión de autorización en una secuencia de comandos con el identificador físico de la sesión de autorización cargada en el TPM.</span><span class="sxs-lookup"><span data-stu-id="f505b-178">The TBS replaces each virtual handle associated with an authorization session in a command stream with the physical handle of the authorization session loaded on the TPM.</span></span>

<span data-ttu-id="f505b-179">Si un comando se envía con un identificador virtual que no reconoce TBS en el contexto del autor de la llamada, TBS da formato a una secuencia de error para el autor de la llamada con el error TPM \_ E \_ identificador no válido \_ .</span><span class="sxs-lookup"><span data-stu-id="f505b-179">If a command is submitted with a virtual handle that is not recognized by the TBS in the context of the caller, the TBS formats an error stream for the caller with the error TPM\_E\_INVALID\_HANDLE.</span></span>

## <a name="transport-sessions"></a><span data-ttu-id="f505b-180">Sesiones de transporte</span><span class="sxs-lookup"><span data-stu-id="f505b-180">Transport Sessions</span></span>

> [!Note]  
> <span data-ttu-id="f505b-181">El control de las sesiones de transporte como se describe aquí es específico de Windows Vista y Windows Server 2008.</span><span class="sxs-lookup"><span data-stu-id="f505b-181">The handling of transport sessions as described here is specific to Windows Vista and Windows Server 2008.</span></span>

 

<span data-ttu-id="f505b-182">Las sesiones de transporte son un mecanismo proporcionado por el TPM que permite a una pila de software cifrar los datos en un comando a medida que pasa entre el software y el TPM.</span><span class="sxs-lookup"><span data-stu-id="f505b-182">Transport sessions are a mechanism provided by the TPM that enables a software stack to encrypt data in a command as it passes between the software and the TPM.</span></span> <span data-ttu-id="f505b-183">Esto evita que un adversario intercepte los datos a medida que pasan por el bus de hardware.</span><span class="sxs-lookup"><span data-stu-id="f505b-183">This prevents an adversary from intercepting the data as it passes over the hardware bus.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="f505b-184">Solo se cifran los datos de carga.</span><span class="sxs-lookup"><span data-stu-id="f505b-184">Only the payload data is encrypted.</span></span> <span data-ttu-id="f505b-185">Todavía se pueden identificar los comandos que se están ejecutando.</span><span class="sxs-lookup"><span data-stu-id="f505b-185">The commands being executed can still be identified.</span></span>

 

<span data-ttu-id="f505b-186">Desafortunadamente, este mecanismo también impide que el TB examine los datos de carga.</span><span class="sxs-lookup"><span data-stu-id="f505b-186">Unfortunately, this mechanism also prevents the TBS from examining payload data.</span></span> <span data-ttu-id="f505b-187">En la mayoría de los casos, esto no es un problema porque TBS solo modifica los identificadores, no los datos de carga.</span><span class="sxs-lookup"><span data-stu-id="f505b-187">In most cases this is not an issue because the TBS only modifies handles, not payload data.</span></span> <span data-ttu-id="f505b-188">Sin embargo, en el caso de \_ LoadContext de TPM por ejemplo, el identificador de recursos devuelto está incluido en el cifrado.</span><span class="sxs-lookup"><span data-stu-id="f505b-188">However, in the case of TPM\_LoadContext for instance, the returned resource handle is covered by the encryption.</span></span> <span data-ttu-id="f505b-189">Por lo tanto, el TBS impide que se intente realizar una operación LoadContext de TPM que esté \_ incluida en una sesión de transporte.</span><span class="sxs-lookup"><span data-stu-id="f505b-189">Therefore, the TBS prevents attempts to perform a TPM\_LoadContext operation covered by a transport session.</span></span>

<span data-ttu-id="f505b-190">TBS bloquea los siguientes comandos en la sesión de transporte:</span><span class="sxs-lookup"><span data-stu-id="f505b-190">The TBS blocks the following commands under transport session:</span></span>

-   <span data-ttu-id="f505b-191">EstablishTransport de TPM \_</span><span class="sxs-lookup"><span data-stu-id="f505b-191">TPM\_EstablishTransport</span></span>
-   <span data-ttu-id="f505b-192">ExecuteTransport de TPM \_</span><span class="sxs-lookup"><span data-stu-id="f505b-192">TPM\_ExecuteTransport</span></span>
-   <span data-ttu-id="f505b-193">\_Identificador de finalización de TPM \_</span><span class="sxs-lookup"><span data-stu-id="f505b-193">TPM\_Terminate\_Handle</span></span>
-   <span data-ttu-id="f505b-194">LoadKey de TPM \_</span><span class="sxs-lookup"><span data-stu-id="f505b-194">TPM\_LoadKey</span></span>
-   <span data-ttu-id="f505b-195">EvictKey de TPM \_</span><span class="sxs-lookup"><span data-stu-id="f505b-195">TPM\_EvictKey</span></span>
-   <span data-ttu-id="f505b-196">SaveKeyContext de TPM \_</span><span class="sxs-lookup"><span data-stu-id="f505b-196">TPM\_SaveKeyContext</span></span>
-   <span data-ttu-id="f505b-197">LoadKeyContext de TPM \_</span><span class="sxs-lookup"><span data-stu-id="f505b-197">TPM\_LoadKeyContext</span></span>
-   <span data-ttu-id="f505b-198">SaveAuthContext de TPM \_</span><span class="sxs-lookup"><span data-stu-id="f505b-198">TPM\_SaveAuthContext</span></span>
-   <span data-ttu-id="f505b-199">LoadAuthContext de TPM \_</span><span class="sxs-lookup"><span data-stu-id="f505b-199">TPM\_LoadAuthContext</span></span>
-   <span data-ttu-id="f505b-200">SaveContext de TPM \_</span><span class="sxs-lookup"><span data-stu-id="f505b-200">TPM\_SaveContext</span></span>
-   <span data-ttu-id="f505b-201">LoadContext de TPM \_</span><span class="sxs-lookup"><span data-stu-id="f505b-201">TPM\_LoadContext</span></span>
-   <span data-ttu-id="f505b-202">FlushSpecific de TPM \_</span><span class="sxs-lookup"><span data-stu-id="f505b-202">TPM\_FlushSpecific</span></span>

<span data-ttu-id="f505b-203">Cuando uno de estos comandos está incluido en una sesión de transporte, el TBS devuelve el \_ \_ comando incrustado de TPM E incrustado \_ \_ como resultado de TPM.</span><span class="sxs-lookup"><span data-stu-id="f505b-203">When any one of these commands is covered by a transport session, the TBS returns TPM\_E\_EMBEDDED\_COMMAND\_UNSUPPORTED as the TPM result.</span></span>

<span data-ttu-id="f505b-204">Los identificadores de sesión de transporte se virtualizan de una manera similar a los identificadores de clave y de autorización.</span><span class="sxs-lookup"><span data-stu-id="f505b-204">Transport session handles are virtualized in a manner similar to key handles and authorization handles.</span></span> <span data-ttu-id="f505b-205">Hay un número limitado de ranuras de contexto de la sesión de transporte guardadas disponibles en el TPM.</span><span class="sxs-lookup"><span data-stu-id="f505b-205">There are a limited number of saved transport session context slots available on the TPM.</span></span>

<span data-ttu-id="f505b-206">El TBS invalida la sesión de transporte virtual si se produce alguno de los siguientes casos:</span><span class="sxs-lookup"><span data-stu-id="f505b-206">The TBS invalidates the virtual transport session if any of the following cases occurs:</span></span>

-   <span data-ttu-id="f505b-207">La marca de uso continuado asociada a la sesión de transporte en la secuencia de comandos devuelta del TPM es **falsa**.</span><span class="sxs-lookup"><span data-stu-id="f505b-207">The continue-use flag associated with the transport session in the return command stream from the TPM is **FALSE**.</span></span>

    <span data-ttu-id="f505b-208">Al igual que con las sesiones de autorización anteriores, TBS volverá a sincronizar automáticamente las sesiones de transporte después de la ejecución correcta de determinados comandos no deterministas para asegurarse de que el estado de TBS sigue siendo coherente con el estado de TPM.</span><span class="sxs-lookup"><span data-stu-id="f505b-208">As with authorization sessions above, the TBS will automatically resynchronize transport sessions after successful execution of certain nondeterministic commands to ensure that the TBS state remains consistent with the TPM state.</span></span> <span data-ttu-id="f505b-209">Los comandos afectados son:</span><span class="sxs-lookup"><span data-stu-id="f505b-209">The affected commands are:</span></span>

    -   <span data-ttu-id="f505b-210">\_Administración de \_ delegado de Ord de TPM \_</span><span class="sxs-lookup"><span data-stu-id="f505b-210">TPM\_ORD\_Delegate\_Manage</span></span>
    -   <span data-ttu-id="f505b-211">\_ \_ CreateOwnerDelegation delegado de Ord de TPM \_</span><span class="sxs-lookup"><span data-stu-id="f505b-211">TPM\_ORD\_Delegate\_CreateOwnerDelegation</span></span>
    -   <span data-ttu-id="f505b-212">\_ \_ LoadOwnerDelegation delegado de Ord de TPM \_</span><span class="sxs-lookup"><span data-stu-id="f505b-212">TPM\_ORD\_Delegate\_LoadOwnerDelegation</span></span>

<span data-ttu-id="f505b-213">En cada uno de estos casos, el TPM vaciará automáticamente la sesión de transporte en el TPM:</span><span class="sxs-lookup"><span data-stu-id="f505b-213">In each of these cases, the transport session on the TPM will be flushed automatically by the TPM:</span></span>

-   <span data-ttu-id="f505b-214">Crear sesiones de transporte</span><span class="sxs-lookup"><span data-stu-id="f505b-214">Creating Transport Sessions</span></span>

    <span data-ttu-id="f505b-215">El TBS crea un identificador virtual para cada sesión de transporte creada por un cliente.</span><span class="sxs-lookup"><span data-stu-id="f505b-215">The TBS creates a virtual handle for each transport session created by a client.</span></span> <span data-ttu-id="f505b-216">Los identificadores de transporte virtual solo son válidos en el contexto que los creó y los recursos asociados no se conservan más allá de la duración del contexto asociado.</span><span class="sxs-lookup"><span data-stu-id="f505b-216">Virtual transport handles are only valid in the context that created them, and the associated resources are not preserved beyond the life of the associated context.</span></span>

-   <span data-ttu-id="f505b-217">Borrar sesiones de transporte</span><span class="sxs-lookup"><span data-stu-id="f505b-217">Clearing Transport Sessions</span></span>

    <span data-ttu-id="f505b-218">El TBS invalida la sesión de transporte virtual si recibe un \_ comando FlushSpecific de TPM para el identificador virtual desde el contexto del cliente.</span><span class="sxs-lookup"><span data-stu-id="f505b-218">The TBS invalidates the virtual transport session if it receives a TPM\_FlushSpecific command for the virtual handle from the client context.</span></span> <span data-ttu-id="f505b-219">Si la sesión de transporte está físicamente presente en el TPM cuando se recibe el comando de vaciado, el TBS vacía inmediatamente la sesión física desde el TPM.</span><span class="sxs-lookup"><span data-stu-id="f505b-219">If the transport session is physically present on the TPM when the flush command is received, the TBS flushes the physical session from the TPM immediately.</span></span>

-   <span data-ttu-id="f505b-220">Quitar temporalmente las sesiones de transporte</span><span class="sxs-lookup"><span data-stu-id="f505b-220">Temporarily Removing Transport Sessions</span></span>

    <span data-ttu-id="f505b-221">Al expulsar una sesión de transporte del TPM para dejar espacio para una nueva entidad, TBS ejecuta \_ SaveContext de TPM en esa sesión de transporte.</span><span class="sxs-lookup"><span data-stu-id="f505b-221">When evicting a transport session from the TPM to make room for a new entity, the TBS executes TPM\_SaveContext on that transport session.</span></span>

-   <span data-ttu-id="f505b-222">Restaurar sesiones de transporte</span><span class="sxs-lookup"><span data-stu-id="f505b-222">Restoring Transport Sessions</span></span>

    <span data-ttu-id="f505b-223">Cuando \_ se envía un comando ExecuteTransport de TPM a TBS, el TBS garantiza que la sesión de transporte a la que se hace referencia en el comando esté físicamente presente en el TPM.</span><span class="sxs-lookup"><span data-stu-id="f505b-223">When a TPM\_ExecuteTransport command is submitted to the TBS, the TBS ensures that the transport session referred to in the command is physically present on the TPM.</span></span> <span data-ttu-id="f505b-224">Si la sesión de transporte no está presente, TBS la restaura con una llamada a LoadContext de TPM \_ .</span><span class="sxs-lookup"><span data-stu-id="f505b-224">If the transport session is not present, the TBS restores it with a call to TPM\_LoadContext.</span></span>

<span data-ttu-id="f505b-225">TBS reemplaza el identificador virtual asociado a la sesión de transporte en una secuencia de comandos con el identificador físico de la sesión de transporte cargada en el TPM.</span><span class="sxs-lookup"><span data-stu-id="f505b-225">The TBS replaces the virtual handle associated with the transport session in a command stream with the physical handle of the transport session loaded on the TPM.</span></span> <span data-ttu-id="f505b-226">Si un comando se envía con un identificador virtual que no reconoce TBS en el contexto del autor de la llamada, TBS da formato a una secuencia de error para el autor de la llamada mediante el uso de un \_ \_ identificador no válido de TPM E \_ .</span><span class="sxs-lookup"><span data-stu-id="f505b-226">If a command is submitted with a virtual handle that is not recognized by the TBS in the context of the caller, the TBS formats an error stream for the caller by using TPM\_E\_INVALID\_HANDLE.</span></span>

## <a name="exclusive-transport-sessions"></a><span data-ttu-id="f505b-227">Sesiones de transporte exclusivas</span><span class="sxs-lookup"><span data-stu-id="f505b-227">Exclusive Transport Sessions</span></span>

<span data-ttu-id="f505b-228">Las sesiones de transporte ajustadas exclusivas son una manera de que el software de nivel superior determine si cualquier otro software ha tenido acceso al TPM durante una cadena de comandos.</span><span class="sxs-lookup"><span data-stu-id="f505b-228">Exclusive wrapped transport sessions are a way for top-level software to determine whether any other software has accessed the TPM during a chain of commands.</span></span> <span data-ttu-id="f505b-229">No impiden que otro software tenga acceso al TPM, simplemente proporcionan al creador de la sesión de transporte un medio para determinar que se ha producido algún otro acceso.</span><span class="sxs-lookup"><span data-stu-id="f505b-229">They do not prevent other software from accessing the TPM, they just give the creator of the transport session a means of determining that some other access occurred.</span></span> <span data-ttu-id="f505b-230">TBS no hace nada específico para entorpecer las sesiones de transporte exclusivas, pero es algo incompatible con ellos.</span><span class="sxs-lookup"><span data-stu-id="f505b-230">The TBS does not do anything specific to hinder exclusive transport sessions, but it is somewhat incompatible with them.</span></span> <span data-ttu-id="f505b-231">TBS intenta duplicar el comportamiento natural del TPM por ser transparente, por lo que no favorece los comandos de los contextos que establecen una sesión de transporte exclusiva.</span><span class="sxs-lookup"><span data-stu-id="f505b-231">The TBS attempts to duplicate the natural behavior of the TPM by being transparent, so it does not favor commands from contexts that establish an exclusive transport session.</span></span> <span data-ttu-id="f505b-232">Por ejemplo, si el cliente B envía un comando cuando el cliente A está en una sesión de transporte exclusiva, se invalidará la sesión de transporte exclusiva del cliente A.</span><span class="sxs-lookup"><span data-stu-id="f505b-232">For example, if client B submits a command when client A is in an exclusive transport session, then it will invalidate the exclusive transport session of client A.</span></span>

<span data-ttu-id="f505b-233">Los comandos iniciados por TBS también pueden finalizar la sesión de transporte exclusiva.</span><span class="sxs-lookup"><span data-stu-id="f505b-233">Commands initiated by TBS can also terminate the exclusive transport session.</span></span> <span data-ttu-id="f505b-234">Esto sucede cuando el cliente A está en una sesión de transporte exclusiva y un comando ejecutado por el cliente A llama a un recurso que no está presente físicamente en el TPM.</span><span class="sxs-lookup"><span data-stu-id="f505b-234">This happens when client A is in an exclusive transport session, and a command executed by client A calls for a resource that is not physically present in the TPM.</span></span> <span data-ttu-id="f505b-235">Esta situación desencadena que el administrador de virtualización de TBS ejecute un \_ comando LoadContext de TPM para proporcionar ese recurso, que finaliza la sesión de transporte exclusiva del cliente a.</span><span class="sxs-lookup"><span data-stu-id="f505b-235">This situation triggers the TBS virtualization manager to execute a TPM\_LoadContext command to supply that resource, which terminates the exclusive transport session of client A.</span></span>

 

 




