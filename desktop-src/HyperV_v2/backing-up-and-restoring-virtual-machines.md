---
description: Hyper-V usa el Servicio de instantáneas de volumen (VSS) para realizar copias de seguridad y restaurar máquinas virtuales.
ms.assetid: 94C67F22-658D-49DD-9588-6BB4FCF7ADA9
title: Copia de seguridad y restauración de máquinas virtuales
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 6f9cf6d5b80a4c7392fb38e893a4fafad3f90435
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/07/2021
ms.locfileid: "105687528"
---
# <a name="backing-up-and-restoring-virtual-machines"></a><span data-ttu-id="30a21-103">Copia de seguridad y restauración de máquinas virtuales</span><span class="sxs-lookup"><span data-stu-id="30a21-103">Backing up and restoring virtual machines</span></span>

<span data-ttu-id="30a21-104">Hyper-V usa el Servicio de instantáneas de volumen (VSS) para realizar copias de seguridad y restaurar máquinas virtuales.</span><span class="sxs-lookup"><span data-stu-id="30a21-104">Hyper-V uses the Volume Shadow Copy Service (VSS) to backup and restore virtual machines.</span></span> <span data-ttu-id="30a21-105">Si los servicios de integración de copia de seguridad (instantánea de volumen) están instalados en el sistema operativo invitado, se instala un solicitante de VSS que permitirá a los escritores de VSS en el sistema operativo invitado participar en la copia de seguridad de la máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="30a21-105">If the backup (volume snapshot) integration services are installed in the guest operating system, a VSS requester is installed that will allow VSS writers in the guest operating system to participate in the backup of the virtual machine.</span></span> <span data-ttu-id="30a21-106">Para obtener más información, consulte las siguientes secciones:</span><span class="sxs-lookup"><span data-stu-id="30a21-106">For details, see the following sections:</span></span>

-   [<span data-ttu-id="30a21-107">Copia de seguridad de las máquinas virtuales</span><span class="sxs-lookup"><span data-stu-id="30a21-107">Backing up the virtual machines</span></span>](#backing-up-the-virtual-machines)
-   [<span data-ttu-id="30a21-108">Restauración de las máquinas virtuales</span><span class="sxs-lookup"><span data-stu-id="30a21-108">Restoring the virtual machines</span></span>](#restoring-the-virtual-machines)
-   [<span data-ttu-id="30a21-109">Clústeres de conmutación por error y Hyper-V VSS</span><span class="sxs-lookup"><span data-stu-id="30a21-109">Failover clustering and Hyper-V VSS</span></span>](#failover-clustering-and-hyper-v-vss)
-   [<span data-ttu-id="30a21-110">Detalles sobre VSS Writer de Hyper-V</span><span class="sxs-lookup"><span data-stu-id="30a21-110">Details on the Hyper-V VSS Writer</span></span>](#details-on-the-hyper-v-vss-writer)
-   [<span data-ttu-id="30a21-111">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="30a21-111">Related topics</span></span>](#related-topics)

## <a name="backing-up-the-virtual-machines"></a><span data-ttu-id="30a21-112">Copia de seguridad de las máquinas virtuales</span><span class="sxs-lookup"><span data-stu-id="30a21-112">Backing up the virtual machines</span></span>

<span data-ttu-id="30a21-113">Hyper-V usa uno de los dos mecanismos para realizar una copia de seguridad de cada máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="30a21-113">Hyper-V uses one of two mechanisms to back up each virtual machine.</span></span> <span data-ttu-id="30a21-114">El mecanismo de copia de seguridad predeterminado se denomina método "estado guardado", en el que la máquina virtual se coloca en un estado guardado durante el procesamiento del evento PrepareForSnapshot, se toman las instantáneas de los volúmenes adecuados y la máquina virtual se vuelve al estado anterior durante el procesamiento del evento de instantáneas.</span><span class="sxs-lookup"><span data-stu-id="30a21-114">The default backup mechanism is called the "Saved State" method, where the virtual machine is put into a saved state during the processing of the PrepareForSnapshot event, snapshots are taken of the appropriate volumes, and the virtual machine is returned to the previous state during the processing of the PostSnapshot event.</span></span>

<span data-ttu-id="30a21-115">El otro mecanismo de copia de seguridad se denomina método "instantánea de máquina virtual secundaria", que usa VSS dentro de la máquina virtual secundaria para participar en la copia de seguridad.</span><span class="sxs-lookup"><span data-stu-id="30a21-115">The other backup mechanism is called the "Child VM Snapshot" method, which uses VSS inside the child virtual machine to participate in the backup.</span></span> <span data-ttu-id="30a21-116">Para que se admita el método "instantánea de máquina virtual secundaria", deben cumplirse todas las condiciones siguientes:</span><span class="sxs-lookup"><span data-stu-id="30a21-116">For the "Child VM Snapshot" method to be supported, all of the following conditions must be met:</span></span>

-   <span data-ttu-id="30a21-117">El servicio de integración de copia de seguridad (instantánea de volumen) está instalado y ejecutándose en la máquina virtual secundaria.</span><span class="sxs-lookup"><span data-stu-id="30a21-117">Backup (volume snapshot) Integration Service is installed and running in the child virtual machine.</span></span> <span data-ttu-id="30a21-118">El nombre del servicio es "solicitante de instantáneas de volumen de Hyper-V".</span><span class="sxs-lookup"><span data-stu-id="30a21-118">The service name is "Hyper-V Volume Shadow Copy Requestor".</span></span>
-   <span data-ttu-id="30a21-119">La máquina virtual secundaria debe estar en el estado en ejecución.</span><span class="sxs-lookup"><span data-stu-id="30a21-119">The child virtual machine must be in the running state.</span></span>
-   <span data-ttu-id="30a21-120">La ubicación del archivo de instantáneas de la máquina virtual está configurada para que sea el mismo volumen en el sistema operativo host que los archivos VHD de la máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="30a21-120">The Snapshot File Location for the virtual machine is set to be the same volume in the host operating system as the VHD files for the virtual machine.</span></span>
-   <span data-ttu-id="30a21-121">Todos los volúmenes de la máquina virtual secundaria son discos básicos y no hay ningún disco dinámico.</span><span class="sxs-lookup"><span data-stu-id="30a21-121">All volumes on the child virtual machine are basic disks and there are no dynamic disks.</span></span>
-   <span data-ttu-id="30a21-122">Todos los discos de la máquina virtual secundaria deben usar un sistema de archivos que admita instantáneas (por ejemplo, NTFS).</span><span class="sxs-lookup"><span data-stu-id="30a21-122">All disks on the child virtual machine must use a file system that supports snapshots (for example, NTFS).</span></span>

<span data-ttu-id="30a21-123">En general, el proceso de copia de seguridad de máquinas virtuales es el mismo que se describe en [información general sobre el procesamiento de una copia de seguridad en VSS](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss).</span><span class="sxs-lookup"><span data-stu-id="30a21-123">In general, the process for backing up virtual machines is the same as described in [Overview of Processing a Backup Under VSS](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss).</span></span> <span data-ttu-id="30a21-124">El comportamiento único se produce cuando el VSS Writer de Hyper-V (parte del servicio de administración de máquinas virtuales de Hyper-V) procesa el evento PrepareForSnapshot.</span><span class="sxs-lookup"><span data-stu-id="30a21-124">The unique behavior happens when the Hyper-V VSS writer (part of the "Hyper-V Virtual Machine Management" service) processes the PrepareForSnapshot event.</span></span> <span data-ttu-id="30a21-125">Si la copia de seguridad se realizó con el método "instantánea de máquina virtual secundaria", se realiza un procesamiento adicional pero no es visible para la máquina virtual secundaria.</span><span class="sxs-lookup"><span data-stu-id="30a21-125">If the backup was done using the "Child VM Snapshot" method, there is additional processing done but it is not visible to the child virtual machine.</span></span>

<span data-ttu-id="30a21-126">En el procedimiento siguiente se describe cómo realizar copias de seguridad de máquinas virtuales.</span><span class="sxs-lookup"><span data-stu-id="30a21-126">The following procedure describes how to back up virtual machines.</span></span>

<span data-ttu-id="30a21-127">**Para realizar copias de seguridad de máquinas virtuales**</span><span class="sxs-lookup"><span data-stu-id="30a21-127">**To back up virtual machines**</span></span>

1.  <span data-ttu-id="30a21-128">Para cada máquina virtual en los metadatos del sistema de escritura, si se usa el método "estado guardado", la máquina virtual se coloca en un estado guardado.</span><span class="sxs-lookup"><span data-stu-id="30a21-128">For each virtual machine in the writer metadata, if the "Saved State" method is used, the virtual machine is put into a saved state.</span></span> <span data-ttu-id="30a21-129">En el caso de las máquinas virtuales que usan el método "instantánea de VM secundaria", el servicio solicitante de instantáneas de volumen de Hyper-V de la máquina virtual secundaria procesa la copia de seguridad como se detalla en [información general sobre el procesamiento de una copia de seguridad en VSS](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss).</span><span class="sxs-lookup"><span data-stu-id="30a21-129">For virtual machines using the "Child VM Snapshot" method, the Hyper-V Volume Shadow Copy Requestor Service in the child virtual machine processes the backup as detailed in [Overview of Processing a Backup Under VSS](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss).</span></span> <span data-ttu-id="30a21-130">Todos los eventos de VSS en la máquina virtual secundaria se producen durante el procesamiento del sistema operativo host del evento PrepareForSnapshot.</span><span class="sxs-lookup"><span data-stu-id="30a21-130">All VSS events on the child virtual machine occur during the host operating system processing of the PrepareForSnapshot event.</span></span>
2.  <span data-ttu-id="30a21-131">Después de que todas las máquinas virtuales se hayan puesto en el estado guardado o se hayan tomado instantáneas, el VSS Writer de Hyper-V vuelve del evento PrepareForSnapshot.</span><span class="sxs-lookup"><span data-stu-id="30a21-131">After all virtual machines have either been put in the saved state or had snapshots taken, the Hyper-V VSS writer returns from the PrepareForSnapshot event.</span></span> <span data-ttu-id="30a21-132">La VSS Writer de Hyper-V no realiza ningún procesamiento durante los eventos Freeze y reanudación.</span><span class="sxs-lookup"><span data-stu-id="30a21-132">No processing is done by the Hyper-V VSS writer during the Freeze and Thaw events.</span></span>
3.  <span data-ttu-id="30a21-133">Cuando el VSS Writer de Hyper-V procesa el evento de instantáneas, las máquinas virtuales de las que se realizó una copia de seguridad mediante el método "estado guardado" y que se pusieron en estado guardado por el VSS Writer de Hyper-V se devuelven al estado en que se encontraban antes de que se iniciara la copia de seguridad.</span><span class="sxs-lookup"><span data-stu-id="30a21-133">When the Hyper-V VSS writer processes the PostSnapshot event, virtual machines that were backed up using the "Saved State" method and were put into a saved state by the Hyper-V VSS writer are returned to the state they were in before the backup started.</span></span> <span data-ttu-id="30a21-134">En el caso de las máquinas virtuales de las que se realizó una copia de seguridad mediante el método "instantánea de máquina virtual secundaria", la imagen de host de los archivos VHD que tenían las instantáneas tomadas se revierte a la instantánea tomada durante el procesamiento del evento PrepareForSnapshot.</span><span class="sxs-lookup"><span data-stu-id="30a21-134">For the virtual machines that were backed up using the "Child VM Snapshot" method, the host image of the VHD files that had the snapshots taken are rolled back to the snapshot taken during the processing of the PrepareForSnapshot event.</span></span> <span data-ttu-id="30a21-135">Este procesamiento se realiza de forma independiente de los escritores de VSS en las máquinas virtuales secundarias, por lo que las instantáneas tomadas deben ser recuperables automáticamente.</span><span class="sxs-lookup"><span data-stu-id="30a21-135">This processing is done independently of the VSS writers on the child virtual machines so the snapshots taken must be auto-recoverable.</span></span> <span data-ttu-id="30a21-136">(**VSS \_ VOLSNAP \_ ATTR \_ \_** no se ha establecido la Autorrecuperación en el contexto).</span><span class="sxs-lookup"><span data-stu-id="30a21-136">(**VSS\_VOLSNAP\_ATTR\_NO\_AUTORECOVERY** is not set in the context.)</span></span>

<span data-ttu-id="30a21-137">No se admiten copias de seguridad parciales.</span><span class="sxs-lookup"><span data-stu-id="30a21-137">Partial backups are not supported.</span></span> <span data-ttu-id="30a21-138">Si se produce un error en una máquina virtual para crear una instantánea, no se hará ninguna copia de seguridad de las máquinas virtuales.</span><span class="sxs-lookup"><span data-stu-id="30a21-138">If any virtual machine fails to create a snapshot, no virtual machines will be backed up.</span></span>

> [!Note]  
> <span data-ttu-id="30a21-139">Los discos de paso a través e iSCSI no son visibles para el sistema operativo host y, por lo tanto, no se realiza una copia de seguridad del VSS Writer de Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="30a21-139">Pass-through and iSCSI disks are not visible to the host operating system and therefore not backed up by the Hyper-V VSS writer.</span></span> <span data-ttu-id="30a21-140">Las copias de seguridad de estos volúmenes deben realizarse en su totalidad en la máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="30a21-140">Backups of these volumes must be done entirely on the virtual machine.</span></span>

 

## <a name="restoring-the-virtual-machines"></a><span data-ttu-id="30a21-141">Restauración de las máquinas virtuales</span><span class="sxs-lookup"><span data-stu-id="30a21-141">Restoring the virtual machines</span></span>

<span data-ttu-id="30a21-142">La restauración de las máquinas virtuales se realiza por completo en el sistema operativo host; los escritores de VSS en las máquinas virtuales secundarias no están implicados.</span><span class="sxs-lookup"><span data-stu-id="30a21-142">Restoring the virtual machines is done entirely by the host operating system; the VSS writers on the child virtual machines are not involved.</span></span>

<span data-ttu-id="30a21-143">En el procedimiento siguiente se describe cómo restaurar máquinas virtuales.</span><span class="sxs-lookup"><span data-stu-id="30a21-143">The following procedure describes how to restore virtual machines.</span></span>

<span data-ttu-id="30a21-144">**Para restaurar máquinas virtuales**</span><span class="sxs-lookup"><span data-stu-id="30a21-144">**To restore virtual machines**</span></span>

1.  <span data-ttu-id="30a21-145">Durante el procesamiento del evento de prerestauración, el VSS Writer de Hyper-V se apaga y elimina todas las máquinas virtuales que se van a restaurar.</span><span class="sxs-lookup"><span data-stu-id="30a21-145">During the processing of the PreRestore event, the Hyper-V VSS writer turns off and deletes any virtual machines that are about to be restored.</span></span>
2.  <span data-ttu-id="30a21-146">Después de que todos los escritores de VSS hayan procesado el evento prerestore, se restauran los archivos.</span><span class="sxs-lookup"><span data-stu-id="30a21-146">After all VSS writers have processed the PreRestore event, the files are restored.</span></span>
3.  <span data-ttu-id="30a21-147">Durante el procesamiento del evento postrestore, el VSS Writer de Hyper-V llama al método [**IVssComponent:: GetFileRestoreStatus**](/windows/desktop/api/vswriter/nf-vswriter-ivsscomponent-getfilerestorestatus) .</span><span class="sxs-lookup"><span data-stu-id="30a21-147">During the processing of the PostRestore event, the Hyper-V VSS writer calls the [**IVssComponent::GetFileRestoreStatus**](/windows/desktop/api/vswriter/nf-vswriter-ivsscomponent-getfilerestorestatus) method.</span></span> <span data-ttu-id="30a21-148">Si el valor devuelto no es **VSS \_ RS \_ ALL**, el VSS Writer de Hyper-V llama al método [**SetWriterFailure**](/windows/desktop/api/vswriter/nf-vswriter-cvsswriter-setwriterfailure) y devuelve **false** desde el método [**OnPostRestore**](/windows/desktop/api/vswriter/nf-vswriter-cvsswriter-onpostrestore) .</span><span class="sxs-lookup"><span data-stu-id="30a21-148">If the return is not **VSS\_RS\_ALL**, then the Hyper-V VSS writer calls the [**SetWriterFailure**](/windows/desktop/api/vswriter/nf-vswriter-cvsswriter-setwriterfailure) method and returns **False** from the [**OnPostRestore**](/windows/desktop/api/vswriter/nf-vswriter-cvsswriter-onpostrestore) method.</span></span>
4.  <span data-ttu-id="30a21-149">Para cada máquina virtual restaurada, la VSS Writer de Hyper-V registra la máquina virtual con el servicio de administración de Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="30a21-149">For each virtual machine that was restored, the Hyper-V VSS writer registers the virtual machine with the Hyper-V management service.</span></span> <span data-ttu-id="30a21-150">Si la máquina virtual se restaura en una ubicación no predeterminada, se crea un vínculo simbólico en la ubicación predeterminada que se vincula a esa ubicación.</span><span class="sxs-lookup"><span data-stu-id="30a21-150">If the virtual machine is restored to a nondefault location, a symbolic link is created in the default location linking to that location.</span></span>
5.  <span data-ttu-id="30a21-151">Para cada VHD que se restauró, la ubicación se compara con la especificada para esa máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="30a21-151">For each VHD that was restored, the location is compared with the one specified for that virtual machine.</span></span> <span data-ttu-id="30a21-152">Si la ubicación es diferente, la configuración se actualiza con la ubicación adecuada.</span><span class="sxs-lookup"><span data-stu-id="30a21-152">If the location is different, then the configuration is updated with the proper location.</span></span>
6.  <span data-ttu-id="30a21-153">Se actualiza la configuración de red.</span><span class="sxs-lookup"><span data-stu-id="30a21-153">The network configuration is updated.</span></span> <span data-ttu-id="30a21-154">Si los conmutadores virtuales a los que estaba conectada la máquina virtual cuando se hizo la copia de seguridad todavía salen, se crean nuevos puertos y se conectan a la máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="30a21-154">If the virtual switches that the virtual machine was connected to when it was backed up still exit, new ports are created and connected to the virtual machine.</span></span>

## <a name="failover-clustering-and-hyper-v-vss"></a><span data-ttu-id="30a21-155">Clústeres de conmutación por error y Hyper-V VSS</span><span class="sxs-lookup"><span data-stu-id="30a21-155">Failover clustering and Hyper-V VSS</span></span>

<span data-ttu-id="30a21-156">La VSS Writer de Hyper-V no da ninguna consideración a las máquinas virtuales que forman parte de un clúster de conmutación por error.</span><span class="sxs-lookup"><span data-stu-id="30a21-156">The Hyper-V VSS writer does not give any consideration to virtual machines that are part of a failover cluster.</span></span> <span data-ttu-id="30a21-157">Durante las copias de seguridad del método "estado guardado" y todas las restauraciones, la máquina virtual se colocará en el estado guardado o se eliminará completamente.</span><span class="sxs-lookup"><span data-stu-id="30a21-157">During both the "Saved State" method backups and all restores, the virtual machine would be put into the saved state or deleted entirely.</span></span> <span data-ttu-id="30a21-158">Esto se vería como un error en el servicio de agrupación en clústeres y hace que las aplicaciones de esos nodos se conmuten por error a otros nodos.</span><span class="sxs-lookup"><span data-stu-id="30a21-158">This would be seen as a failure by the clustering service and cause the applications on those nodes to be failed over to other nodes.</span></span> <span data-ttu-id="30a21-159">Para evitar esto durante las copias de seguridad de "estado guardado", el estado de la máquina virtual se debe guardar mediante el servicio de agrupación en clústeres.</span><span class="sxs-lookup"><span data-stu-id="30a21-159">To avoid this during "Saved State" backups, the virtual machine state must be saved using the clustering service.</span></span> <span data-ttu-id="30a21-160">Para evitar esto durante una restauración, los recursos de la máquina virtual deberán dejarse sin conexión.</span><span class="sxs-lookup"><span data-stu-id="30a21-160">To avoid this during a restore, the resources on the virtual machine would need to be taken offline.</span></span>

## <a name="details-on-the-hyper-v-vss-writer"></a><span data-ttu-id="30a21-161">Detalles sobre VSS Writer de Hyper-V</span><span class="sxs-lookup"><span data-stu-id="30a21-161">Details on the Hyper-V VSS Writer</span></span>

<span data-ttu-id="30a21-162">Nombre del escritor: Microsoft Hyper-V VSS Writer</span><span class="sxs-lookup"><span data-stu-id="30a21-162">Writer Name: Microsoft Hyper-V VSS Writer</span></span>

<span data-ttu-id="30a21-163">ID. de escritor: 66841cd4-6ded-4f4b-8f17-fd23f8ddc3de</span><span class="sxs-lookup"><span data-stu-id="30a21-163">Writer ID: 66841cd4-6ded-4f4b-8f17-fd23f8ddc3de</span></span>

## <a name="related-topics"></a><span data-ttu-id="30a21-164">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="30a21-164">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="30a21-165">Información general sobre el procesamiento de una copia de seguridad en VSS</span><span class="sxs-lookup"><span data-stu-id="30a21-165">Overview of Processing a Backup Under VSS</span></span>](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss)
</dt> <dt>

[<span data-ttu-id="30a21-166">Información general sobre el procesamiento de una restauración en VSS</span><span class="sxs-lookup"><span data-stu-id="30a21-166">Overview of Processing a Restore Under VSS</span></span>](/windows/desktop/VSS/overview-of-processing-a-restore-under-vss)
</dt> </dl>

 

 
