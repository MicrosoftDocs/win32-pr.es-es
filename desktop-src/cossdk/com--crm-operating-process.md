---
description: Proceso operativo COM+ CRM
ms.assetid: be50912e-b9fd-4ef7-b81a-e37617a96955
title: Proceso operativo COM+ CRM
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d39dba3dedcbdefebe0f62144547ebb6985fa51f
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/07/2021
ms.locfileid: "103907484"
---
# <a name="com-crm-operating-process"></a><span data-ttu-id="438df-103">Proceso operativo COM+ CRM</span><span class="sxs-lookup"><span data-stu-id="438df-103">COM+ CRM Operating Process</span></span>

<span data-ttu-id="438df-104">En el funcionamiento normal, un componente de aplicación que se ejecuta en un proceso de aplicación de servidor usaría una CRM de COM+ mediante la creación de un trabajo de CRM.</span><span class="sxs-lookup"><span data-stu-id="438df-104">In normal operation, an application component running in a server application process would use a COM+ CRM by creating a CRM worker.</span></span> <span data-ttu-id="438df-105">El trabajador de CRM implementa una interfaz COM específica para la tarea que está diseñada para realizar.</span><span class="sxs-lookup"><span data-stu-id="438df-105">The CRM worker implements a COM interface specific to the task it is designed to perform.</span></span> <span data-ttu-id="438df-106">El componente de aplicación debe ejecutarse en una transacción para que el trabajador de CRM herede la transacción del componente de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="438df-106">The application component must be running under a transaction so that the CRM worker inherits the transaction of the application component.</span></span> <span data-ttu-id="438df-107">Los trabajadores de CRM siempre requieren una transacción.</span><span class="sxs-lookup"><span data-stu-id="438df-107">CRM workers always require a transaction.</span></span>

<span data-ttu-id="438df-108">Para obtener acceso a la CRM de COM+, el trabajador de CRM obtiene primero la interfaz [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol) , que permite al trabajador de CRM escribir registros en el registro durable.</span><span class="sxs-lookup"><span data-stu-id="438df-108">To access the COM+ CRM, the CRM worker first obtains the [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol) interface, which allows the CRM worker to write records to the durable log.</span></span> <span data-ttu-id="438df-109">El trabajador de CRM obtiene esta interfaz mediante la creación de un componente de funcionario de CRM.</span><span class="sxs-lookup"><span data-stu-id="438df-109">The CRM worker obtains this interface by creating a CRM clerk component.</span></span>

<span data-ttu-id="438df-110">A continuación, el trabajador de CRM debe indicar al funcionario de CRM el nombre del compensador de CRM que quiere usar.</span><span class="sxs-lookup"><span data-stu-id="438df-110">Next the CRM worker must tell the CRM clerk the name of the CRM Compensator it wants to use.</span></span> <span data-ttu-id="438df-111">Para ello, llama al método [**ICrmLogControl:: RegisterCompensator**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-registercompensator) .</span><span class="sxs-lookup"><span data-stu-id="438df-111">It does this by calling the [**ICrmLogControl::RegisterCompensator**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-registercompensator) method.</span></span> <span data-ttu-id="438df-112">Una vez que se llama a este método, la infraestructura de CRM crea el compensador de CRM cuando se completa la transacción.</span><span class="sxs-lookup"><span data-stu-id="438df-112">After this method is called, the CRM Compensator is created by the CRM infrastructure when the transaction completes.</span></span>

<span data-ttu-id="438df-113">Una vez que el trabajador de CRM ha registrado su compensador de CRM, puede escribir registros en el registro de CRM mediante [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol).</span><span class="sxs-lookup"><span data-stu-id="438df-113">After the CRM worker has registered its CRM Compensator, it can write records to the CRM log using [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol).</span></span> <span data-ttu-id="438df-114">El trabajador de CRM debe *escribir de antemano*; es decir, debe escribir un registro en el registro que describa una acción antes de realizar realmente la acción, en caso de que se produzca un bloqueo inmediatamente después de completar la acción.</span><span class="sxs-lookup"><span data-stu-id="438df-114">The CRM worker must *write ahead*; that is, it must write a record to the log describing an action before it actually performs the action, in case a crash occurs immediately after completing the action.</span></span> <span data-ttu-id="438df-115">Sin estas entradas de registro de escritura previa, no hay ninguna manera de corregir la acción.</span><span class="sxs-lookup"><span data-stu-id="438df-115">Without these write-ahead log records, there is no way to correct for the action.</span></span>

<span data-ttu-id="438df-116">Además, la escritura previa significa que el compensador de CRM, que es el componente que recibe las entradas de registro en la recuperación, debe tratar con el caso en el que se escribieron las entradas del registro pero la acción no se produce de hecho.</span><span class="sxs-lookup"><span data-stu-id="438df-116">Also, write ahead means that the CRM Compensator, which is the component that receives the log records on recovery, must deal with the case where the log records were written but the action did not in fact occur.</span></span> <span data-ttu-id="438df-117">Las acciones del compensador de CRM deben ser *idempotente*; es decir, deben ser capaces de ejecutarse más de una vez, pero deben producir el mismo resultado.</span><span class="sxs-lookup"><span data-stu-id="438df-117">Actions by the CRM Compensator must be *idempotent*; that is, they should be capable of being performed more than once but should lead to the same outcome.</span></span> <span data-ttu-id="438df-118">Por ejemplo, establecer un saldo de cuenta en el valor de $100 es una acción idempotente; no se agrega $100 al saldo de cuenta.</span><span class="sxs-lookup"><span data-stu-id="438df-118">For example, setting an account balance to the value of $100 is an idempotent action; adding $100 to the account balance is not.</span></span>

<span data-ttu-id="438df-119">La interfaz [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol) proporciona los dos métodos siguientes para escribir entradas de registro:</span><span class="sxs-lookup"><span data-stu-id="438df-119">The [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol) interface provides the following two methods for writing log records:</span></span>

-   <span data-ttu-id="438df-120">[**WriteLogRecordVariants**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-writelogrecordvariants) se utiliza para escribir una entrada de registro estructurada que se compila como una colección de variantes.</span><span class="sxs-lookup"><span data-stu-id="438df-120">[**WriteLogRecordVariants**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-writelogrecordvariants) is used for writing a structured log record that is built up as a collection of Variants.</span></span> <span data-ttu-id="438df-121">Se usa principalmente al desarrollar CRMs en Microsoft Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="438df-121">It is primarily for use when developing CRMs in Microsoft Visual Basic.</span></span>
-   <span data-ttu-id="438df-122">[**WriteLogRecord**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-writelogrecord) se usa para escribir una entrada de registro no estructurada como blobs de bytes.</span><span class="sxs-lookup"><span data-stu-id="438df-122">[**WriteLogRecord**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-writelogrecord) is used for writing an unstructured log record as BLOBs of bytes.</span></span> <span data-ttu-id="438df-123">Se usa principalmente al desarrollar CRMs en Microsoft Visual C++.</span><span class="sxs-lookup"><span data-stu-id="438df-123">It is primarily for use when developing CRMs in Microsoft Visual C++.</span></span> <span data-ttu-id="438df-124">Dado que las estructuras de registro en C suelen estar formadas por un conjunto de encabezados y campos que pueden estar dispersos en la memoria, el método **WriteLogRecord** implementa una funcionalidad de recopilación que reduce la copia de datos.</span><span class="sxs-lookup"><span data-stu-id="438df-124">Because record structures in C are often made up of a set of headers and fields that may be scattered in memory, the **WriteLogRecord** method implements a gather capability that reduces the copying of data.</span></span>

> [!Note]  
> <span data-ttu-id="438df-125">No debe haber tipos de puntero de usuario dentro de estructuras de datos en una entrada de registro.</span><span class="sxs-lookup"><span data-stu-id="438df-125">You should not user pointer types within data structures in a log record.</span></span> <span data-ttu-id="438df-126">Los punteros ya no son válidos durante la fase de recuperación porque el compensador de CRM se ejecuta en un proceso diferente que el del trabajador de CRM que escribió la entrada de registro.</span><span class="sxs-lookup"><span data-stu-id="438df-126">Pointers are no longer valid during recovery phase because the CRM Compensator runs in a different process than that of the CRM worker that wrote the log record.</span></span> <span data-ttu-id="438df-127">La inclusión de tipos de puntero en una entrada de registro puede hacer que una aplicación se bloquee o se dañe durante la recuperación.</span><span class="sxs-lookup"><span data-stu-id="438df-127">Including pointer types in a log record might cause an application to crash or corrupt itself during recovery.</span></span>

 

<span data-ttu-id="438df-128">Ambos métodos de escritura escriben una entrada de registro en el disco, pero no garantizan la durabilidad del registro.</span><span class="sxs-lookup"><span data-stu-id="438df-128">Both of these write methods write a log record to disk but do not guarantee the record's durability.</span></span> <span data-ttu-id="438df-129">Aunque permitir que las escrituras diferidas se acumulen antes de forzar el disco puede mejorar el rendimiento, puede usar el método [**ICrmLogControl:: ForceLog**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-forcelog) en su lugar para garantizar que todas las escrituras realizadas por el CRM son duraderas en el disco, lo que es importante para la recuperación de errores.</span><span class="sxs-lookup"><span data-stu-id="438df-129">While allowing lazy writes to accumulate before forcing to disk can improve performance, you can use the [**ICrmLogControl::ForceLog**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-forcelog) method instead to guarantee that all writes done by the CRM are durable on disk, which is important for failure recovery.</span></span>

<span data-ttu-id="438df-130">Cuando el trabajo de CRM se realiza con sus acciones y ha terminado de escribir y forzar registros en el registro, debe liberar [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol).</span><span class="sxs-lookup"><span data-stu-id="438df-130">When the CRM worker is done with its actions and has finished writing and forcing records to the log, it must release [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol).</span></span> <span data-ttu-id="438df-131">Cuando se completa la transacción (normalmente debido al componente de la aplicación que llama a [**SetComplete**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontext-setcomplete) o [**SetAbort**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontext-setabort)), la infraestructura de CRM crea el componente Compensator de CRM, que implementa la interfaz [**ICrmCompensator**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmcompensator) o la interfaz [**ICrmCompensatorVariants**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmcompensatorvariants) .</span><span class="sxs-lookup"><span data-stu-id="438df-131">When the transaction completes (typically due to the application component calling [**SetComplete**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontext-setcomplete) or [**SetAbort**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontext-setabort)), the CRM infrastructure creates the CRM Compensator component, which implements either the [**ICrmCompensator**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmcompensator) interface or the [**ICrmCompensatorVariants**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmcompensatorvariants) interface.</span></span> <span data-ttu-id="438df-132">Estas interfaces se utilizan para pasar los registros no estructurados (Visual C++) o estructurados (Visual Basic) al compensador de CRM junto con las notificaciones de resultado de la transacción.</span><span class="sxs-lookup"><span data-stu-id="438df-132">These interfaces are used to pass the unstructured (Visual C++) or structured (Visual Basic) records to the CRM Compensator along with the transaction outcome notifications.</span></span>

<span data-ttu-id="438df-133">El compensador de CRM se notifica primero de la fase de preparación de la finalización de la transacción y puede votar sí o no a la solicitud de preparación.</span><span class="sxs-lookup"><span data-stu-id="438df-133">The CRM Compensator is first notified of the prepare phase of the transaction completion and can vote either yes or no to the prepare request.</span></span> <span data-ttu-id="438df-134">Si el compensador de CRM vota no, no recibirá ninguna notificación de anulación más.</span><span class="sxs-lookup"><span data-stu-id="438df-134">If the CRM Compensator votes no, it does not receive any further abort notifications.</span></span> <span data-ttu-id="438df-135">Si vota afirmativamente a la solicitud de preparación, recibirá las notificaciones de confirmación o anulación.</span><span class="sxs-lookup"><span data-stu-id="438df-135">If it votes yes to the prepare request, it receives either the commit or abort notifications.</span></span> <span data-ttu-id="438df-136">En el caso de una anulación del cliente, no se reciben notificaciones de preparación, solo se anulan las notificaciones.</span><span class="sxs-lookup"><span data-stu-id="438df-136">In the case of a client abort, no prepare notifications are received, only abort notifications.</span></span> <span data-ttu-id="438df-137">El compensador de CRM debe estar preparado para administrar todos estos casos, y también debe controlar el caso en el que el trabajo de CRM no haya escrito correctamente ningún registro.</span><span class="sxs-lookup"><span data-stu-id="438df-137">The CRM Compensator must be prepared to handle all these cases, and it also must handle the case where no log records were successfully written by the CRM worker.</span></span> <span data-ttu-id="438df-138">El compensador de CRM no debe suponer que la misma instancia de compensador de CRM recibirá las notificaciones de la fase 1 (preparación) y la fase 2 (confirmación o anulación), ya que podrían interrumpirse mediante la recuperación.</span><span class="sxs-lookup"><span data-stu-id="438df-138">The CRM Compensator must not assume that the same CRM Compensator instance will receive both the phase 1 (prepare) and the phase 2 (commit or abort) notifications, as these could be interrupted by recovery.</span></span>

<span data-ttu-id="438df-139">Normalmente, un compensador de CRM utiliza la notificación de anulación para invertir la acción realizada por el trabajador de CRM.</span><span class="sxs-lookup"><span data-stu-id="438df-139">Typically, a CRM Compensator uses the abort notification to reverse the action that was performed by the CRM worker.</span></span> <span data-ttu-id="438df-140">El trabajo de CRM podría dejar algún estado disponible en caso de que necesite invertir su acción.</span><span class="sxs-lookup"><span data-stu-id="438df-140">The CRM worker might leave some state available in case it needs to reverse its action.</span></span> <span data-ttu-id="438df-141">Ese estado podría estar completamente incluido en las entradas del registro y, si no, el compensador de CRM debe limpiar ese estado si se confirma la transacción.</span><span class="sxs-lookup"><span data-stu-id="438df-141">That state might be fully contained in the log records, and if not, the CRM Compensator needs to clean up that state if the transaction commits.</span></span> <span data-ttu-id="438df-142">Este es el motivo por el que el compensador de CRM recibe la notificación de confirmación.</span><span class="sxs-lookup"><span data-stu-id="438df-142">This is the reason why the CRM Compensator receives the commit notification.</span></span> <span data-ttu-id="438df-143">El compensador de CRM no se ejecuta en una transacción DTC.</span><span class="sxs-lookup"><span data-stu-id="438df-143">The CRM Compensator does not run under a DTC transaction.</span></span>

<span data-ttu-id="438df-144">El compensador de CRM puede registrar nuevos registros, si es necesario, mediante [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol), que recibe a medida que se crea.</span><span class="sxs-lookup"><span data-stu-id="438df-144">The CRM Compensator can log new records if required by using [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol), which it receives as it is created.</span></span> <span data-ttu-id="438df-145">Tanto el compensador de CRM como el del trabajador de CRM también pueden olvidar la última entrada de registro que escribieron, lo que podría ser necesario para evitar una recuperación innecesaria.</span><span class="sxs-lookup"><span data-stu-id="438df-145">Both the CRM worker and CRM Compensator can also forget the last log record they wrote, which might be required to avoid unnecessary recovery.</span></span>

## <a name="related-topics"></a><span data-ttu-id="438df-146">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="438df-146">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="438df-147">Conceptos de Administrador de recursos de compensación de COM+</span><span class="sxs-lookup"><span data-stu-id="438df-147">COM+ Compensating Resource Manager Concepts</span></span>](com--compensating-resource-manager-concepts.md)
</dt> <dt>

[<span data-ttu-id="438df-148">Inicio y recuperación de COM+ CRM</span><span class="sxs-lookup"><span data-stu-id="438df-148">COM+ CRM Startup and Recovery</span></span>](com--crm-startup-and-recovery.md)
</dt> </dl>

 

 



