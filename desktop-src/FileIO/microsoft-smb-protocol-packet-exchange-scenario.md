---
description: Ejemplo de intercambio de paquetes del protocolo SMB de Microsoft entre un cliente y un servidor.
ms.assetid: f831d0de-0e38-4141-811c-892a1b5c4037
title: Escenario de intercambio de paquetes del protocolo SMB de Microsoft
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: e8a03e2f75b00aa93e629b3e698631c5efde4694
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/07/2021
ms.locfileid: "104360237"
---
# <a name="microsoft-smb-protocol-packet-exchange-scenario"></a><span data-ttu-id="0dccd-103">Escenario de intercambio de paquetes del protocolo SMB de Microsoft</span><span class="sxs-lookup"><span data-stu-id="0dccd-103">Microsoft SMB Protocol Packet Exchange Scenario</span></span>

<span data-ttu-id="0dccd-104">En este tema se proporciona un ejemplo de un intercambio de paquetes del protocolo SMB de Microsoft entre un cliente y un servidor.</span><span class="sxs-lookup"><span data-stu-id="0dccd-104">This topic gives an example of a Microsoft SMB Protocol packet exchange between a client and a server.</span></span> <span data-ttu-id="0dccd-105">Los pasos siguientes son una introducción al proceso:</span><span class="sxs-lookup"><span data-stu-id="0dccd-105">The following steps are an overview of the process:</span></span>

1.  <span data-ttu-id="0dccd-106">El cliente y el servidor establecen una sesión NetBIOS.</span><span class="sxs-lookup"><span data-stu-id="0dccd-106">The client and server establish a NetBIOS session.</span></span>
2.  <span data-ttu-id="0dccd-107">El cliente y el servidor negocian el dialecto del protocolo SMB de Microsoft.</span><span class="sxs-lookup"><span data-stu-id="0dccd-107">The client and server negotiate the Microsoft SMB Protocol dialect.</span></span>
3.  <span data-ttu-id="0dccd-108">El cliente inicia sesión en el servidor.</span><span class="sxs-lookup"><span data-stu-id="0dccd-108">The client logs on to the server.</span></span>
4.  <span data-ttu-id="0dccd-109">El cliente se conecta a un recurso compartido en el servidor.</span><span class="sxs-lookup"><span data-stu-id="0dccd-109">The client connects to a share on the server.</span></span>
5.  <span data-ttu-id="0dccd-110">El cliente abre un archivo en el recurso compartido.</span><span class="sxs-lookup"><span data-stu-id="0dccd-110">The client opens a file on the share.</span></span>
6.  <span data-ttu-id="0dccd-111">El cliente lee el archivo.</span><span class="sxs-lookup"><span data-stu-id="0dccd-111">The client reads from the file.</span></span>

<span data-ttu-id="0dccd-112">En primer lugar, el cliente establece una conexión TCP de dúplex completo con el servidor.</span><span class="sxs-lookup"><span data-stu-id="0dccd-112">First, a full-duplex TCP connection is established by the client with the server.</span></span> <span data-ttu-id="0dccd-113">A continuación, el cliente genera y envía un paquete de solicitud de sesión NetBIOS a través de la conexión TCP.</span><span class="sxs-lookup"><span data-stu-id="0dccd-113">Then the client builds and sends a NetBIOS session request packet over the TCP connection.</span></span> <span data-ttu-id="0dccd-114">Si el paquete tenía el formato correcto, el servidor devuelve un paquete que contiene un mensaje que confirma que se ha establecido la sesión.</span><span class="sxs-lookup"><span data-stu-id="0dccd-114">If the packet was formatted correctly, the server then returns a packet that contains a message acknowledging that the session has been established.</span></span> <span data-ttu-id="0dccd-115">Después, el cliente envía los paquetes del primer protocolo SMB de Microsoft al servidor.</span><span class="sxs-lookup"><span data-stu-id="0dccd-115">After this, the client sends the first Microsoft SMB Protocol packets to the server.</span></span>



|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="0dccd-116">**Paquete 1: \_ negociando com de SMB \_**</span><span class="sxs-lookup"><span data-stu-id="0dccd-116">**Packet 1:  SMB\_COM\_NEGOTIATE**</span></span><br/> <span data-ttu-id="0dccd-117">**Dirección:** Cliente a servidor</span><span class="sxs-lookup"><span data-stu-id="0dccd-117">**Direction:** Client to server</span></span><br/> <span data-ttu-id="0dccd-118">**Descripción:** El cliente solicita que el servidor negocie el dialecto del protocolo SMB de Microsoft.</span><span class="sxs-lookup"><span data-stu-id="0dccd-118">**Description:** The client requests that the server negotiate the Microsoft SMB Protocol dialect.</span></span> <span data-ttu-id="0dccd-119">En el paquete se incluye una lista de cadenas que identifican los dialectos con los que el cliente puede trabajar.</span><span class="sxs-lookup"><span data-stu-id="0dccd-119">A list of strings identifying the dialects that the client can work with is included in the packet.</span></span><br/>                                                                                                                                                                                                                                                                                                                                   |
| <span data-ttu-id="0dccd-120">**Paquete 2: \_ negociando com de SMB \_**</span><span class="sxs-lookup"><span data-stu-id="0dccd-120">**Packet 2:  SMB\_COM\_NEGOTIATE**</span></span><br/> <span data-ttu-id="0dccd-121">**Dirección:** Servidor a cliente</span><span class="sxs-lookup"><span data-stu-id="0dccd-121">**Direction:** Server to client</span></span><br/> <span data-ttu-id="0dccd-122">**Descripción:** El servidor responde a la solicitud del cliente para identificar el dialecto del protocolo SMB de Microsoft que se va a usar en la sesión.</span><span class="sxs-lookup"><span data-stu-id="0dccd-122">**Description:** The server responds to the client's request to identify the Microsoft SMB Protocol dialect that is going to be used in the session.</span></span> <span data-ttu-id="0dccd-123">El paquete devuelto también incluye una cadena aleatoria de 8 bytes que se usará en el paso siguiente para autenticar el cliente durante el proceso de inicio de sesión.</span><span class="sxs-lookup"><span data-stu-id="0dccd-123">The returned packet also includes an 8-byte random string that will be used in the next step to authenticate the client during the logon process.</span></span><br/>                                                                                                                                                                                                                                   |
| <span data-ttu-id="0dccd-124">**Paquete 3: \_ configuración de sesión com de SMB \_ \_ \_ ANDX**</span><span class="sxs-lookup"><span data-stu-id="0dccd-124">**Packet 3:  SMB\_COM\_SESSION\_SETUP\_ANDX**</span></span><br/> <span data-ttu-id="0dccd-125">**Dirección:** Cliente a servidor</span><span class="sxs-lookup"><span data-stu-id="0dccd-125">**Direction:** Client to server</span></span><br/> <span data-ttu-id="0dccd-126">**Descripción:** Este paquete incluye información sobre las capacidades de cliente, por lo que este paquete se debe enviar incluso si el servidor solo ha implementado la seguridad de nivel de recurso compartido.</span><span class="sxs-lookup"><span data-stu-id="0dccd-126">**Description:** This packet includes information about client capabilities, so this packet must be sent even if the server has implemented only share-level security.</span></span><br/> <span data-ttu-id="0dccd-127">**Paquete 3: \_ configuración de sesión com de SMB \_ \_ \_ ANDX**</span><span class="sxs-lookup"><span data-stu-id="0dccd-127">**Packet 3:  SMB\_COM\_SESSION\_SETUP\_ANDX**</span></span><br/> <span data-ttu-id="0dccd-128">**Dirección:** Servidor a cliente</span><span class="sxs-lookup"><span data-stu-id="0dccd-128">**Direction:** Server to client</span></span><br/> <span data-ttu-id="0dccd-129">**Descripción:** Si el servidor acepta el desafío/respuesta, se incluye un UID válido en el paquete que se devuelve al cliente.</span><span class="sxs-lookup"><span data-stu-id="0dccd-129">**Description:** If the challenge/response is accepted by the server, a valid UID is included in the packet that is returned to the client.</span></span> <span data-ttu-id="0dccd-130">Si no se acepta, el servidor devolverá un código de error en este paquete y denegará el acceso.</span><span class="sxs-lookup"><span data-stu-id="0dccd-130">If it is not accepted, the server will return an error code in this packet and deny access.</span></span><br/> |
| <span data-ttu-id="0dccd-131">**Paquete 4: \_ conexión de árbol com de SMB \_ \_ \_ ANDX**</span><span class="sxs-lookup"><span data-stu-id="0dccd-131">**Packet 4:  SMB\_COM\_TREE\_CONNECT\_ANDX**</span></span><br/> <span data-ttu-id="0dccd-132">**Dirección:** Cliente a servidor</span><span class="sxs-lookup"><span data-stu-id="0dccd-132">**Direction:** Client to server</span></span><br/> <span data-ttu-id="0dccd-133">**Descripción:** El cliente solicita acceso al recurso compartido.</span><span class="sxs-lookup"><span data-stu-id="0dccd-133">**Description:** The client requests access to the share.</span></span> <span data-ttu-id="0dccd-134">El paquete contiene la ruta de acceso completa del recurso compartido en formato UNC.</span><span class="sxs-lookup"><span data-stu-id="0dccd-134">The packet contains the fully specified path of the share in UNC format.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                             |
| <span data-ttu-id="0dccd-135">**Paquete 5: \_ conexión de árbol com de SMB \_ \_ \_ ANDX**</span><span class="sxs-lookup"><span data-stu-id="0dccd-135">**Packet 5:  SMB\_COM\_TREE\_CONNECT\_ANDX**</span></span><br/> <span data-ttu-id="0dccd-136">**Dirección:** Servidor a cliente</span><span class="sxs-lookup"><span data-stu-id="0dccd-136">**Direction:** Server to client</span></span><br/> <span data-ttu-id="0dccd-137">**Descripción:** Si se concede el acceso al recurso compartido, el servidor devuelve el identificador de árbol de 16 bits (TID) que corresponde al recurso compartido de este paquete.</span><span class="sxs-lookup"><span data-stu-id="0dccd-137">**Description:** If access to the share is granted, then the server returns the 16-bit tree ID (TID) that corresponds to the share in this packet.</span></span> <span data-ttu-id="0dccd-138">Si el recurso compartido no existe o el usuario no tiene credenciales suficientes para tener acceso al recurso compartido, el servidor devolverá un código de error en este paquete y denegará el acceso al recurso compartido.</span><span class="sxs-lookup"><span data-stu-id="0dccd-138">If the share does not exist or the user has insufficient credentials to access the share, the server will return an error code in this packet and deny access to the share.</span></span><br/>                                                                                                                                                                                                 |
| <span data-ttu-id="0dccd-139">**Paquete 6: \_ \_ ANDX Open com de SMB \_**</span><span class="sxs-lookup"><span data-stu-id="0dccd-139">**Packet 6:  SMB\_COM\_OPEN\_ANDX**</span></span><br/> <span data-ttu-id="0dccd-140">**Dirección:** Cliente a servidor</span><span class="sxs-lookup"><span data-stu-id="0dccd-140">**Direction:** Client to server</span></span><br/> <span data-ttu-id="0dccd-141">**Descripción:** El cliente solicita al servidor que abra un archivo en el recurso compartido al que se tiene acceso en nombre del cliente.</span><span class="sxs-lookup"><span data-stu-id="0dccd-141">**Description:** The client requests the server to open a file on the accessed share on behalf of the client.</span></span> <span data-ttu-id="0dccd-142">Este paquete contiene el nombre del archivo que se va a abrir.</span><span class="sxs-lookup"><span data-stu-id="0dccd-142">This packet contains the name of the file to be opened.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                   |
| <span data-ttu-id="0dccd-143">**Paquete 7: \_ \_ ANDX Open com de SMB \_**</span><span class="sxs-lookup"><span data-stu-id="0dccd-143">**Packet 7:  SMB\_COM\_OPEN\_ANDX**</span></span><br/> <span data-ttu-id="0dccd-144">**Dirección:** Servidor a cliente</span><span class="sxs-lookup"><span data-stu-id="0dccd-144">**Direction:** Server to client</span></span><br/> <span data-ttu-id="0dccd-145">**Descripción:** Si se concede el acceso al archivo, el servidor devuelve el identificador de archivo del archivo solicitado.</span><span class="sxs-lookup"><span data-stu-id="0dccd-145">**Description:** If access to the file is granted, then the server returns the file ID of the requested file.</span></span> <span data-ttu-id="0dccd-146">Si el archivo no existe o el usuario no tiene credenciales suficientes para tener acceso al archivo, el servidor devolverá un código de error en este paquete y denegará el acceso al archivo.</span><span class="sxs-lookup"><span data-stu-id="0dccd-146">If the file does not exist or the user has insufficient credentials to access the file, the server will return an error code in this packet and deny access to the file.</span></span><br/>                                                                                                                                                                                                                                                  |
| <span data-ttu-id="0dccd-147">**Paquete 8: \_ ANDX de \_ lectura de com SMB \_**</span><span class="sxs-lookup"><span data-stu-id="0dccd-147">**Packet 8:  SMB\_COM\_READ\_ANDX**</span></span><br/> <span data-ttu-id="0dccd-148">**Dirección:** Cliente a servidor</span><span class="sxs-lookup"><span data-stu-id="0dccd-148">**Direction:** Client to server</span></span><br/> <span data-ttu-id="0dccd-149">**Descripción:** El cliente solicita al servidor que lea los datos del archivo abierto en nombre del cliente y los devuelva al cliente.</span><span class="sxs-lookup"><span data-stu-id="0dccd-149">**Description:** The client requests the server to read data from the opened file on behalf of the client and return this data to the client.</span></span> <span data-ttu-id="0dccd-150">El ID. de archivo que obtiene el cliente al abrir el archivo se incluye en este paquete para identificar el archivo abierto en el que el servidor debe leer los datos.</span><span class="sxs-lookup"><span data-stu-id="0dccd-150">The file ID that is obtained by the client when the file was opened is included in this packet in order to identify which opened file the server should read data from.</span></span><br/>                                                                                                                                                                                                                   |
| <span data-ttu-id="0dccd-151">**Paquete 9: \_ ANDX de \_ lectura de com SMB \_**</span><span class="sxs-lookup"><span data-stu-id="0dccd-151">**Packet 9:  SMB\_COM\_READ\_ANDX**</span></span><br/> <span data-ttu-id="0dccd-152">**Dirección:** Servidor a cliente</span><span class="sxs-lookup"><span data-stu-id="0dccd-152">**Direction:** Server to client</span></span><br/> <span data-ttu-id="0dccd-153">**Descripción:** El servidor devuelve los datos de archivo solicitados en este paquete.</span><span class="sxs-lookup"><span data-stu-id="0dccd-153">**Description:** The server returns the requested file data in this packet.</span></span> <span data-ttu-id="0dccd-154">Aquí no es probable que se produzca un error, dado que se ha concedido acceso al servidor, al recurso compartido y al archivo.</span><span class="sxs-lookup"><span data-stu-id="0dccd-154">An error here is unlikely given that access to the server, share, and file has been granted.</span></span> <span data-ttu-id="0dccd-155">Sin embargo, puede suceder en algunas situaciones: por ejemplo, si se cambia el acceso a un recurso compartido entre el momento en que se abre el archivo y el momento en que se lee.</span><span class="sxs-lookup"><span data-stu-id="0dccd-155">It can happen in some situations, however: for example, if access to a share is changed between the time the file is opened and the time it is read from.</span></span><br/>                                                                                                                                                                                                      |



 

> [!Note]  
> <span data-ttu-id="0dccd-156">Si implementa un CIFS que no admite notificaciones de cambios, Windows no puede mantener un identificador pendiente en el sistema de archivos y la conexión SMB puede desaparecer sin previo aviso.</span><span class="sxs-lookup"><span data-stu-id="0dccd-156">If you implement a CIFS that does not support change notifications, Windows cannot keep an outstanding handle to the file system, and the SMB connection can go away without notice.</span></span>

 

 

 




