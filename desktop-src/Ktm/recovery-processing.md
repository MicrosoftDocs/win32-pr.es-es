---
description: Después de cualquier tipo de error que interrumpa el procesamiento de transacciones normal, KTM y cada administrador de recursos deben realizar operaciones de recuperación. La recuperación es el proceso por el que llegan los participantes de la transacción en una vista coherente de cada estado de las transacciones.
ms.assetid: 5bc9a155-6ba4-41f8-8e12-e87f48d83940
title: Procesamiento de recuperación
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 5a8e74d4f8bff3e56af03b017522212e7a02e232
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/07/2021
ms.locfileid: "105687395"
---
# <a name="recovery-processing"></a><span data-ttu-id="efee7-104">Procesamiento de recuperación</span><span class="sxs-lookup"><span data-stu-id="efee7-104">Recovery Processing</span></span>

<span data-ttu-id="efee7-105">Después de cualquier tipo de error que interrumpa el procesamiento de transacciones normal, KTM y cada administrador de recursos deben realizar operaciones de *recuperación* .</span><span class="sxs-lookup"><span data-stu-id="efee7-105">After any type of failure that disrupts normal transaction processing, KTM and each resource manager must perform *recovery* operations.</span></span> <span data-ttu-id="efee7-106">La recuperación es el proceso por el que llegan los participantes de la transacción en una vista coherente del estado de cada transacción.</span><span class="sxs-lookup"><span data-stu-id="efee7-106">Recovery is the process by which transaction participants arrive at a consistent view of each transaction's state.</span></span>

<span data-ttu-id="efee7-107">Es posible que los administradores de recursos estén *en duda* sobre el resultado de una transacción, lo que significa que, en el momento en que se produjo el error, han recibido una notificación de preparación de una transacción \_ \_ , había preparado el almacenamiento duradero, pero no se ha recibido (o recibido pero no registrado) el resultado final de la transacción.</span><span class="sxs-lookup"><span data-stu-id="efee7-107">Resource managers may be *in-doubt* about a transaction's outcome, meaning that at the time of failure, they had received a TRANSACTION\_NOTIFY\_PREPARE notification, had prepared to durable storage, but had not received (or received but not logged) a final outcome for the transaction.</span></span> <span data-ttu-id="efee7-108">Del mismo modo, KTM puede ser dudoso sobre una transacción si se había preparado pero no se ha recibido (o recibido pero no registrado) un resultado.</span><span class="sxs-lookup"><span data-stu-id="efee7-108">Similarly, KTM can be in-doubt about a transaction if it had been prepared but had not received (or received but not logged) an outcome.</span></span> <span data-ttu-id="efee7-109">En el momento de la recuperación, se deben volver a enviar todos los resultados enviados pero no confirmados.</span><span class="sxs-lookup"><span data-stu-id="efee7-109">At recovery time, all outcomes that have been sent but not acknowledged must be re-sent.</span></span> <span data-ttu-id="efee7-110">Por ejemplo, si un administrador de recursos ha recibido una notificación de confirmación de notificación de transacción y se ha \_ \_ llamado a la función [**CommitComplete**](/windows/desktop/api/Ktmw32/nf-ktmw32-commitcomplete) , es posible que el RM siga recibiendo una notificación de confirmación de notificación de transacción duplicada \_ \_ en el momento de la recuperación.</span><span class="sxs-lookup"><span data-stu-id="efee7-110">For example, if a resource manager received a TRANSACTION\_NOTIFY\_COMMIT notification and called the [**CommitComplete**](/windows/desktop/api/Ktmw32/nf-ktmw32-commitcomplete) function, the RM may still receive a duplicate TRANSACTION\_NOTIFY\_COMMIT notification at recovery time.</span></span>

<span data-ttu-id="efee7-111">Para que una transacción se recupere correctamente después de un error del sistema o del administrador de recursos, cada administrador de recursos debe hacer lo siguiente cada vez que se inicia:</span><span class="sxs-lookup"><span data-stu-id="efee7-111">For a transaction to properly recover after a resource manager or system failure, each resource manager must do the following each time it is started:</span></span>

1.  <span data-ttu-id="efee7-112">Llame a la función [**OpenResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-openresourcemanager) para volver a abrir su identificador de Resource Manager usando su nombre único y persistente.</span><span class="sxs-lookup"><span data-stu-id="efee7-112">Call the [**OpenResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-openresourcemanager) function to re-open its resource manager handle using its unique, persistent name.</span></span> <span data-ttu-id="efee7-113">Esto informa a KTM de que el administrador de recursos se está ejecutando de nuevo y está disponible para realizar la recuperación.</span><span class="sxs-lookup"><span data-stu-id="efee7-113">This informs KTM that the resource manager is running again and is available to perform recovery.</span></span> <span data-ttu-id="efee7-114">Si no existe ninguna inscripción para recuperarla, se puede producir un error en la llamada a **OpenResourceManager** .</span><span class="sxs-lookup"><span data-stu-id="efee7-114">If no enlistments exist to be recovered, the call to **OpenResourceManager** can fail.</span></span> <span data-ttu-id="efee7-115">Llame a [**CreateResourceManager (**](/windows/desktop/api/Ktmw32/nf-ktmw32-createresourcemanager) para volver a crear el objeto RM.</span><span class="sxs-lookup"><span data-stu-id="efee7-115">Call [**CreateResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-createresourcemanager) to re-create the RM object.</span></span>
2.  <span data-ttu-id="efee7-116">Llame a [**RecoverResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-recoverresourcemanager).</span><span class="sxs-lookup"><span data-stu-id="efee7-116">Call [**RecoverResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-recoverresourcemanager).</span></span> <span data-ttu-id="efee7-117">El administrador de recursos recibirá un evento de notificación de notificaciones de [**\_ \_ recuperación de transacciones**](notification-mask.md) para cada inscripción para la que necesite realizar operaciones de recuperación, seguida de una notificación de la \_ \_ última recuperación de la transacción \_ .</span><span class="sxs-lookup"><span data-stu-id="efee7-117">The resource manager will receive a [**TRANSACTION\_NOTIFY\_RECOVER**](notification-mask.md) notification event for each enlistment for which it needs to perform recovery operations, followed by a TRANSACTION\_NOTIFY\_LAST\_RECOVER.</span></span> <span data-ttu-id="efee7-118">El evento de notificación incluye un identificador único global para la transacción y la inscripción.</span><span class="sxs-lookup"><span data-stu-id="efee7-118">The notification event includes a globally unique identifier for both the transaction and the enlistment.</span></span>
3.  <span data-ttu-id="efee7-119">Llame a la función [**OpenEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-openenlistment) para volver a abrir cada identificador de inscripción para el que el administrador de recursos haya recibido una notificación de solicitud de recuperación de la transacción \_ \_ .</span><span class="sxs-lookup"><span data-stu-id="efee7-119">Call the [**OpenEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-openenlistment) function to re-open each enlistment handle for which the resource manager received a TRANSACTION\_NOTIFY\_RECOVER notification.</span></span>
4.  <span data-ttu-id="efee7-120">Para cada inscripción abierta por [**OpenEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-openenlistment), llame a [**RecoverEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-recoverenlistment).</span><span class="sxs-lookup"><span data-stu-id="efee7-120">For each enlistment opened by [**OpenEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-openenlistment), call [**RecoverEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-recoverenlistment).</span></span> <span data-ttu-id="efee7-121">Esto hace que se vuelvan a entregar la notificación de confirmación de notificación de transacción o de notificaciones \_ \_ \_ \_ de transacción.</span><span class="sxs-lookup"><span data-stu-id="efee7-121">This causes the TRANSACTION\_NOTIFY\_COMMIT or TRANSACTION\_NOTIFY\_INDOUBT notification to be redelivered.</span></span>
5.  <span data-ttu-id="efee7-122">Si la transacción recibida de RM \_ notifica la \_ confirmación, el RM puede completar la transacción llamando a [**CommitComplete**](/windows/desktop/api/Ktmw32/nf-ktmw32-commitcomplete).</span><span class="sxs-lookup"><span data-stu-id="efee7-122">If the RM received TRANSACTION\_NOTIFY\_COMMIT, the RM can complete the transaction by calling [**CommitComplete**](/windows/desktop/api/Ktmw32/nf-ktmw32-commitcomplete).</span></span>

    <span data-ttu-id="efee7-123">Si la transacción recibida de RM \_ notifica inadvertidamente \_ , el RM debe esperar a que llegue la notificación de resultados.</span><span class="sxs-lookup"><span data-stu-id="efee7-123">If the RM received TRANSACTION\_NOTIFY\_INDOUBT, the RM should wait for the outcome notification to arrive.</span></span>

6.  <span data-ttu-id="efee7-124">En el caso de las transacciones que el RM no recibe, se notifica una \_ \_ notificación de recuperación de una transacción, pero anteriormente recibió una \_ notificación de notificaciones \_ de preparación para, el RM debe procesar la transacción como si se revirtió.</span><span class="sxs-lookup"><span data-stu-id="efee7-124">For any transactions that the RM does not receive a TRANSACTION\_NOTIFY\_RECOVER notification, but previously received a TRANSACTION\_NOTIFY\_PREPARE notification for, the RM should process the transaction as if it were rolled back.</span></span>

> [!Note]
>
> <span data-ttu-id="efee7-125">Los administradores de recursos pueden dar de alta o crear nuevas transacciones mientras están en proceso de realizar la recuperación.</span><span class="sxs-lookup"><span data-stu-id="efee7-125">Resource managers are allowed to enlist in or create new transactions while in the process of performing recovery.</span></span>

 

<span data-ttu-id="efee7-126">KTM usa un modelo de transacción *presunta anulación* .</span><span class="sxs-lookup"><span data-stu-id="efee7-126">KTM uses a *presumed abort* transaction model.</span></span> <span data-ttu-id="efee7-127">En el escenario siguiente se muestra este comportamiento.</span><span class="sxs-lookup"><span data-stu-id="efee7-127">The following scenario illustrates this behavior.</span></span> <span data-ttu-id="efee7-128">Supongamos que KTM y un administrador de recursos existen en el mismo equipo.</span><span class="sxs-lookup"><span data-stu-id="efee7-128">Assume that KTM and an resource manager exist on the same computer.</span></span> <span data-ttu-id="efee7-129">Suponga que KTM emite una notificación de preparación para una transacción, pero el sistema se bloquea antes de que KTM registre la notificación de preparación.</span><span class="sxs-lookup"><span data-stu-id="efee7-129">Suppose KTM issues a prepare notification for a transaction, but the system crashes before KTM logs the prepare notification.</span></span> <span data-ttu-id="efee7-130">Supongamos que el administrador de recursos recibe y registra la notificación de preparación justo antes de que se bloquee el sistema.</span><span class="sxs-lookup"><span data-stu-id="efee7-130">Further suppose that the resource manager receives and logs the prepare notification just before the system crashes.</span></span> <span data-ttu-id="efee7-131">Una vez restaurado el sistema, KTM no tiene ningún conocimiento de la transacción, porque nunca registró la fase de preparación.</span><span class="sxs-lookup"><span data-stu-id="efee7-131">After the system is restored, KTM has no knowledge of the transaction, because it never logged the prepare phase.</span></span> <span data-ttu-id="efee7-132">El administrador de recursos tiene conocimiento de la transacción, porque recibió, procesó y registró la notificación de preparación.</span><span class="sxs-lookup"><span data-stu-id="efee7-132">The resource manager has knowledge of the transaction, because it received, processed, and logged the prepare notification.</span></span> <span data-ttu-id="efee7-133">Cuando KTM emite las notificaciones de recuperación, el administrador de recursos no incluye una notificación de recuperación para la transacción en cuestión.</span><span class="sxs-lookup"><span data-stu-id="efee7-133">When KTM issues its recovery notifications, the resource manager does not include a recovery notification for the transaction in question.</span></span> <span data-ttu-id="efee7-134">Con el modelo de anulación supuesto, el administrador de recursos en este caso tratará la transacción preparada como anulada cuando no reciba notificaciones para realizar la recuperación en esa transacción.</span><span class="sxs-lookup"><span data-stu-id="efee7-134">With the presumed abort model, the resource manager in this case will treat the prepared transaction as aborted when it does not receive notifications to perform recovery on that transaction.</span></span>

 

 



