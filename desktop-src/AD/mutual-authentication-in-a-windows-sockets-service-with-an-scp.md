---
title: Autenticación mutua en un servicio de Windows Sockets con SCP
description: En los temas de esta sección se incluyen ejemplos de código que muestran cómo realizar la autenticación mutua con un servicio que se publica mediante un punto de conexión de servicio (SCP).
ms.assetid: f730464c-95ac-4285-960c-18862f6f7852
ms.tgt_platform: multiple
keywords:
- Autenticación mutua en un servicio de Windows Sockets con un AD de SCP
- Active Directory, uso, autenticación mutua, servicio de Windows Sockets con un SCP
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 527715c4a35dc15cd67f5820e6fa891b56452399
ms.sourcegitcommit: 803f3ccd65bdefe36bd851b9c6e7280be9489016
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/17/2020
ms.locfileid: "103904488"
---
# <a name="mutual-authentication-in-a-windows-sockets-service-with-scp"></a><span data-ttu-id="5923c-105">Autenticación mutua en un servicio de Windows Sockets con SCP</span><span class="sxs-lookup"><span data-stu-id="5923c-105">Mutual Authentication in a Windows Sockets Service with SCP</span></span>

<span data-ttu-id="5923c-106">En los temas de esta sección se incluyen ejemplos de código que muestran cómo realizar la autenticación mutua con un servicio que se publica mediante un punto de conexión de servicio (SCP).</span><span class="sxs-lookup"><span data-stu-id="5923c-106">The topics in this section include code examples that show how to perform mutual authentication with a service that publishes itself using a service connection point (SCP).</span></span> <span data-ttu-id="5923c-107">Los ejemplos se basan en un servicio de Microsoft Windows Sockets que usa un paquete SSPI para controlar la negociación de la autenticación mutua entre un cliente y el servicio.</span><span class="sxs-lookup"><span data-stu-id="5923c-107">The examples are based on a Microsoft Windows Sockets service that uses an SSPI package to handle the mutual authentication negotiation between a client and the service.</span></span> <span data-ttu-id="5923c-108">Utilice los procedimientos siguientes para implementar la autenticación mutua en este escenario.</span><span class="sxs-lookup"><span data-stu-id="5923c-108">Use the following procedures to implement mutual authentication within this scenario.</span></span>

<span data-ttu-id="5923c-109">**Para registrar los SPN en un directorio cuando se instala un servicio**</span><span class="sxs-lookup"><span data-stu-id="5923c-109">**To register SPNs in a directory when a service is installed**</span></span>

1.  <span data-ttu-id="5923c-110">Llame a la función [**DsGetSpn**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsgetspna) para crear nombres de entidad de seguridad de servicio (SPN) para el servicio.</span><span class="sxs-lookup"><span data-stu-id="5923c-110">Call the [**DsGetSpn**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsgetspna) function to compose service principal names (SPNs) for the service.</span></span>
2.  <span data-ttu-id="5923c-111">Llame a la función [**DsWriteAccountSpn**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dswriteaccountspna) para registrar los SPN en la cuenta de servicio o la cuenta de equipo en cuyo contexto se ejecutará el servicio.</span><span class="sxs-lookup"><span data-stu-id="5923c-111">Call the [**DsWriteAccountSpn**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dswriteaccountspna) function to register the SPNs on the service account or computer account in whose context the service will run.</span></span> <span data-ttu-id="5923c-112">Este paso lo debe realizar un administrador de dominio; una excepción es que un servicio que se ejecuta con la cuenta LocalSystem puede registrar su SPN con el formato " <service class> / <host> " en la cuenta de equipo del host del servicio.</span><span class="sxs-lookup"><span data-stu-id="5923c-112">This step must be performed by a domain administrator; an exception is that a service running under the LocalSystem account can register its SPN in the form "<service class>/<host>" on the computer account of the service host.</span></span>

<span data-ttu-id="5923c-113">**Para comprobar la configuración en el inicio del servicio**</span><span class="sxs-lookup"><span data-stu-id="5923c-113">**To verify configuration at service startup**</span></span>

-   <span data-ttu-id="5923c-114">Compruebe que los SPN adecuados están registrados en la cuenta en la que se está ejecutando el servicio.</span><span class="sxs-lookup"><span data-stu-id="5923c-114">Verify that the appropriate SPNs are registered on the account under which the service is running.</span></span> <span data-ttu-id="5923c-115">Para obtener más información, consulte tareas de mantenimiento de la [cuenta de inicio de sesión](logon-account-maintenance-tasks.md).</span><span class="sxs-lookup"><span data-stu-id="5923c-115">For more information, see [Logon Account Maintenance Tasks](logon-account-maintenance-tasks.md).</span></span>

<span data-ttu-id="5923c-116">**Para autenticar el servicio en el inicio del cliente**</span><span class="sxs-lookup"><span data-stu-id="5923c-116">**To authenticate the service at client startup**</span></span>

1.  <span data-ttu-id="5923c-117">Recuperar datos de conexión desde el punto de conexión de servicio del servicio.</span><span class="sxs-lookup"><span data-stu-id="5923c-117">Retrieve connection data from the service's service connection point.</span></span>
2.  <span data-ttu-id="5923c-118">Establezca una conexión con el servicio.</span><span class="sxs-lookup"><span data-stu-id="5923c-118">Establish a connection to the service.</span></span>
3.  <span data-ttu-id="5923c-119">Llame a la función [**DsMakeSpn**](/windows/desktop/api/Dsparse/nf-dsparse-dsmakespna) para crear un SPN para el servicio.</span><span class="sxs-lookup"><span data-stu-id="5923c-119">Call the [**DsMakeSpn**](/windows/desktop/api/Dsparse/nf-dsparse-dsmakespna) function to compose an SPN for the service.</span></span> <span data-ttu-id="5923c-120">Cree el SPN a partir de la cadena de clase de servicio conocida y los datos recuperados del punto de conexión de servicio.</span><span class="sxs-lookup"><span data-stu-id="5923c-120">Compose the SPN from the known service class string, and the data retrieved from the service connection point.</span></span> <span data-ttu-id="5923c-121">Estos datos incluyen el nombre de host del servidor en el que se ejecuta el servicio.</span><span class="sxs-lookup"><span data-stu-id="5923c-121">This data includes the host name of the server on which the service is running.</span></span> <span data-ttu-id="5923c-122">Tenga en cuenta que el nombre de host debe ser un nombre DNS.</span><span class="sxs-lookup"><span data-stu-id="5923c-122">Be aware that the host name must be a DNS name.</span></span>
4.  <span data-ttu-id="5923c-123">Use un paquete de seguridad de SSPI para realizar la autenticación:</span><span class="sxs-lookup"><span data-stu-id="5923c-123">Use an SSPI security package to perform the authentication:</span></span>
    1.  <span data-ttu-id="5923c-124">Llame a la función [**AcquireCredentialsHandle**](../SecAuthN/acquirecredentialshandle--general.md) para adquirir las credenciales del cliente.</span><span class="sxs-lookup"><span data-stu-id="5923c-124">Call the [**AcquireCredentialsHandle**](../SecAuthN/acquirecredentialshandle--general.md) function to acquire the client's credentials.</span></span>
    2.  <span data-ttu-id="5923c-125">Pase las credenciales de cliente y el SPN a la función [**InitializeSecurityContext**](../SecAuthN/initializesecuritycontext--general.md) para generar un BLOB de seguridad que se enviará al servicio para la autenticación.</span><span class="sxs-lookup"><span data-stu-id="5923c-125">Pass the client credentials and the SPN to the [**InitializeSecurityContext**](../SecAuthN/initializesecuritycontext--general.md) function to generate a security blob to send to the service for authentication.</span></span> <span data-ttu-id="5923c-126">Establezca la marca **ISC \_ req \_ Mutual \_ auth** para solicitar autenticación mutua.</span><span class="sxs-lookup"><span data-stu-id="5923c-126">Set the **ISC\_REQ\_MUTUAL\_AUTH** flag to request mutual authentication.</span></span>
    3.  <span data-ttu-id="5923c-127">Intercambie blobs con el servicio hasta que se complete la autenticación.</span><span class="sxs-lookup"><span data-stu-id="5923c-127">Exchange blobs with the service until the authentication is complete.</span></span>
5.  <span data-ttu-id="5923c-128">Compruebe la máscara de funcionalidades devueltas para la marca de autenticación mutua de REQ de ISC para comprobar que se realizó la autenticación mutua. **\_ \_ \_**</span><span class="sxs-lookup"><span data-stu-id="5923c-128">Verify the returned capabilities mask for the **ISC\_REQ\_MUTUAL\_AUTH** flag to verify that mutual authentication was performed.</span></span>
6.  <span data-ttu-id="5923c-129">Si la autenticación se realizó correctamente, intercambie el tráfico con el servicio autenticado.</span><span class="sxs-lookup"><span data-stu-id="5923c-129">If the authentication was successful, exchange traffic with the authenticated service.</span></span> <span data-ttu-id="5923c-130">Use la firma digital para asegurarse de que los mensajes entre el cliente y el servicio no se han alterado.</span><span class="sxs-lookup"><span data-stu-id="5923c-130">Use digital signing to ensure that messages between client and service have not been tampered with.</span></span> <span data-ttu-id="5923c-131">A menos que los requisitos de rendimiento sean graves, use el cifrado.</span><span class="sxs-lookup"><span data-stu-id="5923c-131">Unless performance requirements are severe, use encryption.</span></span> <span data-ttu-id="5923c-132">Para obtener más información y un ejemplo de código que muestra cómo usar las funciones [**MakeSignature**](/windows/desktop/api/sspi/nf-sspi-makesignature), [**VerifySignature**](/windows/desktop/api/sspi/nf-sspi-verifysignature), [**EncryptMessage**](../SecAuthN/encryptmessage--general.md)y [**DecryptMessage**](../SecAuthN/decryptmessage--general.md) en un paquete SSPI, consulte [garantizar la integridad de la comunicación durante el intercambio de mensajes](/windows/desktop/SecAuthN/ensuring-communication-integrity-during-message-exchange).</span><span class="sxs-lookup"><span data-stu-id="5923c-132">For more information and a code example that shows how to use the [**MakeSignature**](/windows/desktop/api/sspi/nf-sspi-makesignature), [**VerifySignature**](/windows/desktop/api/sspi/nf-sspi-verifysignature), [**EncryptMessage**](../SecAuthN/encryptmessage--general.md), and [**DecryptMessage**](../SecAuthN/decryptmessage--general.md) functions in an SSPI package, see [Ensuring Communication Integrity During Message Exchange](/windows/desktop/SecAuthN/ensuring-communication-integrity-during-message-exchange).</span></span>

<span data-ttu-id="5923c-133">**Para autenticar el cliente por el servicio cuando un cliente se conecta**</span><span class="sxs-lookup"><span data-stu-id="5923c-133">**To authenticate the client by the service when a client connects**</span></span>

1.  <span data-ttu-id="5923c-134">Cargue un paquete de seguridad de SSPI que admita la autenticación mutua.</span><span class="sxs-lookup"><span data-stu-id="5923c-134">Load an SSPI security package that supports mutual authentication.</span></span>
2.  <span data-ttu-id="5923c-135">Cuando se conecte un cliente, use el paquete de seguridad para realizar la autenticación:</span><span class="sxs-lookup"><span data-stu-id="5923c-135">When a client connects, use the security package to perform the authentication:</span></span>
    1.  <span data-ttu-id="5923c-136">Llame a la función [**AcquireCredentialsHandle**](../SecAuthN/acquirecredentialshandle--general.md) para adquirir las credenciales del servicio.</span><span class="sxs-lookup"><span data-stu-id="5923c-136">Call the [**AcquireCredentialsHandle**](../SecAuthN/acquirecredentialshandle--general.md) function to acquire the service credentials.</span></span>
    2.  <span data-ttu-id="5923c-137">Pase las credenciales de servicio y el BLOB de seguridad recibido del cliente a la función [**AcceptSecurityContext**](../SecAuthN/acceptsecuritycontext--general.md) para generar un BLOB de seguridad que se devolverá al cliente.</span><span class="sxs-lookup"><span data-stu-id="5923c-137">Pass the service credentials and the security blob received from the client to the [**AcceptSecurityContext**](../SecAuthN/acceptsecuritycontext--general.md) function to generate a security blob to send back to the client.</span></span>
    3.  <span data-ttu-id="5923c-138">Intercambie blobs con el cliente hasta que se complete la autenticación.</span><span class="sxs-lookup"><span data-stu-id="5923c-138">Exchange blobs with the client until the authentication is complete.</span></span>
3.  <span data-ttu-id="5923c-139">Compruebe la máscara de funcionalidades devueltas para la marca de autenticación **\_ \_ mutua \_ de ASC RET** para comprobar que se realizó la autenticación mutua.</span><span class="sxs-lookup"><span data-stu-id="5923c-139">Check the returned capabilities mask for the **ASC\_RET\_MUTUAL\_AUTH** flag to verify that mutual authentication was performed.</span></span>
4.  <span data-ttu-id="5923c-140">Si la autenticación se realizó correctamente, intercambie el tráfico con el cliente autenticado.</span><span class="sxs-lookup"><span data-stu-id="5923c-140">If the authentication was successful, exchange traffic with the authenticated client.</span></span> <span data-ttu-id="5923c-141">Utilice la firma digital y el cifrado a menos que el rendimiento sea un problema.</span><span class="sxs-lookup"><span data-stu-id="5923c-141">Use digital signing and encryption unless performance is an issue.</span></span>

<span data-ttu-id="5923c-142">Para obtener más información y un ejemplo de código para este escenario de autenticación mutua, vea:</span><span class="sxs-lookup"><span data-stu-id="5923c-142">For more information and a code example for this mutual authentication scenario, see:</span></span>

-   [<span data-ttu-id="5923c-143">Cómo un cliente autentica un servicio de Windows Sockets basado en SCP</span><span class="sxs-lookup"><span data-stu-id="5923c-143">How a Client Authenticates an SCP-based Windows Sockets Service</span></span>](how-a-client-authenticates-an-scp-based-windows-sockets-service.md)
-   [<span data-ttu-id="5923c-144">Creación y registro de SPN para un servicio de Windows Sockets basado en SCP</span><span class="sxs-lookup"><span data-stu-id="5923c-144">Composing and Registering SPNs for an SCP-based Windows Sockets Service</span></span>](composing-and-registering-spns-for-an-scp-based-windows-sockets-service.md)
-   [<span data-ttu-id="5923c-145">Cómo autentica un servicio de Windows Sockets un cliente</span><span class="sxs-lookup"><span data-stu-id="5923c-145">How a Windows Sockets Service Authenticates a Client</span></span>](how-a-windows-sockets-service-authenticates-a-client.md)

<span data-ttu-id="5923c-146">Para más información, consulte:</span><span class="sxs-lookup"><span data-stu-id="5923c-146">For more information, see:</span></span>

-   [<span data-ttu-id="5923c-147">Publicar con puntos de conexión de servicio</span><span class="sxs-lookup"><span data-stu-id="5923c-147">Publishing with service connection points</span></span>](publishing-with-service-connection-points.md)
-   [<span data-ttu-id="5923c-148">Documentación de SSPI</span><span class="sxs-lookup"><span data-stu-id="5923c-148">SSPI documentation</span></span>](/windows/desktop/SecAuthN/sspi)
-   [<span data-ttu-id="5923c-149">Documentación de Windows Sockets</span><span class="sxs-lookup"><span data-stu-id="5923c-149">Windows Sockets documentation</span></span>](/windows/desktop/WinSock/windows-sockets-start-page-2)

 

 