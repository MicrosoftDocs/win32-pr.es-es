---
title: Implementación del recuento de referencias
description: Implementación del recuento de referencias
ms.assetid: d4fd98c9-afa4-4c5c-a3c9-44d34881cbdb
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a0d4dfe2b0faf2fc6557d1b089e33ae6ce4b98cb
ms.sourcegitcommit: 5f33645661bf8c825a7a2e73950b1f4ea0f1cd82
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/21/2020
ms.locfileid: "105714485"
---
# <a name="implementing-reference-counting"></a><span data-ttu-id="cdd94-103">Implementación del recuento de referencias</span><span class="sxs-lookup"><span data-stu-id="cdd94-103">Implementing Reference Counting</span></span>

<span data-ttu-id="cdd94-104">El recuento de referencias requiere trabajo en la parte del implementador de una clase y de los clientes que usan objetos de esa clase.</span><span class="sxs-lookup"><span data-stu-id="cdd94-104">Reference counting requires work on the part of both the implementor of a class and the clients who use objects of that class.</span></span> <span data-ttu-id="cdd94-105">Al implementar una clase, debe implementar los métodos [**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) y [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) como parte de la interfaz [**IUnknown**](/windows/desktop/api/Unknwn/nn-unknwn-iunknown) .</span><span class="sxs-lookup"><span data-stu-id="cdd94-105">When you implement a class, you must implement the [**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) and [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) methods as part of the [**IUnknown**](/windows/desktop/api/Unknwn/nn-unknwn-iunknown) interface.</span></span> <span data-ttu-id="cdd94-106">Estos dos métodos tienen las siguientes implementaciones simples:</span><span class="sxs-lookup"><span data-stu-id="cdd94-106">These two methods have the following simple implementations:</span></span>

-   <span data-ttu-id="cdd94-107">[**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) incrementa el recuento de referencias internas del objeto.</span><span class="sxs-lookup"><span data-stu-id="cdd94-107">[**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) increments the object's internal reference count.</span></span>
-   <span data-ttu-id="cdd94-108">[**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) primero disminuye el recuento de referencias interno del objeto y, a continuación, comprueba si el recuento de referencias ha descendido a cero.</span><span class="sxs-lookup"><span data-stu-id="cdd94-108">[**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) first decrements the object's internal reference count, and then it checks whether the reference count has fallen to zero.</span></span> <span data-ttu-id="cdd94-109">En caso afirmativo, eso significa que nadie está utilizando el objeto más, por lo que la función **Release** desasigna el objeto.</span><span class="sxs-lookup"><span data-stu-id="cdd94-109">If it has, that means no one is using the object any longer, so the **Release** function deallocates the object.</span></span>

<span data-ttu-id="cdd94-110">Un enfoque de implementación común para la mayoría de los objetos es tener solo una implementación de estos métodos (junto con [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q))), que se comparte entre todas las interfaces y, por lo tanto, un recuento de referencias que se aplica a todo el objeto.</span><span class="sxs-lookup"><span data-stu-id="cdd94-110">A common implementation approach for most objects is to have only one implementation of these methods (along with [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q))), which is shared between all interfaces, and therefore a reference count that applies to the entire object.</span></span> <span data-ttu-id="cdd94-111">Sin embargo, desde el punto de vista de un cliente, el recuento de referencias es estrictamente y claramente una noción por puntero a interfaz y, por tanto, los objetos que aprovechan esta funcionalidad mediante la construcción, destrucción, carga o descarga de partes de su funcionalidad en función de los punteros de interfaz que se pueden implementar actualmente.</span><span class="sxs-lookup"><span data-stu-id="cdd94-111">However, from a client's perspective, reference counting is strictly and clearly a per-interface-pointer notion, and therefore objects that take advantage of this capability by dynamically constructing, destroying, loading, or unloading portions of their functionality based on the currently extant interface pointers may be implemented.</span></span> <span data-ttu-id="cdd94-112">Se trata de suele denominados *interfaces de recorte*.</span><span class="sxs-lookup"><span data-stu-id="cdd94-112">These are colloquially called *tear-off interfaces*.</span></span>

<span data-ttu-id="cdd94-113">Cada vez que un cliente llama a un método (o una función de API), como [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q)), que devuelve un nuevo puntero de interfaz, el método al que se llama es responsable de incrementar el recuento de referencias a través del puntero devuelto.</span><span class="sxs-lookup"><span data-stu-id="cdd94-113">Whenever a client calls a method (or API function), such as [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q)), that returns a new interface pointer, the method being called is responsible for incrementing the reference count through the returned pointer.</span></span> <span data-ttu-id="cdd94-114">Por ejemplo, cuando un cliente crea primero un objeto, recibe un puntero de interfaz a un objeto que, desde el punto de vista del cliente, tiene un recuento de referencias de uno.</span><span class="sxs-lookup"><span data-stu-id="cdd94-114">For example, when a client first creates an object, it receives an interface pointer to an object that, from the client's point of view, has a reference count of one.</span></span> <span data-ttu-id="cdd94-115">Si el cliente llama a [**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) en el puntero de interfaz, el recuento de referencias se convierte en dos.</span><span class="sxs-lookup"><span data-stu-id="cdd94-115">If the client then calls [**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) on the interface pointer, the reference count becomes two.</span></span> <span data-ttu-id="cdd94-116">El cliente debe llamar a [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) dos veces en el puntero de interfaz para quitar todas sus referencias al objeto.</span><span class="sxs-lookup"><span data-stu-id="cdd94-116">The client must call [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) twice on the interface pointer to drop all of its references to the object.</span></span>

<span data-ttu-id="cdd94-117">Un ejemplo de cómo los recuentos de referencias son estrictamente por interfaz: puntero se produce cuando un cliente llama a [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q)) en el primer puntero para una nueva interfaz o la misma interfaz.</span><span class="sxs-lookup"><span data-stu-id="cdd94-117">An example of how reference counts are strictly per-interface-pointer occurs when a client calls [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q)) on the first pointer for either a new interface or the same interface.</span></span> <span data-ttu-id="cdd94-118">En cualquiera de estos casos, el cliente debe llamar a [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) una vez para cada puntero.</span><span class="sxs-lookup"><span data-stu-id="cdd94-118">In either of these cases, the client is required to call [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) once for each pointer.</span></span> <span data-ttu-id="cdd94-119">COM no requiere que un objeto devuelva el mismo puntero cuando se le pida varias veces la misma interfaz.</span><span class="sxs-lookup"><span data-stu-id="cdd94-119">COM does not require that an object return the same pointer when asked for the same interface multiple times.</span></span> <span data-ttu-id="cdd94-120">(La única excepción a esto es una consulta a [**IUnknown**](/windows/desktop/api/Unknwn/nn-unknwn-iunknown), que identifica un objeto a com). Esto permite que la implementación del objeto administre los recursos de forma eficaz.</span><span class="sxs-lookup"><span data-stu-id="cdd94-120">(The only exception to this is a query to [**IUnknown**](/windows/desktop/api/Unknwn/nn-unknwn-iunknown), which identifies an object to COM.) This allows the object implementation to manage resources efficiently.</span></span>

<span data-ttu-id="cdd94-121">La seguridad para subprocesos también es un problema importante en la implementación de [**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) y [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release).</span><span class="sxs-lookup"><span data-stu-id="cdd94-121">Thread-safety is also an important issue in implementing [**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) and [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release).</span></span> <span data-ttu-id="cdd94-122">Para obtener más información, consulte [procesos, subprocesos y apartamentos](processes--threads--and-apartments.md).</span><span class="sxs-lookup"><span data-stu-id="cdd94-122">For more information, see [Processes, Threads, and Apartments](processes--threads--and-apartments.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="cdd94-123">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="cdd94-123">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="cdd94-124">Administrar la duración de los objetos mediante el recuento de referencias</span><span class="sxs-lookup"><span data-stu-id="cdd94-124">Managing Object Lifetimes Through Reference Counting</span></span>](managing-object-lifetimes-through-reference-counting.md)
</dt> </dl>

 

 