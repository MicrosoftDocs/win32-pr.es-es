---
description: La programación de modo de usuario (UMS) es un mecanismo ligero que las aplicaciones pueden usar para programar sus propios subprocesos.
ms.assetid: f9dd92fe-6d7a-452c-893e-e6df1757e377
title: Programación de User-Mode
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f3ceea3c4d4e40d73f48414d074bcb5b4f6e911d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/08/2021
ms.locfileid: "105677984"
---
# <a name="user-mode-scheduling"></a><span data-ttu-id="c71f8-103">Programación de User-Mode</span><span class="sxs-lookup"><span data-stu-id="c71f8-103">User-Mode Scheduling</span></span>

<span data-ttu-id="c71f8-104">La programación de modo de usuario (UMS) es un mecanismo ligero que las aplicaciones pueden usar para programar sus propios subprocesos.</span><span class="sxs-lookup"><span data-stu-id="c71f8-104">User-mode scheduling (UMS) is a lightweight mechanism that applications can use to schedule their own threads.</span></span> <span data-ttu-id="c71f8-105">Una aplicación puede cambiar entre los subprocesos UMS en modo de usuario sin que intervenga el [programador del sistema](scheduling.md) y recuperar el control del procesador si un SUBproceso UMS se bloquea en el kernel.</span><span class="sxs-lookup"><span data-stu-id="c71f8-105">An application can switch between UMS threads in user mode without involving the [system scheduler](scheduling.md) and regain control of the processor if a UMS thread blocks in the kernel.</span></span> <span data-ttu-id="c71f8-106">Los subprocesos UMS se diferencian de las [fibras](fibers.md) en que cada subproceso UMS tiene su propio contexto de subproceso en lugar de compartir el contexto del subproceso de un solo subproceso.</span><span class="sxs-lookup"><span data-stu-id="c71f8-106">UMS threads differ from [fibers](fibers.md) in that each UMS thread has its own thread context instead of sharing the thread context of a single thread.</span></span> <span data-ttu-id="c71f8-107">La capacidad de cambiar entre subprocesos en modo de usuario hace que UMS sea más eficaz que los [grupos de subprocesos](thread-pools.md) para administrar un gran número de elementos de trabajo de corta duración que requieren pocas llamadas del sistema.</span><span class="sxs-lookup"><span data-stu-id="c71f8-107">The ability to switch between threads in user mode makes UMS more efficient than [thread pools](thread-pools.md) for managing large numbers of short-duration work items that require few system calls.</span></span>

<span data-ttu-id="c71f8-108">UMS se recomienda para las aplicaciones con requisitos de alto rendimiento que necesitan ejecutar de forma eficaz muchos subprocesos simultáneamente en sistemas multiprocesador o de varios núcleos.</span><span class="sxs-lookup"><span data-stu-id="c71f8-108">UMS is recommended for applications with high performance requirements that need to efficiently run many threads concurrently on multiprocessor or multicore systems.</span></span> <span data-ttu-id="c71f8-109">Para aprovechar las ventajas de UMS, una aplicación debe implementar un componente de programador que administre los subprocesos UMS de la aplicación y determine Cuándo deben ejecutarse.</span><span class="sxs-lookup"><span data-stu-id="c71f8-109">To take advantage of UMS, an application must implement a scheduler component that manages the application's UMS threads and determines when they should run.</span></span> <span data-ttu-id="c71f8-110">Los desarrolladores deben considerar si sus requisitos de rendimiento de la aplicación justifican el trabajo implicado en el desarrollo de este componente.</span><span class="sxs-lookup"><span data-stu-id="c71f8-110">Developers should consider whether their application performance requirements justify the work involved in developing such a component.</span></span> <span data-ttu-id="c71f8-111">Es posible que las aplicaciones con requisitos de rendimiento moderados se puedan atender mejor permitiendo que el programador del sistema Programe sus subprocesos.</span><span class="sxs-lookup"><span data-stu-id="c71f8-111">Applications with moderate performance requirements might be better served by allowing the system scheduler to schedule their threads.</span></span>

<span data-ttu-id="c71f8-112">UMS está disponible para las aplicaciones de 64 bits que se ejecutan en versiones de 64 bits de Windows 7 y Windows Server 2008 R2 o versiones posteriores de 64 bits de Windows.</span><span class="sxs-lookup"><span data-stu-id="c71f8-112">UMS is available for 64-bit applications running on 64-bit versions of Windows 7 and Windows Server 2008 R2 or later 64-bit versions of Windows.</span></span> <span data-ttu-id="c71f8-113">Esta característica no está disponible en las versiones de 32 bits de Windows.</span><span class="sxs-lookup"><span data-stu-id="c71f8-113">This feature is not available on 32-bit versions of Windows.</span></span>

<span data-ttu-id="c71f8-114">Para obtener más información, consulte las siguientes secciones:</span><span class="sxs-lookup"><span data-stu-id="c71f8-114">For details, see the following sections:</span></span>

-   [<span data-ttu-id="c71f8-115">Programador UMS</span><span class="sxs-lookup"><span data-stu-id="c71f8-115">UMS Scheduler</span></span>](#ums-scheduler)
-   [<span data-ttu-id="c71f8-116">Subproceso del programador UMS</span><span class="sxs-lookup"><span data-stu-id="c71f8-116">UMS Scheduler Thread</span></span>](#ums-scheduler-thread)
-   [<span data-ttu-id="c71f8-117">Subprocesos de trabajo UMS, contextos de subproceso y listas de finalización</span><span class="sxs-lookup"><span data-stu-id="c71f8-117">UMS Worker Threads, Thread Contexts, and Completion Lists</span></span>](#ums-worker-threads-thread-contexts-and-completion-lists)
-   [<span data-ttu-id="c71f8-118">Función de punto de entrada del programador UMS</span><span class="sxs-lookup"><span data-stu-id="c71f8-118">UMS Scheduler Entry Point Function</span></span>](#ums-scheduler-entry-point-function)
-   [<span data-ttu-id="c71f8-119">Ejecución del subproceso UMS</span><span class="sxs-lookup"><span data-stu-id="c71f8-119">UMS Thread Execution</span></span>](#ums-thread-execution)
-   [<span data-ttu-id="c71f8-120">Prácticas recomendadas de UMS</span><span class="sxs-lookup"><span data-stu-id="c71f8-120">UMS Best Practices</span></span>](#ums-best-practices)

## <a name="ums-scheduler"></a><span data-ttu-id="c71f8-121">Programador UMS</span><span class="sxs-lookup"><span data-stu-id="c71f8-121">UMS Scheduler</span></span>

<span data-ttu-id="c71f8-122">El programador UMS de una aplicación es responsable de crear, administrar y eliminar los subprocesos UMS y determinar qué subproceso UMS ejecutar.</span><span class="sxs-lookup"><span data-stu-id="c71f8-122">An application's UMS scheduler is responsible for creating, managing, and deleting UMS threads and determining which UMS thread to run.</span></span> <span data-ttu-id="c71f8-123">El programador de una aplicación realiza las siguientes tareas:</span><span class="sxs-lookup"><span data-stu-id="c71f8-123">An application's scheduler performs the following tasks:</span></span>

-   <span data-ttu-id="c71f8-124">Crea un subproceso de programador UMS para cada procesador en el que la aplicación ejecutará los subprocesos de trabajo UMS.</span><span class="sxs-lookup"><span data-stu-id="c71f8-124">Creates one UMS scheduler thread for each processor on which the application will run UMS worker threads.</span></span>
-   <span data-ttu-id="c71f8-125">Crea subprocesos de trabajo UMS para realizar el trabajo de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="c71f8-125">Creates UMS worker threads to perform the work of the application.</span></span>
-   <span data-ttu-id="c71f8-126">Mantiene su propia cola de subprocesos preparada de subprocesos de trabajo listos para ejecutarse y selecciona los subprocesos que se ejecutan en función de las directivas de programación de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="c71f8-126">Maintains its own ready-thread queue of worker threads that are ready to run, and selects threads to run based on the application's scheduling policies.</span></span>
-   <span data-ttu-id="c71f8-127">Crea y supervisa una o varias listas de finalización en las que el sistema pone en cola los subprocesos después de finalizar el procesamiento en el kernel.</span><span class="sxs-lookup"><span data-stu-id="c71f8-127">Creates and monitors one or more completion lists where the system queues threads after they finish processing in the kernel.</span></span> <span data-ttu-id="c71f8-128">Entre estos se incluyen los subprocesos de trabajo y subprocesos recién creados bloqueados previamente en una llamada del sistema que se han desbloqueado.</span><span class="sxs-lookup"><span data-stu-id="c71f8-128">These include newly created worker threads and threads previously blocked on a system call that become unblocked.</span></span>
-   <span data-ttu-id="c71f8-129">Proporciona una función de punto de entrada del programador para controlar las notificaciones del sistema.</span><span class="sxs-lookup"><span data-stu-id="c71f8-129">Provides a scheduler entry point function to handles notifications from the system.</span></span> <span data-ttu-id="c71f8-130">El sistema llama a la función de punto de entrada cuando se crea un subproceso de programador, cuando un subproceso de trabajo se bloquea en una llamada del sistema o cuando un subproceso de trabajo cede explícitamente el control.</span><span class="sxs-lookup"><span data-stu-id="c71f8-130">The system calls the entry point function when a scheduler thread is created, when a worker thread blocks on a system call, or when a worker thread explicitly yields control.</span></span>
-   <span data-ttu-id="c71f8-131">Realiza tareas de limpieza para los subprocesos de trabajo que han terminado de ejecutarse.</span><span class="sxs-lookup"><span data-stu-id="c71f8-131">Performs cleanup tasks for worker threads that have finished running.</span></span>
-   <span data-ttu-id="c71f8-132">Realiza un cierre ordenado del programador cuando lo solicita la aplicación.</span><span class="sxs-lookup"><span data-stu-id="c71f8-132">Performs an orderly shutdown of the scheduler when requested by the application.</span></span>

## <a name="ums-scheduler-thread"></a><span data-ttu-id="c71f8-133">Subproceso del programador UMS</span><span class="sxs-lookup"><span data-stu-id="c71f8-133">UMS Scheduler Thread</span></span>

<span data-ttu-id="c71f8-134">Un subproceso de programador UMS es un subproceso normal que se ha convertido en UMS mediante una llamada a la función [**EnterUmsSchedulingMode**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode) .</span><span class="sxs-lookup"><span data-stu-id="c71f8-134">A UMS scheduler thread is an ordinary thread that has converted itself to UMS by calling the [**EnterUmsSchedulingMode**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode) function.</span></span> <span data-ttu-id="c71f8-135">El programador del sistema determina cuándo se ejecuta el subproceso del programador UMS en función de su prioridad en relación con otros subprocesos listos.</span><span class="sxs-lookup"><span data-stu-id="c71f8-135">The system scheduler determines when the UMS scheduler thread runs based on its priority relative to other ready threads.</span></span> <span data-ttu-id="c71f8-136">El procesador en el que se ejecuta el subproceso del programador se ve afectado por la afinidad del subproceso, igual que para los subprocesos que no son UMS.</span><span class="sxs-lookup"><span data-stu-id="c71f8-136">The processor on which the scheduler thread runs is influenced by the thread's affinity, same as for non-UMS threads.</span></span>

<span data-ttu-id="c71f8-137">El autor de la llamada de [**EnterUmsSchedulingMode**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode) especifica una lista de finalización y una función de punto de entrada [*UmsSchedulerProc*](/windows/desktop/api/WinNT/nc-winnt-rtl_ums_scheduler_entry_point) que se va a asociar al subproceso del programador UMS.</span><span class="sxs-lookup"><span data-stu-id="c71f8-137">The caller of [**EnterUmsSchedulingMode**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode) specifies a completion list and a [*UmsSchedulerProc*](/windows/desktop/api/WinNT/nc-winnt-rtl_ums_scheduler_entry_point) entry point function to associate with the UMS scheduler thread.</span></span> <span data-ttu-id="c71f8-138">El sistema llama a la función de punto de entrada especificada cuando ha terminado de convertir el subproceso que realiza la llamada a UMS.</span><span class="sxs-lookup"><span data-stu-id="c71f8-138">The system calls the specified entry point function when it is finished converting the calling thread to UMS.</span></span> <span data-ttu-id="c71f8-139">La función de punto de entrada del programador es responsable de determinar la siguiente acción adecuada para el subproceso especificado.</span><span class="sxs-lookup"><span data-stu-id="c71f8-139">The scheduler entry point function is responsible for determining the appropriate next action for the specified thread.</span></span> <span data-ttu-id="c71f8-140">Para obtener más información, vea [función de punto de entrada del programador UMS](#ums-scheduler-entry-point-function) más adelante en este tema.</span><span class="sxs-lookup"><span data-stu-id="c71f8-140">For more information, see [UMS Scheduler Entry Point Function](#ums-scheduler-entry-point-function) later in this topic.</span></span>

<span data-ttu-id="c71f8-141">Una aplicación puede crear un subproceso de programador UMS para cada procesador que se usará para ejecutar subprocesos UMS.</span><span class="sxs-lookup"><span data-stu-id="c71f8-141">An application might create one UMS scheduler thread for each processor that will be used to run UMS threads.</span></span> <span data-ttu-id="c71f8-142">La aplicación también podría establecer la afinidad de cada subproceso del programador UMS para un procesador lógico específico, lo que tiende a excluir subprocesos no relacionados que se ejecutan en ese procesador y que, de hecho, lo reservan para ese subproceso del programador.</span><span class="sxs-lookup"><span data-stu-id="c71f8-142">The application might also set the affinity of each UMS scheduler thread for a specific logical processor, which tends to exclude unrelated threads from running on that processor, effectively reserving it for that scheduler thread.</span></span> <span data-ttu-id="c71f8-143">Tenga en cuenta que establecer la afinidad de subprocesos de este modo puede afectar al rendimiento global del sistema al privar a otros procesos que se puedan estar ejecutando en el sistema.</span><span class="sxs-lookup"><span data-stu-id="c71f8-143">Be aware that setting thread affinity in this way can affect overall system performance by starving other processes that may be running on the system.</span></span> <span data-ttu-id="c71f8-144">Para obtener más información acerca de la afinidad de subprocesos, vea [varios procesadores](multiple-processors.md).</span><span class="sxs-lookup"><span data-stu-id="c71f8-144">For more information about thread affinity, see [Multiple Processors](multiple-processors.md).</span></span>

## <a name="ums-worker-threads-thread-contexts-and-completion-lists"></a><span data-ttu-id="c71f8-145">Subprocesos de trabajo UMS, contextos de subproceso y listas de finalización</span><span class="sxs-lookup"><span data-stu-id="c71f8-145">UMS Worker Threads, Thread Contexts, and Completion Lists</span></span>

<span data-ttu-id="c71f8-146">Un subproceso de trabajo UMS se crea mediante una llamada a [**CreateRemoteThreadEx**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethreadex) con el atributo de subproceso de procedimiento \_ \_ \_ UMS \_ y especifica un contexto de subproceso UMS y una lista de finalización.</span><span class="sxs-lookup"><span data-stu-id="c71f8-146">A UMS worker thread is created by calling [**CreateRemoteThreadEx**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethreadex) with the PROC\_THREAD\_ATTRIBUTE\_UMS\_THREAD attribute and specifying a UMS thread context and a completion list.</span></span>

<span data-ttu-id="c71f8-147">Un contexto de subproceso UMS representa el estado de subproceso UMS de un subproceso de trabajo y se usa para identificar el subproceso de trabajo en las llamadas a funciones UMS.</span><span class="sxs-lookup"><span data-stu-id="c71f8-147">A UMS thread context represents the UMS thread state of a worker thread and is used to identify the worker thread in UMS function calls.</span></span> <span data-ttu-id="c71f8-148">Se crea llamando a [**CreateUmsThreadContext**](/windows/desktop/api/WinBase/nf-winbase-createumsthreadcontext).</span><span class="sxs-lookup"><span data-stu-id="c71f8-148">It is created by calling [**CreateUmsThreadContext**](/windows/desktop/api/WinBase/nf-winbase-createumsthreadcontext).</span></span>

<span data-ttu-id="c71f8-149">Una lista de finalización se crea mediante una llamada a la función [**CreateUmsCompletionList**](/windows/desktop/api/WinBase/nf-winbase-createumscompletionlist) .</span><span class="sxs-lookup"><span data-stu-id="c71f8-149">A completion list is created by calling the [**CreateUmsCompletionList**](/windows/desktop/api/WinBase/nf-winbase-createumscompletionlist) function.</span></span> <span data-ttu-id="c71f8-150">Una lista de finalización recibe los subprocesos de trabajo de UMS que han completado la ejecución en el kernel y están listos para ejecutarse en modo de usuario.</span><span class="sxs-lookup"><span data-stu-id="c71f8-150">A completion list receives UMS worker threads that have completed execution in the kernel and are ready to run in user mode.</span></span> <span data-ttu-id="c71f8-151">Solo el sistema puede poner en cola los subprocesos de trabajo en una lista de finalización.</span><span class="sxs-lookup"><span data-stu-id="c71f8-151">Only the system can queue worker threads to a completion list.</span></span> <span data-ttu-id="c71f8-152">Los nuevos subprocesos de trabajo UMS se ponen en cola automáticamente en la lista de finalización especificada cuando se crearon los subprocesos.</span><span class="sxs-lookup"><span data-stu-id="c71f8-152">New UMS worker threads are automatically queued to the completion list specified when the threads were created.</span></span> <span data-ttu-id="c71f8-153">Los subprocesos de trabajo previamente bloqueados también se ponen en cola en la lista de finalización cuando ya no se bloquean.</span><span class="sxs-lookup"><span data-stu-id="c71f8-153">Previously blocked worker threads are also queued to the completion list when they are no longer blocked.</span></span>

<span data-ttu-id="c71f8-154">Cada subproceso del programador UMS está asociado a una sola lista de finalización.</span><span class="sxs-lookup"><span data-stu-id="c71f8-154">Each UMS scheduler thread is associated with a single completion list.</span></span> <span data-ttu-id="c71f8-155">Sin embargo, la misma lista de finalización se puede asociar a cualquier número de subprocesos del programador UMS y un subproceso del programador puede recuperar contextos UMS de cualquier lista de finalización para la que tenga un puntero.</span><span class="sxs-lookup"><span data-stu-id="c71f8-155">However, the same completion list can be associated with any number of UMS scheduler threads, and a scheduler thread can retrieve UMS contexts from any completion list for which it has a pointer.</span></span>

<span data-ttu-id="c71f8-156">Cada lista de finalización tiene un evento asociado que el sistema señala cuando pone en cola uno o más subprocesos de trabajo en una lista vacía.</span><span class="sxs-lookup"><span data-stu-id="c71f8-156">Each completion list has an associated event that is signaled by the system when it queues one or more worker threads to an empty list.</span></span> <span data-ttu-id="c71f8-157">La función [**GetUmsCompletionListEvent**](/windows/desktop/api/WinBase/nf-winbase-getumscompletionlistevent) recupera un identificador para el evento para una lista de finalización especificada.</span><span class="sxs-lookup"><span data-stu-id="c71f8-157">The [**GetUmsCompletionListEvent**](/windows/desktop/api/WinBase/nf-winbase-getumscompletionlistevent) function retrieves a handle to the event for a specified completion list.</span></span> <span data-ttu-id="c71f8-158">Una aplicación puede esperar en más de un evento de lista de finalización junto con otros eventos que tienen sentido para la aplicación.</span><span class="sxs-lookup"><span data-stu-id="c71f8-158">An application can wait on more than one completion list event along with other events that make sense for the application.</span></span>

## <a name="ums-scheduler-entry-point-function"></a><span data-ttu-id="c71f8-159">Función de punto de entrada del programador UMS</span><span class="sxs-lookup"><span data-stu-id="c71f8-159">UMS Scheduler Entry Point Function</span></span>

<span data-ttu-id="c71f8-160">La función de punto de entrada del programador de una aplicación se implementa como una función [*UmsSchedulerProc*](/windows/desktop/api/WinNT/nc-winnt-rtl_ums_scheduler_entry_point) .</span><span class="sxs-lookup"><span data-stu-id="c71f8-160">An application's scheduler entry point function is implemented as a [*UmsSchedulerProc*](/windows/desktop/api/WinNT/nc-winnt-rtl_ums_scheduler_entry_point) function.</span></span> <span data-ttu-id="c71f8-161">El sistema llama a la función de punto de entrada del programador de la aplicación en las siguientes ocasiones:</span><span class="sxs-lookup"><span data-stu-id="c71f8-161">The system calls the application's scheduler entry point function at the following times:</span></span>

-   <span data-ttu-id="c71f8-162">Cuando un subproceso que no es UMS se convierte en un subproceso del programador UMS llamando a [**EnterUmsSchedulingMode**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode).</span><span class="sxs-lookup"><span data-stu-id="c71f8-162">When a non-UMS thread is converted to a UMS scheduler thread by calling [**EnterUmsSchedulingMode**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode).</span></span>
-   <span data-ttu-id="c71f8-163">Cuando un subproceso de trabajo UMS llama a [**UmsThreadYield**](/windows/desktop/api/WinBase/nf-winbase-umsthreadyield).</span><span class="sxs-lookup"><span data-stu-id="c71f8-163">When a UMS worker thread calls [**UmsThreadYield**](/windows/desktop/api/WinBase/nf-winbase-umsthreadyield).</span></span>
-   <span data-ttu-id="c71f8-164">Cuando un subproceso de trabajo UMS se bloquea en un servicio del sistema, como una llamada del sistema o un error de página.</span><span class="sxs-lookup"><span data-stu-id="c71f8-164">When a UMS worker thread blocks on a system service such as a system call or a page fault.</span></span>

<span data-ttu-id="c71f8-165">El parámetro *Reason* de la función [*UmsSchedulerProc*](/windows/desktop/api/WinNT/nc-winnt-rtl_ums_scheduler_entry_point) especifica la razón por la que se llamó a la función de punto de entrada.</span><span class="sxs-lookup"><span data-stu-id="c71f8-165">The *Reason* parameter of the [*UmsSchedulerProc*](/windows/desktop/api/WinNT/nc-winnt-rtl_ums_scheduler_entry_point) function specifies the reason that the entry point function was called.</span></span> <span data-ttu-id="c71f8-166">Si se llamó a la función de punto de entrada porque se creó un nuevo subproceso de programador UMS, el parámetro *SchedulerParam* contiene los datos especificados por el autor de la llamada de [**EnterUmsSchedulingMode**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode).</span><span class="sxs-lookup"><span data-stu-id="c71f8-166">If the entry point function was called because a new UMS scheduler thread was created, the *SchedulerParam* parameter contains data specified by the caller of [**EnterUmsSchedulingMode**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode).</span></span> <span data-ttu-id="c71f8-167">Si se llamó a la función de punto de entrada porque se produjo un subproceso de trabajo UMS, el parámetro *SchedulerParam* contiene los datos especificados por el autor de la llamada de [**UmsThreadYield**](/windows/desktop/api/WinBase/nf-winbase-umsthreadyield).</span><span class="sxs-lookup"><span data-stu-id="c71f8-167">If the entry point function was called because a UMS worker thread yielded, the *SchedulerParam* parameter contains data specified by the caller of [**UmsThreadYield**](/windows/desktop/api/WinBase/nf-winbase-umsthreadyield).</span></span> <span data-ttu-id="c71f8-168">Si se llamó a la función de punto de entrada porque un subproceso de trabajo UMS se bloqueó en el kernel, el parámetro *SchedulerParam* es NULL.</span><span class="sxs-lookup"><span data-stu-id="c71f8-168">If the entry point function was called because a UMS worker thread blocked in the kernel, the *SchedulerParam* parameter is NULL.</span></span>

<span data-ttu-id="c71f8-169">La función de punto de entrada del programador es responsable de determinar la siguiente acción adecuada para el subproceso especificado.</span><span class="sxs-lookup"><span data-stu-id="c71f8-169">The scheduler entry point function is responsible for determining the appropriate next action for the specified thread.</span></span> <span data-ttu-id="c71f8-170">Por ejemplo, si se bloquea un subproceso de trabajo, la función de punto de entrada del programador podría ejecutar el siguiente subproceso de trabajo UMS listo y disponible.</span><span class="sxs-lookup"><span data-stu-id="c71f8-170">For example, if a worker thread is blocked, the scheduler entry point function might run the next available ready UMS worker thread.</span></span>

<span data-ttu-id="c71f8-171">Cuando se llama a la función de punto de entrada del programador, el programador de la aplicación debe intentar recuperar todos los elementos de la lista de finalización asociada llamando a la función [**DequeueUmsCompletionListItems**](/windows/desktop/api/WinBase/nf-winbase-dequeueumscompletionlistitems) .</span><span class="sxs-lookup"><span data-stu-id="c71f8-171">When the scheduler entry point function is called, the application's scheduler should attempt to retrieve all of the items in its associated completion list by calling the [**DequeueUmsCompletionListItems**](/windows/desktop/api/WinBase/nf-winbase-dequeueumscompletionlistitems) function.</span></span> <span data-ttu-id="c71f8-172">Esta función recupera una lista de contextos de subprocesos UMS que han terminado de procesarse en el kernel y están listos para ejecutarse en modo de usuario.</span><span class="sxs-lookup"><span data-stu-id="c71f8-172">This function retrieves a list of UMS thread contexts that have finished processing in the kernel and are ready to run in user mode.</span></span> <span data-ttu-id="c71f8-173">El programador de la aplicación no debe ejecutar los subprocesos UMS directamente desde esta lista, ya que esto puede provocar un comportamiento imprevisible en la aplicación.</span><span class="sxs-lookup"><span data-stu-id="c71f8-173">The application's scheduler should not run UMS threads directly from this list because this can cause unpredictable behavior in the application.</span></span> <span data-ttu-id="c71f8-174">En su lugar, el programador debe recuperar todos los contextos de subprocesos UMS llamando a la función [**GetNextUmsListItem**](/windows/desktop/api/WinBase/nf-winbase-getnextumslistitem) una vez para cada contexto, inserte los contextos de subproceso UMS en la cola de subprocesos preparada del programador y, a continuación, ejecute únicamente los subprocesos UMS desde la cola de subprocesos listos.</span><span class="sxs-lookup"><span data-stu-id="c71f8-174">Instead, the scheduler should retrieve all UMS thread contexts by calling the [**GetNextUmsListItem**](/windows/desktop/api/WinBase/nf-winbase-getnextumslistitem) function once for each context, insert the UMS thread contexts in the scheduler’s ready thread queue, and only then run UMS threads from the ready thread queue.</span></span>

<span data-ttu-id="c71f8-175">Si el programador no necesita esperar en varios eventos, debe llamar a [**DequeueUmsCompletionListItems**](/windows/desktop/api/WinBase/nf-winbase-dequeueumscompletionlistitems) con un parámetro de tiempo de espera distinto de cero para que la función espere en el evento de lista de finalización antes de devolver.</span><span class="sxs-lookup"><span data-stu-id="c71f8-175">If the scheduler does not need to wait on multiple events, it should call [**DequeueUmsCompletionListItems**](/windows/desktop/api/WinBase/nf-winbase-dequeueumscompletionlistitems) with a nonzero timeout parameter so the function waits on the completion list event before returning.</span></span> <span data-ttu-id="c71f8-176">Si el programador necesita esperar en varios eventos de lista de finalización, debe llamar a **DequeueUmsCompletionListItems** con un parámetro de tiempo de espera de cero para que la función se devuelva inmediatamente, incluso si la lista de finalización está vacía.</span><span class="sxs-lookup"><span data-stu-id="c71f8-176">If the scheduler does need to wait on multiple completion list events, it should call **DequeueUmsCompletionListItems** with a timeout parameter of zero so the function returns immediately, even if the completion list is empty.</span></span> <span data-ttu-id="c71f8-177">En este caso, el programador puede esperar explícitamente los eventos de la lista de finalización, por ejemplo, mediante [**WaitForMultipleObjects**](/windows/win32/api/synchapi/nf-synchapi-waitformultipleobjects).</span><span class="sxs-lookup"><span data-stu-id="c71f8-177">In this case, the scheduler can wait explicitly on completion list events, for example, by using [**WaitForMultipleObjects**](/windows/win32/api/synchapi/nf-synchapi-waitformultipleobjects).</span></span>

## <a name="ums-thread-execution"></a><span data-ttu-id="c71f8-178">Ejecución del subproceso UMS</span><span class="sxs-lookup"><span data-stu-id="c71f8-178">UMS Thread Execution</span></span>

<span data-ttu-id="c71f8-179">Un subproceso de trabajo UMS recién creado se pone en la cola de la lista de finalización especificada y no comienza a ejecutarse hasta que el programador UMS de la aplicación lo selecciona para ejecutarse.</span><span class="sxs-lookup"><span data-stu-id="c71f8-179">A newly created UMS worker thread is queued to the specified completion list and does not begin running until the application's UMS scheduler selects it to run.</span></span> <span data-ttu-id="c71f8-180">Esto difiere de los subprocesos que no son UMS, que el programador de sistema programa automáticamente para ejecutarse, a menos que el llamador cree explícitamente el subproceso suspendido.</span><span class="sxs-lookup"><span data-stu-id="c71f8-180">This differs from non-UMS threads, which the system scheduler automatically schedules to run unless the caller explicitly creates the thread suspended.</span></span>

<span data-ttu-id="c71f8-181">Scheduler ejecuta un subproceso de trabajo mediante una llamada a [**ExecuteUmsThread**](/windows/desktop/api/WinBase/nf-winbase-executeumsthread) con el contexto UMS del subproceso de trabajo.</span><span class="sxs-lookup"><span data-stu-id="c71f8-181">The scheduler runs a worker thread by calling [**ExecuteUmsThread**](/windows/desktop/api/WinBase/nf-winbase-executeumsthread) with the worker thread's UMS context.</span></span> <span data-ttu-id="c71f8-182">Un subproceso de trabajo UMS se ejecuta hasta que produce una llamada a la función [**UmsThreadYield**](/windows/desktop/api/WinBase/nf-winbase-umsthreadyield) , bloques o finaliza.</span><span class="sxs-lookup"><span data-stu-id="c71f8-182">A UMS worker thread runs until it yields by calling the [**UmsThreadYield**](/windows/desktop/api/WinBase/nf-winbase-umsthreadyield) function, blocks, or terminates.</span></span>

## <a name="ums-best-practices"></a><span data-ttu-id="c71f8-183">Prácticas recomendadas de UMS</span><span class="sxs-lookup"><span data-stu-id="c71f8-183">UMS Best Practices</span></span>

<span data-ttu-id="c71f8-184">Las aplicaciones que implementan UMS deben seguir estos procedimientos recomendados:</span><span class="sxs-lookup"><span data-stu-id="c71f8-184">Applications that implement UMS should follow these best practices:</span></span>

-   <span data-ttu-id="c71f8-185">El sistema administra las estructuras subyacentes para los contextos de subprocesos UMS y no se debe modificar directamente.</span><span class="sxs-lookup"><span data-stu-id="c71f8-185">The underlying structures for UMS thread contexts are managed by the system and should not be modified directly.</span></span> <span data-ttu-id="c71f8-186">En su lugar, use [**QueryUmsThreadInformation**](/windows/desktop/api/WinBase/nf-winbase-queryumsthreadinformation) y [**SetUmsThreadInformation**](/windows/desktop/api/WinBase/nf-winbase-setumsthreadinformation) para recuperar y establecer información acerca de un subproceso de trabajo UMS.</span><span class="sxs-lookup"><span data-stu-id="c71f8-186">Instead, use [**QueryUmsThreadInformation**](/windows/desktop/api/WinBase/nf-winbase-queryumsthreadinformation) and [**SetUmsThreadInformation**](/windows/desktop/api/WinBase/nf-winbase-setumsthreadinformation) to retrieve and set information about a UMS worker thread.</span></span>
-   <span data-ttu-id="c71f8-187">Para ayudar a evitar los interbloqueos, el subproceso del programador UMS no debe compartir bloqueos con subprocesos de trabajo UMS.</span><span class="sxs-lookup"><span data-stu-id="c71f8-187">To help prevent deadlocks, the UMS scheduler thread should not share locks with UMS worker threads.</span></span> <span data-ttu-id="c71f8-188">Esto incluye tanto los bloqueos creados por la aplicación como los bloqueos del sistema adquiridos indirectamente por operaciones como la asignación del montón o la carga de archivos dll.</span><span class="sxs-lookup"><span data-stu-id="c71f8-188">This includes both application-created locks and system locks that are acquired indirectly by operations such as allocating from the heap or loading DLLs.</span></span> <span data-ttu-id="c71f8-189">Por ejemplo, supongamos que Scheduler ejecuta un subproceso de trabajo UMS que carga un archivo DLL.</span><span class="sxs-lookup"><span data-stu-id="c71f8-189">For example, suppose the scheduler runs a UMS worker thread that loads a DLL.</span></span> <span data-ttu-id="c71f8-190">El subproceso de trabajo adquiere el bloqueo y los bloques del cargador.</span><span class="sxs-lookup"><span data-stu-id="c71f8-190">The worker thread acquires the loader lock and blocks.</span></span> <span data-ttu-id="c71f8-191">El sistema llama a la función de punto de entrada del programador, que luego carga un archivo DLL.</span><span class="sxs-lookup"><span data-stu-id="c71f8-191">The system calls the scheduler entry point function, which then loads a DLL.</span></span> <span data-ttu-id="c71f8-192">Esto provoca un interbloqueo, porque el bloqueo del cargador ya se mantiene y no se puede liberar hasta que el primer subproceso se desbloquea.</span><span class="sxs-lookup"><span data-stu-id="c71f8-192">This causes a deadlock, because the loader lock is already held and cannot be released until the first thread unblocks.</span></span> <span data-ttu-id="c71f8-193">Para evitar este problema, delegue el trabajo que podría compartir bloqueos con subprocesos de trabajo UMS en un subproceso de trabajo UMS dedicado o en un subproceso no UMS.</span><span class="sxs-lookup"><span data-stu-id="c71f8-193">To help avoid this problem, delegate work that might share locks with UMS worker threads to a dedicated UMS worker thread or a non-UMS thread.</span></span>
-   <span data-ttu-id="c71f8-194">UMS es más eficaz cuando la mayor parte del procesamiento se realiza en modo de usuario.</span><span class="sxs-lookup"><span data-stu-id="c71f8-194">UMS is most efficient when most processing is done in user mode.</span></span> <span data-ttu-id="c71f8-195">Siempre que sea posible, Evite realizar llamadas del sistema en subprocesos de trabajo UMS.</span><span class="sxs-lookup"><span data-stu-id="c71f8-195">Whenever possible, avoid making system calls in UMS worker threads.</span></span>
-   <span data-ttu-id="c71f8-196">Los subprocesos de trabajo UMS no deben asumir que se está usando el programador del sistema.</span><span class="sxs-lookup"><span data-stu-id="c71f8-196">UMS worker threads should not assume the system scheduler is being used.</span></span> <span data-ttu-id="c71f8-197">Esta suposición puede tener efectos sutiles; por ejemplo, si un subproceso en el código desconocido establece una prioridad o afinidad de subprocesos, el programador UMS podría reemplazarlo.</span><span class="sxs-lookup"><span data-stu-id="c71f8-197">This assumption can have subtle effects; for example, if a thread in the unknown code sets a thread priority or affinity, the UMS scheduler might still override it.</span></span> <span data-ttu-id="c71f8-198">Es posible que el código que supone el uso del programador del sistema no se comporte de la manera esperada y que se interrumpa cuando lo llame un subproceso UMS.</span><span class="sxs-lookup"><span data-stu-id="c71f8-198">Code that assumes the system scheduler is being used may not behave as expected and may break when called by a UMS thread.</span></span>
-   <span data-ttu-id="c71f8-199">Es posible que el sistema tenga que bloquear el contexto del subproceso de un subproceso de trabajo UMS.</span><span class="sxs-lookup"><span data-stu-id="c71f8-199">The system may need to lock the thread context of a UMS worker thread.</span></span> <span data-ttu-id="c71f8-200">Por ejemplo, una llamada a procedimiento asincrónico (APC) en modo kernel podría cambiar el contexto del subproceso UMS, por lo que el contexto del subproceso debe estar bloqueado.</span><span class="sxs-lookup"><span data-stu-id="c71f8-200">For example, a kernel-mode asynchronous procedure call (APC) might change the context of the UMS thread, so the thread context must be locked.</span></span> <span data-ttu-id="c71f8-201">Si Scheduler intenta ejecutar el contexto del subproceso UMS mientras está bloqueado, se producirá un error en la llamada.</span><span class="sxs-lookup"><span data-stu-id="c71f8-201">If the scheduler tries to execute the UMS thread context while it is locked, the call will fail.</span></span> <span data-ttu-id="c71f8-202">Este comportamiento es así por diseño y el programador debe estar diseñado para reintentar el acceso al contexto del subproceso UMS.</span><span class="sxs-lookup"><span data-stu-id="c71f8-202">This behavior is by design, and the scheduler should be designed to retry access to the UMS thread context.</span></span>

 

 
