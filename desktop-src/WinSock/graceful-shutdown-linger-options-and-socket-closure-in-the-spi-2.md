---
description: Es importante distinguir entre apagar una conexión de socket y cerrar un socket.
ms.assetid: f076b1ec-6b96-4386-8519-4728e0a2b1ff
title: Cierre estable, opciones de permanencia y cierre de sockets en el SPI
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 743cae48977421c08611c79053520799420e9e72
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/07/2021
ms.locfileid: "104541579"
---
# <a name="graceful-shutdown-linger-options-and-socket-closure-in-the-spi"></a><span data-ttu-id="65b15-103">Cierre estable, opciones de permanencia y cierre de sockets en el SPI</span><span class="sxs-lookup"><span data-stu-id="65b15-103">Graceful Shutdown, Linger Options, and Socket Closure in the SPI</span></span>

<span data-ttu-id="65b15-104">Es importante distinguir entre apagar una conexión de socket y cerrar un socket.</span><span class="sxs-lookup"><span data-stu-id="65b15-104">It is important to distinguish between shutting down a socket connection and closing a socket.</span></span> <span data-ttu-id="65b15-105">Cerrar una conexión de socket implica un intercambio de mensajes de protocolo entre los dos extremos, lo que se conoce en adelante como una secuencia de cierre.</span><span class="sxs-lookup"><span data-stu-id="65b15-105">Shutting down a socket connection involves an exchange of protocol messages between the two endpoints, which is hereafter referred to as a shutdown sequence.</span></span> <span data-ttu-id="65b15-106">Se definen dos clases generales de secuencias de cierre: correcto y anulación.</span><span class="sxs-lookup"><span data-stu-id="65b15-106">Two general classes of shutdown sequences are defined: graceful and abortive.</span></span> <span data-ttu-id="65b15-107">En una secuencia de cierre correcto, cualquier dato que se haya puesto en cola pero que todavía no se haya transmitido se puede enviar antes de que se cierre la conexión.</span><span class="sxs-lookup"><span data-stu-id="65b15-107">In a graceful shutdown sequence, any data that has been queued but not yet transmitted can be sent prior to the connection being closed.</span></span> <span data-ttu-id="65b15-108">En un cierre anulado, se pierden los datos no enviados.</span><span class="sxs-lookup"><span data-stu-id="65b15-108">In an abortive shutdown, any unsent data is lost.</span></span> <span data-ttu-id="65b15-109">La aparición de una secuencia de apagado (correcta o anulación) también se puede usar para proporcionar una \_ indicación de cierre FD a las aplicaciones asociadas, lo que significa que hay un apagado en curso.</span><span class="sxs-lookup"><span data-stu-id="65b15-109">The occurrence of a shutdown sequence (graceful or abortive) can also be used to provide an FD\_CLOSE indication to the associated applications signifying that a shutdown is in progress.</span></span> <span data-ttu-id="65b15-110">Al cerrar un socket, por otro lado, el controlador de socket se desasigna para que la aplicación ya no pueda hacer referencia o usar el socket de ninguna manera.</span><span class="sxs-lookup"><span data-stu-id="65b15-110">Closing a socket, on the other hand, causes the socket handle to become deallocated so that the application can no longer reference or use the socket in any manner.</span></span>

<span data-ttu-id="65b15-111">En Windows Sockets, la función [**WSPShutdown**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85)) y la función [**WSPSendDisconnect**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85)) se pueden usar para iniciar una secuencia de apagado, mientras que la función [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)) se usa para desasignar identificadores de socket y liberar los recursos asociados.</span><span class="sxs-lookup"><span data-stu-id="65b15-111">In Windows Sockets, both the [**WSPShutdown**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85)) function and the [**WSPSendDisconnect**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85)) function can be used to initiate a shutdown sequence, while the [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)) function is used to deallocate socket handles and free up any associated resources.</span></span> <span data-ttu-id="65b15-112">Sin embargo, se produce cierto número de confusión, desde el hecho de que la función **WSPCloseSocket** provocará implícitamente que se produzca una secuencia de cierre si aún no se ha producido.</span><span class="sxs-lookup"><span data-stu-id="65b15-112">Some amount of confusion arises, however, from the fact that the **WSPCloseSocket** function will implicitly cause a shutdown sequence to occur if it has not already happened.</span></span> <span data-ttu-id="65b15-113">De hecho, se ha convertido en una práctica de programación bastante común que se basa en esta característica y se usa **WSPCloseSocket** para iniciar la secuencia de apagado y desasignar el identificador de socket.</span><span class="sxs-lookup"><span data-stu-id="65b15-113">In fact, it has become a rather common programming practice to rely on this feature and use **WSPCloseSocket** to both initiate the shutdown sequence and deallocate the socket handle.</span></span>

<span data-ttu-id="65b15-114">Para facilitar este uso, la interfaz de sockets proporciona controles a través del mecanismo de opción de socket que permite al programador indicar si la secuencia de apagado implícita debe ser correcta o anulada, y también si la función debe ser persistente, no completada inmediatamente, para dejar tiempo para que se complete una secuencia de cierre correcto.</span><span class="sxs-lookup"><span data-stu-id="65b15-114">To facilitate this usage, the sockets interface provides for controls through the socket option mechanism that allows the programmer to indicate whether the implicit shutdown sequence should be graceful or abortive, and also whether the function should linger that is, not complete immediately) to allow time for a graceful shutdown sequence to complete.</span></span>

<span data-ttu-id="65b15-115">Mediante el establecimiento de los valores adecuados para las opciones de socket, por lo tanto \_ \_ , DONTLINGER, se pueden obtener los siguientes tipos de comportamiento con la función [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)) .</span><span class="sxs-lookup"><span data-stu-id="65b15-115">By establishing appropriate values for the socket options SO\_LINGER and SO\_DONTLINGER, the following types of behavior can be obtained with the [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)) function.</span></span>

-   <span data-ttu-id="65b15-116">Secuencia de apagado anulada, devolución inmediata desde [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)).</span><span class="sxs-lookup"><span data-stu-id="65b15-116">Abortive shutdown sequence, immediate return from [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)).</span></span>
-   <span data-ttu-id="65b15-117">Cierre estable, retrasar la devolución hasta que finalice la secuencia de cierre o transcurra un intervalo de tiempo especificado.</span><span class="sxs-lookup"><span data-stu-id="65b15-117">Graceful shutdown, delay return until either shutdown sequence completes or a specified time interval elapses.</span></span> <span data-ttu-id="65b15-118">Si el intervalo de tiempo expira antes de que se complete la secuencia de cierre correcto, se produce una secuencia de apagado anulado y [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)) devuelve.</span><span class="sxs-lookup"><span data-stu-id="65b15-118">If the time interval expires before the graceful shutdown sequence completes, an abortive shutdown sequence occurs and [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)) returns.</span></span>
-   <span data-ttu-id="65b15-119">Cierre estable, vuelva inmediatamente y permita que la secuencia de apagado se complete en segundo plano.</span><span class="sxs-lookup"><span data-stu-id="65b15-119">Graceful shutdown, return immediately, and allow the shutdown sequence to complete in the background.</span></span> <span data-ttu-id="65b15-120">Este es el comportamiento predeterminado.</span><span class="sxs-lookup"><span data-stu-id="65b15-120">This is the default behavior.</span></span> <span data-ttu-id="65b15-121">Tenga en cuenta, sin embargo, que la aplicación no tiene ninguna manera de saber cuándo se completa la secuencia de cierre correcto.</span><span class="sxs-lookup"><span data-stu-id="65b15-121">Note, however, that the application has no way of knowing when (or whether) the graceful shutdown sequence completes.</span></span>

<span data-ttu-id="65b15-122">Una técnica que se puede usar para minimizar la posibilidad de que se produzcan problemas durante la destrucción de la conexión no depende de que [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85))inicie un cierre implícito.</span><span class="sxs-lookup"><span data-stu-id="65b15-122">One technique that can be used to minimize the chance of problems occurring during connection teardown is not to rely on an implicit shutdown being initiated by [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)).</span></span> <span data-ttu-id="65b15-123">En su lugar, se usa una de las dos funciones de cierre explícitas ([**WSPShutdown**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85)) o [**WSPSendDisconnect**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85))).</span><span class="sxs-lookup"><span data-stu-id="65b15-123">Instead, one of the two explicit shutdown functions ([**WSPShutdown**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85)) or [**WSPSendDisconnect**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85))) are used.</span></span> <span data-ttu-id="65b15-124">Esto, a su vez, provocará que \_ la aplicación del mismo nivel reciba una indicación de cierre FD que indica que se han recibido todos los datos pendientes.</span><span class="sxs-lookup"><span data-stu-id="65b15-124">This in turn will cause an FD\_CLOSE indication to be received by the peer application indicating that all pending data has been received.</span></span> <span data-ttu-id="65b15-125">Para ilustrar esto, en la tabla siguiente se muestran las funciones que invocarían los componentes de cliente y servidor de una aplicación, donde el cliente es responsable de iniciar un cierre estable.</span><span class="sxs-lookup"><span data-stu-id="65b15-125">To illustrate this, the following table shows the functions that would be invoked by the client and server components of an application, where the client is responsible for initiating a graceful shutdown.</span></span>

| <span data-ttu-id="65b15-126">En el cliente</span><span class="sxs-lookup"><span data-stu-id="65b15-126">Client side</span></span>                                                                                                                         | <span data-ttu-id="65b15-127">En el servidor</span><span class="sxs-lookup"><span data-stu-id="65b15-127">Server side</span></span>                                                                                                  |
|-------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="65b15-128">(1) invoca [**WSPShutdown**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85)) (*s*, SD \_ send) para señalar el final de la sesión y ese cliente no tiene más datos para enviar.</span><span class="sxs-lookup"><span data-stu-id="65b15-128">(1) Invokes [**WSPShutdown**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85)) (*s*, SD\_SEND) to signal end of session and that client has no more data to send.</span></span> |                                                                                                              |
|                                                                                                                                     | <span data-ttu-id="65b15-129">(2) recibe FD \_ Close, lo que indica un cierre correcto en curso y que se han recibido todos los datos.</span><span class="sxs-lookup"><span data-stu-id="65b15-129">(2) Receives FD\_CLOSE, indicating graceful shutdown in progress and that all data has been received.</span></span>        |
|                                                                                                                                     | <span data-ttu-id="65b15-130">(3) envía los datos de respuesta restantes.</span><span class="sxs-lookup"><span data-stu-id="65b15-130">(3) Sends any remaining response data.</span></span>                                                                       |
| <span data-ttu-id="65b15-131">(5 ') obtiene FD \_ Read e Invoke RECV para obtener los datos de respuesta enviados por el servidor.</span><span class="sxs-lookup"><span data-stu-id="65b15-131">(5') Gets FD\_READ and invoke recv to get any response data sent by server.</span></span>                                                         | <span data-ttu-id="65b15-132">(4) invoca [**WSPShutdown**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85))(*s*, SD \_ send) para indicar que el servidor no tiene más datos para enviar.</span><span class="sxs-lookup"><span data-stu-id="65b15-132">(4) Invokes [**WSPShutdown**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85))(*s*, SD\_SEND) to indicate server has no more data to send.</span></span> |
| <span data-ttu-id="65b15-133">(5) recibe la \_ indicación FD de cierre.</span><span class="sxs-lookup"><span data-stu-id="65b15-133">(5) Receives FD\_CLOSE indication.</span></span>                                                                                                  | <span data-ttu-id="65b15-134">(4 ') invoca [ **WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85))</span><span class="sxs-lookup"><span data-stu-id="65b15-134">(4') Invokes [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85))</span></span>                                                      |
| <span data-ttu-id="65b15-135">(6) invoca [ **WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85))</span><span class="sxs-lookup"><span data-stu-id="65b15-135">(6) Invokes [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85))</span></span>                                                                              |                                                                                                              |



 

<span data-ttu-id="65b15-136">La secuencia de tiempo se mantiene del paso (1) al paso (6) entre el cliente y el servidor. excepto en el caso de los pasos (4 ') y (5 '), que solo tienen una importancia en el tiempo local en el sentido de que el paso (5) sigue al paso (5 ') en el lado cliente mientras el paso (4 ') sigue el paso (4) en el lado servidor, sin relación de tiempo con la parte remota.</span><span class="sxs-lookup"><span data-stu-id="65b15-136">The timing sequence is maintained from step (1) to step (6) between the client and the server, except for steps (4') and (5') which only have local timing significance in the sense that step (5) follows step (5') on the client side while step (4') follows step (4) on the server side, with no timing relationship with the remote party.</span></span>

 

 
