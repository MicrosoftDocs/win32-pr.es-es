---
description: Un grupo de subprocesos es una colección de subprocesos de trabajo que ejecutan de forma eficaz las devoluciones de llamada asincrónicas en nombre de la aplicación.
ms.assetid: abe0798a-0b60-4bdb-a61e-45393f1e958d
title: Grupos de subprocesos
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 690aa3eb6fd3ce7a99d71e0f57118529ef79113f
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/08/2021
ms.locfileid: "105677987"
---
# <a name="thread-pools"></a><span data-ttu-id="c9d59-103">Grupos de subprocesos</span><span class="sxs-lookup"><span data-stu-id="c9d59-103">Thread Pools</span></span>

<span data-ttu-id="c9d59-104">Un *grupo de subprocesos* es una colección de subprocesos de trabajo que ejecutan de forma eficaz las devoluciones de llamada asincrónicas en nombre de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="c9d59-104">A *thread pool* is a collection of worker threads that efficiently execute asynchronous callbacks on behalf of the application.</span></span> <span data-ttu-id="c9d59-105">El grupo de subprocesos se usa principalmente para reducir el número de subprocesos de aplicación y proporcionar administración de los subprocesos de trabajo.</span><span class="sxs-lookup"><span data-stu-id="c9d59-105">The thread pool is primarily used to reduce the number of application threads and provide management of the worker threads.</span></span> <span data-ttu-id="c9d59-106">Las aplicaciones pueden poner en cola los elementos de trabajo, asociar el trabajo con los identificadores de espera, poner en cola automáticamente en función de un temporizador y enlazar con e/s.</span><span class="sxs-lookup"><span data-stu-id="c9d59-106">Applications can queue work items, associate work with waitable handles, automatically queue based on a timer, and bind with I/O.</span></span>

## <a name="thread-pool-architecture"></a><span data-ttu-id="c9d59-107">Arquitectura de grupo de subprocesos</span><span class="sxs-lookup"><span data-stu-id="c9d59-107">Thread Pool Architecture</span></span>

<span data-ttu-id="c9d59-108">Las aplicaciones siguientes pueden beneficiarse del uso de un grupo de subprocesos:</span><span class="sxs-lookup"><span data-stu-id="c9d59-108">The following applications can benefit from using a thread pool:</span></span>

-   <span data-ttu-id="c9d59-109">Una aplicación muy paralela y puede distribuir un gran número de elementos de trabajo pequeños de forma asincrónica (por ejemplo, búsqueda de índice distribuida o e/s de red).</span><span class="sxs-lookup"><span data-stu-id="c9d59-109">An application that is highly parallel and can dispatch a large number of small work items asynchronously (such as distributed index search or network I/O).</span></span>
-   <span data-ttu-id="c9d59-110">Aplicación que crea y destruye un gran número de subprocesos que se ejecutan durante un breve período de tiempo.</span><span class="sxs-lookup"><span data-stu-id="c9d59-110">An application that creates and destroys a large number of threads that each run for a short time.</span></span> <span data-ttu-id="c9d59-111">El uso del grupo de subprocesos puede reducir la complejidad de la administración de subprocesos y la sobrecarga que implica la creación y destrucción de subprocesos.</span><span class="sxs-lookup"><span data-stu-id="c9d59-111">Using the thread pool can reduce the complexity of thread management and the overhead involved in thread creation and destruction.</span></span>
-   <span data-ttu-id="c9d59-112">Aplicación que procesa elementos de trabajo independientes en segundo plano y en paralelo (por ejemplo, la carga de varias pestañas).</span><span class="sxs-lookup"><span data-stu-id="c9d59-112">An application that processes independent work items in the background and in parallel (such as loading multiple tabs).</span></span>
-   <span data-ttu-id="c9d59-113">Aplicación que debe realizar una espera exclusiva en los objetos de kernel o bloquear los eventos de entrada en un objeto.</span><span class="sxs-lookup"><span data-stu-id="c9d59-113">An application that must perform an exclusive wait on kernel objects or block on incoming events on an object.</span></span> <span data-ttu-id="c9d59-114">El uso del grupo de subprocesos puede reducir la complejidad de la administración de subprocesos y aumentar el rendimiento al reducir el número de cambios de contexto.</span><span class="sxs-lookup"><span data-stu-id="c9d59-114">Using the thread pool can reduce the complexity of thread management and increase performance by reducing the number of context switches.</span></span>
-   <span data-ttu-id="c9d59-115">Aplicación que crea subprocesos de espera personalizados para esperar en los eventos.</span><span class="sxs-lookup"><span data-stu-id="c9d59-115">An application that creates custom waiter threads to wait on events.</span></span>

<span data-ttu-id="c9d59-116">El grupo de subprocesos original se ha rediseñado completamente en Windows Vista.</span><span class="sxs-lookup"><span data-stu-id="c9d59-116">The original thread pool has been completely rearchitected in Windows Vista.</span></span> <span data-ttu-id="c9d59-117">El nuevo grupo de subprocesos mejora porque proporciona un único tipo de subproceso de trabajo (admite e/s y no e/s), no utiliza un subproceso de temporizador, proporciona una única cola de temporizador y proporciona un subproceso persistente dedicado.</span><span class="sxs-lookup"><span data-stu-id="c9d59-117">The new thread pool is improved because it provides a single worker thread type (supports both I/O and non-I/O), does not use a timer thread, provides a single timer queue, and provides a dedicated persistent thread.</span></span> <span data-ttu-id="c9d59-118">También proporciona grupos de limpieza, mayor rendimiento, varios grupos por proceso que se programan de forma independiente y una nueva API de grupo de subprocesos.</span><span class="sxs-lookup"><span data-stu-id="c9d59-118">It also provides clean-up groups, higher performance, multiple pools per process that are scheduled independently, and a new thread pool API.</span></span>

<span data-ttu-id="c9d59-119">La arquitectura del grupo de subprocesos consta de lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="c9d59-119">The thread pool architecture consists of the following:</span></span>

-   <span data-ttu-id="c9d59-120">Subprocesos de trabajo que ejecutan las funciones de devolución de llamada</span><span class="sxs-lookup"><span data-stu-id="c9d59-120">Worker threads that execute the callback functions</span></span>
-   <span data-ttu-id="c9d59-121">Subprocesos en espera que esperan en varios identificadores de espera</span><span class="sxs-lookup"><span data-stu-id="c9d59-121">Waiter threads that wait on multiple wait handles</span></span>
-   <span data-ttu-id="c9d59-122">Una cola de trabajo</span><span class="sxs-lookup"><span data-stu-id="c9d59-122">A work queue</span></span>
-   <span data-ttu-id="c9d59-123">Un grupo de subprocesos predeterminado para cada proceso</span><span class="sxs-lookup"><span data-stu-id="c9d59-123">A default thread pool for each process</span></span>
-   <span data-ttu-id="c9d59-124">Un generador de trabajo que administra los subprocesos de trabajo</span><span class="sxs-lookup"><span data-stu-id="c9d59-124">A worker factory that manages the worker threads</span></span>

## <a name="best-practices"></a><span data-ttu-id="c9d59-125">Prácticas recomendadas</span><span class="sxs-lookup"><span data-stu-id="c9d59-125">Best Practices</span></span>

<span data-ttu-id="c9d59-126">La nueva [API de grupo de subprocesos](thread-pool-api.md) proporciona más flexibilidad y control que la [API de grupo de subprocesos original](thread-pooling.md).</span><span class="sxs-lookup"><span data-stu-id="c9d59-126">The new [thread pool API](thread-pool-api.md) provides more flexibility and control than the [original thread pool API](thread-pooling.md).</span></span> <span data-ttu-id="c9d59-127">Sin embargo, hay algunas diferencias sutiles pero importantes.</span><span class="sxs-lookup"><span data-stu-id="c9d59-127">However, there are a few subtle but important differences.</span></span> <span data-ttu-id="c9d59-128">En la API original, el restablecimiento de la espera era automático; en la nueva API, la espera debe restablecerse explícitamente cada vez.</span><span class="sxs-lookup"><span data-stu-id="c9d59-128">In the original API, the wait reset was automatic; in the new API, the wait must be explicitly reset each time.</span></span> <span data-ttu-id="c9d59-129">La API original controlaba la suplantación automáticamente, transfiriendo el contexto de seguridad del proceso de llamada al subproceso.</span><span class="sxs-lookup"><span data-stu-id="c9d59-129">The original API handled impersonation automatically, transferring the security context of the calling process to the thread.</span></span> <span data-ttu-id="c9d59-130">Con la nueva API, la aplicación debe establecer explícitamente el contexto de seguridad.</span><span class="sxs-lookup"><span data-stu-id="c9d59-130">With the new API, the application must explicitly set the security context.</span></span>

<span data-ttu-id="c9d59-131">A continuación se muestran los procedimientos recomendados para usar un grupo de subprocesos:</span><span class="sxs-lookup"><span data-stu-id="c9d59-131">The following are best practices when using a thread pool:</span></span>

-   <span data-ttu-id="c9d59-132">Los subprocesos de un proceso comparten el grupo de subprocesos.</span><span class="sxs-lookup"><span data-stu-id="c9d59-132">The threads of a process share the thread pool.</span></span> <span data-ttu-id="c9d59-133">Un único subproceso de trabajo puede ejecutar varias funciones de devolución de llamada, de una en una.</span><span class="sxs-lookup"><span data-stu-id="c9d59-133">A single worker thread can execute multiple callback functions, one at a time.</span></span> <span data-ttu-id="c9d59-134">Estos subprocesos de trabajo se administran mediante el grupo de subprocesos.</span><span class="sxs-lookup"><span data-stu-id="c9d59-134">These worker threads are managed by the thread pool.</span></span> <span data-ttu-id="c9d59-135">Por consiguiente, no termine un subproceso del grupo de subprocesos llamando a [**TerminateThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminatethread) en el subproceso o llamando a [**ExitThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitthread) desde una función de devolución de llamada.</span><span class="sxs-lookup"><span data-stu-id="c9d59-135">Therefore, do not terminate a thread from the thread pool by calling [**TerminateThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminatethread) on the thread or by calling [**ExitThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitthread) from a callback function.</span></span>
-   <span data-ttu-id="c9d59-136">Una solicitud de e/s se puede ejecutar en cualquier subproceso del grupo de subprocesos.</span><span class="sxs-lookup"><span data-stu-id="c9d59-136">An I/O request can run on any thread in the thread pool.</span></span> <span data-ttu-id="c9d59-137">La cancelación de e/s en un subproceso del grupo de subprocesos requiere sincronización porque la función de cancelación puede ejecutarse en un subproceso diferente al que controla la solicitud de e/s, lo que puede dar lugar a la cancelación de una operación desconocida.</span><span class="sxs-lookup"><span data-stu-id="c9d59-137">Canceling I/O on a thread pool thread requires synchronization because the cancel function might run on a different thread than the one that is handling the I/O request, which can result in cancellation of an unknown operation.</span></span> <span data-ttu-id="c9d59-138">Para evitar esto, proporcione siempre la estructura [**superpuesta**](/windows/win32/api/minwinbase/ns-minwinbase-overlapped) con la que se inició una solicitud de e/s al llamar a [**CancelIoEx**](/windows/win32/api/ioapiset/nf-ioapiset-cancelioex) para la e/s asincrónica, o use su propia sincronización para asegurarse de que no se pueda iniciar ninguna otra e/s en el subproceso de destino antes de llamar a la función [**CancelSynchronousIo**](/windows/win32/api/ioapiset/nf-ioapiset-cancelsynchronousio) o **CancelIoEx** .</span><span class="sxs-lookup"><span data-stu-id="c9d59-138">To avoid this, always provide the [**OVERLAPPED**](/windows/win32/api/minwinbase/ns-minwinbase-overlapped) structure with which an I/O request was initiated when calling [**CancelIoEx**](/windows/win32/api/ioapiset/nf-ioapiset-cancelioex) for asynchronous I/O, or use your own synchronization to ensure that no other I/O can be started on the target thread before calling either the [**CancelSynchronousIo**](/windows/win32/api/ioapiset/nf-ioapiset-cancelsynchronousio) or **CancelIoEx** function.</span></span>
-   <span data-ttu-id="c9d59-139">Limpie todos los recursos creados en la función de devolución de llamada antes de volver de la función.</span><span class="sxs-lookup"><span data-stu-id="c9d59-139">Clean up all resources created in the callback function before returning from the function.</span></span> <span data-ttu-id="c9d59-140">Entre ellas se incluyen TLS, contextos de seguridad, prioridad de subprocesos y registro COM.</span><span class="sxs-lookup"><span data-stu-id="c9d59-140">These include TLS, security contexts, thread priority, and COM registration.</span></span> <span data-ttu-id="c9d59-141">Las funciones de devolución de llamada también deben restaurar el estado del subproceso antes de devolver.</span><span class="sxs-lookup"><span data-stu-id="c9d59-141">Callback functions must also restore the thread state before returning.</span></span>
-   <span data-ttu-id="c9d59-142">Mantenga los controladores de espera y sus objetos asociados activos hasta que el grupo de subprocesos haya señalado que ha finalizado con el identificador.</span><span class="sxs-lookup"><span data-stu-id="c9d59-142">Keep wait handles and their associated objects alive until the thread pool has signaled that it is finished with the handle.</span></span>
-   <span data-ttu-id="c9d59-143">Marque todos los subprocesos que están a la espera de operaciones largas (como vaciados de e/s o limpieza de recursos) para que el grupo de subprocesos pueda asignar nuevos subprocesos en lugar de esperar a este.</span><span class="sxs-lookup"><span data-stu-id="c9d59-143">Mark all threads that are waiting on lengthy operations (such as I/O flushes or resource cleanup) so that the thread pool can allocate new threads instead of waiting for this one.</span></span>
-   <span data-ttu-id="c9d59-144">Antes de descargar un archivo DLL que usa el grupo de subprocesos, cancele todos los elementos de trabajo, e/s, operaciones de espera y temporizadores, y espere a que se complete la ejecución de las devoluciones de llamada.</span><span class="sxs-lookup"><span data-stu-id="c9d59-144">Before unloading a DLL that uses the thread pool, cancel all work items, I/O, wait operations, and timers, and wait for executing callbacks to complete.</span></span>
-   <span data-ttu-id="c9d59-145">Evite los interbloqueos eliminando las dependencias entre los elementos de trabajo y entre las devoluciones de llamada, asegurándose de que una devolución de llamada no está esperando a que se complete y conservando la prioridad del subproceso.</span><span class="sxs-lookup"><span data-stu-id="c9d59-145">Avoid deadlocks by eliminating dependencies between work items and between callbacks, by ensuring a callback is not waiting for itself to complete, and by preserving the thread priority.</span></span>
-   <span data-ttu-id="c9d59-146">No ponga en cola demasiados elementos demasiado rápido en un proceso con otros componentes que usen el grupo de subprocesos predeterminado.</span><span class="sxs-lookup"><span data-stu-id="c9d59-146">Do not queue too many items too quickly in a process with other components using the default thread pool.</span></span> <span data-ttu-id="c9d59-147">Hay un grupo de subprocesos predeterminado por proceso, incluido Svchost.exe.</span><span class="sxs-lookup"><span data-stu-id="c9d59-147">There is one default thread pool per process, including Svchost.exe.</span></span> <span data-ttu-id="c9d59-148">De forma predeterminada, cada grupo de subprocesos tiene un máximo de 500 subprocesos de trabajo.</span><span class="sxs-lookup"><span data-stu-id="c9d59-148">By default, each thread pool has a maximum of 500 worker threads.</span></span> <span data-ttu-id="c9d59-149">El grupo de subprocesos intenta crear más subprocesos de trabajo cuando el número de subprocesos de trabajo en el estado listo/en ejecución debe ser menor que el número de procesadores.</span><span class="sxs-lookup"><span data-stu-id="c9d59-149">The thread pool attempts to create more worker threads when the number of worker threads in the ready/running state must be less than the number of processors.</span></span>
-   <span data-ttu-id="c9d59-150">Evite el modelo de apartamento de un solo subproceso COM, ya que no es compatible con el grupo de subprocesos.</span><span class="sxs-lookup"><span data-stu-id="c9d59-150">Avoid the COM single-threaded apartment model, as it is incompatible with the thread pool.</span></span> <span data-ttu-id="c9d59-151">STA crea un estado de subproceso que puede afectar al siguiente elemento de trabajo para el subproceso.</span><span class="sxs-lookup"><span data-stu-id="c9d59-151">STA creates thread state which can affect the next work item for the thread.</span></span> <span data-ttu-id="c9d59-152">STA suele ser de larga duración y tiene afinidad de subprocesos, que es lo contrario que el grupo de subprocesos.</span><span class="sxs-lookup"><span data-stu-id="c9d59-152">STA is generally long-lived and has thread affinity, which is the opposite of the thread pool.</span></span>
-   <span data-ttu-id="c9d59-153">Cree un nuevo grupo de subprocesos para controlar la prioridad y el aislamiento de subprocesos, cree características personalizadas y, posiblemente, mejore la capacidad de respuesta.</span><span class="sxs-lookup"><span data-stu-id="c9d59-153">Create a new thread pool to control thread priority and isolation, create custom characteristics, and possibly improve responsiveness.</span></span> <span data-ttu-id="c9d59-154">Sin embargo, los grupos de subprocesos adicionales requieren más recursos del sistema (subprocesos, memoria de kernel).</span><span class="sxs-lookup"><span data-stu-id="c9d59-154">However, additional thread pools require more system resources (threads, kernel memory).</span></span> <span data-ttu-id="c9d59-155">Un número excesivo de grupos aumenta la posibilidad de contención de la CPU.</span><span class="sxs-lookup"><span data-stu-id="c9d59-155">Too many pools increases the potential for CPU contention.</span></span>
-   <span data-ttu-id="c9d59-156">Si es posible, utilice un objeto que se puede esperar en lugar de un mecanismo basado en APC para indicar un subproceso del grupo de subprocesos.</span><span class="sxs-lookup"><span data-stu-id="c9d59-156">If possible, use a waitable object instead of an APC-based mechanism to signal a thread pool thread.</span></span> <span data-ttu-id="c9d59-157">APC no funcionan también con subprocesos de grupo de subprocesos como otros mecanismos de señalización porque el sistema controla la duración de los subprocesos del grupo de subprocesos, por lo que es posible que un subproceso finalice antes de que se entregue la notificación.</span><span class="sxs-lookup"><span data-stu-id="c9d59-157">APCs do not work as well with thread pool threads as other signaling mechanisms because the system controls the lifetime of thread pool threads, so it is possible for a thread to be terminated before the notification is delivered.</span></span>
-   <span data-ttu-id="c9d59-158">Use la extensión del depurador del grupo de subprocesos,! TP.</span><span class="sxs-lookup"><span data-stu-id="c9d59-158">Use the thread pool debugger extension, !tp.</span></span> <span data-ttu-id="c9d59-159">Este comando tiene el siguiente uso:</span><span class="sxs-lookup"><span data-stu-id="c9d59-159">This command has the following usage:</span></span>

    -   <span data-ttu-id="c9d59-160">*marcas* de *Dirección* de grupo</span><span class="sxs-lookup"><span data-stu-id="c9d59-160">pool *address* *flags*</span></span>
    -   <span data-ttu-id="c9d59-161">*marcas* de *Dirección* de obj</span><span class="sxs-lookup"><span data-stu-id="c9d59-161">obj *address* *flags*</span></span>
    -   <span data-ttu-id="c9d59-162">*marcas* de *Dirección* TNO</span><span class="sxs-lookup"><span data-stu-id="c9d59-162">tqueue *address* *flags*</span></span>
    -   <span data-ttu-id="c9d59-163">*Dirección* de espera</span><span class="sxs-lookup"><span data-stu-id="c9d59-163">waiter *address*</span></span>
    -   <span data-ttu-id="c9d59-164">*Dirección* de trabajo</span><span class="sxs-lookup"><span data-stu-id="c9d59-164">worker *address*</span></span>

    <span data-ttu-id="c9d59-165">En el caso de los grupos, waitr y Worker, si la dirección es cero, el comando vuelca todos los objetos.</span><span class="sxs-lookup"><span data-stu-id="c9d59-165">For pool, waiter, and worker, if the address is zero, the command dumps all objects.</span></span> <span data-ttu-id="c9d59-166">En wait y Worker, si se omite la dirección, se vuelca el subproceso actual.</span><span class="sxs-lookup"><span data-stu-id="c9d59-166">For waiter and worker, omitting the address dumps the current thread.</span></span> <span data-ttu-id="c9d59-167">Se definen las marcas siguientes: 0x1 (salida de una sola línea), 0X2 (miembros de volcado de memoria) y 0x4 (cola de trabajo del grupo de volcado).</span><span class="sxs-lookup"><span data-stu-id="c9d59-167">The following flags are defined: 0x1 (single-line output), 0x2 (dump members), and 0x4 (dump pool work queue).</span></span>

## <a name="related-topics"></a><span data-ttu-id="c9d59-168">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="c9d59-168">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="c9d59-169">API de grupo de subprocesos</span><span class="sxs-lookup"><span data-stu-id="c9d59-169">Thread Pool API</span></span>](thread-pool-api.md)
</dt> <dt>

[<span data-ttu-id="c9d59-170">Usar las funciones de grupo de subprocesos</span><span class="sxs-lookup"><span data-stu-id="c9d59-170">Using the Thread Pool Functions</span></span>](using-the-thread-pool-functions.md)
</dt> </dl>

 

 
