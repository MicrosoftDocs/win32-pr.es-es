---
description: En Windows 7, las API de plataforma de alto nivel que usan las API de audio principales, como las API de Media Foundation, DirectSound y Wave, implementan la característica de enrutamiento de flujo mediante la administración del cambio de secuencia desde un dispositivo existente a un nuevo punto de conexión de audio predeterminado.
ms.assetid: ecda0b5b-6583-43b4-a9b4-f12a95f09452
title: Consideraciones de implementación de enrutamiento de flujo
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 27dc1f7e3fe56d6b421ca59f528ab1a65d2261a9
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/07/2021
ms.locfileid: "104000637"
---
# <a name="stream-routing-implementation-considerations"></a><span data-ttu-id="4b03f-103">Consideraciones de implementación de enrutamiento de flujo</span><span class="sxs-lookup"><span data-stu-id="4b03f-103">Stream Routing Implementation Considerations</span></span>

<span data-ttu-id="4b03f-104">En Windows 7, las API de plataforma de alto nivel que usan las API de audio principales, como las API de Media Foundation, DirectSound y Wave, implementan la característica de enrutamiento de flujo mediante la administración del cambio de secuencia desde un dispositivo existente a un nuevo punto de conexión de audio predeterminado.</span><span class="sxs-lookup"><span data-stu-id="4b03f-104">In Windows 7, high-level platform APIs that use Core Audio APIs, such as Media Foundation, DirectSound, and Wave APIs, implement the stream routing feature by handling stream switching from an existing device to a new default audio endpoint.</span></span> <span data-ttu-id="4b03f-105">Las aplicaciones multimedia que usan estas API usan el comportamiento de enrutamiento de flujo sin modificaciones en el origen.</span><span class="sxs-lookup"><span data-stu-id="4b03f-105">Media applications that use these APIs use the stream routing behavior without any modifications to the source.</span></span> <span data-ttu-id="4b03f-106">Los clientes de WASAPI directos pueden usar las notificaciones enviadas por componentes de audio principales e implementar la característica de enrutamiento de flujo.</span><span class="sxs-lookup"><span data-stu-id="4b03f-106">Direct WASAPI clients can use the notifications sent by Core Audio components and implement the stream routing feature.</span></span>

<span data-ttu-id="4b03f-107">Los clientes de WASAPI directos (aplicaciones multimedia que usan WASAPI directamente) reciben nuevas notificaciones de sesión de dispositivo y audio enviadas por componentes de audio principales.</span><span class="sxs-lookup"><span data-stu-id="4b03f-107">Direct WASAPI clients (media applications that use WASAPI directly) receive new device and audio session notifications sent by Core Audio components.</span></span> <span data-ttu-id="4b03f-108">El comportamiento de la característica de enrutamiento de flujo se define en el modo en que la aplicación controla estas notificaciones.</span><span class="sxs-lookup"><span data-stu-id="4b03f-108">The behavior of the stream routing feature is defined by how the application handles these notifications.</span></span>

<span data-ttu-id="4b03f-109">La API de MMDevice y la sesión de audio envían notificaciones sobre los cambios de estado de dispositivo y los cambios de sesión a los clientes de WASAPI en forma de devoluciones de llamada.</span><span class="sxs-lookup"><span data-stu-id="4b03f-109">MMDevice API and the audio session send notifications about device state changes and session changes to WASAPI clients in the form of callbacks.</span></span> <span data-ttu-id="4b03f-110">Para obtener estas notificaciones, el cliente debe registrar su implementación de [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) y [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents).</span><span class="sxs-lookup"><span data-stu-id="4b03f-110">To get these notifications, the client must register its implementation of [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) and [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents).</span></span> <span data-ttu-id="4b03f-111">Para obtener más información, consulte [notificaciones relevantes para el enrutamiento de flujos](relevant-device-notifications-for-stream-routing.md).</span><span class="sxs-lookup"><span data-stu-id="4b03f-111">For more information, see [Relevant Notifications for Stream Routing](relevant-device-notifications-for-stream-routing.md).</span></span>

<span data-ttu-id="4b03f-112">En el escenario de auriculares USB descrito en [enrutamiento de transmisión](stream-routing.md), una aplicación está reproduciendo una secuencia de audio y usa MMDEVICEAPI y WASAPI para representar la secuencia en el dispositivo de representación predeterminado, **Speaker**.</span><span class="sxs-lookup"><span data-stu-id="4b03f-112">In the USB headset scenario described in [Stream Routing](stream-routing.md), an application is playing an audio stream and uses MMDeviceAPI and WASAPI to render the stream on the default rendering device, **Speaker**.</span></span> <span data-ttu-id="4b03f-113">Cuando se cambia el dispositivo predeterminado, la aplicación recibe una notificación de [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) .</span><span class="sxs-lookup"><span data-stu-id="4b03f-113">When the default device is changed, the application receives an [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) notification.</span></span> <span data-ttu-id="4b03f-114">La aplicación también recibe notificaciones de [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) que indican que el usuario ha quitado el dispositivo de punto de conexión de audio o que el formato de secuencia ha cambiado para el dispositivo al que está conectada la sesión de audio.</span><span class="sxs-lookup"><span data-stu-id="4b03f-114">The application also receives [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) notifications indicating that the user removed the audio endpoint device or that the stream format changed for the device that the audio session is connected to.</span></span> <span data-ttu-id="4b03f-115">Después de recibir las notificaciones, la aplicación detiene el streaming al extremo del orador y vuelve a abrir la secuencia para la representación en el punto de conexión predeterminado actual, los auriculares.</span><span class="sxs-lookup"><span data-stu-id="4b03f-115">Upon receiving the notifications, the application stops streaming to the speaker endpoint and reopens the stream for rendering on the current default endpoint, the headset.</span></span>

![diagrama del flujo de datos para las notificaciones de dispositivo.](images/stream-routing.gif)

<span data-ttu-id="4b03f-117">En respuesta a estas notificaciones, es posible que el cliente vuelva a abrir la secuencia en el nuevo dispositivo predeterminado en el nuevo formato seleccionado por el usuario.</span><span class="sxs-lookup"><span data-stu-id="4b03f-117">In response to such notifications, the client might reopen the stream on the new default device in the new format selected by the user.</span></span>

## <a name="stream-managment"></a><span data-ttu-id="4b03f-118">Administración de flujos</span><span class="sxs-lookup"><span data-stu-id="4b03f-118">Stream Managment</span></span>

<span data-ttu-id="4b03f-119">En la lista siguiente se resumen los pasos que debe realizar un cliente de WASAPI para proporcionar la funcionalidad de cambio de secuencia.</span><span class="sxs-lookup"><span data-stu-id="4b03f-119">The following list summarizes the steps that a WASAPI client must perform to provide the stream switching functionality.</span></span>

1.  <span data-ttu-id="4b03f-120">Espere a la notificación de [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) pertinente.</span><span class="sxs-lookup"><span data-stu-id="4b03f-120">Wait for the relevant [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) notification.</span></span> <span data-ttu-id="4b03f-121">Si el dispositivo es el dispositivo predeterminado, se recibe la notificación [**IMMNotificationClient:: OnDefaultDeviceChanged**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immnotificationclient-ondefaultdevicechanged) .</span><span class="sxs-lookup"><span data-stu-id="4b03f-121">If the device is the default device, the [**IMMNotificationClient::OnDefaultDeviceChanged**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immnotificationclient-ondefaultdevicechanged) notification is received.</span></span>
2.  <span data-ttu-id="4b03f-122">Si hay un nuevo dispositivo disponible, obtenga una referencia al punto de conexión del nuevo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="4b03f-122">If a new device is available, get a reference to the endpoint of the new device.</span></span> <span data-ttu-id="4b03f-123">Llame a [**IMMDeviceEnumerator:: GetDefaultAudioEndpoint**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) para el nuevo dispositivo predeterminado.</span><span class="sxs-lookup"><span data-stu-id="4b03f-123">Call [**IMMDeviceEnumerator::GetDefaultAudioEndpoint**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) for the new default device.</span></span> <span data-ttu-id="4b03f-124">Si el dispositivo nuevo no es el predeterminado, puede recuperar el dispositivo mediante una llamada a [**IMMDeviceEnumerator:: GetDevice**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdevice).</span><span class="sxs-lookup"><span data-stu-id="4b03f-124">If the new device is not the default device, you can retrieve the device by calling [**IMMDeviceEnumerator::GetDevice**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdevice).</span></span> <span data-ttu-id="4b03f-125">Para obtener más información, consulte [obtención del punto de conexión del dispositivo para el enrutamiento de transmisiones](getting-the-default-device-endpoint-for-stream-routing.md).</span><span class="sxs-lookup"><span data-stu-id="4b03f-125">For more information, see [Getting the Device Endpoint for Stream Routing](getting-the-default-device-endpoint-for-stream-routing.md).</span></span>
3.  <span data-ttu-id="4b03f-126">Espere a [**IAudioSessionEvents:: OnSessionDisconnected**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessionevents-onsessiondisconnected) con el valor de razón.</span><span class="sxs-lookup"><span data-stu-id="4b03f-126">Wait for the [**IAudioSessionEvents::OnSessionDisconnected**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessionevents-onsessiondisconnected) with the reason value.</span></span>
    > [!Note]  
    > <span data-ttu-id="4b03f-127">Dado que todas estas operaciones son asincrónicas, no se puede predecir el orden en el que la aplicación recibe notificaciones de cambio de dispositivo y de desconexión de sesión.</span><span class="sxs-lookup"><span data-stu-id="4b03f-127">Because all of these operations are asychronous, the order in which the application receives device-change and session-disconnect notifications cannnot be predicted.</span></span> <span data-ttu-id="4b03f-128">La aplicación debe implementar el control de notificaciones para recibir estas notificaciones en cualquier orden.</span><span class="sxs-lookup"><span data-stu-id="4b03f-128">The application must implement notification handling to receive these notifications in any order.</span></span> <span data-ttu-id="4b03f-129">Sin embargo, normalmente, la aplicación recibe el valor **AudioSessionDisconnect** antes de la notificación de cambio de dispositivo predeterminada.</span><span class="sxs-lookup"><span data-stu-id="4b03f-129">However, typically, the application receives **AudioSessionDisconnect** value before the default device change notification.</span></span>

     

4.  <span data-ttu-id="4b03f-130">Evalúe el valor del motivo y determine si es necesario transferir el flujo a otro punto de conexión de audio o si es necesario reinicializar el flujo con un nuevo formato.</span><span class="sxs-lookup"><span data-stu-id="4b03f-130">Evaluate the reason value and determine whether the stream needs to be transferred to another audio endpoint or the stream needs to be reinitialized with a new format.</span></span>
5.  <span data-ttu-id="4b03f-131">Detenga el streaming al dispositivo predeterminado anterior si el motivo indica que el flujo se debe volver a enrutar al nuevo dispositivo predeterminado.</span><span class="sxs-lookup"><span data-stu-id="4b03f-131">Stop streaming to the old default device if the reason indicates that the stream should be re-routed to the new default device.</span></span>
6.  <span data-ttu-id="4b03f-132">Realizar cálculos de asignación de posición.</span><span class="sxs-lookup"><span data-stu-id="4b03f-132">Perform position mapping calculations.</span></span>
7.  <span data-ttu-id="4b03f-133">Abra la secuencia en el nuevo dispositivo y transfiera toda la información de estado.</span><span class="sxs-lookup"><span data-stu-id="4b03f-133">Open the stream on the new device and transfer all state information.</span></span>
8.  <span data-ttu-id="4b03f-134">Reanude el streaming en el nuevo dispositivo predeterminado.</span><span class="sxs-lookup"><span data-stu-id="4b03f-134">Resume streaming on the new default device.</span></span>
9.  <span data-ttu-id="4b03f-135">Controlar la salida del dispositivo predeterminado anterior.</span><span class="sxs-lookup"><span data-stu-id="4b03f-135">Handle the departure of the old default device.</span></span>

<span data-ttu-id="4b03f-136">Para que la operación de cambio de flujo parezca perfecta, debe realizarse lo más rápido posible.</span><span class="sxs-lookup"><span data-stu-id="4b03f-136">To make the stream switching operation appear seamless, it must be done as quickly as possible.</span></span> <span data-ttu-id="4b03f-137">Esto depende del rendimiento de los componentes implicados en el reinicio de la secuencia en el nuevo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="4b03f-137">This depends on the performance of the components involved in re-initiation of the stream on the new device.</span></span>

## <a name="position-mapping-considerations"></a><span data-ttu-id="4b03f-138">Consideraciones sobre la asignación de posiciones</span><span class="sxs-lookup"><span data-stu-id="4b03f-138">Position Mapping Considerations</span></span>

<span data-ttu-id="4b03f-139">Cuando la aplicación obtiene notificaciones de [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) y [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) , puede enrutar los flujos existentes al nuevo dispositivo predeterminado.</span><span class="sxs-lookup"><span data-stu-id="4b03f-139">When the application gets [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) and [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) notifications, it can route the existing streams to the new default device.</span></span> <span data-ttu-id="4b03f-140">Cuando una secuencia de audio existente se interrumpe y se abre en el nuevo dispositivo, la representación en el nuevo dispositivo debe comenzar en la posición en la que se detuvo la secuencia en el dispositivo antiguo.</span><span class="sxs-lookup"><span data-stu-id="4b03f-140">When an existing audio stream is interrupted and opened on the new device, rendering on the new device must start at the position at which the stream was stopped on the old device.</span></span> <span data-ttu-id="4b03f-141">Para ello, la aplicación debe tener la última posición de dispositivo conocida, para calcular la posición de inicio en el nuevo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="4b03f-141">To do this, the application must have the last known device position, to calculate the start position on the new device.</span></span> <span data-ttu-id="4b03f-142">Por ejemplo, esta posición se puede usar como desplazamiento Delta para la asignación de posición subsiguiente.</span><span class="sxs-lookup"><span data-stu-id="4b03f-142">For example, this position can be used as the delta offset for subsequent position mapping.</span></span> <span data-ttu-id="4b03f-143">Cuando el flujo comienza a representarse, la nueva posición del dispositivo se puede reasignar a la posición del dispositivo almacenado en memoria caché.</span><span class="sxs-lookup"><span data-stu-id="4b03f-143">When the stream starts rendering, the new device position can be remapped to the cached device position.</span></span>

<span data-ttu-id="4b03f-144">En los pasos siguientes se resume el proceso de realizar una transición de flujo sin problemas.</span><span class="sxs-lookup"><span data-stu-id="4b03f-144">The following steps summarize the process of making a seamless stream transition.</span></span>

1.  <span data-ttu-id="4b03f-145">Almacenar en caché la última posición del dispositivo de la secuencia en el dispositivo antiguo.</span><span class="sxs-lookup"><span data-stu-id="4b03f-145">Cache the last device position of the stream on the old device.</span></span>
2.  <span data-ttu-id="4b03f-146">Detenga el flujo en el dispositivo antiguo.</span><span class="sxs-lookup"><span data-stu-id="4b03f-146">Stop the stream on the old device.</span></span>
3.  <span data-ttu-id="4b03f-147">Realizar cálculos de reasignación para obtener la nueva posición.</span><span class="sxs-lookup"><span data-stu-id="4b03f-147">Perform remapping calculations to get the new position.</span></span>
4.  <span data-ttu-id="4b03f-148">Empiece a representar la secuencia en el nuevo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="4b03f-148">Start rendering the stream on the new device.</span></span>
5.  <span data-ttu-id="4b03f-149">Libere el flujo anterior.</span><span class="sxs-lookup"><span data-stu-id="4b03f-149">Release the old stream.</span></span>

<span data-ttu-id="4b03f-150">Durante la transición, la aplicación debe asegurarse de que el reloj no se queda sin sincronización, lo que da lugar a secuencias de audio y vídeo que no están sincronizadas.</span><span class="sxs-lookup"><span data-stu-id="4b03f-150">During the transition, the application must ensure that the clock does not get out of synchronization, resulting in out-of-sync audio and video streams.</span></span> <span data-ttu-id="4b03f-151">Esto puede ocurrir si los ejemplos de vídeo continúan representando mientras la secuencia de audio se enruta al nuevo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="4b03f-151">This can occur if the video samples continue to render while the audio stream is routed to the new device.</span></span> <span data-ttu-id="4b03f-152">La aplicación debe almacenar en caché la posición del reloj para el cálculo de reasignación y asegurarse de que los ejemplos de vídeo no se representen hasta que la secuencia de audio se vuelva a abrir en el nuevo dispositivo, de modo que cuando el clip reanude la representación, se sincronicen las secuencias de audio y de vídeo.</span><span class="sxs-lookup"><span data-stu-id="4b03f-152">The application must cache the clock position for the remapping calculation and make sure that the video samples are not rendered until the audio stream is reopened on the new device, so that when the clip resumes rendering, the audio and the video streams are synchronized.</span></span> <span data-ttu-id="4b03f-153">En algunos casos, en los que el tiempo de presentación para representar los fotogramas de vídeo se basa en el reloj de audio, es suficiente detener la secuencia de audio hasta que se complete la conmutación de la secuencia y no sea necesaria ninguna otra implementación de asignación de posición para la secuencia de vídeo para la sincronización de vídeo de audio.</span><span class="sxs-lookup"><span data-stu-id="4b03f-153">In some cases, where the presentation time for rendering the video frames is based on the audio clock, it is sufficient to stop the audio stream until stream switching is complete and no other position mapping implementation for the video stream is necessary for audio video synchronization.</span></span>

<span data-ttu-id="4b03f-154">Si durante la representación, [**IAudioRenderClient:: getBuffer**](/windows/desktop/api/Audioclient/nf-audioclient-iaudiorenderclient-getbuffer) devuelve un error porque se pierde el dispositivo anterior, la aplicación no necesita detener la secuencia antigua porque la operación de streaming ya finalizó.</span><span class="sxs-lookup"><span data-stu-id="4b03f-154">If while rendering, [**IAudioRenderClient::GetBuffer**](/windows/desktop/api/Audioclient/nf-audioclient-iaudiorenderclient-getbuffer) returns an error because the old device is lost, the application need not stop the old stream because the streaming operation has already terminated.</span></span> <span data-ttu-id="4b03f-155">Para obtener información acerca de cómo controlar este error, consulte [recuperación de un error de Invalid-Device](recovering-from-an-invalid-device-error.md).</span><span class="sxs-lookup"><span data-stu-id="4b03f-155">For information about handling this error, see [Recovering from an Invalid-Device Error](recovering-from-an-invalid-device-error.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="4b03f-156">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="4b03f-156">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="4b03f-157">Acerca de la API de MMDevice</span><span class="sxs-lookup"><span data-stu-id="4b03f-157">About MMDevice API</span></span>](mmdevice-api.md)
</dt> <dt>

[<span data-ttu-id="4b03f-158">Acerca de WASAPI</span><span class="sxs-lookup"><span data-stu-id="4b03f-158">About WASAPI</span></span>](wasapi.md)
</dt> <dt>

[<span data-ttu-id="4b03f-159">Enrutamiento de flujos</span><span class="sxs-lookup"><span data-stu-id="4b03f-159">Stream Routing</span></span>](stream-routing.md)
</dt> </dl>

 

 



