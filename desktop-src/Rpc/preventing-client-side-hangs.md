---
title: Impedir bloqueos del cliente
description: Hay dos maneras en las que el cliente puede bloquear la conectividad de red puede provocar que se pierdan las solicitudes del servidor o que el propio servidor pueda bloquearse. Con las opciones predeterminadas, RPC nunca agotará el tiempo de espera de una llamada y el subproceso de cliente esperará indefinidamente una respuesta.
ms.assetid: 2c201e29-9d9c-48e6-b0b5-68e4b25c3fb7
keywords:
- RPC llamada a procedimiento remoto, procedimientos recomendados, impedir bloqueos del cliente
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 18d4b5fc92ca18b575d081cd7b5abf90929e7df5
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/20/2020
ms.locfileid: "103791991"
---
# <a name="preventing-client-side-hangs"></a><span data-ttu-id="b4a8a-105">Impedir bloqueos del cliente</span><span class="sxs-lookup"><span data-stu-id="b4a8a-105">Preventing Client-side Hangs</span></span>

<span data-ttu-id="b4a8a-106">Hay dos maneras en las que el cliente puede bloquearse: la conectividad de red puede provocar que se pierdan las solicitudes del servidor o que el propio servidor pueda bloquearse.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-106">There are two ways your client can hang: network connectivity can cause server requests to become lost, or the server itself can crash.</span></span> <span data-ttu-id="b4a8a-107">Con las opciones predeterminadas, RPC nunca agotará el tiempo de espera de una llamada y el subproceso de cliente esperará indefinidamente una respuesta.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-107">With default options, RPC will never time out a call, and your client thread will wait forever for a response.</span></span>

<span data-ttu-id="b4a8a-108">Hay dos métodos para evitar esto: mantener las conexiones activas y tiempos de espera.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-108">There are two methods to prevent this: keep alives and time outs.</span></span>

## <a name="tcp-keep-alives"></a><span data-ttu-id="b4a8a-109">Mantenimiento de conexiones TCP</span><span class="sxs-lookup"><span data-stu-id="b4a8a-109">TCP Keep Alives</span></span>

<span data-ttu-id="b4a8a-110">El cliente puede configurarse para hacer ping periódicamente en el servidor para asegurarse de que el servidor está activo y en ejecución.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-110">The client can be set up to periodically ping the server to ensure the server is alive and running.</span></span> <span data-ttu-id="b4a8a-111">Los pings son conexiones TCP persistentes para las secuencias de protocolo [**ncacn \_ IP \_ TCP**](/windows/desktop/Midl/ncacn-ip-tcp) y [**ncacn \_ http**](/windows/desktop/Midl/ncacn-http) y, por tanto, son eficientes en el uso de CPU y el ancho de banda de red.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-111">The pings are TCP keep-alives for the [**ncacn\_ip\_tcp**](/windows/desktop/Midl/ncacn-ip-tcp) and [**ncacn\_http**](/windows/desktop/Midl/ncacn-http) protocol sequences, and as such, they are efficient in CPU utilization and network bandwidth.</span></span> <span data-ttu-id="b4a8a-112">Para habilitar Keep alives en una llamada a procedimiento remoto determinada, use la función [**RpcMgmtSetComTimeout**](/windows/desktop/api/Rpcdce/nf-rpcdce-rpcmgmtsetcomtimeout) antes de que se inicie la llamada.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-112">To enable keep alives on a given remote procedure call, use the [**RpcMgmtSetComTimeout**](/windows/desktop/api/Rpcdce/nf-rpcdce-rpcmgmtsetcomtimeout) function before the call is initiated.</span></span> <span data-ttu-id="b4a8a-113">Esta función toma un identificador de enlace y un tiempo de espera como argumentos.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-113">This function takes a binding handle and a time out as arguments.</span></span> <span data-ttu-id="b4a8a-114">Cada llamada a procedimiento remoto en este identificador de enlace después de **RpcMgmtSetComTimeout** utiliza el tiempo de espera proporcionado.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-114">Every remote procedure call on this binding handle after **RpcMgmtSetComTimeout** uses the supplied time out.</span></span>

<span data-ttu-id="b4a8a-115">El parámetro timeout de la función [**RpcMgmtSetComTimeout**](/windows/desktop/api/Rpcdce/nf-rpcdce-rpcmgmtsetcomtimeout) especifica cuánto tiempo espera el tiempo de ejecución de RPC antes de activar Keep alives.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-115">The Timeout parameter for the [**RpcMgmtSetComTimeout**](/windows/desktop/api/Rpcdce/nf-rpcdce-rpcmgmtsetcomtimeout) function specifies how long the RPC run time waits before it turns on keep alives.</span></span> <span data-ttu-id="b4a8a-116">El tiempo de espera es un valor comprendido entre 0 y 10, donde 0 es el tiempo de espera mínimo y 10 es el tiempo de espera infinito (sin tiempo de espera).</span><span class="sxs-lookup"><span data-stu-id="b4a8a-116">The time out is a value between 0 and 10, where 0 is the minimal time out, and 10 is infinite time out (no time out).</span></span> <span data-ttu-id="b4a8a-117">El tiempo de espera no está en segundos; la conversión del valor de tiempo de espera proporcionado a la función **RpcMgmtSetComTimeout** en segundos se realiza en el tiempo de ejecución de RPC y es específica de la implementación.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-117">The time out itself is not in seconds; the translation from the time-out value supplied to the **RpcMgmtSetComTimeout** function to seconds is done by the RPC run time, and is implementation specific.</span></span>

<span data-ttu-id="b4a8a-118">En la tabla siguiente se proporciona la traducción a segundos para Windows 2000 y Windows XP.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-118">The following table provides the translation to seconds for Windows 2000 and Windows XP.</span></span> <span data-ttu-id="b4a8a-119">Las versiones futuras de Windows pueden cambiar la asignación entre el parámetro timeout y el valor de tiempo de espera en segundos:</span><span class="sxs-lookup"><span data-stu-id="b4a8a-119">Future versions of Windows may change the mapping between the Timeout parameter and the time-out value in seconds:</span></span>

| <span data-ttu-id="b4a8a-120">Parámetro timeout</span><span class="sxs-lookup"><span data-stu-id="b4a8a-120">Timeout parameter</span></span>                       | <span data-ttu-id="b4a8a-121">Tiempo de espera real en segundos</span><span class="sxs-lookup"><span data-stu-id="b4a8a-121">Actual time out in seconds</span></span> |
|-----------------------------------------|----------------------------|
| <span data-ttu-id="b4a8a-122">0 ( \_ tiempo de \_ espera mínimo de enlace de RPC C \_ \_ )</span><span class="sxs-lookup"><span data-stu-id="b4a8a-122">0 (RPC\_C\_BINDING\_MIN\_TIMEOUT)</span></span>       | <span data-ttu-id="b4a8a-123">120</span><span class="sxs-lookup"><span data-stu-id="b4a8a-123">120</span></span>                        |
| <span data-ttu-id="b4a8a-124">1</span><span class="sxs-lookup"><span data-stu-id="b4a8a-124">1</span></span>                                       | <span data-ttu-id="b4a8a-125">240</span><span class="sxs-lookup"><span data-stu-id="b4a8a-125">240</span></span>                        |
| <span data-ttu-id="b4a8a-126">2</span><span class="sxs-lookup"><span data-stu-id="b4a8a-126">2</span></span>                                       | <span data-ttu-id="b4a8a-127">360</span><span class="sxs-lookup"><span data-stu-id="b4a8a-127">360</span></span>                        |
| <span data-ttu-id="b4a8a-128">3</span><span class="sxs-lookup"><span data-stu-id="b4a8a-128">3</span></span>                                       | <span data-ttu-id="b4a8a-129">480</span><span class="sxs-lookup"><span data-stu-id="b4a8a-129">480</span></span>                        |
| <span data-ttu-id="b4a8a-130">4</span><span class="sxs-lookup"><span data-stu-id="b4a8a-130">4</span></span>                                       | <span data-ttu-id="b4a8a-131">600</span><span class="sxs-lookup"><span data-stu-id="b4a8a-131">600</span></span>                        |
| <span data-ttu-id="b4a8a-132">5 ( \_ tiempo de \_ espera predeterminado de enlace de RPC C \_ \_ )</span><span class="sxs-lookup"><span data-stu-id="b4a8a-132">5 (RPC\_C\_BINDING\_DEFAULT\_TIMEOUT)</span></span>   | <span data-ttu-id="b4a8a-133">720</span><span class="sxs-lookup"><span data-stu-id="b4a8a-133">720</span></span>                        |
| <span data-ttu-id="b4a8a-134">6</span><span class="sxs-lookup"><span data-stu-id="b4a8a-134">6</span></span>                                       | <span data-ttu-id="b4a8a-135">840</span><span class="sxs-lookup"><span data-stu-id="b4a8a-135">840</span></span>                        |
| <span data-ttu-id="b4a8a-136">7</span><span class="sxs-lookup"><span data-stu-id="b4a8a-136">7</span></span>                                       | <span data-ttu-id="b4a8a-137">960</span><span class="sxs-lookup"><span data-stu-id="b4a8a-137">960</span></span>                        |
| <span data-ttu-id="b4a8a-138">8</span><span class="sxs-lookup"><span data-stu-id="b4a8a-138">8</span></span>                                       | <span data-ttu-id="b4a8a-139">1080</span><span class="sxs-lookup"><span data-stu-id="b4a8a-139">1080</span></span>                       |
| <span data-ttu-id="b4a8a-140">9 ( \_ tiempo de \_ espera máximo de enlace de RPC C \_ \_ )</span><span class="sxs-lookup"><span data-stu-id="b4a8a-140">9 (RPC\_C\_BINDING\_MAX\_TIMEOUT)</span></span>       | <span data-ttu-id="b4a8a-141">1200</span><span class="sxs-lookup"><span data-stu-id="b4a8a-141">1200</span></span>                       |
| <span data-ttu-id="b4a8a-142">10 ( \_ tiempo de \_ espera infinito de enlace de RPC C \_ \_ )</span><span class="sxs-lookup"><span data-stu-id="b4a8a-142">10 (RPC\_C\_BINDING\_INFINITE\_TIMEOUT)</span></span> | <span data-ttu-id="b4a8a-143">Tiempo de espera infinito</span><span class="sxs-lookup"><span data-stu-id="b4a8a-143">Infinite time out</span></span>          |



 

<span data-ttu-id="b4a8a-144">Una vez que se activan las conexiones de mantenimiento, el cliente envía un paquete de mantenimiento de conexión cada segundo.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-144">Once the keep alives are turned on, the client sends one keep alive packet every second.</span></span> <span data-ttu-id="b4a8a-145">Si no hay ninguna confirmación del servidor durante tres o más conexiones Keep Alive, el cliente declara la conexión muerta y produce un error en la llamada a procedimiento remoto.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-145">If there is no acknowledgment from the server for three or more keep alives, the client declares the connection dead and fails the remote procedure call.</span></span> <span data-ttu-id="b4a8a-146">Si el servidor envía una respuesta dentro del tiempo de espera especificado, las conexiones Keep Alive no se activarán.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-146">If the server sends a response within the specified time out, keep alives will not be turned on.</span></span> <span data-ttu-id="b4a8a-147">Si el servidor responde a Keep alives, pero no responde a la llamada a procedimiento remoto, el cliente continúa enviando las conexiones de mantenimiento.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-147">If the server responds to keep alives, but does not respond to the remote procedure call, the client continues sending keep alives.</span></span> <span data-ttu-id="b4a8a-148">Una vez que el servidor responde a la llamada RPC, las conexiones persistentes están desactivadas.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-148">Once the server responds to the RPC call, the keep alives are turned off.</span></span> <span data-ttu-id="b4a8a-149">En Windows 2000, Keep alives solo se activa para las llamadas RPC sincrónicas.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-149">For Windows 2000, keep alives are turned on only for synchronous RPC calls.</span></span> <span data-ttu-id="b4a8a-150">En Windows XP, mantener las conexiones activas también se activan para las llamadas RPC asincrónicas.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-150">For Windows XP, keep alives are turned on for asynchronous RPC calls as well.</span></span>

<span data-ttu-id="b4a8a-151">Es tentador establecer Keep alives en el valor más bajo para asegurarse de que la aplicación cliente responde a los problemas de la red de manera puntual.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-151">It is tempting to set keep alives to the lowest value to ensure the client application responds to network problems in a timely fashion.</span></span> <span data-ttu-id="b4a8a-152">Se debe tener en cuenta el cuidado y el escrutinio aplicados a si se garantiza un valor agresivo.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-152">Careful consideration should be given to such temptation, and scrutiny applied to whether an aggressive value is warranted.</span></span> <span data-ttu-id="b4a8a-153">Un servidor que pierde temporalmente la conectividad se puede desbordar con mantener conexiones de varios clientes una vez que se restaure la conectividad.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-153">A server that temporarily loses connectivity may find itself flooded with keep alives from numerous clients once connectivity is restored.</span></span> <span data-ttu-id="b4a8a-154">Además, las tareas de cálculo largas pueden tardar más de dos minutos, y el servidor puede que se encuentre en un tiempo mayor que la respuesta a la espera de tiempo de CPU que la realización de un trabajo útil.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-154">In addition, long computational tasks can take more than two minutes, and the server may find itself spending more CPU time answering keep alives than performing useful work.</span></span> <span data-ttu-id="b4a8a-155">Por lo tanto, las conexiones Keep Alive deben usarse con moderación.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-155">Therefore, keep alives should be used with moderation.</span></span> <span data-ttu-id="b4a8a-156">Si el cliente no puede tolerar que el subproceso se esté enlazando durante períodos largos, se debe tener en cuenta la RPC asincrónica.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-156">If the client cannot tolerate its thread being tied up for long periods, asynchronous RPC should be considered.</span></span>

<span data-ttu-id="b4a8a-157">Otras secuencias de protocolos pueden implementar mecanismos diferentes para detectar servidores que no responden, en función del transporte que se utilice.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-157">Other protocol sequences may implement different mechanisms for detecting unresponsive servers, depending on which transport is used.</span></span> <span data-ttu-id="b4a8a-158">El transporte [**ncalrpc**](/windows/desktop/Midl/ncalrpc) no usa Keep alives.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-158">The [**ncalrpc**](/windows/desktop/Midl/ncalrpc) transport does not use keep alives.</span></span> <span data-ttu-id="b4a8a-159">Dado que todas las comunicaciones de **ncalrpc** son locales, si el servidor deja de responder mientras se está realizando una llamada, el tiempo de ejecución de RPC en el cliente produce un error inmediato en la llamada.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-159">Since all communications in **ncalrpc** are local, if the server becomes unresponsive while a call is in progress, the RPC run time on the client immediately fails the call.</span></span>

## <a name="call-time-outs"></a><span data-ttu-id="b4a8a-160">Tiempo de espera de llamadas</span><span class="sxs-lookup"><span data-stu-id="b4a8a-160">Call Time Outs</span></span>

<span data-ttu-id="b4a8a-161">TCP Keep alives está bien si se pierde la conectividad de red o si se bloquea el servidor.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-161">TCP keep alives are fine if network connectivity is lost, or if the server crashes.</span></span> <span data-ttu-id="b4a8a-162">Pero si el servidor se bloquea en modo de usuario, TCP Keep alives se devuelve correctamente, pero la llamada nunca devolverá.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-162">But if the server deadlocks in user mode, TCP keep alives return successfully but the call will never return.</span></span> <span data-ttu-id="b4a8a-163">Para tratar este escenario, se ha agregado una nueva opción en tiempo de ejecución para Windows XP: \_ tiempo de espera de llamada de RPC C \_ OPT \_ \_ .</span><span class="sxs-lookup"><span data-stu-id="b4a8a-163">To deal with this scenario, a new run-time option was added for Windows XP: RPC\_C\_OPT\_CALL\_TIMEOUT.</span></span> <span data-ttu-id="b4a8a-164">Esta opción indica al tiempo de ejecución de RPC que configure un temporizador cada vez que envíe una solicitud al servidor.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-164">This option instructs the RPC run time to set up a timer each time it sends a request to the server.</span></span> <span data-ttu-id="b4a8a-165">Si el temporizador expira, la llamada se cancela automáticamente y se completa con la llamada de \_ RPC \_ S \_ cancelada.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-165">If the timer expires, the call is automatically canceled and completes with RPC\_S\_CALL\_CANCELLED.</span></span> <span data-ttu-id="b4a8a-166">Siempre que el servidor responda dentro del límite de tiempo especificado, el cliente no cancelará la llamada.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-166">As long as the server responds within the specified time limit, the client will not cancel the call.</span></span> <span data-ttu-id="b4a8a-167">Esto significa que una llamada de varios fragmentos puede tardar más que el tiempo de espera para completarse, ya que cada respuesta del servidor se recibe dentro del período de tiempo de espera, aunque el período de tiempo para que lleguen todas las respuestas supera el período de tiempo de espera.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-167">This means a multifragment call may take more than the time-out period to complete, as each response from the server is received within the time-out period, even though the time period for all responses to arrive was more than the time-out period.</span></span>

<span data-ttu-id="b4a8a-168">Además, cuando se cancela una llamada, el servidor no recibe una notificación de la cancelación.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-168">Also, when a call is canceled the server is not notified of the cancellation.</span></span> <span data-ttu-id="b4a8a-169">Por lo tanto, el servidor probablemente ejecutará la llamada en algún momento y el cliente simplemente omitirá la respuesta del servidor.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-169">The server, therefore, will likely execute the call at some point, and the client will simply ignore the response from the server.</span></span>

<span data-ttu-id="b4a8a-170">La dificultad más peligrosa con el tiempo de espera de la llamada es establecer un tiempo de espera corto y volver a intentar la llamada en el mismo servidor.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-170">The most dangerous pitfall with call time outs is establishing a short time out and retrying the call on the same server.</span></span> <span data-ttu-id="b4a8a-171">En el escenario siguiente se muestran los peligros de este enfoque:</span><span class="sxs-lookup"><span data-stu-id="b4a8a-171">The following scenario illustrates the dangers of this approach:</span></span>

<span data-ttu-id="b4a8a-172">Imagine un servidor que funciona cerca de su capacidad.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-172">Imagine a server that operates near capacity.</span></span> <span data-ttu-id="b4a8a-173">Tiene varios clientes con tiempos de espera muy cortos, como cinco segundos.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-173">It has a number of clients with very short time outs, such as five seconds.</span></span> <span data-ttu-id="b4a8a-174">Una pérdida temporal de la conectividad de red o la congestión en un enrutador produce una interrupción en las respuestas del servidor durante unos segundos.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-174">A temporary loss of network connectivity or congestion at a router causes a lapse in server replies for a few seconds.</span></span> <span data-ttu-id="b4a8a-175">En redes Ethernet, esta situación se puede deber fácilmente a una ráfaga de actividad en un vínculo que el servidor comparte con otro equipo.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-175">On Ethernet networks, this situation can easily be caused by a burst of activity on a link that the server shares with another machine.</span></span> <span data-ttu-id="b4a8a-176">El servidor no administra para enviar todas las respuestas antes de que se agote el tiempo de espera de cinco segundos. Los clientes obtienen sus llamadas canceladas e intentan de inmediato.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-176">The server does not manage to send all replies before the five-second time out. The clients get their calls canceled, and immediately retry.</span></span> <span data-ttu-id="b4a8a-177">El servidor no es consciente de que las llamadas son reintentos y las ejecuta también.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-177">The server is not aware the calls are retries, and executes them as well.</span></span> <span data-ttu-id="b4a8a-178">Por lo tanto, en lugar de ejecutar su carga de trabajo normal de llamadas, ejecuta 30-50% más llamadas, dependiendo de cuántos clientes hayan agotado el tiempo de espera. Si esto supera su capacidad y el servidor no puede responder a todos los clientes en un plazo de cinco segundos, se envía otra ronda de llamadas al servidor.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-178">Thus, instead of executing its normal workload of calls, it executes 30-50% more calls, depending on how many clients timed out. If this exceeds its capacity, and the server cannot respond to all clients within five seconds, another round of calls are sent to the server.</span></span> <span data-ttu-id="b4a8a-179">Los clientes siguen reemitiendo las mismas llamadas y, dado que el servidor está sobrecargado en el procesamiento de llamadas anteriores, no puede responder dentro del tiempo de espera. Una vez que responde, los clientes han alcanzado el tiempo de espera, ha emitido una nueva llamada y descartado la respuesta.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-179">The clients keep reissuing the same calls, and since the server is overloaded processing previous calls, it is unable to respond within the time out. Once it responds, the clients have hit the time out, issued a new call, and discarded the answer.</span></span> <span data-ttu-id="b4a8a-180">En el peor de los casos, el servidor no se recuperará hasta que se reinicie y, según el patrón de acceso de cliente, no se pueda recuperar hasta que se detenga un número suficiente de clientes.</span><span class="sxs-lookup"><span data-stu-id="b4a8a-180">In a worst case scenario, the server will not recover until reboot, and depending on client access pattern, may not recover until a sufficient number of clients are stopped.</span></span>

> [!Note]  
> <span data-ttu-id="b4a8a-181">Los tiempos de espera de la llamada solo funcionan en las secuencias de protocolo [**\_ \_ TCP IP ncacn**](/windows/desktop/Midl/ncacn-ip-tcp) y [**ncacn \_ http**](/windows/desktop/Midl/ncacn-http) .</span><span class="sxs-lookup"><span data-stu-id="b4a8a-181">Call time outs work only on the [**ncacn\_ip\_tcp**](/windows/desktop/Midl/ncacn-ip-tcp) and [**ncacn\_http**](/windows/desktop/Midl/ncacn-http) protocol sequences.</span></span>

 

 

 