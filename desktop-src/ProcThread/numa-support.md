---
description: El modelo tradicional para la compatibilidad con varios procesadores es el multiprocesador simétrico (SMP). En este modelo, cada procesador tiene el mismo acceso a la memoria y la E/S. A medida que se agregan más procesadores, el bus de procesador se convierte en una limitación del rendimiento del sistema.
ms.assetid: a1263968-2b26-45cc-bdd7-6aa354821a5a
title: Compatibilidad NUMA
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 178f53c6b55b6ae291cd5cdcf99386515a441094
ms.sourcegitcommit: f848119a8faa29b27585f4df53f6e50ee9666684
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 05/27/2021
ms.locfileid: "110549810"
---
# <a name="numa-support"></a><span data-ttu-id="5c637-105">Compatibilidad NUMA</span><span class="sxs-lookup"><span data-stu-id="5c637-105">NUMA Support</span></span>

<span data-ttu-id="5c637-106">El modelo tradicional para la compatibilidad con varios procesadores es el multiprocesador simétrico (SMP).</span><span class="sxs-lookup"><span data-stu-id="5c637-106">The traditional model for multiprocessor support is symmetric multiprocessor (SMP).</span></span> <span data-ttu-id="5c637-107">En este modelo, cada procesador tiene el mismo acceso a la memoria y la E/S.</span><span class="sxs-lookup"><span data-stu-id="5c637-107">In this model, each processor has equal access to memory and I/O.</span></span> <span data-ttu-id="5c637-108">A medida que se agregan más procesadores, el bus de procesador se convierte en una limitación del rendimiento del sistema.</span><span class="sxs-lookup"><span data-stu-id="5c637-108">As more processors are added, the processor bus becomes a limitation for system performance.</span></span>

<span data-ttu-id="5c637-109">Los diseñadores del sistema usan el acceso no uniforme a memoria (NUMA) para aumentar la velocidad del procesador sin aumentar la carga en el bus de procesador.</span><span class="sxs-lookup"><span data-stu-id="5c637-109">System designers use non-uniform memory access (NUMA) to increase processor speed without increasing the load on the processor bus.</span></span> <span data-ttu-id="5c637-110">La arquitectura no es uniforme porque cada procesador está cerca de algunas partes de la memoria y más lejos de otras partes de la memoria.</span><span class="sxs-lookup"><span data-stu-id="5c637-110">The architecture is non-uniform because each processor is close to some parts of memory and farther from other parts of memory.</span></span> <span data-ttu-id="5c637-111">El procesador obtiene rápidamente acceso a la memoria a la que está cerca, mientras que puede tardar más tiempo en obtener acceso a la memoria que está más lejos.</span><span class="sxs-lookup"><span data-stu-id="5c637-111">The processor quickly gains access to the memory it is close to, while it can take longer to gain access to memory that is farther away.</span></span>

<span data-ttu-id="5c637-112">En un sistema NUMA, las CPU se organizan en sistemas más pequeños *denominados nodos*.</span><span class="sxs-lookup"><span data-stu-id="5c637-112">In a NUMA system, CPUs are arranged in smaller systems called *nodes*.</span></span> <span data-ttu-id="5c637-113">Cada nodo tiene sus propios procesadores y memoria, y está conectado al sistema más grande a través de un bus de interconexión coherente con caché.</span><span class="sxs-lookup"><span data-stu-id="5c637-113">Each node has its own processors and memory, and is connected to the larger system through a cache-coherent interconnect bus.</span></span>

<span data-ttu-id="5c637-114">El sistema intenta mejorar el rendimiento programando subprocesos en procesadores que se encuentran en el mismo nodo que la memoria que se usa.</span><span class="sxs-lookup"><span data-stu-id="5c637-114">The system attempts to improve performance by scheduling threads on processors that are in the same node as the memory being used.</span></span> <span data-ttu-id="5c637-115">Intenta satisfacer las solicitudes de asignación de memoria desde dentro del nodo, pero asignará memoria de otros nodos si es necesario.</span><span class="sxs-lookup"><span data-stu-id="5c637-115">It attempts to satisfy memory-allocation requests from within the node, but will allocate memory from other nodes if necessary.</span></span> <span data-ttu-id="5c637-116">También proporciona una API para que la topología del sistema esté disponible para las aplicaciones.</span><span class="sxs-lookup"><span data-stu-id="5c637-116">It also provides an API to make the topology of the system available to applications.</span></span> <span data-ttu-id="5c637-117">Puede mejorar el rendimiento de las aplicaciones mediante las funciones NUMA para optimizar la programación y el uso de memoria.</span><span class="sxs-lookup"><span data-stu-id="5c637-117">You can improve the performance of your applications by using the NUMA functions to optimize scheduling and memory usage.</span></span>

<span data-ttu-id="5c637-118">En primer lugar, deberá determinar el diseño de los nodos del sistema.</span><span class="sxs-lookup"><span data-stu-id="5c637-118">First of all, you will need to determine the layout of nodes in the system.</span></span> <span data-ttu-id="5c637-119">Para recuperar el nodo numerado más alto del sistema, use la [**función GetNumaHighestNodeNumber.**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumahighestnodenumber)</span><span class="sxs-lookup"><span data-stu-id="5c637-119">To retrieve the highest numbered node in the system, use the [**GetNumaHighestNodeNumber**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumahighestnodenumber) function.</span></span> <span data-ttu-id="5c637-120">Tenga en cuenta que no se garantiza que este número sea igual al número total de nodos del sistema.</span><span class="sxs-lookup"><span data-stu-id="5c637-120">Note that this number is not guaranteed to equal the total number of nodes in the system.</span></span> <span data-ttu-id="5c637-121">Además, no se garantiza que los nodos con números secuenciales estén juntos.</span><span class="sxs-lookup"><span data-stu-id="5c637-121">Also, nodes with sequential numbers are not guaranteed to be close together.</span></span> <span data-ttu-id="5c637-122">Para recuperar la lista de procesadores del sistema, use la [**función GetProcessAffinityMask.**](/windows/desktop/api/WinBase/nf-winbase-getprocessaffinitymask)</span><span class="sxs-lookup"><span data-stu-id="5c637-122">To retrieve the list of processors on the system, use the [**GetProcessAffinityMask**](/windows/desktop/api/WinBase/nf-winbase-getprocessaffinitymask) function.</span></span> <span data-ttu-id="5c637-123">Puede determinar el nodo de cada procesador de la lista mediante la [**función GetNumaProcessorNode.**](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornode)</span><span class="sxs-lookup"><span data-stu-id="5c637-123">You can determine the node for each processor in the list by using the [**GetNumaProcessorNode**](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornode) function.</span></span> <span data-ttu-id="5c637-124">Como alternativa, para recuperar una lista de todos los procesadores de un nodo, use la [**función GetNumaNodeProcessorMask.**](/windows/desktop/api/WinBase/nf-winbase-getnumanodeprocessormask)</span><span class="sxs-lookup"><span data-stu-id="5c637-124">Alternatively, to retrieve a list of all processors in a node, use the [**GetNumaNodeProcessorMask**](/windows/desktop/api/WinBase/nf-winbase-getnumanodeprocessormask) function.</span></span>

<span data-ttu-id="5c637-125">Después de determinar qué procesadores pertenecen a qué nodos, puede optimizar el rendimiento de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="5c637-125">After you have determined which processors belong to which nodes, you can optimize your application's performance.</span></span> <span data-ttu-id="5c637-126">Para asegurarse de que todos los subprocesos del proceso se ejecutan en el mismo nodo, use la función [**SetProcessAffinityMask**](/windows/desktop/api/WinBase/nf-winbase-setprocessaffinitymask) con una máscara de afinidad de proceso que especifique procesadores en el mismo nodo.</span><span class="sxs-lookup"><span data-stu-id="5c637-126">To ensure that all threads for your process run on the same node, use the [**SetProcessAffinityMask**](/windows/desktop/api/WinBase/nf-winbase-setprocessaffinitymask) function with a process affinity mask that specifies processors in the same node.</span></span> <span data-ttu-id="5c637-127">Esto aumenta la eficacia de las aplicaciones cuyos subprocesos necesitan acceder a la misma memoria.</span><span class="sxs-lookup"><span data-stu-id="5c637-127">This increases the efficiency of applications whose threads need to access the same memory.</span></span> <span data-ttu-id="5c637-128">Como alternativa, para limitar el número de subprocesos en cada nodo, use la [**función SetThreadAffinityMask.**](/windows/desktop/api/WinBase/nf-winbase-setthreadaffinitymask)</span><span class="sxs-lookup"><span data-stu-id="5c637-128">Alternatively, to limit the number of threads on each node, use the [**SetThreadAffinityMask**](/windows/desktop/api/WinBase/nf-winbase-setthreadaffinitymask) function.</span></span>

<span data-ttu-id="5c637-129">Las aplicaciones que consumen mucha memoria tendrán que optimizar su uso de memoria.</span><span class="sxs-lookup"><span data-stu-id="5c637-129">Memory-intensive applications will need to optimize their memory usage.</span></span> <span data-ttu-id="5c637-130">Para recuperar la cantidad de memoria disponible para un nodo, use la [**función GetNumaAvailableMemoryNode.**](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynode)</span><span class="sxs-lookup"><span data-stu-id="5c637-130">To retrieve the amount of free memory available to a node, use the [**GetNumaAvailableMemoryNode**](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynode) function.</span></span> <span data-ttu-id="5c637-131">La [**función VirtualAllocExNuma permite**](/windows/win32/api/memoryapi/nf-memoryapi-virtualallocexnuma) a la aplicación especificar un nodo preferido para la asignación de memoria.</span><span class="sxs-lookup"><span data-stu-id="5c637-131">The [**VirtualAllocExNuma**](/windows/win32/api/memoryapi/nf-memoryapi-virtualallocexnuma) function enables the application to specify a preferred node for the memory allocation.</span></span> <span data-ttu-id="5c637-132">**VirtualAllocExNuma** no asigna ninguna página física, por lo que se realizará correctamente tanto si las páginas están disponibles en ese nodo como en otra parte del sistema.</span><span class="sxs-lookup"><span data-stu-id="5c637-132">**VirtualAllocExNuma** does not allocate any physical pages, so it will succeed whether or not the pages are available on that node or elsewhere in the system.</span></span> <span data-ttu-id="5c637-133">Las páginas físicas se asignan a petición.</span><span class="sxs-lookup"><span data-stu-id="5c637-133">The physical pages are allocated on demand.</span></span> <span data-ttu-id="5c637-134">Si el nodo preferido se queda sin páginas, el administrador de memoria usará páginas de otros nodos.</span><span class="sxs-lookup"><span data-stu-id="5c637-134">If the preferred node runs out of pages, the memory manager will use pages from other nodes.</span></span> <span data-ttu-id="5c637-135">Si se pagina la memoria, se usa el mismo proceso cuando se vuelve a traer.</span><span class="sxs-lookup"><span data-stu-id="5c637-135">If the memory is paged out, the same process is used when it is brought back in.</span></span>

### <a name="numa-support-on-systems-with-more-than-64-logical-processors"></a><span data-ttu-id="5c637-136">Compatibilidad con NUMA en sistemas con más de 64 procesadores lógicos</span><span class="sxs-lookup"><span data-stu-id="5c637-136">NUMA Support on Systems With More Than 64 Logical Processors</span></span>

<span data-ttu-id="5c637-137">En sistemas con más de 64 procesadores lógicos, los nodos se asignan a grupos de procesadores [según](processor-groups.md) la capacidad de los nodos.</span><span class="sxs-lookup"><span data-stu-id="5c637-137">On systems with more than 64 logical processors, nodes are assigned to [processor groups](processor-groups.md) according to the capacity of the nodes.</span></span> <span data-ttu-id="5c637-138">La capacidad de un nodo es el número de procesadores que están presentes cuando el sistema se inicia junto con cualquier procesador lógico adicional que se pueda agregar mientras se ejecuta el sistema.</span><span class="sxs-lookup"><span data-stu-id="5c637-138">The capacity of a node is the number of processors that are present when the system starts together with any additional logical processors that can be added while the system is running.</span></span>

<span data-ttu-id="5c637-139">**Windows Server 2008, Windows Vista, Windows Server 2003 y Windows XP:** No se admiten grupos de procesadores.</span><span class="sxs-lookup"><span data-stu-id="5c637-139">**Windows Server 2008, Windows Vista, Windows Server 2003 and Windows XP:** Processor groups are not supported.</span></span>

<span data-ttu-id="5c637-140">Cada nodo debe estar totalmente contenido dentro de un grupo.</span><span class="sxs-lookup"><span data-stu-id="5c637-140">Each node must be fully contained within a group.</span></span> <span data-ttu-id="5c637-141">Si las capacidades de los nodos son relativamente pequeñas, el sistema asigna más de un nodo al mismo grupo, eligiendo nodos físicamente cercanos entre sí para mejorar el rendimiento.</span><span class="sxs-lookup"><span data-stu-id="5c637-141">If the capacities of the nodes are relatively small, the system assigns more than one node to the same group, choosing nodes that are physically close to one another for better performance.</span></span> <span data-ttu-id="5c637-142">Si la capacidad de un nodo supera el número máximo de procesadores de un grupo, el sistema divide el nodo en varios nodos más pequeños, cada uno lo suficientemente pequeño como para caber en un grupo.</span><span class="sxs-lookup"><span data-stu-id="5c637-142">If a node's capacity exceeds the maximum number of processors in a group, the system splits the node into multiple smaller nodes, each small enough to fit in a group.</span></span>

<span data-ttu-id="5c637-143">Se puede solicitar un nodo NUMA ideal para un nuevo proceso mediante el atributo [**extendido PROC THREAD ATTRIBUTE PREFERRED \_ \_ \_ \_ NODE**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute) cuando se crea el proceso.</span><span class="sxs-lookup"><span data-stu-id="5c637-143">An ideal NUMA node for a new process can be requested using the [**PROC\_THREAD\_ATTRIBUTE\_PREFERRED\_NODE**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute) extended attribute when the process is created.</span></span> <span data-ttu-id="5c637-144">Al igual que un procesador ideal para subprocesos, el nodo ideal es una sugerencia para el programador, que asigna el nuevo proceso al grupo que contiene el nodo solicitado si es posible.</span><span class="sxs-lookup"><span data-stu-id="5c637-144">Like a thread ideal processor, the ideal node is a hint to the scheduler, which assigns the new process to the group that contains the requested node if possible.</span></span>

<span data-ttu-id="5c637-145">Las funciones NUMA extendidas [**GetNumaAvailableMemoryNodeEx**](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynodeex), [**GetNumaNodeProcessorMaskEx,**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumanodeprocessormaskex) [**GetNumaProcessorNodeEx**](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornodeex)y [**GetNumaProximityNodeEx**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumaproximitynodeex) difieren de sus homólogos no extendidos en que el número de nodo es un valor **USHORT** en lugar de **un UCHAR**, para dar cabida al número potencialmente mayor de nodos en un sistema con más de 64 procesadores lógicos.</span><span class="sxs-lookup"><span data-stu-id="5c637-145">The extended NUMA functions [**GetNumaAvailableMemoryNodeEx**](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynodeex), [**GetNumaNodeProcessorMaskEx**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumanodeprocessormaskex), [**GetNumaProcessorNodeEx**](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornodeex), and [**GetNumaProximityNodeEx**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumaproximitynodeex) differ from their unextended counterparts in that the node number is a **USHORT** value rather than a **UCHAR**, to accommodate the potentially greater number of nodes on a system with more than 64 logical processors.</span></span> <span data-ttu-id="5c637-146">Además, el procesador especificado con o recuperado por las funciones extendidas incluye el grupo de procesadores; el procesador especificado con o recuperado por las funciones no existentes es relativo al grupo.</span><span class="sxs-lookup"><span data-stu-id="5c637-146">Also, the processor specified with or retrieved by the extended functions includes the processor group; the processor specified with or retrieved by the unextended functions is group-relative.</span></span> <span data-ttu-id="5c637-147">Para más información, consulte los temas de referencia de funciones individuales.</span><span class="sxs-lookup"><span data-stu-id="5c637-147">For details, see the individual function reference topics.</span></span>

<span data-ttu-id="5c637-148">Una aplicación para grupos puede asignar todos sus subprocesos a un nodo determinado de forma similar a la descrita anteriormente en este tema, mediante las funciones NUMA extendidas correspondientes.</span><span class="sxs-lookup"><span data-stu-id="5c637-148">A group-aware application can assign all of its threads to a particular node in a similar fashion to that described earlier in this topic, using the corresponding extended NUMA functions.</span></span> <span data-ttu-id="5c637-149">La aplicación usa [**GetLogicalProcessorInformationEx para**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getlogicalprocessorinformationex) obtener la lista de todos los procesadores del sistema.</span><span class="sxs-lookup"><span data-stu-id="5c637-149">The application uses [**GetLogicalProcessorInformationEx**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getlogicalprocessorinformationex) to get the list of all processors on the system.</span></span> <span data-ttu-id="5c637-150">Tenga en cuenta que la aplicación no puede establecer la máscara de afinidad de proceso a menos que el proceso se asigne a un único grupo y el nodo previsto se encuentra en ese grupo.</span><span class="sxs-lookup"><span data-stu-id="5c637-150">Note that the application cannot set the process affinity mask unless the process is assigned to a single group and the intended node is located in that group.</span></span> <span data-ttu-id="5c637-151">Normalmente, la aplicación debe llamar [**a SetThreadGroupAffinity**](/windows/win32/api/processtopologyapi/nf-processtopologyapi-setthreadgroupaffinity) para limitar sus subprocesos al nodo previsto.</span><span class="sxs-lookup"><span data-stu-id="5c637-151">Usually the application must call [**SetThreadGroupAffinity**](/windows/win32/api/processtopologyapi/nf-processtopologyapi-setthreadgroupaffinity) to limit its threads to the intended node.</span></span>


### <a name="behavior-starting-with-windows-10-build-20348"></a><span data-ttu-id="5c637-152">Comportamiento a partir de Windows 10 compilación 20348</span><span class="sxs-lookup"><span data-stu-id="5c637-152">Behavior starting with Windows 10 Build 20348</span></span> 

> [!NOTE]
> <span data-ttu-id="5c637-153">A partir de Windows 10 Compilación 20348, el comportamiento de esta y otras funciones NUMA se ha modificado para admitir mejor los sistemas con nodos que contienen más de 64 procesadores.</span><span class="sxs-lookup"><span data-stu-id="5c637-153">Starting with Windows 10 Build 20348, the behavior of this and other NUMA functions has been modified to better support systems with nodes containing more that 64 processors.</span></span>

<span data-ttu-id="5c637-154">La creación de nodos "falsos" para dar cabida a una asignación 1:1 entre grupos y nodos ha dado lugar a comportamientos confusos en los que se notifican números inesperados de nodos NUMA y, por lo tanto, a partir de la compilación 20348 de Windows 10, el sistema operativo ha cambiado para permitir que varios grupos se asocien a un nodo, por lo que ahora se puede informar de la verdadera topología NUMA del sistema.</span><span class="sxs-lookup"><span data-stu-id="5c637-154">Creating "fake" nodes to accommodate a 1:1 mapping between groups and nodes has resulted in confusing behaviors where unexpected numbers of NUMA nodes are reported and so, starting with Windows 10 Build 20348, the OS has changed to allow multiple groups to be associated with a node, and so now the true NUMA topology of the system can be reported.</span></span>  

<span data-ttu-id="5c637-155">Como parte de estos cambios en el sistema operativo, varias API NUMA han cambiado para admitir la presentación de informes de varios grupos que ahora se pueden asociar a un único nodo NUMA.</span><span class="sxs-lookup"><span data-stu-id="5c637-155">As part of these changes to the OS, a number of NUMA APIs have changed to support reporting the multiple groups which can now be associated with a single NUMA node.</span></span> <span data-ttu-id="5c637-156">Las API nuevas y actualizadas se etiquetan en la tabla de la sección **API NUMA** siguiente.</span><span class="sxs-lookup"><span data-stu-id="5c637-156">Updated and new APIs are labeled in the table in the **NUMA API** section below.</span></span>

<span data-ttu-id="5c637-157">Dado que la eliminación de la división de nodos puede afectar potencialmente a las aplicaciones existentes, hay un valor del Registro disponible para permitir volver al comportamiento de división de nodos heredado.</span><span class="sxs-lookup"><span data-stu-id="5c637-157">Because the removal of node splitting can potentially impact existing applications, a registry value is available to allow opting back into the legacy node splitting behavior.</span></span> <span data-ttu-id="5c637-158">La división de nodos se puede volver **a** habilitar mediante la creación de un valor REG_DWORD denominado "SplitLargeNodes" con el valor 1 debajo de HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\NUMA.</span><span class="sxs-lookup"><span data-stu-id="5c637-158">Node splitting can be re-enabled by creating a **REG_DWORD** value named "SplitLargeNodes" with value 1 underneath HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\NUMA.</span></span> <span data-ttu-id="5c637-159">Los cambios en esta configuración requieren un reinicio para que su efecto.</span><span class="sxs-lookup"><span data-stu-id="5c637-159">Changes to this setting require a reboot to take effect.</span></span>

```powershell
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\NUMA" /v SplitLargeNumaNodes /t REG_DWORD /v 1
```

> [!NOTE]
> <span data-ttu-id="5c637-160">Las aplicaciones que se actualizan para usar la nueva funcionalidad de API que informa de la verdadera topología NUMA seguirán funcionando correctamente en sistemas donde se ha habilitado la división de nodos grandes con esta clave del Registro.</span><span class="sxs-lookup"><span data-stu-id="5c637-160">Applications that are updated to use the new API functionality that reports the true NUMA topology will continue to work properly on systems where large node splitting has been reenabled with this registry key.</span></span>

<span data-ttu-id="5c637-161">En el ejemplo siguiente se muestran en primer lugar posibles problemas con las tablas de compilaciones que asigna procesadores a nodos NUMA mediante las API de afinidad heredadas, que ya no proporcionan una cobertura completa de todos los procesadores del sistema, lo que puede dar lugar a una tabla incompleta.</span><span class="sxs-lookup"><span data-stu-id="5c637-161">The following example first demonstrates potential issues with builds tables mapping processors to NUMA nodes using the legacy affinity APIs, which no longer provide a full cover of all processors in the system this can result in an incomplete table.</span></span> <span data-ttu-id="5c637-162">Las implicaciones de este tipo de inconsitudencia dependen del contenido de la tabla.</span><span class="sxs-lookup"><span data-stu-id="5c637-162">The implications of such incompleteness depend on the contents of the table.</span></span> <span data-ttu-id="5c637-163">Si la tabla simplemente almacena el número de nodo correspondiente, es probable que esto sea solo un problema de rendimiento con procesadores descubiertos que se quedan como parte del nodo 0.</span><span class="sxs-lookup"><span data-stu-id="5c637-163">If the table simply stores the corresponding node number then this is likely only a performance issue with uncovered processors being left as part of node 0.</span></span> <span data-ttu-id="5c637-164">Sin embargo, si la tabla contiene punteros a una estructura de contexto por nodo, esto puede dar lugar a desreferencias NULL en tiempo de ejecución.</span><span class="sxs-lookup"><span data-stu-id="5c637-164">However, if the table contains pointers to a per-node context structure this can result in NULL dereferences at runtime.</span></span>

<span data-ttu-id="5c637-165">A continuación, en el ejemplo de código se muestran dos soluciones alternativas para el problema.</span><span class="sxs-lookup"><span data-stu-id="5c637-165">Next, the code example illustrates two workarounds for the issue.</span></span> <span data-ttu-id="5c637-166">La primera es migrar a las API de afinidad de nodo de varios grupos (modo de usuario y modo kernel).</span><span class="sxs-lookup"><span data-stu-id="5c637-166">The first is to migrate to the multi-group node affinity APIs (user-mode and kernel-mode).</span></span> <span data-ttu-id="5c637-167">La segunda es usar **KeQueryLogicalProcessorRelationship para** consultar directamente el nodo NUMA asociado a un número de procesador determinado.</span><span class="sxs-lookup"><span data-stu-id="5c637-167">The second is to use **KeQueryLogicalProcessorRelationship** to directly query the NUMA node associated with a given processor number.</span></span>

```cpp

//
// Problematic implementation using KeQueryNodeActiveAffinity.
//

USHORT CurrentNode;
USHORT HighestNodeNumber;
GROUP_AFFINITY NodeAffinity;
ULONG ProcessorIndex;
PROCESSOR_NUMBER ProcessorNumber;

HighestNodeNumber = KeQueryHighestNodeNumber();
for (CurrentNode = 0; CurrentNode <= HighestNodeNumber; CurrentNode += 1) {

    KeQueryNodeActiveAffinity(CurrentNode, &NodeAffinity, NULL);
    while (NodeAffinity.Mask != 0) {

        ProcessorNumber.Group = NodeAffinity.Group;
        BitScanForward(&ProcessorNumber.Number, NodeAffinity.Mask);

        ProcessorIndex = KeGetProcessorIndexFromNumber(&ProcessorNumber);

        ProcessorNodeContexts[ProcessorIndex] = NodeContexts[CurrentNode;]

        NodeAffinity.Mask &= ~((KAFFINITY)1 << ProcessorNumber.Number);
    }
}

//
// Resolution using KeQueryNodeActiveAffinity2.
//

USHORT CurrentIndex;
USHORT CurrentNode;
USHORT CurrentNodeAffinityCount;
USHORT HighestNodeNumber;
ULONG MaximumGroupCount;
PGROUP_AFFINITY NodeAffinityMasks;
ULONG ProcessorIndex;
PROCESSOR_NUMBER ProcessorNumber;
NTSTATUS Status;

MaximumGroupCount = KeQueryMaximumGroupCount();
NodeAffinityMasks = ExAllocatePool2(POOL_FLAG_PAGED,
                                    sizeof(GROUP_AFFINITY) * MaximumGroupCount,
                                    'tseT');

if (NodeAffinityMasks == NULL) {
    return STATUS_NO_MEMORY;
}

HighestNodeNumber = KeQueryHighestNodeNumber();
for (CurrentNode = 0; CurrentNode <= HighestNodeNumber; CurrentNode += 1) {

    Status = KeQueryNodeActiveAffinity2(CurrentNode,
                                        NodeAffinityMasks,
                                        MaximumGroupCount,
                                        &CurrentNodeAffinityCount);
    NT_ASSERT(NT_SUCCESS(Status));

    for (CurrentIndex = 0; CurrentIndex < CurrentNodeAffinityCount; CurrentIndex += 1) {

        CurrentAffinity = &NodeAffinityMasks[CurrentIndex];

        while (CurrentAffinity->Mask != 0) {

            ProcessorNumber.Group = CurrentAffinity.Group;
            BitScanForward(&ProcessorNumber.Number, CurrentAffinity->Mask);

            ProcessorIndex = KeGetProcessorIndexFromNumber(&ProcessorNumber);

            ProcessorNodeContexts[ProcessorIndex] = NodeContexts[CurrentNode];

            CurrentAffinity->Mask &= ~((KAFFINITY)1 << ProcessorNumber.Number);
        }
    }
}

//
// Resolution using KeQueryLogicalProcessorRelationship.
//

ULONG ProcessorCount;
ULONG ProcessorIndex;
SYSTEM_LOGICAL_PROCESSOR_INFORMATION_EX ProcessorInformation;
ULONG ProcessorInformationSize;
PROCESSOR_NUMBER ProcessorNumber;
NTSTATUS Status;

ProcessorCount = KeQueryActiveProcessorCountEx(ALL_PROCESSOR_GROUPS);

for (ProcessorIndex = 0; ProcessorIndex < ProcessorCount; ProcessorIndex += 1) {

    Status = KeGetProcessorNumberFromIndex(ProcessorIndex, &ProcessorNumber);
    NT_ASSERT(NT_SUCCESS(Status));

    ProcessorInformationSize = sizeof(ProcessorInformation);
    Status = KeQueryLogicalProcessorRelationship(&ProcessorNumber,
                                                    RelationNumaNode,
                                                    &ProcessorInformation,
                                                    &ProcesorInformationSize);
    NT_ASSERT(NT_SUCCESS(Status));

    NodeNumber = ProcessorInformation.NumaNode.NodeNumber;

    ProcessorNodeContexts[ProcessorIndex] = NodeContexts[NodeNumber];
}
```

## <a name="numa-api"></a><span data-ttu-id="5c637-168">NUMA API</span><span class="sxs-lookup"><span data-stu-id="5c637-168">NUMA API</span></span>

<span data-ttu-id="5c637-169">En la tabla siguiente se describe la API NUMA.</span><span class="sxs-lookup"><span data-stu-id="5c637-169">The following table describes the NUMA API.</span></span>



| <span data-ttu-id="5c637-170">Función</span><span class="sxs-lookup"><span data-stu-id="5c637-170">Function</span></span>                                                                     | <span data-ttu-id="5c637-171">Descripción</span><span class="sxs-lookup"><span data-stu-id="5c637-171">Description</span></span>                                                                                                                                                                                                                     |
|------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [<span data-ttu-id="5c637-172">**AllocateUserPhysicalPagesNuma**</span><span class="sxs-lookup"><span data-stu-id="5c637-172">**AllocateUserPhysicalPagesNuma**</span></span>](/windows/win32/api/memoryapi/nf-memoryapi-allocateuserphysicalpagesnuma)      | <span data-ttu-id="5c637-173">Asigna páginas de memoria física que se asignarán y desasignarán dentro de cualquier región de extensiones de ventana de direcciones [](../memory/address-windowing-extensions.md) (AWE) de un proceso especificado y especifica el nodo NUMA para la memoria física.</span><span class="sxs-lookup"><span data-stu-id="5c637-173">Allocates physical memory pages to be mapped and unmapped within any [Address Windowing Extensions](../memory/address-windowing-extensions.md) (AWE) region of a specified process and specifies the NUMA node for the physical memory.</span></span> |
| [<span data-ttu-id="5c637-174">**CreateFileMappingNuma**</span><span class="sxs-lookup"><span data-stu-id="5c637-174">**CreateFileMappingNuma**</span></span>](/windows/win32/api/memoryapi/nf-memoryapi-createfilemappingnumaw)                      | <span data-ttu-id="5c637-175">Crea o abre un objeto de asignación de archivos con nombre o sin nombre para un archivo especificado y especifica el nodo NUMA para la memoria física.</span><span class="sxs-lookup"><span data-stu-id="5c637-175">Creates or opens a named or unnamed file mapping object for a specified file, and specifies the NUMA node for the physical memory.</span></span>                                                                                              |
| [<span data-ttu-id="5c637-176">**GetLogicalProcessorInformation**</span><span class="sxs-lookup"><span data-stu-id="5c637-176">**GetLogicalProcessorInformation**</span></span>](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getlogicalprocessorinformation)     | <span data-ttu-id="5c637-177">Se actualizó Windows 10 compilación 20348.</span><span class="sxs-lookup"><span data-stu-id="5c637-177">Updated in Windows 10 Build 20348.</span></span> <span data-ttu-id="5c637-178">Recupera información sobre procesadores lógicos y hardware relacionado.</span><span class="sxs-lookup"><span data-stu-id="5c637-178">Retrieves information about logical processors and related hardware.</span></span>                                                                                                                                                            |
| [<span data-ttu-id="5c637-179">**GetLogicalProcessorInformationEx**</span><span class="sxs-lookup"><span data-stu-id="5c637-179">**GetLogicalProcessorInformationEx**</span></span>](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getlogicalprocessorinformationex) | <span data-ttu-id="5c637-180">Se actualizó Windows 10 compilación 20348.</span><span class="sxs-lookup"><span data-stu-id="5c637-180">Updated in Windows 10 Build 20348.</span></span> <span data-ttu-id="5c637-181">Recupera información sobre las relaciones de los procesadores lógicos y el hardware relacionado.</span><span class="sxs-lookup"><span data-stu-id="5c637-181">Retrieves information about the relationships of logical processors and related hardware.</span></span>                                                                                                                                       |
| [<span data-ttu-id="5c637-182">**GetNumaAvailableMemoryNode**</span><span class="sxs-lookup"><span data-stu-id="5c637-182">**GetNumaAvailableMemoryNode**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynode)             | <span data-ttu-id="5c637-183">Recupera la cantidad de memoria disponible en el nodo especificado.</span><span class="sxs-lookup"><span data-stu-id="5c637-183">Retrieves the amount of memory available in the specified node.</span></span>                                                                                                                                                                 |
| [<span data-ttu-id="5c637-184">**GetNumaAvailableMemoryNodeEx**</span><span class="sxs-lookup"><span data-stu-id="5c637-184">**GetNumaAvailableMemoryNodeEx**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynodeex)         | <span data-ttu-id="5c637-185">Recupera la cantidad de memoria disponible en un nodo especificado como **un valor USHORT.**</span><span class="sxs-lookup"><span data-stu-id="5c637-185">Retrieves the amount of memory available in a node specified as a **USHORT** value.</span></span>                                                                                                                                             |
| [<span data-ttu-id="5c637-186">**GetNumaHighestNodeNumber**</span><span class="sxs-lookup"><span data-stu-id="5c637-186">**GetNumaHighestNodeNumber**</span></span>](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumahighestnodenumber)                 | <span data-ttu-id="5c637-187">Recupera el nodo que tiene actualmente el número más alto.</span><span class="sxs-lookup"><span data-stu-id="5c637-187">Retrieves the node that currently has the highest number.</span></span>                                                                                                                                                                       |
| [<span data-ttu-id="5c637-188">**GetNumaNodeProcessorMask**</span><span class="sxs-lookup"><span data-stu-id="5c637-188">**GetNumaNodeProcessorMask**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumanodeprocessormask)                 | <span data-ttu-id="5c637-189">Se actualizó Windows 10 compilación 20348.</span><span class="sxs-lookup"><span data-stu-id="5c637-189">Updated in Windows 10 Build 20348.</span></span> <span data-ttu-id="5c637-190">Recupera la máscara del procesador para el nodo especificado.</span><span class="sxs-lookup"><span data-stu-id="5c637-190">Retrieves the processor mask for the specified node.</span></span>                                                                                                                                                                            |
| [<span data-ttu-id="5c637-191">**GetNumaNodeProcessorMask2**</span><span class="sxs-lookup"><span data-stu-id="5c637-191">**GetNumaNodeProcessorMask2**</span></span>](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumanodeprocessormask2)                         | <span data-ttu-id="5c637-192">Novedad de Windows 10 compilación 20348.</span><span class="sxs-lookup"><span data-stu-id="5c637-192">New in Windows 10 Build 20348.</span></span> <span data-ttu-id="5c637-193">Recupera la máscara de procesador de varios grupos del nodo especificado.</span><span class="sxs-lookup"><span data-stu-id="5c637-193">Retrieves the multi-group processor mask of the specified node.</span></span>                                                                                                                                                                          |
| [<span data-ttu-id="5c637-194">**GetNumaNodeProcessorMaskEx**</span><span class="sxs-lookup"><span data-stu-id="5c637-194">**GetNumaNodeProcessorMaskEx**</span></span>](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumanodeprocessormaskex)             | <span data-ttu-id="5c637-195">Se actualizó Windows 10 compilación 20348.</span><span class="sxs-lookup"><span data-stu-id="5c637-195">Updated in Windows 10 Build 20348.</span></span> <span data-ttu-id="5c637-196">Recupera la máscara de procesador para un nodo especificado como un **valor USHORT.**</span><span class="sxs-lookup"><span data-stu-id="5c637-196">Retrieves the processor mask for a node specified as a **USHORT** value.</span></span>                                                                                                                                                        |
| [<span data-ttu-id="5c637-197">**GetNumaProcessorNode**</span><span class="sxs-lookup"><span data-stu-id="5c637-197">**GetNumaProcessorNode**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornode)                         | <span data-ttu-id="5c637-198">Recupera el número de nodo para el procesador especificado.</span><span class="sxs-lookup"><span data-stu-id="5c637-198">Retrieves the node number for the specified processor.</span></span>                                                                                                                                                                          |
| [<span data-ttu-id="5c637-199">**GetNumaProcessorNodeEx**</span><span class="sxs-lookup"><span data-stu-id="5c637-199">**GetNumaProcessorNodeEx**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornodeex)                     | <span data-ttu-id="5c637-200">Recupera el número de nodo como un **valor USHORT** para el procesador especificado.</span><span class="sxs-lookup"><span data-stu-id="5c637-200">Retrieves the node number as a **USHORT** value for the specified processor.</span></span>                                                                                                                                                    |
| [<span data-ttu-id="5c637-201">**GetNumaProximityNode**</span><span class="sxs-lookup"><span data-stu-id="5c637-201">**GetNumaProximityNode**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumaproximitynode)                         | <span data-ttu-id="5c637-202">Recupera el número de nodo para el identificador de proximidad especificado.</span><span class="sxs-lookup"><span data-stu-id="5c637-202">Retrieves the node number for the specified proximity identifier.</span></span>                                                                                                                                                               |
| [<span data-ttu-id="5c637-203">**GetNumaProximityNodeEx**</span><span class="sxs-lookup"><span data-stu-id="5c637-203">**GetNumaProximityNodeEx**</span></span>](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumaproximitynodeex)                     | <span data-ttu-id="5c637-204">Recupera el número de nodo como un **valor USHORT** para el identificador de proximidad especificado.</span><span class="sxs-lookup"><span data-stu-id="5c637-204">Retrieves the node number as a **USHORT** value for the specified proximity identifier.</span></span>                                                                                                                                         |
| [<span data-ttu-id="5c637-205">**GetProcessDefaultCpuSetMasks**</span><span class="sxs-lookup"><span data-stu-id="5c637-205">**GetProcessDefaultCpuSetMasks**</span></span>](/windows/win32/api/processthreadsapi/nf-processthreadsapi-getprocessdefaultcpusetmasks)                     | <span data-ttu-id="5c637-206">Novedad de Windows 10 Compilación 20348.</span><span class="sxs-lookup"><span data-stu-id="5c637-206">New in Windows 10 Build 20348.</span></span> <span data-ttu-id="5c637-207">Recupera la lista de conjuntos de CPU del conjunto predeterminado de procesos establecido por SetProcessDefaultCpuSetMasks o SetProcessDefaultCpuSets.</span><span class="sxs-lookup"><span data-stu-id="5c637-207">Retrieves the list of CPU Sets in the process default set that was set by SetProcessDefaultCpuSetMasks or SetProcessDefaultCpuSets.</span></span>                                                                                                                                         |
| [<span data-ttu-id="5c637-208">**GetThreadSelectedCpuSetMasks**</span><span class="sxs-lookup"><span data-stu-id="5c637-208">**GetThreadSelectedCpuSetMasks**</span></span>](/windows/win32/api/processthreadsapi/nf-processthreadsapi-getthreadselectedcpusetmasks)                     | <span data-ttu-id="5c637-209">Novedad de Windows 10 Compilación 20348.</span><span class="sxs-lookup"><span data-stu-id="5c637-209">New in Windows 10 Build 20348.</span></span> <span data-ttu-id="5c637-210">Establece la asignación de conjuntos de CPU seleccionados para el subproceso especificado.</span><span class="sxs-lookup"><span data-stu-id="5c637-210">Sets the selected CPU Sets assignment for the specified thread.</span></span> <span data-ttu-id="5c637-211">Esta asignación invalida la asignación predeterminada del proceso, si se establece una.</span><span class="sxs-lookup"><span data-stu-id="5c637-211">This assignment overrides the process default assignment, if one is set.</span></span>                                                                                                                                          |
| [<span data-ttu-id="5c637-212">**MapViewOfFileExNuma**</span><span class="sxs-lookup"><span data-stu-id="5c637-212">**MapViewOfFileExNuma**</span></span>](/windows/win32/api/winbase/nf-winbase-mapviewoffileexnuma)                          | <span data-ttu-id="5c637-213">Asigna una vista de una asignación de archivos al espacio de direcciones de un proceso de llamada y especifica el nodo NUMA para la memoria física.</span><span class="sxs-lookup"><span data-stu-id="5c637-213">Maps a view of a file mapping into the address space of a calling process, and specifies the NUMA node for the physical memory.</span></span>                                                                                                 |
| [<span data-ttu-id="5c637-214">**SetProcessDefaultCpuSetMasks**</span><span class="sxs-lookup"><span data-stu-id="5c637-214">**SetProcessDefaultCpuSetMasks**</span></span>](/windows/win32/api/processthreadsapi/nf-processthreadsapi-setprocessdefaultcpusetmasks)                     | <span data-ttu-id="5c637-215">Novedad de Windows 10 Compilación 20348.</span><span class="sxs-lookup"><span data-stu-id="5c637-215">New in Windows 10 Build 20348.</span></span> <span data-ttu-id="5c637-216">Establece la asignación predeterminada de conjuntos de CPU para subprocesos en el proceso especificado.</span><span class="sxs-lookup"><span data-stu-id="5c637-216">Sets the default CPU Sets assignment for threads in the specified process.</span></span>                                                                                                                                          |
| [<span data-ttu-id="5c637-217">**SetThreadSelectedCpuSetMasks**</span><span class="sxs-lookup"><span data-stu-id="5c637-217">**SetThreadSelectedCpuSetMasks**</span></span>](/windows/win32/api/processthreadsapi/nf-processthreadsapi-setthreadselectedcpusetmasks)                     | <span data-ttu-id="5c637-218">Novedad de Windows 10 Compilación 20348.</span><span class="sxs-lookup"><span data-stu-id="5c637-218">New in Windows 10 Build 20348.</span></span> <span data-ttu-id="5c637-219">Establece la asignación de conjuntos de CPU seleccionados para el subproceso especificado.</span><span class="sxs-lookup"><span data-stu-id="5c637-219">Sets the selected CPU Sets assignment for the specified thread.</span></span> <span data-ttu-id="5c637-220">Esta asignación invalida la asignación predeterminada del proceso, si se establece una.</span><span class="sxs-lookup"><span data-stu-id="5c637-220">This assignment overrides the process default assignment, if one is set.</span></span>                                                                                                                                          |
| [<span data-ttu-id="5c637-221">**VirtualAllocExNuma**</span><span class="sxs-lookup"><span data-stu-id="5c637-221">**VirtualAllocExNuma**</span></span>](/windows/win32/api/memoryapi/nf-memoryapi-virtualallocexnuma)                            | <span data-ttu-id="5c637-222">Reserva o confirma una región de memoria dentro del espacio de direcciones virtuales del proceso especificado y especifica el nodo NUMA para la memoria física.</span><span class="sxs-lookup"><span data-stu-id="5c637-222">Reserves or commits a region of memory within the virtual address space of the specified process, and specifies the NUMA node for the physical memory.</span></span>                                                                          |



 

<span data-ttu-id="5c637-223">La [**función QueryWorkingSetEx**](/windows/win32/api/psapi/nf-psapi-queryworkingsetex) se puede usar para recuperar el nodo NUMA en el que se asigna una página.</span><span class="sxs-lookup"><span data-stu-id="5c637-223">The [**QueryWorkingSetEx**](/windows/win32/api/psapi/nf-psapi-queryworkingsetex) function can be used to retrieve the NUMA node on which a page is allocated.</span></span> <span data-ttu-id="5c637-224">Para obtener un ejemplo, vea [Asignación de memoria desde un nodo NUMA](../memory/allocating-memory-from-a-numa-node.md).</span><span class="sxs-lookup"><span data-stu-id="5c637-224">For an example, see [Allocating Memory from a NUMA Node](../memory/allocating-memory-from-a-numa-node.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="5c637-225">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="5c637-225">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="5c637-226">Asignación de memoria desde un nodo NUMA</span><span class="sxs-lookup"><span data-stu-id="5c637-226">Allocating Memory from a NUMA Node</span></span>](../memory/allocating-memory-from-a-numa-node.md)
</dt> <dt>

[<span data-ttu-id="5c637-227">Varios procesadores</span><span class="sxs-lookup"><span data-stu-id="5c637-227">Multiple Processors</span></span>](multiple-processors.md)
</dt> <dt>

[<span data-ttu-id="5c637-228">Grupos de procesadores</span><span class="sxs-lookup"><span data-stu-id="5c637-228">Processor Groups</span></span>](processor-groups.md)
</dt> </dl>

 

 
