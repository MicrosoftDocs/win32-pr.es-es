---
description: Las tareas previas a la copia de seguridad en VSS se centran en crear una instantánea de los volúmenes que contienen datos para la copia de seguridad.
ms.assetid: e6b082af-719b-4426-8217-0fc940f5884d
title: Información general de las tareas previas a la copia de seguridad
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: af8dd6ea99215d486b8be7d07d30bcbdb5258548078fd642028dd6a93ca42796
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/11/2021
ms.locfileid: "119511745"
---
# <a name="overview-of-pre-backup-tasks"></a>Información general de las tareas previas a la copia de seguridad

Las tareas previas a la copia de seguridad en VSS se centran en crear una instantánea de los volúmenes que contienen datos para la copia de seguridad. La aplicación de copia de seguridad guardará los datos de la instantánea, no del volumen real. Para obtener más información, vea [Información general sobre el procesamiento de una copia de seguridad en VSS.](overview-of-processing-a-backup-under-vss.md)

Normalmente, los solicitantes esperan a que los escritores se preparen para la copia de seguridad y creen la instantánea. El sistema de escritura debe determinar si va a participar en la copia de seguridad y, si es así, configurar sus archivos y estar listo para la copia de seguridad y la instantánea. En la tabla siguiente se muestra la secuencia de acciones y eventos necesarios para prepararse para una operación de copia de seguridad.



| Acción del solicitante                                                                                                                                                                                                                                                                                                            | Evento                                                                      | Acción de escritor                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| El solicitante puede establecer opciones de copia de seguridad (vea [**IVssBackupComponents::SetBackupOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupoptions))                                                                                                                                                                                          | None                                                                       | None                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Admitir operaciones de copia de seguridad incrementales y diferenciales mediante el examen de las marcas de copia de seguridad almacenadas (vea [**IVssComponent::GetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupstamp), [**IVssBackupComponents::SetPreviousBackupStamp**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp))                                               | None                                                                       | None                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Notificar a los escritores que se preparen para una operación de copia de seguridad [ **mediante IVssBackupComponents::P repareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup)                                                                                                                                                                              | [*PrepareForBackup*](vssgloss-p.md)  | Los preparativos del escritor incluyen determinar si se va a realizar una copia de seguridad de los archivos. si el escritor participará en la inmovilización de instantáneas, así como crear metadatos específicos del escritor (vea [**CVssWriter::OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup), [**CVssWriter::IsPathAffected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispathaffected), [**IVssWriterComponents**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents), [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent), [**IVssComponent::GetBackupOptions**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupoptions), [**CVssWriter::AreComponentsSelected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-arecomponentsselected), [**IVssComponent::SetBackupMetadata**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupmetadata)y [**IVssComponent::GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp). |
| El solicitante espera a que los escritores configuren la copia de seguridad [**mediante IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync). También debe comprobar el estado del sistema de escritura (vea [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**IVssBackupComponents::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus))     | None                                                                       | None                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| El solicitante solicita una instantánea mediante [ **IVssBackupComponents::D oSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset)                                                                                                                                                                                                    | None                                                                       | None                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| None                                                                                                                                                                                                                                                                                                                        | [*PrepareForSnapshot*](vssgloss-p.md) | [**CVssWriter::OnPrepareSnapshot:**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot)coloque el escritor en un estado listo para la instantánea.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| Ninguno                                                                                                                                                                                                                                                                                                                        | [*Freeze*](vssgloss-f.md)                      | [**CVssWriter::OnFreeze:**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze)configuración final antes de la instantánea.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| Ninguno                                                                                                                                                                                                                                                                                                                        | [*Deshielo*](vssgloss-t.md)                          | [**CVssWriter::OnThaw:**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw)se puede reanudar el funcionamiento normal (incluida la E/S).<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| Ninguno                                                                                                                                                                                                                                                                                                                        | [*PostSnapshot*](vssgloss-p.md)          | [**CVssWriter::OnPostSnapshot:**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot)limpiezas finales de las preparaciones de instantáneas. Vea [**IVssComponent::AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime) e [**IVssComponent::SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp).<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| El solicitante espera la finalización de la instantánea mediante: [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync), también debe comprobar el estado del escritor (vea [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**IVssBackupComponents::GetWriterStatus).**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus)<br/> | None                                                                       | None                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |



 

## <a name="requester-pre-backup-tasks"></a>Tareas previas a la copia de seguridad del solicitante

Además, antes de crear un evento [**IVssBackupComponents::P repareForBackup,**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) un solicitante también puede establecer opciones de copia de seguridad para escritores individuales mediante [**IVssBackupComponents::SetBackupOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupoptions) en función de los detalles de cada escritor y de si un solicitante los conoce.

Para admitir operaciones incrementales y diferenciales, los solicitantes pueden en este momento elegir examinar los componentes para las marcas de tiempo de una operación de copia de seguridad anterior (mediante [**IVssComponent::GetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupstamp)) y usar esa información para establecer una marca de tiempo anterior para que un escritor procese (mediante [**IVssBackupComponents::SetPreviousBackupStamp).**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp) Consulte [Copias de seguridad incrementales y](incremental-and-differential-backups.md) diferenciales para obtener más información.

Ahora, un solicitante puede dirigir a los escritores del sistema para que completen los preparativos previos a la copia de seguridad y controle la creación de una instantánea.

En primer lugar, el solicitante genera un [**evento PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) llamando a [**IVssBackupComponents::P repareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup).

Después de que todos los escritores participantes vuelvan de controlar el evento [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) (que un solicitante determina mediante la instancia de la interfaz [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync) devuelta por **PrepareForBackup),** el solicitante puede iniciar la instantánea llamando a [**IVssBackupComponents::D oSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset), que, a medida que avanza, generará eventos [*PrepareForSnapshot,*](vssgloss-p.md) [*Freeze,*](vssgloss-f.md) [*Thaw*](vssgloss-t.md)y [*PostSnapshot*](vssgloss-p.md) para que los escritores los controlen.

Hay algunos casos en los que es posible que un solicitante no necesite crear una instantánea. En concreto, [](vssgloss-f.md) cada conjunto de archivos administrado por uno de los componentes de un escritor determinado tiene una máscara de copia de seguridad de especificación de archivo (indicada por un or bit a bit de valores OR de [**VSS \_ FILE SPEC \_ \_ BACKUP \_ TYPE)**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type) establecida durante el evento [*Identify.*](vssgloss-i.md) Esta máscara especifica, entre otras cosas, si un conjunto de archivos requiere que se realice una instantánea del sistema antes de realizar la copia de seguridad.

Si no es necesario realizar una copia de seguridad de ningún conjunto de archivos en ningún volumen, no es necesario llamar a [**IVssBackupComponents::D oSnapshotSet.**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset)

## <a name="writer-pre-backup-tasks"></a>Tareas previas a la copia de seguridad del escritor

Al controlar el evento [**PrepareForBackup,**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) VSS llamará al método [**CVssWriter::OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) de cada escritor, un método virtual que, de forma predeterminada, simplemente devuelve true.

Los escritores pueden invalidar esta implementación predeterminada y usar el control para buscar información sobre la próxima copia de seguridad y tomar medidas.

Un escritor puede determinar información sobre el tipo de operación de copia de seguridad prevista mediante los métodos siguientes:

1.  [**CVssWriter::GetBackupType**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-getbackuptype)
2.  [**CVssWriter::IsBootableStateBackedUp**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-isbootablesystemstatebackedup)
3.  [**CVssWriter::AreComponentsSelected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-arecomponentsselected)

Un sistema de escritura determina si los archivos que administra participarán en la instantánea mediante [**CVssWriter::IsPathAffected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispathaffected).

Más importante, cuando VSS llama al método [**CVssWriter::OnPrepareBackup,**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) pasa una instancia de la interfaz [**IVssWriterComponents,**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents) que permite [](vssgloss-e.md) el acceso directo a través de la interfaz [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) a los de sus componentes incluidos explícitamente en el documento componentes de copia de seguridad del solicitante. El sistema de escritura usaba las instancias de la interfaz **IVssComponent** que definen conjuntos de componentes para obtener acceso a su componente incluido implícitamente (vea [Selectability and working with Component Properties](selectability-and-working-with-component-properties.md)). 

Durante el control del evento [**PrepareForBackup,**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) los escritores usan la interfaz [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) para realizar operaciones de componente por componente (o de componente establecidas por conjunto de componentes), incluidas:

1.  Agregar [*archivos parciales*](vssgloss-p.md) (si se admite) mediante una [**llamada a IVssComponent::AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile).
2.  Establecer los metadatos privados que el escritor necesitará para controlar la restauración.
3.  Si el sistema de escritura admite copias de seguridad incrementales y diferenciales (vea Copias de [seguridad incrementales y diferenciales),](incremental-and-differential-backups.md)haga lo siguiente:
    -   Comprobar las marcas de tiempo de copia de seguridad anteriores mediante una [**llamada a IVssComponent::GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp).
    -   Para agregar los [*archivos con diferencia necesarios,*](vssgloss-d.md) llame a [**IVssComponent::AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime).
    -   Si el sistema de escritura admite el esquema **\_ \_ TIMESTAMPED de VSS BS,** agregue cadenas de marca de tiempo de copia de seguridad en el propio formato del escritor mediante [**IVssComponent::SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp).
4.  Iniciar operaciones asincrónicas que requieren mucho tiempo, como sincronizar datos en varios discos. Esto permitirá que el escritor siga trabajando mientras se procesa la operación, incluido el control de otros eventos de VSS. Estas operaciones deben finalizar antes del [*evento Freeze.*](vssgloss-f.md)

La llamada del solicitante a [**IVssBackupComponents::D oSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) inicia la instantánea y genera los siguientes eventos para que los escritores controle:

-   [*PrepareForSnapshot*](vssgloss-p.md)
-   [*Freeze*](vssgloss-f.md)
-   [*Deshielo*](vssgloss-t.md)
-   [*PostSnapshot*](vssgloss-p.md)

Tres de los controladores del escritor,[**CVssWriter::OnPrepareSnapshot,**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) [**CVssWriter::OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze)y [**CVssWriter::OnThaw,**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw)son métodos virtuales puros y cada escritor debe implementarlos en lugar de depender de los valores predeterminados. En función de las necesidades de un escritor, se pueden codificar como métodos ficticios, simplemente devolviendo **TRUE.**

Dado que normalmente hay un período de tiempo reducido entre la emisión de un evento [*Freeze*](vssgloss-f.md) y la emisión de un evento [*Thaw,*](vssgloss-t.md) la mayor parte del trabajo principal en la preparación de la instantánea,como apagar procesos, crear archivos temporales o purgar colas de E/S, se controlaría en [**CVssWriter::OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot).

La forma en que un escritor puede usar [**CVssWriter::OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) para controlar su E/S antes de crear una instantánea depende en gran medida de la propia arquitectura del escritor.

Los escritores que pueden permitirse contener todas las escrituras y mantener los datos en un estado coherente absoluto antes de [*Inmovilizar*](vssgloss-f.md), deben hacerlo.

Si el escritor no puede inmovilizar su E/S, debe realizar acciones para crear un origen estable para la copia de seguridad y reducir el tiempo de recuperación de una instantánea. Algunos ejemplos de esto pueden ser poner en cola las solicitudes de E/S entrantes o generar un conjunto duplicado de archivos en una ruta de acceso alternativa que se usará como origen de una copia de seguridad. [](vssgloss-a.md)

El método [**CVssWriter::OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze) realiza tareas sencillas y cortas, como comprobar que la E/S izquierda de [**CVssWriter::OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) está en el estado correcto y que todas las tareas asincrónicas iniciadas por [**CVssWriter::OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) se completaron. Este método es la última oportunidad de un escritor de vetar una instantánea si hay problemas (vea Errores y [vetos del escritor).](writer-errors-and-vetoes.md)

Por lo general, es posible que un escritor reanude el funcionamiento normal después de un evento [*Thaw:*](vssgloss-t.md) es posible que una instantánea no esté lista inmediatamente para la copia de seguridad después de Thaw, pero un escritor debe poder reanudar el funcionamiento normal. Por lo tanto, los escritores suelen usar [**CVssWriter::OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) para volver a un estado de inmovilización previa. Sin embargo, los archivos temporales creados para admitir la instantánea se deben dejar en su lugar hasta el [*evento PostSnapshot.*](vssgloss-p.md) Normalmente, usaría [**CVssWriter::OnPostSnapshot para**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot) este tipo de limpieza. Dado que muchas aplicaciones no requieren este tipo de limpieza, **CVssWriter::OnPostSnapshot** es un método virtual con una implementación predeterminada que simplemente **devuelve TRUE.** Si se realiza una copia de seguridad incremental o diferencial, el escritor puede llamar a [**IVssComponent::GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp) e [**IVssComponent::SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp). Para obtener más información, vea [Rol de escritor en Copia de seguridad de almacenes complejos.](writer-role-in-backing-up-complex-stores.md) Otro método al que se puede llamar en este momento [**es IVssComponent::AddDifferencedFilesByLastModifyTime.**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime)

 

 




