---
description: Obtenga información sobre cómo crear un motor de sincronización de archivos en la nube que use archivos de marcadores de posición mediante la API de archivos en la nube.
title: Compilar un motor de sincronización en la nube que admita archivos de marcadores de posición
ms.topic: article
ms.date: 11/12/2020
ms.openlocfilehash: 4f1330285d0c8ef0359639f2be84162f8bc2ef3b
ms.sourcegitcommit: 3bdf30edb314e0fcd17dc4ddbc70e4ec7d3596e6
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 02/10/2021
ms.locfileid: "104554746"
---
# <a name="build-a-cloud-sync-engine-that-supports-placeholder-files"></a><span data-ttu-id="81432-103">Compilar un motor de sincronización en la nube que admita archivos de marcadores de posición</span><span class="sxs-lookup"><span data-stu-id="81432-103">Build a Cloud Sync Engine that Supports Placeholder Files</span></span>

<span data-ttu-id="81432-104">Un motor de sincronización es un servicio que sincroniza los archivos, normalmente entre un host remoto y un cliente local.</span><span class="sxs-lookup"><span data-stu-id="81432-104">A sync engine is a service that syncs files, typically between a remote host and a local client.</span></span> <span data-ttu-id="81432-105">Los motores de sincronización en Windows suelen presentar esos archivos al usuario a través del sistema de archivos de Windows y el explorador de archivos.</span><span class="sxs-lookup"><span data-stu-id="81432-105">Sync engines on Windows often present those files to the user through the Windows file system and File Explorer.</span></span> <span data-ttu-id="81432-106">Antes de la versión 1709 de Windows 10, la compatibilidad con el motor de sincronización en Windows se limitaba a superficies ad hoc independientes del escenario, como el panel de navegación del explorador de archivos, la bandeja del sistema de Windows y (para aplicaciones más técnicas) controladores de filtro del sistema de archivos.</span><span class="sxs-lookup"><span data-stu-id="81432-106">Before Windows 10, version 1709, sync engine support in Windows was limited to scenario-agnostic ad-hoc surfaces, such as File Explorer’s navigation pane, the Windows system tray, and (for more technical applications) file system filter drivers.</span></span>

<span data-ttu-id="81432-107">La versión 1709 de Windows 10 (también denominada Fall Creators Update) presentó la *API de archivos* en la nube.</span><span class="sxs-lookup"><span data-stu-id="81432-107">Windows 10 version 1709 (also called the Fall Creators Update) introduced the *cloud files API*.</span></span> <span data-ttu-id="81432-108">Esta API es una nueva plataforma que formaliza la compatibilidad con los motores de sincronización.</span><span class="sxs-lookup"><span data-stu-id="81432-108">This API is a new platform that formalizes support for sync engines.</span></span> <span data-ttu-id="81432-109">La API de archivos en la nube proporciona compatibilidad con los motores de sincronización de una forma que ofrece muchas ventajas nuevas a los desarrolladores y usuarios finales.</span><span class="sxs-lookup"><span data-stu-id="81432-109">The cloud files API provides support for sync engines in a way that offers many new benefits to developers and end users.</span></span>

<span data-ttu-id="81432-110">La API de Cloud files contiene las siguientes API nativas de Win32 y las API de Windows Runtime (WinRT):</span><span class="sxs-lookup"><span data-stu-id="81432-110">The cloud files API contains the following native Win32 APIs and Windows Runtime (WinRT) APIs:</span></span>

* <span data-ttu-id="81432-111">[Cloud Filter API](cloud-filter-reference.md): esta API nativa de Win32 proporciona funcionalidad en el límite entre el modo de usuario y el sistema de archivos.</span><span class="sxs-lookup"><span data-stu-id="81432-111">[Cloud Filter API](cloud-filter-reference.md): This native Win32 API provides functionality at the boundary between the user mode and the file system.</span></span> <span data-ttu-id="81432-112">Esta API controla la creación y administración de archivos y directorios de marcadores de posición.</span><span class="sxs-lookup"><span data-stu-id="81432-112">This API handles the creation and management of placeholder files and directories.</span></span>
* <span data-ttu-id="81432-113">[Espacio de nombres Windows. Storage. Provider](/uwp/api/windows.storage.provider): esta API de WinRT permite a las aplicaciones configurar el proveedor de almacenamiento en la nube y registrar la raíz de sincronización con el sistema operativo.</span><span class="sxs-lookup"><span data-stu-id="81432-113">[Windows.Storage.Provider namespace](/uwp/api/windows.storage.provider): This WinRT API enables applications to configure the cloud storage provider and register the sync root with the operating system.</span></span>

> [!NOTE]
> <span data-ttu-id="81432-114">La API de Cloud files no admite actualmente la implementación de motores de sincronización en la nube en aplicaciones para UWP.</span><span class="sxs-lookup"><span data-stu-id="81432-114">The cloud files API does not currently support implementing cloud sync engines in UWP apps.</span></span> <span data-ttu-id="81432-115">Los motores de sincronización en la nube deben implementarse en aplicaciones de escritorio.</span><span class="sxs-lookup"><span data-stu-id="81432-115">Cloud sync engines must be implemented in desktop apps.</span></span>

## <a name="supported-features"></a><span data-ttu-id="81432-116">Características admitidas</span><span class="sxs-lookup"><span data-stu-id="81432-116">Supported features</span></span>

<span data-ttu-id="81432-117">La API de archivos en la nube proporciona las siguientes características para crear motores de sincronización en la nube.</span><span class="sxs-lookup"><span data-stu-id="81432-117">The cloud files API provides the following features for building cloud sync engines.</span></span>

### <a name="placeholder-files"></a><span data-ttu-id="81432-118">Archivos de marcadores de posición</span><span class="sxs-lookup"><span data-stu-id="81432-118">Placeholder files</span></span>

* <span data-ttu-id="81432-119">Los motores de sincronización pueden crear archivos de marcadores de posición que solo consumen 1 KB de almacenamiento para el encabezado filesystem y que se convierten automáticamente en archivos completos en condiciones de uso normales.</span><span class="sxs-lookup"><span data-stu-id="81432-119">Sync engines can create placeholder files that consume only 1 KB of storage for the filesystem header, and that automatically hydrate into full files under normal use conditions.</span></span> <span data-ttu-id="81432-120">Los archivos de marcador de posición se presentan como archivos típicos en las aplicaciones y a los usuarios finales en el shell de Windows.</span><span class="sxs-lookup"><span data-stu-id="81432-120">Placeholder files present as typical files to apps and to end users in the Windows Shell.</span></span>
* <span data-ttu-id="81432-121">Los archivos de marcador de posición se integran verticalmente desde el kernel de Windows hasta el shell de Windows y, por lo general, la compatibilidad de aplicaciones con los archivos de marcador de posición no es un problema.</span><span class="sxs-lookup"><span data-stu-id="81432-121">Placeholder files are vertically integrated from the Windows kernel up to the Windows Shell, and app compatibility with placeholder files is generally a non-issue.</span></span> <span data-ttu-id="81432-122">Tanto si usa las API del sistema de archivos, el símbolo del sistema o una aplicación de escritorio o de UWP para tener acceso a un archivo de marcador de posición, el archivo se hidratará sin cambios de código adicionales y esa aplicación podrá usar el archivo normalmente.</span><span class="sxs-lookup"><span data-stu-id="81432-122">Whether you use file system APIs, the Command Prompt, or a desktop or a UWP app to access a placeholder file, the file will hydrate without additional code changes and that app can use the file normally.</span></span>
* <span data-ttu-id="81432-123">Los archivos pueden existir en tres Estados:</span><span class="sxs-lookup"><span data-stu-id="81432-123">Files can exist in three states:</span></span>
  * <span data-ttu-id="81432-124">**Archivo de marcador de posición**: representación vacía del archivo y solo está disponible si el servicio de sincronización está disponible.</span><span class="sxs-lookup"><span data-stu-id="81432-124">**Placeholder file**: An empty representation of the file and only available if the sync service is available.</span></span>
  * <span data-ttu-id="81432-125">**Archivo completo**: el archivo se ha hidratado implícitamente y podría ser deshidratado por el sistema si se necesita espacio.</span><span class="sxs-lookup"><span data-stu-id="81432-125">**Full file**: The file has been hydrated implicitly and could be dehydrated by the system if space is needed.</span></span>
  * <span data-ttu-id="81432-126">**Archivo completo anclado**: el usuario ha hidratado explícitamente el archivo a través del explorador de archivos y se garantiza que está disponible sin conexión.</span><span class="sxs-lookup"><span data-stu-id="81432-126">**Pinned full file**: The file has been hydrated explicitly by the user through File Explorer and is guaranteed to be available offline.</span></span>

<span data-ttu-id="81432-127">En la imagen siguiente se muestra cómo se muestran los Estados de los archivos completos de marcador de posición, completos y anclados en el explorador de archivos.</span><span class="sxs-lookup"><span data-stu-id="81432-127">The following image demonstrates how the placeholder, full, and pinned full file states are shown in File Explorer.</span></span>

  ![Ejemplo de tres Estados de archivo en el explorador de archivos](images/cloud-file-states-file-explorer.png)

### <a name="standardized-sync-root-registration"></a><span data-ttu-id="81432-129">Registro de la raíz de sincronización normalizada</span><span class="sxs-lookup"><span data-stu-id="81432-129">Standardized sync root registration</span></span>

* <span data-ttu-id="81432-130">El registro de una raíz de sincronización es sencillo y estandarizado.</span><span class="sxs-lookup"><span data-stu-id="81432-130">Registering a sync root is straightforward and standardized.</span></span> <span data-ttu-id="81432-131">Esto incluye la creación de un nodo de marca en el panel de navegación del explorador de archivos, tal como se muestra en la siguiente captura de pantalla.</span><span class="sxs-lookup"><span data-stu-id="81432-131">This includes creation of a branded node in the navigation pane of File Explorer, as shown in the following screenshot.</span></span> <span data-ttu-id="81432-132">Las raíces se pueden crear como entradas de nivel superior individuales o como elementos secundarios de una agrupación primaria.</span><span class="sxs-lookup"><span data-stu-id="81432-132">Roots can be created either as individual top-level entries, or as children of a parent grouping.</span></span>

  ![Ejemplo de una entrada de la raíz de sincronización en el explorador de archivos](images/register-sync-root-file-explorer.png)

### <a name="shell-integration"></a><span data-ttu-id="81432-134">Integración de Shell</span><span class="sxs-lookup"><span data-stu-id="81432-134">Shell integration</span></span>

* <span data-ttu-id="81432-135">Iconos de estado:</span><span class="sxs-lookup"><span data-stu-id="81432-135">State icons:</span></span>
  * <span data-ttu-id="81432-136">La API de archivos en la nube proporciona iconos de estado de hidratación automática y estandarizados que se muestran en el explorador de archivos y en el escritorio de Windows.</span><span class="sxs-lookup"><span data-stu-id="81432-136">The cloud files API provides standardized, automatic hydration state icons shown in File Explorer and on the Windows desktop.</span></span>
  * <span data-ttu-id="81432-137">Además de los iconos de estado de Windows estándar que se usan para el estado de la hidratación, puede proporcionar iconos de estado personalizados para propiedades adicionales específicas del servicio.</span><span class="sxs-lookup"><span data-stu-id="81432-137">In addition to the standard Windows state icons used for hydration state, you can provide custom state icons for additional service-specific properties.</span></span>
  * <span data-ttu-id="81432-138">Reemplaza las extensiones de Shell de superposición de iconos heredadas.</span><span class="sxs-lookup"><span data-stu-id="81432-138">Replaces legacy icon overlay Shell extensions.</span></span>
* <span data-ttu-id="81432-139">Indicación de progreso:</span><span class="sxs-lookup"><span data-stu-id="81432-139">Progress indication:</span></span>
  * <span data-ttu-id="81432-140">Abrir un archivo de marcador de posición que tarde más de unos segundos en hidratos mostrará el progreso de la hidratación.</span><span class="sxs-lookup"><span data-stu-id="81432-140">Opening a placeholder file that takes more than a few seconds to hydrate will show hydration progress.</span></span> <span data-ttu-id="81432-141">El progreso se muestra en algunas ubicaciones en función del contexto:</span><span class="sxs-lookup"><span data-stu-id="81432-141">Progress is shown in a few locations depending on context:</span></span>
    * <span data-ttu-id="81432-142">En una ventana del cuadro de diálogo del motor de copia.</span><span class="sxs-lookup"><span data-stu-id="81432-142">In a copy engine dialog window.</span></span>
    * <span data-ttu-id="81432-143">El progreso en línea se muestra junto al archivo en el explorador de archivos.</span><span class="sxs-lookup"><span data-stu-id="81432-143">Inline progress is shown next to the file in File Explorer.</span></span>
    * <span data-ttu-id="81432-144">Si el archivo no se abre en la instrucción específica del usuario, se muestra una notificación del sistema para informar al usuario y proporcionar una manera de controlar la actividad de la hidratación no deseada.</span><span class="sxs-lookup"><span data-stu-id="81432-144">If the file is not opened at the user’s specific instruction, a toast notification is shown to inform the user and provide a way to control unintended hydration activity.</span></span>
* <span data-ttu-id="81432-145">Miniaturas y metadatos:</span><span class="sxs-lookup"><span data-stu-id="81432-145">Thumbnails and metadata:</span></span>
  * <span data-ttu-id="81432-146">Los archivos de marcadores de posición pueden tener miniaturas enriquecidas proporcionadas por el servicio y metadatos de archivos extendidos para proporcionar al usuario una experiencia de explorador de archivos sin problemas.</span><span class="sxs-lookup"><span data-stu-id="81432-146">Placeholder files can have rich service-provided thumbnails and extended file metadata to provide the user with a seamless File Explorer experience.</span></span>
* <span data-ttu-id="81432-147">Panel de navegación del explorador de archivos:</span><span class="sxs-lookup"><span data-stu-id="81432-147">File Explorer navigation pane:</span></span>
  * <span data-ttu-id="81432-148">El registro de una raíz de sincronización con la API de archivos en la nube hace que la raíz de sincronización (con un icono y un nombre personalizado) aparezca en el panel de navegación del explorador de archivos.</span><span class="sxs-lookup"><span data-stu-id="81432-148">Registering a sync root with the cloud files API causes that sync root (with an icon and custom name) to appear in File Explorer’s navigation pane.</span></span>
* <span data-ttu-id="81432-149">Menús contextuales del explorador de archivos:</span><span class="sxs-lookup"><span data-stu-id="81432-149">File Explorer context menus:</span></span>
  * <span data-ttu-id="81432-150">Al registrar una raíz de sincronización con la API de archivos en la nube, se proporcionan automáticamente varios verbos (entradas de menú) en el menú contextual del explorador de archivos que permiten al usuario controlar el estado de la hidratación del archivo.</span><span class="sxs-lookup"><span data-stu-id="81432-150">Registering a sync root with the cloud files API automatically provides several verbs (menu entries) in File Explorer’s context menu that let the user control the hydration state of their file.</span></span>
  * <span data-ttu-id="81432-151">Se pueden agregar verbos adicionales a esta sección del menú contextual mediante las API compatibles con puente de escritorio.</span><span class="sxs-lookup"><span data-stu-id="81432-151">Additional verbs can be added to this section of the context menu using Desktop Bridge-compatible APIs.</span></span>
* <span data-ttu-id="81432-152">Control de usuario de la hidratación de archivos:</span><span class="sxs-lookup"><span data-stu-id="81432-152">User control of file hydration:</span></span>
  * <span data-ttu-id="81432-153">Los usuarios siempre tienen el control de la hidratación de archivos, incluso cuando el usuario no ha hidratado explícitamente los archivos.</span><span class="sxs-lookup"><span data-stu-id="81432-153">Users are always in control of file hydration, even when the files are not hydrated explicitly by the user.</span></span> <span data-ttu-id="81432-154">Se muestra una notificación del sistema interactiva para la hidratación en segundo plano para avisar al usuario y proporcionar opciones.</span><span class="sxs-lookup"><span data-stu-id="81432-154">An interactive toast is shown for background hydration to alert the user and provide options.</span></span> <span data-ttu-id="81432-155">En la imagen siguiente se muestra una notificación del sistema para un archivo Hydrating.</span><span class="sxs-lookup"><span data-stu-id="81432-155">The following image demonstrates a toast notification for a hydrating file.</span></span>
    <span data-ttu-id="81432-156">![Ejemplo de un sistema interactivo que se muestra para la hidratación de archivos en segundo plano](images/file-hydration-interactive-toast.png)</span><span class="sxs-lookup"><span data-stu-id="81432-156">![Example of an interactive toast shown for background file hydration](images/file-hydration-interactive-toast.png)</span></span>
  * <span data-ttu-id="81432-157">Si un usuario bloquea una aplicación de archivos Hydrating a través de una notificación del sistema interactiva, puede desbloquear la aplicación en la página de **descargas automáticas de archivos** en **configuración**.</span><span class="sxs-lookup"><span data-stu-id="81432-157">If a user blocks an app from hydrating files through an interactive toast, they can unblock the app in the **Automatic file downloads** page in **Settings**.</span></span>
    <span data-ttu-id="81432-158">![Captura de pantalla de la configuración de descargas de archivos automáticas](images/allow-automatic-file-downloads-setting.png)</span><span class="sxs-lookup"><span data-stu-id="81432-158">![Screenshot of the automatic file downloads setting](images/allow-automatic-file-downloads-setting.png)</span></span>
* <span data-ttu-id="81432-159">Enlazar operaciones del motor de copia (admitidas en Windows 10 Insider Preview compilación 19624 y versiones posteriores):</span><span class="sxs-lookup"><span data-stu-id="81432-159">Hooking copy engine operations (supported in Windows 10 Insider Preview Build 19624 and later versions):</span></span>
  * <span data-ttu-id="81432-160">Los proveedores de almacenamiento en la nube pueden registrar un enlace de copia de Shell para supervisar las operaciones de archivo dentro de su raíz de sincronización.</span><span class="sxs-lookup"><span data-stu-id="81432-160">Cloud storage providers can register a shell copy hook for monitoring file operations within their sync root.</span></span>
  * <span data-ttu-id="81432-161">El proveedor registra su enlace de copia estableciendo el valor del registro **CopyHook** en la clave del Registro raíz de sincronización en el CLSID de su objeto de servidor local com.</span><span class="sxs-lookup"><span data-stu-id="81432-161">The provider registers their copy hook by setting the **CopyHook** registry value under their sync root registry key to a the CLSID of their COM local server object.</span></span> <span data-ttu-id="81432-162">Este objeto de servidor local implementa la interfaz [IStorageProviderCopyHook](../shell/nn-shobjidl-istorageprovidercopyhook.md) .</span><span class="sxs-lookup"><span data-stu-id="81432-162">This local server object implements the [IStorageProviderCopyHook](../shell/nn-shobjidl-istorageprovidercopyhook.md) interface.</span></span>

### <a name="desktop-bridge"></a><span data-ttu-id="81432-163">Puente de dispositivo de escritorio</span><span class="sxs-lookup"><span data-stu-id="81432-163">Desktop Bridge</span></span>

* <span data-ttu-id="81432-164">Los motores de sincronización que usan las API de archivos en la nube están diseñados para usar el [puente de escritorio](/windows/uwp/porting/desktop-to-uwp-root) como un requisito de implementación.</span><span class="sxs-lookup"><span data-stu-id="81432-164">Sync engines using the cloud files APIs are designed to use the [Desktop Bridge](/windows/uwp/porting/desktop-to-uwp-root) as an implementation requirement.</span></span>

## <a name="cloud-mirror-sample"></a><span data-ttu-id="81432-165">Ejemplo de reflejo en la nube</span><span class="sxs-lookup"><span data-stu-id="81432-165">Cloud Mirror sample</span></span>

<span data-ttu-id="81432-166">El [ejemplo de reflejo](https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/CloudMirror) en la nube muestra cómo compilar una solución que usa la API de archivos en la nube.</span><span class="sxs-lookup"><span data-stu-id="81432-166">The [Cloud Mirror sample](https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/CloudMirror) illustrates how to build a solution that uses the cloud files API.</span></span> <span data-ttu-id="81432-167">No está diseñado para usarse como código de producción.</span><span class="sxs-lookup"><span data-stu-id="81432-167">It is not intended to be used as production code.</span></span> <span data-ttu-id="81432-168">Carece de un control de errores robusto y se escribe para que sea lo más fácil de entender posible.</span><span class="sxs-lookup"><span data-stu-id="81432-168">It lacks robust error handling and it is written to be as easily understood as possible.</span></span> <span data-ttu-id="81432-169">Se denomina reflejo en la nube porque simplemente refleja una carpeta local en el disco local.</span><span class="sxs-lookup"><span data-stu-id="81432-169">It's called Cloud Mirror because it simply mirrors a local folder on your local disk.</span></span> <span data-ttu-id="81432-170">Especifique una carpeta de servidor que esté pensada para representar el servidor de archivos en la nube y una carpeta de cliente diseñada para especificar la ruta de acceso raíz de sincronización.</span><span class="sxs-lookup"><span data-stu-id="81432-170">You specify a server folder that is meant to represent your cloud file server and a client folder that is meant to specify the sync root path.</span></span> <span data-ttu-id="81432-171">Aparece un nodo de nivel superior en el panel de navegación del explorador de archivos denominado **TestStorageProviderDisplayName** y este nodo se asigna a la carpeta de cliente especificada.</span><span class="sxs-lookup"><span data-stu-id="81432-171">A top-level node appears in the navigation pane in File Explorer called **TestStorageProviderDisplayName**, and this node maps to the specified client folder.</span></span>

<span data-ttu-id="81432-172">En lo que respecta a la sincronización, estos son los elementos que debe implementar un proveedor de sincronización de archivos en la nube completamente desarrollados:</span><span class="sxs-lookup"><span data-stu-id="81432-172">When it comes to syncing, these are the things that a fully-developed cloud files sync provider must implement:</span></span>

* <span data-ttu-id="81432-173">Cuando el archivo raíz de sincronización es simplemente un marcador de posición, el servicio es responsable de copiar el contenido del archivo para la hidratación.</span><span class="sxs-lookup"><span data-stu-id="81432-173">When the sync root file is just a placeholder, the service is responsible for copying down the contents of the file for hydration.</span></span> <span data-ttu-id="81432-174">Esto se implementa en el ejemplo.</span><span class="sxs-lookup"><span data-stu-id="81432-174">This is implemented in the sample.</span></span>
* <span data-ttu-id="81432-175">Cuando el archivo raíz de sincronización es un archivo completo y el contenido del archivo en el servicio en la nube cambia, el servicio es responsable de notificar al cliente de sincronización local del cambio y el cliente de sincronización local debe administrar las combinaciones según sus propias especificaciones.</span><span class="sxs-lookup"><span data-stu-id="81432-175">When the sync root file is a full file and the contents of the file in the cloud service change, the service is responsible of notifying the local sync client of the change and the local sync client must handle merges according to their own specifications.</span></span> <span data-ttu-id="81432-176">Esto no se implementa en el ejemplo.</span><span class="sxs-lookup"><span data-stu-id="81432-176">This is not implemented in the sample.</span></span>
* <span data-ttu-id="81432-177">Cuando el archivo raíz de sincronización es un archivo completo y el contenido del archivo en la ruta de acceso raíz de sincronización (el cliente local) cambia, el cliente de sincronización local debe notificar al servicio en la nube y controlar las combinaciones según sus propias especificaciones.</span><span class="sxs-lookup"><span data-stu-id="81432-177">When the sync root file is a full file and the contents of the file in the sync root path (the local client) change, the local sync client must notify the cloud service and handle merges according to their own specifications.</span></span> <span data-ttu-id="81432-178">La notificación de cambio de archivo local se implementa en el ejemplo, pero no hace nada.</span><span class="sxs-lookup"><span data-stu-id="81432-178">The local file change notification is implemented in the sample, but it does not do anything.</span></span>

### <a name="use-the-sample"></a><span data-ttu-id="81432-179">Usar el ejemplo</span><span class="sxs-lookup"><span data-stu-id="81432-179">Use the sample</span></span>

1. <span data-ttu-id="81432-180">Cree dos carpetas en la unidad de disco duro local.</span><span class="sxs-lookup"><span data-stu-id="81432-180">Create two folders on your local hard drive.</span></span> <span data-ttu-id="81432-181">Uno de ellos actuará como el servidor y el otro como cliente.</span><span class="sxs-lookup"><span data-stu-id="81432-181">One of them will act as the server and the other as the client.</span></span>
2. <span data-ttu-id="81432-182">Agregue algunos archivos a la carpeta del servidor.</span><span class="sxs-lookup"><span data-stu-id="81432-182">Add some files to the server folder.</span></span> <span data-ttu-id="81432-183">Asegúrese de que la carpeta de cliente está vacía.</span><span class="sxs-lookup"><span data-stu-id="81432-183">Make sure the client folder is empty.</span></span>
3. <span data-ttu-id="81432-184">Abra el ejemplo de reflejo en la nube en Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="81432-184">Open the Cloud Mirror sample in Visual Studio.</span></span> <span data-ttu-id="81432-185">Establezca el proyecto **CloudMirrorPackage** como proyecto de inicio y, después, compile y ejecute el ejemplo.</span><span class="sxs-lookup"><span data-stu-id="81432-185">Set the **CloudMirrorPackage** project as your startup project and then build and run the sample.</span></span> <span data-ttu-id="81432-186">Cuando el ejemplo lo solicite, escriba las dos rutas de acceso a las carpetas del servidor y del cliente.</span><span class="sxs-lookup"><span data-stu-id="81432-186">When prompted by the sample, enter the two paths to your server and client folders.</span></span> <span data-ttu-id="81432-187">Después, verá una ventana de consola con información de diagnóstico.</span><span class="sxs-lookup"><span data-stu-id="81432-187">After this you will see a console window with diagnostic information.</span></span>
4. <span data-ttu-id="81432-188">Abra el explorador de archivos y confirme que ve el nodo **TestStorageProviderDisplayName** y los marcadores de posición de todos los archivos que copió en la carpeta del servidor.</span><span class="sxs-lookup"><span data-stu-id="81432-188">Open File Explorer and confirm that you see the **TestStorageProviderDisplayName** node and the placeholders for all the files that you copied into the server folder.</span></span> <span data-ttu-id="81432-189">Para simular una aplicación que intente abrir archivos sin usar el selector, copie varias imágenes en la carpeta del servidor.</span><span class="sxs-lookup"><span data-stu-id="81432-189">To simulate an application that tries to open files without using the picker, copy several images to the server folder.</span></span> <span data-ttu-id="81432-190">Haga doble clic en una de ellas en la carpeta raíz de sincronización y confirme que está hidratada.</span><span class="sxs-lookup"><span data-stu-id="81432-190">Double-click one of them in your sync root folder and confirm that it hydrates.</span></span> <span data-ttu-id="81432-191">A continuación, abra la aplicación fotos.</span><span class="sxs-lookup"><span data-stu-id="81432-191">Then, open the Photos app.</span></span> <span data-ttu-id="81432-192">La aplicación cargará previamente los archivos adyacentes en segundo plano para que sea más probable que el usuario no experimente retrasos al examinar las demás imágenes.</span><span class="sxs-lookup"><span data-stu-id="81432-192">The app will pre-load adjacent files in the background to make it more likely the user does not experience delays when looking through the other pictures.</span></span> <span data-ttu-id="81432-193">Puede observar que la deshidratación en segundo plano se produce a través de notificaciones del sistema o en el explorador de archivos.</span><span class="sxs-lookup"><span data-stu-id="81432-193">You can observe the background dehydration happen via toasts or in File Explorer.</span></span>
5. <span data-ttu-id="81432-194">Haga clic con el botón derecho en un archivo en el explorador de archivos para abrir un menú contextual y confirme que ve el elemento de menú **prueba** .</span><span class="sxs-lookup"><span data-stu-id="81432-194">Right-click a file in File Explorer to bring up a context menu, and confirm that you see the **TestCommand** menu item.</span></span> <span data-ttu-id="81432-195">Al hacer clic en este elemento de menú, se mostrará un cuadro de mensaje.</span><span class="sxs-lookup"><span data-stu-id="81432-195">Clicking this menu item will display a message box.</span></span>
6. <span data-ttu-id="81432-196">Para detener el ejemplo, establezca el foco en la salida de la consola y presione **Ctrl + C**.</span><span class="sxs-lookup"><span data-stu-id="81432-196">To stop the sample, set focus to the console output and press **Ctrl-C**.</span></span> <span data-ttu-id="81432-197">Esto limpiará el registro de la raíz de sincronización para que el proveedor se desinstale.</span><span class="sxs-lookup"><span data-stu-id="81432-197">This will cleanup the sync root registration so that the provider is uninstalled.</span></span> <span data-ttu-id="81432-198">Si el ejemplo se bloquea, es posible que la raíz de sincronización permanezca registrada.</span><span class="sxs-lookup"><span data-stu-id="81432-198">If the sample crashes, it’s possible that the sync root will remain registered.</span></span> <span data-ttu-id="81432-199">Esto hará que el explorador de archivos se reinicie cada vez que haga clic en cualquier cosa, y se le pedirán las ubicaciones de cliente y servidor falsas.</span><span class="sxs-lookup"><span data-stu-id="81432-199">This will cause File Explorer to relaunch every time you click on anything, and you would get prompted for the fake client and server locations.</span></span> <span data-ttu-id="81432-200">Si esto ocurre, desinstale la aplicación de ejemplo **CloudMirrorPackage** del equipo.</span><span class="sxs-lookup"><span data-stu-id="81432-200">If this occurs, uninstall the **CloudMirrorPackage** sample application from your computer.</span></span>

### <a name="sample-architecture"></a><span data-ttu-id="81432-201">Arquitectura de ejemplo</span><span class="sxs-lookup"><span data-stu-id="81432-201">Sample architecture</span></span>

<span data-ttu-id="81432-202">El ejemplo es deliberadamente simple.</span><span class="sxs-lookup"><span data-stu-id="81432-202">The sample is deliberately simple.</span></span> <span data-ttu-id="81432-203">Utiliza clases estáticas para hacer que sea innecesario pasar punteros de instancia.</span><span class="sxs-lookup"><span data-stu-id="81432-203">It uses static classes to make it unnecessary to pass instance pointers.</span></span> <span data-ttu-id="81432-204">Estas son las clases principales en el ejemplo:</span><span class="sxs-lookup"><span data-stu-id="81432-204">Here are the main classes in the sample:</span></span>

* <span data-ttu-id="81432-205">**FakeCloudProvider**: esta clase de nivel superior controla las siguientes clases de trabajo:</span><span class="sxs-lookup"><span data-stu-id="81432-205">**FakeCloudProvider**: This top-level class controls the following worker classes:</span></span>
  * <span data-ttu-id="81432-206">**CloudProviderRegistrar**: registra la información raíz de la sincronización con el shell de Windows.</span><span class="sxs-lookup"><span data-stu-id="81432-206">**CloudProviderRegistrar**: Registers the sync root information with the Windows Shell.</span></span>
  * <span data-ttu-id="81432-207">**Marcadores de posición**: genera los archivos de marcador de posición en la ruta de acceso raíz de sincronización.</span><span class="sxs-lookup"><span data-stu-id="81432-207">**Placeholders**: Generates the placeholder files in the sync root path.</span></span>
  * <span data-ttu-id="81432-208">**ShellServices**: construye los proveedores de Shell de Windows para el menú contextual, las miniaturas y otros servicios.</span><span class="sxs-lookup"><span data-stu-id="81432-208">**ShellServices**: Constructs the Windows Shell providers for the context menu, thumbnails, and other services.</span></span>
  * <span data-ttu-id="81432-209">**CloudProviderSyncRootWatcher**: crea una instancia de DirectoryWatcher para supervisar los cambios en la ruta de acceso raíz de sincronización y actúa en los cambios.</span><span class="sxs-lookup"><span data-stu-id="81432-209">**CloudProviderSyncRootWatcher**: Instantiates a DirectoryWatcher to monitor changes to the sync root path and act on changes.</span></span>
  * <span data-ttu-id="81432-210">**FileCopierWithProgress**: copia los archivos de la carpeta del servidor en la carpeta cliente lentamente en fragmentos para simular su descarga desde un servidor en la nube real.</span><span class="sxs-lookup"><span data-stu-id="81432-210">**FileCopierWithProgress**: Copies files from the server folder to the client folder slowly in chunks to simulate downloading them from a real cloud server.</span></span> <span data-ttu-id="81432-211">Proporciona una indicación de progreso para que la interfaz de usuario del explorador de archivos y notificaciones del sistema muestre el usuario algo informativo.</span><span class="sxs-lookup"><span data-stu-id="81432-211">Provides progress indication so that toasts and File Explorer UI shows the user something informative.</span></span>

<span data-ttu-id="81432-212">Además de las clases anteriores, el ejemplo también proporciona varias clases auxiliares para solicitar al usuario carpetas y algunas utilidades.</span><span class="sxs-lookup"><span data-stu-id="81432-212">In addition to the classes above, the sample also provides several helper classes to prompt the user for folders and some utilities.</span></span> <span data-ttu-id="81432-213">**TestExplorerCommandHandler**, **CustomStateProvider**, **ThumbnailProvider** y **UriSource** son ejemplos de proveedores de servicios de Shell.</span><span class="sxs-lookup"><span data-stu-id="81432-213">The **TestExplorerCommandHandler**, **CustomStateProvider**, **ThumbnailProvider**, and **UriSource** are all examples of Shell service providers.</span></span>

## <a name="cloud-files-api-architecture"></a><span data-ttu-id="81432-214">Arquitectura de API de archivos en la nube</span><span class="sxs-lookup"><span data-stu-id="81432-214">Cloud files API architecture</span></span>

<span data-ttu-id="81432-215">En el núcleo de la pila de almacenamiento de la API de archivos en la nube se encuentra un controlador de minifiltro del sistema de archivos denominado cldflt.sys.</span><span class="sxs-lookup"><span data-stu-id="81432-215">At the core of the storage stack in the cloud files API is a file system minifilter driver called cldflt.sys.</span></span> <span data-ttu-id="81432-216">Este controlador actúa como un proxy entre las aplicaciones del usuario y el motor de sincronización.</span><span class="sxs-lookup"><span data-stu-id="81432-216">This driver acts as a proxy between the user’s applications and your sync engine.</span></span> <span data-ttu-id="81432-217">El motor de sincronización sabe cómo descargar y cargar los datos a petición, mientras que es responsabilidad de cldflt.sys trabajar con el shell para presentar archivos como si los datos de la nube estuvieran disponibles localmente.</span><span class="sxs-lookup"><span data-stu-id="81432-217">Your sync engine knows how to download and upload the data on demand while it is responsibility of cldflt.sys to work with the Shell to present files as if the cloud data were locally available.</span></span>

<span data-ttu-id="81432-218">Actualmente, Cldflt.sys solo admite volúmenes NTFS, ya que depende de algunas características únicas de NTFS.</span><span class="sxs-lookup"><span data-stu-id="81432-218">Cldflt.sys currently only supports NTFS volumes because it depends on some features unique to NTFS.</span></span>

<span data-ttu-id="81432-219">Hay muchos controladores de minifiltro del sistema de archivos en un sistema y pueden estar activos en un volumen determinado al mismo tiempo.</span><span class="sxs-lookup"><span data-stu-id="81432-219">There are many file system minifilter drivers in a system and they can be active on a given volume at the same time.</span></span> <span data-ttu-id="81432-220">Los controladores que son de mayor interés para la API de archivos en la nube son los filtros del sistema de archivos antivirus.</span><span class="sxs-lookup"><span data-stu-id="81432-220">The drivers that are of most interest to the cloud files API are the anti-virus file system filters.</span></span>

<span data-ttu-id="81432-221">Los controladores de minifiltro del sistema de archivos se administran y admiten en un componente especial en modo kernel denominado administrador de filtros.</span><span class="sxs-lookup"><span data-stu-id="81432-221">File system minifilter drivers are managed and supported by a special kernel-mode component called the filter manager.</span></span> <span data-ttu-id="81432-222">Entre otras muchas tareas, el administrador de filtros facilita la comunicación sin filtrar entre los filtros y los componentes de modo de usuario a través de una construcción conocida como puerto de mensajes de filtro.</span><span class="sxs-lookup"><span data-stu-id="81432-222">Among many other duties, the filter manager facilitates unfiltered communication between filters and user mode components via a construct known as filter message port.</span></span>

## <a name="hydration-policies"></a><span data-ttu-id="81432-223">Directivas de hidratación</span><span class="sxs-lookup"><span data-stu-id="81432-223">Hydration Policies</span></span>

<span data-ttu-id="81432-224">Windows admite una variedad de [directivas de hidratación principal](/windows/desktop/api/cfapi/ne-cfapi-cf_hydration_policy_primary) y los modificadores de la [Directiva de hidratación secundaria](/windows/desktop/api/cfapi/ne-cfapi-cf_hydration_policy_modifier) .</span><span class="sxs-lookup"><span data-stu-id="81432-224">Windows supports a variety of [primary hydration policies](/windows/desktop/api/cfapi/ne-cfapi-cf_hydration_policy_primary) and [secondary hydration policy](/windows/desktop/api/cfapi/ne-cfapi-cf_hydration_policy_modifier) modifiers.</span></span> <span data-ttu-id="81432-225">Las directivas de hidratación principales tienen este orden:</span><span class="sxs-lookup"><span data-stu-id="81432-225">Primary hydration policies have this order:</span></span>

  <span data-ttu-id="81432-226">**Always Full > Full > progresivo > parcial**</span><span class="sxs-lookup"><span data-stu-id="81432-226">**Always full > Full > Progressive > Partial**</span></span>

<span data-ttu-id="81432-227">Tanto las aplicaciones como los motores de sincronización pueden definir su Directiva de hidratación principal preferida.</span><span class="sxs-lookup"><span data-stu-id="81432-227">Both applications and sync engines can define their preferred primary hydration policy.</span></span> <span data-ttu-id="81432-228">Si no se especifica, la Directiva de hidratación predeterminada es progresiva para las aplicaciones y los motores de sincronización.</span><span class="sxs-lookup"><span data-stu-id="81432-228">If not specified, the default hydration policy is progressive for both applications and sync engines.</span></span>

<span data-ttu-id="81432-229">La Directiva de hidratación de un archivo en la nube se determina en el momento de apertura del archivo mediante esta fórmula:</span><span class="sxs-lookup"><span data-stu-id="81432-229">The hydration policy of a cloud file is determined at the file open time by this formula:</span></span>

  ```File hydration policy = max(app hydration policy, provider hydration policy)```

<span data-ttu-id="81432-230">Por ejemplo, supongamos que el usuario está intentando abrir un archivo PDF almacenado en la unidad de nube de Fabrikam mediante el visor de PDF de Contoso, que no especifica una directiva de hidratación preferida.</span><span class="sxs-lookup"><span data-stu-id="81432-230">For example, let’s say the user is trying to open a PDF file stored on Fabrikam Cloud Drive using Contoso PDF Viewer, which doesn’t specify a preferred hydration policy.</span></span> <span data-ttu-id="81432-231">La Directiva de hidratación de aplicaciones es, por lo tanto, la hidratación progresiva, en este caso de forma predeterminada.</span><span class="sxs-lookup"><span data-stu-id="81432-231">The application hydration policy is therefore progressive hydration, in this case by default.</span></span> <span data-ttu-id="81432-232">Sin embargo, dado que la unidad de nube de Fabrikam es un motor de sincronización de hidratación completo, la última Directiva de hidratación en el archivo se convierte en una hidratación completa, lo que hará que el archivo se quede completamente hidratado en el primer acceso.</span><span class="sxs-lookup"><span data-stu-id="81432-232">However, because Fabrikam Cloud Drive is a full hydration sync engine, the final hydration policy on the file becomes full hydration, which will result in the file being fully hydrated on first access.</span></span> <span data-ttu-id="81432-233">El mismo resultado se produce en los casos en los que el motor de sincronización admite la hidratación progresiva, pero la preferencia de la aplicación es la hidratación completa.</span><span class="sxs-lookup"><span data-stu-id="81432-233">The same outcome happens in cases where the sync engine supports progressive hydration, but the app’s preference is full hydration.</span></span>

<span data-ttu-id="81432-234">Tenga en cuenta que la Directiva de hidratación de archivos no se puede cambiar una vez abierto el archivo.</span><span class="sxs-lookup"><span data-stu-id="81432-234">Note that the file hydration policy cannot be changed after the file is opened.</span></span>

## <a name="compatibility-with-applications-that-use-reparse-points"></a><span data-ttu-id="81432-235">Compatibilidad con aplicaciones que usan puntos de análisis</span><span class="sxs-lookup"><span data-stu-id="81432-235">Compatibility with applications that use reparse points</span></span>

<span data-ttu-id="81432-236">La API de Cloud files implementa el sistema de marcadores de posición mediante [puntos de reanálisis](/windows/desktop/FileIO/reparse-points).</span><span class="sxs-lookup"><span data-stu-id="81432-236">The cloud files API implements the placeholder system using [reparse points](/windows/desktop/FileIO/reparse-points).</span></span> <span data-ttu-id="81432-237">Una idea equivocada común sobre los puntos de reanálisis es que son los mismos que los vínculos simbólicos.</span><span class="sxs-lookup"><span data-stu-id="81432-237">A common misconception about reparse points is that they are the same as symbolic links.</span></span> <span data-ttu-id="81432-238">Este error de concepto se refleja ocasionalmente en las implementaciones de la aplicación y, como resultado, muchas aplicaciones existentes alcanzan errores al encontrar cualquier punto de reanálisis.</span><span class="sxs-lookup"><span data-stu-id="81432-238">This misconception is occasionally reflected in application implementations, and as a result, many existing applications hit errors when encountering any reparse point.</span></span>

<span data-ttu-id="81432-239">Para mitigar este problema de compatibilidad, la API de archivos en la nube oculta siempre sus puntos de análisis de todas las aplicaciones excepto los motores y procesos de sincronización cuya imagen principal reside en **% systemroot%**.</span><span class="sxs-lookup"><span data-stu-id="81432-239">To mitigate this compatibility issue, the cloud files API always hides its reparse points from all applications except for sync engines and processes whose main image resides under **%systemroot%**.</span></span> <span data-ttu-id="81432-240">Las aplicaciones que entienden los puntos de análisis correctamente pueden forzar a la plataforma a exponer los puntos de reanálisis de API de los archivos en la nube mediante [RtlSetProcessPlaceholderCompatibilityMode](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-rtlsetprocessplaceholdercompatibilitymode) o [RtlSetThreadProcessPlaceholderCompatibilityMode](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-rtlsetthreadplaceholdercompatibilitymode).</span><span class="sxs-lookup"><span data-stu-id="81432-240">Applications that understand reparse points correctly can force the platform to expose cloud files API reparse points using [RtlSetProcessPlaceholderCompatibilityMode](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-rtlsetprocessplaceholdercompatibilitymode) or [RtlSetThreadProcessPlaceholderCompatibilityMode](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-rtlsetthreadplaceholdercompatibilitymode).</span></span>