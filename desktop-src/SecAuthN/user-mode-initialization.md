---
description: Las aplicaciones distribuidas (cliente/servidor) usan paquetes de seguridad para obtener conexiones autenticadas y intercambiar mensajes.
ms.assetid: 8f28177f-335a-4fa2-bf66-2ec1698bebec
title: Inicialización del modo de usuario
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 473b06daf2e1c3612b02583d203ce4cd9afebabd
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/08/2021
ms.locfileid: "104002546"
---
# <a name="user-mode-initialization"></a><span data-ttu-id="60e9f-103">Inicialización del modo de usuario</span><span class="sxs-lookup"><span data-stu-id="60e9f-103">User Mode Initialization</span></span>

<span data-ttu-id="60e9f-104">Las aplicaciones distribuidas (cliente/servidor) usan [*paquetes de seguridad*](../secgloss/s-gly.md) para obtener conexiones autenticadas y intercambiar mensajes.</span><span class="sxs-lookup"><span data-stu-id="60e9f-104">Distributed (client/server) applications use [*security packages*](../secgloss/s-gly.md) to obtain authenticated connections and to exchange messages.</span></span> <span data-ttu-id="60e9f-105">La aplicación llama a las funciones de la interfaz del proveedor de compatibilidad con seguridad (SSPI) que se asignan a [las funciones implementadas por SSP/APS](authentication-functions.md)y a [las funciones implementadas por SSP/APS en modo de usuario](authentication-functions.md).</span><span class="sxs-lookup"><span data-stu-id="60e9f-105">The application calls security support provider interface (SSPI) functions which are mapped to [functions implemented by SSP/APs](authentication-functions.md), and [functions implemented by User-mode SSP/APs](authentication-functions.md).</span></span> <span data-ttu-id="60e9f-106">Esta asignación la realiza el archivo DLL del proveedor de seguridad (Secur32.dll o Security.dll), que se puede cargar de forma dinámica en los procesos de cliente y servidor.</span><span class="sxs-lookup"><span data-stu-id="60e9f-106">This mapping is performed by the security provider DLL (Secur32.dll or Security.dll), which can be loaded into the client and server processes dynamically.</span></span> <span data-ttu-id="60e9f-107">El archivo DLL también se puede vincular estáticamente mediante SECUR32. lib.</span><span class="sxs-lookup"><span data-stu-id="60e9f-107">The DLL can also be statically linked using Secur32.lib.</span></span> <span data-ttu-id="60e9f-108">Tanto DLL como LIB se distribuyen con el kit de desarrollo de software (SDK) de Microsoft Windows.</span><span class="sxs-lookup"><span data-stu-id="60e9f-108">Both the DLL and LIB ship with the Microsoft Windows Software Development Kit (SDK).</span></span>

<span data-ttu-id="60e9f-109">El sistema controla la carga del paquete de seguridad en el proceso del cliente o del servidor, si el archivo DLL SSP/AP que contiene el paquete de seguridad está registrado correctamente.</span><span class="sxs-lookup"><span data-stu-id="60e9f-109">Loading the security package into the client or server's process is handled by the system, if the SSP/AP DLL that contains the security package is properly registered.</span></span>

<span data-ttu-id="60e9f-110">El servidor comienza el proceso de obtención de una conexión segura con un cliente mediante la supervisión de un puerto, a la espera de que un cliente envíe un mensaje.</span><span class="sxs-lookup"><span data-stu-id="60e9f-110">The server begins the process of obtaining a secure connection with a client by monitoring a port, waiting for a client to send a message.</span></span> <span data-ttu-id="60e9f-111">El cliente comienza el proceso de obtención de una conexión segura al servidor mediante una llamada a la función InitializeSecurityContext de SSPI [**(general)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta).</span><span class="sxs-lookup"><span data-stu-id="60e9f-111">The client begins the process of obtaining a secure connection to the server by calling the SSPI function [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta).</span></span> <span data-ttu-id="60e9f-112">Esta función se asigna a la función [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) del paquete de seguridad personalizado.</span><span class="sxs-lookup"><span data-stu-id="60e9f-112">This function is mapped to the custom security package's [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) function.</span></span> <span data-ttu-id="60e9f-113">**SpInitLsaModeContext** devuelve un token al cliente, que lo reenvía al servidor.</span><span class="sxs-lookup"><span data-stu-id="60e9f-113">**SpInitLsaModeContext** returns a token to the client, who forwards it to the server.</span></span>

<span data-ttu-id="60e9f-114">Al recibir el token del cliente, el servidor llama a la función SSPI [**AcceptSecurityContext (general)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext), que se envía a la función [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) del paquete de seguridad.</span><span class="sxs-lookup"><span data-stu-id="60e9f-114">Upon receiving the token from the client, the server calls the SSPI function [**AcceptSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext), which is dispatched to the security package's [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) function.</span></span> <span data-ttu-id="60e9f-115">Si la función **SpAcceptLsaModeContext** se ejecuta correctamente y no se requiere más procesamiento para establecer el contexto de seguridad, la función debe devolver el estado \_ correcto al llamador.</span><span class="sxs-lookup"><span data-stu-id="60e9f-115">If the **SpAcceptLsaModeContext** function succeeds and no more processing is required to establish the security context, the function should return STATUS\_SUCCESS to the caller.</span></span> <span data-ttu-id="60e9f-116">Si se requiere un procesamiento adicional, la función debe devolver los segundos \_ que se \_ \_ necesitan y devolver un token al servidor.</span><span class="sxs-lookup"><span data-stu-id="60e9f-116">If additional processing is required, the function should return SEC\_I\_CONTINUE\_NEEDED, and return a token to the server.</span></span> <span data-ttu-id="60e9f-117">El servidor reenvía el token al cliente, que llama de nuevo a [**InitializeSecurityContext (general)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta) .</span><span class="sxs-lookup"><span data-stu-id="60e9f-117">The server forwards the token to the client, who calls [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta) again.</span></span>

<span data-ttu-id="60e9f-118">Este ciclo de llamada se puede repetir tantas veces como sea necesario hasta que se establezca una conexión autenticada o se produzca un error.</span><span class="sxs-lookup"><span data-stu-id="60e9f-118">This calling cycle may be repeated as often as necessary until an authenticated connection is established or fails.</span></span> <span data-ttu-id="60e9f-119">Durante este proceso, si la función [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) o [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) se realiza correctamente y no se requiere más procesamiento para establecer el [*contexto de seguridad*](../secgloss/s-gly.md), la función debe devolver el estado \_ correcto al llamador.</span><span class="sxs-lookup"><span data-stu-id="60e9f-119">During this process, if the [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) or [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) function succeeds and no more processing is required to establish the [*security context*](../secgloss/s-gly.md), the function should return STATUS\_SUCCESS to the caller.</span></span> <span data-ttu-id="60e9f-120">Si se requiere un procesamiento adicional, la función debe devolver los segundos que se \_ \_ \_ necesitan y devolver un token al llamador, que es responsable de reenviarlo.</span><span class="sxs-lookup"><span data-stu-id="60e9f-120">If additional processing is required, the function should return SEC\_I\_CONTINUE\_NEEDED, and return a token to the caller, who is responsible for forwarding it.</span></span>

<span data-ttu-id="60e9f-121">El protocolo implementado por el paquete de seguridad determina el número de veces que se repite este ciclo.</span><span class="sxs-lookup"><span data-stu-id="60e9f-121">The protocol implemented by the security package determines the number of times this cycle is repeated.</span></span> <span data-ttu-id="60e9f-122">Por ejemplo, en los paquetes de seguridad que admiten la autenticación mutua de tres tramos, la secuencia de llamada es la siguiente:</span><span class="sxs-lookup"><span data-stu-id="60e9f-122">For example, in security packages that supports three-leg mutual authentication, the calling sequence is as follows:</span></span>

1.  <span data-ttu-id="60e9f-123">El cliente obtiene un token mediante una llamada a [**InitializeSecurityContext (general)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta)y lo envía al servidor.</span><span class="sxs-lookup"><span data-stu-id="60e9f-123">Client obtains a token by calling [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta), and sends it to the server.</span></span> <span data-ttu-id="60e9f-124">El servidor llama a [**AcceptSecurityContext (general)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext) la primera vez y recupera un token de respuesta que envía al cliente.</span><span class="sxs-lookup"><span data-stu-id="60e9f-124">The server calls [**AcceptSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext) the first time, and gets back a reply token which it sends to the client.</span></span>
2.  <span data-ttu-id="60e9f-125">El cliente utiliza el token recibido del servidor en una segunda llamada a [**InitializeSecurityContext (general)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta)y devuelve un token final.</span><span class="sxs-lookup"><span data-stu-id="60e9f-125">The client uses the token received from the server in a second call to [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta), and gets back a final token.</span></span> <span data-ttu-id="60e9f-126">El cliente envía este token al servidor.</span><span class="sxs-lookup"><span data-stu-id="60e9f-126">The client sends this token to the server.</span></span>
3.  <span data-ttu-id="60e9f-127">El servidor recibe el token generado en la pierna 2 que usa en la llamada final a [**AcceptSecurityContext (general)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext).</span><span class="sxs-lookup"><span data-stu-id="60e9f-127">The server receives the token generated in leg 2 which it uses in the final call to [**AcceptSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext).</span></span>

<span data-ttu-id="60e9f-128">Cuando las funciones [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) y [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) se realizan correctamente y no se requiere más procesamiento para establecer el contexto de seguridad, las funciones deben devolver el estado \_ correcto al llamador.</span><span class="sxs-lookup"><span data-stu-id="60e9f-128">When the [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) and [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) functions succeed and no more processing is required to establish the security context, the functions should return STATUS\_SUCCESS to the caller.</span></span> <span data-ttu-id="60e9f-129">Además, si el paquete de seguridad personalizado admite las [funciones implementadas por SSP/APS en modo de usuario](authentication-functions.md), **SpAcceptLsaModeContext** y **SpInitLsaModeContext** deben devolver **true** mediante el parámetro *MappedContext* .</span><span class="sxs-lookup"><span data-stu-id="60e9f-129">Additionally, if the custom security package supports the [functions implemented by user-mode SSP/APs](authentication-functions.md), **SpAcceptLsaModeContext** and **SpInitLsaModeContext** must return **TRUE** by way of the *MappedContext* parameter.</span></span> <span data-ttu-id="60e9f-130">El valor *MappedContext* no se devuelve a la aplicación; lo intercepta la LSA.</span><span class="sxs-lookup"><span data-stu-id="60e9f-130">The *MappedContext* value is not passed back to the application; it is intercepted by the LSA.</span></span>

<span data-ttu-id="60e9f-131">Cuando *MappedContext* es **true**, LSA llama a la función [**SpUsermodeInitialize**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spusermodeinitializefn) de la dll SSP/AP.</span><span class="sxs-lookup"><span data-stu-id="60e9f-131">When *MappedContext* is **true**, the LSA calls the SSP/AP DLL's [**SpUsermodeInitialize**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spusermodeinitializefn) function.</span></span> <span data-ttu-id="60e9f-132">Esta función proporciona tablas de punteros a las funciones de modo de usuario implementadas por cada paquete de seguridad.</span><span class="sxs-lookup"><span data-stu-id="60e9f-132">This function provides tables of pointers to the user-mode functions implemented by each security package.</span></span> <span data-ttu-id="60e9f-133">Se llama a la función [**SpInstanceInit**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinstanceinitfn) de cada paquete, con las tablas de funciones devueltas por **SpUsermodeInitialize**.</span><span class="sxs-lookup"><span data-stu-id="60e9f-133">Each package's [**SpInstanceInit**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinstanceinitfn) function is called, using the function tables returned by **SpUsermodeInitialize**.</span></span> <span data-ttu-id="60e9f-134">**SpInstanceInit** recibe una tabla de punteros a [las funciones de LSA llamadas por SSP/APS en modo de usuario](authentication-functions.md).</span><span class="sxs-lookup"><span data-stu-id="60e9f-134">**SpInstanceInit** receives a table of pointers to [LSA functions called by user-mode SSP/APs](authentication-functions.md).</span></span>

 

 
