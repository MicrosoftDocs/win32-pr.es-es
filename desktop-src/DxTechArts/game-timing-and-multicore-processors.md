---
title: Control del tiempo de juego y procesadores de varios núcleos
description: En este artículo se sugiere una solución más precisa y confiable para obtener intervalos de CPU de alta resolución mediante las API de Windows QueryPerformanceCounter y QueryPerformanceFrequency.
ms.assetid: 1512324d-dffa-3681-be3f-f63a3b8f11db
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f7a6d9d65ccb79c7b496b4d02b1bed132bdc2d3f
ms.sourcegitcommit: 998a611c97d5e20ac0c45e3bda768ae67d8c2cca
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 05/11/2021
ms.locfileid: "109725014"
---
# <a name="game-timing-and-multicore-processors"></a><span data-ttu-id="b5608-103">Control del tiempo de juego y procesadores de varios núcleos</span><span class="sxs-lookup"><span data-stu-id="b5608-103">Game Timing and Multicore Processors</span></span>

<span data-ttu-id="b5608-104">Con las tecnologías de administración de energía cada vez más comunes en los equipos actuales, es posible que un método que se usa habitualmente para obtener tiempos de CPU de alta resolución, la instrucción RDTSC, ya no funcione según lo previsto.</span><span class="sxs-lookup"><span data-stu-id="b5608-104">With power management technologies becoming more commonplace in today's computers, a commonly-used method to obtain high-resolution CPU timings, the RDTSC instruction, may no longer work as expected.</span></span> <span data-ttu-id="b5608-105">En este artículo se sugiere una solución más precisa y confiable para obtener intervalos de CPU de alta resolución mediante las API de Windows [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) y [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency).</span><span class="sxs-lookup"><span data-stu-id="b5608-105">This article suggests a more accurate, reliable solution to obtain high-resolution CPU timings by using the Windows APIs [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency).</span></span>

-   [<span data-ttu-id="b5608-106">Información preliminar</span><span class="sxs-lookup"><span data-stu-id="b5608-106">Background</span></span>](#background)
-   [<span data-ttu-id="b5608-107">Recomendaciones</span><span class="sxs-lookup"><span data-stu-id="b5608-107">Recommendations</span></span>](#recommendations)
-   [<span data-ttu-id="b5608-108">Compatibilidad de aplicaciones</span><span class="sxs-lookup"><span data-stu-id="b5608-108">Application Compatibility</span></span>](#application-compatibility)

## <a name="background"></a><span data-ttu-id="b5608-109">Información previa</span><span class="sxs-lookup"><span data-stu-id="b5608-109">Background</span></span>

<span data-ttu-id="b5608-110">Desde la introducción del conjunto de instrucciones X86 P5, muchos desarrolladores de juegos han hecho uso del contador de marca de tiempo de lectura, la instrucción RDTSC, para realizar tiempos de alta resolución.</span><span class="sxs-lookup"><span data-stu-id="b5608-110">Since the introduction of the x86 P5 instruction set, many game developers have made use of read time stamp counter, the RDTSC instruction, to perform high-resolution timing.</span></span> <span data-ttu-id="b5608-111">Los temporizadores multimedia de Windows son lo suficientemente precisos para el procesamiento de sonido y vídeo, pero con tiempos de fotogramas de una decenas de milisegundos o menos, no tienen suficiente resolución para proporcionar información en tiempo delta.</span><span class="sxs-lookup"><span data-stu-id="b5608-111">The Windows multimedia timers are precise enough for sound and video processing, but with frame times of a dozen milliseconds or less, they don't have enough resolution to provide delta-time information.</span></span> <span data-ttu-id="b5608-112">Muchos juegos siguen utilizando un temporizador multimedia al inicio para establecer la frecuencia de la CPU y usan ese valor de frecuencia para escalar los resultados de RDTSC para obtener una hora precisa.</span><span class="sxs-lookup"><span data-stu-id="b5608-112">Many games still use a multimedia timer at start-up to establish the frequency of the CPU, and they use that frequency value to scale results from RDTSC to get accurate time.</span></span> <span data-ttu-id="b5608-113">Debido a las limitaciones de RDTSC, la API de Windows expone la manera más correcta de acceder a esta funcionalidad a través de las rutinas [**de QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) y [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency).</span><span class="sxs-lookup"><span data-stu-id="b5608-113">Due to the limitations of RDTSC, the Windows API exposes the more correct way to access this functionality through the routines of [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency).</span></span>

<span data-ttu-id="b5608-114">Este uso de RDTSC para el tiempo sufre estos problemas fundamentales:</span><span class="sxs-lookup"><span data-stu-id="b5608-114">This use of RDTSC for timing suffers from these fundamental issues:</span></span>

-   <span data-ttu-id="b5608-115">Valores discontinuos.</span><span class="sxs-lookup"><span data-stu-id="b5608-115">Discontinuous values.</span></span> <span data-ttu-id="b5608-116">El uso directo de RDTSC supone que el subproceso siempre se ejecuta en el mismo procesador.</span><span class="sxs-lookup"><span data-stu-id="b5608-116">Using RDTSC directly assumes that the thread is always running on the same processor.</span></span> <span data-ttu-id="b5608-117">Los sistemas multiprocesador y de doble núcleo no garantizan la sincronización de sus contadores de ciclo entre núcleos.</span><span class="sxs-lookup"><span data-stu-id="b5608-117">Multiprocessor and dual-core systems do not guarantee synchronization of their cycle counters between cores.</span></span> <span data-ttu-id="b5608-118">Esto se agudizará cuando se combina con tecnologías modernas de administración de energía que inactivan y restauran varios núcleos en momentos diferentes, lo que da lugar a que los núcleos normalmente no se sincronizan.</span><span class="sxs-lookup"><span data-stu-id="b5608-118">This is exacerbated when combined with modern power management technologies that idle and restore various cores at different times, which results in the cores typically being out of synchronization.</span></span> <span data-ttu-id="b5608-119">En el caso de una aplicación, esto suele producir problemas o posibles bloqueos a medida que el subproceso salta entre los procesadores y obtiene valores de tiempo que resultan en diferencias grandes, diferencias negativas o tiempo detenido.</span><span class="sxs-lookup"><span data-stu-id="b5608-119">For an application, this generally results in glitches or in potential crashes as the thread jumps between the processors and gets timing values that result in large deltas, negative deltas, or halted timing.</span></span>
-   <span data-ttu-id="b5608-120">Disponibilidad de hardware dedicado.</span><span class="sxs-lookup"><span data-stu-id="b5608-120">Availability of dedicated hardware.</span></span> <span data-ttu-id="b5608-121">RDTSC bloquea la información de control de tiempo que la aplicación solicita al contador de ciclos del procesador.</span><span class="sxs-lookup"><span data-stu-id="b5608-121">RDTSC locks the timing information that the application requests to the processor's cycle counter.</span></span> <span data-ttu-id="b5608-122">Durante muchos años, esta era la mejor manera de obtener información de control de tiempo de alta precisión, pero las nuevas placa base ahora incluyen dispositivos de control de tiempo dedicados que proporcionan información de control de tiempo de alta resolución sin los inconvenientes de RDTSC.</span><span class="sxs-lookup"><span data-stu-id="b5608-122">For many years this was the best way to get high-precision timing information, but newer motherboards are now including dedicated timing devices which provide high-resolution timing information without the drawbacks of RDTSC.</span></span>
-   <span data-ttu-id="b5608-123">Variabilidad de la frecuencia de la CPU.</span><span class="sxs-lookup"><span data-stu-id="b5608-123">Variability of the CPU's frequency.</span></span> <span data-ttu-id="b5608-124">A menudo se supone que la frecuencia de la CPU se fija durante la vida del programa.</span><span class="sxs-lookup"><span data-stu-id="b5608-124">The assumption is often made that the frequency of the CPU is fixed for the life of the program.</span></span> <span data-ttu-id="b5608-125">Sin embargo, con las tecnologías modernas de administración de energía, se trata de una suposición incorrecta.</span><span class="sxs-lookup"><span data-stu-id="b5608-125">However, with modern power management technologies, this is an incorrect assumption.</span></span> <span data-ttu-id="b5608-126">Aunque inicialmente se limita a equipos portátiles y otros dispositivos móviles, la tecnología que cambia la frecuencia de la CPU está en uso en muchos equipos de escritorio de gama alta. Deshabilitar su función para mantener una frecuencia coherente no suele ser aceptable para los usuarios.</span><span class="sxs-lookup"><span data-stu-id="b5608-126">While initially limited to laptop computers and other mobile devices, technology that changes the frequency of the CPU is in use in many high-end desktop PCs; disabling its function to maintain a consistent frequency is generally not acceptable to users.</span></span>

## <a name="recommendations"></a><span data-ttu-id="b5608-127">Recomendaciones</span><span class="sxs-lookup"><span data-stu-id="b5608-127">Recommendations</span></span>

<span data-ttu-id="b5608-128">Los juegos necesitan información de control de tiempo precisa, pero también debe implementar código de control de tiempo de una manera que evite los problemas asociados con el uso de RDTSC.</span><span class="sxs-lookup"><span data-stu-id="b5608-128">Games need accurate timing information, but you also need to implement timing code in a way that avoids the problems associated with using RDTSC.</span></span> <span data-ttu-id="b5608-129">Al implementar el tiempo de alta resolución, siga estos pasos:</span><span class="sxs-lookup"><span data-stu-id="b5608-129">When you implement high-resolution timing, take the following steps:</span></span>

1.  <span data-ttu-id="b5608-130">Use [**QueryPerformanceCounter y**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) [**QueryPerformanceFrequency en**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) lugar de RDTSC.</span><span class="sxs-lookup"><span data-stu-id="b5608-130">Use [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) instead of RDTSC.</span></span> <span data-ttu-id="b5608-131">Estas API pueden usar RDTSC, pero en su lugar pueden usar dispositivos de control de tiempo en la placa base o en algunos otros servicios del sistema que proporcionan información de control de tiempo de alta resolución de alta calidad.</span><span class="sxs-lookup"><span data-stu-id="b5608-131">These APIs may make use of RDTSC, but might instead make use of a timing devices on the motherboard or some other system services that provide high-quality high-resolution timing information.</span></span> <span data-ttu-id="b5608-132">Aunque RDTSC es mucho más rápido que **QueryPerformanceCounter**, puesto que este último es una llamada API, es una API a la que se puede llamar varios cientos de veces por fotograma sin ningún impacto perceptible.</span><span class="sxs-lookup"><span data-stu-id="b5608-132">While RDTSC is much faster than **QueryPerformanceCounter**, since the latter is an API call, it is an API that can be called several hundred times per frame without any noticeable impact.</span></span> <span data-ttu-id="b5608-133">(No obstante, los desarrolladores deben intentar que sus juegos llamen a **QueryPerformanceCounter** lo menos posible para evitar cualquier penalización de rendimiento).</span><span class="sxs-lookup"><span data-stu-id="b5608-133">(Nevertheless, developers should attempt to have their games call **QueryPerformanceCounter** as little as possible to avoid any performance penalty.)</span></span>
2.  <span data-ttu-id="b5608-134">Al calcular diferencias, los valores deben fijarse para asegurarse de que los errores en los valores de tiempo no provocan bloqueos ni cálculos inestables relacionados con el tiempo.</span><span class="sxs-lookup"><span data-stu-id="b5608-134">When computing deltas, the values should be clamped to ensure that any bugs in the timing values do not cause crashes or unstable time-related computations.</span></span> <span data-ttu-id="b5608-135">El intervalo de fijación debe ser de 0 (para evitar valores diferenciales negativos) a algún valor razonable en función de la velocidad de fotogramas esperada más baja.</span><span class="sxs-lookup"><span data-stu-id="b5608-135">The clamp range should be from 0 (to prevent negative delta values) to some reasonable value based on your lowest expected framerate.</span></span> <span data-ttu-id="b5608-136">Es probable que la fijación sea útil en cualquier depuración de la aplicación, pero asegúrese de tenerla en cuenta si está realizando análisis de rendimiento o ejecutando el juego en algún modo sin optimizar.</span><span class="sxs-lookup"><span data-stu-id="b5608-136">Clamping is likely to be useful in any debugging of your application, but be sure to keep it in mind if doing performance analysis or running the game in some unoptimized mode.</span></span>
3.  <span data-ttu-id="b5608-137">Calcular todos los intervalos en un único subproceso.</span><span class="sxs-lookup"><span data-stu-id="b5608-137">Compute all timing on a single thread.</span></span> <span data-ttu-id="b5608-138">El cálculo del tiempo en varios subprocesos (por ejemplo, con cada subproceso asociado a un procesador específico) reduce en gran medida el rendimiento de los sistemas de varios núcleos.</span><span class="sxs-lookup"><span data-stu-id="b5608-138">Computation of timing on multiple threads — for example, with each thread associated with a specific processor — greatly reduces performance of multi-core systems.</span></span>
4.  <span data-ttu-id="b5608-139">Establezca ese único subproceso para que permanezca en un solo procesador mediante [**setThreadAffinityMask**](/windows/win32/api/winbase/nf-winbase-setthreadaffinitymask)de la API de Windows.</span><span class="sxs-lookup"><span data-stu-id="b5608-139">Set that single thread to remain on a single processor by using the Windows API [**SetThreadAffinityMask**](/windows/win32/api/winbase/nf-winbase-setthreadaffinitymask).</span></span> <span data-ttu-id="b5608-140">Normalmente, este es el subproceso principal del juego.</span><span class="sxs-lookup"><span data-stu-id="b5608-140">Typically, this is the main game thread.</span></span> <span data-ttu-id="b5608-141">Aunque [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) y [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) suelen ajustarse para varios procesadores, los errores en el BIOS o los controladores pueden dar lugar a que estas rutinas devuelvan valores diferentes a medida que el subproceso se mueve de un procesador a otro.</span><span class="sxs-lookup"><span data-stu-id="b5608-141">While [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) typically adjust for multiple processors, bugs in the BIOS or drivers may result in these routines returning different values as the thread moves from one processor to another.</span></span> <span data-ttu-id="b5608-142">Por lo tanto, es mejor mantener el subproceso en un solo procesador.</span><span class="sxs-lookup"><span data-stu-id="b5608-142">So, it's best to keep the thread on a single processor.</span></span>

    <span data-ttu-id="b5608-143">Todos los demás subprocesos deben funcionar sin recopilar sus propios datos de temporizador.</span><span class="sxs-lookup"><span data-stu-id="b5608-143">All other threads should operate without gathering their own timer data.</span></span> <span data-ttu-id="b5608-144">No se recomienda usar un subproceso de trabajo para calcular el tiempo, ya que se convertirá en un cuello de botella de sincronización.</span><span class="sxs-lookup"><span data-stu-id="b5608-144">We do not recommend using a worker thread to compute timing, as this will become a synchronization bottleneck.</span></span> <span data-ttu-id="b5608-145">En su lugar, los subprocesos de trabajo deben leer las marcas de tiempo del subproceso principal y, dado que los subprocesos de trabajo solo leen marcas de tiempo, no es necesario usar secciones críticas.</span><span class="sxs-lookup"><span data-stu-id="b5608-145">Instead, worker threads should read timestamps from the main thread, and because the worker threads only read timestamps, there is no need to use critical sections.</span></span>

5.  <span data-ttu-id="b5608-146">Llame [**a QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) solo una vez, porque la frecuencia no cambiará mientras el sistema se esté ejecutando.</span><span class="sxs-lookup"><span data-stu-id="b5608-146">Call [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) only once, because the frequency will not change while the system is running.</span></span>

## <a name="application-compatibility"></a><span data-ttu-id="b5608-147">Compatibilidad de aplicaciones</span><span class="sxs-lookup"><span data-stu-id="b5608-147">Application Compatibility</span></span>

<span data-ttu-id="b5608-148">Muchos desarrolladores han realizado suposiciones sobre el comportamiento de RDTSC durante muchos años, por lo que es muy probable que algunas aplicaciones existentes presenten problemas cuando se ejecutan en un sistema con varios procesadores o núcleos debido a la implementación de tiempo.</span><span class="sxs-lookup"><span data-stu-id="b5608-148">Many developers have made assumptions about the behavior of RDTSC over many years, so it is quite likely that some existing applications will exhibit problems when run on a system with multiple processors or cores due to the timing implementation.</span></span> <span data-ttu-id="b5608-149">Estos problemas normalmente se manifiestan como problemas o movimiento de movimiento lento.</span><span class="sxs-lookup"><span data-stu-id="b5608-149">These problems will usually manifest as glitching or slow-motion movement.</span></span> <span data-ttu-id="b5608-150">No hay ninguna solución fácil para las aplicaciones que no son conscientes de la administración de energía, pero hay una corrección de compatibilidad (shim) existente para forzar que una aplicación se ejecute siempre en un único procesador en un sistema de varios procesadores.</span><span class="sxs-lookup"><span data-stu-id="b5608-150">There is no easy remedy for applications that are not aware of power management, but there is an existing shim for forcing an application to always run on a single processor in a multiprocessor system.</span></span>

<span data-ttu-id="b5608-151">Para crear esta corrección de compatibilidad, descargue El kit de herramientas de compatibilidad de aplicaciones de Microsoft de [Compatibilidad de aplicaciones de Windows](/archive/blogs/yongrhee/download-application-compatibility-toolkit-act-for-windows-10).</span><span class="sxs-lookup"><span data-stu-id="b5608-151">To create this shim, download the Microsoft Application Compatibility Toolkit from [Windows Application Compatibility](/archive/blogs/yongrhee/download-application-compatibility-toolkit-act-for-windows-10).</span></span>

<span data-ttu-id="b5608-152">Con el administrador de compatibilidad, que forma parte del kit de herramientas, cree una base de datos de la aplicación y las correcciones asociadas.</span><span class="sxs-lookup"><span data-stu-id="b5608-152">Using the Compatibility Administrator, part of the toolkit, create a database of your application and associated fixes.</span></span> <span data-ttu-id="b5608-153">Cree un nuevo modo de compatibilidad para esta base de datos y seleccione la corrección de compatibilidad **SingleProcAffinity** para forzar que todos los subprocesos de la aplicación se ejecuten en un solo procesador o núcleo.</span><span class="sxs-lookup"><span data-stu-id="b5608-153">Create a new compatibility mode for this database and select the compatibility fix **SingleProcAffinity** to force all of the threads of the application to run on a single processor/core.</span></span> <span data-ttu-id="b5608-154">Mediante el uso de la herramienta de línea de comandos Fixpack.exe (también parte del kit de herramientas), puede convertir esta base de datos en un paquete instalable para la instalación, las pruebas y la distribución.</span><span class="sxs-lookup"><span data-stu-id="b5608-154">By using the command-line tool Fixpack.exe (also part of the toolkit), you can convert this database into an installable package for installation, testing, and distribution.</span></span>

<span data-ttu-id="b5608-155">Para obtener instrucciones sobre el uso del administrador de compatibilidad, consulte la documentación del kit de herramientas.</span><span class="sxs-lookup"><span data-stu-id="b5608-155">For instruction on using Compatibility Administrator, see the toolkit's documentation.</span></span> <span data-ttu-id="b5608-156">Para obtener sintaxis de y ejemplos de Fixpack.exe, vea su ayuda de la línea de comandos.</span><span class="sxs-lookup"><span data-stu-id="b5608-156">For syntax for and examples of using Fixpack.exe, see its command-line help.</span></span>

<span data-ttu-id="b5608-157">Para obtener información orientada al cliente, consulte los siguientes artículos knowledge base ayuda y soporte técnico de Microsoft:</span><span class="sxs-lookup"><span data-stu-id="b5608-157">For customer-oriented information, see the following knowledge base articles from Microsoft Help and Support:</span></span>

-   <span data-ttu-id="b5608-158">[Los programas que usan la función QueryPerformanceCounter](https://support.microsoft.com/kb/895980) pueden funcionar mal en Windows Server 2003 y en Windows XP (artículo 895980)</span><span class="sxs-lookup"><span data-stu-id="b5608-158">[Programs that use the QueryPerformanceCounter function may perform poorly in Windows Server 2003 and in Windows XP](https://support.microsoft.com/kb/895980) (article 895980)</span></span>
-   <span data-ttu-id="b5608-159">[El rendimiento de los juegos puede](https://support.microsoft.com/kb/909944) ser deficiente en un equipo basado en Windows XP que usa un procesador de doble núcleo (artículo 909944)</span><span class="sxs-lookup"><span data-stu-id="b5608-159">[Game performance may be poor on a Windows XP-based computer that is using a dual-core processor](https://support.microsoft.com/kb/909944) (article 909944)</span></span>

 

 
