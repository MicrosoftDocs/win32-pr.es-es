---
description: Proceso de creación de instantáneas
ms.assetid: ca484eec-31c6-4790-9232-3ed67263f6fb
title: Proceso de creación de instantáneas
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 4239e2b671edcaeb35b404d9b9411b43316c0212
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/07/2021
ms.locfileid: "103809848"
---
# <a name="the-shadow-copy-creation-process"></a>Proceso de creación de instantáneas

A continuación se describe la función del proveedor de hardware en la creación de un conjunto de instantáneas. Para ver un diagrama de este proceso, vea [creación de instantáneas para proveedores](shadow-copy-creation-for-providers.md).

1.  A medida que el solicitante agrega cada volumen al conjunto de instantáneas, VSS determina los LUN asociados. Por ejemplo, un volumen distribuido podría estar compuesto de varios LUN. VSS crea una [**\_ \_ información**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) inicial del LUN de VDS mediante la información de dispositivo físico para cada LUN.
2.  VSS llama a [**AreLunsSupported**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported) para determinar si el proveedor admite una instantánea para ese LUN. El proveedor de hardware usa [**la \_ \_ información de LUN de VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) para determinar si se admiten los LUN. Esta determinación debe ser All o Nothing; el mismo proveedor de hardware debe admitir todos los LUN que contribuyan a un volumen específico. En el ejemplo de volumen distribuido, el proveedor no puede indicar que solo admite uno de los LUN que componen el volumen.
3.  Para cada volumen del conjunto de instantáneas, VSS llama a [**IVssHardwareSnapshotProvider:: BeginPrepareSnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot) con la misma matriz de estructuras de [**información de \_ LUN \_ de VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) . En una sola llamada, todos los LUN de la matriz son únicos, pero el mismo LUN puede aparecer en una llamada subsiguiente cada vez que el mismo LUN contribuye a varios volúmenes. El proveedor debe controlar el caso correctamente.
4.  Inmediatamente después de [**IVssProviderCreateSnapshotSet:: EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots), VSS establecerá las marcas de solo lectura, ocultas, sin letra de unidad y de instantánea en todos los LUN afectados. Las marcas se implementan mediante sectores ocultos en discos MBR o bits específicos del sistema operativo en la entrada de encabezado de partición en discos GPT. Las marcas harán que todos los volúmenes de los discos afectados se muestren en los equipos receptores como de solo lectura y ocultos. Tenga en cuenta que los LUN de copia sombra no se han confirmado en esta fase, de modo que, en caso de bloqueo del sistema, las marcas se borrarán y el LUN original no se verá afectado. Es decir, todos los volúmenes del LUN original se tratarán como normales y conservarán sus asignaciones originales de letra de unidad, carpetas montadas y estado de lectura/escritura.
    > [!Note]  
    > Los proveedores no deben intentar modificar ninguna de las marcas de LUN.

     

5.  En [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), se confirman los LUN de instantáneas. **CommitSnapshots** debe devolverse en pocos segundos o se producirá un error en todo el proceso de creación de instantáneas.
6.  Después de [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), VSS borra las marcas de todos los LUN originales implicados en la instantánea. Dado que los LUN de instantáneas se han confirmado en este punto, los LUN de instantáneas conservan estas marcas.
7.  Después de [**IVssProviderCreateSnapshotSet::P ostcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots), VSS borra las marcas de LUN (que estableció después de [**IVssProviderCreateSnapshotSet:: EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots)) y notifica a los escritores que se reanudan. A continuación, VSS llama a los métodos [**IVssProviderCreateSnapshotSet::P refinalcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-prefinalcommitsnapshots) y [**IVssProviderCreateSnapshotSet::P ostfinalcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postfinalcommitsnapshots) del proveedor.
8.  VSS recupera una matriz de estructuras [**de \_ \_ información de LUN de VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) , una para cada LUN de instantánea recién creado, llamando a [**IVssHardwareSnapshotProvider:: GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns). El proveedor debe proporcionar información suficiente para permitir que VSS y el proveedor identifiquen las instantáneas en cualquier momento posterior y en cualquier sistema conectado al subsistema. En este momento, no es posible tener acceso a los LUN de instantáneas en este equipo; el proveedor debe usar algún mecanismo distinto de simplemente leyendo la información del LUN.
9.  En el caso de las instantáneas transportables, VSS anexa lo siguiente al documento componentes de copia de seguridad que describe el conjunto de instantáneas:
    1.  La matriz de [**\_ \_ información de LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) de LUN original.
    2.  La nueva matriz de [**\_ \_ información**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) del LUN VDS de LUN de instantáneas.
    3.  Las extensiones de disco para cada volumen del conjunto de instantáneas.
10. En el caso de las instantáneas de importación automática, comienza el proceso de importación. En [**IVssHardwareSnapshotProvider:: LocateLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-locateluns), al proveedor se le proporcionará [**la \_ \_ información de LUN de VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) generada en [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) en el momento de la creación. Durante **LocateLuns**, el proveedor debe hacer que los LUN de instantáneas sean visibles para el sistema. El proveedor no debe hacer que se vuelva a examinar el bus. VSS hará que el nuevo examen y la enumeración permitan que PNP detecte los LUN y que los volúmenes se conecten.
11. VSS llama a [**IVssHardwareSnapshotProvider:: FillInLunInfo**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-fillinluninfo) para los discos recién llegados en el sistema. VSS usa la matriz de [**\_ \_ información LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) de LUN de instantáneas de **FillInLunInfo**, comparándola con **la \_ \_ información de LUN de VDS** generada durante la creación en [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) y las extensiones de disco para cada volumen del conjunto de instantáneas para identificar los LUN de instantánea recién llegados.
12. En este momento, todos los volúmenes contenidos en los LUN de instantánea se montan ocultos y son de solo lectura, y VSS tiene una asignación desde el volumen original al volumen de instantáneas.

Dado que un solo LUN puede contener partes de varios volúmenes, el conjunto de LUN de instantáneas puede incluir volúmenes "adicionales". Esos volúmenes no forman parte del conjunto de instantáneas y no deben usarse, ya que no se garantiza que sean coherentes.

Después de la importación, se puede tener acceso a la instantánea a través del método [**IVssBackupComponents:: query**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-query) . Una instantánea también se puede exponer como una letra de unidad, una carpeta montada o un recurso compartido mediante [**IVssBackupComponents:: ExposeSnapshot**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-exposesnapshot). Un conjunto de instantáneas también se puede convertir en un LUN normal mediante el método [**IVssBackupComponents:: BreakSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-breaksnapshotset) . Desde allí, las aplicaciones de administración pueden usar las API de administración de discos adecuadas para administrar más el LUN (por ejemplo, cambiar los atributos de lectura y escritura).

### <a name="transportable-shadow-copies-on-a-san"></a>Instantáneas transportables en una SAN

A partir de Windows Server 2003, Datacenter Edition y Windows Server 2003, Enterprise Edition, VSS habilita los conjuntos de instantáneas transportables en una red SAN. Desde el punto de vista de un proveedor capaz de transportar LUN entre hosts, hay poca o ninguna diferencia entre un conjunto de instantáneas no transportables y un conjunto de instantáneas transportables.

**Windows server 2003, Standard Edition, Windows server 2003, Web Edition y Windows XP:** No se admiten los conjuntos de instantáneas transportables. Todas las ediciones de Windows Server 2003 con Service Pack 1 (SP1) admiten conjuntos de instantáneas transportables.

Los conjuntos de instantáneas transportables deben crearse con el atributo de **\_ \_ \_ transportable** de atributo VOLSNAP de VSS agregado al contexto de instantáneas descrito por la enumeración de [**\_ \_ \_ \_ atributos de instantáneas de volumen de VSS**](/windows/desktop/api/Vss/ne-vss-vss_volume_snapshot_attributes) . Todos los volúmenes del conjunto deben ser transportables. Al devolver Success desde [**IVssHardwareSnapshotProvider:: AreLunsSupported**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported), el proveedor indica que no solo admite el Lun, sino que también puede transportar el LUN. La creación de un conjunto de instantáneas transportables concluye cuando VSS registra la información del LUN en el documento componentes de copia de seguridad. Un conjunto de instantáneas solo se puede importar una vez después de la creación inicial.

En el equipo receptor, el solicitante importa el conjunto de instantáneas. El método [**IVssBackupComponents:: ImportSnapshots**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-importsnapshots) usa el documento componentes de copia de seguridad que describe el conjunto de instantáneas como entrada. La importación continúa:

1.  VSS crea una matriz de estructuras de [**información de \_ LUN \_ de VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) de instantáneas a partir del documento componentes de copia de seguridad.
2.  Cuando VSS llama a [**IVssHardwareSnapshotProvider:: LocateLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-locateluns), la matriz de estructuras de [**información de \_ LUN \_ de VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) generadas en [**IVssHardwareSnapshotProvider:: GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) se pasará al proveedor. Al procesar este método, el proveedor debe hacer que los LUN de instantáneas sean visibles para el sistema. El proveedor no debe hacer que se vuelva a examinar el bus. VSS desencadenará el nuevo análisis y la enumeración para permitir que PNP detecte los LUN y que los volúmenes se conecten.
3.  VSS llama a [**IVssHardwareSnapshotProvider:: FillInLunInfo**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-fillinluninfo) para los discos recién llegados en el sistema. VSS usa la matriz de LUN de instantánea de estructuras de [**\_ \_ información de LUN de VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) de **FillInLunInfo**, comparándola con la **\_ \_ información de LUN de VDS** generada durante la creación del conjunto de instantáneas en [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) y las extensiones de disco para cada volumen del conjunto de instantáneas para identificar los LUN de instantánea recién llegados.
4.  En este momento, todos los volúmenes contenidos en los LUN transportados se montan y son de solo lectura y VSS tiene una asignación del volumen original al volumen de la instantánea.

Tanto en el caso de una sola máquina como en el caso transportable, la secuencia es similar empezando por el punto en el que se llama a [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) . Para la importación automática, los pasos se realizan directamente después de la creación.

 

 
