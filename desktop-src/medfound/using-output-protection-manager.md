---
description: Más información acerca de cómo usar el administrador de protección de salida
ms.assetid: 01edc17e-e71c-4772-a03c-09c9a2b8400f
title: Usar el administrador de protección de salida
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 57bf4def3b0575dd706ae5f0c62924b6f1375a05
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/07/2021
ms.locfileid: "105720484"
---
# <a name="using-output-protection-manager"></a><span data-ttu-id="f46e6-103">Usar el administrador de protección de salida</span><span class="sxs-lookup"><span data-stu-id="f46e6-103">Using Output Protection Manager</span></span>

<span data-ttu-id="f46e6-104">En este tema se describe cómo usar el administrador de protección de salida (OPM) para proteger el contenido de vídeo mientras viaja a través de un conector físico a un dispositivo de pantalla.</span><span class="sxs-lookup"><span data-stu-id="f46e6-104">This topic describes how to use Output Protection Manager (OPM) to protect video content as it travels over a physical connector to a display device.</span></span> <span data-ttu-id="f46e6-105">Este tema contiene las siguientes secciones:</span><span class="sxs-lookup"><span data-stu-id="f46e6-105">This topic contains the following sections:</span></span>

-   [<span data-ttu-id="f46e6-106">Salidas de vídeo</span><span class="sxs-lookup"><span data-stu-id="f46e6-106">Video Outputs</span></span>](#video-outputs)
-   [<span data-ttu-id="f46e6-107">Inicializar una sesión de OPM</span><span class="sxs-lookup"><span data-stu-id="f46e6-107">Initializing an OPM Session</span></span>](#initializing-an-opm-session)
-   [<span data-ttu-id="f46e6-108">Envío de solicitudes de estado de OPM</span><span class="sxs-lookup"><span data-stu-id="f46e6-108">Sending OPM Status Requests</span></span>](#sending-opm-status-requests)
-   [<span data-ttu-id="f46e6-109">Envío de comandos de OPM</span><span class="sxs-lookup"><span data-stu-id="f46e6-109">Sending OPM Commands</span></span>](#sending-opm-commands)
-   [<span data-ttu-id="f46e6-110">Control de una salida de vídeo deshabilitado</span><span class="sxs-lookup"><span data-stu-id="f46e6-110">Handling a Disabled Video Output</span></span>](#sending-opm-commands)
-   [<span data-ttu-id="f46e6-111">Usar HDCP para proteger el contenido</span><span class="sxs-lookup"><span data-stu-id="f46e6-111">Using HDCP to Protect Content</span></span>](#using-hdcp-to-protect-content)

<span data-ttu-id="f46e6-112">Normalmente, el contenido de vídeo Premium se cifra para protegerlo de la duplicación no autorizada.</span><span class="sxs-lookup"><span data-stu-id="f46e6-112">Premium video content is usually encrypted to protect it from unauthorized duplication.</span></span> <span data-ttu-id="f46e6-113">Por supuesto, el vídeo debe descifrarse antes de que se muestre.</span><span class="sxs-lookup"><span data-stu-id="f46e6-113">Of course, the video must be decrypted before it is displayed.</span></span> <span data-ttu-id="f46e6-114">Los fotogramas descifrados y sin comprimir deben viajar a través de un conector físico al dispositivo de pantalla.</span><span class="sxs-lookup"><span data-stu-id="f46e6-114">The decrypted, uncompressed frames must then travel across a physical connector to the display device.</span></span> <span data-ttu-id="f46e6-115">Los proveedores de contenido pueden requerir que los fotogramas de vídeo estén protegidos en este punto, a medida que viajan por el conector físico.</span><span class="sxs-lookup"><span data-stu-id="f46e6-115">Content providers may require the video frames to be protected at this point, as they travel across the physical connector.</span></span>

<span data-ttu-id="f46e6-116">Existen varios mecanismos de protección para este propósito, como High-Bandwidth Digital Content Protection (HDCP) y DisplayPort Content Protection (DPCP) para las salidas digitales; y copie el sistema de administración de generación-analógico (CGMS-A) para salidas analógicas.</span><span class="sxs-lookup"><span data-stu-id="f46e6-116">Various protection mechanisms exist for this purpose, including High-Bandwidth Digital Content Protection (HDCP) and DisplayPort Content Protection (DPCP) for digital outputs; and Copy Generation Management System - Analog (CGMS-A) for analog outputs.</span></span> <span data-ttu-id="f46e6-117">Por lo general, estos mecanismos implican cifrar o codificar la señal antes de que pase a la pantalla.</span><span class="sxs-lookup"><span data-stu-id="f46e6-117">Generally, these mechanisms involve encrypting or scrambling the signal befores it goes to the display.</span></span>

<span data-ttu-id="f46e6-118">OPM permite a una aplicación aplicar mecanismos de protección de contenido en la salida de vídeo.</span><span class="sxs-lookup"><span data-stu-id="f46e6-118">OPM enables an application to enforce content protection mechanisms on the video output.</span></span> <span data-ttu-id="f46e6-119">Mediante OPM, la aplicación envía comandos y solicitudes de estado al controlador de gráficos a través de un canal seguro y de confianza.</span><span class="sxs-lookup"><span data-stu-id="f46e6-119">Using OPM, the application sends commands and status requests to the graphics driver through a trusted, secure channel.</span></span> <span data-ttu-id="f46e6-120">OPM permite a una aplicación:</span><span class="sxs-lookup"><span data-stu-id="f46e6-120">OPM enables an application to:</span></span>

-   <span data-ttu-id="f46e6-121">Compruebe que el controlador de gráficos está firmado por Microsoft.</span><span class="sxs-lookup"><span data-stu-id="f46e6-121">Verify that a graphics driver has been signed by Microsoft.</span></span>
-   <span data-ttu-id="f46e6-122">Configure un canal de comunicación de confianza con el controlador.</span><span class="sxs-lookup"><span data-stu-id="f46e6-122">Set up a trusted communication channel with the driver.</span></span>
-   <span data-ttu-id="f46e6-123">Aplique los mecanismos de protección de contenido en la salida física.</span><span class="sxs-lookup"><span data-stu-id="f46e6-123">Enforce content protection mechanisms on the physical output.</span></span>

<span data-ttu-id="f46e6-124">OPM reemplaza la protección de la salida certificada protocolo (COPP) y usa una API similar.</span><span class="sxs-lookup"><span data-stu-id="f46e6-124">OPM replaces Certified Output Protection Protcol (COPP) and uses a similar API.</span></span> <span data-ttu-id="f46e6-125">Por compatibilidad con versiones anteriores, la interfaz OPM puede emular la interfaz COPP.</span><span class="sxs-lookup"><span data-stu-id="f46e6-125">For backward compatibility, the OPM interface can emulate the COPP interface.</span></span> <span data-ttu-id="f46e6-126">Entre las diferencias entre OPM y COPP se incluyen las siguientes:</span><span class="sxs-lookup"><span data-stu-id="f46e6-126">Differences between OPM and COPP include the following:</span></span>

-   <span data-ttu-id="f46e6-127">OPM usa certificados X. 509, mientras que COPP usa un formato de certificado propietario.</span><span class="sxs-lookup"><span data-stu-id="f46e6-127">OPM uses X.509 certificates, while COPP uses a proprietary certificate format.</span></span>
-   <span data-ttu-id="f46e6-128">OPM admite repetidores de HDCP.</span><span class="sxs-lookup"><span data-stu-id="f46e6-128">OPM supports HDCP repeaters.</span></span>
-   <span data-ttu-id="f46e6-129">Las aplicaciones que usan OPM no tienen que analizar los mensajes de renovación del sistema HDCP (SRMs).</span><span class="sxs-lookup"><span data-stu-id="f46e6-129">Applications that use OPM do not have to parse HDCP system renewability messages (SRMs).</span></span>
-   <span data-ttu-id="f46e6-130">OPM se puede usar cuando la pantalla de gráficos usa el modo de clonación.</span><span class="sxs-lookup"><span data-stu-id="f46e6-130">OPM can be used when the graphics display is using clone mode.</span></span> <span data-ttu-id="f46e6-131">COPP no admite el modo de clonación.</span><span class="sxs-lookup"><span data-stu-id="f46e6-131">COPP does not support clone mode.</span></span>

<span data-ttu-id="f46e6-132">Si su aplicación usa la ruta de acceso multimedia protegida (PMP) para reproducir contenido de vídeo, no tiene que usar la API de OPM, porque el PMP realiza todas las llamadas OPM necesarias.</span><span class="sxs-lookup"><span data-stu-id="f46e6-132">If your application uses the protected media path (PMP) to play video content, you do not have to use the OPM API, because the PMP makes all of the required OPM calls.</span></span> <span data-ttu-id="f46e6-133">La API de OPM está disponible para las aplicaciones que no usan el PMP.</span><span class="sxs-lookup"><span data-stu-id="f46e6-133">The OPM API is available for applications that do not use the PMP.</span></span>

<span data-ttu-id="f46e6-134">OPM está disponible en Windows Vista y versiones posteriores, pero la API no se hizo pública hasta Windows 7.</span><span class="sxs-lookup"><span data-stu-id="f46e6-134">OPM is available in Windows Vista and later, but the API was not made public until Windows 7.</span></span> <span data-ttu-id="f46e6-135">Para usar OPM en una aplicación, debe tener los encabezados y los archivos de biblioteca del SDK de Windows 7.</span><span class="sxs-lookup"><span data-stu-id="f46e6-135">To use OPM in an application, you must have the headers and library files from the Windows 7 SDK.</span></span> <span data-ttu-id="f46e6-136">No es necesario redistribuir los archivos DLL para usar OPM en Windows Vista o Windows Server 2008.</span><span class="sxs-lookup"><span data-stu-id="f46e6-136">You do not have to redistribute any DLLs to use OPM in Windows Vista or Windows Server 2008.</span></span>

## <a name="video-outputs"></a><span data-ttu-id="f46e6-137">Salidas de vídeo</span><span class="sxs-lookup"><span data-stu-id="f46e6-137">Video Outputs</span></span>

<span data-ttu-id="f46e6-138">Un adaptador de gráficos puede tener más de una salida física, cada una con sus propias capacidades.</span><span class="sxs-lookup"><span data-stu-id="f46e6-138">A graphics adapter can have more than one physical output, each with its own capabilities.</span></span> <span data-ttu-id="f46e6-139">Antes de que una aplicación reproduzca contenido protegido, debe establecer los mecanismos de protección adecuados en cada salida de vídeo asociada a la tarjeta gráfica que mostrará el vídeo.</span><span class="sxs-lookup"><span data-stu-id="f46e6-139">Before an application plays protected content, it must set the appropriate protection mechanisms on every video output associated with the graphics card that will display the video.</span></span> <span data-ttu-id="f46e6-140">Los mecanismos de protección que se aplicarán dependerán de las reglas de uso para el contenido.</span><span class="sxs-lookup"><span data-stu-id="f46e6-140">Which protection mechanisms to apply will depend on the usage rules for the content.</span></span>

<span data-ttu-id="f46e6-141">Cada salida de vídeo se representa mediante una instancia de la interfaz [**IOPMVideoOutput**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) .</span><span class="sxs-lookup"><span data-stu-id="f46e6-141">Each video output is represented by an instance of the [**IOPMVideoOutput**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) interface.</span></span> <span data-ttu-id="f46e6-142">Puede usar un dispositivo Direct3D o controladores de monitor para obtener las salidas de vídeo.</span><span class="sxs-lookup"><span data-stu-id="f46e6-142">You can use a Direct3D device or monitor handles to get the video outputs.</span></span>

<span data-ttu-id="f46e6-143">Uso de un dispositivo Direct3D:</span><span class="sxs-lookup"><span data-stu-id="f46e6-143">Using a Direct3D device:</span></span>

1.  <span data-ttu-id="f46e6-144">Obtiene el puntero **IDirect3DDevice9** para el dispositivo Direct3D que usará la aplicación para crear superficies que contengan los fotogramas de vídeo.</span><span class="sxs-lookup"><span data-stu-id="f46e6-144">Get the **IDirect3DDevice9** pointer for the Direct3D device that your application will use to create surfaces to hold the video frames.</span></span>
2.  <span data-ttu-id="f46e6-145">Llame a la función [**OPMGetVideoOutputsFromIDirect3DDevice9Object**](/windows/desktop/api/opmapi/nf-opmapi-opmgetvideooutputsfromidirect3ddevice9object) .</span><span class="sxs-lookup"><span data-stu-id="f46e6-145">Call the [**OPMGetVideoOutputsFromIDirect3DDevice9Object**](/windows/desktop/api/opmapi/nf-opmapi-opmgetvideooutputsfromidirect3ddevice9object) function.</span></span> <span data-ttu-id="f46e6-146">Esta función asigna una matriz de punteros de [**IOPMVideoOutput**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) , uno para cada salida.</span><span class="sxs-lookup"><span data-stu-id="f46e6-146">This function allocates an array of [**IOPMVideoOutput**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) pointers, one for each output.</span></span>

<span data-ttu-id="f46e6-147">Uso de identificadores de monitor:</span><span class="sxs-lookup"><span data-stu-id="f46e6-147">Using monitor handles:</span></span>

1.  <span data-ttu-id="f46e6-148">Llame a **EnumDisplayMonitors** para obtener los identificadores de **HMONITOR** que corresponden a la ventana de vídeo.</span><span class="sxs-lookup"><span data-stu-id="f46e6-148">Call **EnumDisplayMonitors** to get the **HMONITOR** handles that correspond to the video window.</span></span> <span data-ttu-id="f46e6-149">Se pueden asociar varios monitores a la misma ventana, por lo que puede obtener varios identificadores de **HMONITOR** .</span><span class="sxs-lookup"><span data-stu-id="f46e6-149">Several monitors can be associated with the same window, so you might get several **HMONITOR** handles.</span></span>
2.  <span data-ttu-id="f46e6-150">Para cada controlador de monitor, llame a [**OPMGetVideoOutputsFromHMONITOR**](/windows/desktop/api/opmapi/nf-opmapi-opmgetvideooutputsfromhmonitor).</span><span class="sxs-lookup"><span data-stu-id="f46e6-150">For each monitor handle, call [**OPMGetVideoOutputsFromHMONITOR**](/windows/desktop/api/opmapi/nf-opmapi-opmgetvideooutputsfromhmonitor).</span></span> <span data-ttu-id="f46e6-151">Esta función asigna una matriz de punteros de [**IOPMVideoOutput**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) , uno para cada salida.</span><span class="sxs-lookup"><span data-stu-id="f46e6-151">This function allocates an array of [**IOPMVideoOutput**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) pointers, one for each output.</span></span>

## <a name="initializing-an-opm-session"></a><span data-ttu-id="f46e6-152">Inicializar una sesión de OPM</span><span class="sxs-lookup"><span data-stu-id="f46e6-152">Initializing an OPM Session</span></span>

<span data-ttu-id="f46e6-153">Antes de que la aplicación envíe comandos OPM o solicitudes de estado, debe comprobar que la salida del vídeo es de confianza y establecer una clave de sesión.</span><span class="sxs-lookup"><span data-stu-id="f46e6-153">Before the application sends OPM commands or status requests, it must verify that the video output is trusted and establish a session key.</span></span> <span data-ttu-id="f46e6-154">La clave de sesión se usa para firmar los datos que se intercambian entre la aplicación y el controlador de gráficos.</span><span class="sxs-lookup"><span data-stu-id="f46e6-154">The session key is used to sign the data that is exchanged between the application and the graphics driver.</span></span>

<span data-ttu-id="f46e6-155">La API de OPM define un protocolo de enlace que establece la confianza y establece la clave de sesión.</span><span class="sxs-lookup"><span data-stu-id="f46e6-155">The OPM API defines a handshake that establishes trust and sets the session key.</span></span> <span data-ttu-id="f46e6-156">Debe realizar este protocolo de enlace para cada instancia de la interfaz [**IOPMVideoOutput**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) , como se indica a continuación:</span><span class="sxs-lookup"><span data-stu-id="f46e6-156">You must perform this handshake for each instance of the [**IOPMVideoOutput**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) interface, as follows:</span></span>

1.  <span data-ttu-id="f46e6-157">Llame a [**IOPMVideoOutput:: StartInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-startinitialization).</span><span class="sxs-lookup"><span data-stu-id="f46e6-157">Call [**IOPMVideoOutput::StartInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-startinitialization).</span></span> <span data-ttu-id="f46e6-158">Este método recupera dos fragmentos de datos:</span><span class="sxs-lookup"><span data-stu-id="f46e6-158">This method retrieves two pieces of data:</span></span>
    -   <span data-ttu-id="f46e6-159">Número aleatorio generado por el controlador.</span><span class="sxs-lookup"><span data-stu-id="f46e6-159">A random number, generated by the driver.</span></span> <span data-ttu-id="f46e6-160">Usará este número para completar el protocolo de enlace.</span><span class="sxs-lookup"><span data-stu-id="f46e6-160">You will use this number to complete the handshake.</span></span>
    -   <span data-ttu-id="f46e6-161">La cadena de certificados X. 509 del controlador.</span><span class="sxs-lookup"><span data-stu-id="f46e6-161">The driver's X.509 certificate chain.</span></span>
2.  <span data-ttu-id="f46e6-162">Compruebe que Microsoft ha firmado la cadena de certificados.</span><span class="sxs-lookup"><span data-stu-id="f46e6-162">Verify that the certificate chain has been signed by Microsoft.</span></span>
    > [!Note]  
    > <span data-ttu-id="f46e6-163">La revocación de certificados está fuera del ámbito de OPM.</span><span class="sxs-lookup"><span data-stu-id="f46e6-163">Certificate revocation is outside the scope of OPM.</span></span>

     

3.  <span data-ttu-id="f46e6-164">Obtiene la clave pública del controlador de la cadena de certificados.</span><span class="sxs-lookup"><span data-stu-id="f46e6-164">Get the driver's public key from the certificate chain.</span></span>
4.  <span data-ttu-id="f46e6-165">Genere una clave de sesión AES de 128 bits.</span><span class="sxs-lookup"><span data-stu-id="f46e6-165">Generate a 128-bit AES session key.</span></span>
5.  <span data-ttu-id="f46e6-166">Generar dos números de bits 32 aleatorios:</span><span class="sxs-lookup"><span data-stu-id="f46e6-166">Generate two random 32-bit numbers:</span></span>

    -   <span data-ttu-id="f46e6-167">El número de secuencia inicial para solicitudes de estado de OPM.</span><span class="sxs-lookup"><span data-stu-id="f46e6-167">The starting sequence number for OPM status requests.</span></span>
    -   <span data-ttu-id="f46e6-168">El número de secuencia inicial para los comandos OPM.</span><span class="sxs-lookup"><span data-stu-id="f46e6-168">The starting sequence number for OPM commands.</span></span>

    <span data-ttu-id="f46e6-169">Estos números se deben generar mediante un generador de números pseudoaleatorios seguro criptográficamente, como **CryptGenRandom**.</span><span class="sxs-lookup"><span data-stu-id="f46e6-169">These numbers must be generated using a cryptographically secure pseudo-random number generator, such as **CryptGenRandom**.</span></span>

6.  <span data-ttu-id="f46e6-170">Copie el número aleatorio del controlador (obtenido en el paso 1), la clave de sesión y los dos números de secuencia en una estructura de [**\_ \_ \_ parámetros de inicialización cifrada de OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_encrypted_initialization_parameters) , como se describe en [**IOPMVideoOutput:: FinishInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization).</span><span class="sxs-lookup"><span data-stu-id="f46e6-170">Copy the driver's random number (obtained in step 1), the session key, and the two sequence numbers into an [**OPM\_ENCRYPTED\_INITIALIZATION\_PARAMETERS**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_encrypted_initialization_parameters) structure, as described in [**IOPMVideoOutput::FinishInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization).</span></span>
7.  <span data-ttu-id="f46e6-171">Cifre la estructura de [**\_ \_ \_ parámetros de inicialización cifrada de OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_encrypted_initialization_parameters) con RSAES-OAEP mediante la clave pública del controlador, que se encuentra en el certificado del controlador.</span><span class="sxs-lookup"><span data-stu-id="f46e6-171">Encrypt the [**OPM\_ENCRYPTED\_INITIALIZATION\_PARAMETERS**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_encrypted_initialization_parameters) structure with RSAES-OAEP, using the driver's public key, which is found in the driver's certificate.</span></span>
8.  <span data-ttu-id="f46e6-172">Llame a [**IOPMVideoOutput:: FinishInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization).</span><span class="sxs-lookup"><span data-stu-id="f46e6-172">Call [**IOPMVideoOutput::FinishInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization).</span></span>

## <a name="sending-opm-status-requests"></a><span data-ttu-id="f46e6-173">Envío de solicitudes de estado de OPM</span><span class="sxs-lookup"><span data-stu-id="f46e6-173">Sending OPM Status Requests</span></span>

<span data-ttu-id="f46e6-174">Las solicitudes de estado de OPM devuelven información sobre la salida de vídeo, como el tipo de conector físico y el nivel de protección actual.</span><span class="sxs-lookup"><span data-stu-id="f46e6-174">OPM status requests return information about the video output, such as the type of physical connector and the current protection level.</span></span> <span data-ttu-id="f46e6-175">Para obtener una lista de tipos de solicitud, consulte [solicitudes de estado de OPM](opm-status-requests.md).</span><span class="sxs-lookup"><span data-stu-id="f46e6-175">For a list of request types, see [OPM Status Requests](opm-status-requests.md).</span></span>

<span data-ttu-id="f46e6-176">Para enviar una solicitud de estado, realice los pasos siguientes.</span><span class="sxs-lookup"><span data-stu-id="f46e6-176">To send a status request, perform the following steps.</span></span>

1.  <span data-ttu-id="f46e6-177">Inicialice una estructura de [**\_ parámetros de obtención de \_ información \_ de OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) tal y como se muestra en la tabla siguiente.</span><span class="sxs-lookup"><span data-stu-id="f46e6-177">Initialize an [**OPM\_GET\_INFO\_PARAMETERS**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) structure as shown in the following table.</span></span>

    | <span data-ttu-id="f46e6-178">Miembro</span><span class="sxs-lookup"><span data-stu-id="f46e6-178">Member</span></span>               | <span data-ttu-id="f46e6-179">Descripción</span><span class="sxs-lookup"><span data-stu-id="f46e6-179">Description</span></span>                                                                                                                                                                                                                                                                                                                                                                 |
    |----------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
    | <span data-ttu-id="f46e6-180">**omac**</span><span class="sxs-lookup"><span data-stu-id="f46e6-180">**omac**</span></span>             | <span data-ttu-id="f46e6-181">Omitir este campo por ahora.</span><span class="sxs-lookup"><span data-stu-id="f46e6-181">Skip this field for now.</span></span>                                                                                                                                                                                                                                                                                                                                                    |
    | <span data-ttu-id="f46e6-182">**rnRandomNumber**</span><span class="sxs-lookup"><span data-stu-id="f46e6-182">**rnRandomNumber**</span></span>   | <span data-ttu-id="f46e6-183">Número aleatorio de 128 bits criptográficamente seguro.</span><span class="sxs-lookup"><span data-stu-id="f46e6-183">A cryptographically secure 128-bit random number.</span></span> <span data-ttu-id="f46e6-184">Siempre que realice una solicitud de estado, genere siempre un nuevo número aleatorio, incluso si realiza la misma solicitud.</span><span class="sxs-lookup"><span data-stu-id="f46e6-184">Whenever you make a status request, always generate a new random number, even if you are making the same request.</span></span> <span data-ttu-id="f46e6-185">Almacene el número en una variable, ya que tendrá que hacer referencia a él más adelante.</span><span class="sxs-lookup"><span data-stu-id="f46e6-185">Store the number in a variable, because you will need to refer to it later.</span></span>                                                                                                                             |
    | <span data-ttu-id="f46e6-186">**guidInformation**</span><span class="sxs-lookup"><span data-stu-id="f46e6-186">**guidInformation**</span></span>  | <span data-ttu-id="f46e6-187">GUID que identifica la solicitud de estado.</span><span class="sxs-lookup"><span data-stu-id="f46e6-187">A GUID that identifies the status request.</span></span> <span data-ttu-id="f46e6-188">Para obtener una lista de solicitudes de estado, consulte [solicitudes de estado de OPM](opm-status-requests.md).</span><span class="sxs-lookup"><span data-stu-id="f46e6-188">For a list of status requests, see [OPM Status Requests](opm-status-requests.md).</span></span>                                                                                                                                                                                                                                               |
    | <span data-ttu-id="f46e6-189">**ulSequenceNumber**</span><span class="sxs-lookup"><span data-stu-id="f46e6-189">**ulSequenceNumber**</span></span> | <span data-ttu-id="f46e6-190">El número de secuencia global.</span><span class="sxs-lookup"><span data-stu-id="f46e6-190">The sequence number.</span></span> <span data-ttu-id="f46e6-191">Para la primera solicitud de estado, use el número de secuencia de inicio que especificó en el método [**IOPMVideoOutput:: FinishInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization) (paso 5 de la [inicialización de una sesión de OPM](#initializing-an-opm-session)). Cada vez que realice otra solicitud de estado, incremente este número en 1.</span><span class="sxs-lookup"><span data-stu-id="f46e6-191">For the first status request, use the starting sequence number that you specified in the [**IOPMVideoOutput::FinishInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization) method (step 5 of [Initializing an OPM Session](#initializing-an-opm-session).) Each time you make another status request, increment this number by 1.</span></span> |
    | <span data-ttu-id="f46e6-192">**abParameters**</span><span class="sxs-lookup"><span data-stu-id="f46e6-192">**abParameters**</span></span>     | <span data-ttu-id="f46e6-193">Matriz de bytes que contiene datos de entrada adicionales para la solicitud.</span><span class="sxs-lookup"><span data-stu-id="f46e6-193">A byte array that contains additional input data for the request.</span></span> <span data-ttu-id="f46e6-194">El formato de los datos de entrada se muestra en el tema de referencia de cada solicitud de estado.</span><span class="sxs-lookup"><span data-stu-id="f46e6-194">The format of the input data is listed in the reference topic for each status request.</span></span>                                                                                                                                                                                                                    |
    | <span data-ttu-id="f46e6-195">**cbParametersSize**</span><span class="sxs-lookup"><span data-stu-id="f46e6-195">**cbParametersSize**</span></span> | <span data-ttu-id="f46e6-196">Tamaño de los datos válidos de la matriz **abParameters** .</span><span class="sxs-lookup"><span data-stu-id="f46e6-196">The size of the valid data in the **abParameters** array.</span></span> <span data-ttu-id="f46e6-197">El contenido del resto de la matriz no está definido.</span><span class="sxs-lookup"><span data-stu-id="f46e6-197">The contents of the rest of the array are undefined.</span></span>                                                                                                                                                                                                                                                              |

    

     

2.  <span data-ttu-id="f46e6-198">Calcule el CBC MAC de una clave (OMAC-1) para calcular un hash para el bloque de datos que aparece después del miembro **OMAC** y, a continuación, establezca el miembro **OMAC** en este valor.</span><span class="sxs-lookup"><span data-stu-id="f46e6-198">Calculate the one-key CBC MAC (OMAC-1) to calculate a hash for the block of data that appears after the **omac** member, and then set the **omac** member to this value.</span></span> <span data-ttu-id="f46e6-199">Vea [código de ejemplo de OPM](opm-example-code.md).</span><span class="sxs-lookup"><span data-stu-id="f46e6-199">See [OPM Example Code](opm-example-code.md).</span></span>
3.  <span data-ttu-id="f46e6-200">Llame al método [**IOPMVideoOutput:: GetInformation**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) .</span><span class="sxs-lookup"><span data-stu-id="f46e6-200">Call the [**IOPMVideoOutput::GetInformation**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) method.</span></span> <span data-ttu-id="f46e6-201">Pase un puntero a la estructura [**de \_ \_ \_ parámetros de obtención de información de OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) y un puntero a una estructura de [**\_ \_ información solicitada de OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) .</span><span class="sxs-lookup"><span data-stu-id="f46e6-201">Pass in a pointer to the [**OPM\_GET\_INFO\_PARAMETERS**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) structure and a pointer to an [**OPM\_REQUESTED\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) structure.</span></span> <span data-ttu-id="f46e6-202">La respuesta del controlador se escribe en la estructura de **\_ \_ información solicitada de OPM** .</span><span class="sxs-lookup"><span data-stu-id="f46e6-202">The driver's response is written to the **OPM\_REQUESTED\_INFORMATION** structure.</span></span>
    -   <span data-ttu-id="f46e6-203">El miembro **OMAC** de esta estructura contiene una OMAC calculada para los datos que siguen a este miembro.</span><span class="sxs-lookup"><span data-stu-id="f46e6-203">The **omac** member of this structure contains an OMAC computed for the data that follows this member.</span></span>
    -   <span data-ttu-id="f46e6-204">El miembro **abRequestedInformation** es una matriz de bytes que contiene los datos de salida de la respuesta.</span><span class="sxs-lookup"><span data-stu-id="f46e6-204">The **abRequestedInformation** member is a byte array that contains output data for the response.</span></span> <span data-ttu-id="f46e6-205">El formato de los datos de salida se muestra en el tema de referencia de cada solicitud de estado.</span><span class="sxs-lookup"><span data-stu-id="f46e6-205">The format of the output data is listed in the reference topic for each status request.</span></span>
4.  <span data-ttu-id="f46e6-206">Calcula un OMAC para la estructura de [**\_ \_ información solicitada de OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) , sin incluir el miembro **OMAC** .</span><span class="sxs-lookup"><span data-stu-id="f46e6-206">Calculate an OMAC for the [**OPM\_REQUESTED\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) structure, not including the **omac** member.</span></span> <span data-ttu-id="f46e6-207">Compruebe que OMAC coincide con el valor del miembro **OMAC** .</span><span class="sxs-lookup"><span data-stu-id="f46e6-207">Verify that the OMAC matches the value in the **omac** member.</span></span>
5.  <span data-ttu-id="f46e6-208">Asegúrese de que el miembro **cbRequestedInformationSize** de la estructura de [**\_ \_ información solicitada de OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) proporciona el tamaño correcto para los datos de salida.</span><span class="sxs-lookup"><span data-stu-id="f46e6-208">Make sure the **cbRequestedInformationSize** member of the [**OPM\_REQUESTED\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) structure gives the correct size for the output data.</span></span> <span data-ttu-id="f46e6-209">Por ejemplo, los datos de salida de la consulta de [**\_ \_ \_ tipo de conector OPM Get**](opm-get-connector-type.md) son una estructura de [**\_ \_ información estándar de OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) , por lo que el valor de **cbRequestedInformationSize** debe ser `sizeof(OPM_STANDARD_INFORMATION)` .</span><span class="sxs-lookup"><span data-stu-id="f46e6-209">For example, the output data for the [**OPM\_GET\_CONNECTOR\_TYPE**](opm-get-connector-type.md) query is an [**OPM\_STANDARD\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) structure, so the value of **cbRequestedInformationSize** should be `sizeof(OPM_STANDARD_INFORMATION)`.</span></span>
6.  <span data-ttu-id="f46e6-210">Convierta el miembro **abRequestedInformation** de la estructura de [**\_ \_ información solicitada de OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) en la estructura de datos de salida correcta.</span><span class="sxs-lookup"><span data-stu-id="f46e6-210">Cast the **abRequestedInformation** member of the [**OPM\_REQUESTED\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) structure to the correct output data structure.</span></span> <span data-ttu-id="f46e6-211">Por ejemplo, si la solicitud de estado es el [**\_ tipo de \_ conector \_ OPM Get**](opm-get-connector-type.md), convierta **abRequestedInformation** en una estructura de [**\_ \_ información estándar de OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) .</span><span class="sxs-lookup"><span data-stu-id="f46e6-211">For example, if the status request is [**OPM\_GET\_CONNECTOR\_TYPE**](opm-get-connector-type.md), cast **abRequestedInformation** to an [**OPM\_STANDARD\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) structure.</span></span>
7.  <span data-ttu-id="f46e6-212">Asegúrese de que el miembro **rnRandomNumber** de la estructura de datos de salida coincide con el valor de **rnRandomNumber** del paso 1.</span><span class="sxs-lookup"><span data-stu-id="f46e6-212">Make sure the **rnRandomNumber** member of the output data structure matches the value of **rnRandomNumber** from step 1.</span></span>
8.  <span data-ttu-id="f46e6-213">Compruebe el miembro **ulStatusFlags** de la estructura de datos de salida, tal como se describe en [controlar una salida de vídeo deshabilitado](#handling-a-disabled-video-output).</span><span class="sxs-lookup"><span data-stu-id="f46e6-213">Check the **ulStatusFlags** member of the output data structure, as described in [Handling a Disabled Video Output](#handling-a-disabled-video-output).</span></span>

<span data-ttu-id="f46e6-214">Si se produce un error en cualquiera de las comprobaciones en los pasos 5 – 8, la aplicación debe dejar de mostrar contenido protegido.</span><span class="sxs-lookup"><span data-stu-id="f46e6-214">If any of the checks in steps 5–8 fails, the application must stop showing protected content.</span></span>

## <a name="sending-opm-commands"></a><span data-ttu-id="f46e6-215">Envío de comandos de OPM</span><span class="sxs-lookup"><span data-stu-id="f46e6-215">Sending OPM Commands</span></span>

<span data-ttu-id="f46e6-216">Los comandos OPM se usan para establecer el nivel de protección y otros valores en la salida de vídeo.</span><span class="sxs-lookup"><span data-stu-id="f46e6-216">OPM commands are used to set the protection level and other settings on the video output.</span></span> <span data-ttu-id="f46e6-217">El envío de un comando OPM es similar a enviar una solicitud de estado, salvo que no hay datos de respuesta del controlador.</span><span class="sxs-lookup"><span data-stu-id="f46e6-217">Sending an OPM command is similar to sending a status request, except there is no response data from the driver.</span></span> <span data-ttu-id="f46e6-218">Para obtener una lista de comandos, consulte [comandos de OPM](opm-commands.md).</span><span class="sxs-lookup"><span data-stu-id="f46e6-218">For a list of commands, see [OPM Commands](opm-commands.md).</span></span>

<span data-ttu-id="f46e6-219">Para enviar un comando OPM, realice los pasos siguientes.</span><span class="sxs-lookup"><span data-stu-id="f46e6-219">To send an OPM command, perform the following steps.</span></span>

1.  <span data-ttu-id="f46e6-220">Rellene una estructura de [**\_ \_ parámetros de configuración de OPM**](/windows/desktop/api/opmapi/ns-opmapi-opm_configure_parameters) tal y como se muestra en la tabla siguiente.</span><span class="sxs-lookup"><span data-stu-id="f46e6-220">Fill in an [**OPM\_CONFIGURE\_PARAMETERS**](/windows/desktop/api/opmapi/ns-opmapi-opm_configure_parameters) structure as shown in the following table.</span></span>

    | <span data-ttu-id="f46e6-221">Miembro</span><span class="sxs-lookup"><span data-stu-id="f46e6-221">Member</span></span>                | <span data-ttu-id="f46e6-222">Descripción</span><span class="sxs-lookup"><span data-stu-id="f46e6-222">Description</span></span>                                                                                                                                                                                                                                                                                                                                                   |
    |-----------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
    | <span data-ttu-id="f46e6-223">**omac**</span><span class="sxs-lookup"><span data-stu-id="f46e6-223">**omac**</span></span>              | <span data-ttu-id="f46e6-224">Omitir este campo por ahora.</span><span class="sxs-lookup"><span data-stu-id="f46e6-224">Skip this field for now.</span></span>                                                                                                                                                                                                                                                                                                                                      |
    | <span data-ttu-id="f46e6-225">**guidSetting**</span><span class="sxs-lookup"><span data-stu-id="f46e6-225">**guidSetting**</span></span>       | <span data-ttu-id="f46e6-226">GUID que identifica el comando.</span><span class="sxs-lookup"><span data-stu-id="f46e6-226">A GUID that identifies the command.</span></span> <span data-ttu-id="f46e6-227">Para obtener una lista de comandos, consulte [comandos de OPM](opm-commands.md).</span><span class="sxs-lookup"><span data-stu-id="f46e6-227">For a list of commands, see [OPM Commands](opm-commands.md).</span></span>                                                                                                                                                                                                                                                             |
    | <span data-ttu-id="f46e6-228">**ulSequenceNumber**</span><span class="sxs-lookup"><span data-stu-id="f46e6-228">**ulSequenceNumber**</span></span>  | <span data-ttu-id="f46e6-229">El número de secuencia global.</span><span class="sxs-lookup"><span data-stu-id="f46e6-229">The sequence number.</span></span> <span data-ttu-id="f46e6-230">Para el primer comando, use el número de secuencia inicial que especificó en el método [**IOPMVideoOutput:: FinishInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization) (paso 5 de la [inicialización de una sesión OPM](#initializing-an-opm-session)). Cada vez que envíe otro comando, incremente este número en 1.</span><span class="sxs-lookup"><span data-stu-id="f46e6-230">For the first command, use the starting sequence number that you specified in the [**IOPMVideoOutput::FinishInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization) method (step 5 of [Initializing an OPM Session](#initializing-an-opm-session).) Each time you send another command, increment this number by 1.</span></span> |
    | <span data-ttu-id="f46e6-231">**abParameters**</span><span class="sxs-lookup"><span data-stu-id="f46e6-231">**abParameters**</span></span>      | <span data-ttu-id="f46e6-232">Matriz de bytes que contiene datos de entrada adicionales para el comando.</span><span class="sxs-lookup"><span data-stu-id="f46e6-232">A byte array that contains additional input data for the command.</span></span> <span data-ttu-id="f46e6-233">El formato de los datos de entrada se muestra en el tema de referencia de cada comando.</span><span class="sxs-lookup"><span data-stu-id="f46e6-233">The format of the input data is listed in the reference topic for each command.</span></span>                                                                                                                                                                                                             |
    | <span data-ttu-id="f46e6-234">**cbSettingDataSize**</span><span class="sxs-lookup"><span data-stu-id="f46e6-234">**cbSettingDataSize**</span></span> | <span data-ttu-id="f46e6-235">Tamaño de los datos válidos de la matriz **abParameters** .</span><span class="sxs-lookup"><span data-stu-id="f46e6-235">The size of the valid data in the **abParameters** array.</span></span> <span data-ttu-id="f46e6-236">El contenido del resto de la matriz no está definido.</span><span class="sxs-lookup"><span data-stu-id="f46e6-236">The contents of the rest of the array are undefined.</span></span>                                                                                                                                                                                                                                                |

    

     

2.  <span data-ttu-id="f46e6-237">Calcule un OMAC para el bloque de datos que aparece después del miembro **OMAC** y, a continuación, establezca el miembro **OMAC** en este valor.</span><span class="sxs-lookup"><span data-stu-id="f46e6-237">Calculate an OMAC for the block of data that appears after the **omac** member, and then set the **omac** member to this value.</span></span>
3.  <span data-ttu-id="f46e6-238">Llame a [**IOPMVideoOutput:: configure**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-configure).</span><span class="sxs-lookup"><span data-stu-id="f46e6-238">Call [**IOPMVideoOutput::Configure**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-configure).</span></span>

<span data-ttu-id="f46e6-239">Para la mayoría de los comandos, hay una solicitud de estado correspondiente que devuelve el estado del comando.</span><span class="sxs-lookup"><span data-stu-id="f46e6-239">For most commands, there is a corresponding status request that returns the status of the command.</span></span> <span data-ttu-id="f46e6-240">Por ejemplo, el [**comando \_ configuración \_ de \_ nivel de protección OPM**](opm-set-protection-level.md) establece el nivel de protección y el comando [**OPM \_ obtener \_ \_ \_ nivel**](opm-get-virtual-protection-level.md) de protección virtual obtiene el nivel de protección actual.</span><span class="sxs-lookup"><span data-stu-id="f46e6-240">For example, the [**OPM\_SET\_PROTECTION\_LEVEL**](opm-set-protection-level.md) command sets the protection level, and the [**OPM\_GET\_VIRTUAL\_PROTECTION\_LEVEL**](opm-get-virtual-protection-level.md) command gets the current protection level.</span></span>

## <a name="handling-a-disabled-video-output"></a><span data-ttu-id="f46e6-241">Control de una salida de vídeo deshabilitado</span><span class="sxs-lookup"><span data-stu-id="f46e6-241">Handling a Disabled Video Output</span></span>

<span data-ttu-id="f46e6-242">Una salida de vídeo podría deshabilitarse en cualquier momento para evitar el uso no autorizado del contenido de vídeo.</span><span class="sxs-lookup"><span data-stu-id="f46e6-242">A video output might disable itself at any time to prevent the unauthorized use of video content.</span></span> <span data-ttu-id="f46e6-243">Esto puede deberse a que un mecanismo de protección deja de funcionar, porque el controlador detecta alteraciones o porque la pantalla se desconectó del conector físico.</span><span class="sxs-lookup"><span data-stu-id="f46e6-243">This might occur because a protection mechanism stops working, because the driver detects tampering, or because the display was disconnected from the physical connector.</span></span> <span data-ttu-id="f46e6-244">Mientras una salida de vídeo está deshabilitada, no se muestran fotogramas de vídeo.</span><span class="sxs-lookup"><span data-stu-id="f46e6-244">While a video output is disabled, no video frames are displayed.</span></span>

<span data-ttu-id="f46e6-245">Mientras está habilitada la protección de contenido, una aplicación debe realizar periódicamente (al menos una vez cada 2 segundos) los pasos siguientes.</span><span class="sxs-lookup"><span data-stu-id="f46e6-245">While content protection is enabled, an application should periodically (at least once every 2 seconds) perform the following steps.</span></span>

1.  <span data-ttu-id="f46e6-246">Llame a [**IOPMVideoOutput:: GetInformation**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) para enviar el [**\_ nivel de \_ \_ protección \_ de OPM real**](opm-get-actual-protection-level.md) o la solicitud de estado de [**\_ \_ \_ \_ nivel de protección virtual de OPM**](opm-get-virtual-protection-level.md) .</span><span class="sxs-lookup"><span data-stu-id="f46e6-246">Call [**IOPMVideoOutput::GetInformation**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) to send either the [**OPM\_GET\_ACTUAL\_PROTECTION\_LEVEL**](opm-get-actual-protection-level.md) or [**OPM\_GET\_VIRTUAL\_PROTECTION\_LEVEL**](opm-get-virtual-protection-level.md) status request.</span></span> <span data-ttu-id="f46e6-247">Los datos devueltos para ambos comandos son una estructura de [**\_ \_ información estándar de OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) .</span><span class="sxs-lookup"><span data-stu-id="f46e6-247">The return data for both commands is an [**OPM\_STANDARD\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) structure.</span></span>
2.  <span data-ttu-id="f46e6-248">Compruebe el miembro **ulInformation** de la estructura de [**\_ \_ información estándar de OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) .</span><span class="sxs-lookup"><span data-stu-id="f46e6-248">Check the **ulInformation** member of the [**OPM\_STANDARD\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) structure.</span></span> <span data-ttu-id="f46e6-249">Este miembro contiene una marca que indica si la protección de contenido todavía está habilitada.</span><span class="sxs-lookup"><span data-stu-id="f46e6-249">This member contains a flag indicating whether content protection is still enabled.</span></span> <span data-ttu-id="f46e6-250">Si la protección de contenido está desactivada, detenga la reproducción del vídeo inmediatamente.</span><span class="sxs-lookup"><span data-stu-id="f46e6-250">If content protection is off, stop playing the video immediately.</span></span>
3.  <span data-ttu-id="f46e6-251">Si la protección de contenido está activada, compruebe el miembro **ulStatusFlags** de la estructura de [**\_ \_ información estándar de OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) .</span><span class="sxs-lookup"><span data-stu-id="f46e6-251">If content protection is on, check the **ulStatusFlags** member of the [**OPM\_STANDARD\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) structure.</span></span> <span data-ttu-id="f46e6-252">Si no se establece ningún marcador, la salida del vídeo funciona correctamente.</span><span class="sxs-lookup"><span data-stu-id="f46e6-252">If no flags are set, the video output is working correctly.</span></span> <span data-ttu-id="f46e6-253">De lo contrario, la salida de vídeo está deshabilitada.</span><span class="sxs-lookup"><span data-stu-id="f46e6-253">Otherwise, the video output is disabled.</span></span>

<span data-ttu-id="f46e6-254">Se definen las marcas siguientes para **ulStatusFlags**.</span><span class="sxs-lookup"><span data-stu-id="f46e6-254">The following flags are defined for **ulStatusFlags**.</span></span>



<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th><span data-ttu-id="f46e6-255">Marca</span><span class="sxs-lookup"><span data-stu-id="f46e6-255">Flag</span></span></th>
<th><span data-ttu-id="f46e6-256">Descripción</span><span class="sxs-lookup"><span data-stu-id="f46e6-256">Description</span></span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span data-ttu-id="f46e6-257"><strong>OPM_STATUS_LINK_LOST</strong></span><span class="sxs-lookup"><span data-stu-id="f46e6-257"><strong>OPM_STATUS_LINK_LOST</strong></span></span></td>
<td><span data-ttu-id="f46e6-258">La protección de la salida dejó de funcionar por algún motivo. por ejemplo, el dispositivo de pantalla podría estar desconectado de conntector.</span><span class="sxs-lookup"><span data-stu-id="f46e6-258">Output protection stopped working for some reason; for example, the display device might be unplugged from the conntector.</span></span> <span data-ttu-id="f46e6-259">Detenga la reproducción y desactive todos los mecanismos de protección de salida.</span><span class="sxs-lookup"><span data-stu-id="f46e6-259">Stop playback and turn off all output protection mechanisms.</span></span></td>
</tr>
<tr class="even">
<td><span data-ttu-id="f46e6-260"><strong>OPM_STATUS_RENEGOTIATION_REQUIRED</strong></span><span class="sxs-lookup"><span data-stu-id="f46e6-260"><strong>OPM_STATUS_RENEGOTIATION_REQUIRED</strong></span></span></td>
<td><span data-ttu-id="f46e6-261">La aplicación debe restablecer la sesión OPM.</span><span class="sxs-lookup"><span data-stu-id="f46e6-261">The application must reestablish the OPM session.</span></span> <span data-ttu-id="f46e6-262">Responda de la siguiente manera:</span><span class="sxs-lookup"><span data-stu-id="f46e6-262">Respond as follows:</span></span>
<ol>
<li><span data-ttu-id="f46e6-263">Detenga la reproducción.</span><span class="sxs-lookup"><span data-stu-id="f46e6-263">Stop playback.</span></span></li>
<li><span data-ttu-id="f46e6-264">Desactive todos los mecanismos de protección.</span><span class="sxs-lookup"><span data-stu-id="f46e6-264">Turn off all protection mechanisms.</span></span></li>
<li><span data-ttu-id="f46e6-265">Libere la interfaz <a href="/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput"><strong>IOPMVideoOutput</strong></a> .</span><span class="sxs-lookup"><span data-stu-id="f46e6-265">Release the <a href="/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput"><strong>IOPMVideoOutput</strong></a> interface.</span></span></li>
<li><span data-ttu-id="f46e6-266">Vuelva a crear todas las superficies de vídeo.</span><span class="sxs-lookup"><span data-stu-id="f46e6-266">Recreate all video surfaces.</span></span></li>
<li><span data-ttu-id="f46e6-267">Cree un nuevo objeto OPM e intente restablecer la protección de contenido.</span><span class="sxs-lookup"><span data-stu-id="f46e6-267">Create a new OPM object and attempt to reestablish content protection.</span></span> <span data-ttu-id="f46e6-268">Si se produce un error, muestra un mensaje de error al usuario.</span><span class="sxs-lookup"><span data-stu-id="f46e6-268">If this fails, display an error message to the user.</span></span> <span data-ttu-id="f46e6-269">No reproduzca más contenido de vídeo.</span><span class="sxs-lookup"><span data-stu-id="f46e6-269">Do not play any more video content.</span></span></li>
</ol></td>
</tr>
<tr class="odd">
<td><span data-ttu-id="f46e6-270"><strong>OPM_STATUS_REVOKED_HDCP_DEVICE_ATTACHED</strong></span><span class="sxs-lookup"><span data-stu-id="f46e6-270"><strong>OPM_STATUS_REVOKED_HDCP_DEVICE_ATTACHED</strong></span></span></td>
<td><span data-ttu-id="f46e6-271">Esta marca solo se aplica cuando se usa HDCP e indica la presencia de un dispositivo HDCP revocado.</span><span class="sxs-lookup"><span data-stu-id="f46e6-271">This flag applies only when HDCP is used, and indicates the presence of a revoked HDCP device.</span></span> <span data-ttu-id="f46e6-272">Detenga la reproducción y desactive todos los mecanismos de protección de esta salida de vídeo.</span><span class="sxs-lookup"><span data-stu-id="f46e6-272">Stop playback and turn off all protection mechanisms on this video output.</span></span> <span data-ttu-id="f46e6-273">Cuando se establece esta marca, también se establece la marca de <strong>OPM_STATUS_LINK_LOST</strong> .</span><span class="sxs-lookup"><span data-stu-id="f46e6-273">When this flag is set, the <strong>OPM_STATUS_LINK_LOST</strong> flag is also set.</span></span></td>
</tr>
<tr class="even">
<td><span data-ttu-id="f46e6-274"><strong>OPM_STATUS_REVOKED_HDCP_DEVICE_ATTACHED</strong></span><span class="sxs-lookup"><span data-stu-id="f46e6-274"><strong>OPM_STATUS_REVOKED_HDCP_DEVICE_ATTACHED</strong></span></span></td>
<td><span data-ttu-id="f46e6-275">El controlador ha detectado alteraciones.</span><span class="sxs-lookup"><span data-stu-id="f46e6-275">The driver has detected tampering.</span></span> <span data-ttu-id="f46e6-276">Detenga la reproducción y no reproduzca más vídeo con esta salida de vídeo.</span><span class="sxs-lookup"><span data-stu-id="f46e6-276">Stop playback, and do not play any more video using this video output.</span></span> <span data-ttu-id="f46e6-277">También es una buena idea dejar de usar cualquier otra salida de vídeo, ya que el sistema podría estar en peligro.</span><span class="sxs-lookup"><span data-stu-id="f46e6-277">It is also a good idea to stop using any other video outputs, because the system might be compromised.</span></span></td>
</tr>
</tbody>
</table>



 

## <a name="using-hdcp-to-protect-content"></a><span data-ttu-id="f46e6-278">Usar HDCP para proteger el contenido</span><span class="sxs-lookup"><span data-stu-id="f46e6-278">Using HDCP to Protect Content</span></span>

<span data-ttu-id="f46e6-279">En esta sección se describe cómo habilitar la protección de salida de HDCP mediante OPM.</span><span class="sxs-lookup"><span data-stu-id="f46e6-279">This section describes how to enable HDCP output protection using OPM.</span></span> <span data-ttu-id="f46e6-280">A continuación se muestra una descripción general de los pasos que debe realizar la aplicación.</span><span class="sxs-lookup"><span data-stu-id="f46e6-280">Here is a general outline of the steps the application must take.</span></span> <span data-ttu-id="f46e6-281">Más adelante en esta sección se proporcionan detalles.</span><span class="sxs-lookup"><span data-stu-id="f46e6-281">Details are given later in this section.</span></span>

1.  <span data-ttu-id="f46e6-282">Es posible que la aplicación tenga que proporcionar un SRM a la salida de vídeo.</span><span class="sxs-lookup"><span data-stu-id="f46e6-282">The application might have to provide an SRM to the video output.</span></span> <span data-ttu-id="f46e6-283">El mecanismo para recibir SRMs está fuera del ámbito de la interfaz OPM.</span><span class="sxs-lookup"><span data-stu-id="f46e6-283">The mechanism for receiving SRMs is outside the scope of the OPM interface.</span></span> <span data-ttu-id="f46e6-284">Por ejemplo, SRMs se puede entregar como parte de un flujo de difusión.</span><span class="sxs-lookup"><span data-stu-id="f46e6-284">For example, SRMs might be delivered as part of a broadcast stream.</span></span>
2.  <span data-ttu-id="f46e6-285">La aplicación habilita la protección de salida de HDCP.</span><span class="sxs-lookup"><span data-stu-id="f46e6-285">The application enables HDCP output protection.</span></span>
3.  <span data-ttu-id="f46e6-286">La aplicación reproduce el contenido del vídeo.</span><span class="sxs-lookup"><span data-stu-id="f46e6-286">The application plays the video content.</span></span> <span data-ttu-id="f46e6-287">Periódicamente, la aplicación sondea el controlador para asegurarse de que la HDCP está activada.</span><span class="sxs-lookup"><span data-stu-id="f46e6-287">Periodically, the application polls the driver to make sure HDCP is on.</span></span>
4.  <span data-ttu-id="f46e6-288">Una vez completada la reproducción, la aplicación desactiva HDCP.</span><span class="sxs-lookup"><span data-stu-id="f46e6-288">When playback is complete, the application turns off HDCP.</span></span>

### <a name="setting-the-srm"></a><span data-ttu-id="f46e6-289">Establecimiento de la SRM</span><span class="sxs-lookup"><span data-stu-id="f46e6-289">Setting the SRM</span></span>

<span data-ttu-id="f46e6-290">Para establecer la SRM, realice los pasos siguientes.</span><span class="sxs-lookup"><span data-stu-id="f46e6-290">To set the SRM, perform the following steps.</span></span>

1.  <span data-ttu-id="f46e6-291">Inicialice una estructura de [**\_ \_ parámetros de \_ SRM \_ set HDCP de configuración**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_hdcp_srm_parameters) con el número de versión de SRM.</span><span class="sxs-lookup"><span data-stu-id="f46e6-291">Initialize an [**OPM\_SET\_HDCP\_SRM\_PARAMETERS**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_hdcp_srm_parameters) structure with the SRM version number.</span></span>
2.  <span data-ttu-id="f46e6-292">Almacene el SRM en una variable.</span><span class="sxs-lookup"><span data-stu-id="f46e6-292">Store the SRM in a variable.</span></span>
3.  <span data-ttu-id="f46e6-293">Envíe un comando [**OPM \_ set \_ HDCP \_ SRM**](opm-set-hdcp-srm.md) a la salida de vídeo.</span><span class="sxs-lookup"><span data-stu-id="f46e6-293">Send an [**OPM\_SET\_HDCP\_SRM**](opm-set-hdcp-srm.md) command to the video output.</span></span> <span data-ttu-id="f46e6-294">Siga el procedimiento descrito en [envío de comandos de OPM](#sending-opm-commands).</span><span class="sxs-lookup"><span data-stu-id="f46e6-294">Use the procedure described in [Sending OPM Commands](#sending-opm-commands).</span></span>
    -   <span data-ttu-id="f46e6-295">El miembro **abParameters** de la estructura de [**\_ \_ parámetros de configuración de OPM**](/windows/desktop/api/opmapi/ns-opmapi-opm_configure_parameters) contiene la estructura de [**\_ \_ \_ \_ parámetros**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_hdcp_srm_parameters) de la definición de la configuración de HDCP de HDCP.</span><span class="sxs-lookup"><span data-stu-id="f46e6-295">The **abParameters** member of the [**OPM\_CONFIGURE\_PARAMETERS**](/windows/desktop/api/opmapi/ns-opmapi-opm_configure_parameters) structure contains the [**OPM\_SET\_HDCP\_SRM\_PARAMETERS**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_hdcp_srm_parameters) structure.</span></span>
    -   <span data-ttu-id="f46e6-296">El parámetro *pbAdditionalParameters* del método [**IOPMVideoOutput:: configure**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-configure) apunta a la variable que contiene el SRM.</span><span class="sxs-lookup"><span data-stu-id="f46e6-296">The *pbAdditionalParameters* parameter of the [**IOPMVideoOutput::Configure**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-configure) method points to the variable that contains the SRM.</span></span>
4.  <span data-ttu-id="f46e6-297">Envíe una solicitud de estado de versión de la versión de HDCP de la [**\_ \_ \_ \_ \_ versión actual de HDCP**](opm-get-current-hdcp-srm-version.md) en la salida de vídeo.</span><span class="sxs-lookup"><span data-stu-id="f46e6-297">Send an [**OPM\_GET\_CURRENT\_HDCP\_SRM\_VERSION**](opm-get-current-hdcp-srm-version.md) status request to the video output.</span></span> <span data-ttu-id="f46e6-298">Siga el procedimiento descrito en [envío de solicitudes de estado de OPM](#sending-opm-status-requests).</span><span class="sxs-lookup"><span data-stu-id="f46e6-298">Use the procedure described in [Sending OPM Status Requests](#sending-opm-status-requests).</span></span> <span data-ttu-id="f46e6-299">Esta solicitud de estado no tiene datos de entrada, por lo que el contenido del miembro **abParameters** de la estructura de [**parámetros de obtención de \_ \_ información \_ de OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) es indefinido.</span><span class="sxs-lookup"><span data-stu-id="f46e6-299">This status request has no input data, so the contents of the **abParameters** member of the [**OPM\_GET\_INFO\_PARAMETERS**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) structure are undefined.</span></span>
5.  <span data-ttu-id="f46e6-300">Cuando el método [**IOPMVideoOutput:: GetInformation**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) devuelve, la matriz **abRequestedInformation** de la estructura de [**\_ \_ información solicitada de OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) contiene una estructura de [**\_ \_ información estándar de OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) .</span><span class="sxs-lookup"><span data-stu-id="f46e6-300">When the [**IOPMVideoOutput::GetInformation**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) method returns, the **abRequestedInformation** array in the [**OPM\_REQUESTED\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) structure contains an [**OPM\_STANDARD\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) structure.</span></span> <span data-ttu-id="f46e6-301">El miembro **ulInformation** de esta estructura contiene el número de versión del SRM actual.</span><span class="sxs-lookup"><span data-stu-id="f46e6-301">The **ulInformation** member of this structure contains the version number of the current SRM.</span></span> <span data-ttu-id="f46e6-302">Este valor debe ser igual al valor del paso 2.</span><span class="sxs-lookup"><span data-stu-id="f46e6-302">This value must equal the value from step 2.</span></span>

### <a name="enabling-hdcp"></a><span data-ttu-id="f46e6-303">Habilitar HDCP</span><span class="sxs-lookup"><span data-stu-id="f46e6-303">Enabling HDCP</span></span>

<span data-ttu-id="f46e6-304">Para habilitar HDCP, realice los pasos siguientes.</span><span class="sxs-lookup"><span data-stu-id="f46e6-304">To enable HDCP, perform the following steps.</span></span>

1.  <span data-ttu-id="f46e6-305">Inicialice una estructura de [**\_ parámetros de \_ \_ nivel \_ de protección set de OPM**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_protection_level_parameters) con los siguientes valores:</span><span class="sxs-lookup"><span data-stu-id="f46e6-305">Initialize an [**OPM\_SET\_PROTECTION\_LEVEL\_PARAMETERS**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_protection_level_parameters) structure with the following values:</span></span>
    -   <span data-ttu-id="f46e6-306">**ulProtectionType**  =  **OPM \_ tipo de protección \_ \_ HDCP**</span><span class="sxs-lookup"><span data-stu-id="f46e6-306">**ulProtectionType** = **OPM\_PROTECTION\_TYPE\_HDCP**</span></span>
    -   <span data-ttu-id="f46e6-307">**ulProtectionLevel**  =  **OPM \_ HDCP \_ activado**</span><span class="sxs-lookup"><span data-stu-id="f46e6-307">**ulProtectionLevel** = **OPM\_HDCP\_ON**</span></span>
    -   <span data-ttu-id="f46e6-308">**Reservado** = 0</span><span class="sxs-lookup"><span data-stu-id="f46e6-308">**Reserved** = 0</span></span>
    -   <span data-ttu-id="f46e6-309">**Reserved2** = 0</span><span class="sxs-lookup"><span data-stu-id="f46e6-309">**Reserved2** = 0</span></span>
2.  <span data-ttu-id="f46e6-310">Envíe un comando de [**nivel de protección de conjunto de OPM \_ \_ \_**](opm-set-protection-level.md) .</span><span class="sxs-lookup"><span data-stu-id="f46e6-310">Send an [**OPM\_SET\_PROTECTION\_LEVEL**](opm-set-protection-level.md) command.</span></span> <span data-ttu-id="f46e6-311">Los datos de entrada de la matriz **abParameters** son la estructura de [**parámetros de \_ \_ \_ nivel \_ de protección de OPM**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_protection_level_parameters) .</span><span class="sxs-lookup"><span data-stu-id="f46e6-311">The input data in the **abParameters** array is the [**OPM\_SET\_PROTECTION\_LEVEL\_PARAMETERS**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_protection_level_parameters) structure.</span></span>
3.  <span data-ttu-id="f46e6-312">Envíe una solicitud de estado de [**\_ \_ \_ \_ nivel de protección virtual de OPM**](opm-get-virtual-protection-level.md) para comprobar si se ha habilitado HDCP.</span><span class="sxs-lookup"><span data-stu-id="f46e6-312">Send an [**OPM\_GET\_VIRTUAL\_PROTECTION\_LEVEL**](opm-get-virtual-protection-level.md) status request to check whether HDCP is enabled.</span></span> <span data-ttu-id="f46e6-313">Los primeros 4 bytes del miembro **abParameters** de la estructura [**de \_ \_ \_ parámetros de obtención de información de OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) contienen el valor de tipo de **\_ protección OPM \_ \_ HDCP**.</span><span class="sxs-lookup"><span data-stu-id="f46e6-313">The first 4 bytes of the **abParameters** member of the [**OPM\_GET\_INFO\_PARAMETERS**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) structure contain the value **OPM\_PROTECTION\_TYPE\_HDCP**.</span></span>

<span data-ttu-id="f46e6-314">Cuando el método [**GetInformation**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) devuelve, la matriz **abRequestedInformation** de la estructura de [**\_ \_ información solicitada de OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) contiene una estructura de [**\_ \_ información estándar de OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) .</span><span class="sxs-lookup"><span data-stu-id="f46e6-314">When the [**GetInformation**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) method returns, the **abRequestedInformation** array in the [**OPM\_REQUESTED\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) structure contains an [**OPM\_STANDARD\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) structure.</span></span> <span data-ttu-id="f46e6-315">El miembro **ulInformation** de esta estructura contiene un valor de la enumeración de [**\_ \_ \_ nivel de protección OPM HDCP**](/windows/desktop/api/opmapi/ne-opmapi-opm_hdcp_protection_level) .</span><span class="sxs-lookup"><span data-stu-id="f46e6-315">The **ulInformation** member of this structure contains a value from the [**OPM\_HDCP\_PROTECTION\_LEVEL**](/windows/desktop/api/opmapi/ne-opmapi-opm_hdcp_protection_level) enumeration.</span></span> <span data-ttu-id="f46e6-316">Si el valor es igual **\_ a la HDCP \_ de OPM activada**, significa que se habilita HDCP.</span><span class="sxs-lookup"><span data-stu-id="f46e6-316">If the value equals **OPM\_HDCP\_ON**, it means HDCP is enabled.</span></span> <span data-ttu-id="f46e6-317">De lo contrario, repita los pasos 1 a 2 hasta que se habilite HDCP o se produzca un error.</span><span class="sxs-lookup"><span data-stu-id="f46e6-317">Otherwise, repeat steps 1–2 until HDCP is enabled, or an error occurs.</span></span> <span data-ttu-id="f46e6-318">(Recuerde incrementar el número de secuencia y generar un nuevo número aleatorio cada vez).</span><span class="sxs-lookup"><span data-stu-id="f46e6-318">(Remember to increment the sequence number and generate a new random number each time.)</span></span>

<span data-ttu-id="f46e6-319">Normalmente, se tarda entre 100 y 200 milisegundos en habilitar HDCP, pero puede tardar más tiempo.</span><span class="sxs-lookup"><span data-stu-id="f46e6-319">It usually takes between 100 and 200 milliseconds to enable HDCP, but it can take longer.</span></span> <span data-ttu-id="f46e6-320">No suponga que se ha habilitado HDCP hasta que lo haya comprobado.</span><span class="sxs-lookup"><span data-stu-id="f46e6-320">Do not assume that HDCP is enabled until you have verified it.</span></span>

<span data-ttu-id="f46e6-321">Cuando la aplicación termine de reproducir contenido protegido, desactive HDCP.</span><span class="sxs-lookup"><span data-stu-id="f46e6-321">When the application finishes playing protected content, turn off HDCP.</span></span> <span data-ttu-id="f46e6-322">Los pasos son los mismos que para habilitar HDCP, pero en el paso 1, establezca **ulProtectionLevel** en la **HDCP de OPM en \_ \_ OFF**.</span><span class="sxs-lookup"><span data-stu-id="f46e6-322">The steps are the same as for enabling HDCP, but in step 1, set **ulProtectionLevel** to **OPM\_HDCP\_OFF**.</span></span>

> [!Note]  
> <span data-ttu-id="f46e6-323">No habilite HDCP si el tipo de conector es el **tipo de conector de OPM \_ \_ \_ \_ incrustado**.</span><span class="sxs-lookup"><span data-stu-id="f46e6-323">Do not enable HDCP if the connector type is **OPM\_CONNECTOR\_TYPE\_DISPLAYPORT\_EMBEDDED**.</span></span> <span data-ttu-id="f46e6-324">(Consulte las [**marcas de tipo de conector de OPM**](opm-connector-type-flags.md)).</span><span class="sxs-lookup"><span data-stu-id="f46e6-324">(See [**OPM Connector Type Flags**](opm-connector-type-flags.md).)</span></span>

 

## <a name="related-topics"></a><span data-ttu-id="f46e6-325">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="f46e6-325">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="f46e6-326">Administrador de protección de salida</span><span class="sxs-lookup"><span data-stu-id="f46e6-326">Output Protection Manager</span></span>](output-protection-manager.md)
</dt> </dl>

 

 



