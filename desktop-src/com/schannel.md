---
title: Schannel
description: El paquete de seguridad de canal seguro (Schannel), cuyo identificador de servicio de autenticación es RPC \_ C \_ authn \_ GSS \_ Schannel, admite los siguientes protocolos basados en clave pública SSL (capa de sockets seguros) versiones 2,0 y 3,0, seguridad de la capa de transporte (TLS) 1,0 y tecnología de comunicaciones privadas (PCT) 1,0. TLS 1,0 es una versión estándar, ligeramente modificada, de SSL 3,0 emitida por Internet Engineering Task Force (IETF) en enero de 1999, en el documento RFC 2246. Dado que TLS está normalizado, se recomienda a los desarrolladores que utilicen TLS en lugar de SSL. PCT se incluye solo por motivos de compatibilidad con versiones anteriores y no debe usarse para el desarrollo nuevo. Cuando se utiliza el paquete de seguridad Schannel, DCOM negocia automáticamente el mejor protocolo, en función de las capacidades del cliente y del servidor.
ms.assetid: 03a5f987-f668-4f19-9b58-d62711f58734
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: eccc9f82a05d1542e7585426128f10cdf452d31d
ms.sourcegitcommit: 5f33645661bf8c825a7a2e73950b1f4ea0f1cd82
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/21/2020
ms.locfileid: "104359452"
---
# <a name="schannel"></a><span data-ttu-id="526e6-107">Schannel</span><span class="sxs-lookup"><span data-stu-id="526e6-107">Schannel</span></span>

<span data-ttu-id="526e6-108">El paquete de seguridad de canal seguro (Schannel), cuyo identificador de servicio de autenticación es RPC \_ C \_ authn \_ GSS \_ Schannel, admite los siguientes protocolos basados en claves públicas: SSL (capa de sockets seguros) versiones 2,0 y 3,0, seguridad de la capa de transporte (TLS) 1,0 y tecnología de comunicaciones privadas (PCT) 1,0.</span><span class="sxs-lookup"><span data-stu-id="526e6-108">The Secure Channel (Schannel) security package, whose authentication service identifier is RPC\_C\_AUTHN\_GSS\_SCHANNEL, supports the following public-key based protocols: SSL (Secure Sockets Layer) versions 2.0 and 3.0, Transport Layer Security (TLS) 1.0, and Private Communication Technology (PCT) 1.0.</span></span> <span data-ttu-id="526e6-109">TLS 1,0 es una versión estándar, ligeramente modificada, de SSL 3,0 emitida por Internet Engineering Task Force (IETF) en enero de 1999, en el documento [RFC 2246](https://www.ietf.org/rfc/rfc2246.txt).</span><span class="sxs-lookup"><span data-stu-id="526e6-109">TLS 1.0 is a standardized, slightly modified version of SSL 3.0 that was issued by the Internet Engineering Task Force (IETF) in January 1999, in document [RFC 2246](https://www.ietf.org/rfc/rfc2246.txt).</span></span> <span data-ttu-id="526e6-110">Dado que TLS está normalizado, se recomienda a los desarrolladores que utilicen TLS en lugar de SSL.</span><span class="sxs-lookup"><span data-stu-id="526e6-110">Because TLS has been standardized, developers are encouraged to use TLS rather than SSL.</span></span> <span data-ttu-id="526e6-111">PCT se incluye solo por motivos de compatibilidad con versiones anteriores y no debe usarse para el desarrollo nuevo.</span><span class="sxs-lookup"><span data-stu-id="526e6-111">PCT is included for backward compatibility only and should not be used for new development.</span></span> <span data-ttu-id="526e6-112">Cuando se utiliza el paquete de seguridad Schannel, DCOM negocia automáticamente el mejor protocolo, en función de las capacidades del cliente y del servidor.</span><span class="sxs-lookup"><span data-stu-id="526e6-112">When the Schannel security package is used, DCOM automatically negotiates the best protocol, depending on the client and server capabilities.</span></span>

<span data-ttu-id="526e6-113">En los siguientes temas se describe brevemente el protocolo TLS y cómo funciona con DCOM.</span><span class="sxs-lookup"><span data-stu-id="526e6-113">The following topics briefly describe the TLS protocol and how it works with DCOM.</span></span>

-   [<span data-ttu-id="526e6-114">Cuándo usar TLS</span><span class="sxs-lookup"><span data-stu-id="526e6-114">When to Use TLS</span></span>](#when-to-use-tls)
-   [<span data-ttu-id="526e6-115">Breve descripción de cómo funciona TLS</span><span class="sxs-lookup"><span data-stu-id="526e6-115">Brief Overview of How TLS Works</span></span>](#brief-overview-of-how-tls-works)
-   [<span data-ttu-id="526e6-116">Certificados X. 509</span><span class="sxs-lookup"><span data-stu-id="526e6-116">X.509 Certificates</span></span>](#x509-certificates)
    -   [<span data-ttu-id="526e6-117">Certificados de cliente</span><span class="sxs-lookup"><span data-stu-id="526e6-117">Client Certificates</span></span>](#client-certificates)
-   [<span data-ttu-id="526e6-118">Usar TLS en COM</span><span class="sxs-lookup"><span data-stu-id="526e6-118">Using TLS in COM</span></span>](#using-tls-in-com)
    -   [<span data-ttu-id="526e6-119">Cómo establece un servidor el marco de seguridad</span><span class="sxs-lookup"><span data-stu-id="526e6-119">How a Server Sets the Security Blanket</span></span>](#how-a-server-sets-the-security-blanket)
    -   [<span data-ttu-id="526e6-120">Cómo establece un cliente el marco de seguridad</span><span class="sxs-lookup"><span data-stu-id="526e6-120">How a Client Sets the Security Blanket</span></span>](#how-a-client-sets-the-security-blanket)
    -   [<span data-ttu-id="526e6-121">Cómo cambia un cliente el marco de seguridad</span><span class="sxs-lookup"><span data-stu-id="526e6-121">How a Client Changes the Security Blanket</span></span>](#how-a-client-changes-the-security-blanket)
    -   [<span data-ttu-id="526e6-122">Ejemplo: el cliente cambia el marco de seguridad</span><span class="sxs-lookup"><span data-stu-id="526e6-122">Example: Client Changes the Security Blanket</span></span>](#example-client-changes-the-security-blanket)
-   [<span data-ttu-id="526e6-123">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="526e6-123">Related topics</span></span>](#related-topics)

> [!Note]  
> <span data-ttu-id="526e6-124">Toda la información sobre el protocolo TLS en estas secciones también se aplica a los protocolos SSL y PCT.</span><span class="sxs-lookup"><span data-stu-id="526e6-124">All the information about the TLS protocol in these sections also applies to the SSL and PCT protocols.</span></span>

 

## <a name="when-to-use-tls"></a><span data-ttu-id="526e6-125">Cuándo usar TLS</span><span class="sxs-lookup"><span data-stu-id="526e6-125">When to Use TLS</span></span>

<span data-ttu-id="526e6-126">TLS es la única opción de seguridad disponible cuando los servidores necesitan demostrar su identidad a los clientes anónimos.</span><span class="sxs-lookup"><span data-stu-id="526e6-126">TLS is the only security option available when servers need to prove their identity to anonymous clients.</span></span> <span data-ttu-id="526e6-127">Esto es especialmente importante para los sitios web que desean participar en el comercio electrónico porque ayuda a proteger la transmisión de información confidencial, como números de tarjeta de crédito.</span><span class="sxs-lookup"><span data-stu-id="526e6-127">This is particularly important for websites that want to participate in e-commerce because it helps protect the transmission of sensitive information such as credit card numbers.</span></span> <span data-ttu-id="526e6-128">TLS garantiza que los clientes de comercio electrónico pueden estar seguros de quiénes están haciendo negocios, ya que se les proporciona una prueba de la identidad del servidor.</span><span class="sxs-lookup"><span data-stu-id="526e6-128">TLS assures that the e-commerce customers can be certain of whom they are doing business with because they are given proof of the server's identity.</span></span> <span data-ttu-id="526e6-129">También proporciona al servidor de comercio electrónico la eficiencia de no tener que preocuparse por la autenticación de la identidad de cada uno de sus clientes.</span><span class="sxs-lookup"><span data-stu-id="526e6-129">It also gives the e-commerce server the efficiency of not having to concern itself with authenticating the identity of each of its customers.</span></span>

<span data-ttu-id="526e6-130">TLS requiere que todos los servidores demuestren su identidad a los clientes.</span><span class="sxs-lookup"><span data-stu-id="526e6-130">TLS requires that all servers prove their identity to clients.</span></span> <span data-ttu-id="526e6-131">Además, TLS ofrece la opción de hacer que los clientes demuestren su identidad a los servidores.</span><span class="sxs-lookup"><span data-stu-id="526e6-131">Additionally, TLS provides the option of having clients prove their identity to servers.</span></span> <span data-ttu-id="526e6-132">Esta autenticación mutua puede ser útil a la vez que se restringe el acceso de ciertas páginas web en una intranet corporativa de gran tamaño.</span><span class="sxs-lookup"><span data-stu-id="526e6-132">This mutual authentication can be useful in restricting the access of certain webpages in a large corporate intranet.</span></span>

<span data-ttu-id="526e6-133">TLS es compatible con los niveles de autenticación más seguros y ofrece una arquitectura abierta que permite que el nivel de cifrado aumente con el tiempo para mantenerse al día con la innovación tecnológica.</span><span class="sxs-lookup"><span data-stu-id="526e6-133">TLS supports the strongest authentication levels and offers an open architecture that permits encryption strength to increase over time to keep up with technological innovation.</span></span> <span data-ttu-id="526e6-134">TLS es la mejor opción para entornos en los que se desea el nivel más alto de seguridad para los datos en tránsito.</span><span class="sxs-lookup"><span data-stu-id="526e6-134">TLS is the best choice for environments where the highest level of security is desired for the data in transit.</span></span>

## <a name="brief-overview-of-how-tls-works"></a><span data-ttu-id="526e6-135">Breve descripción de cómo funciona TLS</span><span class="sxs-lookup"><span data-stu-id="526e6-135">Brief Overview of How TLS Works</span></span>

<span data-ttu-id="526e6-136">TLS se basa en una infraestructura de clave pública (PKI), que usa pares de claves pública y privada para habilitar el cifrado de datos y para establecer la integridad de los datos, y usa certificados X. 509 para la autenticación.</span><span class="sxs-lookup"><span data-stu-id="526e6-136">TLS is built upon a public key infrastructure (PKI), which uses public/private key pairs for enabling data encryption and establishing data integrity, and uses X.509 certificates for authentication.</span></span>

<span data-ttu-id="526e6-137">Muchos protocolos de seguridad, como el protocolo Kerberos V5, dependen de una única clave para cifrar y descifrar los datos.</span><span class="sxs-lookup"><span data-stu-id="526e6-137">Many security protocols, such as the Kerberos v5 protocol, depend on a single key to both encrypt and decrypt data.</span></span> <span data-ttu-id="526e6-138">Por tanto, estos protocolos dependen del intercambio seguro de claves de cifrado. en el protocolo Kerberos, esto se hace a través de los vales obtenidos del Centro de distribución de claves (KDC).</span><span class="sxs-lookup"><span data-stu-id="526e6-138">Such protocols therefore depend on the secure exchange of encryption keys; in the Kerberos protocol, this is done through tickets obtained from the Key Distribution Center (KDC).</span></span> <span data-ttu-id="526e6-139">Esto requiere que todos los usuarios que usen el protocolo Kerberos se registren con el KDC, lo que sería una limitación inviable para un servidor Web de comercio electrónico destinado a atraer a millones de clientes de todo el mundo.</span><span class="sxs-lookup"><span data-stu-id="526e6-139">This requires that everyone using the Kerberos protocol be registered with the KDC, which would be an impractical limitation for an e-commerce web server that is intended to attract millions of customers from around the world.</span></span> <span data-ttu-id="526e6-140">Por consiguiente, TLS se basa en una PKI, que usa dos claves para Data encryptionâ € "cuando una clave del par cifra los datos, solo la otra clave del par puede descifrarlos.</span><span class="sxs-lookup"><span data-stu-id="526e6-140">TLS therefore relies upon a PKI, which uses two keys for data encryptionâ€”when one key of the pair encrypts the data, only the other key of the pair can decrypt it.</span></span> <span data-ttu-id="526e6-141">La ventaja principal de este diseño es que el cifrado se puede realizar sin necesidad de un intercambio seguro de claves de cifrado.</span><span class="sxs-lookup"><span data-stu-id="526e6-141">The principle benefit of this design is that encryption can be performed without requiring the secure exchange of encryption keys.</span></span>

<span data-ttu-id="526e6-142">Una PKI usa una técnica en la que una de las claves se mantiene privada y solo está disponible para la entidad de seguridad en la que se registra, mientras que la otra clave se hace pública para que cualquiera tenga acceso.</span><span class="sxs-lookup"><span data-stu-id="526e6-142">A PKI uses a technique where one of the keys is kept private and is available only to the principal to whom it is registered, while the other key is made public for anyone to access.</span></span> <span data-ttu-id="526e6-143">Si alguien desea enviar un mensaje privado al propietario de un par de claves, el mensaje se puede cifrar con la clave pública y solo se puede usar la clave privada para descifrar el mensaje.</span><span class="sxs-lookup"><span data-stu-id="526e6-143">If someone wants to send a private message to the owner of a key pair, the message can be encrypted with the public key and only the private key can be used to decrypt the message.</span></span>

<span data-ttu-id="526e6-144">Los pares de claves también se usan para comprobar la integridad de los datos que se envían.</span><span class="sxs-lookup"><span data-stu-id="526e6-144">Key pairs are also used to verify the integrity of the data being sent.</span></span> <span data-ttu-id="526e6-145">Para ello, el propietario del par de claves puede adjuntar una firma digital a los datos antes de enviarla.</span><span class="sxs-lookup"><span data-stu-id="526e6-145">To do this, the owner of the key pair can attach a digital signature to the data before sending it.</span></span> <span data-ttu-id="526e6-146">La creación de una firma digital implica el cálculo de un hash de los datos y el cifrado del hash con la clave privada.</span><span class="sxs-lookup"><span data-stu-id="526e6-146">Creating a digital signature involves calculating a hash of the data and encrypting the hash with the private key.</span></span> <span data-ttu-id="526e6-147">Cualquier persona que use la clave pública para descifrar la firma digital está seguro de que la firma digital debe haber sido procedente únicamente de la persona que posee la clave privada.</span><span class="sxs-lookup"><span data-stu-id="526e6-147">Anyone who uses the public key to decrypt the digital signature is assured that the digital signature must have come only from the person who owns the private key.</span></span> <span data-ttu-id="526e6-148">Además, el destinatario puede calcular un hash de los datos utilizando el mismo algoritmo que el remitente y, si el hash calculado coincide con el que se envió en la firma digital, el destinatario puede estar seguro de que los datos no se modificaron una vez firmados digitalmente.</span><span class="sxs-lookup"><span data-stu-id="526e6-148">Additionally, the recipient can calculate a hash of the data using the same algorithm as the sender, and if the calculated hash matches the one sent in the digital signature, the recipient can be certain that the data was not modified after it was digitally signed.</span></span>

<span data-ttu-id="526e6-149">Una desventaja del uso de una PKI para el cifrado de datos de gran volumen es su rendimiento relativamente lento.</span><span class="sxs-lookup"><span data-stu-id="526e6-149">One disadvantage of using a PKI for high-volume data encryption is its relatively slow performance.</span></span> <span data-ttu-id="526e6-150">Debido a las matemáticas intensivas implicadas, el cifrado y descifrado de los datos mediante un cifrado asimétrico que depende de un par de claves puede ser hasta 1.000 veces más lento que el cifrado y el descifrado mediante un cifrado simétrico que solo depende de una clave única.</span><span class="sxs-lookup"><span data-stu-id="526e6-150">Because of the intensive mathematics involved, encryption and decryption of data using an asymmetric cipher that depends on a key pair can be up to 1,000 times slower than encryption and decryption using a symmetric cipher that depends only on a single key.</span></span> <span data-ttu-id="526e6-151">Por lo tanto, TLS utiliza una PKI solo para generar firmas digitales y para negociar la clave única específica de la sesión que el cliente y el servidor usarán para el cifrado y descifrado de datos de forma masiva.</span><span class="sxs-lookup"><span data-stu-id="526e6-151">TLS therefore uses a PKI only for generating digital signatures and for negotiating the session-specific single key that will be used by both the client and the server for bulk data encryption and decryption.</span></span> <span data-ttu-id="526e6-152">TLS admite una amplia variedad de cifrados simétricos de una sola clave y se pueden agregar cifrados adicionales en el futuro.</span><span class="sxs-lookup"><span data-stu-id="526e6-152">TLS supports a wide variety of single-key symmetric ciphers, and additional ciphers may be added in the future.</span></span>

<span data-ttu-id="526e6-153">Para obtener más información acerca del Protocolo de enlace TLS, consulte [Protocolo de enlace TLS](/windows/desktop/SecAuthN/tls-handshake-protocol).</span><span class="sxs-lookup"><span data-stu-id="526e6-153">For more information about the TLS handshake protocol, see [TLS Handshake Protocol](/windows/desktop/SecAuthN/tls-handshake-protocol).</span></span>

<span data-ttu-id="526e6-154">Para obtener más información sobre la criptografía detrás del protocolo TLS, consulte [Criptografía Essentials](/windows/desktop/SecCrypto/cryptography-essentials).</span><span class="sxs-lookup"><span data-stu-id="526e6-154">For more details regarding the cryptography behind the TLS protocol, see [Cryptography Essentials](/windows/desktop/SecCrypto/cryptography-essentials).</span></span>

## <a name="x509-certificates"></a><span data-ttu-id="526e6-155">Certificados X.509</span><span class="sxs-lookup"><span data-stu-id="526e6-155">X.509 Certificates</span></span>

<span data-ttu-id="526e6-156">Un problema crítico que debe administrar una PKI es la capacidad de confiar en la autenticidad de la clave pública que se está usando.</span><span class="sxs-lookup"><span data-stu-id="526e6-156">A critical issue that must be handled by a PKI is the ability to trust the authenticity of the public key that is being used.</span></span> <span data-ttu-id="526e6-157">Si usa una clave pública emitida para una empresa con la que desea hacer negocios, querrá asegurarse de que la clave pertenece realmente a la empresa en lugar de a un ladrón que desee detectar el número de su tarjeta de crédito.</span><span class="sxs-lookup"><span data-stu-id="526e6-157">When you use a public key issued to a company that you want to do business with, you want to be certain that the key actually belongs to the company rather than to a thief who wants to discover your credit card number.</span></span>

<span data-ttu-id="526e6-158">Para garantizar la identidad de una entidad de seguridad que contiene un par de claves, una entidad de certificación (CA) emite un certificado X. 509 a la entidad de seguridad.</span><span class="sxs-lookup"><span data-stu-id="526e6-158">To guarantee the identity of a principal holding a key pair, the principal is issued an X.509 certificate by a certification authority (CA).</span></span> <span data-ttu-id="526e6-159">Este certificado contiene información que identifica la entidad de seguridad, contiene la clave pública de la entidad de seguridad y está firmada digitalmente por la CA.</span><span class="sxs-lookup"><span data-stu-id="526e6-159">This certificate contains information that identifies the principal, contains the principal's public key, and is digitally signed by the CA.</span></span> <span data-ttu-id="526e6-160">Esta firma digital indica que la entidad de certificación considera que la clave pública incluida en el certificado realmente pertenece a la entidad de seguridad identificada por el certificado.</span><span class="sxs-lookup"><span data-stu-id="526e6-160">This digital signature indicates that the CA believes that the public key contained in the certificate truly belongs to the principal identified by the certificate.</span></span>

<span data-ttu-id="526e6-161">¿Y cómo confía en la entidad de certificación?</span><span class="sxs-lookup"><span data-stu-id="526e6-161">And how do you trust the CA?</span></span> <span data-ttu-id="526e6-162">Dado que la propia CA contiene un certificado X. 509 firmado por una CA de nivel superior.</span><span class="sxs-lookup"><span data-stu-id="526e6-162">Because the CA itself holds an X.509 certificate that has been signed by a higher-level CA.</span></span> <span data-ttu-id="526e6-163">Esta cadena de firmas de certificado continúa hasta que llega a una CA raíz, que es una CA que firma sus propios certificados.</span><span class="sxs-lookup"><span data-stu-id="526e6-163">This chain of certificate signatures continues until it reaches a root CA, which is a CA that signs its own certificates.</span></span> <span data-ttu-id="526e6-164">Si confía en la integridad de la CA raíz de un certificado, debería poder confiar en la autenticidad del propio certificado.</span><span class="sxs-lookup"><span data-stu-id="526e6-164">If you trust the integrity of the root CA of a certificate, you should be able to trust the authenticity of the certificate itself.</span></span> <span data-ttu-id="526e6-165">Por lo tanto, la selección de las CA raíz en las que está dispuesto a confiar es un derecho importante para un administrador del sistema.</span><span class="sxs-lookup"><span data-stu-id="526e6-165">Therefore, picking root CAs that you are willing to trust is an important duty for a system administrator.</span></span>

### <a name="client-certificates"></a><span data-ttu-id="526e6-166">Certificados de cliente</span><span class="sxs-lookup"><span data-stu-id="526e6-166">Client Certificates</span></span>

<span data-ttu-id="526e6-167">Cuando surgieron los protocolos de nivel de transporte de seguridad por primera vez, su objetivo principal era garantizar que un cliente se conectaba a un servidor auténtico y ayuda a proteger la privacidad de los datos durante el tránsito.</span><span class="sxs-lookup"><span data-stu-id="526e6-167">When security transport-layer protocols first emerged, their primary purpose was to guarantee that a client was connecting to an authentic server and help protect the privacy of data while in transit.</span></span> <span data-ttu-id="526e6-168">Sin embargo, SSL 3,0 y TLS 1,0 también incluyen compatibilidad con la transmisión de un certificado de cliente durante el protocolo de enlace del protocolo.</span><span class="sxs-lookup"><span data-stu-id="526e6-168">However, SSL 3.0 and TLS 1.0 also include support for the transmission of a client's certificate during the protocol's handshake.</span></span> <span data-ttu-id="526e6-169">Esta característica opcional habilita la autenticación mutua del cliente y el servidor.</span><span class="sxs-lookup"><span data-stu-id="526e6-169">This optional feature enables the mutual authentication of the client and server.</span></span>

<span data-ttu-id="526e6-170">La decisión de si usar un certificado de cliente debe realizarse en el contexto de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="526e6-170">The decision of whether to use a client certificate should be made in the context of the application.</span></span> <span data-ttu-id="526e6-171">Los certificados de cliente no son necesarios si el requisito principal es la autenticación del servidor.</span><span class="sxs-lookup"><span data-stu-id="526e6-171">Client certificates are unnecessary if the primary requirement is authenticating the server.</span></span> <span data-ttu-id="526e6-172">Sin embargo, si la autenticación de cliente es esencial, se puede usar un certificado de cliente en lugar de confiar en la autenticación personalizada dentro de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="526e6-172">However, if client authentication is essential, a client's certificate can be used rather than relying on custom authentication within the application.</span></span> <span data-ttu-id="526e6-173">El uso de certificados de cliente es preferible a través de la autenticación personalizada, ya que proporciona a los usuarios un escenario de inicio de sesión único.</span><span class="sxs-lookup"><span data-stu-id="526e6-173">Using client certificates is preferable over custom authentication because it gives users a single sign-on scenario.</span></span>

## <a name="using-tls-in-com"></a><span data-ttu-id="526e6-174">Usar TLS en COM</span><span class="sxs-lookup"><span data-stu-id="526e6-174">Using TLS in COM</span></span>

<span data-ttu-id="526e6-175">TLS solo es compatible con el nivel de suplantación ( \_ \_ \_ \_ suplantación de nivel Imp de RPC C) de suplantación.</span><span class="sxs-lookup"><span data-stu-id="526e6-175">TLS supports only the impersonate (RPC\_C\_IMP\_LEVEL\_IMPERSONATE) level of impersonation.</span></span> <span data-ttu-id="526e6-176">Si COM negocia TLS como servicio de autenticación en un proxy, COM establecerá el nivel de suplantación en Impersonate independientemente del valor predeterminado del proceso.</span><span class="sxs-lookup"><span data-stu-id="526e6-176">If COM negotiates TLS as the authentication service on a proxy, COM will set the impersonation level to impersonate regardless of the process default.</span></span> <span data-ttu-id="526e6-177">Para que la suplantación funcione correctamente en TLS, el cliente debe proporcionar un certificado X. 509 al servidor y el servidor debe tener ese certificado asignado a una cuenta de usuario determinada en el servidor.</span><span class="sxs-lookup"><span data-stu-id="526e6-177">For impersonation to work properly in TLS, the client must provide an X.509 certificate to the server and the server must have that certificate mapped to a particular user account on the server.</span></span> <span data-ttu-id="526e6-178">Para obtener más información, consulte la [Guía paso a paso para asignar certificados a cuentas de usuario](https://www.microsoft.com/isapi/redir.dll?prd=windows2000&sbp=technicallibrary&ar=security&sba=mappingcertificates).</span><span class="sxs-lookup"><span data-stu-id="526e6-178">For more information, see the [Step-by-Step Guide to Mapping Certificates to User Accounts](https://www.microsoft.com/isapi/redir.dll?prd=windows2000&sbp=technicallibrary&ar=security&sba=mappingcertificates).</span></span>

<span data-ttu-id="526e6-179">TLS no admite la [ocultación](cloaking.md).</span><span class="sxs-lookup"><span data-stu-id="526e6-179">TLS does not support [cloaking](cloaking.md).</span></span> <span data-ttu-id="526e6-180">Si se especifica una marca de ocultación y TLS en una llamada a [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) o [**IClientSecurity:: SetBlanket**](/windows/win32/api/objidl/nf-objidl-iclientsecurity-setblanket) , se \_ devolverá E INVALIDARG.</span><span class="sxs-lookup"><span data-stu-id="526e6-180">If a cloaking flag and TLS are specified in a [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) or a [**IClientSecurity::SetBlanket**](/windows/win32/api/objidl/nf-objidl-iclientsecurity-setblanket) call, E\_INVALIDARG will be returned.</span></span>

<span data-ttu-id="526e6-181">TLS no funciona con el nivel de autenticación establecido en ninguno.</span><span class="sxs-lookup"><span data-stu-id="526e6-181">TLS does not work with the authentication level set to None.</span></span> <span data-ttu-id="526e6-182">El protocolo de enlace entre el cliente y el servidor examina el nivel de autenticación establecido por cada y elige la configuración de seguridad más alta para la conexión.</span><span class="sxs-lookup"><span data-stu-id="526e6-182">The handshake between the client and server examines the authentication level set by each and chooses the higher security setting for the connection.</span></span>

<span data-ttu-id="526e6-183">Los parámetros de seguridad de TLS se pueden establecer llamando a [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) y [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket).</span><span class="sxs-lookup"><span data-stu-id="526e6-183">The security parameters for TLS can be set by calling [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) and [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket).</span></span> <span data-ttu-id="526e6-184">En las secciones siguientes se describen los matices implicados en la realización de esas llamadas.</span><span class="sxs-lookup"><span data-stu-id="526e6-184">The following sections describe the nuances involved in making those calls.</span></span>

### <a name="how-a-server-sets-the-security-blanket"></a><span data-ttu-id="526e6-185">Cómo establece un servidor el marco de seguridad</span><span class="sxs-lookup"><span data-stu-id="526e6-185">How a Server Sets the Security Blanket</span></span>

<span data-ttu-id="526e6-186">Si un servidor desea utilizar TLS, debe especificar Schannel (RPC \_ C \_ authn \_ GSS \_ Schannel) como servicio de autenticación en el parámetro *asAuthSvc* de [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity).</span><span class="sxs-lookup"><span data-stu-id="526e6-186">If a server wants to use TLS, it must specify Schannel (RPC\_C\_AUTHN\_GSS\_SCHANNEL) as an authentication service in the *asAuthSvc* parameter of [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity).</span></span> <span data-ttu-id="526e6-187">Para evitar que los clientes se conecten al servidor mediante un servicio de autenticación menos seguro, el servidor solo debe especificar Schannel como servicio de autenticación cuando llama a **CoInitializeSecurity**.</span><span class="sxs-lookup"><span data-stu-id="526e6-187">To prevent clients from connecting to the server by using a less secure authentication service, the server should specify only Schannel as an authentication service when it calls **CoInitializeSecurity**.</span></span> <span data-ttu-id="526e6-188">El servidor no puede cambiar el marco de seguridad después de que se haya llamado **CoInitializeSecurity**.</span><span class="sxs-lookup"><span data-stu-id="526e6-188">The server cannot change the security blanket after it has called **CoInitializeSecurity**.</span></span>

<span data-ttu-id="526e6-189">Para usar TLS, deben especificarse los siguientes parámetros cuando un servidor llama a [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity):</span><span class="sxs-lookup"><span data-stu-id="526e6-189">To use TLS, the following parameters should be specified when a server calls [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity):</span></span>

-   <span data-ttu-id="526e6-190">*pVoid* debe ser un puntero a un objeto [**IAccessControl**](/windows/desktop/api/IAccess/nn-iaccess-iaccesscontrol) o un puntero a un [**\_ descriptor de seguridad**](/windows/desktop/api/winnt/ns-winnt-security_descriptor).</span><span class="sxs-lookup"><span data-stu-id="526e6-190">*pVoid* should be either a pointer to an [**IAccessControl**](/windows/desktop/api/IAccess/nn-iaccess-iaccesscontrol) object or a pointer to a [**SECURITY\_DESCRIPTOR**](/windows/desktop/api/winnt/ns-winnt-security_descriptor).</span></span> <span data-ttu-id="526e6-191">No debe ser **null** ni un puntero a un AppID.</span><span class="sxs-lookup"><span data-stu-id="526e6-191">It should not be **NULL** or a pointer to an AppID.</span></span>
-   <span data-ttu-id="526e6-192">*cAuthSvc* no puede ser 0 o-1.</span><span class="sxs-lookup"><span data-stu-id="526e6-192">*cAuthSvc* cannot be 0 or -1.</span></span> <span data-ttu-id="526e6-193">Los servidores COM nunca eligen Schannel cuando *cAuthSvc* es-1.</span><span class="sxs-lookup"><span data-stu-id="526e6-193">COM servers never chooses Schannel when *cAuthSvc* is -1.</span></span>
-   <span data-ttu-id="526e6-194">*asAuthSvc* debe especificar Schannel como posible servicio de autenticación.</span><span class="sxs-lookup"><span data-stu-id="526e6-194">*asAuthSvc* must specify Schannel as a possible authentication service.</span></span> <span data-ttu-id="526e6-195">Esto se hace estableciendo los siguientes parámetros [**del \_ \_ servicio de autenticación único**](/windows/win32/api/objidlbase/ns-objidlbase-sole_authentication_service) para el miembro Schannel de la [**\_ \_ lista de autenticación única**](/windows/win32/api/objidlbase/ns-objidlbase-sole_authentication_list):</span><span class="sxs-lookup"><span data-stu-id="526e6-195">This is done by setting the following [**SOLE\_AUTHENTICATION\_SERVICE**](/windows/win32/api/objidlbase/ns-objidlbase-sole_authentication_service) parameters for the Schannel member of the [**SOLE\_AUTHENTICATION\_LIST**](/windows/win32/api/objidlbase/ns-objidlbase-sole_authentication_list):</span></span>
    -   <span data-ttu-id="526e6-196">*dwAuthnSvc* debe ser RPC \_ C \_ authn \_ GSS \_ Schannel.</span><span class="sxs-lookup"><span data-stu-id="526e6-196">*dwAuthnSvc* must be RPC\_C\_AUTHN\_GSS\_SCHANNEL.</span></span>
    -   <span data-ttu-id="526e6-197">*dwAuthzSvc* debe ser RPC \_ C \_ AUTHZ \_ ninguno.</span><span class="sxs-lookup"><span data-stu-id="526e6-197">*dwAuthzSvc* should be RPC\_C\_AUTHZ\_NONE.</span></span> <span data-ttu-id="526e6-198">Actualmente, se omite.</span><span class="sxs-lookup"><span data-stu-id="526e6-198">Currently, it is ignored.</span></span>
    -   <span data-ttu-id="526e6-199">*pPrincipalName* debe ser un puntero a un [**\_ contexto de certificado**](/windows/desktop/api/wincrypt/ns-wincrypt-cert_context), convertido en un puntero a OLECHAR, que representa el certificado X. 509 del servidor.</span><span class="sxs-lookup"><span data-stu-id="526e6-199">*pPrincipalName* must be a pointer to a [**CERT\_CONTEXT**](/windows/desktop/api/wincrypt/ns-wincrypt-cert_context), cast as a pointer to OLECHAR, which represents the server's X.509 certificate.</span></span>
-   <span data-ttu-id="526e6-200">*dwAuthnLevel* indica el nivel de autenticación mínimo que se aceptará de los clientes para una conexión correcta.</span><span class="sxs-lookup"><span data-stu-id="526e6-200">*dwAuthnLevel* indicates the minimum authentication level that will be accepted from clients for a successful connection.</span></span> <span data-ttu-id="526e6-201">No puede ser el \_ \_ nivel ninguno de autenticación RPC C \_ \_ .</span><span class="sxs-lookup"><span data-stu-id="526e6-201">It cannot be RPC\_C\_AUTHN\_LEVEL\_NONE.</span></span>
-   <span data-ttu-id="526e6-202">*dwCapabilities* no debe tener establecida la \_ marca EOAC AppID.</span><span class="sxs-lookup"><span data-stu-id="526e6-202">*dwCapabilities* should not have the EOAC\_APPID flag set.</span></span> <span data-ttu-id="526e6-203">La \_ marca de control de acceso EOAC \_ debe establecerse si *pVoid* apunta a un objeto [**IAccessControl**](/windows/desktop/api/IAccess/nn-iaccess-iaccesscontrol) ; no debe establecerse si *pVoid* apunta a un \_ descriptor de seguridad.</span><span class="sxs-lookup"><span data-stu-id="526e6-203">The EOAC\_ACCESS\_CONTROL flag should be set if *pVoid* points to an [**IAccessControl**](/windows/desktop/api/IAccess/nn-iaccess-iaccesscontrol) object; it should not be set if *pVoid* points to a SECURITY\_DESCRIPTOR.</span></span> <span data-ttu-id="526e6-204">Para ver otras marcas que se pueden establecer, vea [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity).</span><span class="sxs-lookup"><span data-stu-id="526e6-204">For other flags that may be set, see [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity).</span></span>

<span data-ttu-id="526e6-205">Para obtener más información sobre el uso de [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity), consulte [configuración de la seguridad de Processwide con CoInitializeSecurity](setting-processwide-security-with-coinitializesecurity.md).</span><span class="sxs-lookup"><span data-stu-id="526e6-205">For more information about using [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity), see [Setting Processwide Security with CoInitializeSecurity](setting-processwide-security-with-coinitializesecurity.md).</span></span>

### <a name="how-a-client-sets-the-security-blanket"></a><span data-ttu-id="526e6-206">Cómo establece un cliente el marco de seguridad</span><span class="sxs-lookup"><span data-stu-id="526e6-206">How a Client Sets the Security Blanket</span></span>

<span data-ttu-id="526e6-207">Si un cliente desea usar TLS, debe especificar Schannel (RPC \_ C \_ authn \_ GSS \_ Schannel) en su lista de servicios de autenticación en el parámetro *pAuthList* de [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity).</span><span class="sxs-lookup"><span data-stu-id="526e6-207">If a client wants to use TLS, it must specify Schannel (RPC\_C\_AUTHN\_GSS\_SCHANNEL) in its list of authentication services in the *pAuthList* parameter of [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity).</span></span> <span data-ttu-id="526e6-208">Si Schannel no se especifica como un posible servicio de autenticación cuando se llama a **CoInitializeSecurity** , se producirá un error en una llamada posterior a [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket) (o [**IClientSecurity:: SetBlanket**](/windows/win32/api/objidl/nf-objidl-iclientsecurity-setblanket)) si intenta especificar Schannel como el servicio de autenticación.</span><span class="sxs-lookup"><span data-stu-id="526e6-208">If Schannel is not specified as a possible authentication service when **CoInitializeSecurity** is called, a later call to [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket) (or [**IClientSecurity::SetBlanket**](/windows/win32/api/objidl/nf-objidl-iclientsecurity-setblanket)) will fail if it tries to specify Schannel as the authentication service.</span></span>

<span data-ttu-id="526e6-209">Se deben especificar los siguientes parámetros cuando un cliente llama a [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity):</span><span class="sxs-lookup"><span data-stu-id="526e6-209">The following parameters should be specified when a client calls [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity):</span></span>

-   <span data-ttu-id="526e6-210">*dwAuthnLevel* especifica el nivel de autenticación predeterminado que el cliente desea usar.</span><span class="sxs-lookup"><span data-stu-id="526e6-210">*dwAuthnLevel* specifies the default authentication level that the client wants to use.</span></span> <span data-ttu-id="526e6-211">No puede ser el \_ \_ nivel ninguno de autenticación RPC C \_ \_ .</span><span class="sxs-lookup"><span data-stu-id="526e6-211">It cannot be RPC\_C\_AUTHN\_LEVEL\_NONE.</span></span>
-   <span data-ttu-id="526e6-212">*dwImpLevel* debe ser la \_ \_ \_ suplantación de nivel de Imp de RPC C \_ .</span><span class="sxs-lookup"><span data-stu-id="526e6-212">*dwImpLevel* must be RPC\_C\_IMP\_LEVEL\_IMPERSONATE.</span></span>
-   <span data-ttu-id="526e6-213">*pAuthList* debe tener los siguientes parámetros de [**\_ \_ información de autenticación únicos**](/windows/win32/api/objidlbase/ns-objidlbase-sole_authentication_info) como miembro de la lista:</span><span class="sxs-lookup"><span data-stu-id="526e6-213">*pAuthList* must have the following [**SOLE\_AUTHENTICATION\_INFO**](/windows/win32/api/objidlbase/ns-objidlbase-sole_authentication_info) parameters as a member of the list:</span></span>
    -   <span data-ttu-id="526e6-214">*dwAuthnSvc* debe ser RPC \_ C \_ authn \_ GSS \_ Schannel.</span><span class="sxs-lookup"><span data-stu-id="526e6-214">*dwAuthnSvc* must be RPC\_C\_AUTHN\_GSS\_SCHANNEL.</span></span>
    -   <span data-ttu-id="526e6-215">*dwAuthzSvc* debe ser RPC \_ C \_ AUTHZ \_ None.</span><span class="sxs-lookup"><span data-stu-id="526e6-215">*dwAuthzSvc* must be RPC\_C\_AUTHZ\_NONE.</span></span>
    -   <span data-ttu-id="526e6-216">*pAuthInfo* es un puntero a un [**\_ contexto de certificado**](/windows/desktop/api/wincrypt/ns-wincrypt-cert_context), convertido en un puntero a void, que representa el certificado X. 509 del cliente.</span><span class="sxs-lookup"><span data-stu-id="526e6-216">*pAuthInfo* is a pointer to a [**CERT\_CONTEXT**](/windows/desktop/api/wincrypt/ns-wincrypt-cert_context), cast as a pointer to void, which represents the client's X.509 certificate.</span></span> <span data-ttu-id="526e6-217">Si el cliente no tiene un certificado o no desea presentar su certificado en el servidor, *pAuthInfo* debe ser **null** y se intentará establecer una conexión anónima con el servidor.</span><span class="sxs-lookup"><span data-stu-id="526e6-217">If the client does not have a certificate or does not wish to present its certificate to the server, *pAuthInfo* must be **NULL** and an anonymous connection will be attempted with the server.</span></span>
-   <span data-ttu-id="526e6-218">*dwCapabilities* es un conjunto de marcas que indican funcionalidades de cliente adicionales.</span><span class="sxs-lookup"><span data-stu-id="526e6-218">*dwCapabilities* is a set of flags that indicate additional client capabilities.</span></span> <span data-ttu-id="526e6-219">Consulte [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) para obtener información sobre qué marcas se deben establecer.</span><span class="sxs-lookup"><span data-stu-id="526e6-219">See [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) for information about which flags should be set.</span></span>

<span data-ttu-id="526e6-220">Para obtener más información sobre el uso de [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity), consulte [configuración de la seguridad de Processwide con CoInitializeSecurity](setting-processwide-security-with-coinitializesecurity.md).</span><span class="sxs-lookup"><span data-stu-id="526e6-220">For more information about using [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity), see [Setting Processwide Security with CoInitializeSecurity](setting-processwide-security-with-coinitializesecurity.md).</span></span>

### <a name="how-a-client-changes-the-security-blanket"></a><span data-ttu-id="526e6-221">Cómo cambia un cliente el marco de seguridad</span><span class="sxs-lookup"><span data-stu-id="526e6-221">How a Client Changes the Security Blanket</span></span>

<span data-ttu-id="526e6-222">Si un cliente desea utilizar TLS pero cambia la capa de seguridad después de llamar a [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity), debe llamar a [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket) o [**IClientSecurity:: SetBlanket**](/windows/win32/api/objidl/nf-objidl-iclientsecurity-setblanket) con parámetros similares a los que se usan en la llamada a **CoInitializeSecurity**, con las siguientes diferencias:</span><span class="sxs-lookup"><span data-stu-id="526e6-222">If a client wants to use TLS but change the security blanket after calling [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity), it must call either [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket) or [**IClientSecurity::SetBlanket**](/windows/win32/api/objidl/nf-objidl-iclientsecurity-setblanket) with parameters similar to those used in the call to **CoInitializeSecurity**, with the following differences:</span></span>

-   <span data-ttu-id="526e6-223">*pServerPrincName* indica el nombre principal del servidor, en formato msstd o fullsic.</span><span class="sxs-lookup"><span data-stu-id="526e6-223">*pServerPrincName* indicates the principal name of the server, in either msstd or fullsic format.</span></span> <span data-ttu-id="526e6-224">Para obtener información sobre estos formatos, consulte [nombres principales](/windows/desktop/Rpc/principal-names).</span><span class="sxs-lookup"><span data-stu-id="526e6-224">For information on these formats, see [Principal Names](/windows/desktop/Rpc/principal-names).</span></span> <span data-ttu-id="526e6-225">Si el cliente tiene el certificado X. 509 del servidor, puede encontrar el nombre principal llamando a [**RpcCertGeneratePrincipalName**](/windows/desktop/api/rpcssl/nf-rpcssl-rpccertgenerateprincipalname).</span><span class="sxs-lookup"><span data-stu-id="526e6-225">If the client has the server's X.509 certificate, it can find the principal name by calling [**RpcCertGeneratePrincipalName**](/windows/desktop/api/rpcssl/nf-rpcssl-rpccertgenerateprincipalname).</span></span>
-   <span data-ttu-id="526e6-226">*pAuthInfo* es un puntero a un [**\_ contexto de certificado**](/windows/desktop/api/wincrypt/ns-wincrypt-cert_context), convertido en un puntero al \_ identificador de identidad de autenticación de RPC \_ \_ , que representa el certificado X. 509 del cliente.</span><span class="sxs-lookup"><span data-stu-id="526e6-226">*pAuthInfo* is a pointer to a [**CERT\_CONTEXT**](/windows/desktop/api/wincrypt/ns-wincrypt-cert_context), cast as a pointer to RPC\_AUTH\_IDENTITY\_HANDLE, which represents the client's X.509 certificate.</span></span> <span data-ttu-id="526e6-227">Si el cliente no tiene un certificado o no desea presentar su certificado en el servidor, *pAuthInfo* debe ser **null** y se intentará establecer una conexión anónima con el servidor.</span><span class="sxs-lookup"><span data-stu-id="526e6-227">If the client does not have a certificate or does not wish to present its certificate to the server, *pAuthInfo* must be **NULL** and an anonymous connection will be attempted with the server.</span></span>
-   <span data-ttu-id="526e6-228">*dwCapabilities* consta de marcas que indican funcionalidades de cliente adicionales.</span><span class="sxs-lookup"><span data-stu-id="526e6-228">*dwCapabilities* consists of flags that indicate additional client capabilities.</span></span> <span data-ttu-id="526e6-229">Solo se pueden usar cuatro marcas para cambiar la configuración de la capa de seguridad: EOAC \_ default, EOAC \_ Mutual \_ auth, EOAC \_ cualquier \_ entidad (esta marca está en desuso) y EOAC \_ Make \_ FULLSIC.</span><span class="sxs-lookup"><span data-stu-id="526e6-229">Only four flags can be used to change security blanket settings: EOAC\_DEFAULT, EOAC\_MUTUAL\_AUTH, EOAC\_ANY\_AUTHORITY (this flag is deprecated), and EOAC\_MAKE\_FULLSIC.</span></span> <span data-ttu-id="526e6-230">Para obtener más información, vea [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket).</span><span class="sxs-lookup"><span data-stu-id="526e6-230">For more information, see [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket).</span></span>

<span data-ttu-id="526e6-231">Para obtener más información sobre el uso de [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket), consulte [configuración de la seguridad en el nivel de proxy de interfaz](setting-security-at-the-interface-proxy-level.md).</span><span class="sxs-lookup"><span data-stu-id="526e6-231">For more information about using [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket), see [Setting Security at the Interface Proxy Level](setting-security-at-the-interface-proxy-level.md).</span></span>

### <a name="example-client-changes-the-security-blanket"></a><span data-ttu-id="526e6-232">Ejemplo: el cliente cambia el marco de seguridad</span><span class="sxs-lookup"><span data-stu-id="526e6-232">Example: Client Changes the Security Blanket</span></span>

<span data-ttu-id="526e6-233">En el ejemplo siguiente se muestra cómo un cliente puede cambiar la capa de seguridad para dar cabida a una solicitud del servidor para que el cliente proporcione su certificado X. 509.</span><span class="sxs-lookup"><span data-stu-id="526e6-233">The following example demonstrates how a client can change the security blanket to accommodate a request from the server for the client to provide its X.509 certificate.</span></span> <span data-ttu-id="526e6-234">El código de control de errores se omite por motivos de brevedad.</span><span class="sxs-lookup"><span data-stu-id="526e6-234">Error handling code is omitted for brevity.</span></span>


```C++
void ClientChangesSecurity ()
{
  HCRYPTPROV                   provider           = 0;
  HCERTSTORE                   cert_store         = NULL;
  PCCERT_CONTEXT               client_cert        = NULL;
  PCCERT_CONTEXT               server_cert        = NULL;
  WCHAR                        *server_princ_name = NULL;
  ISecret                      *pSecret           = NULL;
  MULTI_QI                     server_instance;
  COSERVERINFO                 server_machine;
  SOLE_AUTHENTICATION_LIST     auth_list;
  SOLE_AUTHENTICATION_INFO     auth_info[1];



  // Specify all the authentication info. 
  // The client is willing to connect using SChannel,
  //   with no client certificate.
  auth_list.cAuthInfo     = 1;
  auth_list.aAuthInfo     = auth_info;
  auth_info[0].dwAuthnSvc = RPC_C_AUTHN_GSS_SCHANNEL;
  auth_info[0].dwAuthzSvc = RPC_C_AUTHZ_NONE;
  auth_info[0].pAuthInfo  = NULL;  // No certificate

  // Initialize client security with no client certificate.
  CoInitializeSecurity( NULL, -1, NULL, NULL,
                        RPC_C_AUTHN_LEVEL_PKT,
                        RPC_C_IMP_LEVEL_IMPERSONATE, &auth_list,
                        EOAC_NONE, NULL );
  
  // Specify info for the proxy.
  server_instance = {&IID_ISecret, NULL, S_OK};
  server_machine  = {0, L"ServerMachineName", NULL, 0};
  
  // Create a proxy.
  CoCreateInstanceEx( CLSID_Secret, NULL, CLSCTX_REMOTE_SERVER, 
                      &server_machine, 1, &server_instance);
  pSecret = (ISecret *) server_instance.pItf;

  //** The client obtained the server's certificate during the handshake.
  //** The server requests a certificate from the client.

  // Get the default certificate provider.
  CryptAcquireContext( &provider, NULL, NULL, PROV_RSA_SCHANNEL, 0 );

  // Open the certificate store.
  cert_store = CertOpenSystemStore( provider, L"my" );

  // Find the client's certificate.
  client_cert = 
    CertFindCertificateInStore( cert_store,
                                X509_ASN_ENCODING | PKCS_7_ASN_ENCODING,
                                0,
                                CERT_FIND_SUBJECT_STR,
                                L"ClientName",  // Use the principal name
                                NULL );

  // Find the fullsic principal name of the server.
  RpcCertGeneratePrincipalName( server_cert, RPC_C_FULL_CERT_CHAIN, 
                                &server_princ_name );

  // Change the client's security: 
  // Increase the authentication level and attach a certificate.
  CoSetProxyBlanket( pSecret, RPC_C_AUTHN_GSS_SCHANNEL,
                     RPC_C_AUTHZ_NONE,
                     server_princ_name, RPC_C_AUTHN_LEVEL_PKT_PRIVACY,
                     RPC_C_IMP_LEVEL_IMPERSONATE, 
                     (RPC_AUTH_IDENTITY_HANDLE *) client_cert,
                     EOAC_NONE );

  cleanup:
  if (server_princ_name != NULL)
    RpcStringFree( &server_princ_name );
  if (client_cert != NULL)
    CertFreeCertificateContext(client_cert);
  if (server_cert != NULL)
    CertFreeCertificateContext(server_cert);
  if (cert_store != NULL)
    CertCloseStore( cert_store, CERT_CLOSE_STORE_CHECK_FLAG );
  if (provider != 0 )
    CryptReleaseContext( provider, 0 );
  if (pSecret != NULL)
    pSecret->Release();
  CoUninitialize();
}
```



## <a name="related-topics"></a><span data-ttu-id="526e6-235">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="526e6-235">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="526e6-236">COM y paquetes de seguridad</span><span class="sxs-lookup"><span data-stu-id="526e6-236">COM and Security Packages</span></span>](com-and-security-packages.md)
</dt> </dl>

 

 