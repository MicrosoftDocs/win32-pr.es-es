---
description: Obtenga información sobre las consideraciones de implementación para el enrutamiento de flujos. Las API implementan el enrutamiento de flujos controlando el cambio de secuencia a un nuevo punto de conexión de audio predeterminado.
ms.assetid: ecda0b5b-6583-43b4-a9b4-f12a95f09452
title: Consideraciones sobre la implementación del enrutamiento de flujos
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 62bd753fe027c92ffac9f5a41cea589b600d7f26
ms.sourcegitcommit: 51ef825fb48f15e1aa30e8795988f10dc2b2155c
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 06/14/2021
ms.locfileid: "112068041"
---
# <a name="stream-routing-implementation-considerations"></a><span data-ttu-id="7f467-104">Consideraciones sobre la implementación del enrutamiento de flujos</span><span class="sxs-lookup"><span data-stu-id="7f467-104">Stream Routing Implementation Considerations</span></span>

<span data-ttu-id="7f467-105">En Windows 7, las API de plataforma de alto nivel que usan las API de audio principal, como las API de Media Foundation, Direct Sound y Wave, implementan la característica de enrutamiento de flujos controlando el cambio de flujo de un dispositivo existente a un nuevo punto de conexión de audio predeterminado.</span><span class="sxs-lookup"><span data-stu-id="7f467-105">In Windows 7, high-level platform APIs that use Core Audio APIs, such as Media Foundation, DirectSound, and Wave APIs, implement the stream routing feature by handling stream switching from an existing device to a new default audio endpoint.</span></span> <span data-ttu-id="7f467-106">Las aplicaciones multimedia que usan estas API usan el comportamiento de enrutamiento de flujos sin modificaciones en el origen.</span><span class="sxs-lookup"><span data-stu-id="7f467-106">Media applications that use these APIs use the stream routing behavior without any modifications to the source.</span></span> <span data-ttu-id="7f467-107">Los clientes WASAPI directos pueden usar las notificaciones enviadas por los componentes de Core Audio e implementar la característica de enrutamiento de secuencias.</span><span class="sxs-lookup"><span data-stu-id="7f467-107">Direct WASAPI clients can use the notifications sent by Core Audio components and implement the stream routing feature.</span></span>

<span data-ttu-id="7f467-108">Los clientes WASAPI directos (aplicaciones multimedia que usan WASAPI directamente) reciben nuevas notificaciones de sesión de audio y dispositivo enviadas por los componentes de Audio principal.</span><span class="sxs-lookup"><span data-stu-id="7f467-108">Direct WASAPI clients (media applications that use WASAPI directly) receive new device and audio session notifications sent by Core Audio components.</span></span> <span data-ttu-id="7f467-109">El comportamiento de la característica de enrutamiento de flujos se define mediante la forma en que la aplicación controla estas notificaciones.</span><span class="sxs-lookup"><span data-stu-id="7f467-109">The behavior of the stream routing feature is defined by how the application handles these notifications.</span></span>

<span data-ttu-id="7f467-110">MMDevice API y la sesión de audio envían notificaciones sobre los cambios de estado del dispositivo y los cambios de sesión a los clientes WASAPI en forma de devoluciones de llamada.</span><span class="sxs-lookup"><span data-stu-id="7f467-110">MMDevice API and the audio session send notifications about device state changes and session changes to WASAPI clients in the form of callbacks.</span></span> <span data-ttu-id="7f467-111">Para obtener estas notificaciones, el cliente debe registrar su implementación de [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) e [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents).</span><span class="sxs-lookup"><span data-stu-id="7f467-111">To get these notifications, the client must register its implementation of [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) and [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents).</span></span> <span data-ttu-id="7f467-112">Para obtener más información, vea [Notificaciones pertinentes para el enrutamiento de secuencias.](relevant-device-notifications-for-stream-routing.md)</span><span class="sxs-lookup"><span data-stu-id="7f467-112">For more information, see [Relevant Notifications for Stream Routing](relevant-device-notifications-for-stream-routing.md).</span></span>

<span data-ttu-id="7f467-113">En el escenario de casco USB descrito en [Stream Routing](stream-routing.md), una aplicación reproduce una secuencia de audio y usa MMDeviceAPI y WASAPI para representar la secuencia en el dispositivo de representación predeterminado, **Speaker**.</span><span class="sxs-lookup"><span data-stu-id="7f467-113">In the USB headset scenario described in [Stream Routing](stream-routing.md), an application is playing an audio stream and uses MMDeviceAPI and WASAPI to render the stream on the default rendering device, **Speaker**.</span></span> <span data-ttu-id="7f467-114">Cuando se cambia el dispositivo predeterminado, la aplicación recibe una [**notificación IMMNotificationClient.**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient)</span><span class="sxs-lookup"><span data-stu-id="7f467-114">When the default device is changed, the application receives an [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) notification.</span></span> <span data-ttu-id="7f467-115">La aplicación también recibe notificaciones [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) que indican que el usuario quitó el dispositivo de punto de conexión de audio o que el formato de secuencia cambió para el dispositivo al que está conectada la sesión de audio.</span><span class="sxs-lookup"><span data-stu-id="7f467-115">The application also receives [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) notifications indicating that the user removed the audio endpoint device or that the stream format changed for the device that the audio session is connected to.</span></span> <span data-ttu-id="7f467-116">Tras recibir las notificaciones, la aplicación deja de transmitir al punto de conexión del hablante y vuelve a abrir la secuencia para representarla en el punto de conexión predeterminado actual, el casco.</span><span class="sxs-lookup"><span data-stu-id="7f467-116">Upon receiving the notifications, the application stops streaming to the speaker endpoint and reopens the stream for rendering on the current default endpoint, the headset.</span></span>

![diagrama de flujo de datos para notificaciones de dispositivos.](images/stream-routing.gif)

<span data-ttu-id="7f467-118">En respuesta a estas notificaciones, el cliente podría volver a abrir la secuencia en el nuevo dispositivo predeterminado con el nuevo formato seleccionado por el usuario.</span><span class="sxs-lookup"><span data-stu-id="7f467-118">In response to such notifications, the client might reopen the stream on the new default device in the new format selected by the user.</span></span>

## <a name="stream-managment"></a><span data-ttu-id="7f467-119">Stream Managment</span><span class="sxs-lookup"><span data-stu-id="7f467-119">Stream Managment</span></span>

<span data-ttu-id="7f467-120">En la lista siguiente se resumen los pasos que debe realizar un cliente WASAPI para proporcionar la funcionalidad de conmutación de flujo.</span><span class="sxs-lookup"><span data-stu-id="7f467-120">The following list summarizes the steps that a WASAPI client must perform to provide the stream switching functionality.</span></span>

1.  <span data-ttu-id="7f467-121">Espere a la notificación [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) pertinente.</span><span class="sxs-lookup"><span data-stu-id="7f467-121">Wait for the relevant [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) notification.</span></span> <span data-ttu-id="7f467-122">Si el dispositivo es el predeterminado, se recibe la notificación [**IMMNotificationClient::OnDefaultDeviceChanged.**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immnotificationclient-ondefaultdevicechanged)</span><span class="sxs-lookup"><span data-stu-id="7f467-122">If the device is the default device, the [**IMMNotificationClient::OnDefaultDeviceChanged**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immnotificationclient-ondefaultdevicechanged) notification is received.</span></span>
2.  <span data-ttu-id="7f467-123">Si hay un nuevo dispositivo disponible, obtenga una referencia al punto de conexión del nuevo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="7f467-123">If a new device is available, get a reference to the endpoint of the new device.</span></span> <span data-ttu-id="7f467-124">Llame [**a IMMDeviceEnumerator::GetDefaultAudioEndpoint para**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) el nuevo dispositivo predeterminado.</span><span class="sxs-lookup"><span data-stu-id="7f467-124">Call [**IMMDeviceEnumerator::GetDefaultAudioEndpoint**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) for the new default device.</span></span> <span data-ttu-id="7f467-125">Si el nuevo dispositivo no es el predeterminado, puede recuperarlo llamando a [**IMMDeviceEnumerator::GetDevice**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdevice).</span><span class="sxs-lookup"><span data-stu-id="7f467-125">If the new device is not the default device, you can retrieve the device by calling [**IMMDeviceEnumerator::GetDevice**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdevice).</span></span> <span data-ttu-id="7f467-126">Para obtener más información, vea [Getting the Device Endpoint for Stream Routing](getting-the-default-device-endpoint-for-stream-routing.md).</span><span class="sxs-lookup"><span data-stu-id="7f467-126">For more information, see [Getting the Device Endpoint for Stream Routing](getting-the-default-device-endpoint-for-stream-routing.md).</span></span>
3.  <span data-ttu-id="7f467-127">Espere a [**IAudioSessionEvents::OnSessionDisconnected con**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessionevents-onsessiondisconnected) el valor de motivo.</span><span class="sxs-lookup"><span data-stu-id="7f467-127">Wait for the [**IAudioSessionEvents::OnSessionDisconnected**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessionevents-onsessiondisconnected) with the reason value.</span></span>
    > [!Note]  
    > <span data-ttu-id="7f467-128">Dado que todas estas operaciones son asócronas, no se puede predecir el orden en el que la aplicación recibe notificaciones de cambio de dispositivo y de desconexión de sesión.</span><span class="sxs-lookup"><span data-stu-id="7f467-128">Because all of these operations are asychronous, the order in which the application receives device-change and session-disconnect notifications cannnot be predicted.</span></span> <span data-ttu-id="7f467-129">La aplicación debe implementar el control de notificaciones para recibir estas notificaciones en cualquier orden.</span><span class="sxs-lookup"><span data-stu-id="7f467-129">The application must implement notification handling to receive these notifications in any order.</span></span> <span data-ttu-id="7f467-130">Sin embargo, normalmente, la aplicación recibe el **valor AudioSessionDisconnect** antes de la notificación de cambio de dispositivo predeterminada.</span><span class="sxs-lookup"><span data-stu-id="7f467-130">However, typically, the application receives **AudioSessionDisconnect** value before the default device change notification.</span></span>

     

4.  <span data-ttu-id="7f467-131">Evalúe el valor de motivo y determine si la secuencia debe transferirse a otro punto de conexión de audio o si la secuencia debe reinicializarse con un nuevo formato.</span><span class="sxs-lookup"><span data-stu-id="7f467-131">Evaluate the reason value and determine whether the stream needs to be transferred to another audio endpoint or the stream needs to be reinitialized with a new format.</span></span>
5.  <span data-ttu-id="7f467-132">Detenga el streaming al dispositivo predeterminado anterior si el motivo indica que la secuencia se debe volver a enrutar al nuevo dispositivo predeterminado.</span><span class="sxs-lookup"><span data-stu-id="7f467-132">Stop streaming to the old default device if the reason indicates that the stream should be re-routed to the new default device.</span></span>
6.  <span data-ttu-id="7f467-133">Realizar cálculos de asignación de posición.</span><span class="sxs-lookup"><span data-stu-id="7f467-133">Perform position mapping calculations.</span></span>
7.  <span data-ttu-id="7f467-134">Abra la secuencia en el nuevo dispositivo y transfiera toda la información de estado.</span><span class="sxs-lookup"><span data-stu-id="7f467-134">Open the stream on the new device and transfer all state information.</span></span>
8.  <span data-ttu-id="7f467-135">Reanude el streaming en el nuevo dispositivo predeterminado.</span><span class="sxs-lookup"><span data-stu-id="7f467-135">Resume streaming on the new default device.</span></span>
9.  <span data-ttu-id="7f467-136">Controlar la salida del dispositivo predeterminado anterior.</span><span class="sxs-lookup"><span data-stu-id="7f467-136">Handle the departure of the old default device.</span></span>

<span data-ttu-id="7f467-137">Para que la operación de conmutación de flujo parezca perfecta, debe realizarse lo más rápido posible.</span><span class="sxs-lookup"><span data-stu-id="7f467-137">To make the stream switching operation appear seamless, it must be done as quickly as possible.</span></span> <span data-ttu-id="7f467-138">Esto depende del rendimiento de los componentes implicados en la nueva iniciación de la secuencia en el nuevo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="7f467-138">This depends on the performance of the components involved in re-initiation of the stream on the new device.</span></span>

## <a name="position-mapping-considerations"></a><span data-ttu-id="7f467-139">Consideraciones sobre la asignación de posiciones</span><span class="sxs-lookup"><span data-stu-id="7f467-139">Position Mapping Considerations</span></span>

<span data-ttu-id="7f467-140">Cuando la aplicación obtiene [**notificaciones IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) [**e IAudioSessionEvents,**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) puede enrutar las secuencias existentes al nuevo dispositivo predeterminado.</span><span class="sxs-lookup"><span data-stu-id="7f467-140">When the application gets [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) and [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) notifications, it can route the existing streams to the new default device.</span></span> <span data-ttu-id="7f467-141">Cuando una secuencia de audio existente se interrumpe y se abre en el nuevo dispositivo, la representación en el nuevo dispositivo debe comenzar en la posición en la que se detuvo la secuencia en el dispositivo antiguo.</span><span class="sxs-lookup"><span data-stu-id="7f467-141">When an existing audio stream is interrupted and opened on the new device, rendering on the new device must start at the position at which the stream was stopped on the old device.</span></span> <span data-ttu-id="7f467-142">Para ello, la aplicación debe tener la última posición conocida del dispositivo para calcular la posición inicial en el nuevo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="7f467-142">To do this, the application must have the last known device position, to calculate the start position on the new device.</span></span> <span data-ttu-id="7f467-143">Por ejemplo, esta posición se puede usar como desplazamiento delta para la asignación de posición posterior.</span><span class="sxs-lookup"><span data-stu-id="7f467-143">For example, this position can be used as the delta offset for subsequent position mapping.</span></span> <span data-ttu-id="7f467-144">Cuando la secuencia comienza a representarse, la nueva posición del dispositivo se puede volver a colocar en la posición del dispositivo almacenado en caché.</span><span class="sxs-lookup"><span data-stu-id="7f467-144">When the stream starts rendering, the new device position can be remapped to the cached device position.</span></span>

<span data-ttu-id="7f467-145">En los pasos siguientes se resume el proceso de realizar una transición de flujo sin problemas.</span><span class="sxs-lookup"><span data-stu-id="7f467-145">The following steps summarize the process of making a seamless stream transition.</span></span>

1.  <span data-ttu-id="7f467-146">Almacenar en caché la última posición del dispositivo de la secuencia en el dispositivo antiguo.</span><span class="sxs-lookup"><span data-stu-id="7f467-146">Cache the last device position of the stream on the old device.</span></span>
2.  <span data-ttu-id="7f467-147">Detenga la secuencia en el dispositivo antiguo.</span><span class="sxs-lookup"><span data-stu-id="7f467-147">Stop the stream on the old device.</span></span>
3.  <span data-ttu-id="7f467-148">Realice cálculos de remapping para obtener la nueva posición.</span><span class="sxs-lookup"><span data-stu-id="7f467-148">Perform remapping calculations to get the new position.</span></span>
4.  <span data-ttu-id="7f467-149">Comience a representar la secuencia en el nuevo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="7f467-149">Start rendering the stream on the new device.</span></span>
5.  <span data-ttu-id="7f467-150">Libere la secuencia anterior.</span><span class="sxs-lookup"><span data-stu-id="7f467-150">Release the old stream.</span></span>

<span data-ttu-id="7f467-151">Durante la transición, la aplicación debe asegurarse de que el reloj no salga de la sincronización, lo que da lugar a secuencias de audio y vídeo no sincronizadas.</span><span class="sxs-lookup"><span data-stu-id="7f467-151">During the transition, the application must ensure that the clock does not get out of synchronization, resulting in out-of-sync audio and video streams.</span></span> <span data-ttu-id="7f467-152">Esto puede ocurrir si los ejemplos de vídeo se siguen representando mientras la secuencia de audio se enruta al nuevo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="7f467-152">This can occur if the video samples continue to render while the audio stream is routed to the new device.</span></span> <span data-ttu-id="7f467-153">La aplicación debe almacenar en caché la posición del reloj para el cálculo de remapping y asegurarse de que los ejemplos de vídeo no se representen hasta que la secuencia de audio se vuelva a abrir en el nuevo dispositivo, de modo que cuando el clip reanude la representación, se sincronicen las secuencias de audio y vídeo.</span><span class="sxs-lookup"><span data-stu-id="7f467-153">The application must cache the clock position for the remapping calculation and make sure that the video samples are not rendered until the audio stream is reopened on the new device, so that when the clip resumes rendering, the audio and the video streams are synchronized.</span></span> <span data-ttu-id="7f467-154">En algunos casos, cuando el tiempo de presentación para representar los fotogramas de vídeo se basa en el reloj de audio, es suficiente detener la secuencia de audio hasta que se complete el cambio de secuencia y no sea necesaria ninguna otra implementación de asignación de posición para la secuencia de vídeo para la sincronización de vídeo de audio.</span><span class="sxs-lookup"><span data-stu-id="7f467-154">In some cases, where the presentation time for rendering the video frames is based on the audio clock, it is sufficient to stop the audio stream until stream switching is complete and no other position mapping implementation for the video stream is necessary for audio video synchronization.</span></span>

<span data-ttu-id="7f467-155">Si durante la representación, [**IAudioRenderClient::GetBuffer**](/windows/desktop/api/Audioclient/nf-audioclient-iaudiorenderclient-getbuffer) devuelve un error porque se pierde el dispositivo antiguo, la aplicación no necesita detener la secuencia anterior porque la operación de streaming ya ha finalizado.</span><span class="sxs-lookup"><span data-stu-id="7f467-155">If while rendering, [**IAudioRenderClient::GetBuffer**](/windows/desktop/api/Audioclient/nf-audioclient-iaudiorenderclient-getbuffer) returns an error because the old device is lost, the application need not stop the old stream because the streaming operation has already terminated.</span></span> <span data-ttu-id="7f467-156">Para obtener información sobre cómo controlar este error, vea [Recuperación de un Invalid-Device error](recovering-from-an-invalid-device-error.md).</span><span class="sxs-lookup"><span data-stu-id="7f467-156">For information about handling this error, see [Recovering from an Invalid-Device Error](recovering-from-an-invalid-device-error.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="7f467-157">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="7f467-157">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="7f467-158">Acerca de MMDevice API</span><span class="sxs-lookup"><span data-stu-id="7f467-158">About MMDevice API</span></span>](mmdevice-api.md)
</dt> <dt>

[<span data-ttu-id="7f467-159">Acerca de WASAPI</span><span class="sxs-lookup"><span data-stu-id="7f467-159">About WASAPI</span></span>](wasapi.md)
</dt> <dt>

[<span data-ttu-id="7f467-160">Enrutamiento de flujos</span><span class="sxs-lookup"><span data-stu-id="7f467-160">Stream Routing</span></span>](stream-routing.md)
</dt> </dl>

 

 



