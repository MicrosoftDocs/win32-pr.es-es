---
description: Una aplicación VSS de copia de seguridad y recuperación que realiza la recuperación ante desastres (también denominada reconstrucción completa) puede usar el escritor de recuperación automática del sistema (ASR) junto con Entorno de preinstalación de Windows (Windows PE) para realizar una copia de seguridad y restaurar los volúmenes críticos y otros componentes del estado del sistema de arranque. La aplicación de copia de seguridad se implementa como un solicitante de VSS.
ms.assetid: 13adfd79-f26a-4385-9b59-129d06fa72eb
title: Uso de la recuperación automatizada del sistema de VSS para la recuperación ante desastres
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 1e31ef8ba223f40928e2422fa92240656f94592d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/07/2021
ms.locfileid: "105696485"
---
# <a name="using-vss-automated-system-recovery-for-disaster-recovery"></a><span data-ttu-id="c64a2-104">Uso de la recuperación automatizada del sistema de VSS para la recuperación ante desastres</span><span class="sxs-lookup"><span data-stu-id="c64a2-104">Using VSS Automated System Recovery for Disaster Recovery</span></span>

<span data-ttu-id="c64a2-105">Una aplicación VSS de copia de seguridad y recuperación que realiza la recuperación ante desastres (también denominada reconstrucción completa) puede usar el escritor de recuperación automática del sistema (ASR) junto con Entorno de preinstalación de Windows (Windows PE) para realizar una copia de seguridad y restaurar los volúmenes críticos y otros componentes del estado del sistema de arranque.</span><span class="sxs-lookup"><span data-stu-id="c64a2-105">A VSS backup-and-recovery application that performs disaster recovery (also called bare-metal recovery) can use the Automated System Recovery (ASR) writer together with Windows Preinstallation Environment (Windows PE) to back up and restore critical volumes and other components of the bootable system state.</span></span> <span data-ttu-id="c64a2-106">La aplicación de copia de seguridad se implementa como un solicitante de VSS.</span><span class="sxs-lookup"><span data-stu-id="c64a2-106">The backup application is implemented as a VSS requester.</span></span>

<span data-ttu-id="c64a2-107">**Nota:**  Las aplicaciones que usan ASR deben tener una licencia de Windows PE.</span><span class="sxs-lookup"><span data-stu-id="c64a2-107">**Note**  Applications that use ASR must license Windows PE.</span></span>

<span data-ttu-id="c64a2-108">**Windows Server 2003 y Windows XP:** ASR no se implementa como VSS Writer.</span><span class="sxs-lookup"><span data-stu-id="c64a2-108">**Windows Server 2003 and Windows XP:** ASR is not implemented as a VSS writer.</span></span>

<span data-ttu-id="c64a2-109">Para obtener información acerca de las herramientas de seguimiento que puede usar con ASR, consulte [uso de herramientas de seguimiento con aplicaciones de ASR de VSS](using-tracing-tools-with-vss-asr-applications.md).</span><span class="sxs-lookup"><span data-stu-id="c64a2-109">For information about tracing tools that you can use with ASR, see [Using Tracing Tools with VSS ASR Applications](using-tracing-tools-with-vss-asr-applications.md).</span></span>

<span data-ttu-id="c64a2-110">**En este artículo:**</span><span class="sxs-lookup"><span data-stu-id="c64a2-110">**In this article:**</span></span>

-   [<span data-ttu-id="c64a2-111">Información general de las tareas de fase de copia de seguridad</span><span class="sxs-lookup"><span data-stu-id="c64a2-111">Overview of Backup Phase Tasks</span></span>](#overview-of-backup-phase-tasks)
-   [<span data-ttu-id="c64a2-112">Elección de los componentes críticos de la copia de seguridad</span><span class="sxs-lookup"><span data-stu-id="c64a2-112">Choosing Which Critical Components to Back Up</span></span>](#choosing-which-critical-components-to-back-up)
-   [<span data-ttu-id="c64a2-113">Información general sobre las tareas de la fase de restauración</span><span class="sxs-lookup"><span data-stu-id="c64a2-113">Overview of Restore Phase Tasks</span></span>](#overview-of-restore-phase-tasks)
-   [<span data-ttu-id="c64a2-114">Excluir todos los discos de un volumen</span><span class="sxs-lookup"><span data-stu-id="c64a2-114">Excluding All Disks for a Volume</span></span>](#excluding-all-disks-for-a-volume)

## <a name="overview-of-backup-phase-tasks"></a><span data-ttu-id="c64a2-115">Información general de las tareas de fase de copia de seguridad</span><span class="sxs-lookup"><span data-stu-id="c64a2-115">Overview of Backup Phase Tasks</span></span>

<span data-ttu-id="c64a2-116">En el momento de la copia de seguridad, el solicitante realiza los pasos siguientes.</span><span class="sxs-lookup"><span data-stu-id="c64a2-116">At backup time, the requester performs the following steps.</span></span>

> [!Note]  
> <span data-ttu-id="c64a2-117">Todos los pasos son necesarios a menos que se indique lo contrario.</span><span class="sxs-lookup"><span data-stu-id="c64a2-117">All steps are required unless otherwise indicated.</span></span>

 

1.  <span data-ttu-id="c64a2-118">Llame a la función [**CreateVssBackupComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssbackupcomponents) para crear una instancia de la interfaz [**ivssbackupcomponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) y llamar al método [**IVssBackupComponents:: InitializeForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforbackup) para inicializar la instancia para administrar una copia de seguridad.</span><span class="sxs-lookup"><span data-stu-id="c64a2-118">Call the [**CreateVssBackupComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssbackupcomponents) function to create an instance of the [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) interface and call the [**IVssBackupComponents::InitializeForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforbackup) method to initialize the instance to manage a backup.</span></span>
2.  <span data-ttu-id="c64a2-119">Llame a [**IVssBackupComponents:: SetContext**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setcontext) para establecer el contexto de la operación de instantánea.</span><span class="sxs-lookup"><span data-stu-id="c64a2-119">Call [**IVssBackupComponents::SetContext**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setcontext) to set the context for the shadow copy operation.</span></span>
3.  <span data-ttu-id="c64a2-120">Llame a [**IVssBackupComponents:: SetBackupState**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupstate) para configurar la copia de seguridad.</span><span class="sxs-lookup"><span data-stu-id="c64a2-120">Call [**IVssBackupComponents::SetBackupState**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupstate) to configure the backup.</span></span> <span data-ttu-id="c64a2-121">Establezca el parámetro *bBackupBootableSystemState* en **true** para indicar que la copia de seguridad incluirá un estado del sistema de arranque.</span><span class="sxs-lookup"><span data-stu-id="c64a2-121">Set the *bBackupBootableSystemState* parameter to **true** to indicate that the backup will include a bootable system state.</span></span>
4.  <span data-ttu-id="c64a2-122">Elija los componentes críticos del documento de metadatos del escritor del escritor de ASR para realizar copias de seguridad y llamar a [**IVssBackupComponents:: AddComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent) para cada uno de ellos.</span><span class="sxs-lookup"><span data-stu-id="c64a2-122">Choose which critical components in the ASR writer's Writer Metadata Document to back up and call [**IVssBackupComponents::AddComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent) for each of them.</span></span>
5.  <span data-ttu-id="c64a2-123">Llame a [**IVssBackupComponents:: StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset) para crear un nuevo conjunto de instantáneas vacío.</span><span class="sxs-lookup"><span data-stu-id="c64a2-123">Call [**IVssBackupComponents::StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset) to create a new, empty shadow copy set.</span></span>
6.  <span data-ttu-id="c64a2-124">Llame a [**IVssBackupComponents:: GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata) para iniciar el contacto asincrónico con escritores.</span><span class="sxs-lookup"><span data-stu-id="c64a2-124">Call [**IVssBackupComponents::GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata) to initiate asynchronous contact with writers.</span></span>
7.  <span data-ttu-id="c64a2-125">Llame a [**IVssBackupComponents:: GetWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritermetadata) para recuperar el documento de metadatos del escritor del escritor de ASR.</span><span class="sxs-lookup"><span data-stu-id="c64a2-125">Call [**IVssBackupComponents::GetWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritermetadata) to retrieve the ASR writer's Writer Metadata Document.</span></span> <span data-ttu-id="c64a2-126">El ID. de escritor del escritor de ASR es BE000CBE-11FE-4426-9C58-531AA6355FC4 y la cadena de nombre de escritor es "ASR Writer".</span><span class="sxs-lookup"><span data-stu-id="c64a2-126">The writer ID for the ASR writer is BE000CBE-11FE-4426-9C58-531AA6355FC4, and the writer name string is "ASR Writer".</span></span>
8.  <span data-ttu-id="c64a2-127">Llame a [**IVssExamineWriterMetadata:: SaveAsXML**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-saveasxml) para guardar una copia del documento de metadatos del escritor del escritor de ASR.</span><span class="sxs-lookup"><span data-stu-id="c64a2-127">Call [**IVssExamineWriterMetadata::SaveAsXML**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-saveasxml) to save a copy of the ASR writer's Writer Metadata Document.</span></span>
9.  <span data-ttu-id="c64a2-128">Llame a [**IVssBackupComponents:: AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset) para cada volumen que pueda participar en instantáneas para agregar el volumen al conjunto de instantáneas.</span><span class="sxs-lookup"><span data-stu-id="c64a2-128">Call [**IVssBackupComponents::AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset) for each volume that can participate in shadow copies to add the volume to the shadow copy set.</span></span>
10. <span data-ttu-id="c64a2-129">Llame a [**IVssBackupComponents::P repareforbackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) para notificar a los escritores que deben prepararse para una operación de copia de seguridad.</span><span class="sxs-lookup"><span data-stu-id="c64a2-129">Call [**IVssBackupComponents::PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) to notify writers to prepare for a backup operation.</span></span>
11. <span data-ttu-id="c64a2-130">Llame a [**ivssbackupcomponents:: GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) y [**IVssBackupComponents:: GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus) (o [**IVssBackupComponentsEx3:: GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponentsex3-getwriterstatusex)) para comprobar el estado del escritor de ASR.</span><span class="sxs-lookup"><span data-stu-id="c64a2-130">Call [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) and [**IVssBackupComponents::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus) (or [**IVssBackupComponentsEx3::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponentsex3-getwriterstatusex)) to verify the status of the ASR writer.</span></span>
12. <span data-ttu-id="c64a2-131">En este momento, puede consultar los mensajes de error establecidos por el escritor en su método [**CVssWriter:: OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) .</span><span class="sxs-lookup"><span data-stu-id="c64a2-131">At this point, you can query for failure messages that were set by the writer in its [**CVssWriter::OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) method.</span></span> <span data-ttu-id="c64a2-132">Para obtener un ejemplo de código que muestra cómo ver estos mensajes, vea [**IVssComponentEx:: GetPrepareForBackupFailureMsg**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponentex-getprepareforbackupfailuremsg).</span><span class="sxs-lookup"><span data-stu-id="c64a2-132">For example code that shows how to view these messages, see [**IVssComponentEx::GetPrepareForBackupFailureMsg**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponentex-getprepareforbackupfailuremsg).</span></span>
13. <span data-ttu-id="c64a2-133">Llame a [**IVssBackupComponents::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) para crear una instantánea de volumen.</span><span class="sxs-lookup"><span data-stu-id="c64a2-133">Call [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) to create a volume shadow copy.</span></span>
14. <span data-ttu-id="c64a2-134">Llame a [**ivssbackupcomponents:: GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) y [**IVssBackupComponents:: GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus) para comprobar el estado del escritor de ASR.</span><span class="sxs-lookup"><span data-stu-id="c64a2-134">Call [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) and [**IVssBackupComponents::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus) to verify the status of the ASR writer.</span></span>
15. <span data-ttu-id="c64a2-135">Realice una copia de seguridad de los datos.</span><span class="sxs-lookup"><span data-stu-id="c64a2-135">Back up the data.</span></span>
16. <span data-ttu-id="c64a2-136">Indica si la operación de copia de seguridad se realizó correctamente llamando a [**IVssBackupComponents:: SetBackupSucceeded**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupsucceeded).</span><span class="sxs-lookup"><span data-stu-id="c64a2-136">Indicate whether the backup operation succeeded by calling [**IVssBackupComponents::SetBackupSucceeded**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupsucceeded).</span></span>
17. <span data-ttu-id="c64a2-137">Llame a [**IVssBackupComponents:: BackupComplete**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete) para indicar que se ha completado la operación de copia de seguridad.</span><span class="sxs-lookup"><span data-stu-id="c64a2-137">Call [**IVssBackupComponents::BackupComplete**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete) to indicate that the backup operation has completed.</span></span>
18. <span data-ttu-id="c64a2-138">Llame a [**ivssbackupcomponents:: GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) y [**IVssBackupComponents:: GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus).</span><span class="sxs-lookup"><span data-stu-id="c64a2-138">Call [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) and [**IVssBackupComponents::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus).</span></span> <span data-ttu-id="c64a2-139">La memoria de estado de sesión del escritor es un recurso limitado y los escritores deben volver a usar los Estados de sesión.</span><span class="sxs-lookup"><span data-stu-id="c64a2-139">The writer session state memory is a limited resource, and writers must eventually reuse session states.</span></span> <span data-ttu-id="c64a2-140">Este paso marca el estado de la sesión de copia de seguridad del escritor como completado e informa a VSS de que esta ranura de sesión de copia de seguridad se puede volver a usar en una operación de copia de seguridad posterior.</span><span class="sxs-lookup"><span data-stu-id="c64a2-140">This step marks the writer’s backup session state as completed and notifies VSS that this backup session slot can be reused by a subsequent backup operation.</span></span>
    > [!Note]  
    > <span data-ttu-id="c64a2-141">Esto solo es necesario en Windows Server 2008 con Service Pack 2 (SP2) y versiones anteriores.</span><span class="sxs-lookup"><span data-stu-id="c64a2-141">This is only necessary on Windows Server 2008 with Service Pack 2 (SP2) and earlier.</span></span>

     

19. <span data-ttu-id="c64a2-142">Llame a [**IVssBackupComponents:: SaveAsXML**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-saveasxml) para guardar una copia del documento de componentes de copia de seguridad del solicitante.</span><span class="sxs-lookup"><span data-stu-id="c64a2-142">Call [**IVssBackupComponents::SaveAsXML**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-saveasxml) to save a copy of the requester's Backup Components Document.</span></span> <span data-ttu-id="c64a2-143">La información del documento componentes de copia de seguridad se usa en el momento de la restauración cuando el solicitante llama al método [**IVssBackupComponents:: InitializeForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore) .</span><span class="sxs-lookup"><span data-stu-id="c64a2-143">The information in the Backup Components Document is used at restore time when the requester calls the [**IVssBackupComponents::InitializeForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore) method.</span></span>

## <a name="choosing-which-critical-components-to-back-up"></a><span data-ttu-id="c64a2-144">Elección de los componentes críticos de la copia de seguridad</span><span class="sxs-lookup"><span data-stu-id="c64a2-144">Choosing Which Critical Components to Back Up</span></span>

<span data-ttu-id="c64a2-145">En la fase de inicialización de la copia de seguridad, el escritor de ASR informa de los siguientes tipos de componentes en su documento de metadatos de escritura:</span><span class="sxs-lookup"><span data-stu-id="c64a2-145">In the backup initialization phase, the ASR writer reports the following types of components in its Writer Metadata Document:</span></span>

-   <span data-ttu-id="c64a2-146">Volúmenes críticos, como los volúmenes de arranque, sistema y entorno de recuperación de Windows (Windows RE) y la partición de Windows RE asociada a la instancia de Windows Vista o Windows Server 2008 que se está ejecutando actualmente.</span><span class="sxs-lookup"><span data-stu-id="c64a2-146">Critical volumes, such as the boot, system, and Windows Recovery Environment (Windows RE) volumes and the Windows RE partition that is associated with the instance of Windows Vista or Windows Server 2008 that is currently running.</span></span> <span data-ttu-id="c64a2-147">Un volumen es un *volumen crítico* si contiene información de estado del sistema.</span><span class="sxs-lookup"><span data-stu-id="c64a2-147">A volume is a *critical volume* if it contains system state information.</span></span> <span data-ttu-id="c64a2-148">Los volúmenes de arranque y del sistema se incluyen automáticamente.</span><span class="sxs-lookup"><span data-stu-id="c64a2-148">The boot and system volumes are included automatically.</span></span> <span data-ttu-id="c64a2-149">El solicitante debe incluir todos los volúmenes que contengan componentes críticos del sistema detectados por escritores, como los volúmenes que contienen el Active Directory.</span><span class="sxs-lookup"><span data-stu-id="c64a2-149">The requester must include all volumes that contain system-critical components reported by writers, such as the volumes that contain the Active Directory.</span></span> <span data-ttu-id="c64a2-150">Los componentes críticos del sistema se marcan como "no seleccionable para copia de seguridad".</span><span class="sxs-lookup"><span data-stu-id="c64a2-150">System-critical components are marked as "not selectable for backup."</span></span> <span data-ttu-id="c64a2-151">En VSS, "no seleccionable" significa "no opcional".</span><span class="sxs-lookup"><span data-stu-id="c64a2-151">In VSS, "not selectable" means "not optional."</span></span> <span data-ttu-id="c64a2-152">Por lo tanto, se requiere que el solicitante realice una copia de seguridad de ellos como parte del estado del sistema.</span><span class="sxs-lookup"><span data-stu-id="c64a2-152">Thus, the requester is required to back them up as part of system state.</span></span> <span data-ttu-id="c64a2-153">Para obtener más información, consulte [copia de seguridad y restauración del estado del sistema](locating-additional-system-files.md).</span><span class="sxs-lookup"><span data-stu-id="c64a2-153">For more information, see [Backing Up and Restoring System State](locating-additional-system-files.md).</span></span> <span data-ttu-id="c64a2-154">Los componentes para los que \_ se establece la marca de estado CF de VSS \_ no \_ son críticos para el \_ sistema.</span><span class="sxs-lookup"><span data-stu-id="c64a2-154">Components for which the VSS\_CF\_NOT\_SYSTEM\_STATE flag is set are not system-critical.</span></span>
    > [!Note]  
    > <span data-ttu-id="c64a2-155">El componente ASR es un componente crítico para el sistema que es detectado por el escritor de ASR.</span><span class="sxs-lookup"><span data-stu-id="c64a2-155">The ASR component is a system-critical component that is reported by the ASR writer.</span></span>

     

-   <span data-ttu-id="c64a2-156">Disco.</span><span class="sxs-lookup"><span data-stu-id="c64a2-156">Disks.</span></span> <span data-ttu-id="c64a2-157">Cada disco fijo del equipo se expone como componente en ASR.</span><span class="sxs-lookup"><span data-stu-id="c64a2-157">Every fixed disk on the computer is exposed as a component in ASR.</span></span> <span data-ttu-id="c64a2-158">Si un disco no se ha excluido durante la copia de seguridad, se asignará durante la restauración y se podrá volver a crear y formatear.</span><span class="sxs-lookup"><span data-stu-id="c64a2-158">If a disk was not excluded during backup, it will be assigned during restore and can be re-created and reformatted.</span></span> <span data-ttu-id="c64a2-159">Tenga en cuenta que durante la restauración, el solicitante puede volver a crear un disco que se ha excluido durante la copia de seguridad llamando al método [**IVssBackupComponents:: SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) .</span><span class="sxs-lookup"><span data-stu-id="c64a2-159">Note that during restore, the requester can still re-create a disk that was excluded during backup by calling the [**IVssBackupComponents::SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) method.</span></span> <span data-ttu-id="c64a2-160">Si se selecciona un disco en un paquete de disco dinámico, también se deben seleccionar todos los demás discos de ese paquete.</span><span class="sxs-lookup"><span data-stu-id="c64a2-160">If one disk in a dynamic disk pack is selected, all other disks in that pack must also be selected.</span></span> <span data-ttu-id="c64a2-161">Si se selecciona un volumen porque es un volumen crítico (es decir, un volumen que contiene información de estado del sistema), también se deben seleccionar todos los discos que contengan una extensión para ese volumen.</span><span class="sxs-lookup"><span data-stu-id="c64a2-161">If a volume is selected because it is a critical volume (that is, a volume that contains system state information), every disk that contains an extent for that volume must also be selected.</span></span> <span data-ttu-id="c64a2-162">Para buscar las extensiones de un volumen, use el código de control de [**volumen de ioctl \_ \_ Get \_ Volume \_ \_ extents**](/windows/win32/api/winioctl/ni-winioctl-ioctl_volume_get_volume_disk_extents) .</span><span class="sxs-lookup"><span data-stu-id="c64a2-162">To find the extents for a volume, use the [**IOCTL\_VOLUME\_GET\_VOLUME\_DISK\_EXTENTS**](/windows/win32/api/winioctl/ni-winioctl-ioctl_volume_get_volume_disk_extents) control code.</span></span>

    > [!Note]  
    > <span data-ttu-id="c64a2-163">Durante la copia de seguridad, el solicitante debe incluir todos los discos fijos.</span><span class="sxs-lookup"><span data-stu-id="c64a2-163">During backup, the requester should include all fixed disks.</span></span> <span data-ttu-id="c64a2-164">Si el disco que contiene el conjunto de copia de seguridad del solicitante es un disco local, se debe incluir este disco.</span><span class="sxs-lookup"><span data-stu-id="c64a2-164">If the disk that contains the requester's backup set is a local disk, this disk should be included.</span></span> <span data-ttu-id="c64a2-165">Durante la restauración, el solicitante debe excluir el disco que contiene el conjunto de copia de seguridad del solicitante para evitar que se sobrescriba.</span><span class="sxs-lookup"><span data-stu-id="c64a2-165">During restore, the requester must exclude the disk that contains the requester's backup set to prevent it from being overwritten.</span></span>

     

    <span data-ttu-id="c64a2-166">En un entorno de clústeres, ASR no vuelve a crear el diseño de los discos compartidos del clúster.</span><span class="sxs-lookup"><span data-stu-id="c64a2-166">In a clustering environment, ASR does not re-create the layout of the cluster's shared disks.</span></span> <span data-ttu-id="c64a2-167">Esos discos deben restaurarse en línea después de restaurar el sistema operativo en Windows RE.</span><span class="sxs-lookup"><span data-stu-id="c64a2-167">Those disks should be restored online after the operating system is restored in the Windows RE.</span></span>

-   <span data-ttu-id="c64a2-168">Almacén datos de la configuración de arranque (BCD) (BCD).</span><span class="sxs-lookup"><span data-stu-id="c64a2-168">Boot Configuration Data (BCD) store.</span></span> <span data-ttu-id="c64a2-169">Este componente especifica la ruta de acceso del directorio que contiene el almacén BCD.</span><span class="sxs-lookup"><span data-stu-id="c64a2-169">This component specifies the path of the directory that contains the BCD store.</span></span> <span data-ttu-id="c64a2-170">El solicitante debe especificar este componente y realizar una copia de seguridad de todos los archivos del directorio del almacén BCD.</span><span class="sxs-lookup"><span data-stu-id="c64a2-170">The requester must specify this component and back up all of the files in the BCD store directory.</span></span> <span data-ttu-id="c64a2-171">Para obtener más información sobre el almacén BCD, consulte [acerca de BCD](/previous-versions/windows/desktop/bcd/about-bcd).</span><span class="sxs-lookup"><span data-stu-id="c64a2-171">For more information about the BCD store, see [About BCD](/previous-versions/windows/desktop/bcd/about-bcd).</span></span>
    > [!Note]  
    > <span data-ttu-id="c64a2-172">En los equipos que usan la interfaz de firmware extendido (EFI), la partición del sistema EFI (ESP) siempre está oculta y no se puede incluir en una instantánea de volumen.</span><span class="sxs-lookup"><span data-stu-id="c64a2-172">On computers that use the Extended Firmware Interface (EFI), the EFI System Partition (ESP) is always hidden and cannot be included in a volume shadow copy.</span></span> <span data-ttu-id="c64a2-173">El solicitante debe realizar una copia de seguridad del contenido de esta partición.</span><span class="sxs-lookup"><span data-stu-id="c64a2-173">The requester must back up the contents of this partition.</span></span> <span data-ttu-id="c64a2-174">Dado que esta partición no se puede incluir en una instantánea de volumen, la copia de seguridad solo se puede realizar desde el volumen activo, no desde la instantánea.</span><span class="sxs-lookup"><span data-stu-id="c64a2-174">Because this partition cannot be included in a volume shadow copy, the backup can only be performed from the live volume, not from the shadow copy.</span></span> <span data-ttu-id="c64a2-175">Para obtener más información acerca de EFI y ESP, consulte la [Guía de introducción](/windows-hardware/drivers/bringup/).</span><span class="sxs-lookup"><span data-stu-id="c64a2-175">For more information about EFI and ESP, see [Bring up guide](/windows-hardware/drivers/bringup/).</span></span>

<span data-ttu-id="c64a2-176">Los nombres de componente usan los formatos siguientes:</span><span class="sxs-lookup"><span data-stu-id="c64a2-176">The component names use the following formats:</span></span>

-   <span data-ttu-id="c64a2-177">En el caso de los componentes de disco, el formato es</span><span class="sxs-lookup"><span data-stu-id="c64a2-177">For disk components, the format is</span></span>

    <COMPONENT logicalPath="Disks" componentName="harddisk*n*" componentType="filegroup" />

    <span data-ttu-id="c64a2-178">donde *n* es el número de disco.</span><span class="sxs-lookup"><span data-stu-id="c64a2-178">where *n* is the disk number.</span></span> <span data-ttu-id="c64a2-179">Solo se registra el número de disco.</span><span class="sxs-lookup"><span data-stu-id="c64a2-179">Only the disk number is recorded.</span></span> <span data-ttu-id="c64a2-180">Para obtener el número de disco, use el código de control de [**\_ \_ \_ \_ número de dispositivo de almacenamiento de ioctl**](/windows/win32/api/winioctl/ni-winioctl-ioctl_storage_get_device_number) .</span><span class="sxs-lookup"><span data-stu-id="c64a2-180">To get the disk number, use the [**IOCTL\_STORAGE\_GET\_DEVICE\_NUMBER**](/windows/win32/api/winioctl/ni-winioctl-ioctl_storage_get_device_number) control code.</span></span>

-   <span data-ttu-id="c64a2-181">En el caso de los componentes de volumen, el formato es</span><span class="sxs-lookup"><span data-stu-id="c64a2-181">For volume components, the format is</span></span>

    <COMPONENT logicalPath="Volumes" componentName="Volume{*GUID*}" componentType="filegroup" />

    <span data-ttu-id="c64a2-182">donde *GUID* es el GUID del volumen.</span><span class="sxs-lookup"><span data-stu-id="c64a2-182">where *GUID* is the volume GUID.</span></span>

-   <span data-ttu-id="c64a2-183">En el caso del componente de almacén BCD, el formato es</span><span class="sxs-lookup"><span data-stu-id="c64a2-183">For the BCD store component, the format is</span></span>

    <COMPONENT logicalPath="BCD" componentName="BCD" componentType="filegroup" componentCaption = "This is the path to the boot BCD store and the boot managers...All the files in this directory need to be backed up...">

    <span data-ttu-id="c64a2-184">Si la partición del sistema tiene un nombre de GUID de volumen, este componente es seleccionable.</span><span class="sxs-lookup"><span data-stu-id="c64a2-184">If the system partition has a volume GUID name, this component is selectable.</span></span> <span data-ttu-id="c64a2-185">De lo contrario, no es seleccionable.</span><span class="sxs-lookup"><span data-stu-id="c64a2-185">Otherwise, it is not selectable.</span></span>

    > [!Note]  
    > <span data-ttu-id="c64a2-186">ASR agrega los archivos al grupo de archivos del componente de almacén BCD como se indica a continuación:</span><span class="sxs-lookup"><span data-stu-id="c64a2-186">ASR adds the files to the BCD store component's file group as follows:</span></span>
    >
    > -   <span data-ttu-id="c64a2-187">Para los discos EFI, ASR agrega</span><span class="sxs-lookup"><span data-stu-id="c64a2-187">For EFI disks, ASR adds</span></span>
    >
    >     <span data-ttu-id="c64a2-188">*SystemPartitionPath* \\ Arranque de EFI de \\ Microsoft \\ \\ \* .\*</span><span class="sxs-lookup"><span data-stu-id="c64a2-188">*SystemPartitionPath*\\EFI\\Microsoft\\Boot\\\*.\*</span></span>
    >
    >     <span data-ttu-id="c64a2-189">donde *SystemPartitionPath* es la ruta de acceso a la partición del sistema.</span><span class="sxs-lookup"><span data-stu-id="c64a2-189">where *SystemPartitionPath* is the path to the system partition.</span></span>
    >
    > -   <span data-ttu-id="c64a2-190">Para discos GPT, ASR agrega</span><span class="sxs-lookup"><span data-stu-id="c64a2-190">For GPT disks, ASR adds</span></span>
    >
    >     <span data-ttu-id="c64a2-191">*SystemPartitionPath* \\ Arranque \\ \* .\*</span><span class="sxs-lookup"><span data-stu-id="c64a2-191">*SystemPartitionPath*\\Boot\\\*.\*</span></span>
    >
    >     <span data-ttu-id="c64a2-192">donde *SystemPartitionPath* es la ruta de acceso a la partición del sistema.</span><span class="sxs-lookup"><span data-stu-id="c64a2-192">where *SystemPartitionPath* is the path to the system partition.</span></span>
    >
    > -   <span data-ttu-id="c64a2-193">La ruta de acceso de la partición del sistema se puede encontrar en la siguiente clave del registro: **HKEY \_ local \_ Machine** \\ **System** \\ **setup** \\ **SystemPartition**</span><span class="sxs-lookup"><span data-stu-id="c64a2-193">The system partition path can be found under the following registry key: **HKEY\_LOCAL\_MACHINE**\\**System**\\**Setup**\\**SystemPartition**</span></span>

     

<span data-ttu-id="c64a2-194">En la restauración, se deben restaurar todos los componentes marcados como volúmenes críticos.</span><span class="sxs-lookup"><span data-stu-id="c64a2-194">On restore, all components that are marked as critical volumes must be restored.</span></span> <span data-ttu-id="c64a2-195">Si no se pueden restaurar uno o más volúmenes críticos, se produce un error en la operación de restauración.</span><span class="sxs-lookup"><span data-stu-id="c64a2-195">If one or more critical volumes cannot be restored, the restore operation fails.</span></span>

<span data-ttu-id="c64a2-196">En la fase de [**prerestauración**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) de la secuencia de restauración, los discos que no se excluyeron durante la copia de seguridad se vuelven a crear y se cambian de formato de forma predeterminada.</span><span class="sxs-lookup"><span data-stu-id="c64a2-196">In the [**PreRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) phase of the restore sequence, disks that were not excluded during backup are re-created and reformatted by default.</span></span> <span data-ttu-id="c64a2-197">Sin embargo, no se vuelven a crear ni se les vuelve a dar formato si cumplen las condiciones siguientes:</span><span class="sxs-lookup"><span data-stu-id="c64a2-197">However, they are not re-created or reformatted if they meet the following conditions:</span></span>

-   <span data-ttu-id="c64a2-198">Un disco básico no se vuelve a crear si el diseño del disco está intacto o solo se han realizado cambios aditivos en él.</span><span class="sxs-lookup"><span data-stu-id="c64a2-198">A basic disk is not re-created if its disk layout is intact or only additive changes have been made to it.</span></span> <span data-ttu-id="c64a2-199">El diseño del disco está intacto si se cumplen las condiciones siguientes:</span><span class="sxs-lookup"><span data-stu-id="c64a2-199">The disk layout is intact if the following conditions are true:</span></span>
    -   <span data-ttu-id="c64a2-200">La firma de disco, el estilo de disco (GPT o MBR), el tamaño de sector lógico y el desplazamiento de inicio de volumen no cambian.</span><span class="sxs-lookup"><span data-stu-id="c64a2-200">The disk signature, disk style (GPT or MBR), logical sector size, and volume start offset are not changed.</span></span>
    -   <span data-ttu-id="c64a2-201">No se reduce el tamaño del volumen.</span><span class="sxs-lookup"><span data-stu-id="c64a2-201">The volume size is not decreased.</span></span>
    -   <span data-ttu-id="c64a2-202">En el caso de los discos GPT, no se cambia el identificador de la partición.</span><span class="sxs-lookup"><span data-stu-id="c64a2-202">For GPT disks, the partition identifier is not changed.</span></span>
-   <span data-ttu-id="c64a2-203">Un disco dinámico no se vuelve a crear si el diseño del disco está intacto o solo se han realizado cambios aditivos en él.</span><span class="sxs-lookup"><span data-stu-id="c64a2-203">A dynamic disk is not re-created if its disk layout is intact or only additive changes have been made to it.</span></span> <span data-ttu-id="c64a2-204">Para que un disco dinámico quede intacto, deben cumplirse todas las condiciones de un disco básico.</span><span class="sxs-lookup"><span data-stu-id="c64a2-204">For a dynamic disk to be intact, all of the conditions for a basic disk must be met.</span></span> <span data-ttu-id="c64a2-205">Además, la estructura de volumen de todo el paquete de disco debe estar intacta.</span><span class="sxs-lookup"><span data-stu-id="c64a2-205">In addition, the entire disk pack's volume structure must be intact.</span></span> <span data-ttu-id="c64a2-206">La estructura de volumen del paquete de disco está intacta si cumple las siguientes condiciones, que se aplican a los discos MBR y GPT:</span><span class="sxs-lookup"><span data-stu-id="c64a2-206">The disk pack's volume structure is intact if it meets the following conditions, which apply to both MBR and GPT disks:</span></span>
    -   <span data-ttu-id="c64a2-207">El número de volúmenes que están disponibles en el paquete físico durante la restauración debe ser mayor o igual que el número de volúmenes que se especificaron en los metadatos del escritor de ASR durante la copia de seguridad.</span><span class="sxs-lookup"><span data-stu-id="c64a2-207">The number of volumes that are available in the physical pack during restore must be greater than or equal to the number of volumes that were specified in the ASR writer metadata during backup.</span></span>
    -   <span data-ttu-id="c64a2-208">El número de [*complejos*](../vds/virtual-disk-service-glossary-all.md) por volumen debe ser inalterado.</span><span class="sxs-lookup"><span data-stu-id="c64a2-208">The number of [*plexes*](../vds/virtual-disk-service-glossary-all.md) per volume must be unchanged.</span></span>
    -   <span data-ttu-id="c64a2-209">El número de [*miembros*](../vds/virtual-disk-service-glossary-all.md) no debe modificarse.</span><span class="sxs-lookup"><span data-stu-id="c64a2-209">The number of [*members*](../vds/virtual-disk-service-glossary-all.md) must be unchanged.</span></span>
    -   <span data-ttu-id="c64a2-210">El número de extensiones de disco físico debe ser mayor que el número de extensiones de disco especificado en los metadatos del escritor de ASR.</span><span class="sxs-lookup"><span data-stu-id="c64a2-210">The number of physical disk extents must be greater than the number of disk extents specified in the ASR writer metadata.</span></span>
    -   <span data-ttu-id="c64a2-211">Un paquete intacto permanece intacto cuando se agregan volúmenes adicionales o si se extiende un volumen del paquete (por ejemplo, de un volumen simple a un volumen distribuido).</span><span class="sxs-lookup"><span data-stu-id="c64a2-211">An intact pack remains intact when additional volumes are added, or if a volume in the pack is extended (for example, from a simple volume to a spanned volume).</span></span>
        > [!Note]  
        > <span data-ttu-id="c64a2-212">Si un volumen simple está reflejado, el paquete no está intacto y se volverá a crear para asegurarse de que los BCD y el estado del volumen de arranque siguen siendo coherentes después de la restauración.</span><span class="sxs-lookup"><span data-stu-id="c64a2-212">If a simple volume is mirrored, the pack is not intact and will be re-created to ensure that the BCD and boot volume state remain consistent after restore.</span></span> <span data-ttu-id="c64a2-213">Si se eliminan los volúmenes, se vuelve a crear el paquete.</span><span class="sxs-lookup"><span data-stu-id="c64a2-213">If volumes are deleted, the pack is re-created.</span></span>

         
-   <span data-ttu-id="c64a2-214">Si la estructura de volumen del paquete de disco dinámico está intacta y solo se han realizado cambios aditivos en ella, los discos del módulo no se vuelven a crear.</span><span class="sxs-lookup"><span data-stu-id="c64a2-214">If the dynamic disk pack's volume structure is intact and only additive changes have been made to it, the disks in the pack are not re-created.</span></span>

    <span data-ttu-id="c64a2-215">**Windows Vista:** Los discos dinámicos siempre se vuelven a crear.</span><span class="sxs-lookup"><span data-stu-id="c64a2-215">**Windows Vista:** Dynamic disks are always re-created.</span></span> <span data-ttu-id="c64a2-216">Tenga en cuenta que este comportamiento ha cambiado con Windows Server 2008 y Windows Vista con Service Pack 1 (SP1).</span><span class="sxs-lookup"><span data-stu-id="c64a2-216">Note that this behavior has changed with Windows Server 2008 and Windows Vista with Service Pack 1 (SP1).</span></span>

<span data-ttu-id="c64a2-217">En cualquier momento antes del comienzo de la fase de restauración, el solicitante puede especificar que los discos deben tener un formato rápido estableciendo la clave del registro **HKEY \_ local \_ Machine** \\ **software** \\ **Microsoft** \\ **Windows NT** \\ **CurrentVersion** \\ **ASR** \\ **RestoreSession** .</span><span class="sxs-lookup"><span data-stu-id="c64a2-217">At any time before the beginning of the restore phase, the requester can specify that the disks should be quick-formatted by setting the **HKEY\_LOCAL\_MACHINE**\\**SOFTWARE**\\**Microsoft**\\**Windows NT**\\**CurrentVersion**\\**ASR**\\**RestoreSession** registry key.</span></span> <span data-ttu-id="c64a2-218">Bajo esta clave, hay un valor denominado **QuickFormat** con el tipo de datos reg \_ DWORD.</span><span class="sxs-lookup"><span data-stu-id="c64a2-218">Under this key, there is a value named **QuickFormat** with the data type REG\_DWORD.</span></span> <span data-ttu-id="c64a2-219">Si este valor no existe, debe crearlo.</span><span class="sxs-lookup"><span data-stu-id="c64a2-219">If this value does not exist, you should create it.</span></span> <span data-ttu-id="c64a2-220">Establezca los datos del valor de **QuickFormat** en 1 para el formato rápido o 0 para el formato lento.</span><span class="sxs-lookup"><span data-stu-id="c64a2-220">Set the data of the **QuickFormat** value to 1 for quick formatting or 0 for slow formatting.</span></span>

<span data-ttu-id="c64a2-221">Si el valor **QuickFormat** no existe, los discos tendrán un formato lento.</span><span class="sxs-lookup"><span data-stu-id="c64a2-221">If the **QuickFormat** value does not exist, the disks will be slow-formatted.</span></span>

<span data-ttu-id="c64a2-222">El formato rápido es mucho más rápido que el formato lento (también denominado formato completo).</span><span class="sxs-lookup"><span data-stu-id="c64a2-222">Quick formatting is significantly faster than slow formatting (also called full formatting).</span></span> <span data-ttu-id="c64a2-223">Sin embargo, el formato rápido no comprueba cada sector del volumen.</span><span class="sxs-lookup"><span data-stu-id="c64a2-223">However, quick formatting does not verify each sector on the volume.</span></span>

## <a name="overview-of-restore-phase-tasks"></a><span data-ttu-id="c64a2-224">Información general sobre las tareas de la fase de restauración</span><span class="sxs-lookup"><span data-stu-id="c64a2-224">Overview of Restore Phase Tasks</span></span>

<span data-ttu-id="c64a2-225">En el momento de la restauración, el solicitante realiza los siguientes pasos:</span><span class="sxs-lookup"><span data-stu-id="c64a2-225">At restore time, the requester performs the following steps:</span></span>

> [!Note]  
> <span data-ttu-id="c64a2-226">Todos los pasos son necesarios a menos que se indique lo contrario.</span><span class="sxs-lookup"><span data-stu-id="c64a2-226">All steps are required unless otherwise indicated.</span></span>

 

1.  <span data-ttu-id="c64a2-227">Llame a la función [**CreateVssBackupComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssbackupcomponents) para crear una instancia de la interfaz [**ivssbackupcomponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) y llamar al método [**IVssBackupComponents:: InitializeForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore) para inicializar la instancia para la restauración mediante la carga del documento de componentes de copia de seguridad del solicitante en la instancia.</span><span class="sxs-lookup"><span data-stu-id="c64a2-227">Call the [**CreateVssBackupComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssbackupcomponents) function to create an instance of the [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) interface and call the [**IVssBackupComponents::InitializeForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore) method to initialize the instance for restore by loading the requester's Backup Components Document into the instance.</span></span>
2.  <span data-ttu-id="c64a2-228">\[Este paso solo es necesario si el solicitante debe cambiar si se especifica "IncludeDisk" o "ExcludeDisk" para uno o varios discos. \] Llame a [**IVssBackupComponents:: SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) para establecer las opciones de restauración de los componentes del escritor de ASR.</span><span class="sxs-lookup"><span data-stu-id="c64a2-228">\[This step is required only if the requester needs to change whether "IncludeDisk" or "ExcludeDisk" is specified for one or more disks.\] Call [**IVssBackupComponents::SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) to set the restore options for the ASR writer components.</span></span> <span data-ttu-id="c64a2-229">El escritor de ASR admite las siguientes opciones: "IncludeDisk" permite que el solicitante incluya un disco en el sistema de destino que se va a considerar para la restauración, aunque no se haya seleccionado durante la fase de copia de seguridad.</span><span class="sxs-lookup"><span data-stu-id="c64a2-229">The ASR writer supports the following options: "IncludeDisk" allows the requester to include a disk on the target system to be considered for restore, even if it was not selected during the backup phase.</span></span> <span data-ttu-id="c64a2-230">"ExcludeDisk" permite al solicitante impedir que se vuelva a crear un disco en el sistema de destino.</span><span class="sxs-lookup"><span data-stu-id="c64a2-230">"ExcludeDisk" allows the requester to prevent a disk on the target system from being re-created.</span></span> <span data-ttu-id="c64a2-231">Tenga en cuenta que si se especifica "ExcludeDisk" para un disco que contiene un volumen crítico, se producirá un error en la siguiente llamada a [**IVssBackupComponents::P Rerestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) .</span><span class="sxs-lookup"><span data-stu-id="c64a2-231">Note that if "ExcludeDisk" is specified for a disk that contains a critical volume, the subsequent call to [**IVssBackupComponents::PreRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) will fail.</span></span>

    <span data-ttu-id="c64a2-232">En el ejemplo siguiente se muestra cómo usar [**SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) para evitar que se vuelvan a crear el disco 0 y el disco 1, así como para inyectar controladores de terceros en el volumen de arranque restaurado.</span><span class="sxs-lookup"><span data-stu-id="c64a2-232">The following example shows how to use [**SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) to prevent disk 0 and disk 1 from being re-created and inject third-party drivers into the restored boot volume.</span></span>

    <span data-ttu-id="c64a2-233">**Windows server 2008, Windows Vista, Windows server 2003 y Windows XP:** No se admite la inyección de controladores de terceros.</span><span class="sxs-lookup"><span data-stu-id="c64a2-233">**Windows Server 2008, Windows Vista, Windows Server 2003 and Windows XP:** Injection of third-party drivers is not supported.</span></span>

    <span data-ttu-id="c64a2-234">En el ejemplo se da por supuesto que el puntero [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) , m \_ pBackupComponents, es válido.</span><span class="sxs-lookup"><span data-stu-id="c64a2-234">The example assumes that the [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) pointer, m\_pBackupComponents, is valid.</span></span>

    ```C++
        m_pBackupComponents->SetRestoreOptions(
            AsrWriterId,
            VSS_CT_FILEGROUP,
            NULL,
            TEXT("ASR"),
            TEXT("\"ExcludeDisk\"=\"0\", \"ExcludeDisk\"=\"1\" "),
            TEXT("\"InjectDrivers\"=\"1\" ")
            );
    ```

    

    <span data-ttu-id="c64a2-235">Para excluir todos los discos de un volumen especificado, consulte la siguiente sección "excluir todos los discos de un volumen".</span><span class="sxs-lookup"><span data-stu-id="c64a2-235">To exclude all disks for a specified volume, see the following "Excluding All Disks for a Volume."</span></span>

3.  <span data-ttu-id="c64a2-236">Llame a [**IVssBackupComponents::P**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) volver a restaurar para notificar al escritor de ASR que debe prepararse para una operación de restauración.</span><span class="sxs-lookup"><span data-stu-id="c64a2-236">Call [**IVssBackupComponents::PreRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) to notify the ASR writer to prepare for a restore operation.</span></span> <span data-ttu-id="c64a2-237">Llame a [**IVssAsync:: QueryStatus**](/windows/desktop/api/Vss/nf-vss-ivssasync-querystatus) tantas veces como sea necesario hasta que el valor de estado devuelto en el parámetro *pHrResult* no esté pendiente de VSS \_ S \_ Async \_ .</span><span class="sxs-lookup"><span data-stu-id="c64a2-237">Call [**IVssAsync::QueryStatus**](/windows/desktop/api/Vss/nf-vss-ivssasync-querystatus) as many times as necessary until the status value returned in the *pHrResult* parameter is not VSS\_S\_ASYNC\_PENDING.</span></span>
4.  <span data-ttu-id="c64a2-238">Restaure los datos.</span><span class="sxs-lookup"><span data-stu-id="c64a2-238">Restore the data.</span></span> <span data-ttu-id="c64a2-239">En la fase de restauración, ASR vuelve a configurar la ruta de acceso del GUID del volumen ( \\ \\ ? \\ Volumen {GUID}) de cada volumen para que coincida con la ruta de acceso del GUID del volumen que se usó durante la fase de copia de seguridad.</span><span class="sxs-lookup"><span data-stu-id="c64a2-239">In the restore phase, ASR reconfigures the volume GUID path (\\\\?\\Volume{GUID}) for each volume to match the volume GUID path that was used during the backup phase.</span></span> <span data-ttu-id="c64a2-240">No obstante, las letras de unidad no se conservan, ya que esto provocaría colisiones con las letras de unidad que se asignan automáticamente en el entorno de recuperación.</span><span class="sxs-lookup"><span data-stu-id="c64a2-240">However, drive letters are not preserved, because this would cause collisions with the drive letters that are automatically assigned in the recovery environment.</span></span> <span data-ttu-id="c64a2-241">Por lo tanto, al restaurar los datos, el solicitante debe usar las rutas de acceso de GUID de volumen, no las letras de unidad, para acceder a los volúmenes.</span><span class="sxs-lookup"><span data-stu-id="c64a2-241">Thus, when restoring data, the requester must use volume GUID paths, not drive letters, to access the volumes.</span></span>
5.  <span data-ttu-id="c64a2-242">Establezca la  \\  \\ clave del registro HKLM software **Microsoft** \\ **Windows NT** \\ **CurrentVersion** \\ **ASR** \\ **RestoreSession** para indicar el conjunto de volúmenes que se han restaurado o cambiado de formato.</span><span class="sxs-lookup"><span data-stu-id="c64a2-242">Set the **HKLM**\\**SOFTWARE**\\**Microsoft**\\**Windows NT**\\**CurrentVersion**\\**ASR**\\**RestoreSession** registry key to indicate the set of volumes that have been restored or reformatted.</span></span>

    <span data-ttu-id="c64a2-243">Bajo esta clave, hay un valor denominado **RestoredVolumes** con el tipo de datos reg \_ multi \_ SZ.</span><span class="sxs-lookup"><span data-stu-id="c64a2-243">Under this key, there is a value named **RestoredVolumes** with the data type REG\_MULTI\_SZ.</span></span> <span data-ttu-id="c64a2-244">Si este valor no existe, debe crearlo.</span><span class="sxs-lookup"><span data-stu-id="c64a2-244">If this value does not exist, you should create it.</span></span> <span data-ttu-id="c64a2-245">En este valor, el solicitante debe crear una entrada de GUID de volumen para cada volumen que se ha restaurado.</span><span class="sxs-lookup"><span data-stu-id="c64a2-245">Under this value, your requester should create a volume GUID entry for each volume that has been restored.</span></span> <span data-ttu-id="c64a2-246">Esta entrada debe tener el formato siguiente: \\ \\ ? \\ Volumen {78618c8f-AEFD-11da-a898-806e6f6e6963}.</span><span class="sxs-lookup"><span data-stu-id="c64a2-246">This entry should be in the following format: \\\\?\\Volume{78618c8f-aefd-11da-a898-806e6f6e6963}.</span></span> <span data-ttu-id="c64a2-247">Cada vez que se realiza una reconstrucción completa, ASR establece el valor de **RestoredVolumes** en el conjunto de volúmenes restaurados con ASR.</span><span class="sxs-lookup"><span data-stu-id="c64a2-247">Each time a bare-metal recovery is performed, ASR sets the **RestoredVolumes** value to the set of volumes that ASR restored.</span></span> <span data-ttu-id="c64a2-248">Si el solicitante restauró volúmenes adicionales, debe establecer este valor en la Unión del conjunto de volúmenes restaurado por el solicitante y en el conjunto de volúmenes restaurados con ASR.</span><span class="sxs-lookup"><span data-stu-id="c64a2-248">If the requester restored additional volumes, it should set this value to the union of the set of volumes that the requester restored and the set of volumes that ASR restored.</span></span> <span data-ttu-id="c64a2-249">Si el solicitante no usó ASR, debe reemplazar la lista de volúmenes.</span><span class="sxs-lookup"><span data-stu-id="c64a2-249">If the requester did not use ASR, it should replace the list of volumes.</span></span>

    <span data-ttu-id="c64a2-250">También debe crear un valor denominado **LastInstance** con el tipo de datos reg \_ SZ.</span><span class="sxs-lookup"><span data-stu-id="c64a2-250">You should also create a value named **LastInstance** with the data type REG\_SZ.</span></span> <span data-ttu-id="c64a2-251">Esta clave debe contener una cookie aleatoria que identifique de forma única la operación de restauración actual.</span><span class="sxs-lookup"><span data-stu-id="c64a2-251">This key should contain a random cookie that uniquely identifies the current restore operation.</span></span> <span data-ttu-id="c64a2-252">Esta cookie se puede crear mediante las funciones [**UuidCreate**](/windows/win32/api/rpcdce/nf-rpcdce-uuidcreate) y [**UuidToString**](/windows/win32/api/rpcdce/nf-rpcdce-uuidtostring) .</span><span class="sxs-lookup"><span data-stu-id="c64a2-252">Such a cookie can be created by using the [**UuidCreate**](/windows/win32/api/rpcdce/nf-rpcdce-uuidcreate) and [**UuidToString**](/windows/win32/api/rpcdce/nf-rpcdce-uuidtostring) functions.</span></span> <span data-ttu-id="c64a2-253">Cada vez que se realiza una reconstrucción completa, ASR restablece este valor del registro para notificar a los solicitantes y a las aplicaciones de copia de seguridad que no son de VSS que se ha producido la recuperación.</span><span class="sxs-lookup"><span data-stu-id="c64a2-253">Each time a bare-metal recovery is performed, ASR resets this registry value to notify requesters and non-VSS backup applications that the recovery has occurred.</span></span>

6.  <span data-ttu-id="c64a2-254">Llame a [**IVssBackupComponents::P ostrestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore) para indicar el final de la operación de restauración.</span><span class="sxs-lookup"><span data-stu-id="c64a2-254">Call [**IVssBackupComponents::PostRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore) to indicate the end of the restore operation.</span></span> <span data-ttu-id="c64a2-255">Llame a [**IVssAsync:: QueryStatus**](/windows/desktop/api/Vss/nf-vss-ivssasync-querystatus) tantas veces como sea necesario hasta que el valor de estado devuelto en el parámetro *pHrResult* no esté pendiente de VSS \_ S \_ Async \_ .</span><span class="sxs-lookup"><span data-stu-id="c64a2-255">Call [**IVssAsync::QueryStatus**](/windows/desktop/api/Vss/nf-vss-ivssasync-querystatus) as many times as necessary until the status value returned in the *pHrResult* parameter is not VSS\_S\_ASYNC\_PENDING.</span></span>

<span data-ttu-id="c64a2-256">En la fase de restauración, ASR puede crear o quitar particiones para restaurar el equipo a su estado anterior.</span><span class="sxs-lookup"><span data-stu-id="c64a2-256">In the restore phase, ASR may create or remove partitions to restore the computer to its previous state.</span></span> <span data-ttu-id="c64a2-257">Los solicitantes no deben intentar asignar los números de disco de la fase de copia de seguridad a la fase de restauración.</span><span class="sxs-lookup"><span data-stu-id="c64a2-257">Requesters must not attempt to map disk numbers from the backup phase to the restore phase.</span></span>

<span data-ttu-id="c64a2-258">En la restauración, el solicitante debe excluir el disco que contiene el conjunto de copia de seguridad del solicitante.</span><span class="sxs-lookup"><span data-stu-id="c64a2-258">On restore, the requester must exclude the disk that contains the requester's backup set.</span></span> <span data-ttu-id="c64a2-259">De lo contrario, la operación de restauración puede sobrescribir el conjunto de copia de seguridad.</span><span class="sxs-lookup"><span data-stu-id="c64a2-259">Otherwise, the backup set can be overwritten by the restore operation.</span></span>

<span data-ttu-id="c64a2-260">En la restauración, se excluye un disco si no se seleccionó como componente durante la copia de seguridad, o si se excluye explícitamente mediante una llamada a [**IVssBackupComponents:: SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) con la opción "ExcludeDisk" durante la restauración.</span><span class="sxs-lookup"><span data-stu-id="c64a2-260">On restore, a disk is excluded if it was not selected as a component during backup, or if it is explicitly excluded by calling [**IVssBackupComponents::SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) with the "ExcludeDisk" option during restore.</span></span>

<span data-ttu-id="c64a2-261">Es importante tener en cuenta que durante la recuperación ante desastres de WinPE, la funcionalidad del escritor de ASR está presente, pero no hay ningún otro escritor disponible y el servicio VSS no se está ejecutando.</span><span class="sxs-lookup"><span data-stu-id="c64a2-261">It is important to note that during WinPE disaster recovery, ASR writer functionality is present, but no other writers are available, and the VSS service is not running.</span></span> <span data-ttu-id="c64a2-262">Una vez finalizada la recuperación ante desastres de WinPE, el equipo se ha reiniciado y el sistema operativo Windows se ejecuta con normalidad, se puede iniciar el servicio VSS y el solicitante puede realizar cualquier operación de restauración adicional que requiera la participación de escritores distintos del escritor de ASR.</span><span class="sxs-lookup"><span data-stu-id="c64a2-262">After WinPE disaster recovery has completed, the computer has restarted, and the Windows operating system is running normally, the VSS service can be started, and the requester can perform any additional restore operations that require participation of writers other than the ASR writer.</span></span>

<span data-ttu-id="c64a2-263">Si durante la sesión de restauración la aplicación de copia de seguridad detecta que los identificadores únicos del volumen no han cambiado y, por tanto, todos los volúmenes desde el momento de la copia de seguridad están presentes e intactos en WinPE, la aplicación de copia de seguridad puede continuar para restaurar solo el contenido de los volúmenes, sin necesidad de ASR.</span><span class="sxs-lookup"><span data-stu-id="c64a2-263">If during the restore session the backup application detects that the volume unique IDs are unchanged, and therefore all volumes from the time of the backup are present and intact in WinPE, the backup application can proceed to restore only the contents of the volumes, without involving ASR.</span></span> <span data-ttu-id="c64a2-264">En este caso, la aplicación de copia de seguridad debe indicar que el equipo se restauró mediante la configuración de la siguiente clave del registro en el sistema operativo restaurado: **HKEY \_ local \_ Machine** \\ **software** \\ **Microsoft** \\ **Windows NT** \\ **CurrentVersion** \\ **ASR** \\ **RestoreSession**</span><span class="sxs-lookup"><span data-stu-id="c64a2-264">In this case, the backup application should indicate that the computer was restored by setting the following registry key in the restored operating system: **HKEY\_LOCAL\_MACHINE**\\**SOFTWARE**\\**Microsoft**\\**Windows NT**\\**CurrentVersion**\\**ASR**\\**RestoreSession**</span></span>

<span data-ttu-id="c64a2-265">Bajo esta clave, especifique **LastInstance** para el nombre de valor, REG \_ SZ para el tipo de valor y una cookie aleatoria (como un GUID creado por la función [**UuidCreate**](/windows/win32/api/rpcdce/nf-rpcdce-uuidcreate) ) para los datos del valor.</span><span class="sxs-lookup"><span data-stu-id="c64a2-265">Under this key, specify **LastInstance** for the value name, REG\_SZ for the value type, and a random cookie (such as a GUID created by the [**UuidCreate**](/windows/win32/api/rpcdce/nf-rpcdce-uuidcreate) function) for the value data.</span></span>

<span data-ttu-id="c64a2-266">Si durante la sesión de restauración la aplicación de copia de seguridad detecta que uno o varios volúmenes se han modificado o faltan, la aplicación de copia de seguridad debe usar ASR para realizar la restauración.</span><span class="sxs-lookup"><span data-stu-id="c64a2-266">If during the restore session the backup application detects that one or more volumes are changed or missing, the backup application should use ASR to perform the restore.</span></span> <span data-ttu-id="c64a2-267">ASR volverá a crear los volúmenes exactamente del modo en que se encontraban en el momento de la copia de seguridad y establecerá la clave del registro **RestoreSession** .</span><span class="sxs-lookup"><span data-stu-id="c64a2-267">ASR will re-create the volumes exactly the way they were at the time of the backup and set the **RestoreSession** registry key.</span></span>

## <a name="excluding-all-disks-for-a-volume"></a><span data-ttu-id="c64a2-268">Excluir todos los discos de un volumen</span><span class="sxs-lookup"><span data-stu-id="c64a2-268">Excluding All Disks for a Volume</span></span>

<span data-ttu-id="c64a2-269">En el ejemplo siguiente se muestra cómo excluir todos los discos de un volumen especificado.</span><span class="sxs-lookup"><span data-stu-id="c64a2-269">The following example shows how to exclude all disks for a specified volume.</span></span>


```C++
HRESULT BuildRestoreOptionString
(
    const WCHAR             *pwszVolumeNamePath,
    CMyString               *pstrExclusionList
)
{
    HANDLE                  hVolume           = INVALID_HANDLE_VALUE;
    DWORD                   cbSize            = 0;
    VOLUME_DISK_EXTENTS     * pExtents        = NULL;
    DISK_EXTENT             * pExtent         = NULL;
    ULONG                   i                 = 0;
    BOOL                    fIoRet            = FALSE;
    WCHAR                   wszDest[MAX_PATH] = L"";
    CMyString               strVolumeName;
    CMyString               strRestoreOption;

    // Open a handle to the volume device.
    strVolumeName.Set( pwszVolumeNamePath );
    // If the volume name contains a trailing backslash, remove it.
    strVolumeName.UnTrailing( L'\\' );
    hVolume = ::CreateFile(strVolumeName, 0, FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, OPEN_EXISTING, NULL, 0);
    // Check whether the call to CreateFile succeeded.

    // Get the list of disks used by this volume.
    cbSize = sizeof(VOLUME_DISK_EXTENTS);
    pExtents = (VOLUME_DISK_EXTENTS *)::CoTaskMemAlloc(cbSize);

    ::ZeroMemory(pExtents, cbSize);

    fIoRet = ::DeviceIoControl(hVolume, IOCTL_VOLUME_GET_VOLUME_DISK_EXTENTS, NULL, 0, pExtents, cbSize, &cbSize, 0);
    if ( !fIoRet && GetLastError() == ERROR_MORE_DATA )
    {
        // Allocate more memory.
        cbSize = FIELD_OFFSET(VOLUME_DISK_EXTENTS, Extents) + pExtents->NumberOfDiskExtents * sizeof(DISK_EXTENT);
        ::CoTaskMemFree(pExtents);
        pExtents = NULL;

        pExtents = (VOLUME_DISK_EXTENTS *) ::CoTaskMemAlloc(cbSize);
        // Check whether CoTaskMemAlloc returned an out-of-memory error.
        ::ZeroMemory(pExtents, cbSize);

        // Now the buffer should be big enough.
        ::DeviceIoControl(hVolume, IOCTL_VOLUME_GET_VOLUME_DISK_EXTENTS, NULL, 0, pExtents, cbSize, &cbSize, 0);
        // Check whether the IOCTL succeeded.
    }
    // Check for errors; note that the IOCTL can fail for a reason other than insufficient memory.

    // For each disk, mark it to be excluded in the Restore Option string.
    for (i = 0; i < pExtents->NumberOfDiskExtents; i++)
    {
        pExtent = &pExtents->Extents[i];

        *wszDest = L'\0';
        StringCchPrintf(wszDest, MAX_PATH, L"\"ExcludeDisk\"=\"%d\", ", pExtent->DiskNumber); // check errors

        strRestoreOption.Append(wszDest);
        // Check for an out-of-memory error.
    }

    // Remove the trailing comma.
    strRestoreOption.TrimRight();
    strRestoreOption.UnTrailing(',');

    // Set the output parameter.
    strRestoreOption.Transfer( pstrExclusionList );

Exit:
    if( pExtents )
    {
        ::CoTaskMemFree(pExtents);
        pExtents = NULL;
    }

    if( hVolume != INVALID_HANDLE_VALUE )
    {
        ::CloseHandle(hVolume);
        hVolume = INVALID_HANDLE_VALUE;
    }

    return ( hr );
}

```



 

 
