---
description: Con la versión 2,0, los contadores de rendimiento cambiaron la arquitectura para simplificar el proceso de proporcionar datos de contador a los consumidores.
ms.assetid: 37f75b15-3f52-4259-a6d9-5a1a14f88379
title: Proporcionar datos de contadores con la versión 2,0
ms.topic: article
ms.date: 08/17/2020
ms.openlocfilehash: 67976c8a0b6c77582ed8c50c2e5cf753c77fcf6b
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/07/2021
ms.locfileid: "105667256"
---
# <a name="providing-counter-data-using-version-20"></a><span data-ttu-id="d2fd9-103">Proporcionar datos de contadores con la versión 2,0</span><span class="sxs-lookup"><span data-stu-id="d2fd9-103">Providing Counter Data Using Version 2.0</span></span>

<span data-ttu-id="d2fd9-104">Los proveedores de datos de rendimiento modernos usan un manifiesto para definir los datos del contador y usar las API del proveedor de contadores de rendimiento para administrar los datos en el contexto del proveedor.</span><span class="sxs-lookup"><span data-stu-id="d2fd9-104">Modern performance data providers use a manifest to define the counter data and use performance counter provider APIs to manage data within the context of the provider.</span></span> <span data-ttu-id="d2fd9-105">Los proveedores implementados mediante un manifiesto y las API de proveedor de contadores de rendimiento a menudo se denominan **proveedores V2**.</span><span class="sxs-lookup"><span data-stu-id="d2fd9-105">Providers implemented using a manifest and performance counter provider APIs are often called **V2 providers**.</span></span> <span data-ttu-id="d2fd9-106">Windows admite proveedores de modo usuario V2 en Windows Vista o posterior y proveedores de modo kernel v2 en Windows 7 o posterior.</span><span class="sxs-lookup"><span data-stu-id="d2fd9-106">Windows supports user-mode V2 providers on Windows Vista or later and kernel-mode V2 providers on Windows 7 or later.</span></span>

<span data-ttu-id="d2fd9-107">En esta página se describen los proveedores de modo usuario V2.</span><span class="sxs-lookup"><span data-stu-id="d2fd9-107">This page describes user-mode V2 providers.</span></span> <span data-ttu-id="d2fd9-108">Para obtener información acerca de los proveedores de modo kernel v2, consulte [supervisión del rendimiento del modo kernel](/windows-hardware/drivers/devtest/kernel-mode-performance-monitoring).</span><span class="sxs-lookup"><span data-stu-id="d2fd9-108">For information about kernel-mode V2 providers, see [Kernel Mode Performance Monitoring](/windows-hardware/drivers/devtest/kernel-mode-performance-monitoring).</span></span>

<span data-ttu-id="d2fd9-109">En tiempo de ejecución, los proveedores de v2 funcionan de la siguiente manera:</span><span class="sxs-lookup"><span data-stu-id="d2fd9-109">At runtime, V2 providers work as follows:</span></span>

- <span data-ttu-id="d2fd9-110">El proceso de proveedor se registra a sí mismo con el sistema de contador de rendimiento de Windows mediante una llamada a PerfStartProvider y PerfSetCounterSetInfo.</span><span class="sxs-lookup"><span data-stu-id="d2fd9-110">The provider process registers itself with the Windows Performance Counter system by calling PerfStartProvider and PerfSetCounterSetInfo.</span></span> <span data-ttu-id="d2fd9-111">Opcionalmente, el proveedor proporciona una función de devolución de llamada a la que se notificarán las solicitudes del consumidor.</span><span class="sxs-lookup"><span data-stu-id="d2fd9-111">The provider optionally provides a callback function that will be notified about consumer requests.</span></span>
- <span data-ttu-id="d2fd9-112">El proceso del proveedor agrega o quita las instancias según corresponda mediante PerfCreateInstance y PerfDeleteInstance.</span><span class="sxs-lookup"><span data-stu-id="d2fd9-112">The provider process adds or removes instances as appropriate using PerfCreateInstance and PerfDeleteInstance.</span></span> <span data-ttu-id="d2fd9-113">El proveedor actualiza los valores de contador cuando cambian con las API de PerfSet \* \* _.</span><span class="sxs-lookup"><span data-stu-id="d2fd9-113">The provider updates counter values when they change using PerfSet\*\*_ APIs.</span></span>
- <span data-ttu-id="d2fd9-114">Un consumidor realiza una solicitud de datos de un CounterSet.</span><span class="sxs-lookup"><span data-stu-id="d2fd9-114">A consumer makes a request for data from a counterset.</span></span> <span data-ttu-id="d2fd9-115">El sistema comprueba que el llamador tiene permisos para recopilar los datos.</span><span class="sxs-lookup"><span data-stu-id="d2fd9-115">The system verifies that the caller has permissions to collect the data.</span></span> <span data-ttu-id="d2fd9-116">Después, el sistema usa un subproceso de trabajo que se ejecuta en el proceso del proveedor para controlar la solicitud, invocando la función de devolución de llamada del proveedor si es necesario.</span><span class="sxs-lookup"><span data-stu-id="d2fd9-116">The system then uses a worker thread running in the provider process to handle the request, invoking the provider's callback function if appropriate.</span></span> <span data-ttu-id="d2fd9-117">El subproceso de trabajo copia los datos recopilados en un búfer administrado por el sistema y, a continuación, el sistema devuelve los datos al consumidor.</span><span class="sxs-lookup"><span data-stu-id="d2fd9-117">The worker thread copies the collected data into a system-managed buffer, and the system then returns the data to the consumer.</span></span>

## <a name="steps-to-creating-a-provider"></a><span data-ttu-id="d2fd9-118">Pasos para crear un proveedor</span><span class="sxs-lookup"><span data-stu-id="d2fd9-118">Steps to creating a provider</span></span>

1. <span data-ttu-id="d2fd9-119">Escriba un manifiesto que defina los datos del contador que proporcionará el proveedor.</span><span class="sxs-lookup"><span data-stu-id="d2fd9-119">Write a manifest that defines the counter data that your provider will provide.</span></span> <span data-ttu-id="d2fd9-120">Para obtener más información sobre cómo escribir el manifiesto, vea [esquema de contadores de rendimiento](performance-counters-schema.md).</span><span class="sxs-lookup"><span data-stu-id="d2fd9-120">For details on writing the manifest, see [Performance Counters Schema](performance-counters-schema.md).</span></span>
2. <span data-ttu-id="d2fd9-121">Use [CTRPP](ctrpp.md) para generar el código de plantilla que se incluye en el proveedor.</span><span class="sxs-lookup"><span data-stu-id="d2fd9-121">Use [CTRPP](ctrpp.md) to generate the template code that you include in your provider.</span></span> <span data-ttu-id="d2fd9-122">El código de plantilla incluye las estructuras que definen los conjuntos de contadores, las funciones [_ *contrainitial* \*](counterinitialize.md) y [**percleanup**](countercleanup.md) y las cadenas de recursos.</span><span class="sxs-lookup"><span data-stu-id="d2fd9-122">The template code includes the structures that define the counter sets, the [_ *CounterInitialize*\*](counterinitialize.md) and [**CounterCleanup**](countercleanup.md) functions, and the resource strings.</span></span>

   <span data-ttu-id="d2fd9-123">El proveedor debe llamar a las funciones [**contrainitialized**](counterinitialize.md) y de [**limpieza**](countercleanup.md) .</span><span class="sxs-lookup"><span data-stu-id="d2fd9-123">Your provider must call the [**CounterInitialize**](counterinitialize.md) and [**CounterCleanup**](countercleanup.md) functions.</span></span> <span data-ttu-id="d2fd9-124">La **Contrainicialización** llama a la función [**PerfStartProvider**](/windows/desktop/api/Perflib/nf-perflib-perfstartprovider) para registrar el proveedor y también llama a la función [**PerfSetCounterSetInfo**](/windows/desktop/api/Perflib/nf-perflib-perfsetcountersetinfo) para inicializar el conjunto de contadores.</span><span class="sxs-lookup"><span data-stu-id="d2fd9-124">The **CounterInitialize** calls the [**PerfStartProvider**](/windows/desktop/api/Perflib/nf-perflib-perfstartprovider) function to register the provider and also calls the [**PerfSetCounterSetInfo**](/windows/desktop/api/Perflib/nf-perflib-perfsetcountersetinfo) function to initialize the counter set.</span></span> <span data-ttu-id="d2fd9-125">La **perlimpieza** llama a la función [**PerfStopProvider**](/windows/desktop/api/Perflib/nf-perflib-perfstopprovider) para quitar el registro del proveedor.</span><span class="sxs-lookup"><span data-stu-id="d2fd9-125">The **CounterCleanup** calls the [**PerfStopProvider**](/windows/desktop/api/Perflib/nf-perflib-perfstopprovider) function to remove the provider's registration.</span></span>

3. <span data-ttu-id="d2fd9-126">Incluya el código de plantilla del paso anterior en el proyecto y complete el proveedor.</span><span class="sxs-lookup"><span data-stu-id="d2fd9-126">Include the template code from the previous step in your project and complete your provider.</span></span>

   <span data-ttu-id="d2fd9-127">Para completar el proveedor, debe llamar a la función [**PerfCreateInstance**](/windows/desktop/api/Perflib/nf-perflib-perfcreateinstance) para cada instancia del conjunto de contadores que proporcione.</span><span class="sxs-lookup"><span data-stu-id="d2fd9-127">To complete the provider, you need to call the [**PerfCreateInstance**](/windows/desktop/api/Perflib/nf-perflib-perfcreateinstance) function for each instance of the counter set that you provide.</span></span>

   <span data-ttu-id="d2fd9-128">Para establecer los valores de los contadores, llame a una de las siguientes funciones:</span><span class="sxs-lookup"><span data-stu-id="d2fd9-128">To set the counter values, call one of the following functions:</span></span>

   - [<span data-ttu-id="d2fd9-129">**PerfSetULongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="d2fd9-129">**PerfSetULongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfsetulongcountervalue)
   - [<span data-ttu-id="d2fd9-130">**PerfSetULongLongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="d2fd9-130">**PerfSetULongLongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfsetulonglongcountervalue)
   - [<span data-ttu-id="d2fd9-131">**PerfSetCounterRefValue**</span><span class="sxs-lookup"><span data-stu-id="d2fd9-131">**PerfSetCounterRefValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue)

   <span data-ttu-id="d2fd9-132">La ventaja de usar [**PerfSetCounterRefValue**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue) es que no es necesario realizar una llamada de función para establecer o actualizar el valor del contador, simplemente se actualiza la variable de contador local (la variable a la que apuntan los puntos de referencia) y los contadores de rendimiento usan el puntero para obtener acceso al valor del contador.</span><span class="sxs-lookup"><span data-stu-id="d2fd9-132">The benefit of using [**PerfSetCounterRefValue**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue) is that you do not have to make a function call to set or update the counter value, you simply update your local counter variable (the variable to which the reference points) and Performance Counters uses the pointer to access the counter value.</span></span>

   <span data-ttu-id="d2fd9-133">Si no usa [**PerfSetCounterRefValue**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue), puede utilizar las siguientes funciones para aumentar o disminuir el valor del contador:</span><span class="sxs-lookup"><span data-stu-id="d2fd9-133">If you do not use [**PerfSetCounterRefValue**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue), you can use the following functions to increment or decrement the counter value:</span></span>

   - [<span data-ttu-id="d2fd9-134">**PerfDecrementULongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="d2fd9-134">**PerfDecrementULongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfdecrementulongcountervalue)
   - [<span data-ttu-id="d2fd9-135">**PerfDecrementULongLongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="d2fd9-135">**PerfDecrementULongLongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfdecrementulonglongcountervalue)
   - [<span data-ttu-id="d2fd9-136">**PerfIncrementULongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="d2fd9-136">**PerfIncrementULongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfincrementulongcountervalue)
   - [<span data-ttu-id="d2fd9-137">**PerfIncrementULongLongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="d2fd9-137">**PerfIncrementULongLongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfincrementulonglongcountervalue)

   <span data-ttu-id="d2fd9-138">Antes de que se cierre el proveedor, debe llamar a [**PerfDeleteInstance**](/windows/desktop/api/Perflib/nf-perflib-perfdeleteinstance) para cada instancia del conjunto de contadores que creó.</span><span class="sxs-lookup"><span data-stu-id="d2fd9-138">Before the provider exits, it must call the [**PerfDeleteInstance**](/windows/desktop/api/Perflib/nf-perflib-perfdeleteinstance) for each counter set instance that it created.</span></span>

   <span data-ttu-id="d2fd9-139">Si especificó el **atributo callback** en el [**elemento Provider**](/windows/desktop/PerfCtrs/performance-counters-provider--counters--element) del manifiesto o usó el argumento **-NotificationCallback** al llamar a [CTRPP](ctrpp.md), debe implementar la función de devolución de llamada [*ControlCallback*](/windows/desktop/api/Perflib/nc-perflib-perflibrequest) .</span><span class="sxs-lookup"><span data-stu-id="d2fd9-139">If you specified the **callback** attribute in the [**provider**](/windows/desktop/PerfCtrs/performance-counters-provider--counters--element) element in your manifest or used the **-NotificationCallback** argument when calling [CTRPP](ctrpp.md), you must implement the [*ControlCallback*](/windows/desktop/api/Perflib/nc-perflib-perflibrequest) callback function.</span></span> <span data-ttu-id="d2fd9-140">La función de devolución de llamada se pasa a [**UnInitialize**](counterinitialize.md).</span><span class="sxs-lookup"><span data-stu-id="d2fd9-140">You pass the callback function to [**CounterInitialize**](counterinitialize.md).</span></span>

   <span data-ttu-id="d2fd9-141">Si usó **-MemoryRoutines** al llamar a [CTRPP](ctrpp.md), debe implementar las funciones de devolución de llamada [*AllocateMemory*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_alloc) y [*FreeMemory (*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_free) .</span><span class="sxs-lookup"><span data-stu-id="d2fd9-141">If you used the **-MemoryRoutines** when calling [CTRPP](ctrpp.md), you must implement the [*AllocateMemory*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_alloc) and [*FreeMemory*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_free) callback functions.</span></span> <span data-ttu-id="d2fd9-142">Las funciones de devolución de llamada se pasan a [**UnInitialize**](counterinitialize.md).</span><span class="sxs-lookup"><span data-stu-id="d2fd9-142">You pass the callback functions to [**CounterInitialize**](counterinitialize.md).</span></span>

4. <span data-ttu-id="d2fd9-143">Al instalar el proveedor, use la herramienta LodCtr para escribir el nombre del archivo binario que contiene las cadenas de recursos y los identificadores de recursos localizados en el registro.</span><span class="sxs-lookup"><span data-stu-id="d2fd9-143">When installing your provider, use the LodCtr tool to write the name of the binary file that contains the localized resource strings and resource IDs to the registry.</span></span> <span data-ttu-id="d2fd9-144">Para obtener más información sobre el uso de LodCtr, vea [esquema de contadores de rendimiento](performance-counters-schema.md).</span><span class="sxs-lookup"><span data-stu-id="d2fd9-144">For details on using LodCtr, see [Performance Counters Schema](performance-counters-schema.md).</span></span>

5. <span data-ttu-id="d2fd9-145">Al desinstalar el proveedor, utilice la herramienta UnlodCtr para quitar la información del proveedor del registro.</span><span class="sxs-lookup"><span data-stu-id="d2fd9-145">When uninstalling your provider, use the UnlodCtr tool to remove your provider's information from the registry.</span></span>
