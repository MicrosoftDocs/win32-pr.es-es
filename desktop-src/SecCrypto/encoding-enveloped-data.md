---
description: Se puede usar la sintaxis de mensajes criptográficos para codificar mensajes con doble cifrado.
ms.assetid: f35aacda-6827-42e9-b7ac-58dc007fc697
title: Codificación de datos con doble cifrado
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 53dc20fc7483ba1ef364d8b59824d26bd14d458d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/07/2021
ms.locfileid: "104559449"
---
# <a name="encoding-enveloped-data"></a><span data-ttu-id="11498-103">Codificación de datos con doble cifrado</span><span class="sxs-lookup"><span data-stu-id="11498-103">Encoding Enveloped Data</span></span>

<span data-ttu-id="11498-104">Los datos con doble cifrado se componen de contenido cifrado de cualquier tipo y claves de sesión cifradas de cifrado de contenido para uno o más destinatarios.</span><span class="sxs-lookup"><span data-stu-id="11498-104">Enveloped data consists of encrypted content of any type and encrypted content-encryption session keys for one or more recipients.</span></span> <span data-ttu-id="11498-105">Los mensajes con doble cifrado mantienen el contenido del mensaje secreto y permiten que solo las personas o entidades especificadas recuperen el contenido.</span><span class="sxs-lookup"><span data-stu-id="11498-105">Enveloped messages keep the contents of the message secret and allow only specified persons or entities to retrieve the contents.</span></span>

<span data-ttu-id="11498-106">La sintaxis de mensajes criptográficos (CMS) se puede usar para codificar mensajes con doble cifrado.</span><span class="sxs-lookup"><span data-stu-id="11498-106">Cryptographic message syntax (CMS) can be used to encode enveloped messages.</span></span> <span data-ttu-id="11498-107">CMS admite tres técnicas de administración de claves: transporte de claves, contrato de claves y claves de cifrado de claves simétricas (KEK) distribuidas previamente.</span><span class="sxs-lookup"><span data-stu-id="11498-107">CMS supports three key management techniques: key transport, key agreement, and previously distributed symmetric key-encryption keys (KEK).</span></span> <span data-ttu-id="11498-108">Los KEK simétricos distribuidos previamente también se conocen como distribución de claves de lista de distribución de correo.</span><span class="sxs-lookup"><span data-stu-id="11498-108">Previously distributed symmetric KEK are also known as mailing list key distribution.</span></span>

<span data-ttu-id="11498-109">En cada una de estas tres técnicas, se genera una clave de sesión única para cifrar el mensaje con doble cifrado.</span><span class="sxs-lookup"><span data-stu-id="11498-109">In each of these three techniques, a single session key is generated to encrypt the enveloped message.</span></span> <span data-ttu-id="11498-110">Los problemas de administración de claves solucionan la manera en que el remitente cifra la clave de sesión y la descifra un receptor.</span><span class="sxs-lookup"><span data-stu-id="11498-110">Key management issues deal with the way that session key is encrypted by the sender and decrypted by a receiver.</span></span> <span data-ttu-id="11498-111">Un solo mensaje cifrado se puede distribuir a muchos destinatarios mediante una combinación de las técnicas de administración de claves.</span><span class="sxs-lookup"><span data-stu-id="11498-111">A single encrypted message can be distributed to many recipients using a mixture of the key management techniques.</span></span>

<span data-ttu-id="11498-112">La administración de claves de transporte de claves utiliza la clave pública del receptor previsto para cifrar la clave de sesión.</span><span class="sxs-lookup"><span data-stu-id="11498-112">Key transport key management uses an intended receiver's public key to encrypt the session key.</span></span> <span data-ttu-id="11498-113">El receptor descifra la clave de sesión mediante la clave privada asociada a la clave pública que se usó para cifrar.</span><span class="sxs-lookup"><span data-stu-id="11498-113">The receiver decrypts the session key using the private key associated with the public key that was used to encrypt.</span></span> <span data-ttu-id="11498-114">A continuación, el receptor usa la clave de sesión descifrada para descifrar los datos con doble cifrado.</span><span class="sxs-lookup"><span data-stu-id="11498-114">The receiver then uses the decrypted session key to decrypt the enveloped data.</span></span> <span data-ttu-id="11498-115">Cuando se utiliza el transporte de claves, el receptor no ha confirmado la información sobre la identidad del remitente.</span><span class="sxs-lookup"><span data-stu-id="11498-115">When key transport is used, the receiver has not confirmed information on the identity of the sender.</span></span>

<span data-ttu-id="11498-116">En la administración de acuerdos de claves, se genera una clave privada Diffie-Hellman temporal y efímera que se usa para cifrar la clave de sesión.</span><span class="sxs-lookup"><span data-stu-id="11498-116">In key agreement management, a temporary, ephemeral Diffie-Hellman private key is generated and used to encrypt the session key.</span></span> <span data-ttu-id="11498-117">La clave pública correspondiente a la clave privada efímera se incluye como parte de la información del destinatario del mensaje.</span><span class="sxs-lookup"><span data-stu-id="11498-117">The public key corresponding to the ephemeral private key is included as part of the message's recipient information.</span></span> <span data-ttu-id="11498-118">El destinatario descifra la clave de sesión mediante la clave efímera recibida y usa esta clave de sesión descifrada para descifrar el mensaje con doble cifrado.</span><span class="sxs-lookup"><span data-stu-id="11498-118">The recipient decrypts the session key using the received ephemeral key and uses this decrypted session key to decrypt the enveloped message.</span></span> <span data-ttu-id="11498-119">Mediante el uso del acuerdo de claves efímeras junto con la clave privada del receptor, el receptor del mensaje ha confirmado la información sobre la identidad del remitente.</span><span class="sxs-lookup"><span data-stu-id="11498-119">Using ephemeral key agreement in conjunction with the receiver's private key, the message receiver does have confirmed information on the identity of the sender.</span></span>

<span data-ttu-id="11498-120">Para la administración de claves mediante [*claves simétricas*](../secgloss/s-gly.md)distribuidas previamente, cada mensaje incluye la clave de cifrado de contenido que se ha cifrado con una clave de cifrado de clave distribuida previamente.</span><span class="sxs-lookup"><span data-stu-id="11498-120">For key management using previously distributed [*symmetric keys*](../secgloss/s-gly.md), each message includes the content-encryption key that has been encrypted with a previously distributed key-encryption key.</span></span> <span data-ttu-id="11498-121">Los receptores usan la clave de cifrado de clave distribuida previamente para descifrar la clave de cifrado de contenido y, a continuación, usan la clave de cifrado de contenido descifrado para descifrar el mensaje con doble cifrado.</span><span class="sxs-lookup"><span data-stu-id="11498-121">Receivers use the previously distributed key-encryption key to decrypt the content encryption key, then use the decrypted content-encryption key to decrypt the enveloped message.</span></span>

<span data-ttu-id="11498-122">En la ilustración siguiente se muestra una secuencia CMS típica de eventos para codificar los datos con doble cifrado.</span><span class="sxs-lookup"><span data-stu-id="11498-122">A typical CMS sequence of events for encoding enveloped data, is shown in the following illustration.</span></span>

![codificación de datos con doble cifrado](images/envelmsg.png)

-   <span data-ttu-id="11498-124">Se recupera un puntero al mensaje de [*texto simple*](../secgloss/p-gly.md) .</span><span class="sxs-lookup"><span data-stu-id="11498-124">A pointer to the [*plaintext*](../secgloss/p-gly.md) message is retrieved.</span></span>
-   <span data-ttu-id="11498-125">Se genera una clave simétrica ([*sesión*](../secgloss/s-gly.md)).</span><span class="sxs-lookup"><span data-stu-id="11498-125">A symmetric ([*session*](../secgloss/s-gly.md)) key is generated.</span></span>
-   <span data-ttu-id="11498-126">La [*clave simétrica*](../secgloss/s-gly.md) y el algoritmo de cifrado especificado se utilizan para cifrar los datos del mensaje.</span><span class="sxs-lookup"><span data-stu-id="11498-126">The [*symmetric key*](../secgloss/s-gly.md) and specified encryption algorithm are used to encrypt the message data.</span></span>
-   <span data-ttu-id="11498-127">Se abre un [*almacén de certificados*](../secgloss/c-gly.md) .</span><span class="sxs-lookup"><span data-stu-id="11498-127">A [*certificate store*](../secgloss/c-gly.md) is opened.</span></span>
-   <span data-ttu-id="11498-128">El certificado del destinatario se recupera del almacén.</span><span class="sxs-lookup"><span data-stu-id="11498-128">The recipient's certificate is retrieved from the store.</span></span>
-   <span data-ttu-id="11498-129">La [*clave pública*](../secgloss/p-gly.md) se recupera del certificado del destinatario.</span><span class="sxs-lookup"><span data-stu-id="11498-129">The [*public key*](../secgloss/p-gly.md) is retrieved from the recipient's certificate.</span></span>
-   <span data-ttu-id="11498-130">Con la clave pública del destinatario, la clave simétrica está cifrada.</span><span class="sxs-lookup"><span data-stu-id="11498-130">Using the recipient's public key, the symmetric key is encrypted.</span></span>
-   <span data-ttu-id="11498-131">En el certificado del destinatario, se recupera el identificador del destinatario.</span><span class="sxs-lookup"><span data-stu-id="11498-131">From the recipient's certificate, the recipient's ID is retrieved.</span></span>
-   <span data-ttu-id="11498-132">La siguiente información se incluye en el mensaje con sobre digital: el algoritmo de cifrado de datos, los datos cifrados, la clave simétrica cifrada y la estructura de información del destinatario.</span><span class="sxs-lookup"><span data-stu-id="11498-132">The following information is included in the digitally enveloped message: the data encryption algorithm, the encrypted data, the encrypted symmetric key, and the recipient information structure.</span></span>

<span data-ttu-id="11498-133">Para usar funciones de mensaje de bajo nivel para realizar las tareas típicas que se acaban de mostrar, use el procedimiento siguiente.</span><span class="sxs-lookup"><span data-stu-id="11498-133">To use low-level message functions to accomplish the typical tasks just listed, use the following procedure.</span></span>

<span data-ttu-id="11498-134">**Para codificar un mensaje con doble cifrado**</span><span class="sxs-lookup"><span data-stu-id="11498-134">**To encode an enveloped message**</span></span>

1.  <span data-ttu-id="11498-135">Cree o recupere el contenido.</span><span class="sxs-lookup"><span data-stu-id="11498-135">Create or retrieve the content.</span></span>
2.  <span data-ttu-id="11498-136">Obtener un proveedor de servicios criptográficos.</span><span class="sxs-lookup"><span data-stu-id="11498-136">Get a cryptographic provider.</span></span>
3.  <span data-ttu-id="11498-137">Obtener un certificado de destinatario.</span><span class="sxs-lookup"><span data-stu-id="11498-137">Get a recipient certificate.</span></span>
4.  <span data-ttu-id="11498-138">Inicializa la estructura de [**\_ información de \_ codificación \_ con doble cifrado de CMSG**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_enveloped_encode_info) .</span><span class="sxs-lookup"><span data-stu-id="11498-138">Initialize the [**CMSG\_ENVELOPED\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_enveloped_encode_info) structure.</span></span>
5.  <span data-ttu-id="11498-139">Llame a [**CryptMsgCalculateEncodedLength**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength) para obtener el tamaño del BLOB del mensaje codificado.</span><span class="sxs-lookup"><span data-stu-id="11498-139">Call [**CryptMsgCalculateEncodedLength**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength) to get the size of the encoded message BLOB.</span></span> <span data-ttu-id="11498-140">Asigne memoria.</span><span class="sxs-lookup"><span data-stu-id="11498-140">Allocate memory for it.</span></span>
6.  <span data-ttu-id="11498-141">Llame a [**CryptMsgOpenToEncode**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), pasando CMSG \_ sobre *dwMsgType* y un puntero a la información de [**\_ \_ codificación \_ con doble cifrado**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_enveloped_encode_info) para *pvMsgEncodeInfo*.</span><span class="sxs-lookup"><span data-stu-id="11498-141">Call [**CryptMsgOpenToEncode**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), passing in CMSG\_ENVELOPED for *dwMsgType* and a pointer to [**CMSG\_ENVELOPED\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_enveloped_encode_info) for *pvMsgEncodeInfo*.</span></span> <span data-ttu-id="11498-142">Como resultado de esta llamada, obtendrá un identificador para el mensaje abierto.</span><span class="sxs-lookup"><span data-stu-id="11498-142">As a result of this call, you will get a handle to the opened message.</span></span>
7.  <span data-ttu-id="11498-143">Llame a [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate), pasando el identificador recuperado en el paso 6 y un puntero a los datos que se van a cifrar, sobre y codificar.</span><span class="sxs-lookup"><span data-stu-id="11498-143">Call [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate), passing in the handle retrieved in step 6 and a pointer to the data that is to be encrypted, enveloped, and encoded.</span></span> <span data-ttu-id="11498-144">Se puede llamar a esta función tantas veces como sea necesario para completar el proceso de codificación.</span><span class="sxs-lookup"><span data-stu-id="11498-144">This function can be called as many times as necessary to complete the encoding process.</span></span>
8.  <span data-ttu-id="11498-145">Llame a [**CryptMsgGetParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam), pasando el identificador recuperado en el paso 6 y los tipos de parámetro adecuados para tener acceso a los datos codificados deseados.</span><span class="sxs-lookup"><span data-stu-id="11498-145">Call [**CryptMsgGetParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam), passing in the handle retrieved in step 6 and the appropriate parameter types to access the desired, encoded data.</span></span> <span data-ttu-id="11498-146">Por ejemplo, pase \_ el parámetro de contenido CMSG \_ para obtener un puntero al mensaje PKCS \# 7 completo.</span><span class="sxs-lookup"><span data-stu-id="11498-146">For example, pass in CMSG\_CONTENT\_PARAM to get a pointer to the entire PKCS \#7 message.</span></span>

    <span data-ttu-id="11498-147">Si el resultado de esta codificación se va a usar como [*datos internos*](../secgloss/i-gly.md) de otro mensaje codificado, como un mensaje con doble cifrado, \_ \_ \_ se debe pasar el parámetro de parámetro CMSG de código sin sistema operativo.</span><span class="sxs-lookup"><span data-stu-id="11498-147">If the result of this encoding is to be used as the [*inner data*](../secgloss/i-gly.md) for another encoded message, such as an enveloped message, the CMSG\_BARE\_CONTENT\_PARAM parameter must be passed.</span></span> <span data-ttu-id="11498-148">Para obtener un ejemplo, vea [código alternativo para codificar un mensaje con doble cifrado](alternate-code-for-encoding-an-enveloped-message.md).</span><span class="sxs-lookup"><span data-stu-id="11498-148">For an example, see [Alternate Code for Encoding an Enveloped Message](alternate-code-for-encoding-an-enveloped-message.md).</span></span>

9.  <span data-ttu-id="11498-149">Cierre el mensaje mediante una llamada a [**CryptMsgClose**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose).</span><span class="sxs-lookup"><span data-stu-id="11498-149">Close the message by calling [**CryptMsgClose**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose).</span></span>

<span data-ttu-id="11498-150">El resultado de este procedimiento es un mensaje codificado que contiene los datos cifrados, la [*clave simétrica*](../secgloss/s-gly.md) cifrada con las claves públicas del destinatario y las estructuras de datos de información de destinatarios.</span><span class="sxs-lookup"><span data-stu-id="11498-150">The result of this procedure is an encoded message that contains the encrypted data, the [*symmetric key*](../secgloss/s-gly.md) that is encrypted with the recipient's public keys, and the recipient information data structures.</span></span> <span data-ttu-id="11498-151">La combinación de contenido cifrado y una clave simétrica cifrada para un destinatario es una [*envoltura digital*](../secgloss/d-gly.md) para ese destinatario.</span><span class="sxs-lookup"><span data-stu-id="11498-151">The combination of encrypted content and an encrypted symmetric key for a recipient is a [*digital envelope*](../secgloss/d-gly.md) for that recipient.</span></span> <span data-ttu-id="11498-152">Se puede hacer sobre cualquier tipo de contenido para varios destinatarios.</span><span class="sxs-lookup"><span data-stu-id="11498-152">Any type of content can be enveloped for multiple recipients.</span></span>

## <a name="related-topics"></a><span data-ttu-id="11498-153">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="11498-153">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="11498-154">Programa C de ejemplo: codificar un mensaje con signo de cifrado</span><span class="sxs-lookup"><span data-stu-id="11498-154">Example C Program: Encoding an Enveloped, Signed Message</span></span>](example-c-program-encoding-an-enveloped-signed-message.md)
</dt> </dl>

 

 
