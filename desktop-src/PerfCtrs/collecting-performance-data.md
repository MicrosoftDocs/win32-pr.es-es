---
description: Después de crear una consulta y agregarle contadores, llame a la función PdhCollectQueryData para recuperar los datos sin procesar actuales de todos los contadores de la consulta.
ms.assetid: 2534d387-a280-4716-9a9d-3e42f40e2f92
title: Recopilación de datos de rendimiento
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: e99bd2c0e22553245e87d3844694051c88c57895
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/07/2021
ms.locfileid: "104360703"
---
# <a name="collecting-performance-data"></a><span data-ttu-id="31cac-103">Recopilación de datos de rendimiento</span><span class="sxs-lookup"><span data-stu-id="31cac-103">Collecting Performance Data</span></span>

<span data-ttu-id="31cac-104">Después de [crear una consulta](creating-a-query.md) y agregarle contadores, llame a la función [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) para recuperar los datos sin procesar actuales de todos los contadores de la consulta.</span><span class="sxs-lookup"><span data-stu-id="31cac-104">After [creating a query](creating-a-query.md) and adding counters to it, call the [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) function to retrieve the current raw data for all counters in the query.</span></span>

<span data-ttu-id="31cac-105">Muchos contadores, como los contadores de tasa, requieren dos muestras de datos para calcular un valor de datos con formato.</span><span class="sxs-lookup"><span data-stu-id="31cac-105">Many counters, such as rate counters, require two data samples to calculate a formatted data value.</span></span> <span data-ttu-id="31cac-106">PDH mantiene los datos para el ejemplo actual y el ejemplo recopilado anteriormente.</span><span class="sxs-lookup"><span data-stu-id="31cac-106">PDH maintains data for the current sample and the previously collected sample.</span></span> <span data-ttu-id="31cac-107">En el procedimiento siguiente se describe cómo recopilar valores de contador que requieren dos ejemplos para calcular un valor que se pueda mostrar.</span><span class="sxs-lookup"><span data-stu-id="31cac-107">The following procedure describes how to collect counter values that require two samples to calculate a displayable value.</span></span>

<span data-ttu-id="31cac-108">**Para recopilar valores de contador que requieren dos ejemplos para calcular un valor que se pueda mostrar**</span><span class="sxs-lookup"><span data-stu-id="31cac-108">**To collect counter values that require two samples to calculate a displayable value**</span></span>

1.  <span data-ttu-id="31cac-109">Llame a [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) para recopilar el primer ejemplo.</span><span class="sxs-lookup"><span data-stu-id="31cac-109">Call [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) to collect the first sample.</span></span>
2.  <span data-ttu-id="31cac-110">Llame a la función [**Sleep**](/windows/desktop/api/synchapi/nf-synchapi-sleep) para esperar un mínimo de un segundo entre las colecciones.</span><span class="sxs-lookup"><span data-stu-id="31cac-110">Call the [**Sleep**](/windows/desktop/api/synchapi/nf-synchapi-sleep) function to wait a minimum of one second between collections.</span></span>
3.  <span data-ttu-id="31cac-111">Vuelva a llamar a [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) para recopilar el segundo ejemplo.</span><span class="sxs-lookup"><span data-stu-id="31cac-111">Call [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) again to collect the second sample.</span></span>
4.  <span data-ttu-id="31cac-112">Llame a la función [**PdhGetFormattedCounterValue**](/windows/desktop/api/Pdh/nf-pdh-pdhgetformattedcountervalue) para calcular un valor que se pueda mostrar.</span><span class="sxs-lookup"><span data-stu-id="31cac-112">Call the [**PdhGetFormattedCounterValue**](/windows/desktop/api/Pdh/nf-pdh-pdhgetformattedcountervalue) function to calculate a displayable value.</span></span>
5.  <span data-ttu-id="31cac-113">Repita los pasos del 2 al 4.</span><span class="sxs-lookup"><span data-stu-id="31cac-113">Repeat steps 2 through 4.</span></span>

<span data-ttu-id="31cac-114">Como alternativa a la implementación de un período de espera, puede llamar a la función [**PdhCollectQueryDataEx**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydataex) , que crea un subproceso de control de tiempo que espera una cantidad de tiempo especificada, recopila el ejemplo y, a continuación, desencadena un evento definido por la aplicación.</span><span class="sxs-lookup"><span data-stu-id="31cac-114">As an alternative to implementing a wait period yourself, you can call the [**PdhCollectQueryDataEx**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydataex) function, which creates a timing thread that waits a specified amount of time, collects the sample, and then triggers an application-defined event.</span></span>

<span data-ttu-id="31cac-115">Si desea consultar los datos de rendimiento de un archivo de registro, también puede definir un intervalo de tiempo.</span><span class="sxs-lookup"><span data-stu-id="31cac-115">If you want to query performance data from a log file, you can also define a time range.</span></span> <span data-ttu-id="31cac-116">El intervalo de tiempo limita la consulta a las muestras que se recopilaron en el intervalo de tiempo (cada muestra contiene una marca de tiempo para el momento en que se recopiló).</span><span class="sxs-lookup"><span data-stu-id="31cac-116">The time range limits the query to those samples that were collected within the time range (each sample contains a time stamp for when it was collected).</span></span> <span data-ttu-id="31cac-117">Para obtener más información sobre cómo establecer y recuperar intervalos de tiempo, vea [establecer un intervalo de tiempo para una consulta](setting-a-time-range-for-a-query.md).</span><span class="sxs-lookup"><span data-stu-id="31cac-117">For more information on how to set and retrieve time ranges, see [Setting a Time Range for a Query](setting-a-time-range-for-a-query.md).</span></span>

<span data-ttu-id="31cac-118">Si desea recopilar datos de rendimiento y escribirlos en un archivo de registro, debe llamar a la función [**PdhUpdateLog**](/windows/desktop/api/Pdh/nf-pdh-pdhupdateloga) en lugar de llamar a [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata).</span><span class="sxs-lookup"><span data-stu-id="31cac-118">If you want to collect performance data and write it to a log file, you would call the [**PdhUpdateLog**](/windows/desktop/api/Pdh/nf-pdh-pdhupdateloga) function instead of calling [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata).</span></span> <span data-ttu-id="31cac-119">Para obtener más información, vea [trabajar con archivos de registro](working-with-log-files.md) y [escribir datos de rendimiento en un archivo de registro](writing-performance-data-to-a-log-file.md).</span><span class="sxs-lookup"><span data-stu-id="31cac-119">For details, see [Working with Log Files](working-with-log-files.md) and [Writing Performance Data to a Log File](writing-performance-data-to-a-log-file.md).</span></span>

<span data-ttu-id="31cac-120">Para obtener más información sobre cómo calcular un valor de ejemplo que se pueda mostrar, vea [Mostrar datos de rendimiento](displaying-performance-data.md).</span><span class="sxs-lookup"><span data-stu-id="31cac-120">For details on calculating a displayable sample value, see [Displaying Performance Data](displaying-performance-data.md).</span></span>

## <a name="understanding-multiple-processor-counters"></a><span data-ttu-id="31cac-121">Descripción de varios contadores de procesador</span><span class="sxs-lookup"><span data-stu-id="31cac-121">Understanding Multiple Processor Counters</span></span>

<span data-ttu-id="31cac-122">Algunos contadores de rendimiento se diseñaron para sistemas de un solo procesador y es posible que no sean precisos para equipos con varios procesadores.</span><span class="sxs-lookup"><span data-stu-id="31cac-122">Some performance counters were designed for single processor systems and might not be accurate for multiprocessor computers.</span></span> <span data-ttu-id="31cac-123">Por ejemplo, un proceso está limitado al 100 por ciento de un solo procesador; sin embargo, sus subprocesos pueden usar varios procesadores, con un total superior al 100 por ciento.</span><span class="sxs-lookup"><span data-stu-id="31cac-123">For example, a process is limited to 100 percent of a single processor; however, its threads can use several processors, totaling more than 100 percent.</span></span>

<span data-ttu-id="31cac-124">El \\ valor del contador "procesador ( \_ total) \\ % de tiempo de procesador" es el uso promedio de todos los procesadores.</span><span class="sxs-lookup"><span data-stu-id="31cac-124">The "\\Processor(\_Total)\\% Processor Time" counter value is the average usage of all processors.</span></span> <span data-ttu-id="31cac-125">Por ejemplo, si tiene dos procesadores, uno en 100 por ciento y otro en 0 por ciento, este contador informará del 50 por ciento.</span><span class="sxs-lookup"><span data-stu-id="31cac-125">For example, if you have two processors, one at 100 percent and another at 0 percent, this counter will report 50 percent.</span></span> <span data-ttu-id="31cac-126">Por lo tanto, el intervalo está comprendido entre 0 y 100.</span><span class="sxs-lookup"><span data-stu-id="31cac-126">So the range is from 0 through 100.</span></span>

<span data-ttu-id="31cac-127">El \\ valor del contador "proceso (X) \\ % de tiempo de proceso" es la suma del uso del procesador de todos los subprocesos del proceso X. Por ejemplo, en un equipo con dos procesadores, si un proceso tiene dos subprocesos, uno que ocupa el 75 por ciento de una CPU y otro que toma el 80 por ciento de otra CPU, este contador informará del 155 por ciento.</span><span class="sxs-lookup"><span data-stu-id="31cac-127">The "\\Process(X)\\% Process Time" counter value is the sum of the processor usage by all threads of process X. For example, in a computer with two processors, if a process has two threads, one taking up 75 percent of a CPU and the other taking 80 percent of another CPU, this counter will report 155 percent.</span></span> <span data-ttu-id="31cac-128">El intervalo de este contador es de 0 a 100 \* ProcessorCount.</span><span class="sxs-lookup"><span data-stu-id="31cac-128">The range for this counter is from 0 through 100 \* ProcessorCount.</span></span>

<span data-ttu-id="31cac-129">\* \* Windows Server 2003 y Windows XP: \* \*</span><span class="sxs-lookup"><span data-stu-id="31cac-129">\*\*Windows Server 2003 and Windows XP:  \*\*</span></span>

<span data-ttu-id="31cac-130">Puede recibir valores fuera del intervalo de valores esperado para el uso de la CPU.</span><span class="sxs-lookup"><span data-stu-id="31cac-130">You can receive values outside the expected range of values for CPU usage.</span></span> <span data-ttu-id="31cac-131">Para calcular el porcentaje de uso de CPU, PDH necesita dos muestras (cada una con un valor sin formato y una marca de tiempo).</span><span class="sxs-lookup"><span data-stu-id="31cac-131">To calculate the percentage of CPU usage, PDH needs two samples (each with a raw value and a time stamp).</span></span> <span data-ttu-id="31cac-132">Dado que PDH solo usa el nombre de instancia para que coincida con los procesos, a veces puede usar dos ejemplos de diferentes procesos.</span><span class="sxs-lookup"><span data-stu-id="31cac-132">Because PDH uses only the instance name to match the processes, it can sometimes use two samples from different processes.</span></span> <span data-ttu-id="31cac-133">Por ejemplo, si se muestrean tres procesos y se termina un proceso después del tercer ejemplo, otro proceso se moverá a la ranura que queda anulada por ese proceso terminado.</span><span class="sxs-lookup"><span data-stu-id="31cac-133">For example, if three processes are being sampled and one process is terminated after the third sample, another process will move to the slot vacated by that terminated process.</span></span> <span data-ttu-id="31cac-134">Como resultado, un contador con formato proporcionará un valor incorrecto al dar formato al cuarto ejemplo, porque se está usando el tercer ejemplo del proceso terminado y el cuarto ejemplo del proceso que se ha pasado a la ranura terminada del proceso.</span><span class="sxs-lookup"><span data-stu-id="31cac-134">As a result, a formatted counter will provide an incorrect value when you format the fourth sample, because it’s using the third sample from the terminated process and the fourth sample from the process that moved into the terminated process's slot.</span></span>

<span data-ttu-id="31cac-135">En la tabla siguiente se muestra cómo puede ocurrir esto si se termina un proceso mientras se recopilan los datos.</span><span class="sxs-lookup"><span data-stu-id="31cac-135">The following table shows how this can occur if a process is terminated while data is being collected.</span></span> <span data-ttu-id="31cac-136">En la tabla se muestran cinco ejemplos de valores de contador para tres instancias del proceso X. Los ejemplos se recopilan en intervalos de un segundo.</span><span class="sxs-lookup"><span data-stu-id="31cac-136">The table shows five counter value samples for three instances of process X. The samples are collected in one second intervals.</span></span> <span data-ttu-id="31cac-137">Después de recopilar el tercer ejemplo, se termina el proceso X en la ranura 1.</span><span class="sxs-lookup"><span data-stu-id="31cac-137">After the third sample is collected, process X in slot 1 is terminated.</span></span> <span data-ttu-id="31cac-138">Cuando termina el proceso X en la ranura 1, el proceso X de la ranura 2 se mueve a la ranura 1.</span><span class="sxs-lookup"><span data-stu-id="31cac-138">When process X in slot 1 is terminated, process X in slot 2 moves to slot 1.</span></span> <span data-ttu-id="31cac-139">Al recopilar el cuarto ejemplo para el proceso X en la ranura 2, el primer valor es ahora 20 en lugar de 1.000 y el segundo valor es 1.500.</span><span class="sxs-lookup"><span data-stu-id="31cac-139">When you collect the fourth sample for process X in slot 2, the first value is now 20 instead of 1,000, and the second value is 1,500.</span></span> <span data-ttu-id="31cac-140">Al dar formato al valor del contador, obtendrá 1.480 milisegundos en lugar de los 500 milisegundos esperados.</span><span class="sxs-lookup"><span data-stu-id="31cac-140">When you format the counter value, you get 1,480 milliseconds instead of the expected 500 milliseconds.</span></span> <span data-ttu-id="31cac-141">Al dar formato al quinto valor de ejemplo, debe obtener el valor esperado.</span><span class="sxs-lookup"><span data-stu-id="31cac-141">When you format the fifth sample value, you should get the expected value.</span></span>

| <span data-ttu-id="31cac-142">Muestra</span><span class="sxs-lookup"><span data-stu-id="31cac-142">Sample</span></span>   | <span data-ttu-id="31cac-143">Ranura 0 para el proceso X</span><span class="sxs-lookup"><span data-stu-id="31cac-143">Slot 0 for process X</span></span> | <span data-ttu-id="31cac-144">Ranura 1 para el proceso X</span><span class="sxs-lookup"><span data-stu-id="31cac-144">Slot 1 for process X</span></span>           | <span data-ttu-id="31cac-145">Ranura 2 para el proceso X</span><span class="sxs-lookup"><span data-stu-id="31cac-145">Slot 2 for process X</span></span>                     |
|----------|----------------------|--------------------------------|------------------------------------------|
| <span data-ttu-id="31cac-146">Ejemplo 1</span><span class="sxs-lookup"><span data-stu-id="31cac-146">Sample 1</span></span> | <span data-ttu-id="31cac-147">0</span><span class="sxs-lookup"><span data-stu-id="31cac-147">0</span></span>                    | <span data-ttu-id="31cac-148">0</span><span class="sxs-lookup"><span data-stu-id="31cac-148">0</span></span>                              | <span data-ttu-id="31cac-149">0</span><span class="sxs-lookup"><span data-stu-id="31cac-149">0</span></span>                                        |
| <span data-ttu-id="31cac-150">Ejemplo 2</span><span class="sxs-lookup"><span data-stu-id="31cac-150">Sample 2</span></span> | <span data-ttu-id="31cac-151">20</span><span class="sxs-lookup"><span data-stu-id="31cac-151">20</span></span>                   | <span data-ttu-id="31cac-152">10</span><span class="sxs-lookup"><span data-stu-id="31cac-152">10</span></span>                             | <span data-ttu-id="31cac-153">500</span><span class="sxs-lookup"><span data-stu-id="31cac-153">500</span></span>                                      |
| <span data-ttu-id="31cac-154">Ejemplo 3</span><span class="sxs-lookup"><span data-stu-id="31cac-154">Sample 3</span></span> | <span data-ttu-id="31cac-155">40</span><span class="sxs-lookup"><span data-stu-id="31cac-155">40</span></span>                   | <span data-ttu-id="31cac-156">20</span><span class="sxs-lookup"><span data-stu-id="31cac-156">20</span></span>                             | <span data-ttu-id="31cac-157">1,000</span><span class="sxs-lookup"><span data-stu-id="31cac-157">1,000</span></span>                                    |
| <span data-ttu-id="31cac-158">Ejemplo 4</span><span class="sxs-lookup"><span data-stu-id="31cac-158">Sample 4</span></span> | <span data-ttu-id="31cac-159">60</span><span class="sxs-lookup"><span data-stu-id="31cac-159">60</span></span>                   | <span data-ttu-id="31cac-160">1.500 (desde la ranura 2 anterior)</span><span class="sxs-lookup"><span data-stu-id="31cac-160">1,500 (from the former slot 2)</span></span> | <span data-ttu-id="31cac-161">No es aplicable.</span><span class="sxs-lookup"><span data-stu-id="31cac-161">Not applicable.</span></span> <span data-ttu-id="31cac-162">Ahora se recopila en la ranura 1.</span><span class="sxs-lookup"><span data-stu-id="31cac-162">Now collected in slot 1.</span></span> |
| <span data-ttu-id="31cac-163">Ejemplo 5</span><span class="sxs-lookup"><span data-stu-id="31cac-163">Sample 5</span></span> | <span data-ttu-id="31cac-164">80</span><span class="sxs-lookup"><span data-stu-id="31cac-164">80</span></span>                   | <span data-ttu-id="31cac-165">2\.000</span><span class="sxs-lookup"><span data-stu-id="31cac-165">2,000</span></span>                          | <span data-ttu-id="31cac-166">No es aplicable.</span><span class="sxs-lookup"><span data-stu-id="31cac-166">Not applicable.</span></span> <span data-ttu-id="31cac-167">Ahora se recopila en la ranura 1.</span><span class="sxs-lookup"><span data-stu-id="31cac-167">Now collected in slot 1.</span></span> |



 

 

 
