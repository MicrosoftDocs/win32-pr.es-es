---
description: Muestra cómo se pueden usar las funciones de copia de seguridad de servicios de Certificate Server para restaurar y recuperar una base de datos de servicios de certificados y sus archivos asociados.
ms.assetid: f4914f45-629d-4f24-8328-d7f27e8a0062
title: Restauración de servicios de Certificate Server desde la copia de seguridad
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8f5adf46d802194909397a3b70483b3cf43bb409
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/08/2021
ms.locfileid: "105688421"
---
# <a name="restoring-certificate-services-from-backup"></a><span data-ttu-id="54bcf-103">Restauración de servicios de Certificate Server desde la copia de seguridad</span><span class="sxs-lookup"><span data-stu-id="54bcf-103">Restoring Certificate Services from Backup</span></span>

<span data-ttu-id="54bcf-104">En el escenario siguiente se muestra cómo se pueden usar las funciones de copia de seguridad de servicios de Certificate Server para restaurar y recuperar una base de datos de servicios de certificados y sus archivos asociados.</span><span class="sxs-lookup"><span data-stu-id="54bcf-104">The following scenario shows how the Certificate Services backup functions can be used to restore and recover a Certificate Services database and its associated files.</span></span> <span data-ttu-id="54bcf-105">El proceso de restauración implica escribir los archivos contenidos en un conjunto de copia de seguridad en disco.</span><span class="sxs-lookup"><span data-stu-id="54bcf-105">The restoration process involves writing the files contained in a backup set to disk.</span></span> <span data-ttu-id="54bcf-106">Puede restaurar varios conjuntos de copia de seguridad (una copia de seguridad completa más cero o más copias de seguridad incrementales), pero todas las restauraciones se deben completar antes de comenzar el proceso de recuperación.</span><span class="sxs-lookup"><span data-stu-id="54bcf-106">You may restore multiple backup sets (one full backup plus zero or more incremental backups), but all restores must be complete prior to beginning the recovery process.</span></span> <span data-ttu-id="54bcf-107">El proceso de recuperación implica que los servicios de Certificate Server reproduzcan los archivos de registro para garantizar la coherencia de los archivos de registro y la base de datos.</span><span class="sxs-lookup"><span data-stu-id="54bcf-107">The recovery process involves Certificate Services replaying log files to ensure database and log file consistency, thereby ensuring database integrity.</span></span> <span data-ttu-id="54bcf-108">El escenario muestra las llamadas de función para restaurar los conjuntos de copia de seguridad e informar a los servicios de Certificate Server de los parámetros de recuperación.</span><span class="sxs-lookup"><span data-stu-id="54bcf-108">The scenario illustrates the function calls to restore the backup sets and inform Certificate Services of the recovery parameters.</span></span>

<span data-ttu-id="54bcf-109">Debe existir una copia de seguridad completa existente de la base de datos de servicios de certificados antes de implementar este escenario.</span><span class="sxs-lookup"><span data-stu-id="54bcf-109">An existing full backup of the Certificate Services database must exist before implementing this scenario.</span></span>

1.  <span data-ttu-id="54bcf-110">Cargue la biblioteca de Certadm.dll en la memoria (llamando a [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span><span class="sxs-lookup"><span data-stu-id="54bcf-110">Load the Certadm.dll library into memory (by calling [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span></span>
2.  <span data-ttu-id="54bcf-111">Recupere la dirección de cada una de las funciones necesarias en Certadm.dll (mediante [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress)).</span><span class="sxs-lookup"><span data-stu-id="54bcf-111">Retrieve the address of each of the necessary functions in Certadm.dll (by means of [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress)).</span></span> <span data-ttu-id="54bcf-112">Use estas direcciones al llamar a las funciones en los pasos restantes.</span><span class="sxs-lookup"><span data-stu-id="54bcf-112">Use these addresses when calling the functions in the remaining steps.</span></span>
3.  <span data-ttu-id="54bcf-113">Llame a [**CertSrvIsServerOnline**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvisserveronlinew) para determinar si los servicios de Certificate Server están en línea.</span><span class="sxs-lookup"><span data-stu-id="54bcf-113">Call [**CertSrvIsServerOnline**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvisserveronlinew) to determine whether Certificate Services is online.</span></span> <span data-ttu-id="54bcf-114">Si se está ejecutando servicios de Certificate Server, ciérrelo antes de continuar.</span><span class="sxs-lookup"><span data-stu-id="54bcf-114">If Certificate Services is running, shut it down before proceeding.</span></span> <span data-ttu-id="54bcf-115">Los servicios de Certificate Server no deben estar en línea para que las operaciones de restauración se realicen correctamente.</span><span class="sxs-lookup"><span data-stu-id="54bcf-115">Certificate Services must not be online for the restore operations to be successful.</span></span>
4.  <span data-ttu-id="54bcf-116">Llame a [**CertSrvRestorePrepare**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestorepreparew) para iniciar una sesión de restauración.</span><span class="sxs-lookup"><span data-stu-id="54bcf-116">Call [**CertSrvRestorePrepare**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestorepreparew) to begin a restore session.</span></span> <span data-ttu-id="54bcf-117">Varias de las demás funciones utilizarán el identificador de contexto de copia de seguridad de servicios de certificados resultante.</span><span class="sxs-lookup"><span data-stu-id="54bcf-117">The resulting Certificate Services backup context handle will be used by several of the other functions.</span></span>
5.  <span data-ttu-id="54bcf-118">Determine la ruta de acceso de la ubicación de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="54bcf-118">Determine the path for the database location.</span></span> <span data-ttu-id="54bcf-119">Durante un escenario de copia de seguridad, este valor habría estado disponible en una llamada a [**CertSrvRestoreGetDatabaseLocations**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoregetdatabaselocationsw); Este valor se debe haber almacenado como parte de la copia de seguridad.</span><span class="sxs-lookup"><span data-stu-id="54bcf-119">During a backup scenario, this value would have been available from a call to [**CertSrvRestoreGetDatabaseLocations**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoregetdatabaselocationsw); this value should have been stored as part of the backup.</span></span>
6.  <span data-ttu-id="54bcf-120">Cree una asignación de restauración que especifique el nombre de la base de datos restaurada.</span><span class="sxs-lookup"><span data-stu-id="54bcf-120">Create a restore map specifying the name of the restored database.</span></span> <span data-ttu-id="54bcf-121">Se usa una estructura de asignación de restauración de base de datos de servicios de certificados (CSEDB \_ RSTMAPW) para especificar una asignación de restauración.</span><span class="sxs-lookup"><span data-stu-id="54bcf-121">A Certificate Services database restore map structure (CSEDB\_RSTMAPW) is used to specify a restore map.</span></span> <span data-ttu-id="54bcf-122">Establezca el \_ miembro **PWSZDATABASENAME** de CSEDB RSTMAPW y el \_ miembro **RSTMAPW** de CSEDB pwszNewDatabaseName en la ubicación de la base de datos determinada en el paso 5.</span><span class="sxs-lookup"><span data-stu-id="54bcf-122">Set the CSEDB\_RSTMAPW's **pwszDatabaseName** member and the CSEDB\_RSTMAPW's **pwszNewDatabaseName** member to the database location determined in step 5.</span></span> <span data-ttu-id="54bcf-123">Opcionalmente, si la base de datos restaurada tiene un nombre diferente al de la base de datos de copia de seguridad, establezca el \_ miembro **PWSZNEWDATABASENAME** de CSEDB RSTMAPW en el nombre de la nueva base de datos.</span><span class="sxs-lookup"><span data-stu-id="54bcf-123">Optionally, if the restored database is to have a different name than the backup database, set the CSEDB\_RSTMAPW's **pwszNewDatabaseName** member to the new database name.</span></span>
7.  <span data-ttu-id="54bcf-124">Si desea asegurarse de que las modificaciones realizadas en la base de datos después de realizar la copia de seguridad no se vuelvan a aplicar una vez completada la restauración de la base de datos (como parte de la recuperación de la base de datos realizada durante el siguiente inicio de servicios de servidor de certificados), elimine los archivos de la base de datos activa y los directorios de registro</span><span class="sxs-lookup"><span data-stu-id="54bcf-124">If you want to ensure that modifications made to the database after the backup was performed are not reapplied after database restore is complete (as part of database recovery performed during the next Certificate Services startup), delete files from the target server's active database and log directories.</span></span>
8.  <span data-ttu-id="54bcf-125">Copie los archivos contenidos en la copia de seguridad completa en los directorios de registro y la base de datos activa del servidor de destino.</span><span class="sxs-lookup"><span data-stu-id="54bcf-125">Copy the files contained in the full backup to the target server's active database and log directories.</span></span>
9.  <span data-ttu-id="54bcf-126">Llame a [**CertSrvRestoreRegister**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw) para registrar una operación de restauración de la copia de seguridad completa.</span><span class="sxs-lookup"><span data-stu-id="54bcf-126">Call [**CertSrvRestoreRegister**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw) to register a restore operation for the full backup.</span></span> <span data-ttu-id="54bcf-127">**CertSrvRestoreRegister** usa la asignación de restauración especificada en el paso 6.</span><span class="sxs-lookup"><span data-stu-id="54bcf-127">**CertSrvRestoreRegister** uses the restore map specified in step 6.</span></span> <span data-ttu-id="54bcf-128">**CertSrvRestoreRegister** también especifica la ubicación de la base de datos y los registros de copia de seguridad.</span><span class="sxs-lookup"><span data-stu-id="54bcf-128">**CertSrvRestoreRegister** also specifies the location of the backup database and logs.</span></span> <span data-ttu-id="54bcf-129">La llamada a **CertSrvRestoreRegister** forzará a los servicios de Certificate Server a intentar una operación de restauración la próxima vez que se inicie.</span><span class="sxs-lookup"><span data-stu-id="54bcf-129">Calling **CertSrvRestoreRegister** will force Certificate Services to attempt a restore operation the next time it is started.</span></span> <span data-ttu-id="54bcf-130">También impide que los servicios de Certificate Server procesen solicitudes de certificados hasta que se complete la restauración.</span><span class="sxs-lookup"><span data-stu-id="54bcf-130">It also prevents Certificate Services from processing Certificate Requests until the restoration is complete.</span></span>
10. <span data-ttu-id="54bcf-131">Llame a [**CertSrvRestoreRegisterComplete**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete), con lo que finalizará la actividad de registro que comenzó en el paso 8.</span><span class="sxs-lookup"><span data-stu-id="54bcf-131">Call [**CertSrvRestoreRegisterComplete**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete), thereby finishing the registration activity that started in step 8.</span></span> <span data-ttu-id="54bcf-132">Tenga en cuenta que el registro de una operación de restauración es una instrucción para que los servicios de Certificate Server sigan al iniciarse; la recuperación real solo tendrá lugar después de que se inicie servicios de Certificate Server.</span><span class="sxs-lookup"><span data-stu-id="54bcf-132">Note that the registration of a restore operation is an instruction for Certificate Services to follow when it is started; the actual recovery will take place only after Certificate Services is started.</span></span>
11. <span data-ttu-id="54bcf-133">Para restaurar cada copia de seguridad incremental, copie los archivos contenidos en la copia de seguridad incremental en el directorio de registro activo del servidor de destino y, a continuación, llame a [**CertSrvRestoreRegister**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw), seguido de una llamada a [**CertSrvRestoreRegisterComplete**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete).</span><span class="sxs-lookup"><span data-stu-id="54bcf-133">For each incremental backup to be restored, copy the files contained in the incremental backup to the target server's active log directory, then call [**CertSrvRestoreRegister**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw), followed by a call to [**CertSrvRestoreRegisterComplete**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete).</span></span> <span data-ttu-id="54bcf-134">El registro de las copias de seguridad incrementales para la restauración puede realizarse en cualquier orden, pero solo el conjunto de archivos para una copia de seguridad incremental debe copiarse en el servidor antes de cada llamada a **CertSrvRestoreRegister**.</span><span class="sxs-lookup"><span data-stu-id="54bcf-134">The registration of the incremental backups for restoration can occur in any order, but only the set of files for one incremental backup should be copied to the server before each call to **CertSrvRestoreRegister**.</span></span>
12. <span data-ttu-id="54bcf-135">Copie los archivos dinámicos de servicios de servidor de certificados en el servidor de destino.</span><span class="sxs-lookup"><span data-stu-id="54bcf-135">Copy the Certificate Services dynamic files to the target server.</span></span> <span data-ttu-id="54bcf-136">Los archivos dinámicos se habrían identificado durante la copia de seguridad cuando se llamó a [**CertSrvBackupGetDynamicFileList**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) .</span><span class="sxs-lookup"><span data-stu-id="54bcf-136">The dynamic files would have been identified during the backup when [**CertSrvBackupGetDynamicFileList**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) was called.</span></span> <span data-ttu-id="54bcf-137">Puede que sea necesario detener el servicio de publicación de World Wide Web para permitir que se sobrescriban los archivos dinámicos.</span><span class="sxs-lookup"><span data-stu-id="54bcf-137">It may be necessary to stop the World Wide Web Publishing Service to allow overwriting the dynamic files.</span></span>
13. <span data-ttu-id="54bcf-138">Llame a [**CertSrvRestoreEnd**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreend) para finalizar la sesión de restauración.</span><span class="sxs-lookup"><span data-stu-id="54bcf-138">Call [**CertSrvRestoreEnd**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreend) to end the restore session.</span></span>
14. <span data-ttu-id="54bcf-139">Inicie la aplicación de servicios de certificados manualmente (o espere hasta el siguiente reinicio para que se inicie automáticamente).</span><span class="sxs-lookup"><span data-stu-id="54bcf-139">Start the Certificate Services application manually (or wait until the next restart for it to start automatically).</span></span> <span data-ttu-id="54bcf-140">Cuando se inicia servicios de Certificate Server, determinará si se ha registrado una operación de restauración; Si se ha registrado una operación de restauración, los servicios de Certificate Server iniciarán la recuperación.</span><span class="sxs-lookup"><span data-stu-id="54bcf-140">When Certificate Services starts, it will determine whether a restore operation has been registered; if a restore operation has been registered, Certificate Services will begin the recovery.</span></span> <span data-ttu-id="54bcf-141">Los servicios de Certificate Server no procesarán ninguna solicitud de certificado hasta que se complete la operación de recuperación.</span><span class="sxs-lookup"><span data-stu-id="54bcf-141">Certificate Services will not process any certificate requests until the recovery operation is completed.</span></span>

> [!Note]  
> <span data-ttu-id="54bcf-142">Una vez finalizada la recuperación, es importante que realice una nueva copia de seguridad completa de la base de datos de servicios de Certificate Server.</span><span class="sxs-lookup"><span data-stu-id="54bcf-142">When a recovery is complete, it is important that you make a new full backup of the Certificate Services database.</span></span> <span data-ttu-id="54bcf-143">Esto es necesario para truncar los archivos de registro restaurados y establecer un conjunto de copia de seguridad base para las restauraciones futuras.</span><span class="sxs-lookup"><span data-stu-id="54bcf-143">This is necessary to truncate the restored log files and to establish a base backup set for future restores.</span></span> <span data-ttu-id="54bcf-144">Las copias de seguridad realizadas después de una restauración no se pueden mezclar con las copias de seguridad (completas o incrementales) realizadas antes de la restauración. es decir, después de restaurar una base de datos de servicios de certificados y de haber progresado a un estado posterior, no puede usar las copias de seguridad previas a la restauración para restaurar la base de datos a ese estado posterior.</span><span class="sxs-lookup"><span data-stu-id="54bcf-144">Backups performed after a restore cannot be mixed with backups (full or incremental) taken before the restore; that is, after a certificate services database is restored and has progressed to a subsequent state, you cannot use the pre-restoration backups to restore the database to that subsequent state.</span></span>

 

 

 
