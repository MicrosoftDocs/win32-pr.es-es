---
description: Cuando un programa de control de servicios solicita que se ejecute un nuevo servicio, el administrador de control de servicios (SCM) inicia el servicio y envía una solicitud de inicio al distribuidor del control.
ms.assetid: e55e056f-7628-4e3d-9aea-b55c371b4287
title: Función ServiceMain del servicio
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ed50f0f378f348415e56827a09fcf17eea7fc330
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/08/2021
ms.locfileid: "104002845"
---
# <a name="service-servicemain-function"></a><span data-ttu-id="b2d01-103">Función ServiceMain del servicio</span><span class="sxs-lookup"><span data-stu-id="b2d01-103">Service ServiceMain Function</span></span>

<span data-ttu-id="b2d01-104">Cuando un programa de control de servicios solicita que se ejecute un nuevo servicio, el administrador de control de servicios (SCM) inicia el servicio y envía una solicitud de inicio al distribuidor del control.</span><span class="sxs-lookup"><span data-stu-id="b2d01-104">When a service control program requests that a new service run, the Service Control Manager (SCM) starts the service and sends a start request to the control dispatcher.</span></span> <span data-ttu-id="b2d01-105">El distribuidor de control crea un nuevo subproceso para ejecutar la función [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) para el servicio.</span><span class="sxs-lookup"><span data-stu-id="b2d01-105">The control dispatcher creates a new thread to execute the [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) function for the service.</span></span> <span data-ttu-id="b2d01-106">Para obtener un ejemplo, vea [escribir una función ServiceMain](writing-a-servicemain-function.md).</span><span class="sxs-lookup"><span data-stu-id="b2d01-106">For an example, see [Writing a ServiceMain Function](writing-a-servicemain-function.md).</span></span>

<span data-ttu-id="b2d01-107">La función [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) debe realizar las siguientes tareas:</span><span class="sxs-lookup"><span data-stu-id="b2d01-107">The [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) function should perform the following tasks:</span></span>

1.  <span data-ttu-id="b2d01-108">Inicialice todas las variables globales.</span><span class="sxs-lookup"><span data-stu-id="b2d01-108">Initialize all global variables.</span></span>
2.  <span data-ttu-id="b2d01-109">Llame a la función [**RegisterServiceCtrlHandler**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlera) inmediatamente para registrar una función de [**controlador**](/windows/desktop/api/Winsvc/nc-winsvc-lphandler_function) para controlar las solicitudes de control del servicio.</span><span class="sxs-lookup"><span data-stu-id="b2d01-109">Call the [**RegisterServiceCtrlHandler**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlera) function immediately to register a [**Handler**](/windows/desktop/api/Winsvc/nc-winsvc-lphandler_function) function to handle control requests for the service.</span></span> <span data-ttu-id="b2d01-110">El valor devuelto de **RegisterServiceCtrlHandler** es un *identificador de estado de servicio* que se usará en las llamadas para notificar al SCM el estado del servicio.</span><span class="sxs-lookup"><span data-stu-id="b2d01-110">The return value of **RegisterServiceCtrlHandler** is a *service status handle* that will be used in calls to notify the SCM of the service status.</span></span>
3.  <span data-ttu-id="b2d01-111">Realizar la inicialización.</span><span class="sxs-lookup"><span data-stu-id="b2d01-111">Perform initialization.</span></span> <span data-ttu-id="b2d01-112">Si se espera que el tiempo de ejecución del código de inicialización sea muy breve (menos de un segundo), la inicialización se puede realizar directamente en [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona).</span><span class="sxs-lookup"><span data-stu-id="b2d01-112">If the execution time of the initialization code is expected to be very short (less than one second), initialization can be performed directly in [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona).</span></span>

    <span data-ttu-id="b2d01-113">Si se espera que el tiempo de inicialización sea superior a un segundo, el servicio debe usar una de las siguientes técnicas de inicialización:</span><span class="sxs-lookup"><span data-stu-id="b2d01-113">If the initialization time is expected to be longer than one second, the service should use one of the following initialization techniques:</span></span>

    -   <span data-ttu-id="b2d01-114">Llame a la función [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) para que el servicio de informes \_ se ejecute, pero no acepte ningún control hasta que finalice la inicialización.</span><span class="sxs-lookup"><span data-stu-id="b2d01-114">Call the [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) function to report SERVICE\_RUNNING but accept no controls until initialization is finished.</span></span> <span data-ttu-id="b2d01-115">Para ello, el servicio llama a **SetServiceStatus** con **DWCURRENTSTATE** establecido en Service \_ Running y **dwControlsAccepted** establecido en 0 en la estructura de [**\_ Estado del servicio**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) .</span><span class="sxs-lookup"><span data-stu-id="b2d01-115">The service does this by calling **SetServiceStatus** with **dwCurrentState** set to SERVICE\_RUNNING and **dwControlsAccepted** set to 0 in the [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure.</span></span> <span data-ttu-id="b2d01-116">Esto garantiza que el SCM no enviará ninguna solicitud de control al servicio antes de que esté listo y liberará el SCM para administrar otros servicios.</span><span class="sxs-lookup"><span data-stu-id="b2d01-116">This ensures that the SCM will not send any control requests to the service before it is ready and frees the SCM to manage other services.</span></span> <span data-ttu-id="b2d01-117">Se recomienda usar este enfoque para la inicialización en el rendimiento, especialmente en el caso de los servicios de inicio automático.</span><span class="sxs-lookup"><span data-stu-id="b2d01-117">This approach to initialization is recommended for performance, especially for autostart services.</span></span>
    -   <span data-ttu-id="b2d01-118">Inicio del servicio de informes \_ \_ pendiente, no aceptar controles y especificar una sugerencia de espera.</span><span class="sxs-lookup"><span data-stu-id="b2d01-118">Report SERVICE\_START\_PENDING, accept no controls, and specify a wait hint.</span></span> <span data-ttu-id="b2d01-119">Si el código de inicialización del servicio realiza tareas que se espera que tarden más tiempo que el valor de la sugerencia de espera inicial, el código debe llamar a la función [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) periódicamente (posiblemente con una sugerencia de espera revisada) para indicar que se está realizando el progreso.</span><span class="sxs-lookup"><span data-stu-id="b2d01-119">If your service's initialization code performs tasks that are expected to take longer than the initial wait hint value, your code must call the [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) function periodically (possibly with a revised wait hint) to indicate that progress is being made.</span></span> <span data-ttu-id="b2d01-120">Asegúrese de llamar a **SetServiceStatus** solo si la inicialización está realizando el progreso.</span><span class="sxs-lookup"><span data-stu-id="b2d01-120">Be sure to call **SetServiceStatus** only if the initialization is making progress.</span></span> <span data-ttu-id="b2d01-121">En caso contrario, el SCM puede esperar a que el servicio entre en el estado de ejecución del servicio \_ suponiendo que el servicio progresa y bloquee el inicio de otros servicios.</span><span class="sxs-lookup"><span data-stu-id="b2d01-121">Otherwise the SCM can wait for your service to enter the SERVICE\_RUNNING state assuming that your service is making progress and block other services from starting.</span></span> <span data-ttu-id="b2d01-122">No llame a **SetServiceStatus** desde un subproceso independiente a menos que esté seguro de que el subproceso que realiza la inicialización está progresando realmente.</span><span class="sxs-lookup"><span data-stu-id="b2d01-122">Do not call **SetServiceStatus** from a separate thread unless you are sure the thread performing the initialization is truly making progress.</span></span>

        <span data-ttu-id="b2d01-123">Un servicio que usa este enfoque también puede especificar un valor de punto de comprobación e incrementar el valor periódicamente durante una inicialización prolongada.</span><span class="sxs-lookup"><span data-stu-id="b2d01-123">A service that uses this approach can also specify a check-point value and increment the value periodically during a lengthy initialization.</span></span> <span data-ttu-id="b2d01-124">El programa que inició el servicio puede llamar a [**QueryServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatus) o [**QueryServiceStatusEx**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatusex) para obtener el valor de punto de comprobación más reciente del SCM y usar el valor para informar del progreso incremental al usuario.</span><span class="sxs-lookup"><span data-stu-id="b2d01-124">The program that started the service can call [**QueryServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatus) or [**QueryServiceStatusEx**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatusex) to obtain the latest check-point value from the SCM and use the value to report incremental progress to the user.</span></span>

4.  <span data-ttu-id="b2d01-125">Una vez completada la inicialización, llame a [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) para establecer el estado del servicio en servicio en \_ ejecución y especifique los controles que el servicio está preparado para aceptar.</span><span class="sxs-lookup"><span data-stu-id="b2d01-125">When initialization is complete, call [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) to set the service state to SERVICE\_RUNNING and specify the controls that the service is prepared to accept.</span></span> <span data-ttu-id="b2d01-126">Para obtener una lista de controles, consulte la estructura de [**\_ Estado del servicio**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) .</span><span class="sxs-lookup"><span data-stu-id="b2d01-126">For a list of controls, see the [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure.</span></span>
5.  <span data-ttu-id="b2d01-127">Realice las tareas de servicio o, si no hay tareas pendientes, devuelva el control al autor de la llamada.</span><span class="sxs-lookup"><span data-stu-id="b2d01-127">Perform the service tasks, or, if there are no pending tasks, return control to the caller.</span></span> <span data-ttu-id="b2d01-128">Cualquier cambio en el estado del servicio garantiza una llamada a [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) para notificar la nueva información de estado.</span><span class="sxs-lookup"><span data-stu-id="b2d01-128">Any change in the service state warrants a call to [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) to report new status information.</span></span>
6.  <span data-ttu-id="b2d01-129">Si se produce un error mientras el servicio se está inicializando o se está ejecutando, el servicio debe llamar a [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) para establecer el estado del servicio en \_ detención \_ pendiente si la limpieza va a ser larga.</span><span class="sxs-lookup"><span data-stu-id="b2d01-129">If an error occurs while the service is initializing or running, the service should call [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) to set the service state to SERVICE\_STOP\_PENDING if cleanup will be lengthy.</span></span> <span data-ttu-id="b2d01-130">Una vez completada la limpieza, llame a **SetServiceStatus** para establecer el estado del servicio en servicio \_ detenido desde el último subproceso para finalizar.</span><span class="sxs-lookup"><span data-stu-id="b2d01-130">After cleanup is complete, call **SetServiceStatus** to set the service state to SERVICE\_STOPPED from the last thread to terminate.</span></span> <span data-ttu-id="b2d01-131">Asegúrese de establecer los miembros **dwServiceSpecificExitCode** y **dwWin32ExitCode** de la estructura [**de \_ Estado del servicio**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) para identificar el error.</span><span class="sxs-lookup"><span data-stu-id="b2d01-131">Be sure to set the **dwServiceSpecificExitCode** and **dwWin32ExitCode** members of the [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure to identify the error.</span></span>

## <a name="related-topics"></a><span data-ttu-id="b2d01-132">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="b2d01-132">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="b2d01-133">Escribir una función ServiceMain</span><span class="sxs-lookup"><span data-stu-id="b2d01-133">Writing a ServiceMain Function</span></span>](writing-a-servicemain-function.md)
</dt> </dl>

 

 
