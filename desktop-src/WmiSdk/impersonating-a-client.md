---
description: Cuando una aplicación de usuario solicita datos de objetos del sistema a través de un proveedor WMI, la suplantación significa que el proveedor presenta las credenciales que representan el nivel de seguridad de los clientes en lugar de los proveedores.
ms.assetid: 6d54f234-45aa-445b-ad50-7d5a9946c134
ms.tgt_platform: multiple
title: Suplantar a un cliente
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 162857d90c8bddb70d90eb2e10efbc08537299d9
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/08/2021
ms.locfileid: "103911506"
---
# <a name="impersonating-a-client"></a><span data-ttu-id="4f019-103">Suplantar a un cliente</span><span class="sxs-lookup"><span data-stu-id="4f019-103">Impersonating a Client</span></span>

<span data-ttu-id="4f019-104">Cuando una aplicación de usuario solicita datos de objetos en el sistema a través de un proveedor WMI, la suplantación significa que el proveedor presenta las credenciales que representan el nivel de seguridad del cliente en lugar de la del proveedor.</span><span class="sxs-lookup"><span data-stu-id="4f019-104">When a user application requests data from objects on the system through a WMI provider, impersonation means the provider presents credentials that represent the client's security level rather than the provider's.</span></span> <span data-ttu-id="4f019-105">La suplantación impide que un cliente obtenga acceso no autorizado a la información del sistema.</span><span class="sxs-lookup"><span data-stu-id="4f019-105">Impersonation prevents a client from obtaining unauthorized access to information on the system.</span></span>

<span data-ttu-id="4f019-106">En este tema se describen las siguientes secciones:</span><span class="sxs-lookup"><span data-stu-id="4f019-106">The following sections are discussed in this topic:</span></span>

-   [<span data-ttu-id="4f019-107">Registrar un proveedor para la suplantación</span><span class="sxs-lookup"><span data-stu-id="4f019-107">Registering a Provider for Impersonation</span></span>](#registering-a-provider-for-impersonation)
-   [<span data-ttu-id="4f019-108">Establecer los niveles de suplantación dentro de un proveedor</span><span class="sxs-lookup"><span data-stu-id="4f019-108">Setting Impersonation Levels Within a Provider</span></span>](#setting-impersonation-levels-within-a-provider)
-   [<span data-ttu-id="4f019-109">Mantenimiento de los niveles de seguridad de un proveedor</span><span class="sxs-lookup"><span data-stu-id="4f019-109">Maintaining Security Levels in a Provider</span></span>](#maintaining-security-levels-in-a-provider)
-   [<span data-ttu-id="4f019-110">Controlar los mensajes de acceso denegado en un proveedor</span><span class="sxs-lookup"><span data-stu-id="4f019-110">Handling Access Denied Messages in a Provider</span></span>](#handling-access-denied-messages-in-a-provider)
-   [<span data-ttu-id="4f019-111">Informar de instancias parciales</span><span class="sxs-lookup"><span data-stu-id="4f019-111">Reporting Partial Instances</span></span>](#reporting-partial-instances)
-   [<span data-ttu-id="4f019-112">Enumeración parcial de informes</span><span class="sxs-lookup"><span data-stu-id="4f019-112">Reporting Partial Enumerations</span></span>](#reporting-partial-enumerations)
-   [<span data-ttu-id="4f019-113">Depuración del código de acceso denegado</span><span class="sxs-lookup"><span data-stu-id="4f019-113">Debugging Your Access Denied Code</span></span>](#debugging-your-access-denied-code)
-   [<span data-ttu-id="4f019-114">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="4f019-114">Related topics</span></span>](#related-topics)

<span data-ttu-id="4f019-115">Normalmente, WMI se ejecuta como un servicio administrativo en un nivel de seguridad alto, mediante el contexto de seguridad LocalServer.</span><span class="sxs-lookup"><span data-stu-id="4f019-115">WMI typically runs as an administrative service at a high security level, using the LocalServer security context.</span></span> <span data-ttu-id="4f019-116">El uso de un servicio administrativo proporciona a WMI los medios para tener acceso a la información privilegiada.</span><span class="sxs-lookup"><span data-stu-id="4f019-116">Using an administrative service gives WMI the means to access privileged information.</span></span> <span data-ttu-id="4f019-117">Cuando se llama a un proveedor para obtener información, WMI pasa su identificador de seguridad (SID) al proveedor, lo que permite al proveedor tener acceso a información en el mismo nivel de seguridad alto.</span><span class="sxs-lookup"><span data-stu-id="4f019-117">When calling a provider for information, WMI passes its security identifier (SID) to the provider, enabling the provider to access information at the same high security level.</span></span>

<span data-ttu-id="4f019-118">Durante el proceso de inicio de la aplicación WMI, el sistema operativo Windows proporciona a la aplicación WMI el contexto de seguridad del usuario que inició el proceso.</span><span class="sxs-lookup"><span data-stu-id="4f019-118">During the WMI application launch process, the Windows operating system gives the WMI application the security context of the user who began the process.</span></span> <span data-ttu-id="4f019-119">Normalmente, el contexto de seguridad del usuario es un nivel de seguridad inferior al de LocalServer, por lo que es posible que el usuario no tenga permiso de acceso a toda la información disponible en WMI.</span><span class="sxs-lookup"><span data-stu-id="4f019-119">The security context of the user is typically a lower security level than LocalServer, so the user may not have permission to access all of the information available to WMI.</span></span> <span data-ttu-id="4f019-120">Cuando la aplicación de usuario solicita información dinámica, WMI pasa el SID del usuario al proveedor correspondiente.</span><span class="sxs-lookup"><span data-stu-id="4f019-120">When the user application asks for dynamic information, WMI passes the SID of the user to the corresponding provider.</span></span> <span data-ttu-id="4f019-121">Si se escribe correctamente, el proveedor intenta tener acceso a la información con el SID de usuario, en lugar del SID del proveedor.</span><span class="sxs-lookup"><span data-stu-id="4f019-121">If written appropriately, the provider attempts to access information with the user SID, rather than the provider SID.</span></span>

<span data-ttu-id="4f019-122">Para que el proveedor suplante correctamente la aplicación cliente, la aplicación cliente y el proveedor deben cumplir los siguientes criterios:</span><span class="sxs-lookup"><span data-stu-id="4f019-122">For the provider to successfully impersonate the client application, the client application and provider must meet the following criteria:</span></span>

-   <span data-ttu-id="4f019-123">La aplicación cliente debe llamar a WMI con un nivel de seguridad de conexión COM del **\_ \_ \_ \_ delegado de nivel** de Imp. **\_ \_ \_ \_**</span><span class="sxs-lookup"><span data-stu-id="4f019-123">The client application must call WMI with a COM connection security level of **RPC\_C\_IMP\_LEVEL\_IMPERSONATE** or **RPC\_C\_IMP\_LEVEL\_DELEGATE**.</span></span> <span data-ttu-id="4f019-124">Para obtener más información, vea [mantener la seguridad de WMI](maintaining-wmi-security.md).</span><span class="sxs-lookup"><span data-stu-id="4f019-124">For more information, see [Maintaining WMI Security](maintaining-wmi-security.md).</span></span>
-   <span data-ttu-id="4f019-125">El proveedor debe registrarse en WMI como proveedor de suplantación.</span><span class="sxs-lookup"><span data-stu-id="4f019-125">The provider must register with WMI as an impersonation provider.</span></span> <span data-ttu-id="4f019-126">Para obtener más información, vea [registrar un proveedor para la suplantación](#registering-a-provider-for-impersonation).</span><span class="sxs-lookup"><span data-stu-id="4f019-126">For more information, see [Registering a Provider for Impersonation](#registering-a-provider-for-impersonation).</span></span>
-   <span data-ttu-id="4f019-127">El proveedor debe cambiar al nivel de seguridad de la aplicación cliente antes de tener acceso a la información privilegiada.</span><span class="sxs-lookup"><span data-stu-id="4f019-127">The provider must switch to the security level of the client application before accessing privileged information.</span></span> <span data-ttu-id="4f019-128">Para obtener más información, vea [configuración de los niveles de suplantación dentro de un proveedor](#setting-impersonation-levels-within-a-provider).</span><span class="sxs-lookup"><span data-stu-id="4f019-128">For more information, see [Setting Impersonation Levels Within a Provider](#setting-impersonation-levels-within-a-provider).</span></span>
-   <span data-ttu-id="4f019-129">El proveedor debe administrar correctamente las condiciones de error si se deniega el acceso a esta información.</span><span class="sxs-lookup"><span data-stu-id="4f019-129">The provider must correctly handle error conditions if access to this information is denied.</span></span> <span data-ttu-id="4f019-130">Para obtener más información, vea [controlar los mensajes de acceso denegado en un proveedor](#handling-access-denied-messages-in-a-provider).</span><span class="sxs-lookup"><span data-stu-id="4f019-130">For more information, see [Handling Access Denied Messages in a Provider](#handling-access-denied-messages-in-a-provider).</span></span>

## <a name="registering-a-provider-for-impersonation"></a><span data-ttu-id="4f019-131">Registrar un proveedor para la suplantación</span><span class="sxs-lookup"><span data-stu-id="4f019-131">Registering a Provider for Impersonation</span></span>

<span data-ttu-id="4f019-132">WMI solo pasa el SID de una aplicación cliente a los proveedores que se han registrado como proveedores de suplantación.</span><span class="sxs-lookup"><span data-stu-id="4f019-132">WMI only passes the SID of a client application to providers who have registered as impersonation providers.</span></span> <span data-ttu-id="4f019-133">La habilitación de un proveedor para realizar la suplantación requiere que se modifique el proceso de registro del proveedor.</span><span class="sxs-lookup"><span data-stu-id="4f019-133">Enabling a provider to perform impersonation requires that you modify the provider registration process.</span></span>

<span data-ttu-id="4f019-134">En el procedimiento siguiente se describe cómo registrar un proveedor para la suplantación.</span><span class="sxs-lookup"><span data-stu-id="4f019-134">The following procedure describes how to register a provider for impersonation.</span></span> <span data-ttu-id="4f019-135">En el procedimiento se supone que ya entiende el proceso de registro.</span><span class="sxs-lookup"><span data-stu-id="4f019-135">The procedure assumes that you already understand the registration process.</span></span> <span data-ttu-id="4f019-136">Para obtener más información sobre el proceso de registro, vea [registrar un proveedor](registering-a-provider.md).</span><span class="sxs-lookup"><span data-stu-id="4f019-136">For more information about the registration process, see [Registering a Provider](registering-a-provider.md).</span></span>

<span data-ttu-id="4f019-137">**Para registrar un proveedor para la suplantación**</span><span class="sxs-lookup"><span data-stu-id="4f019-137">**To register a provider for impersonation**</span></span>

1.  <span data-ttu-id="4f019-138">Establezca la propiedad [**ImpersonationLevel**](swbemsecurity-impersonationlevel.md) de la clase [**\_ \_ Win32Provider**](--win32provider.md) que representa el proveedor en 1.</span><span class="sxs-lookup"><span data-stu-id="4f019-138">Set the [**ImpersonationLevel**](swbemsecurity-impersonationlevel.md) property of the [**\_\_Win32Provider**](--win32provider.md) class that represents your provider to 1.</span></span>

    <span data-ttu-id="4f019-139">La propiedad [**ImpersonationLevel**](swbemsecurity-impersonationlevel.md) documenta si el proveedor admite la suplantación o no.</span><span class="sxs-lookup"><span data-stu-id="4f019-139">The [**ImpersonationLevel**](swbemsecurity-impersonationlevel.md) property documents whether the provider supports impersonation or not.</span></span> <span data-ttu-id="4f019-140">Al establecer **ImpersonationLevel** en 0, se indica que el proveedor no suplanta al cliente y realiza todas las operaciones solicitadas en el mismo contexto de usuario que WMI.</span><span class="sxs-lookup"><span data-stu-id="4f019-140">Setting **ImpersonationLevel** to 0 indicates that the provider does not impersonate the client and performs all requested operations in the same user context as WMI.</span></span> <span data-ttu-id="4f019-141">Al establecer **ImpersonationLevel** en 1, se indica que el proveedor utiliza las llamadas de suplantación para comprobar las operaciones realizadas en nombre del cliente.</span><span class="sxs-lookup"><span data-stu-id="4f019-141">Setting **ImpersonationLevel** to 1 indicates that the provider uses impersonation calls to check operations performed on behalf of the client.</span></span>

2.  <span data-ttu-id="4f019-142">Establezca la propiedad **PerUserInitialization** de la misma clase [**\_ \_ Win32Provider**](--win32provider.md) en **true**.</span><span class="sxs-lookup"><span data-stu-id="4f019-142">Set the **PerUserInitialization** property of the same [**\_\_Win32Provider**](--win32provider.md) class to **TRUE**.</span></span>

> [!Note]  
> <span data-ttu-id="4f019-143">Si registra un proveedor con la propiedad [**\_ \_ Win32Provider**](--win32provider.md) **InitializeAsAdminFirst** establecida en **true**, el proveedor utiliza el token de seguridad de subprocesos de nivel de administración solo durante la fase de inicialización.</span><span class="sxs-lookup"><span data-stu-id="4f019-143">If you register a provider with the [**\_\_Win32Provider**](--win32provider.md) property **InitializeAsAdminFirst** set to **TRUE**, then the provider uses the administration-level thread security token only during the initialization phase.</span></span> <span data-ttu-id="4f019-144">Aunque no se produce un error en una llamada a [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) , el proveedor utiliza el contexto de seguridad de WMI y no del cliente.</span><span class="sxs-lookup"><span data-stu-id="4f019-144">While a call to [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) does not fail, the provider uses the security context of WMI and not of the client.</span></span>

 

<span data-ttu-id="4f019-145">En el ejemplo de código siguiente se muestra cómo registrar un proveedor para la suplantación.</span><span class="sxs-lookup"><span data-stu-id="4f019-145">The following code example shows how to register a provider for impersonation.</span></span>

``` syntax
instance of __Win32Provider
{
    CLSID = "{FD4F53E0-65DC-11d1-AB64-00C04FD9159E}";
    ImpersonationLevel = 1;
    Name = "MS_NT_EVENTLOG_PROVIDER";
    PerUserInitialization = TRUE;
};
```

## <a name="setting-impersonation-levels-within-a-provider"></a><span data-ttu-id="4f019-146">Establecer los niveles de suplantación dentro de un proveedor</span><span class="sxs-lookup"><span data-stu-id="4f019-146">Setting Impersonation Levels Within a Provider</span></span>

<span data-ttu-id="4f019-147">Si registra un proveedor con la propiedad de clase [**\_ \_ Win32Provider**](--win32provider.md) [**ImpersonationLevel**](swbemsecurity-impersonationlevel.md) establecida en 1, WMI llama a su proveedor para suplantar a varios clientes.</span><span class="sxs-lookup"><span data-stu-id="4f019-147">If you register a provider with the [**\_\_Win32Provider**](--win32provider.md) class property [**ImpersonationLevel**](swbemsecurity-impersonationlevel.md) set to 1, then WMI calls your provider to impersonate various clients.</span></span> <span data-ttu-id="4f019-148">Para controlar estas llamadas, utilice las funciones de com [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) y [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself) en la implementación de la interfaz [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) .</span><span class="sxs-lookup"><span data-stu-id="4f019-148">To handle these calls, use the [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) and [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself) COM functions in your implementation of the [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) interface.</span></span>

<span data-ttu-id="4f019-149">La función [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) permite que un servidor suplante al cliente que realizó la llamada.</span><span class="sxs-lookup"><span data-stu-id="4f019-149">The [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) function allows a server to impersonate the client that made the call.</span></span> <span data-ttu-id="4f019-150">Al colocar una llamada a **CoImpersonateClient** en la implementación de [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices), se permite que el proveedor establezca el token de subproceso del proveedor para que coincida con el token de subproceso del cliente y, por tanto, suplantar al cliente.</span><span class="sxs-lookup"><span data-stu-id="4f019-150">By placing a call to **CoImpersonateClient** into your implementation of [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices), you allow your provider to set the thread token of the provider to match the thread token of the client, and thus impersonate the client.</span></span> <span data-ttu-id="4f019-151">Si no llama a **CoImpersonateClient**, el proveedor ejecuta código en un nivel de seguridad de administrador, con lo que se crea una posible vulnerabilidad de seguridad.</span><span class="sxs-lookup"><span data-stu-id="4f019-151">If you do not call **CoImpersonateClient**, your provider executes code at an administrator level of security, thereby creating a potential security vulnerability.</span></span> <span data-ttu-id="4f019-152">Si el proveedor debe actuar temporalmente como administrador o realizar la comprobación de acceso manualmente, llame a [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself).</span><span class="sxs-lookup"><span data-stu-id="4f019-152">If your provider temporarily needs to act as an administrator or perform the access check manually, then call [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself).</span></span>

<span data-ttu-id="4f019-153">A diferencia de [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient), [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself) es una función com que controla los niveles de suplantación de subprocesos.</span><span class="sxs-lookup"><span data-stu-id="4f019-153">In contrast to [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient), [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself) is a COM function that handles thread impersonation levels.</span></span> <span data-ttu-id="4f019-154">En este caso, **CoRevertToSelf** cambia el nivel de suplantación de nuevo a la configuración de suplantación original.</span><span class="sxs-lookup"><span data-stu-id="4f019-154">In this case, **CoRevertToSelf** changes the impersonation level back to the original impersonation setting.</span></span> <span data-ttu-id="4f019-155">En general, el proveedor es inicialmente un administrador y alterna entre **CoImpersonateClient** y **CoRevertToSelf** , dependiendo de si está realizando una llamada que representa al llamador o a sus propias llamadas.</span><span class="sxs-lookup"><span data-stu-id="4f019-155">In general, the provider is initially an administrator and alternates between **CoImpersonateClient** and **CoRevertToSelf** depending on whether it is making a call that represents the caller or its own calls.</span></span> <span data-ttu-id="4f019-156">Es responsabilidad del proveedor colocar estas llamadas correctamente para que no exponga una carencia de seguridad al usuario final.</span><span class="sxs-lookup"><span data-stu-id="4f019-156">It is the responsibility of the provider to place these calls correctly so as not to expose a security hole to the end user.</span></span> <span data-ttu-id="4f019-157">Por ejemplo, el proveedor solo debe llamar a funciones nativas de Windows dentro de la secuencia de código suplantado.</span><span class="sxs-lookup"><span data-stu-id="4f019-157">For example, the provider should only call native Windows functions within the impersonated code sequence.</span></span>

> [!Note]  
> <span data-ttu-id="4f019-158">El propósito de [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) y [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself) es establecer la seguridad de un proveedor.</span><span class="sxs-lookup"><span data-stu-id="4f019-158">The purpose of [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) and [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself) is to set security for a provider.</span></span> <span data-ttu-id="4f019-159">Si determina que se ha producido un error en la suplantación, debe devolver un código de finalización adecuado a WMI a través de [**IWbemObjectSink:: SetStatus**](/windows/desktop/api/Wbemcli/nf-wbemcli-iwbemobjectsink-setstatus).</span><span class="sxs-lookup"><span data-stu-id="4f019-159">If you determine that your impersonation has failed, you should return an appropriate completion code to WMI through [**IWbemObjectSink::SetStatus**](/windows/desktop/api/Wbemcli/nf-wbemcli-iwbemobjectsink-setstatus).</span></span> <span data-ttu-id="4f019-160">Para obtener más información, vea [controlar los mensajes de acceso denegado en un proveedor](#handling-access-denied-messages-in-a-provider).</span><span class="sxs-lookup"><span data-stu-id="4f019-160">For more information, see [Handling Access Denied Messages in a Provider](#handling-access-denied-messages-in-a-provider).</span></span>

 

## <a name="maintaining-security-levels-in-a-provider"></a><span data-ttu-id="4f019-161">Mantenimiento de los niveles de seguridad de un proveedor</span><span class="sxs-lookup"><span data-stu-id="4f019-161">Maintaining Security Levels in a Provider</span></span>

<span data-ttu-id="4f019-162">Los proveedores no pueden llamar a [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) una vez en una implementación de [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) y suponen que las credenciales de suplantación permanecen en su lugar mientras dure el proveedor.</span><span class="sxs-lookup"><span data-stu-id="4f019-162">Providers cannot call [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) one time in an implementation of [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) and assume that the impersonation credentials remain in place for the duration of the provider.</span></span> <span data-ttu-id="4f019-163">En su lugar, llame a **CoImpersonateClient** varias veces durante el transcurso de una implementación para evitar que WMI cambie las credenciales.</span><span class="sxs-lookup"><span data-stu-id="4f019-163">Instead, call **CoImpersonateClient** multiple times during the course of an implementation to keep WMI from changing the credentials.</span></span>

<span data-ttu-id="4f019-164">La principal preocupación para establecer la suplantación de un proveedor es la reentrada.</span><span class="sxs-lookup"><span data-stu-id="4f019-164">The main concern for setting impersonation for a provider is reentrancy.</span></span> <span data-ttu-id="4f019-165">En este contexto, la reentrada es cuando un proveedor realiza una llamada a WMI para obtener información y espera hasta que WMI vuelva a llamar al proveedor.</span><span class="sxs-lookup"><span data-stu-id="4f019-165">In this context, reentrancy is when a provider makes a call to WMI for information and waits until WMI calls back into the provider.</span></span> <span data-ttu-id="4f019-166">En esencia, el subproceso de ejecución deja el código del proveedor, solo para volver a escribir el código más adelante.</span><span class="sxs-lookup"><span data-stu-id="4f019-166">In essence, the thread of execution leaves the provider code, only to reenter the code at a later date.</span></span> <span data-ttu-id="4f019-167">La reentrada es una parte del diseño de COM y no suele ser un problema.</span><span class="sxs-lookup"><span data-stu-id="4f019-167">Reentry is a part of the design of COM, and is generally not a concern.</span></span> <span data-ttu-id="4f019-168">Sin embargo, cuando el subproceso de ejecución entra en WMI, el subproceso toma los niveles de suplantación de WMI.</span><span class="sxs-lookup"><span data-stu-id="4f019-168">However, when the thread of execution enters WMI, the thread takes on the impersonation levels of WMI.</span></span> <span data-ttu-id="4f019-169">Cuando el subproceso vuelva al proveedor, debe restablecer los niveles de suplantación con otra llamada a [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient).</span><span class="sxs-lookup"><span data-stu-id="4f019-169">When the thread returns to the provider, you must reset the impersonation levels with another call to [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient).</span></span>

<span data-ttu-id="4f019-170">Para protegerse de los agujeros de seguridad en el proveedor, debe realizar llamadas reentrantes en WMI solo mientras suplanta al cliente.</span><span class="sxs-lookup"><span data-stu-id="4f019-170">To protect yourself from security holes in your provider, you should make reentrant calls into WMI only while impersonating the client.</span></span> <span data-ttu-id="4f019-171">Es decir, las llamadas a WMI deben realizarse después de llamar a [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) y antes de llamar a [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself).</span><span class="sxs-lookup"><span data-stu-id="4f019-171">That is, calls to WMI should be made after you call [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) and before you call [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself).</span></span> <span data-ttu-id="4f019-172">Dado que **CoRevertToSelf** hace que la suplantación se establezca en el nivel de usuario, WMI se está ejecutando, por lo general, LocalSystem, las llamadas reentrantes a WMI después de llamar a **CoRevertToSelf** podrían proporcionar al usuario, y a cualquier proveedor llamado, muchas más capacidades de las que deberían tener.</span><span class="sxs-lookup"><span data-stu-id="4f019-172">Because **CoRevertToSelf** causes the impersonation to be set to the user level WMI is running, generally LocalSystem, reentrant calls to WMI after calling **CoRevertToSelf** could give the user, and any providers called, a lot more capabilities than they should have.</span></span>

> [!Note]  
> <span data-ttu-id="4f019-173">Si llama a una función del sistema u otro método de interfaz, no se garantiza que el contexto de llamada se mantenga.</span><span class="sxs-lookup"><span data-stu-id="4f019-173">If you call a system function or another interface method, the call context is not guaranteed to be maintained.</span></span>

 

## <a name="handling-access-denied-messages-in-a-provider"></a><span data-ttu-id="4f019-174">Controlar los mensajes de acceso denegado en un proveedor</span><span class="sxs-lookup"><span data-stu-id="4f019-174">Handling Access Denied Messages in a Provider</span></span>

<span data-ttu-id="4f019-175">La mayoría de los mensajes de error de acceso denegado aparecen cuando un cliente solicita una clase o información a la que no tienen acceso.</span><span class="sxs-lookup"><span data-stu-id="4f019-175">Most Access Denied error messages appear when a client requests a class or information to which they do not have access.</span></span> <span data-ttu-id="4f019-176">Si el proveedor devuelve un mensaje de error de acceso denegado a WMI y WMI lo pasa al cliente, el cliente puede deducir que existe la información.</span><span class="sxs-lookup"><span data-stu-id="4f019-176">If the provider returns an Access Denied error message to WMI and WMI passes this on to the client, the client can infer that the information exists.</span></span> <span data-ttu-id="4f019-177">En algunas situaciones, puede tratarse de una infracción de seguridad.</span><span class="sxs-lookup"><span data-stu-id="4f019-177">In some situations, this can be a breach of security.</span></span> <span data-ttu-id="4f019-178">Por lo tanto, el proveedor no debe propagar el mensaje al cliente.</span><span class="sxs-lookup"><span data-stu-id="4f019-178">Therefore, your provider should not propagate the message to the client.</span></span> <span data-ttu-id="4f019-179">En su lugar, el conjunto de clases que el proveedor habría proporcionado no debe exponerse.</span><span class="sxs-lookup"><span data-stu-id="4f019-179">Instead, the set of classes that the provider would have supplied should not be exposed.</span></span> <span data-ttu-id="4f019-180">De forma similar, un proveedor de instancias dinámicas debe llamar al origen de datos subyacente para determinar cómo tratar los mensajes de acceso denegado.</span><span class="sxs-lookup"><span data-stu-id="4f019-180">Similarly, a dynamic instance provider should call to the underlying data source to determine how to deal with Access Denied messages.</span></span> <span data-ttu-id="4f019-181">Es responsabilidad del proveedor replicar esa filosofía en el entorno de WMI.</span><span class="sxs-lookup"><span data-stu-id="4f019-181">It is the responsibility of the provider to replicate that philosophy into the WMI environment.</span></span> <span data-ttu-id="4f019-182">Para obtener más información, vea [informes de instancias parciales](#reporting-partial-instances) e [informes de enumeraciones parciales](#reporting-partial-enumerations).</span><span class="sxs-lookup"><span data-stu-id="4f019-182">For more information, see [Reporting Partial Instances](#reporting-partial-instances) and [Reporting Partial Enumerations](#reporting-partial-enumerations).</span></span>

<span data-ttu-id="4f019-183">Cuando determine cómo el proveedor debe controlar los mensajes de acceso denegado, debe escribir y depurar el código.</span><span class="sxs-lookup"><span data-stu-id="4f019-183">When you determine how your provider should handle Access Denied messages, you must write and debug your code.</span></span> <span data-ttu-id="4f019-184">Durante la depuración, a menudo es conveniente distinguir entre una denegación debida a una suplantación baja y una denegación debido a un error en el código.</span><span class="sxs-lookup"><span data-stu-id="4f019-184">While debugging, it is often convenient to distinguish between a denial due to low impersonation, and a denial due to an error in your code.</span></span> <span data-ttu-id="4f019-185">Puede usar una prueba sencilla en el código para determinar la diferencia.</span><span class="sxs-lookup"><span data-stu-id="4f019-185">You can use a simple test in your code to determine the difference.</span></span> <span data-ttu-id="4f019-186">Para obtener más información, vea [depurar el código de acceso denegado](#debugging-your-access-denied-code).</span><span class="sxs-lookup"><span data-stu-id="4f019-186">For more information, see [Debugging your Access Denied Code](#debugging-your-access-denied-code).</span></span>

## <a name="reporting-partial-instances"></a><span data-ttu-id="4f019-187">Informar de instancias parciales</span><span class="sxs-lookup"><span data-stu-id="4f019-187">Reporting Partial Instances</span></span>

<span data-ttu-id="4f019-188">Una repetición común de un mensaje de acceso denegado es cuando WMI no puede proporcionar toda la información para rellenar una instancia.</span><span class="sxs-lookup"><span data-stu-id="4f019-188">One common occurrence of an Access Denied message is when WMI cannot provide all the information to fill an instance.</span></span> <span data-ttu-id="4f019-189">Por ejemplo, un cliente puede tener autoridad para ver un objeto de unidad de disco duro, pero puede que no tenga autoridad para ver la cantidad de espacio disponible en la propia unidad de disco duro.</span><span class="sxs-lookup"><span data-stu-id="4f019-189">For example, a client may have the authority to view a hard disk drive object, but may not have authority to see how much space is available on the hard disk drive itself.</span></span> <span data-ttu-id="4f019-190">El proveedor debe determinar cómo tratar cualquier situación en la que el proveedor no puede rellenar completamente una instancia con propiedades debido a una infracción de acceso.</span><span class="sxs-lookup"><span data-stu-id="4f019-190">Your provider must determine how to handle any situation when the provider cannot completely fill an instance with properties due to an access violation.</span></span>

<span data-ttu-id="4f019-191">WMI no requiere una respuesta única a los clientes que tienen acceso parcial a una instancia de.</span><span class="sxs-lookup"><span data-stu-id="4f019-191">WMI does not require a single response to clients that have partial access to an instance.</span></span> <span data-ttu-id="4f019-192">En su lugar, WMI versión 1. x permite al proveedor una de las siguientes opciones:</span><span class="sxs-lookup"><span data-stu-id="4f019-192">Instead, WMI version 1.x allows the provider one of the following options:</span></span>

-   <span data-ttu-id="4f019-193">Se produce un error en toda la operación con **WBEM \_ e \_ acceso \_ denegado** y no se devuelve ninguna instancia.</span><span class="sxs-lookup"><span data-stu-id="4f019-193">Fail the entire operation with **WBEM\_E\_ACCESS\_DENIED** and return no instances.</span></span>

    <span data-ttu-id="4f019-194">Devuelve un objeto de error junto con **WBEM \_ E \_ acceso \_ denegado** para describir el motivo de la denegación.</span><span class="sxs-lookup"><span data-stu-id="4f019-194">Return an error object along with **WBEM\_E\_ACCESS\_DENIED**, to describe the reason for the denial.</span></span>

-   <span data-ttu-id="4f019-195">Devuelve todas las propiedades disponibles y rellena las propiedades no disponibles con un **valor null**.</span><span class="sxs-lookup"><span data-stu-id="4f019-195">Return all available properties, and fill unavailable properties with **NULL**.</span></span>

> [!Note]  
> <span data-ttu-id="4f019-196">Asegúrese de que la devolución de **\_ \_ acceso \_ denegado a WBEM E** no crea una carencia de seguridad en su empresa.</span><span class="sxs-lookup"><span data-stu-id="4f019-196">Make sure that returning **WBEM\_E\_ACCESS\_DENIED** does not create a security hole in your enterprise.</span></span>

 

## <a name="reporting-partial-enumerations"></a><span data-ttu-id="4f019-197">Enumeración parcial de informes</span><span class="sxs-lookup"><span data-stu-id="4f019-197">Reporting Partial Enumerations</span></span>

<span data-ttu-id="4f019-198">Otra aparición común de una infracción de acceso es cuando WMI no puede devolver toda una enumeración.</span><span class="sxs-lookup"><span data-stu-id="4f019-198">Another common occurrence of an access violation is when WMI cannot return all of an enumeration.</span></span> <span data-ttu-id="4f019-199">Por ejemplo, un cliente puede tener acceso para ver todos los objetos de equipo de la red local, pero es posible que no tenga acceso a los objetos de equipo de vista fuera de su dominio.</span><span class="sxs-lookup"><span data-stu-id="4f019-199">For example, a client may have access to view all of the local network computer objects, but may not have access to view computer objects outside of his domain.</span></span> <span data-ttu-id="4f019-200">El proveedor debe determinar cómo tratar cualquier situación en la que no se pueda completar una enumeración debido a una infracción de acceso.</span><span class="sxs-lookup"><span data-stu-id="4f019-200">Your provider must determine how to handle any situation when an enumeration cannot be completed due to an access violation.</span></span>

<span data-ttu-id="4f019-201">Al igual que con un proveedor de instancias, WMI no requiere una única respuesta a una enumeración parcial.</span><span class="sxs-lookup"><span data-stu-id="4f019-201">As with an instance provider, WMI does not require a single response to a partial enumeration.</span></span> <span data-ttu-id="4f019-202">En su lugar, WMI versión 1. x permite a un proveedor de una de las siguientes opciones:</span><span class="sxs-lookup"><span data-stu-id="4f019-202">Instead, WMI version 1.x allows a provider one of the following options:</span></span>

-   <span data-ttu-id="4f019-203">Devolver **WBEM \_ S \_ no \_ error** para todas las instancias a las que el proveedor pueda tener acceso.</span><span class="sxs-lookup"><span data-stu-id="4f019-203">Return **WBEM\_S\_NO\_ERROR** for all instances that the provider can access.</span></span>

    <span data-ttu-id="4f019-204">Si utiliza esta opción, el usuario no es consciente de que algunas instancias no están disponibles.</span><span class="sxs-lookup"><span data-stu-id="4f019-204">If you use this option, the user is not aware that some instances were not available.</span></span> <span data-ttu-id="4f019-205">Varios proveedores, como los que usan Lenguaje de consulta estructurado (SQL) con seguridad de nivel de fila, devuelven resultados parciales correctos mediante el nivel de seguridad del autor de la llamada para definir el conjunto de resultados.</span><span class="sxs-lookup"><span data-stu-id="4f019-205">A number of providers, such as those using Structured Query Language (SQL) with row-level security, return successful partial results using the security level of the caller to define the result set.</span></span>

-   <span data-ttu-id="4f019-206">Se produce un error en toda la operación con **WBEM \_ e \_ acceso \_ denegado** y no se devuelve ninguna instancia.</span><span class="sxs-lookup"><span data-stu-id="4f019-206">Fail the entire operation with **WBEM\_E\_ACCESS\_DENIED** and return no instances.</span></span>

    <span data-ttu-id="4f019-207">Opcionalmente, el proveedor puede incluir un objeto de error que describa la situación del cliente.</span><span class="sxs-lookup"><span data-stu-id="4f019-207">The provider may optionally include an error object that describes the situation to the client.</span></span> <span data-ttu-id="4f019-208">Tenga en cuenta que algunos proveedores pueden acceder a los orígenes de datos en serie y es posible que no encuentren denegaciones hasta que MSRC durante a través de la enumeración.</span><span class="sxs-lookup"><span data-stu-id="4f019-208">Note that some providers may access data sources serially and may not encounter denials until partway through the enumeration.</span></span>

-   <span data-ttu-id="4f019-209">Devuelve todas las instancias de a las que se puede tener acceso, pero que también devuelven el código de estado no error **WBEM \_ S \_ acceso \_ denegado**.</span><span class="sxs-lookup"><span data-stu-id="4f019-209">Return all of the instances that can be accessed but also return the nonerror status code **WBEM\_S\_ACCESS\_DENIED**.</span></span>

    <span data-ttu-id="4f019-210">El proveedor debe anotar la denegación durante la enumeración y puede continuar proporcionando instancias, con el código de estado sin errores.</span><span class="sxs-lookup"><span data-stu-id="4f019-210">The provider should note the denial during enumeration and may continue providing instances, finishing up with the nonerror status code.</span></span> <span data-ttu-id="4f019-211">El proveedor también puede elegir finalizar la enumeración en la primera denegación.</span><span class="sxs-lookup"><span data-stu-id="4f019-211">The provider may also elect to terminate the enumeration at the first denial.</span></span> <span data-ttu-id="4f019-212">La justificación de esta opción es que los distintos proveedores tienen diferentes paradigmas de recuperación.</span><span class="sxs-lookup"><span data-stu-id="4f019-212">The justification for this option is that different providers have different retrieval paradigms.</span></span> <span data-ttu-id="4f019-213">Un proveedor puede haber proporcionado ya instancias antes de detectar una infracción de acceso.</span><span class="sxs-lookup"><span data-stu-id="4f019-213">A provider may have already delivered instances before discovering an access violation.</span></span> <span data-ttu-id="4f019-214">Algunos proveedores pueden optar por continuar proporcionando otras instancias y otros pueden querer terminar.</span><span class="sxs-lookup"><span data-stu-id="4f019-214">Some providers may elect to continue providing other instances and others may wish to terminate.</span></span>

<span data-ttu-id="4f019-215">Debido a la estructura de COM, no se pueden calcular las referencias de ninguna información durante un error, excepto un objeto de error.</span><span class="sxs-lookup"><span data-stu-id="4f019-215">Due to the structure of COM, you cannot marshal back any information during an error except for an error object.</span></span> <span data-ttu-id="4f019-216">Por lo tanto, no se puede devolver información y un código de error.</span><span class="sxs-lookup"><span data-stu-id="4f019-216">Therefore, you cannot return both information and an error code.</span></span> <span data-ttu-id="4f019-217">Si decide devolver información, debe utilizar en su lugar un código de estado sin errores.</span><span class="sxs-lookup"><span data-stu-id="4f019-217">If you choose to return information, you must use a nonerror status code instead.</span></span>

## <a name="debugging-your-access-denied-code"></a><span data-ttu-id="4f019-218">Depuración del código de acceso denegado</span><span class="sxs-lookup"><span data-stu-id="4f019-218">Debugging Your Access Denied Code</span></span>

<span data-ttu-id="4f019-219">Algunas aplicaciones pueden usar niveles de suplantación inferiores a la **\_ \_ \_ \_ suplantación del nivel Imp de RPC C**.</span><span class="sxs-lookup"><span data-stu-id="4f019-219">Some applications may use impersonation levels lower than **RPC\_C\_IMP\_LEVEL\_IMPERSONATE**.</span></span> <span data-ttu-id="4f019-220">En este caso, se producirá un error en la mayoría de las llamadas de suplantación realizadas por el proveedor para la aplicación cliente.</span><span class="sxs-lookup"><span data-stu-id="4f019-220">In this case, most impersonation calls made by the provider for the client application will fail.</span></span> <span data-ttu-id="4f019-221">Para diseñar e implementar correctamente un proveedor, debe tener en cuenta esta idea.</span><span class="sxs-lookup"><span data-stu-id="4f019-221">To successfully design and implement a provider, you must keep this idea in mind.</span></span>

<span data-ttu-id="4f019-222">De forma predeterminada, el único otro nivel de suplantación que puede tener acceso a un proveedor es el **\_ \_ \_ nivel \_ Imp de RPC C**.</span><span class="sxs-lookup"><span data-stu-id="4f019-222">By default, the only other level of impersonation that can access a provider is **RPC\_C\_IMP\_LEVEL\_IDENTIFY**.</span></span> <span data-ttu-id="4f019-223">En los casos en los que una aplicación cliente usa el **\_ \_ \_ nivel \_ Imp de RPC C**, [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) no devuelve un código de error.</span><span class="sxs-lookup"><span data-stu-id="4f019-223">In cases where a client application uses **RPC\_C\_IMP\_LEVEL\_IDENTIFY**, [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) does not return an error code.</span></span> <span data-ttu-id="4f019-224">En su lugar, el proveedor suplanta al cliente solo con fines de identificación.</span><span class="sxs-lookup"><span data-stu-id="4f019-224">Instead, the provider impersonates the client for identification purposes only.</span></span> <span data-ttu-id="4f019-225">Por consiguiente, la mayoría de los métodos de Windows llamados por el proveedor devolverán un mensaje de acceso denegado.</span><span class="sxs-lookup"><span data-stu-id="4f019-225">Therefore, most Windows methods called by the provider will return an access denied message.</span></span> <span data-ttu-id="4f019-226">Esto es inocuo en la práctica, ya que los usuarios no podrán hacer nada inadecuado.</span><span class="sxs-lookup"><span data-stu-id="4f019-226">This is harmless in practice, as users will not be permitted to do anything inappropriate.</span></span> <span data-ttu-id="4f019-227">Sin embargo, puede resultar útil durante el desarrollo de proveedores para saber si el cliente se suplantó realmente o no.</span><span class="sxs-lookup"><span data-stu-id="4f019-227">However, it may be useful during provider development to know whether the client was truly impersonated or not.</span></span>

<span data-ttu-id="4f019-228">El código requiere las siguientes referencias y \# instrucciones include para compilar correctamente.</span><span class="sxs-lookup"><span data-stu-id="4f019-228">The code requires the following references and \#include statements to compile correctly.</span></span>


```C++
#define _WIN32_DCOM
#include <iostream>
using namespace std;
#include <wbemidl.h>
```



<span data-ttu-id="4f019-229">En el ejemplo de código siguiente se muestra cómo determinar si un proveedor ha suplantado correctamente una aplicación cliente.</span><span class="sxs-lookup"><span data-stu-id="4f019-229">The following code example shows how to determine whether a provider has successfully impersonated a client application.</span></span>


```C++
DWORD dwImp = 0;
HANDLE hThreadTok;
DWORD dwBytesReturned;
BOOL bRes;

// You must call this before trying to open a thread token!
CoImpersonateClient();

bRes = OpenThreadToken(
    GetCurrentThread(),
    TOKEN_QUERY,
    TRUE,
    &hThreadTok
);

if (bRes == FALSE)
{
    printf("Unable to read thread token (%d)\n", GetLastError());
    return 0;
}

bRes = GetTokenInformation(
    hThreadTok,
    TokenImpersonationLevel, 
    &dwImp,
    sizeof(DWORD),
    &dwBytesReturned
);

if (!bRes)
{
    printf("Unable to read impersonation level\n");
    CloseHandle(hThreadTok);
    return 0;
}

switch (dwImp)
{
case SecurityAnonymous:
    printf("SecurityAnonymous\n");
    break;

case SecurityIdentification:
    printf("SecurityIdentification\n");
    break;

case SecurityImpersonation:
    printf("SecurityImpersonation\n");
    break;

case SecurityDelegation:
    printf("SecurityDelegation\n");
    break;

default:
    printf("Error. Unable to determine impersonation level\n");
    break;
}

CloseHandle(hThreadTok);
```



## <a name="related-topics"></a><span data-ttu-id="4f019-230">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="4f019-230">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="4f019-231">Desarrollar un proveedor WMI</span><span class="sxs-lookup"><span data-stu-id="4f019-231">Developing a WMI Provider</span></span>](developing-a-wmi-provider.md)
</dt> <dt>

[<span data-ttu-id="4f019-232">Configuración de descriptores de seguridad de espacio</span><span class="sxs-lookup"><span data-stu-id="4f019-232">Setting Namepace Security Descriptors</span></span>](setting-namespace-security-descriptors.md)
</dt> <dt>

[<span data-ttu-id="4f019-233">Protección del proveedor</span><span class="sxs-lookup"><span data-stu-id="4f019-233">Securing Your Provider</span></span>](securing-your-provider.md)
</dt> </dl>

 

 
