---
title: Implementar y activar un controlador con datos adicionales proporcionados por el servidor
description: Implementar y activar un controlador con datos adicionales proporcionados por el servidor
ms.assetid: 5bbf81bd-430d-4008-b1cc-9ea91bb3b1e7
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: db78a3e39c85c37c52dfa3f09ef41f0a71b5f431
ms.sourcegitcommit: d39e82e232f6510f843fdb8d55d25b4e9e02e880
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 02/03/2021
ms.locfileid: "104361772"
---
# <a name="implementing-and-activating-a-handler-with-extra-data-supplied-by-server"></a><span data-ttu-id="8bfb0-103">Implementar y activar un controlador con datos adicionales proporcionados por el servidor</span><span class="sxs-lookup"><span data-stu-id="8bfb0-103">Implementing and Activating a Handler with Extra Data Supplied by Server</span></span>

<span data-ttu-id="8bfb0-104">Si el servidor desea incluir algunos datos adicionales en el paquete para que los use el controlador, el servidor debe implementar las interfaces [**IMarshal**](/windows/win32/api/objidlbase/nn-objidlbase-imarshal) y [**IStdMarshalInfo**](/windows/win32/api/objidlbase/nn-objidlbase-istdmarshalinfo) .</span><span class="sxs-lookup"><span data-stu-id="8bfb0-104">If the server wants to include some extra data in the packet for the handler to use, the server must implement both the [**IMarshal**](/windows/win32/api/objidlbase/nn-objidlbase-imarshal) and the [**IStdMarshalInfo**](/windows/win32/api/objidlbase/nn-objidlbase-istdmarshalinfo) interfaces.</span></span> <span data-ttu-id="8bfb0-105">El servidor debe agregar el serializador estándar y debe delegar la primera parte del cálculo de referencias en el contador de referencias estándar agregado, incluido [**IMarshal:: GetUnmarshalClass**](/windows/desktop/api/ObjIdl/nf-objidl-imarshal-getunmarshalclass), y debe agregar su propio tamaño de datos al tamaño devuelto por la propiedad [**IMarshal:: GetMarshalSizeMax**](/windows/desktop/api/ObjIdl/nf-objidl-imarshal-getmarshalsizemax)del contador de referencias estándar.</span><span class="sxs-lookup"><span data-stu-id="8bfb0-105">The server must aggregate the standard marshaler and must delegate the first part of the marshaling to the aggregated standard marshaler, including [**IMarshal::GetUnmarshalClass**](/windows/desktop/api/ObjIdl/nf-objidl-imarshal-getunmarshalclass), and must add its own data size to the size returned by the standard marshaler's [**IMarshal::GetMarshalSizeMax**](/windows/desktop/api/ObjIdl/nf-objidl-imarshal-getmarshalsizemax).</span></span> <span data-ttu-id="8bfb0-106">El serializador estándar llama a [**IStdMarshalInfo:: GetClassForHandler**](/windows/win32/api/objidlbase/nf-objidlbase-istdmarshalinfo-getclassforhandler) para obtener el CLSID del controlador que se va a crear.</span><span class="sxs-lookup"><span data-stu-id="8bfb0-106">The standard marshaler calls [**IStdMarshalInfo::GetClassForHandler**](/windows/win32/api/objidlbase/nf-objidlbase-istdmarshalinfo-getclassforhandler) to get the CLSID of the handler to be created.</span></span> <span data-ttu-id="8bfb0-107">Después de que el serializador estándar haya realizado su serialización, el servidor escribe sus propios datos adicionales en la secuencia.</span><span class="sxs-lookup"><span data-stu-id="8bfb0-107">After the standard marshaler has done its marshaling, the server then writes its own extra data into the stream.</span></span> <span data-ttu-id="8bfb0-108">Las estructuras resultantes, con datos adicionales en la secuencia, se muestran en la siguiente ilustración:</span><span class="sxs-lookup"><span data-stu-id="8bfb0-108">The resulting structures, with extra data in the stream, are shown in the following illustration:</span></span>

![Diagrama que muestra las estructuras con datos adicionales en la secuencia.](images/4cff306b-bb82-4c05-8e64-7ca73731f265.png)

## <a name="server-side-structures-with-extra-data-in-stream"></a><span data-ttu-id="8bfb0-110">Server-Side estructuras con datos adicionales en el flujo</span><span class="sxs-lookup"><span data-stu-id="8bfb0-110">Server-Side Structures with Extra Data in Stream</span></span>

<span data-ttu-id="8bfb0-111">Esto permite que la llamada desde COM a [**CoUnmarshalInterface**](/windows/desktop/api/combaseapi/nf-combaseapi-counmarshalinterface) en el cliente tenga la capacidad de omitir los datos no leídos y dejar la secuencia en la posición adecuada después de todos los datos de interfaz de cálculo de referencias si el controlador no se puede crear.</span><span class="sxs-lookup"><span data-stu-id="8bfb0-111">This allows the call from COM to [**CoUnmarshalInterface**](/windows/desktop/api/combaseapi/nf-combaseapi-counmarshalinterface) on the client side the ability to skip over any unread data and leave the stream in the appropriate position following all the marshaled interface data if the handler cannot be created.</span></span>

## <a name="client-side-structures-with-extra-data-in-stream"></a><span data-ttu-id="8bfb0-112">Client-Side estructuras con datos adicionales en el flujo</span><span class="sxs-lookup"><span data-stu-id="8bfb0-112">Client-Side Structures with Extra Data in Stream</span></span>

<span data-ttu-id="8bfb0-113">Como en el caso en el que no hay datos de servidor adicionales en la secuencia, la llamada COM del lado cliente a [**CoUnmarshalInterface**](/windows/desktop/api/combaseapi/nf-combaseapi-counmarshalinterface) creará la identidad y el controlador.</span><span class="sxs-lookup"><span data-stu-id="8bfb0-113">As in the case where there is no extra server data in the stream, the client-side COM call to [**CoUnmarshalInterface**](/windows/desktop/api/combaseapi/nf-combaseapi-counmarshalinterface) will create the identity and handler.</span></span> <span data-ttu-id="8bfb0-114">El controlador debe implementar [**IMarshal**](/windows/win32/api/objidlbase/nn-objidlbase-imarshal) y debe delegar primero las llamadas a **IMarshal** al serializador estándar agregado y, a continuación, calcular las referencias de los datos adicionales que el servidor proporcionó o anular su serialización.</span><span class="sxs-lookup"><span data-stu-id="8bfb0-114">The handler must implement [**IMarshal**](/windows/win32/api/objidlbase/nn-objidlbase-imarshal) and must delegate the **IMarshal** calls to the aggregated standard marshaler first and then marshal or unmarshal any extra data that the server provided.</span></span> <span data-ttu-id="8bfb0-115">Se llamará a [**unmarshalinterface (**](/windows/win32/api/objidlbase/nf-objidlbase-imarshal-unmarshalinterface) del controlador para cada no serialización, independientemente de si ha quitado las referencias de la interfaz antes o no.</span><span class="sxs-lookup"><span data-stu-id="8bfb0-115">The handler's [**UnmarshalInterface**](/windows/win32/api/objidlbase/nf-objidlbase-imarshal-unmarshalinterface) will be called for every unmarshal, regardless of whether it has unmarshaled the interface before or not.</span></span> <span data-ttu-id="8bfb0-116">En este caso, el servidor no llama a [**CoGetStdMarshalEx**](/windows/desktop/api/combaseapi/nf-combaseapi-cogetstdmarshalex) , pero el controlador debe.</span><span class="sxs-lookup"><span data-stu-id="8bfb0-116">In this case, the server does not call [**CoGetStdMarshalEx**](/windows/desktop/api/combaseapi/nf-combaseapi-cogetstdmarshalex) but the handler must.</span></span> <span data-ttu-id="8bfb0-117">La estructura del lado cliente resultante se muestra en la siguiente ilustración.</span><span class="sxs-lookup"><span data-stu-id="8bfb0-117">The resulting client-side structure is shown in the following illustration.</span></span>

![Diagrama que muestra la estructura del lado cliente.](images/053411c7-9d54-4ae5-bcb6-778454b1d86f.png)

## <a name="related-topics"></a><span data-ttu-id="8bfb0-119">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="8bfb0-119">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="8bfb0-120">Controlador de Client-Side ligero</span><span class="sxs-lookup"><span data-stu-id="8bfb0-120">The Lightweight Client-Side Handler</span></span>](the-lightweight-client-side-handler.md)
</dt> </dl>

 

 