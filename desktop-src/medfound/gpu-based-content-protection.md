---
description: Describe el contenido de vídeo&\# 8211; capacidades de protección que puede proporcionar un controlador de gráficos.
ms.assetid: FD0625BB-484A-43E6-8931-DB635D4F017F
title: GPU-Based Content Protection
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 6bbc1a0f88cae199b9aab38e5ec429ea5427f44b
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/07/2021
ms.locfileid: "104567208"
---
# <a name="gpu-based-content-protection"></a><span data-ttu-id="aa559-103">GPU-Based Content Protection</span><span class="sxs-lookup"><span data-stu-id="aa559-103">GPU-Based Content Protection</span></span>

<span data-ttu-id="aa559-104">En este tema se describe el contenido de vídeo: capacidades de protección que puede proporcionar un controlador de gráficos.</span><span class="sxs-lookup"><span data-stu-id="aa559-104">This topic describes video content–protection capabilities that a graphics driver can provide.</span></span>

-   [<span data-ttu-id="aa559-105">Introducción</span><span class="sxs-lookup"><span data-stu-id="aa559-105">Introduction</span></span>](#introduction)
-   [<span data-ttu-id="aa559-106">Información general sobre el proceso de descodificación</span><span class="sxs-lookup"><span data-stu-id="aa559-106">Overview of the Decoding Process</span></span>](#overview-of-the-decoding-process)
-   [<span data-ttu-id="aa559-107">Cifrado de búferes de vídeo comprimidos para el descodificador</span><span class="sxs-lookup"><span data-stu-id="aa559-107">Encrypting Compressed Video Buffers for the Decoder</span></span>](#encrypting-compressed-video-buffers-for-the-decoder)
    -   [<span data-ttu-id="aa559-108">1. consultar las capacidades Content Protection del controlador</span><span class="sxs-lookup"><span data-stu-id="aa559-108">1. Query the Content Protection Capabilities of the Driver</span></span>](#1-query-the-content-protection-capabilities-of-the-driver)
    -   [<span data-ttu-id="aa559-109">2. configurar el canal autenticado</span><span class="sxs-lookup"><span data-stu-id="aa559-109">2. Configure the Authenticated Channel</span></span>](#2-configure-the-authenticated-channel)
    -   [<span data-ttu-id="aa559-110">3. configurar la sesión criptográfica</span><span class="sxs-lookup"><span data-stu-id="aa559-110">3. Configure the Cryptographic Session</span></span>](#3-configure-the-cryptographic-session)
    -   [<span data-ttu-id="aa559-111">4. obtener un identificador para el dispositivo descodificador de DXVA</span><span class="sxs-lookup"><span data-stu-id="aa559-111">4. Get a Handle to the DXVA Decoder Device</span></span>](#4-get-a-handle-to-the-dxva-decoder-device)
    -   [<span data-ttu-id="aa559-112">5. asociar el descodificador de DXVA a la sesión criptográfica</span><span class="sxs-lookup"><span data-stu-id="aa559-112">5. Associate the DXVA Decoder with the Cryptographic Session</span></span>](#5-associate-the-dxva-decoder-with-the-cryptographic-session)
-   [<span data-ttu-id="aa559-113">Envío de comandos de canal autenticado</span><span class="sxs-lookup"><span data-stu-id="aa559-113">Sending Authenticated Channel Commands</span></span>](#sending-authenticated-channel-commands)
-   [<span data-ttu-id="aa559-114">Envío de consultas de canales autenticadas</span><span class="sxs-lookup"><span data-stu-id="aa559-114">Sending Authenticated Channel Queries</span></span>](#sending-authenticated-channel-queries)
-   [<span data-ttu-id="aa559-115">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="aa559-115">Related topics</span></span>](#related-topics)

## <a name="introduction"></a><span data-ttu-id="aa559-116">Introducción</span><span class="sxs-lookup"><span data-stu-id="aa559-116">Introduction</span></span>

<span data-ttu-id="aa559-117">En el diagrama siguiente se muestra una vista simplificada de cómo se recorre el contenido de vídeo protegido a través de la canalización.</span><span class="sxs-lookup"><span data-stu-id="aa559-117">The following diagram shows a simplified view of how protected video content travels through the pipeline to be rendered.</span></span>

![diagrama que muestra el contenido de vídeo protegido.](images/d3d9video01.png)

> [!Note]  
> <span data-ttu-id="aa559-119">La [ruta de acceso a los medios protegidos](protected-media-path.md) (PMP) no se muestra en este diagrama.</span><span class="sxs-lookup"><span data-stu-id="aa559-119">The [Protected Media Path](protected-media-path.md) (PMP) is not depicted in this diagram.</span></span> <span data-ttu-id="aa559-120">El flujo de datos que se muestra aquí puede aparecer dentro de un proceso de PMP o dentro de un proceso de aplicación.</span><span class="sxs-lookup"><span data-stu-id="aa559-120">The data flow that is shown here might occur within a PMP process, or within an application process.</span></span>

 

<span data-ttu-id="aa559-121">El descodificador recibe datos de vídeo cifrados y comprimidos de un origen externo.</span><span class="sxs-lookup"><span data-stu-id="aa559-121">The decoder receives encrypted, compressed video data from an external source.</span></span> <span data-ttu-id="aa559-122">También se supone que el descodificador recibe también una clave criptográfica para descifrar estos datos.</span><span class="sxs-lookup"><span data-stu-id="aa559-122">It is assumed also the decoder also receives a cryptographic key to decrypt this data.</span></span> <span data-ttu-id="aa559-123">En este tema no se describe el intercambio de claves entre el origen y el descodificador de vídeo, pero el PMP define un posible mecanismo.</span><span class="sxs-lookup"><span data-stu-id="aa559-123">This topic does not describe the key exchange between the video source and decoder, but the PMP defines one possible mechanism.</span></span> <span data-ttu-id="aa559-124">La GPU no está implicada en esta fase.</span><span class="sxs-lookup"><span data-stu-id="aa559-124">The GPU is not involved at this stage.</span></span>

<span data-ttu-id="aa559-125">Para la descodificación acelerada por hardware, el descodificador de software pasa el contenido de vídeo comprimido a la GPU.</span><span class="sxs-lookup"><span data-stu-id="aa559-125">For hardware-accelerated decoding, the software decoder passes compressed video content to the GPU.</span></span> <span data-ttu-id="aa559-126">Para proteger este contenido, el descodificador vuelve a cifrar los datos, normalmente mediante AES-CTR, antes de pasarlos al Acelerador de hardware.</span><span class="sxs-lookup"><span data-stu-id="aa559-126">To protect this content, the decoder re-encrypts the data, typically using AES-CTR, before passing it to the hardware accelerator.</span></span> <span data-ttu-id="aa559-127">Se define un mecanismo de intercambio de claves entre el descodificador y el controlador de gráficos.</span><span class="sxs-lookup"><span data-stu-id="aa559-127">A key-exchange mechanism is defined between the decoder and the graphics driver.</span></span>

<span data-ttu-id="aa559-128">Los fotogramas de vídeo descodificados se almacenan en la memoria de vídeo, por lo general, sin cifrar.</span><span class="sxs-lookup"><span data-stu-id="aa559-128">Decoded video frames are stored in video memory, generally in the clear.</span></span> <span data-ttu-id="aa559-129">En este momento, los fotogramas se procesan y se presentan.</span><span class="sxs-lookup"><span data-stu-id="aa559-129">At this point, the frames are processed and then presented.</span></span> <span data-ttu-id="aa559-130">Hay dos opciones principales para la presentación.</span><span class="sxs-lookup"><span data-stu-id="aa559-130">There are two main options for presentation.</span></span>

-   <span data-ttu-id="aa559-131">Los fotogramas se pueden presentar mediante una superposición de hardware.</span><span class="sxs-lookup"><span data-stu-id="aa559-131">Frames can be presented using a hardware overlay.</span></span> <span data-ttu-id="aa559-132">Para obtener más información, consulte [compatibilidad con la superposición de hardware](hardware-overlay-support.md).</span><span class="sxs-lookup"><span data-stu-id="aa559-132">For more information, see [Hardware Overlay Support](hardware-overlay-support.md).</span></span>
-   <span data-ttu-id="aa559-133">Los fotogramas se pueden presentar mediante la ventana de escritorio administrar (DWM) mediante una superficie compartida.</span><span class="sxs-lookup"><span data-stu-id="aa559-133">Frames can be presented by the Desktop Window Manage (DWM) using a shared surface.</span></span>

<span data-ttu-id="aa559-134">El último paso es mostrar el fotograma en el monitor, que puede requerir protección de vínculos entre la tarjeta gráfica y el dispositivo de pantalla.</span><span class="sxs-lookup"><span data-stu-id="aa559-134">The last step is to display the frame on the monitor, which may require link protection between the graphics card and the display device.</span></span> <span data-ttu-id="aa559-135">Un ejemplo de protección de vínculos es High-Bandwidth Content Protection digital (HDCP).</span><span class="sxs-lookup"><span data-stu-id="aa559-135">An example of link protection is High-Bandwidth Digital Content Protection (HDCP).</span></span> <span data-ttu-id="aa559-136">La protección de vínculos se configura mediante el [Administrador de protección de salida](output-protection-manager.md) (OPM).</span><span class="sxs-lookup"><span data-stu-id="aa559-136">Link protection is configured using [Output Protection Manager](output-protection-manager.md) (OPM).</span></span> <span data-ttu-id="aa559-137">En este tema no se describe OPM; para obtener más información, consulte [uso del administrador de protección de salida](using-output-protection-manager.md).</span><span class="sxs-lookup"><span data-stu-id="aa559-137">This topic does not describe OPM; for more information, see [Using Output Protection Manager](using-output-protection-manager.md).</span></span>

## <a name="overview-of-the-decoding-process"></a><span data-ttu-id="aa559-138">Información general sobre el proceso de descodificación</span><span class="sxs-lookup"><span data-stu-id="aa559-138">Overview of the Decoding Process</span></span>

<span data-ttu-id="aa559-139">Durante la descodificación acelerada por hardware, el descodificador de software debe pasar datos de vídeo comprimidos a la tarjeta gráfica.</span><span class="sxs-lookup"><span data-stu-id="aa559-139">During hardware-accelerated decoding, the software decoder must pass compressed video data to the graphics card.</span></span> <span data-ttu-id="aa559-140">En el caso de contenido premium, estos datos normalmente se deben cifrar mediante el cifrado de clave simétrica antes de enviarlos a la GPU.</span><span class="sxs-lookup"><span data-stu-id="aa559-140">For premium content, this data typically must be encrypted, using symmetric-key encryption, before it is sent to the GPU.</span></span>

<span data-ttu-id="aa559-141">Para cifrar el vídeo para la descodificación, el descodificador de software utiliza las siguientes interfaces:</span><span class="sxs-lookup"><span data-stu-id="aa559-141">To encrypt the video for decoding, the software decoder uses the following interfaces:</span></span>

-   <span data-ttu-id="aa559-142">[**IDirectXVideoDecoder**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder).</span><span class="sxs-lookup"><span data-stu-id="aa559-142">[**IDirectXVideoDecoder**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder).</span></span> <span data-ttu-id="aa559-143">Representa el dispositivo descodificador de DXVA, también denominado Acelerador.</span><span class="sxs-lookup"><span data-stu-id="aa559-143">Represents the DXVA decoder device, also called the accelerator.</span></span>
-   <span data-ttu-id="aa559-144">[**IDirect3DCryptoSession9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dcryptosession9).</span><span class="sxs-lookup"><span data-stu-id="aa559-144">[**IDirect3DCryptoSession9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dcryptosession9).</span></span> <span data-ttu-id="aa559-145">Representa una sesión de cifrado, que proporciona la clave de cifrado.</span><span class="sxs-lookup"><span data-stu-id="aa559-145">Represents a cryptographic session, which provides the encryption key.</span></span>
-   <span data-ttu-id="aa559-146">[**IDirect3DAuthenticatedChannel9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dauthenticatedchannel9).</span><span class="sxs-lookup"><span data-stu-id="aa559-146">[**IDirect3DAuthenticatedChannel9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dauthenticatedchannel9).</span></span> <span data-ttu-id="aa559-147">Representa un canal autenticado, que permite al descodificador de software asociar la sesión de cifrado con el descodificador de DXVA.</span><span class="sxs-lookup"><span data-stu-id="aa559-147">Represents an authenticated channel, which enables the software decoder to associate the cryptographic session with the DXVA decoder.</span></span>

![diagrama que muestra las interfaces de descodificación de Direct3D9.](images/d3d9video02.png)

<span data-ttu-id="aa559-149">Todas estas interfaces se obtienen del dispositivo Direct3D, como se indica a continuación:</span><span class="sxs-lookup"><span data-stu-id="aa559-149">All of these interfaces are obtained from the Direct3D device, as follows:</span></span>



| <span data-ttu-id="aa559-150">Interfaz</span><span class="sxs-lookup"><span data-stu-id="aa559-150">Interface</span></span>                                                                | <span data-ttu-id="aa559-151">Creación</span><span class="sxs-lookup"><span data-stu-id="aa559-151">Creation</span></span>                                                                                                                                                                      |
|--------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [<span data-ttu-id="aa559-152">**IDirectXVideoDecoder**</span><span class="sxs-lookup"><span data-stu-id="aa559-152">**IDirectXVideoDecoder**</span></span>](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder)                     | <span data-ttu-id="aa559-153">Llame a [**IDirectXVideoDecoderService:: CreateVideoDecoder**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-createvideodecoder).</span><span class="sxs-lookup"><span data-stu-id="aa559-153">Call [**IDirectXVideoDecoderService::CreateVideoDecoder**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-createvideodecoder).</span></span> <span data-ttu-id="aa559-154">El dispositivo descodificador de DXVA se identifica mediante un GUID de Perfil de DXVA.</span><span class="sxs-lookup"><span data-stu-id="aa559-154">The DXVA decoder device is identified by a DXVA profile GUID.</span></span> |
| [<span data-ttu-id="aa559-155">**IDirect3DCryptoSession9**</span><span class="sxs-lookup"><span data-stu-id="aa559-155">**IDirect3DCryptoSession9**</span></span>](/windows/desktop/api/d3d9/nn-d3d9-idirect3dcryptosession9)               | <span data-ttu-id="aa559-156">Llame a [**IDirect3DDevice9Video:: CreateCryptoSession**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession).</span><span class="sxs-lookup"><span data-stu-id="aa559-156">Call [**IDirect3DDevice9Video::CreateCryptoSession**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession).</span></span>                                                                         |
| [<span data-ttu-id="aa559-157">**IDirect3DAuthenticatedChannel9**</span><span class="sxs-lookup"><span data-stu-id="aa559-157">**IDirect3DAuthenticatedChannel9**</span></span>](/windows/desktop/api/d3d9/nn-d3d9-idirect3dauthenticatedchannel9) | <span data-ttu-id="aa559-158">Llame a [**IDirect3DDevice9Video:: CreateAuthenticatedChannel**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel).</span><span class="sxs-lookup"><span data-stu-id="aa559-158">Call [**IDirect3DDevice9Video::CreateAuthenticatedChannel**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel).</span></span>                                                           |



 

> [!Note]  
> <span data-ttu-id="aa559-159">Para obtener un puntero a la interfaz [**IDirect3DDevice9Video**](/windows/desktop/api/d3d9/nn-d3d9-idirect3ddevice9video) , llame a [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) en un dispositivo D3D9Ex.</span><span class="sxs-lookup"><span data-stu-id="aa559-159">To get a pointer to the [**IDirect3DDevice9Video**](/windows/desktop/api/d3d9/nn-d3d9-idirect3ddevice9video) interface, call [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) on a D3D9Ex device.</span></span>

 

<span data-ttu-id="aa559-160">El canal autenticado proporciona un canal de comunicación de confianza entre el descodificador de software y el controlador.</span><span class="sxs-lookup"><span data-stu-id="aa559-160">The authenticated channel provides a trusted communication channel between the software decoder and the driver.</span></span> <span data-ttu-id="aa559-161">El canal de comunicación funciona de la siguiente manera:</span><span class="sxs-lookup"><span data-stu-id="aa559-161">The communication channel works as follows:</span></span>

-   <span data-ttu-id="aa559-162">El controlador proporciona una cadena de certificados X. 509 cuyo certificado raíz está firmado por Microsoft.</span><span class="sxs-lookup"><span data-stu-id="aa559-162">The driver provides an X.509 certificate chain whose root certificate is signed by Microsoft.</span></span>
-   <span data-ttu-id="aa559-163">El certificado contiene una clave pública RSA para el controlador.</span><span class="sxs-lookup"><span data-stu-id="aa559-163">The certificate contains an RSA public key for the driver.</span></span>
-   <span data-ttu-id="aa559-164">El descodificador de software usa la clave pública para enviar al controlador una clave de sesión AES de 128 bits.</span><span class="sxs-lookup"><span data-stu-id="aa559-164">The software decoder uses the public key to send the driver a 128-bit AES session key.</span></span>
-   <span data-ttu-id="aa559-165">El descodificador de software envía consultas y comandos al canal autenticado.</span><span class="sxs-lookup"><span data-stu-id="aa559-165">The software decoder sends queries and commands to the authenticated channel.</span></span>
-   <span data-ttu-id="aa559-166">La clave de sesión se usa para calcular códigos de autenticación de mensajes (Mac) para las consultas y los comandos.</span><span class="sxs-lookup"><span data-stu-id="aa559-166">The session key is used to compute message authentication codes (MACs) for the queries and commands.</span></span> <span data-ttu-id="aa559-167">El controlador utiliza los equipos Mac para comprobar la integridad de los datos de consulta y comando, y el descodificador de software los usa para comprobar la integridad de los datos de respuesta del controlador.</span><span class="sxs-lookup"><span data-stu-id="aa559-167">The driver uses the MACs to verify the integrity of the query/command data, and the software decoder uses them to verify the integrity of the response data from the driver.</span></span>

## <a name="encrypting-compressed-video-buffers-for-the-decoder"></a><span data-ttu-id="aa559-168">Cifrado de búferes de vídeo comprimidos para el descodificador</span><span class="sxs-lookup"><span data-stu-id="aa559-168">Encrypting Compressed Video Buffers for the Decoder</span></span>

<span data-ttu-id="aa559-169">A continuación se muestra una introducción de alto nivel del proceso de cifrado y descodificación:</span><span class="sxs-lookup"><span data-stu-id="aa559-169">Here is a high-level overview of the encryption and decoding process:</span></span>

1.  <span data-ttu-id="aa559-170">El descodificador de software recibe un flujo de datos cifrados del origen de vídeo.</span><span class="sxs-lookup"><span data-stu-id="aa559-170">The software decoder receives a stream of encrypted data from the video source.</span></span> <span data-ttu-id="aa559-171">El descodificador descifra esta secuencia.</span><span class="sxs-lookup"><span data-stu-id="aa559-171">The decoder decrypts this stream.</span></span>
2.  <span data-ttu-id="aa559-172">El descodificador de software negocia una clave de sesión con la sesión criptográfica.</span><span class="sxs-lookup"><span data-stu-id="aa559-172">The software decoder negotiates a session key with the cryptographic session.</span></span>
3.  <span data-ttu-id="aa559-173">El descodificador de software usa el canal autenticado para asociar la sesión criptográfica con el dispositivo descodificador de DXVA.</span><span class="sxs-lookup"><span data-stu-id="aa559-173">The software decoder uses the authenticated channel to associate the cryptographic session with the DXVA decoder device.</span></span>
4.  <span data-ttu-id="aa559-174">El descodificador de software coloca los datos comprimidos en los búferes de DXVA que obtiene del dispositivo de descodificador de DXVA (acelerador).</span><span class="sxs-lookup"><span data-stu-id="aa559-174">The software decoder puts compressed data in DXVA buffers that it gets from the DXVA decoder device (accelerator).</span></span> <span data-ttu-id="aa559-175">Para el contenido protegido, el codificador de software cifra los datos que se colocan en los búferes de DXVA, utilizando la clave de sesión para el cifrado.</span><span class="sxs-lookup"><span data-stu-id="aa559-175">For protected content, the software encoder encrypts the data that is puts into the DXVA buffers, using the session key for the encryption.</span></span>
    > [!Note]  
    > <span data-ttu-id="aa559-176">Algunos controladores usan una clave de contenido, en lugar de la clave de sesión, para el cifrado.</span><span class="sxs-lookup"><span data-stu-id="aa559-176">Some drivers use a content key, instead of the session key, for encryption.</span></span> <span data-ttu-id="aa559-177">La clave de contenido podría cambiar de un marco a otro.</span><span class="sxs-lookup"><span data-stu-id="aa559-177">The content key could change from one frame to the next.</span></span>

     

5.  <span data-ttu-id="aa559-178">El descodificador envía los búferes comprimidos cifrados al acelerador.</span><span class="sxs-lookup"><span data-stu-id="aa559-178">The decoder submits the encrypted compressed buffers to the accelerator.</span></span> <span data-ttu-id="aa559-179">En el caso de AES-CTR, el descodificador también pasa el vector de inicialización.</span><span class="sxs-lookup"><span data-stu-id="aa559-179">For AES-CTR, the decoder also passes the initialization vector.</span></span> <span data-ttu-id="aa559-180">Si se usa una clave de contenido, el descodificador pasa la clave de contenido, cifrada mediante la clave de sesión.</span><span class="sxs-lookup"><span data-stu-id="aa559-180">If a content key is used, the decoder passes content key, encrypted using the session key.</span></span>

<span data-ttu-id="aa559-181">Direct3D tiene compatibilidad estándar con AES-CTR de 128 bits, pero está diseñado para extenderse a tipos de cifrado adicionales.</span><span class="sxs-lookup"><span data-stu-id="aa559-181">Direct3D has standard support for 128-bit AES-CTR, but is designed to extend to additional encryption types.</span></span>

<span data-ttu-id="aa559-182">Las cinco secciones siguientes proporcionan pasos más detallados.</span><span class="sxs-lookup"><span data-stu-id="aa559-182">The next five sections give more detailed steps.</span></span>

-   [<span data-ttu-id="aa559-183">1. consultar las capacidades Content Protection del controlador</span><span class="sxs-lookup"><span data-stu-id="aa559-183">1. Query the Content Protection Capabilities of the Driver</span></span>](#1-query-the-content-protection-capabilities-of-the-driver)
-   [<span data-ttu-id="aa559-184">2. configurar el canal autenticado</span><span class="sxs-lookup"><span data-stu-id="aa559-184">2. Configure the Authenticated Channel</span></span>](#2-configure-the-authenticated-channel)
-   [<span data-ttu-id="aa559-185">3. configurar la sesión criptográfica</span><span class="sxs-lookup"><span data-stu-id="aa559-185">3. Configure the Cryptographic Session</span></span>](#3-configure-the-cryptographic-session)
-   [<span data-ttu-id="aa559-186">4. obtener un identificador para el dispositivo descodificador de DXVA</span><span class="sxs-lookup"><span data-stu-id="aa559-186">4. Get a Handle to the DXVA Decoder Device</span></span>](#4-get-a-handle-to-the-dxva-decoder-device)
-   [<span data-ttu-id="aa559-187">5. asociar el descodificador de DXVA a la sesión criptográfica</span><span class="sxs-lookup"><span data-stu-id="aa559-187">5. Associate the DXVA Decoder with the Cryptographic Session</span></span>](#5-associate-the-dxva-decoder-with-the-cryptographic-session)

### <a name="1-query-the-content-protection-capabilities-of-the-driver"></a><span data-ttu-id="aa559-188">1. consultar las capacidades Content Protection del controlador</span><span class="sxs-lookup"><span data-stu-id="aa559-188">1. Query the Content Protection Capabilities of the Driver</span></span>

<span data-ttu-id="aa559-189">Antes de intentar aplicar el cifrado, obtenga las capacidades de protección de contenido del controlador.</span><span class="sxs-lookup"><span data-stu-id="aa559-189">Before attempting to apply encryption, get the content protection capabilities of the driver.</span></span>

1.  <span data-ttu-id="aa559-190">Obtiene un puntero al dispositivo de Direct3D 9.</span><span class="sxs-lookup"><span data-stu-id="aa559-190">Get a pointer to the Direct3D 9 device.</span></span>
2.  <span data-ttu-id="aa559-191">Llame a [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) para la interfaz [**IDirect3DDevice9Video**](/windows/desktop/api/d3d9/nn-d3d9-idirect3ddevice9video) .</span><span class="sxs-lookup"><span data-stu-id="aa559-191">Call [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) for the [**IDirect3DDevice9Video**](/windows/desktop/api/d3d9/nn-d3d9-idirect3ddevice9video) interface.</span></span>
3.  <span data-ttu-id="aa559-192">Llame a [**IDirect3DDevice9Video:: GetContentProtectionCaps**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-getcontentprotectioncaps).</span><span class="sxs-lookup"><span data-stu-id="aa559-192">Call [**IDirect3DDevice9Video::GetContentProtectionCaps**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-getcontentprotectioncaps).</span></span> <span data-ttu-id="aa559-193">Este método rellena una estructura [**D3DCONTENTPROTECTIONCAPS**](/windows/desktop/api/d3d9caps/ns-d3d9caps-d3dcontentprotectioncaps) con las funcionalidades de protección de contenido del controlador.</span><span class="sxs-lookup"><span data-stu-id="aa559-193">This method fills in a [**D3DCONTENTPROTECTIONCAPS**](/windows/desktop/api/d3d9caps/ns-d3d9caps-d3dcontentprotectioncaps) structure with the driver’s content protection capabilities.</span></span>

<span data-ttu-id="aa559-194">En concreto, busque las siguientes funcionalidades:</span><span class="sxs-lookup"><span data-stu-id="aa559-194">In particular, look for the following capabilities:</span></span>

-   <span data-ttu-id="aa559-195">Si el miembro **caps** contiene la marca **D3DCPCAPS_SOFTWARE** o **D3DCPCAPS_HARDWARE** , el controlador puede realizar el cifrado.</span><span class="sxs-lookup"><span data-stu-id="aa559-195">If the **Caps** member contains the **D3DCPCAPS_SOFTWARE** or **D3DCPCAPS_HARDWARE** flag, the driver can perform encryption.</span></span>
-   <span data-ttu-id="aa559-196">El miembro **KeyExchangeType** especifica cómo realizar el intercambio de claves para la clave de sesión.</span><span class="sxs-lookup"><span data-stu-id="aa559-196">The **KeyExchangeType** member specifies how to perform key exchange for the session key.</span></span>
-   <span data-ttu-id="aa559-197">Si el miembro **caps** contiene la marca **D3DCPCAPS_CONTENTKEY** , el controlador utiliza una clave de contenido independiente para el cifrado.</span><span class="sxs-lookup"><span data-stu-id="aa559-197">If the **Caps** member contains the **D3DCPCAPS_CONTENTKEY** flag, the driver uses a separate content key for encryption.</span></span> <span data-ttu-id="aa559-198">Esto es importante cuando se genera la clave de sesión.</span><span class="sxs-lookup"><span data-stu-id="aa559-198">This is important when you generate the session key.</span></span>

<span data-ttu-id="aa559-199">Las funcionalidades adicionales se indican en el miembro **Cap** .</span><span class="sxs-lookup"><span data-stu-id="aa559-199">Additional capabilities are indicated in the **Caps** member.</span></span>

### <a name="2-configure-the-authenticated-channel"></a><span data-ttu-id="aa559-200">2. configurar el canal autenticado</span><span class="sxs-lookup"><span data-stu-id="aa559-200">2. Configure the Authenticated Channel</span></span>

<span data-ttu-id="aa559-201">El siguiente paso consiste en configurar el canal autenticado.</span><span class="sxs-lookup"><span data-stu-id="aa559-201">The next step is to configure the authenticated channel.</span></span>

1.  <span data-ttu-id="aa559-202">Llame a [**IDirect3DDevice9Video:: CreateAuthenticatedChannel**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel) para crear el canal autenticado.</span><span class="sxs-lookup"><span data-stu-id="aa559-202">Call [**IDirect3DDevice9Video::CreateAuthenticatedChannel**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel) to create the authenticated channel.</span></span> <span data-ttu-id="aa559-203">Para el parámetro *ChannelType* , especifique un tipo de canal que coincida con las capacidades del controlador.</span><span class="sxs-lookup"><span data-stu-id="aa559-203">For the *ChannelType* parameter, specify a channel type that matches the capabilities of the driver.</span></span>
    -   <span data-ttu-id="aa559-204">El tipo de canal **D3DAUTHENTICATEDCHANNEL_DRIVER_SOFTWARE** corresponde a **D3DCPCAPS_SOFTWARE**.</span><span class="sxs-lookup"><span data-stu-id="aa559-204">The **D3DAUTHENTICATEDCHANNEL_DRIVER_SOFTWARE** channel type corresponds to **D3DCPCAPS_SOFTWARE**.</span></span>
    -   <span data-ttu-id="aa559-205">El tipo de canal **D3DAUTHENTICATEDCHANNEL_DRIVER_HARDWARE** corresponde a **D3DCPCAPS_HARDWARE**.</span><span class="sxs-lookup"><span data-stu-id="aa559-205">The **D3DAUTHENTICATEDCHANNEL_DRIVER_HARDWARE** channel type corresponds to **D3DCPCAPS_HARDWARE**.</span></span>

    <span data-ttu-id="aa559-206">El método **CreateAuthenticatedChannel** devuelve un puntero a la interfaz [**IDirect3DAuthenticatedChannel9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dauthenticatedchannel9) junto con un identificador para el canal.</span><span class="sxs-lookup"><span data-stu-id="aa559-206">The **CreateAuthenticatedChannel** method returns a pointer to the [**IDirect3DAuthenticatedChannel9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dauthenticatedchannel9) interface along with a handle to the channel.</span></span> <span data-ttu-id="aa559-207">El identificador se usa más adelante para asociar la sesión de cifrado con el canal autenticado.</span><span class="sxs-lookup"><span data-stu-id="aa559-207">The handle is used later to associate the cryptographic session with the authenticated channel.</span></span>
2.  <span data-ttu-id="aa559-208">Llame a [**IDirect3DAuthenticatedChannel9:: GetCertificateSize**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-getcertificatesize) para obtener el tamaño del certificado X. 509 del controlador.</span><span class="sxs-lookup"><span data-stu-id="aa559-208">Call [**IDirect3DAuthenticatedChannel9::GetCertificateSize**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-getcertificatesize) to get the size of the driver's X.509 certificate.</span></span> <span data-ttu-id="aa559-209">Asigne un búfer del tamaño requerido.</span><span class="sxs-lookup"><span data-stu-id="aa559-209">Allocate a buffer of the required size.</span></span>
3.  <span data-ttu-id="aa559-210">Llame a [**IDirect3DAuthenticatedChannel9:: GetCertificate**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-getcertificate) para obtener el certificado.</span><span class="sxs-lookup"><span data-stu-id="aa559-210">Call [**IDirect3DAuthenticatedChannel9::GetCertificate**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-getcertificate) to get the certificate.</span></span> <span data-ttu-id="aa559-211">El método copia el certificado en el búfer que se asignó en el paso anterior.</span><span class="sxs-lookup"><span data-stu-id="aa559-211">The method copies the certificate into the buffer that was allocated in the previous step.</span></span>
4.  <span data-ttu-id="aa559-212">Compruebe que el certificado del controlador está firmado por Microsoft y que no se ha revocado.</span><span class="sxs-lookup"><span data-stu-id="aa559-212">Verify that the driver’s certificate was signed by Microsoft and has not been revoked.</span></span>
5.  <span data-ttu-id="aa559-213">Obtiene la clave pública del certificado.</span><span class="sxs-lookup"><span data-stu-id="aa559-213">Get the public key from the certificate.</span></span>
6.  <span data-ttu-id="aa559-214">Generar una clave de sesión RSA aleatoria.</span><span class="sxs-lookup"><span data-stu-id="aa559-214">Generate a random RSA session key.</span></span> <span data-ttu-id="aa559-215">Esta clave de sesión se usa para firmar los datos que se envían al canal autenticado.</span><span class="sxs-lookup"><span data-stu-id="aa559-215">This session key is used to sign data that is sent to the authenticated channel.</span></span> <span data-ttu-id="aa559-216">Cifre la clave de sesión mediante la clave pública del controlador.</span><span class="sxs-lookup"><span data-stu-id="aa559-216">Encrypt the session key using the driver's public key.</span></span>
7.  <span data-ttu-id="aa559-217">Llame a [**IDirect3DAuthenticatedChannel9:: NegotiateKeyExchange**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-negotiatekeyexchange) para enviar la clave de sesión cifrada al controlador.</span><span class="sxs-lookup"><span data-stu-id="aa559-217">Call [**IDirect3DAuthenticatedChannel9::NegotiateKeyExchange**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-negotiatekeyexchange) to send the encrypted session key to the driver.</span></span>
8.  <span data-ttu-id="aa559-218">Inicialice el canal seguro como se indica a continuación:</span><span class="sxs-lookup"><span data-stu-id="aa559-218">Initialize the secure channel as follows:</span></span>
    1.  <span data-ttu-id="aa559-219">Rellene una estructura de [**D3DAUTHENTICATEDCHANNEL_CONFIGUREINITIALIZE**](d3dauthenticatedchannel-configureinitialize.md) como se describe en la documentación de.</span><span class="sxs-lookup"><span data-stu-id="aa559-219">Fill in a [**D3DAUTHENTICATEDCHANNEL_CONFIGUREINITIALIZE**](d3dauthenticatedchannel-configureinitialize.md) structure as described in the documentation.</span></span>
    2.  <span data-ttu-id="aa559-220">Envíe el comando [**D3DAUTHENTICATEDCONFIGURE_INITIALIZE**](d3dauthenticatedconfigure-initialize.md) llamando a [**IDirect3DAuthenticatedChannel9:: configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure) como se describe en la sección [envío de comandos de canal autenticado](#sending-authenticated-channel-commands).</span><span class="sxs-lookup"><span data-stu-id="aa559-220">Send the [**D3DAUTHENTICATEDCONFIGURE_INITIALIZE**](d3dauthenticatedconfigure-initialize.md) command by calling [**IDirect3DAuthenticatedChannel9::Configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure) as described in the section [Sending Authenticated Channel Commands](#sending-authenticated-channel-commands).</span></span> <span data-ttu-id="aa559-221">Este comando contiene los números de secuencia inicial para los comandos y las consultas que se envían al canal autenticado.</span><span class="sxs-lookup"><span data-stu-id="aa559-221">This command contains the starting sequence numbers for the commands and queries that are sent to the authenticated channel.</span></span>
9.  <span data-ttu-id="aa559-222">Compruebe el tipo de canal mediante el envío de una [**D3DAUTHENTICATEDQUERY_CHANNELTYPE**](d3dauthenticatedquery-channeltype.md) consulta al canal autenticado, como se describe en la sección [envío de consultas de canal autenticado](#sending-authenticated-channel-queries).</span><span class="sxs-lookup"><span data-stu-id="aa559-222">Verify the channel type by sending a [**D3DAUTHENTICATEDQUERY_CHANNELTYPE**](d3dauthenticatedquery-channeltype.md) query to the authenticated channel, as described in the section [Sending Authenticated Channel Queries](#sending-authenticated-channel-queries).</span></span> <span data-ttu-id="aa559-223">Compruebe que el tipo de canal coincide con lo que especificó en el método [**CreateAuthenticatedChannel**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel) .</span><span class="sxs-lookup"><span data-stu-id="aa559-223">Check that the channel type matches what you specified in the [**CreateAuthenticatedChannel**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel) method.</span></span>

### <a name="3-configure-the-cryptographic-session"></a><span data-ttu-id="aa559-224">3. configurar la sesión criptográfica</span><span class="sxs-lookup"><span data-stu-id="aa559-224">3. Configure the Cryptographic Session</span></span>

<span data-ttu-id="aa559-225">A continuación, configure la sesión criptográfica y establezca la clave de sesión.</span><span class="sxs-lookup"><span data-stu-id="aa559-225">Next, configure the cryptographic session and establish the session key.</span></span>

1.  <span data-ttu-id="aa559-226">Llame a [**IDirect3DDevice9Video:: CreateCryptoSession**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession) para crear la sesión criptográfica.</span><span class="sxs-lookup"><span data-stu-id="aa559-226">Call [**IDirect3DDevice9Video::CreateCryptoSession**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession) to create the cryptographic session.</span></span> <span data-ttu-id="aa559-227">Este método devuelve un puntero a la interfaz [**IDirect3DCryptoSession9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dcryptosession9) y junto con un identificador a la sesión criptográfica.</span><span class="sxs-lookup"><span data-stu-id="aa559-227">This method returns a pointer to the [**IDirect3DCryptoSession9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dcryptosession9) interface and along with a handle to the cryptographic session.</span></span>
2.  <span data-ttu-id="aa559-228">Llame a [**IDirect3DCryptoSession9:: GetCertificateSize**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dcryptosession9-getcertificatesize) para obtener el tamaño del certificado X. 509 del controlador.</span><span class="sxs-lookup"><span data-stu-id="aa559-228">Call [**IDirect3DCryptoSession9::GetCertificateSize**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dcryptosession9-getcertificatesize) to get the size of the driver's X.509 certificate.</span></span> <span data-ttu-id="aa559-229">Asigne un búfer del tamaño requerido.</span><span class="sxs-lookup"><span data-stu-id="aa559-229">Allocate a buffer of the required size.</span></span>
3.  <span data-ttu-id="aa559-230">Llame a [**IDirect3DCryptoSession9:: GetCertificate**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dcryptosession9-getcertificate) para obtener el certificado.</span><span class="sxs-lookup"><span data-stu-id="aa559-230">Call [**IDirect3DCryptoSession9::GetCertificate**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dcryptosession9-getcertificate) to get the certificate.</span></span> <span data-ttu-id="aa559-231">El método copia el certificado en el búfer que se asignó en el paso anterior.</span><span class="sxs-lookup"><span data-stu-id="aa559-231">The method copies the certificate into the buffer that was allocated in the previous step.</span></span>
4.  <span data-ttu-id="aa559-232">Compruebe que el certificado del controlador está firmado por Microsoft y que no se ha revocado.</span><span class="sxs-lookup"><span data-stu-id="aa559-232">Verify that the driver’s certificate was signed by Microsoft and has not been revoked.</span></span>
5.  <span data-ttu-id="aa559-233">Obtiene la clave pública del certificado.</span><span class="sxs-lookup"><span data-stu-id="aa559-233">Get the public key from the certificate.</span></span>
6.  <span data-ttu-id="aa559-234">Generar una clave de sesión RSA aleatoria.</span><span class="sxs-lookup"><span data-stu-id="aa559-234">Generate a random RSA session key.</span></span> <span data-ttu-id="aa559-235">Se trata de una clave de sesión independiente de la clave de sesión del canal autenticado.</span><span class="sxs-lookup"><span data-stu-id="aa559-235">This is a separate session key from the authenticated channel session key.</span></span> <span data-ttu-id="aa559-236">Cifre la clave de sesión mediante la clave pública del controlador.</span><span class="sxs-lookup"><span data-stu-id="aa559-236">Encrypt the session key using the driver's public key.</span></span>
7.  <span data-ttu-id="aa559-237">Llame a [**IDirect3DCryptoSession9:: NegotiateKeyExchange**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-negotiatekeyexchange) para enviar la clave de sesión cifrada al controlador.</span><span class="sxs-lookup"><span data-stu-id="aa559-237">Call [**IDirect3DCryptoSession9::NegotiateKeyExchange**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-negotiatekeyexchange) to send the encrypted session key to the driver.</span></span>
8.  <span data-ttu-id="aa559-238">Si las capacidades de protección de contenido incluyen **D3DCPCAPS_CONTENTKEY**, cree una clave de contenido RSA aleatoria.</span><span class="sxs-lookup"><span data-stu-id="aa559-238">If the content protection capabilities include **D3DCPCAPS_CONTENTKEY**, create a random RSA content key.</span></span> <span data-ttu-id="aa559-239">Se usará más adelante en el proceso de descodificación.</span><span class="sxs-lookup"><span data-stu-id="aa559-239">This will be used later in the decoding process.</span></span>

### <a name="4-get-a-handle-to-the-dxva-decoder-device"></a><span data-ttu-id="aa559-240">4. obtener un identificador para el dispositivo descodificador de DXVA</span><span class="sxs-lookup"><span data-stu-id="aa559-240">4. Get a Handle to the DXVA Decoder Device</span></span>

<span data-ttu-id="aa559-241">En el siguiente paso, necesitará un identificador para el dispositivo descodificador de DXVA.</span><span class="sxs-lookup"><span data-stu-id="aa559-241">For the next step, you will need a handle to the DXVA decoder device.</span></span> <span data-ttu-id="aa559-242">Para obtener este identificador, rellene una estructura de DXVA2_DecodeExecuteParams como se indica a continuación:</span><span class="sxs-lookup"><span data-stu-id="aa559-242">To get this handle, fill in a DXVA2_DecodeExecuteParams structure as follows:</span></span>


```C++
HANDLE hDecodeDeviceHandle;

DXVA2_DecodeExecuteParams execParams = {0};
DXVA2_DecodeExtensionData ExtensionExecute = {0};
    
execParams.NumCompBuffers = 0;
execParams.pCompressedBuffers = NULL;
execParams.pExtensionData = &ExtensionExecute;

ExtensionExecute.Function = DXVA2_DECODE_GET_DRIVER_HANDLE;
ExtensionExecute.pPrivateInputData = NULL;
ExtensionExecute.PrivateInputDataSize = 0;
ExtensionExecute.pPrivateOutputData = &hDecodeDeviceHandle;
ExtensionExecute.PrivateOutputDataSize = sizeof(HANDLE);
```



<span data-ttu-id="aa559-243">Establezca el miembro **pExtensionData** de la estructura [**DXVA2_DecodeExecuteParams**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeexecuteparams) en la dirección de una estructura de [**DXVA2_DecodeExtensionData**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeextensiondata) .</span><span class="sxs-lookup"><span data-stu-id="aa559-243">Set the **pExtensionData** member of the [**DXVA2_DecodeExecuteParams**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeexecuteparams) structure to the address of a [**DXVA2_DecodeExtensionData**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeextensiondata) structure.</span></span>

<span data-ttu-id="aa559-244">En la estructura [**DXVA2_DecodeExtensionData**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeextensiondata) , establezca el miembro de **función** en **DXVA2_DECODE_GET_DRIVER_HANDLE**.</span><span class="sxs-lookup"><span data-stu-id="aa559-244">In the [**DXVA2_DecodeExtensionData**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeextensiondata) structure, set the **Function** member to **DXVA2_DECODE_GET_DRIVER_HANDLE**.</span></span> <span data-ttu-id="aa559-245">Establezca **pPrivateOutputData** en la dirección de un búfer que sea lo suficientemente grande como para almacenar un valor de **identificador** .</span><span class="sxs-lookup"><span data-stu-id="aa559-245">Set **pPrivateOutputData** to the address of a buffer that is large enough to store a **HANDLE** value.</span></span> <span data-ttu-id="aa559-246">(En el ejemplo anterior, este búfer es la variable *hDecodeDeviceHandle* ).</span><span class="sxs-lookup"><span data-stu-id="aa559-246">(In the previous example, this buffer is the *hDecodeDeviceHandle* variable.)</span></span>

<span data-ttu-id="aa559-247">A continuación, llame a [**IDirectXVideoDecoder:: Execute**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) y pase la dirección de la estructura [**DXVA2_DecodeExecuteParams**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeexecuteparams) .</span><span class="sxs-lookup"><span data-stu-id="aa559-247">Then call [**IDirectXVideoDecoder::Execute**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) and pass in the address of the [**DXVA2_DecodeExecuteParams**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeexecuteparams) structure.</span></span> <span data-ttu-id="aa559-248">El identificador del descodificador de DXVA se devuelve en **pPrivateOutputData**.</span><span class="sxs-lookup"><span data-stu-id="aa559-248">The handle to the DXVA decoder is returned in **pPrivateOutputData**.</span></span>

### <a name="5-associate-the-dxva-decoder-with-the-cryptographic-session"></a><span data-ttu-id="aa559-249">5. asociar el descodificador de DXVA a la sesión criptográfica</span><span class="sxs-lookup"><span data-stu-id="aa559-249">5. Associate the DXVA Decoder with the Cryptographic Session</span></span>

<span data-ttu-id="aa559-250">A continuación, asocie el dispositivo descodificador de DXVA con el dispositivo Direct3D y la sesión de cifrado, como se indica a continuación:</span><span class="sxs-lookup"><span data-stu-id="aa559-250">Next, associate the DXVA decoder device with the Direct3D device and the cryptographic session, as follows:</span></span>

1.  <span data-ttu-id="aa559-251">Obtiene un identificador para el dispositivo descodificador de DXVA, tal como se describe en la sección anterior.</span><span class="sxs-lookup"><span data-stu-id="aa559-251">Get a handle to the DXVA decoder device, as described in the previous section.</span></span>
2.  <span data-ttu-id="aa559-252">Obtener un identificador para el dispositivo Direct3D mediante el envío de una [**D3DAUTHENTICATEDQUERY_DEVICEHANDLE**](d3dauthenticatedquery-devicehandle.md) consulta al canal autenticado.</span><span class="sxs-lookup"><span data-stu-id="aa559-252">Get a handle to the Direct3D device, by sending a [**D3DAUTHENTICATEDQUERY_DEVICEHANDLE**](d3dauthenticatedquery-devicehandle.md) query to the authenticated channel.</span></span>
3.  <span data-ttu-id="aa559-253">Rellene una estructura de [**D3DAUTHENTICATEDCHANNEL_CONFIGURECRYPTOSESSION**](d3dauthenticatedchannel-configurecryptosession.md) con la siguiente información:</span><span class="sxs-lookup"><span data-stu-id="aa559-253">Fill in a [**D3DAUTHENTICATEDCHANNEL_CONFIGURECRYPTOSESSION**](d3dauthenticatedchannel-configurecryptosession.md) structure with the following information:</span></span>
    -   <span data-ttu-id="aa559-254">Establezca el miembro **DXVA2DecodeHandle** en el identificador del dispositivo de descodificador de DXVA.</span><span class="sxs-lookup"><span data-stu-id="aa559-254">Set the **DXVA2DecodeHandle** member to the handle to the DXVA decoder device.</span></span>
    -   <span data-ttu-id="aa559-255">Establezca el miembro **CryptoSessionHandle** en el identificador de la sesión criptográfica.</span><span class="sxs-lookup"><span data-stu-id="aa559-255">Set the **CryptoSessionHandle** member to the handle to the cryptographic session.</span></span> <span data-ttu-id="aa559-256">Este identificador es devuelto por el método [**IDirect3DDevice9Video:: CreateCryptoSession**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession) .</span><span class="sxs-lookup"><span data-stu-id="aa559-256">This handle is returned by the [**IDirect3DDevice9Video::CreateCryptoSession**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession) method.</span></span>
    -   <span data-ttu-id="aa559-257">Establezca el miembro **DeviceHandle** en el identificador del dispositivo Direct3D.</span><span class="sxs-lookup"><span data-stu-id="aa559-257">Set the **DeviceHandle** member to the Direct3D device handle.</span></span>
4.  <span data-ttu-id="aa559-258">Llame a [**IDirect3DAuthenticatedChannel9:: configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure) para enviar un comando [**D3DAUTHENTICATEDCONFIGURE_CRYPTOSESSION**](d3dauthenticatedconfigure-cryptosession.md) al canal autenticado.</span><span class="sxs-lookup"><span data-stu-id="aa559-258">Call [**IDirect3DAuthenticatedChannel9::Configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure) to send a [**D3DAUTHENTICATEDCONFIGURE_CRYPTOSESSION**](d3dauthenticatedconfigure-cryptosession.md) command to the authenticated channel.</span></span>

<span data-ttu-id="aa559-259">En el diagrama siguiente se muestra el intercambio de identificadores:</span><span class="sxs-lookup"><span data-stu-id="aa559-259">The following diagram illustrates the exchange of handles:</span></span>

![diagrama que muestra cómo el descodificador de DXVA está asociado a la sesión criptográfica.](images/d3d9video03.png)

<span data-ttu-id="aa559-261">Ahora, el descodificador de software puede usar la clave de sesión criptográfica para cifrar los búferes de vídeo comprimidos.</span><span class="sxs-lookup"><span data-stu-id="aa559-261">The software decoder can now use the cryptographic session key to encrypt the compressed video buffers.</span></span> <span data-ttu-id="aa559-262">Cada búfer comprimido tendrá su propio vector de inicialización (IV) especificado en el miembro **pvPVPState** de la estructura [**DXVA2_DecodeBufferDesc**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodebufferdesc) .</span><span class="sxs-lookup"><span data-stu-id="aa559-262">Each compressed buffer will have its own initialization vector (IV) specified in the **pvPVPState** member of the [**DXVA2_DecodeBufferDesc**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodebufferdesc) structure.</span></span>

## <a name="sending-authenticated-channel-commands"></a><span data-ttu-id="aa559-263">Envío de comandos de canal autenticado</span><span class="sxs-lookup"><span data-stu-id="aa559-263">Sending Authenticated Channel Commands</span></span>

<span data-ttu-id="aa559-264">Se define un conjunto de comandos para configurar el canal autenticado y establecer varias protecciones de contenido.</span><span class="sxs-lookup"><span data-stu-id="aa559-264">A set of commands are defined for configuring the authenticated channel and setting various content protections.</span></span> <span data-ttu-id="aa559-265">Para obtener una lista de comandos, vea [comandos Content Protection](content-protection-commands.md).</span><span class="sxs-lookup"><span data-stu-id="aa559-265">For a list of commands, see [Content Protection Commands](content-protection-commands.md).</span></span>

<span data-ttu-id="aa559-266">Para enviar un comando al canal autenticado, realice los pasos siguientes.</span><span class="sxs-lookup"><span data-stu-id="aa559-266">To send a command to the authenticated channel, perform the following steps.</span></span>

1.  <span data-ttu-id="aa559-267">Rellene la estructura de datos de entrada.</span><span class="sxs-lookup"><span data-stu-id="aa559-267">Fill in the input data structure.</span></span> <span data-ttu-id="aa559-268">Esta estructura de datos siempre es una estructura de [**D3DAUTHENTICATEDCHANNEL_CONFIGURE_INPUT**](d3dauthenticatedchannel-configure-input.md) seguido de campos adicionales.</span><span class="sxs-lookup"><span data-stu-id="aa559-268">This data structure is always a [**D3DAUTHENTICATEDCHANNEL_CONFIGURE_INPUT**](d3dauthenticatedchannel-configure-input.md) structure followed by additional fields.</span></span> <span data-ttu-id="aa559-269">Rellene la estructura **D3DAUTHENTICATEDCHANNEL_CONFIGURE_INPUT** como se muestra en la tabla siguiente.</span><span class="sxs-lookup"><span data-stu-id="aa559-269">Fill in the **D3DAUTHENTICATEDCHANNEL_CONFIGURE_INPUT** structure as shown in the following table.</span></span>

    <table>
    <colgroup>
    <col style="width: 50%" />
    <col style="width: 50%" />
    </colgroup>
    <thead>
    <tr class="header">
    <th><span data-ttu-id="aa559-270">Miembro</span><span class="sxs-lookup"><span data-stu-id="aa559-270">Member</span></span></th>
    <th><span data-ttu-id="aa559-271">Descripción</span><span class="sxs-lookup"><span data-stu-id="aa559-271">Description</span></span></th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td><span data-ttu-id="aa559-272"><strong>omac</strong></span><span class="sxs-lookup"><span data-stu-id="aa559-272"><strong>omac</strong></span></span></td>
    <td><span data-ttu-id="aa559-273">Omitir este campo por ahora.</span><span class="sxs-lookup"><span data-stu-id="aa559-273">Skip this field for now.</span></span></td>
    </tr>
    <tr class="even">
    <td><span data-ttu-id="aa559-274"><strong>ConfigureType</strong></span><span class="sxs-lookup"><span data-stu-id="aa559-274"><strong>ConfigureType</strong></span></span></td>
    <td><span data-ttu-id="aa559-275">GUID que identifica el comando.</span><span class="sxs-lookup"><span data-stu-id="aa559-275">GUID that identifies the command.</span></span> <span data-ttu-id="aa559-276">Para obtener una lista de comandos, vea <a href="content-protection-commands.md">comandos Content Protection</a>.</span><span class="sxs-lookup"><span data-stu-id="aa559-276">For a list of commands, see <a href="content-protection-commands.md">Content Protection Commands</a>.</span></span></td>
    </tr>
    <tr class="odd">
    <td><span data-ttu-id="aa559-277"><strong>hChannel</strong></span><span class="sxs-lookup"><span data-stu-id="aa559-277"><strong>hChannel</strong></span></span></td>
    <td><span data-ttu-id="aa559-278">Identificador del canal autenticado.</span><span class="sxs-lookup"><span data-stu-id="aa559-278">The handle to the authenticated channel.</span></span></td>
    </tr>
    <tr class="even">
    <td><span data-ttu-id="aa559-279"><strong>SequenceNumber</strong></span><span class="sxs-lookup"><span data-stu-id="aa559-279"><strong>SequenceNumber</strong></span></span></td>
    <td><span data-ttu-id="aa559-280">El número de secuencia global.</span><span class="sxs-lookup"><span data-stu-id="aa559-280">The sequence number.</span></span> <span data-ttu-id="aa559-281">El primer número de secuencia se especifica mediante el envío de un comando <a href="d3dauthenticatedconfigure-initialize.md"><strong>D3DAUTHENTICATEDCONFIGURE_INITIALIZE</strong></a> .</span><span class="sxs-lookup"><span data-stu-id="aa559-281">The first sequence number is specified by sending a <a href="d3dauthenticatedconfigure-initialize.md"><strong>D3DAUTHENTICATEDCONFIGURE_INITIALIZE</strong></a> command.</span></span> <span data-ttu-id="aa559-282">Cada vez que envíe otro comando, incremente este número en 1.</span><span class="sxs-lookup"><span data-stu-id="aa559-282">Each time you send another command, increment this number by 1.</span></span> <span data-ttu-id="aa559-283">El número de secuencia se protege contra los ataques de reproducción.</span><span class="sxs-lookup"><span data-stu-id="aa559-283">The sequence number guards against replay attacks.</span></span>
    <blockquote>
    [!Note]<br />
<span data-ttu-id="aa559-284">Se usan dos números de secuencia independientes, uno para los comandos y otro para las consultas.</span><span class="sxs-lookup"><span data-stu-id="aa559-284">Two separate sequence numbers are used, one for commands and one for queries.</span></span>
    </blockquote>
    <br/> <br/></td>
    </tr>
    </tbody>
    </table>

    

     

2.  <span data-ttu-id="aa559-285">Calcule la etiqueta OMAC para el bloque de datos que aparece después del miembro **OMAC** de la estructura de entrada.</span><span class="sxs-lookup"><span data-stu-id="aa559-285">Calculate the OMAC tag for the block of data that appears after the **omac** member of the input structure.</span></span> <span data-ttu-id="aa559-286">A continuación, copie este valor de etiqueta en el miembro **OMAC** .</span><span class="sxs-lookup"><span data-stu-id="aa559-286">Then copy this tag value into the **omac** member.</span></span>
3.  <span data-ttu-id="aa559-287">Llame a [**IDirect3DAuthenticatedChannel9:: configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure).</span><span class="sxs-lookup"><span data-stu-id="aa559-287">Call [**IDirect3DAuthenticatedChannel9::Configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure).</span></span>
4.  <span data-ttu-id="aa559-288">El controlador coloca el resultado del comando en la estructura [**D3DAUTHENTICATEDCHANNEL_CONFIGURE_OUTPUT**](d3dauthenticatedchannel-configure-output.md) .</span><span class="sxs-lookup"><span data-stu-id="aa559-288">The driver places the output from the command in the [**D3DAUTHENTICATEDCHANNEL_CONFIGURE_OUTPUT**](d3dauthenticatedchannel-configure-output.md) structure.</span></span>
5.  <span data-ttu-id="aa559-289">Calcule la etiqueta OMAC para el bloque de datos que aparece después del miembro **OMAC** de la estructura de salida.</span><span class="sxs-lookup"><span data-stu-id="aa559-289">Calculate the OMAC tag for the block of data that appears after the **omac** member of the output structure.</span></span> <span data-ttu-id="aa559-290">Compárelo con el valor del miembro **OMAC** .</span><span class="sxs-lookup"><span data-stu-id="aa559-290">Compare this with the value of the **omac** member.</span></span> <span data-ttu-id="aa559-291">Se produce un error si no coinciden.</span><span class="sxs-lookup"><span data-stu-id="aa559-291">Fail if they do not match.</span></span>
6.  <span data-ttu-id="aa559-292">Compare los valores de los miembros **ConfigureType**, **hChannel** y **SequenceNumber** en la estructura de salida con los valores de esos miembros.</span><span class="sxs-lookup"><span data-stu-id="aa559-292">Compare the values of the **ConfigureType**, **hChannel**, and **SequenceNumber** members in the output structure against your values for those members.</span></span> <span data-ttu-id="aa559-293">Se produce un error si no coinciden.</span><span class="sxs-lookup"><span data-stu-id="aa559-293">Fail if they do not match.</span></span>
7.  <span data-ttu-id="aa559-294">Incremente el número de secuencia para el siguiente comando.</span><span class="sxs-lookup"><span data-stu-id="aa559-294">Increment the sequence number for the next command.</span></span>

## <a name="sending-authenticated-channel-queries"></a><span data-ttu-id="aa559-295">Envío de consultas de canales autenticadas</span><span class="sxs-lookup"><span data-stu-id="aa559-295">Sending Authenticated Channel Queries</span></span>

<span data-ttu-id="aa559-296">Se define un conjunto de consultas para recuperar información sobre el canal autenticado.</span><span class="sxs-lookup"><span data-stu-id="aa559-296">A set of queries are defined for retrieving information about the authenticated channel.</span></span> <span data-ttu-id="aa559-297">Para obtener una lista de consultas, vea [consultas de Content Protection](content-protection-queries.md).</span><span class="sxs-lookup"><span data-stu-id="aa559-297">For a list of queries, see [Content Protection Queries](content-protection-queries.md).</span></span>

<span data-ttu-id="aa559-298">Para enviar un comando al canal autenticado, realice los pasos siguientes.</span><span class="sxs-lookup"><span data-stu-id="aa559-298">To send a command to the authenticated channel, perform the following steps.</span></span>

1.  <span data-ttu-id="aa559-299">Rellene la estructura de datos de entrada.</span><span class="sxs-lookup"><span data-stu-id="aa559-299">Fill in the input data structure.</span></span> <span data-ttu-id="aa559-300">Esta estructura de datos siempre es una estructura de [**D3DAUTHENTICATEDCHANNEL_QUERY_INPUT**](d3dauthenticatedchannel-query-input.md) , posiblemente seguida de campos adicionales.</span><span class="sxs-lookup"><span data-stu-id="aa559-300">This data structure is always a [**D3DAUTHENTICATEDCHANNEL_QUERY_INPUT**](d3dauthenticatedchannel-query-input.md) structure, possibly followed by additional fields.</span></span> <span data-ttu-id="aa559-301">Rellene la estructura **D3DAUTHENTICATEDCHANNEL_QUERY_INPUT** como se muestra en la tabla siguiente.</span><span class="sxs-lookup"><span data-stu-id="aa559-301">Fill in the **D3DAUTHENTICATEDCHANNEL_QUERY_INPUT** structure as shown in the following table.</span></span>

    <table>
    <colgroup>
    <col style="width: 50%" />
    <col style="width: 50%" />
    </colgroup>
    <thead>
    <tr class="header">
    <th><span data-ttu-id="aa559-302">Miembro</span><span class="sxs-lookup"><span data-stu-id="aa559-302">Member</span></span></th>
    <th><span data-ttu-id="aa559-303">Descripción</span><span class="sxs-lookup"><span data-stu-id="aa559-303">Description</span></span></th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td><span data-ttu-id="aa559-304"><strong>QueryType</strong></span><span class="sxs-lookup"><span data-stu-id="aa559-304"><strong>QueryType</strong></span></span></td>
    <td><span data-ttu-id="aa559-305">GUID que identifica la consulta.</span><span class="sxs-lookup"><span data-stu-id="aa559-305">GUID that identifies the query.</span></span> <span data-ttu-id="aa559-306">Para obtener una lista de consultas, vea <a href="content-protection-queries.md">consultas de Content Protection</a>.</span><span class="sxs-lookup"><span data-stu-id="aa559-306">For a list of queries, see <a href="content-protection-queries.md">Content Protection Queries</a>.</span></span></td>
    </tr>
    <tr class="even">
    <td><span data-ttu-id="aa559-307"><strong>hChannel</strong></span><span class="sxs-lookup"><span data-stu-id="aa559-307"><strong>hChannel</strong></span></span></td>
    <td><span data-ttu-id="aa559-308">Identificador del canal autenticado.</span><span class="sxs-lookup"><span data-stu-id="aa559-308">The handle to the authenticated channel.</span></span></td>
    </tr>
    <tr class="odd">
    <td><span data-ttu-id="aa559-309"><strong>SequenceNumber</strong></span><span class="sxs-lookup"><span data-stu-id="aa559-309"><strong>SequenceNumber</strong></span></span></td>
    <td><span data-ttu-id="aa559-310">El número de secuencia global.</span><span class="sxs-lookup"><span data-stu-id="aa559-310">The sequence number.</span></span> <span data-ttu-id="aa559-311">El primer número de secuencia se especifica mediante el envío de un comando <a href="d3dauthenticatedconfigure-initialize.md"><strong>D3DAUTHENTICATEDCONFIGURE_INITIALIZE</strong></a> .</span><span class="sxs-lookup"><span data-stu-id="aa559-311">The first sequence number is specified by sending a <a href="d3dauthenticatedconfigure-initialize.md"><strong>D3DAUTHENTICATEDCONFIGURE_INITIALIZE</strong></a> command.</span></span> <span data-ttu-id="aa559-312">Cada vez que envíe otra consulta, incremente este número en 1.</span><span class="sxs-lookup"><span data-stu-id="aa559-312">Each time you send another query, increment this number by 1.</span></span> <span data-ttu-id="aa559-313">El número de secuencia se protege contra los ataques de reproducción.</span><span class="sxs-lookup"><span data-stu-id="aa559-313">The sequence number guards against replay attacks.</span></span>
    <blockquote>
    [!Note]<br />
<span data-ttu-id="aa559-314">Se usan dos números de secuencia independientes, uno para los comandos y otro para las consultas.</span><span class="sxs-lookup"><span data-stu-id="aa559-314">Two separate sequence numbers are used, one for commands and one for queries.</span></span>
    </blockquote>
    <br/> <br/></td>
    </tr>
    </tbody>
    </table>

    

     

2.  <span data-ttu-id="aa559-315">Llame a [**IDirect3DAuthenticatedChannel9:: query**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-query).</span><span class="sxs-lookup"><span data-stu-id="aa559-315">Call [**IDirect3DAuthenticatedChannel9::Query**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-query).</span></span>
3.  <span data-ttu-id="aa559-316">El controlador coloca el resultado de la consulta en una estructura de [**D3DAUTHENTICATEDCHANNEL_QUERY_OUTPUT**](d3dauthenticatedchannel-query-output.md) .</span><span class="sxs-lookup"><span data-stu-id="aa559-316">The driver places the output from the query in a [**D3DAUTHENTICATEDCHANNEL_QUERY_OUTPUT**](d3dauthenticatedchannel-query-output.md) structure.</span></span> <span data-ttu-id="aa559-317">Esta estructura va seguida de campos adicionales, en función del tipo de consulta.</span><span class="sxs-lookup"><span data-stu-id="aa559-317">This structure is followed by additional fields, depending on the query type.</span></span>
4.  <span data-ttu-id="aa559-318">Calcule la etiqueta OMAC para el bloque de datos que aparece después del miembro **OMAC** de la estructura de salida.</span><span class="sxs-lookup"><span data-stu-id="aa559-318">Calculate the OMAC tag for the block of data that appears after the **omac** member of the output structure.</span></span> <span data-ttu-id="aa559-319">Compárelo con el valor del miembro **OMAC** .</span><span class="sxs-lookup"><span data-stu-id="aa559-319">Compare this with the value of the **omac** member.</span></span> <span data-ttu-id="aa559-320">Se produce un error si no coinciden.</span><span class="sxs-lookup"><span data-stu-id="aa559-320">Fail if they do not match.</span></span>
5.  <span data-ttu-id="aa559-321">Compare los valores de los miembros **ConfigureType**, **hChannel** y **SequenceNumber** en la estructura de salida con los valores de esos miembros.</span><span class="sxs-lookup"><span data-stu-id="aa559-321">Compare the values of the **ConfigureType**, **hChannel**, and **SequenceNumber** members in the output structure against your values for those members.</span></span> <span data-ttu-id="aa559-322">Se produce un error si no coinciden.</span><span class="sxs-lookup"><span data-stu-id="aa559-322">Fail if they do not match.</span></span>
6.  <span data-ttu-id="aa559-323">Incremente el número de secuencia de la siguiente consulta.</span><span class="sxs-lookup"><span data-stu-id="aa559-323">Increment the sequence number for the next query.</span></span>

## <a name="related-topics"></a><span data-ttu-id="aa559-324">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="aa559-324">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="aa559-325">API de vídeo de Direct3D 9</span><span class="sxs-lookup"><span data-stu-id="aa559-325">Direct3D 9 Video APIs</span></span>](direct3d-video-apis.md)
</dt> </dl>

 

 
