---
title: Arquitectura y componentes
description: En este tema se describen los componentes que componen Microsoft DirectComposition.
ms.assetid: 7C79B330-41EA-4BA0-9103-BB5A0C3D4CE2
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: fb2de495aa170560b1e7082cacf1893a8c94905a
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/20/2020
ms.locfileid: "104078186"
---
# <a name="architecture-and-components"></a><span data-ttu-id="f671b-103">Arquitectura y componentes</span><span class="sxs-lookup"><span data-stu-id="f671b-103">Architecture and components</span></span>

> [!NOTE]
> <span data-ttu-id="f671b-104">En el caso de las aplicaciones de Windows 10, se recomienda usar las API de Windows. UI. Composition en lugar de DirectComposition.</span><span class="sxs-lookup"><span data-stu-id="f671b-104">For apps on Windows 10, we recommend using Windows.UI.Composition APIs instead of DirectComposition.</span></span> <span data-ttu-id="f671b-105">Para obtener más información, consulte [modernice su aplicación de escritorio con el nivel de objetos visuales](/windows/uwp/composition/visual-layer-in-desktop-apps).</span><span class="sxs-lookup"><span data-stu-id="f671b-105">For more info, see [Modernize your desktop app using the Visual layer](/windows/uwp/composition/visual-layer-in-desktop-apps).</span></span>

<span data-ttu-id="f671b-106">En este tema se describen los componentes que componen Microsoft DirectComposition.</span><span class="sxs-lookup"><span data-stu-id="f671b-106">This topic describes the components that make up Microsoft DirectComposition.</span></span> <span data-ttu-id="f671b-107">Consta de las siguientes secciones.</span><span class="sxs-lookup"><span data-stu-id="f671b-107">It consists of the following sections.</span></span>

-   [<span data-ttu-id="f671b-108">Componentes de software</span><span class="sxs-lookup"><span data-stu-id="f671b-108">Software components</span></span>](#software-components)
-   [<span data-ttu-id="f671b-109">Biblioteca de aplicaciones</span><span class="sxs-lookup"><span data-stu-id="f671b-109">Application library</span></span>](#application-library)
-   [<span data-ttu-id="f671b-110">Motor de composición</span><span class="sxs-lookup"><span data-stu-id="f671b-110">Composition engine</span></span>](#composition-engine)
-   [<span data-ttu-id="f671b-111">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="f671b-111">Related topics</span></span>](#related-topics)

## <a name="software-components"></a><span data-ttu-id="f671b-112">Componentes de software</span><span class="sxs-lookup"><span data-stu-id="f671b-112">Software components</span></span>

<span data-ttu-id="f671b-113">DirectComposition consta de los siguientes componentes de software principales.</span><span class="sxs-lookup"><span data-stu-id="f671b-113">DirectComposition consists of the following main software components.</span></span>

-   <span data-ttu-id="f671b-114">Biblioteca de aplicaciones de modo de usuario (dcomp.dll) que implementa la API pública basada en el modelo de objetos componentes (COM).</span><span class="sxs-lookup"><span data-stu-id="f671b-114">A user-mode application library (dcomp.dll) that implements the Component Object Model (COM)-based public API.</span></span>
-   <span data-ttu-id="f671b-115">Un motor de composición de modo de usuario (dwmcore.dll) que se hospeda en el proceso de Administrador de ventanas de escritorio (DWM) (dwm.exe) y realiza la composición de escritorio real.</span><span class="sxs-lookup"><span data-stu-id="f671b-115">A user-mode composition engine (dwmcore.dll) that is hosted in the Desktop Window Manager (DWM) process (dwm.exe), and performs the actual desktop composition.</span></span>
-   <span data-ttu-id="f671b-116">Base de datos de objetos de modo kernel (parte de win32k.sys) que calcula las referencias de los comandos de la aplicación al motor de composición.</span><span class="sxs-lookup"><span data-stu-id="f671b-116">A kernel-mode object database (part of win32k.sys) that marshals commands from the application to the composition engine.</span></span>

<span data-ttu-id="f671b-117">Una sola instancia del motor de composición controla los árboles de composición de DirectComposition para todas las aplicaciones y el árbol de composición de DWM, que representa todo el escritorio.</span><span class="sxs-lookup"><span data-stu-id="f671b-117">A single instance of the composition engine handles the DirectComposition composition trees for all applications and the DWM composition tree, which represents the entire desktop.</span></span> <span data-ttu-id="f671b-118">Se crea una instancia de la base de datos de objetos de modo kernel y del motor de composición de modo de usuario una vez por sesión, por lo que una máquina Terminal Server con varios usuarios tiene varias instancias de ambos componentes.</span><span class="sxs-lookup"><span data-stu-id="f671b-118">Both the kernel-mode object database and the user-mode composition engine are instantiated once per session, so a Terminal Server machine with multiple users has multiple instances of both of those components.</span></span>

<span data-ttu-id="f671b-119">En el diagrama siguiente se muestran los componentes principales de DirectComposition y cómo se relacionan entre sí.</span><span class="sxs-lookup"><span data-stu-id="f671b-119">The following diagram shows the main DirectComposition components and how they relate to one another.</span></span>

![arquitectura de nivel superior de directcomposition](images/directcomposition-top-level-architecture.png)

## <a name="application-library"></a><span data-ttu-id="f671b-121">Biblioteca de aplicaciones</span><span class="sxs-lookup"><span data-stu-id="f671b-121">Application library</span></span>

<span data-ttu-id="f671b-122">La biblioteca de aplicaciones de DirectComposition es una API basada en COM pública con un único punto de entrada plano que se exporta desde dcomp.dll y devuelve un puntero de interfaz a un objeto de dispositivo.</span><span class="sxs-lookup"><span data-stu-id="f671b-122">The DirectComposition application library is a public COM-based API with a single flat entry-point that is exported from dcomp.dll and returns an interface pointer to a device object.</span></span> <span data-ttu-id="f671b-123">El objeto de dispositivo, a su vez, tiene métodos para crear todos los demás objetos, cada uno de los cuales se representa mediante un puntero de interfaz.</span><span class="sxs-lookup"><span data-stu-id="f671b-123">The device object, in turn, has methods for creating all other objects, each of which is represented by an interface pointer.</span></span> <span data-ttu-id="f671b-124">Todas las interfaces DirectComposition heredan de y implementan completamente la interfaz [**IUnknown**](/windows/desktop/api/unknwn/nn-unknwn-iunknown) .</span><span class="sxs-lookup"><span data-stu-id="f671b-124">All DirectComposition interfaces inherit from and fully implement the [**IUnknown**](/windows/desktop/api/unknwn/nn-unknwn-iunknown) interface.</span></span> <span data-ttu-id="f671b-125">Todos los métodos que aceptan interfaces DirectCompositions comprueban si la interfaz está implementada dentro de dcomp.dll o si está implementada por otro componente.</span><span class="sxs-lookup"><span data-stu-id="f671b-125">All methods that accept DirectComposition interfaces check whether the interface is implemented inside of dcomp.dll or whether it is implemented by another component.</span></span> <span data-ttu-id="f671b-126">Dado que DirectComposition no es extensible, los métodos que toman interfaces como parámetros devuelven E \_ INVALIDARG si las interfaces no se implementan en dcomp.dll.</span><span class="sxs-lookup"><span data-stu-id="f671b-126">Because DirectComposition is not extensible, methods that take interfaces as parameters return E\_INVALIDARG if the interfaces are not implemented in dcomp.dll.</span></span> <span data-ttu-id="f671b-127">La API no requiere ningún privilegio especial; puede ser llamado por procesos que se ejecutan en el nivel más bajo de acceso.</span><span class="sxs-lookup"><span data-stu-id="f671b-127">The API requires no special privileges; it can be called by processes running at the lowest level of access.</span></span> <span data-ttu-id="f671b-128">Sin embargo, dado que la API no funciona en la sesión 0, no es adecuada para los servicios.</span><span class="sxs-lookup"><span data-stu-id="f671b-128">However, because the API does not operate in session 0, it is not suitable for services.</span></span> <span data-ttu-id="f671b-129">En estos aspectos, la API DirectComposition es similar a otras API de Microsoft DirectX, especialmente en Direct2D, Microsoft Direct3D y Microsoft DirectWrite.</span><span class="sxs-lookup"><span data-stu-id="f671b-129">In these respects, the DirectComposition API is similar to other Microsoft DirectX APIs, most notably Direct2D, Microsoft Direct3D, and Microsoft DirectWrite.</span></span>

<span data-ttu-id="f671b-130">Dado que el motor de composición está diseñado exclusivamente para la ejecución asincrónica, las propiedades de objeto de la API de DirectComposition son de solo escritura.</span><span class="sxs-lookup"><span data-stu-id="f671b-130">Because the composition engine is designed exclusively for asynchronous execution, object properties in the DirectComposition API are write-only.</span></span> <span data-ttu-id="f671b-131">Todas las propiedades tienen métodos de establecedor, pero no métodos de captador.</span><span class="sxs-lookup"><span data-stu-id="f671b-131">All properties have setter methods, but not getter methods.</span></span> <span data-ttu-id="f671b-132">Leer propiedades no solo es un uso intensivo de los recursos, sino que también puede ser inexacto porque cualquier valor devuelto por el motor de composición puede dejar de ser válido inmediatamente.</span><span class="sxs-lookup"><span data-stu-id="f671b-132">Reading properties is not only resource intensive, but can also be inaccurate because any value that the composition engine returns can immediately become invalid.</span></span> <span data-ttu-id="f671b-133">Esto puede ocurrir si, por ejemplo, una animación independiente se enlaza a la propiedad que se está leyendo.</span><span class="sxs-lookup"><span data-stu-id="f671b-133">This can happen if, for example, an independent animation is bound to the property that is being read.</span></span>

<span data-ttu-id="f671b-134">La API es segura para subprocesos.</span><span class="sxs-lookup"><span data-stu-id="f671b-134">The API is thread-safe.</span></span> <span data-ttu-id="f671b-135">Una aplicación puede llamar a cualquier método desde cualquier subproceso en cualquier momento.</span><span class="sxs-lookup"><span data-stu-id="f671b-135">An application can call any method from any thread at any time.</span></span> <span data-ttu-id="f671b-136">Sin embargo, dado que se debe llamar a muchos métodos de API en una secuencia determinada, sin ninguna sincronización, una aplicación puede experimentar un comportamiento imprevisible en función de cómo intercalan los subprocesos.</span><span class="sxs-lookup"><span data-stu-id="f671b-136">However, because many API methods must be called in a particular sequence, without any synchronization an application can experience unpredictable behavior depending on how the threads interleave.</span></span> <span data-ttu-id="f671b-137">Por ejemplo, si dos subprocesos cambian la misma propiedad del mismo objeto a valores diferentes al mismo tiempo, la aplicación no puede predecir cuál de los dos valores será el valor final de la propiedad.</span><span class="sxs-lookup"><span data-stu-id="f671b-137">For example, if two threads change the same property of the same object to different values at the same time, the application cannot predict which of the two values will be the final value of the property.</span></span> <span data-ttu-id="f671b-138">Del mismo modo, si dos subprocesos llaman a [**commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit) en el mismo dispositivo, ninguno de los subprocesos obtiene un comportamiento realmente transaccional porque una llamada a **commit** en un subproceso enviará el lote de todos los comandos emitidos por ambos subprocesos, no solo el que llamó a **commit**.</span><span class="sxs-lookup"><span data-stu-id="f671b-138">Similarly, if two threads call [**Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit) on the same device, neither thread gets truly transactional behavior because a call to **Commit** on one thread will submit the batch of all commands issued by both threads, not just the one that called **Commit**.</span></span>

<span data-ttu-id="f671b-139">El sistema mantiene todo el estado interno por cada objeto de dispositivo.</span><span class="sxs-lookup"><span data-stu-id="f671b-139">The system maintains all internal state per device object.</span></span> <span data-ttu-id="f671b-140">Si una aplicación crea dos o más objetos de dispositivo DirectComposition, la aplicación puede mantener lotes independientes y otro estado entre los dos.</span><span class="sxs-lookup"><span data-stu-id="f671b-140">If an application creates two or more DirectComposition device objects, the application can maintain independent batches and other state between the two.</span></span>

<span data-ttu-id="f671b-141">Todos los objetos DirectComposition tienen afinidad de objeto de dispositivo; los objetos creados por un objeto de dispositivo determinado solo se pueden usar con ese objeto de dispositivo y solo pueden asociarse a otros objetos creados por el mismo objeto de dispositivo.</span><span class="sxs-lookup"><span data-stu-id="f671b-141">All DirectComposition objects have device object affinity; objects created by a particular device object can be used only with that device object, and can be associated only with other objects created by the same device object.</span></span> <span data-ttu-id="f671b-142">En otras palabras, cada objeto de dispositivo es una isla separada independiente de la funcionalidad.</span><span class="sxs-lookup"><span data-stu-id="f671b-142">In other words, each device object is a separate disjoint island of functionality.</span></span> <span data-ttu-id="f671b-143">La única excepción es la clase visual, que permite compilar árboles visuales en los que un objeto visual puede pertenecer a un objeto de dispositivo diferente al de su elemento primario.</span><span class="sxs-lookup"><span data-stu-id="f671b-143">The one exception is the visual class, which permits the building of visual trees where a visual can belong to a different device object than its parent.</span></span> <span data-ttu-id="f671b-144">Esto permite escenarios en los que una aplicación y un control pueden administrar un único árbol de composición sin necesidad de compartir un único objeto de dispositivo DirectComposition.</span><span class="sxs-lookup"><span data-stu-id="f671b-144">This enables scenarios where an application and a control can manage a single composition tree without also needing to share a single DirectComposition device object.</span></span>

## <a name="composition-engine"></a><span data-ttu-id="f671b-145">Motor de composición</span><span class="sxs-lookup"><span data-stu-id="f671b-145">Composition engine</span></span>

<span data-ttu-id="f671b-146">El motor de composición DirectComposition se ejecuta en un proceso dedicado, independiente de cualquier proceso de aplicación.</span><span class="sxs-lookup"><span data-stu-id="f671b-146">The DirectComposition composition engine runs on a dedicated process, separate from any application process.</span></span> <span data-ttu-id="f671b-147">Un único proceso de composición, dwm.exe, admite todas las aplicaciones de una sesión.</span><span class="sxs-lookup"><span data-stu-id="f671b-147">A single composition process, dwm.exe, supports every application in a session.</span></span> <span data-ttu-id="f671b-148">Cada aplicación puede crear dos árboles visuales para cada ventana que posee.</span><span class="sxs-lookup"><span data-stu-id="f671b-148">Each application can create two visual trees for each window that it owns.</span></span> <span data-ttu-id="f671b-149">Todos los árboles se implementan realmente como subárboles de un árbol visual mayor que también abarca las estructuras de composición de DWM.</span><span class="sxs-lookup"><span data-stu-id="f671b-149">All of the trees are actually implemented as subtrees of a larger visual tree that also encompasses the composition structures of DWM.</span></span> <span data-ttu-id="f671b-150">DWM crea un árbol visual grande para cada escritorio de una sesión.</span><span class="sxs-lookup"><span data-stu-id="f671b-150">The DWM constructs one large visual tree for each desktop in a session.</span></span> <span data-ttu-id="f671b-151">Estas son las ventajas principales de esta arquitectura:</span><span class="sxs-lookup"><span data-stu-id="f671b-151">Here are the key advantages to this architecture:</span></span>

-   <span data-ttu-id="f671b-152">El motor de composición tiene acceso a todos los mapas de bits de la aplicación y a los árboles visuales, lo que permite la interoperabilidad y composición de ventanas entre procesos.</span><span class="sxs-lookup"><span data-stu-id="f671b-152">The composition engine has access to all application bitmaps and visual trees, which enables cross-process window interoperability and composition.</span></span>
-   <span data-ttu-id="f671b-153">El motor de composición se ejecuta en un proceso del sistema de confianza que es independiente de cualquier proceso de aplicación, lo que permite que las aplicaciones que tienen derechos de acceso de acceso seguro compongan contenido protegido.</span><span class="sxs-lookup"><span data-stu-id="f671b-153">The composition engine runs in a trusted system process that is separate from any application process, enabling applications that have low access rights to securely compose protected content.</span></span>
-   <span data-ttu-id="f671b-154">El motor de composición puede detectar si una ventana determinada es totalmente ocluidos y evita gastar recursos de CPU y de unidad de procesamiento de gráficos (GPU) compuestas para la ventana.</span><span class="sxs-lookup"><span data-stu-id="f671b-154">The composition engine can detect when a particular window is fully occluded and avoid wasting CPU and graphics processing unit (GPU) resources composing for the window.</span></span>
-   <span data-ttu-id="f671b-155">El motor de composición se puede componer directamente en el búfer de reserva de la pantalla, evitando la necesidad de una copia adicional necesaria para los motores de composición por proceso.</span><span class="sxs-lookup"><span data-stu-id="f671b-155">The composition engine can compose directly to the screen back buffer, avoiding the need for an extra copy that is required for per-process composition engines.</span></span>
-   <span data-ttu-id="f671b-156">Todas las aplicaciones comparten un único dispositivo de Direct3D para la composición, lo que ofrece un ahorro de memoria considerable.</span><span class="sxs-lookup"><span data-stu-id="f671b-156">All applications share a single Direct3D device for composition, which offers considerable memory savings</span></span>

<span data-ttu-id="f671b-157">El árbol visual es una estructura retenida.</span><span class="sxs-lookup"><span data-stu-id="f671b-157">The visual tree is a retained structure.</span></span> <span data-ttu-id="f671b-158">La API de DirectComposition expone métodos para editar la estructura en lotes de cambios que se procesan de forma atómica.</span><span class="sxs-lookup"><span data-stu-id="f671b-158">The DirectComposition API exposes methods to edit the structure in batches of changes that are processed atomically.</span></span> <span data-ttu-id="f671b-159">El objeto raíz de la API DirectComposition es el objeto de dispositivo, que actúa como generador para todos los demás objetos DirectComposition y contiene un método denominado [**commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit).</span><span class="sxs-lookup"><span data-stu-id="f671b-159">The root object in the DirectComposition API is the device object, which serves as the factory for all other DirectComposition objects and contains a method called [**Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit).</span></span> <span data-ttu-id="f671b-160">El motor de composición no refleja los cambios que la aplicación realiza en el árbol visual hasta que la aplicación llame a **commit**, momento en el cual todos los cambios desde la última **confirmación** se procesan como una sola transacción.</span><span class="sxs-lookup"><span data-stu-id="f671b-160">The composition engine does not reflect any changes that the application makes to the visual tree until the application calls **Commit**, at which point all changes since the last **Commit** are processed as a single transaction.</span></span>

<span data-ttu-id="f671b-161">El requisito de llamar a [**commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit) es similar al concepto de "Frame", salvo que, dado que el motor de composición se ejecuta de forma asincrónica, puede presentar varios marcos diferentes entre las llamadas a **commit**.</span><span class="sxs-lookup"><span data-stu-id="f671b-161">The requirement to call [**Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit) is similar to the concept of a "frame" except that, because the composition engine runs asynchronously, it can present several different frames between calls to **Commit**.</span></span> <span data-ttu-id="f671b-162">En DirectComposition, un *marco* es una sola iteración del motor de composición y el intervalo empleado por una aplicación entre dos llamadas a **commit** se denomina *lote*.</span><span class="sxs-lookup"><span data-stu-id="f671b-162">In DirectComposition, a *frame* is a single iteration of the composition engine, and the interval spent by an application between two calls to **Commit** is called a *batch*.</span></span>

<span data-ttu-id="f671b-163">DirectComposition procesa por lotes todas las llamadas a la aplicación a la API de DirectComposition.</span><span class="sxs-lookup"><span data-stu-id="f671b-163">DirectComposition batches all application calls to the DirectComposition API.</span></span> <span data-ttu-id="f671b-164">La base de datos de objetos de kernel, que se implementa en el controlador de sesión win32k.sys, almacena toda la información de estado asociada a las llamadas API.</span><span class="sxs-lookup"><span data-stu-id="f671b-164">The kernel object database, which is implemented in the win32k.sys session driver, stores all state information that is associated with the API calls.</span></span>

<span data-ttu-id="f671b-165">El motor de composición produce un fotograma por cada espacio en blanco vertical en la pantalla.</span><span class="sxs-lookup"><span data-stu-id="f671b-165">The composition engine produces one frame for each vertical blank in the display.</span></span> <span data-ttu-id="f671b-166">El marco se inicia en un espacio en blanco vertical y tiene como destino el siguiente espacio en blanco vertical.</span><span class="sxs-lookup"><span data-stu-id="f671b-166">The frame is started at a vertical blank and targets the subsequent vertical blank.</span></span> <span data-ttu-id="f671b-167">Cuando se inicia el fotograma, el motor de composición recoge todos los lotes pendientes e incluye sus comandos en ese marco.</span><span class="sxs-lookup"><span data-stu-id="f671b-167">When the frame starts, the composition engine picks up all pending batches and includes their commands in that frame.</span></span> <span data-ttu-id="f671b-168">Los lotes se colocan en una cola pendiente cuando la aplicación llama a [**commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit)y la cola pendiente se vacía atómicamente al principio del marco.</span><span class="sxs-lookup"><span data-stu-id="f671b-168">Batches are placed in a pending queue when the application calls [**Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit), and the pending queue is flushed atomically at the beginning of the frame.</span></span> <span data-ttu-id="f671b-169">Por lo tanto, hay un único punto en el tiempo que marca el principio de un marco.</span><span class="sxs-lookup"><span data-stu-id="f671b-169">Therefore, there is a single point in time that marks the beginning of a frame.</span></span> <span data-ttu-id="f671b-170">Los lotes enviados antes de este punto se incluyen en el marco, mientras que los lotes enviados después de deben esperar hasta el siguiente fotograma que se va a procesar.</span><span class="sxs-lookup"><span data-stu-id="f671b-170">Any batches submitted before this point are included in the frame, while any batches submitted after must wait until the next frame to be processed.</span></span> <span data-ttu-id="f671b-171">El bucle de composición completo es el siguiente:</span><span class="sxs-lookup"><span data-stu-id="f671b-171">The full composition loop is as follows:</span></span>

1.  <span data-ttu-id="f671b-172">Estima la hora del siguiente espacio en blanco vertical.</span><span class="sxs-lookup"><span data-stu-id="f671b-172">Estimate the time of the next vertical blank.</span></span>
2.  <span data-ttu-id="f671b-173">Recupere todos los lotes pendientes.</span><span class="sxs-lookup"><span data-stu-id="f671b-173">Retrieve all pending batches.</span></span>
3.  <span data-ttu-id="f671b-174">Procesa los lotes recuperados.</span><span class="sxs-lookup"><span data-stu-id="f671b-174">Process the retrieved batches.</span></span>
4.  <span data-ttu-id="f671b-175">Actualice todas las animaciones con el tiempo estimado en el paso 1.</span><span class="sxs-lookup"><span data-stu-id="f671b-175">Update all animations using the time estimated in step 1.</span></span>
5.  <span data-ttu-id="f671b-176">Determine las regiones de la pantalla que deben volver a componerse.</span><span class="sxs-lookup"><span data-stu-id="f671b-176">Determine the regions of the screen that need to be re-composed.</span></span>
6.  <span data-ttu-id="f671b-177">Vuelva a crear las regiones desfasadas.</span><span class="sxs-lookup"><span data-stu-id="f671b-177">Re-compose the dirty regions.</span></span>
7.  <span data-ttu-id="f671b-178">Presente el fotograma volteando los búferes de atrás y front para cada pantalla.</span><span class="sxs-lookup"><span data-stu-id="f671b-178">Present the frame by flipping the back and front buffers for each screen.</span></span>
8.  <span data-ttu-id="f671b-179">Si no se ha compuesto nada y se presentó en los pasos 6 y 7, espere a que se confirme un lote.</span><span class="sxs-lookup"><span data-stu-id="f671b-179">If nothing was composed and presented in steps 6 and 7, wait for a batch to be committed.</span></span>
9.  <span data-ttu-id="f671b-180">Espere al siguiente espacio en blanco vertical.</span><span class="sxs-lookup"><span data-stu-id="f671b-180">Wait for the next vertical blank.</span></span>

<span data-ttu-id="f671b-181">Si hay varios monitores conectados a un único adaptador de vídeo, el motor de composición utiliza el espacio en blanco vertical del monitor principal para controlar el bucle de composición y establecer los tiempos de muestreo de la animación.</span><span class="sxs-lookup"><span data-stu-id="f671b-181">If there are multiple monitors attached to a single video adapter, the composition engine uses the vertical blank of the primary monitor to drive the composition loop and set the animation sampling times.</span></span> <span data-ttu-id="f671b-182">Cada monitor se representa mediante una cadena de volteo de pantalla completa independiente; el motor de composición repite los pasos 6 y 7 para cada monitor, en modo Round-Robin, con un solo dispositivo Direct3D.</span><span class="sxs-lookup"><span data-stu-id="f671b-182">Each monitor is represented by a separate full-screen flip chain; the composition engine repeats steps 6 and 7 for each monitor, in a round-robin fashion, using a single Direct3D device.</span></span> <span data-ttu-id="f671b-183">Si también hay varios adaptadores de vídeo, el motor de composición usa un dispositivo Direct3D independiente para cada adaptador de vídeo en los pasos 6 y 7.</span><span class="sxs-lookup"><span data-stu-id="f671b-183">If there are also multiple video adapters, the composition engine uses a separate Direct3D device for each video adapter in steps 6 and 7.</span></span>

<span data-ttu-id="f671b-184">Los fotogramas de composición están programados para iniciarse siempre en un espacio en blanco vertical, como se muestra en la ilustración siguiente.</span><span class="sxs-lookup"><span data-stu-id="f671b-184">Composition frames are scheduled to always start at a vertical blank, as the following illustration shows.</span></span>

![programación de fotogramas de composición](images/composition-frame-scheduling.png)

<span data-ttu-id="f671b-186">Si el motor de composición no realiza ningún trabajo porque el árbol de composición no ha cambiado, el subproceso de composición entra en suspensión mientras se espera un nuevo lote.</span><span class="sxs-lookup"><span data-stu-id="f671b-186">If the composition engine has no work to do because the composition tree has not changed, the composition thread sleeps while waiting for a new batch.</span></span> <span data-ttu-id="f671b-187">Cuando se envía un nuevo lote, el subproceso de composición se activa, pero vuelve inmediatamente a la suspensión hasta el siguiente espacio en blanco vertical.</span><span class="sxs-lookup"><span data-stu-id="f671b-187">When a new batch is submitted, the composition thread wakes up but immediately goes back to sleep until the next vertical blank.</span></span> <span data-ttu-id="f671b-188">Este comportamiento garantiza horas de inicio y finalización de fotogramas predecibles para las aplicaciones y para el motor de composición.</span><span class="sxs-lookup"><span data-stu-id="f671b-188">This behavior ensures predictable frame start and end times for applications and for the composition engine.</span></span>

<span data-ttu-id="f671b-189">El motor de composición publica los tiempos de presentación de los fotogramas y la velocidad de fotogramas actual.</span><span class="sxs-lookup"><span data-stu-id="f671b-189">The composition engine publishes the frame presentation times and the current frame rate.</span></span> <span data-ttu-id="f671b-190">La publicación de esta información permite a las aplicaciones calcular el tiempo de presentación de sus propios lotes, lo que a su vez permite sincronizar las animaciones.</span><span class="sxs-lookup"><span data-stu-id="f671b-190">Publishing this information enables applications to estimate the presentation time for their own batches, which in turns enables animations to be synchronized.</span></span> <span data-ttu-id="f671b-191">En concreto, una aplicación puede utilizar una combinación de estadísticas de fotogramas del motor de composición y un modelo histórico de cuánto tiempo tarda su subproceso de interfaz de usuario en generar un lote, para determinar el tiempo de muestreo de sus propias animaciones.</span><span class="sxs-lookup"><span data-stu-id="f671b-191">In particular, an application can use a combination of frame statistics from the composition engine, and a historical model of how long its UI thread takes to produce a batch, to determine the sampling time for its own animations.</span></span>

<span data-ttu-id="f671b-192">Por ejemplo, al principio del lote de aplicaciones que se muestra en la ilustración anterior, la aplicación puede consultar el motor de composición para determinar el tiempo exacto de presentación del fotograma siguiente.</span><span class="sxs-lookup"><span data-stu-id="f671b-192">For example, at the beginning of the application batch shown in the previous illustration, the application can query the composition engine to determine the exact presentation time of the next frame.</span></span> <span data-ttu-id="f671b-193">A continuación, la aplicación puede usar la hora actual, junto con información sobre los lotes anteriores que ha generado, para determinar si la aplicación puede completar el lote actual antes del siguiente espacio en blanco vertical.</span><span class="sxs-lookup"><span data-stu-id="f671b-193">The application can then use the current time, along with information about previous batches that it has produced, to determine whether the application can complete the current batch before the next vertical blank.</span></span> <span data-ttu-id="f671b-194">Por lo tanto, la aplicación utiliza el tiempo de presentación del marco como el tiempo de muestreo para sus propias animaciones.</span><span class="sxs-lookup"><span data-stu-id="f671b-194">Therefore, the application uses the frame presentation time as the sampling time for its own animations.</span></span> <span data-ttu-id="f671b-195">Si la aplicación determina que es improbable que complete su trabajo en el espacio en blanco vertical actual, la aplicación puede usar la hora del fotograma posterior como el tiempo de muestreo, usando la información de velocidad de fotogramas devuelta por el motor de composición para calcular ese tiempo.</span><span class="sxs-lookup"><span data-stu-id="f671b-195">If the application determines that it is unlikely to complete its work in the current vertical blank, the application can use the subsequent frame time as the sampling time instead, using the frame rate information returned by the composition engine to compute that time.</span></span>

## <a name="related-topics"></a><span data-ttu-id="f671b-196">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="f671b-196">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="f671b-197">Conceptos de DirectComposition</span><span class="sxs-lookup"><span data-stu-id="f671b-197">DirectComposition Concepts</span></span>](directcomposition-concepts.md)
</dt> </dl>

 

 