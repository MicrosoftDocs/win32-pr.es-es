---
description: En este tema se describe cómo implementar una transformación de Media Foundation compatible con Direct3D (MFT) para vídeo.
ms.assetid: 8ec7e678-8477-41fa-9726-54df5ed187cd
title: Direct3D-Aware MFTs
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ad50438250c0ee1627cc20aebb49262ec8eec9ac
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/07/2021
ms.locfileid: "104539573"
---
# <a name="direct3d-aware-mfts"></a><span data-ttu-id="0d143-103">Direct3D-Aware MFTs</span><span class="sxs-lookup"><span data-stu-id="0d143-103">Direct3D-Aware MFTs</span></span>

<span data-ttu-id="0d143-104">En este tema se describe cómo implementar una transformación de Media Foundation *compatible con Direct3D* (MFT) para vídeo.</span><span class="sxs-lookup"><span data-stu-id="0d143-104">This topic describes how to implement a *Direct3D-aware* Media Foundation transform (MFT) for video.</span></span>

<span data-ttu-id="0d143-105">Un MFT de vídeo se considera *compatible con Direct3D* si puede procesar ejemplos que contienen superficies de Direct3D.</span><span class="sxs-lookup"><span data-stu-id="0d143-105">An video MFT is considered *Direct3D-aware* if it can process samples that contain Direct3D surfaces.</span></span> <span data-ttu-id="0d143-106">La razón típica para admitir Direct3D en un MFT de vídeo es habilitar la descodificación acelerada por hardware mediante la aceleración de vídeo de DirectX (DXVA).</span><span class="sxs-lookup"><span data-stu-id="0d143-106">The typical reason for supporting Direct3D in a video MFT is to enable hardware-accelerated decoding, using DirectX Video Acceleration (DXVA).</span></span>

<span data-ttu-id="0d143-107">En este tema se describen los pasos necesarios para que la MFT sea compatible con Direct3D.</span><span class="sxs-lookup"><span data-stu-id="0d143-107">This topic describes the steps that are required to make your MFT Direct3D-aware.</span></span> <span data-ttu-id="0d143-108">En este tema no se trata la mecánica de la descodificación de DXVA.</span><span class="sxs-lookup"><span data-stu-id="0d143-108">This topic does not cover the mechanics of DXVA decoding.</span></span> <span data-ttu-id="0d143-109">Para obtener información sobre DXVA, consulte [aceleración de vídeo de DirectX 2,0](directx-video-acceleration-2-0.md).</span><span class="sxs-lookup"><span data-stu-id="0d143-109">For information about DXVA, see [DirectX Video Acceleration 2.0](directx-video-acceleration-2-0.md).</span></span>

> [!IMPORTANT]
> <span data-ttu-id="0d143-110">A partir de Windows 8, se puede usar [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) en lugar de [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9).</span><span class="sxs-lookup"><span data-stu-id="0d143-110">Beginning in Windows 8, [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) can be used instead of the [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9).</span></span> <span data-ttu-id="0d143-111">En el caso de las aplicaciones de la tienda Windows, debe usar **IMFDXGIDeviceManager** y Microsoft Direct3D 11.</span><span class="sxs-lookup"><span data-stu-id="0d143-111">For Windows Store apps, you must use **IMFDXGIDeviceManager** and Microsoft Direct3D 11.</span></span> <span data-ttu-id="0d143-112">Para obtener más información, consulte las [API de vídeo de Direct3D 11](direct3d-11-video-apis.md).</span><span class="sxs-lookup"><span data-stu-id="0d143-112">For more info, see the [Direct3D 11 Video APIs](direct3d-11-video-apis.md).</span></span>

 

1.  <span data-ttu-id="0d143-113">Implemente el método [**IMFTransform:: GetAttributes**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes) .</span><span class="sxs-lookup"><span data-stu-id="0d143-113">Implement the [**IMFTransform::GetAttributes**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes) method.</span></span> <span data-ttu-id="0d143-114">Este método devuelve un puntero a un almacén de atributos.</span><span class="sxs-lookup"><span data-stu-id="0d143-114">This method returns a pointer to an attribute store.</span></span>
2.  <span data-ttu-id="0d143-115">El MFT debe establecer el valor del atributo [**MF de la \_ SA \_ \_**](mf-sa-d3d-aware-attribute.md) de la definición de este en **true** en su propio almacén de atributos.</span><span class="sxs-lookup"><span data-stu-id="0d143-115">The MFT must set the value of the [**MF\_SA\_D3D\_AWARE**](mf-sa-d3d-aware-attribute.md) attribute to **TRUE** on its own attribute store.</span></span> <span data-ttu-id="0d143-116">A partir de Windows 8, si usa Direct3D 11, use [MF \_ SA \_ D3D11 \_ ](mf-sa-d3d11-aware.md).</span><span class="sxs-lookup"><span data-stu-id="0d143-116">Beginning in Windows 8, if using Direct3D 11 use [MF\_SA\_D3D11\_AWARE](mf-sa-d3d11-aware.md).</span></span>
3.  <span data-ttu-id="0d143-117">Durante la negociación de formato, si el atributo [**MF \_ SA \_ \_**](mf-sa-d3d-aware-attribute.md) (o [MF \_ SA \_ D3D11 \_ compatible](mf-sa-d3d11-aware.md) con el uso de Direct3D 11) es **true**, el cliente puede enviar el mensaje de [**\_ \_ \_ \_ Administrador de D3D del conjunto de mensajes MFT**](mft-message-set-d3d-manager.md) al MFT.</span><span class="sxs-lookup"><span data-stu-id="0d143-117">During format negotiation, if the [**MF\_SA\_D3D\_AWARE**](mf-sa-d3d-aware-attribute.md) (or [MF\_SA\_D3D11\_AWARE](mf-sa-d3d11-aware.md) if using Direct3D 11) attribute is **TRUE**, the client may send the [**MFT\_MESSAGE\_SET\_D3D\_MANAGER**](mft-message-set-d3d-manager.md) message to the MFT.</span></span> <span data-ttu-id="0d143-118">El parámetro de evento *ulParam* es un puntero a la interfaz [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) .</span><span class="sxs-lookup"><span data-stu-id="0d143-118">The *ulParam* event parameter is a pointer to the [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) interface.</span></span> <span data-ttu-id="0d143-119">A partir de Windows 8, puede usar [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) en lugar de **IDirect3DDeviceManager9**.</span><span class="sxs-lookup"><span data-stu-id="0d143-119">Beginning in Windows 8, you can use [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) instead of **IDirect3DDeviceManager9**.</span></span> <span data-ttu-id="0d143-120">No es necesario que el cliente envíe este mensaje.</span><span class="sxs-lookup"><span data-stu-id="0d143-120">The client is not required to send this message.</span></span>
4.  <span data-ttu-id="0d143-121">La MFT llama a [**IDirect3DDeviceManager9:: GetVideoService**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-getvideoservice) para consultar el servicio DXVA que necesita.</span><span class="sxs-lookup"><span data-stu-id="0d143-121">The MFT calls [**IDirect3DDeviceManager9::GetVideoService**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-getvideoservice) to query for the DXVA service it needs.</span></span> <span data-ttu-id="0d143-122">A partir de Windows 8, si se usó [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) , la MFT llama a [**IMFDXGIDeviceManager:: GetVideoService**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-getvideoservice).</span><span class="sxs-lookup"><span data-stu-id="0d143-122">Beginning in Windows 8, if [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) was used the MFT calls [**IMFDXGIDeviceManager::GetVideoService**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-getvideoservice).</span></span> <span data-ttu-id="0d143-123">Normalmente, un descodificador consultaría [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice)y un procesador de vídeo consultaría [**IDirectXVideoProcessorService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideoprocessorservice).</span><span class="sxs-lookup"><span data-stu-id="0d143-123">Typically a decoder would query for [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice), and a video processor would query for [**IDirectXVideoProcessorService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideoprocessorservice).</span></span>
5.  <span data-ttu-id="0d143-124">Suponiendo que el paso anterior se realiza correctamente, los métodos [**IMFTransform:: GetInputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputavailabletype) y [**IMFTransform:: GetOutputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) deben devolver formatos compatibles con DXVA.</span><span class="sxs-lookup"><span data-stu-id="0d143-124">Assuming the previous step is successful, the [**IMFTransform::GetInputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputavailabletype) and [**IMFTransform::GetOutputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) methods must return DXVA-compatible formats.</span></span>
6.  <span data-ttu-id="0d143-125">El cliente configura los tipos de medios en la MFT.</span><span class="sxs-lookup"><span data-stu-id="0d143-125">The client configures the media types on the MFT.</span></span> <span data-ttu-id="0d143-126">Si un tipo de medio no es compatible con DXVA, el MFT debe devolver el código de error **MF \_ E no \_ compatible \_ \_ tipo D3D**.</span><span class="sxs-lookup"><span data-stu-id="0d143-126">If a media type is not compatible with DXVA, the MFT must return the error code **MF\_E\_UNSUPPORTED\_D3D\_TYPE**.</span></span>
7.  <span data-ttu-id="0d143-127">En este momento, hay dos opciones, dependiendo de si el cliente encuentra un formato DXVA adecuado.</span><span class="sxs-lookup"><span data-stu-id="0d143-127">At this point, there are two options, depending on whether the client finds a suitable DXVA format.</span></span>
    -   <span data-ttu-id="0d143-128">Si el cliente configura correctamente un formato DXVA, puede comenzar el procesamiento.</span><span class="sxs-lookup"><span data-stu-id="0d143-128">If the client successfully configures a DXVA format, it may begin processing.</span></span> <span data-ttu-id="0d143-129">En este momento, la MFT puede usar DXVA para el procesamiento o revertir al procesamiento de software.</span><span class="sxs-lookup"><span data-stu-id="0d143-129">At this point, the MFT can use DXVA for processing, or fall back to software processing.</span></span>
    -   <span data-ttu-id="0d143-130">Como alternativa, si el cliente no encuentra un formato DXVA aceptable, el cliente puede enviar otro mensaje [**de \_ \_ Administrador de \_ D3D \_ de conjunto de mensajes de MFT**](mft-message-set-d3d-manager.md) , esta vez estableciendo *ulParam* en **null**.</span><span class="sxs-lookup"><span data-stu-id="0d143-130">Alternatively, if the client does not find an acceptable DXVA format, the client may send another [**MFT\_MESSAGE\_SET\_D3D\_MANAGER**](mft-message-set-d3d-manager.md) message, this time setting *ulParam* to **NULL**.</span></span> <span data-ttu-id="0d143-131">El MFT debe liberar el puntero [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) (el puntero [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) , si se usó **IMFDXGIDeviceManager** ) y cualquier otra interfaz DXVA, y revertir al procesamiento de software.</span><span class="sxs-lookup"><span data-stu-id="0d143-131">The MFT must release the [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) pointer (the [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) pointer, if **IMFDXGIDeviceManager** was used) and any other DXVA interfaces, and revert to software processing.</span></span> <span data-ttu-id="0d143-132">En este momento, el MFT no debe usar el procesamiento de DXVA.</span><span class="sxs-lookup"><span data-stu-id="0d143-132">At this point, the MFT must not use DXVA processing.</span></span>

<span data-ttu-id="0d143-133">Un MFT compatible con Direct3D debe estar preparado para controlar ejemplos que contienen una superficie de Direct3D.</span><span class="sxs-lookup"><span data-stu-id="0d143-133">A Direct3D-aware MFT must be prepared to handle samples that contain a Direct3D surface.</span></span> <span data-ttu-id="0d143-134">El ejemplo contendrá exactamente un búfer multimedia.</span><span class="sxs-lookup"><span data-stu-id="0d143-134">The sample will contain exactly one media buffer.</span></span> <span data-ttu-id="0d143-135">Para obtener la superficie de Direct3D del búfer, llame a la función [**MFGetService**](/windows/desktop/api/mfidl/nf-mfidl-mfgetservice) y especifique el servicio de **\_ \_ servicio de búfer Mr** .</span><span class="sxs-lookup"><span data-stu-id="0d143-135">To get the Direct3D surface from the buffer, call the [**MFGetService**](/windows/desktop/api/mfidl/nf-mfidl-mfgetservice) function and specify the **MR\_BUFFER\_SERVICE** service.</span></span> <span data-ttu-id="0d143-136">Para obtener más información, consulte [búfer de superficie de DirectX](directx-surface-buffer.md).</span><span class="sxs-lookup"><span data-stu-id="0d143-136">For more information, see [DirectX Surface Buffer](directx-surface-buffer.md).</span></span>

<span data-ttu-id="0d143-137">Un MFT que use DXVA debe asignar sus propios ejemplos de salida, como se indica a continuación:</span><span class="sxs-lookup"><span data-stu-id="0d143-137">An MFT that uses DXVA must allocate its own output samples, as follows:</span></span>

1.  <span data-ttu-id="0d143-138">En el método [**IMFTransform:: GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) , establezca el **flujo de salida de MFT proporciona la marca \_ \_ \_ \_ Samples** .</span><span class="sxs-lookup"><span data-stu-id="0d143-138">In the [**IMFTransform::GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) method, set the **MFT\_OUTPUT\_STREAM\_PROVIDES\_SAMPLES** flag.</span></span>
2.  <span data-ttu-id="0d143-139">Cree un grupo de superficies de DXVA, tal como se describe en la especificación de DXVA.</span><span class="sxs-lookup"><span data-stu-id="0d143-139">Create a pool of DXVA surfaces, as described in the DXVA specification.</span></span>
3.  <span data-ttu-id="0d143-140">Cree ejemplos de medios mediante una llamada a [**MFCreateVideoSampleFromSurface**](/windows/desktop/api/evr/nc-evr-mfcreatevideosamplefromsurface).</span><span class="sxs-lookup"><span data-stu-id="0d143-140">Create media samples by calling [**MFCreateVideoSampleFromSurface**](/windows/desktop/api/evr/nc-evr-mfcreatevideosamplefromsurface).</span></span>

<span data-ttu-id="0d143-141">La MFT siempre debe admitir el procesamiento de software como reserva, ya que es posible que el procesamiento de DXVA no esté disponible por varias razones:</span><span class="sxs-lookup"><span data-stu-id="0d143-141">The MFT should always support software processing as a fallback, because DXVA processing might not available, for several reasons:</span></span>

-   <span data-ttu-id="0d143-142">Es posible que la GPU no admita DXVA.</span><span class="sxs-lookup"><span data-stu-id="0d143-142">The GPU might not support DXVA.</span></span>
-   <span data-ttu-id="0d143-143">Es posible que el cliente no use Direct3D.</span><span class="sxs-lookup"><span data-stu-id="0d143-143">The client might not use Direct3D.</span></span>
-   <span data-ttu-id="0d143-144">Los perfiles de DXVA no se definen para todos los formatos de vídeo.</span><span class="sxs-lookup"><span data-stu-id="0d143-144">DXVA profiles are not defined for every video format.</span></span>

<span data-ttu-id="0d143-145">Un MFT compatible con Direct3D debe tener un único flujo de salida.</span><span class="sxs-lookup"><span data-stu-id="0d143-145">A Direct3D-aware MFT must have a single output stream.</span></span> <span data-ttu-id="0d143-146">No puede tener varias salidas.</span><span class="sxs-lookup"><span data-stu-id="0d143-146">It cannot have multiple outputs.</span></span>

## <a name="related-topics"></a><span data-ttu-id="0d143-147">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="0d143-147">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="0d143-148">Escribir una MFT personalizada</span><span class="sxs-lookup"><span data-stu-id="0d143-148">Writing a Custom MFT</span></span>](writing-a-custom-mft.md)
</dt> </dl>

 

 



