---
description: Obtenga información acerca de cómo proteger los servicios de modo de usuario de antimalware (AM) y cómo puede optar por incluir esta característica en el servicio antimalware.
ms.assetid: 88875a0d-9027-43f2-8411-34f9ff428fe5
title: Protección de los servicios antimalware
ms.topic: article
ms.date: 08/02/2018
ms.openlocfilehash: 5e7783eb307381d368900332b5e761ad62785913
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/08/2021
ms.locfileid: "104083341"
---
# <a name="protecting-anti-malware-services"></a><span data-ttu-id="8c892-103">Protección de los servicios antimalware</span><span class="sxs-lookup"><span data-stu-id="8c892-103">Protecting Anti-Malware Services</span></span>

<span data-ttu-id="8c892-104">Windows 8.1 presentó un nuevo concepto de servicios protegidos para proteger los servicios antimalware, que son un objetivo frecuente de ataques por malware.</span><span class="sxs-lookup"><span data-stu-id="8c892-104">Windows 8.1 introduced a new concept of protected services to protect anti-malware services, which are a frequent target of attack by malware.</span></span>

<span data-ttu-id="8c892-105">Obtenga información acerca de cómo proteger los servicios de modo de usuario de antimalware (AM) y cómo puede optar por incluir esta característica en el servicio antimalware.</span><span class="sxs-lookup"><span data-stu-id="8c892-105">Learn about protecting anti-malware (AM) user mode services and how you can opt to include this feature in your anti-malware service.</span></span>

<span data-ttu-id="8c892-106">Esta información se aplica a los siguientes sistemas operativos y sus sucesores:</span><span class="sxs-lookup"><span data-stu-id="8c892-106">This information applies to the following operating systems and their successors:</span></span>

-   <span data-ttu-id="8c892-107">Windows 8.1</span><span class="sxs-lookup"><span data-stu-id="8c892-107">Windows 8.1</span></span>
-   <span data-ttu-id="8c892-108">Windows Server 2012 R2</span><span class="sxs-lookup"><span data-stu-id="8c892-108">Windows Server 2012 R2</span></span>

<span data-ttu-id="8c892-109">Las referencias y los recursos que se describen aquí se enumeran al final de este tema.</span><span class="sxs-lookup"><span data-stu-id="8c892-109">References and resources discussed here are listed at the end of this topic.</span></span>

## <a name="introduction"></a><span data-ttu-id="8c892-110">Introducción</span><span class="sxs-lookup"><span data-stu-id="8c892-110">Introduction</span></span>

<span data-ttu-id="8c892-111">La mayoría de las soluciones antimalware incluyen un servicio de modo de usuario que realiza operaciones especializadas para detectar y quitar malware del sistema.</span><span class="sxs-lookup"><span data-stu-id="8c892-111">Most anti-malware solutions include a user-mode service that performs specialized operations to detect and remove malware from the system.</span></span> <span data-ttu-id="8c892-112">Este servicio de modo de usuario también es responsable de descargar las últimas definiciones de virus y firmas.</span><span class="sxs-lookup"><span data-stu-id="8c892-112">This user-mode service is also frequently responsible for downloading the latest virus definitions and signatures.</span></span> <span data-ttu-id="8c892-113">Este servicio de modo de usuario se convierte en un objetivo frecuente de malware porque es el único punto de error en la deshabilitación de la protección en un sistema.</span><span class="sxs-lookup"><span data-stu-id="8c892-113">This user-mode service becomes a frequent target of malware because it’s the single point of failure to disable protection on a system.</span></span> <span data-ttu-id="8c892-114">Para defenderse contra los ataques en el servicio de modo de usuario, los proveedores de protección contra malware tienen que agregar una gran cantidad de funcionalidad e heurística a su software.</span><span class="sxs-lookup"><span data-stu-id="8c892-114">To defend against attacks on the user-mode service, anti-malware vendors have to add a lot of functionality and heuristics to their software.</span></span> <span data-ttu-id="8c892-115">Sin embargo, estas técnicas no son completamente infalibles y tienden a ser propensas a errores porque tienen que identificar la funcionalidad que Windows realiza en su servicio y habilitar selectivamente esa funcionalidad.</span><span class="sxs-lookup"><span data-stu-id="8c892-115">However, such techniques are not completely foolproof and tend to be error prone because they have to identify functionality that Windows performs on their service and selectively enable that functionality.</span></span>

<span data-ttu-id="8c892-116">En Windows 8.1, se ha introducido un nuevo concepto de servicio protegido para permitir que los servicios de modo de usuario antimalware se inicien como un servicio protegido.</span><span class="sxs-lookup"><span data-stu-id="8c892-116">In Windows 8.1, a new concept of protected service has been introduced to allow anti-malware user-mode services to be launched as a protected service.</span></span> <span data-ttu-id="8c892-117">Una vez que el servicio se inicia como protegido, Windows usa la integridad del código para permitir que solo se cargue el código de confianza en el servicio protegido.</span><span class="sxs-lookup"><span data-stu-id="8c892-117">After the service is launched as protected, Windows uses code integrity to only allow trusted code to load into the protected service.</span></span> <span data-ttu-id="8c892-118">Windows también protege estos procesos de la inyección de código y otros ataques desde los procesos de administración.</span><span class="sxs-lookup"><span data-stu-id="8c892-118">Windows also protects these processes from code injection and other attacks from admin processes.</span></span>

<span data-ttu-id="8c892-119">En este documento se describe el modo en que un proveedor de protección contra malware con un controlador antimalware de inicio temprano (ELAM) puede participar en esta característica e iniciar su servicio antimalware como un servicio protegido.</span><span class="sxs-lookup"><span data-stu-id="8c892-119">This document describes how an anti-malware vendor with an Early Launch Anti-Malware (ELAM) driver can opt-in to this feature and launch their anti-malware service as a protected service.</span></span>

## <a name="system-protected-process"></a><span data-ttu-id="8c892-120">Proceso protegido por el sistema</span><span class="sxs-lookup"><span data-stu-id="8c892-120">System protected process</span></span>

<span data-ttu-id="8c892-121">A partir de Windows 8.1, se ha puesto en marcha un nuevo modelo de seguridad en el kernel para defenderse mejor contra ataques malintencionados en componentes críticos del sistema.</span><span class="sxs-lookup"><span data-stu-id="8c892-121">Starting with Windows 8.1, a new security model has been put in place in the kernel to better defend against malicious attacks on system-critical components.</span></span> <span data-ttu-id="8c892-122">Este nuevo modelo de seguridad amplía la infraestructura de procesos protegidos versiones anteriores de Windows que se usan para escenarios específicos, como la reproducción de contenido DRM, en un modelo de uso general que pueden usar los proveedores de software antimalware de terceros.</span><span class="sxs-lookup"><span data-stu-id="8c892-122">This new security model extends the protected process infrastructure previous versions of Windows used for specific scenarios, such as playing DRM content, into a general-purpose model that can be used by 3rd party anti-malware vendors.</span></span> <span data-ttu-id="8c892-123">La infraestructura de procesos protegidos solo permite la carga de código de confianza y firmado, y tiene defensa integrada frente a los ataques por inyección de código.</span><span class="sxs-lookup"><span data-stu-id="8c892-123">The protected process infrastructure only allows trusted, signed code to load and has built-in defense against code injection attacks.</span></span>

<span data-ttu-id="8c892-124">Vea [procesos protegidos en Windows Vista](https://download.microsoft.com/download/a/f/7/af7777e5-7dcd-4800-8a0a-b18336565f5b/process_vista.doc) para obtener más información sobre los procesos protegidos.</span><span class="sxs-lookup"><span data-stu-id="8c892-124">See [Protected Processes in Windows Vista](https://download.microsoft.com/download/a/f/7/af7777e5-7dcd-4800-8a0a-b18336565f5b/process_vista.doc) for more information on protected processes.</span></span>

<span data-ttu-id="8c892-125">El nuevo modelo de seguridad usa una variante ligeramente diferente de la infraestructura de proceso de protección denominada proceso protegido por el sistema, que es más adecuada para esta característica, ya que mantiene el contenido DRM separado.</span><span class="sxs-lookup"><span data-stu-id="8c892-125">The new security model uses a slightly different variant of the protection process infrastructure called system protected process, which is more suitable for this feature as this keeps the DRM content separate.</span></span> <span data-ttu-id="8c892-126">Cada proceso protegido por el sistema tiene un nivel o atributo asociado, que indica la Directiva de firma del código firmado que se permite cargar en el proceso.</span><span class="sxs-lookup"><span data-stu-id="8c892-126">Each system protected process has an associated level or attribute, which indicates the signature policy of the signed code allowed to load within the process.</span></span> <span data-ttu-id="8c892-127">Una vez que los servicios antimalware han optado por el modo de servicio protegido, solo se permite cargar en ese proceso el código firmado de Windows o el código firmado con los certificados del proveedor de antimalware.</span><span class="sxs-lookup"><span data-stu-id="8c892-127">After the anti-malware services have opted into the protected service mode, only Windows signed code or code signed with the anti-malware vendor’s certificates are allowed to load in that process.</span></span> <span data-ttu-id="8c892-128">Del mismo modo, otros niveles de proceso protegidos tienen directivas de código diferentes aplicadas por Windows.</span><span class="sxs-lookup"><span data-stu-id="8c892-128">Similarly, other protected process levels have different code policies enforced by Windows.</span></span>

## <a name="requirements"></a><span data-ttu-id="8c892-129">Requisitos</span><span class="sxs-lookup"><span data-stu-id="8c892-129">Requirements</span></span>

<span data-ttu-id="8c892-130">Para que un servicio de modo de usuario antimalware se ejecute como un servicio protegido, el proveedor de protección contra malware debe tener un controlador ELAM instalado en la máquina Windows.</span><span class="sxs-lookup"><span data-stu-id="8c892-130">For an anti-malware user-mode service to run as a protected service, the anti-malware vendor must have an ELAM driver installed on the Windows machine.</span></span> <span data-ttu-id="8c892-131">Además de los requisitos de certificación existentes del controlador ELAM, el controlador debe tener una sección de recursos incrustados que contenga la información de los certificados utilizados para firmar los archivos binarios del servicio de modo de usuario.</span><span class="sxs-lookup"><span data-stu-id="8c892-131">In addition to the existing ELAM driver certification requirements, the driver must have an embedded resource section containing the information of the certificates used to sign the user mode service binaries.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="8c892-132">En Windows 8.1, la cadena de certificación debe ser una raíz conocida determinada por la comprobación del controlador, o bien se debe incluir el certificado raíz.</span><span class="sxs-lookup"><span data-stu-id="8c892-132">In Windows 8.1, the certification chain either has to be a known root as determined by driver verification, or the root certificate must be included.</span></span>

 

<span data-ttu-id="8c892-133">Durante el proceso de arranque, esta sección de recursos se extraerá del controlador ELAM para validar la información del certificado y registrar el servicio antimalware.</span><span class="sxs-lookup"><span data-stu-id="8c892-133">During the boot process, this resource section will be extracted from the ELAM driver to validate the certificate information and register the anti-malware service.</span></span> <span data-ttu-id="8c892-134">El servicio antimalware también puede registrarse durante el proceso de instalación del software antimalware mediante una llamada a una API especial, como se describe más adelante en este documento.</span><span class="sxs-lookup"><span data-stu-id="8c892-134">The anti-malware service can also be registered during the anti-malware software installation process by calling a special API, as described later in this document.</span></span>

<span data-ttu-id="8c892-135">Una vez que la sección de recursos se extrae correctamente del controlador ELAM y el servicio de modo de usuario está registrado, el servicio puede iniciarse como servicio protegido.</span><span class="sxs-lookup"><span data-stu-id="8c892-135">After the resource section is successfully extracted from the ELAM driver and the user-mode service is registered, the service is allowed to launch as protected service.</span></span> <span data-ttu-id="8c892-136">Una vez que el servicio se inicia como protegido, otros procesos no protegidos del sistema no podrán inyectar subprocesos y no se les permitirá escribir en la memoria virtual del proceso protegido.</span><span class="sxs-lookup"><span data-stu-id="8c892-136">After the service is launched as protected, other non-protected processes on the system won't be able to inject threads, and they wont' be allowed to write into the virtual memory of the protected process.</span></span>

<span data-ttu-id="8c892-137">Además, cualquier dll que no sea de Windows que se cargue en el proceso protegido debe estar firmado con un certificado adecuado.</span><span class="sxs-lookup"><span data-stu-id="8c892-137">In addition, any non-Windows DLLs that get loaded into the protected process must be signed with an appropriate certificate.</span></span>

<span data-ttu-id="8c892-138">Vea [antimalware de inicio temprano](/windows/desktop/w8cookbook/secured-boot) para obtener más información sobre los controladores de Elam.</span><span class="sxs-lookup"><span data-stu-id="8c892-138">See [Early launch antimalware](/windows/desktop/w8cookbook/secured-boot) for more information on ELAM drivers.</span></span>

### <a name="anti-malware-service-signing-requirements"></a><span data-ttu-id="8c892-139">Requisitos de firma del servicio antimalware</span><span class="sxs-lookup"><span data-stu-id="8c892-139">Anti-malware service signing requirements</span></span>

<span data-ttu-id="8c892-140">El servicio de modo de usuario que debe iniciarse como protegido debe estar firmado con certificados válidos.</span><span class="sxs-lookup"><span data-stu-id="8c892-140">The user-mode service that needs to be launched as protected must be signed with valid certificates.</span></span> <span data-ttu-id="8c892-141">El archivo EXE del servicio debe tener la firma de hash de página y cualquier dll que no sea de Windows que se cargue en el servicio también debe estar firmado con los mismos certificados.</span><span class="sxs-lookup"><span data-stu-id="8c892-141">The service EXE must be page hash signed, and any non-Windows DLLs that get loaded into the service must be also signed with the same certificates.</span></span> <span data-ttu-id="8c892-142">El hash de estos certificados se debe agregar al archivo de recursos, que se vinculará al controlador ELAM.</span><span class="sxs-lookup"><span data-stu-id="8c892-142">The hash of these certificates must be added into the resource file, which will be linked into the ELAM driver.</span></span>

> [!Note]  
> <span data-ttu-id="8c892-143">Los hashes de archivo o página SHA256 deben usarse, aunque los certificados pueden seguir siendo SHA1.</span><span class="sxs-lookup"><span data-stu-id="8c892-143">SHA256 file/page hashes must be used, though certificates may continue to be SHA1.</span></span>

 

### <a name="primary-signature-recommended"></a><span data-ttu-id="8c892-144">Firma principal (recomendado)</span><span class="sxs-lookup"><span data-stu-id="8c892-144">Primary signature (recommended)</span></span>

<span data-ttu-id="8c892-145">Se recomienda que los proveedores de protección contra malware utilicen su certificado Authenticode existente para firmar sus archivos binarios del servicio antimalware y que el hash de este certificado Authenticode se incluya en la sección de recursos para indicar el certificado que se usa para firmar los archivos binarios del servicio.</span><span class="sxs-lookup"><span data-stu-id="8c892-145">We recommend that anti-malware vendors use their existing Authenticode certificate to sign their anti-malware service binaries, and that the hash of this Authenticode certificate be included in the resource section to indicate the certificate that's used to sign the service binaries.</span></span> <span data-ttu-id="8c892-146">Si actualiza este certificado, se debe liberar una versión más reciente del controlador ELAM con los hash de certificado actualizados.</span><span class="sxs-lookup"><span data-stu-id="8c892-146">If you update this certificate, a newer version of the ELAM driver must be released with the updated certificate hashes.</span></span>

### <a name="secondary-signature-optional"></a><span data-ttu-id="8c892-147">Firma secundaria (opcional)</span><span class="sxs-lookup"><span data-stu-id="8c892-147">Secondary signature (optional)</span></span>

<span data-ttu-id="8c892-148">Los proveedores de protección contra malware tienen la opción de configurar una CA privada y usar certificados de esta CA para firmar el código de los binarios del servicio antimalware como una firma secundaria.</span><span class="sxs-lookup"><span data-stu-id="8c892-148">Anti-malware vendors have the option to set up a private CA and use certificates from this CA to code sign the anti-malware service binaries as a secondary signature.</span></span> <span data-ttu-id="8c892-149">La principal ventaja de utilizar la entidad de certificación privada es que permite a los proveedores crear certificados con una propiedad de EKU especializada, que se puede utilizar para diferenciar entre varios productos del mismo proveedor.</span><span class="sxs-lookup"><span data-stu-id="8c892-149">The main advantage of using the private CA is that it enables vendors to create certificates with a specialized EKU property, which can be used to differentiate between multiple products from the same vendor.</span></span> <span data-ttu-id="8c892-150">También reduce la necesidad de actualizar el controlador de ELAM debido a la expiración del certificado, ya que los certificados de la entidad de certificación privada normalmente tienen fechas de expiración más largas.</span><span class="sxs-lookup"><span data-stu-id="8c892-150">It also reduces the need to update your ELAM driver due to certificate expiry, as the private CA certs typically have longer expiry dates.</span></span>

<span data-ttu-id="8c892-151">Tenga en cuenta que si los archivos binarios de servicio están firmados con certificados de entidad de certificación privados, los archivos binarios también deben estar firmados con dos certificados de Authenticode.</span><span class="sxs-lookup"><span data-stu-id="8c892-151">Note that if the service binaries are signed with the private CA certs, the binaries must also be dual signed with the existing Authenticode certificates.</span></span> <span data-ttu-id="8c892-152">Si los archivos binarios no están firmados por una CA de confianza conocida (por ejemplo, VeriSign), el usuario del equipo no tiene confianza en los archivos binarios porque no pueden confiar en la CA privada.</span><span class="sxs-lookup"><span data-stu-id="8c892-152">If the binaries are not signed by a well-known trusted CA (for example VeriSign), the user of the machine has no confidence in the binaries because they cannot trust the private CA.</span></span> <span data-ttu-id="8c892-153">La firma doble de los binarios con el certificado Authenticode existente también permite que los archivos binarios se ejecuten en sistemas operativos de nivel inferior.</span><span class="sxs-lookup"><span data-stu-id="8c892-153">Dual signing the binaries with the existing Authenticode certificate also allows the binaries to run on down-level operating systems.</span></span>

<span data-ttu-id="8c892-154">Para obtener más información sobre cómo configurar e instalar la entidad de certificación, consulte [configuración de una entidad](/previous-versions/windows/desktop/ms755466(v=vs.85)) de [certificación e instalación de la entidad de certificación](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj125375(v=ws.11)).</span><span class="sxs-lookup"><span data-stu-id="8c892-154">For more info about how to set up and install the Certificate Authority, see [Setting Up a Certificate Authority](/previous-versions/windows/desktop/ms755466(v=vs.85)) and [Install the Certification Authority](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj125375(v=ws.11)).</span></span>

> [!Note]  
> <span data-ttu-id="8c892-155">Por compatibilidad con Windows Vista o Windows XP (o Windows 7 sin la revisión SHA2), puede usar el modificador "/as" al firmar los archivos binarios con [SignTool.exe](/windows/desktop/SecCrypto/signtool) con los hashes de página o archivo SHA256.</span><span class="sxs-lookup"><span data-stu-id="8c892-155">For compatibility with Windows Vista or Windows XP (or Windows 7 without the SHA2 patch), you can use the "/as" switch when signing your binaries with [SignTool.exe](/windows/desktop/SecCrypto/signtool) with the SHA256 file/page hashes.</span></span> <span data-ttu-id="8c892-156">Esto agregará la firma como una firma secundaria al archivo.</span><span class="sxs-lookup"><span data-stu-id="8c892-156">This will add the signature as a secondary signature to the file.</span></span> <span data-ttu-id="8c892-157">SHA1 firme primero el archivo, ya que Windows XP, Windows Vista y Windows 7 solo verán la primera firma.</span><span class="sxs-lookup"><span data-stu-id="8c892-157">SHA1 sign the file first, since Windows XP, Windows Vista, and Windows 7 will only see the first signature.</span></span>

 

### <a name="dll-signing-requirements"></a><span data-ttu-id="8c892-158">Requisitos de firma de DLL</span><span class="sxs-lookup"><span data-stu-id="8c892-158">DLL signing requirements</span></span>

<span data-ttu-id="8c892-159">Como se mencionó anteriormente, todos los archivos DLL que no sean de Windows que se carguen en el servicio protegido deben estar firmados con el mismo certificado que se usó para firmar el servicio antimalware.</span><span class="sxs-lookup"><span data-stu-id="8c892-159">As mentioned earlier, any non-Windows DLLs that get loaded into the protected service must be signed with the same certificate that was used to sign the anti-malware service.</span></span>

### <a name="catalog-signing"></a><span data-ttu-id="8c892-160">Firma de catálogos</span><span class="sxs-lookup"><span data-stu-id="8c892-160">Catalog Signing</span></span>

<span data-ttu-id="8c892-161">Los proveedores de protección contra malware pueden incluir paquetes desarrollados por otras compañías sin actualizar las firmas binarias.</span><span class="sxs-lookup"><span data-stu-id="8c892-161">Anti-malware vendors can include packages developed by other companies without updating the binary signatures.</span></span> <span data-ttu-id="8c892-162">Esto puede lograrse incluyendo los archivos binarios en un catálogo que está firmado con su certificado Authenticode, para lo que debe seguir estos pasos:</span><span class="sxs-lookup"><span data-stu-id="8c892-162">This can be achieved by including the binaries in a catalog which is signed with their Authenticode certificate, accomplished by following these steps:</span></span>

1. <span data-ttu-id="8c892-163">Generación de un catálogo mediante [MakeCat](/windows/desktop/SecCrypto/makecat)</span><span class="sxs-lookup"><span data-stu-id="8c892-163">Generate a catalog using [MakeCat](/windows/desktop/SecCrypto/makecat)</span></span>
2. <span data-ttu-id="8c892-164">Agregar todos los archivos binarios sin una firma adecuada al catálogo</span><span class="sxs-lookup"><span data-stu-id="8c892-164">Add all of the binaries without an appropriate signature to the catalog</span></span>
3. <span data-ttu-id="8c892-165">Firmar el catálogo con el certificado Authenticode, como haría con cualquier otro archivo binario</span><span class="sxs-lookup"><span data-stu-id="8c892-165">Sign the catalog with the Authenticode certificate, as you would any other binary</span></span>
4. <span data-ttu-id="8c892-166">Utilice la función [Agregar Catálogo](/windows/desktop/api/Mscat/nf-mscat-cryptcatadminaddcatalog) para incluir el catálogo con la aplicación.</span><span class="sxs-lookup"><span data-stu-id="8c892-166">Use the [add catalog](/windows/desktop/api/Mscat/nf-mscat-cryptcatadminaddcatalog) function to include the catalog with the application.</span></span>

<span data-ttu-id="8c892-167">Cuando la integridad del código se encuentra entre los paquetes sin una firma adecuada, buscará un catálogo con una firma aprobada.</span><span class="sxs-lookup"><span data-stu-id="8c892-167">When code integrity comes across the packages without an appropriate signature, it will search for a catalog with an approved signature.</span></span> <span data-ttu-id="8c892-168">Encontrará este catálogo siempre y cuando se sigan estos pasos y se instale con la aplicación.</span><span class="sxs-lookup"><span data-stu-id="8c892-168">It will find this catalog as long as these steps are followed and it is installed with the application.</span></span>


## <a name="resource-file-info"></a><span data-ttu-id="8c892-169">Información del archivo de recursos</span><span class="sxs-lookup"><span data-stu-id="8c892-169">Resource file info</span></span>

<span data-ttu-id="8c892-170">Debe crearse un archivo de recursos y vincularse al controlador ELAM.</span><span class="sxs-lookup"><span data-stu-id="8c892-170">A resource file must be created and linked into the ELAM driver.</span></span> <span data-ttu-id="8c892-171">El hash del certificado, junto con otra información del certificado, se debe agregar en el archivo de recursos.</span><span class="sxs-lookup"><span data-stu-id="8c892-171">The hash of the certificate, along with other certificate information, must be added in the resource file.</span></span>

<span data-ttu-id="8c892-172">La sección de recursos debe estar en el diseño siguiente para que el sistema Extraiga correctamente los recursos de la imagen binaria y valide la información del certificado insertado.</span><span class="sxs-lookup"><span data-stu-id="8c892-172">The resource section must be in the following layout for the system to successfully extract the resources from the binary image and validate the embedded certificate information.</span></span>

``` syntax
MicrosoftElamCertificateInfo  MSElamCertInfoID
{
      3, // count of entries
      L”CertHash1\0”,
      Algorithm,
      L”EKU1\0”,
      L”CertHash2\0”,
      Algorithm,
      L”\0”, //No EKU for cert hash 2
      L”CertHash3\0”,
      Algorithm,
      L”EKU3a;EKU3b;EKU3c\0”,  //multiple EKU entries supported (max: 3)
}
```

<span data-ttu-id="8c892-173">Para obtener más información sobre el archivo de recursos definido por el usuario, consulte [recurso definido por el usuario](/windows/desktop/menurc/user-defined-resource).</span><span class="sxs-lookup"><span data-stu-id="8c892-173">For more info about user-defined resource file, see [User-Defined Resource](/windows/desktop/menurc/user-defined-resource).</span></span>

### <a name="certhash"></a><span data-ttu-id="8c892-174">CertHash</span><span class="sxs-lookup"><span data-stu-id="8c892-174">CertHash</span></span>

<span data-ttu-id="8c892-175">El hash del certificado que se usa para firmar el servicio antimalware.</span><span class="sxs-lookup"><span data-stu-id="8c892-175">The hash of the certificate that's used to sign the anti-malware service.</span></span> <span data-ttu-id="8c892-176">La herramienta CertMgr.exe, que se incluye en el Windows SDK, se puede utilizar para obtener el hash.</span><span class="sxs-lookup"><span data-stu-id="8c892-176">The CertMgr.exe tool, which ships in the Windows SDK, can be used to obtain the hash.</span></span>

``` syntax
certmgr.exe –v <path to the signed file>
```

<span data-ttu-id="8c892-177">Por ejemplo:</span><span class="sxs-lookup"><span data-stu-id="8c892-177">For example:</span></span>

![hash de certificado de servicio protegido contra malware (certhash)](images/cert-hash-example.png)

### <a name="algorithm"></a><span data-ttu-id="8c892-179">Algoritmo</span><span class="sxs-lookup"><span data-stu-id="8c892-179">Algorithm</span></span>

<span data-ttu-id="8c892-180">El valor del algoritmo representa el algoritmo del certificado.</span><span class="sxs-lookup"><span data-stu-id="8c892-180">The algorithm value represents the algorithm of the certificate.</span></span> <span data-ttu-id="8c892-181">Se admiten estos valores de algoritmo:</span><span class="sxs-lookup"><span data-stu-id="8c892-181">These algorithm values are supported:</span></span>

<dl> <span data-ttu-id="8c892-182">0x8004: SHA1</span><span class="sxs-lookup"><span data-stu-id="8c892-182">0x8004 – SHA1</span></span>  
<span data-ttu-id="8c892-183">0x800c – SHA256</span><span class="sxs-lookup"><span data-stu-id="8c892-183">0x800c – SHA256</span></span>  
<span data-ttu-id="8c892-184">0X800d: SHA384</span><span class="sxs-lookup"><span data-stu-id="8c892-184">0X800d – SHA384</span></span>  
<span data-ttu-id="8c892-185">0x800e: SHA512</span><span class="sxs-lookup"><span data-stu-id="8c892-185">0x800e – SHA512</span></span>  
</dl>

<span data-ttu-id="8c892-186">No olvide incluir el valor del algoritmo (como se mostró anteriormente) y no el nombre real del algoritmo.</span><span class="sxs-lookup"><span data-stu-id="8c892-186">Remember to include the value of the algorithm (as shown above) and not the actual name of the algorithm.</span></span> <span data-ttu-id="8c892-187">Por ejemplo, si el certificado se basa en el algoritmo SHA256, incluya 0x800c en la sección de recursos.</span><span class="sxs-lookup"><span data-stu-id="8c892-187">For example, if the cert is based on the SHA256 algorithm, include 0x800c in the resource section.</span></span>

### <a name="eku"></a><span data-ttu-id="8c892-188">EKU</span><span class="sxs-lookup"><span data-stu-id="8c892-188">EKU</span></span>

<span data-ttu-id="8c892-189">El objeto EKU representa una única propiedad de uso de clave extendida (EKU) de un certificado.</span><span class="sxs-lookup"><span data-stu-id="8c892-189">The EKU object represents a single extended key usage (EKU) property of a certificate.</span></span> <span data-ttu-id="8c892-190">Esto es opcional y \\ se debe especificar "0" si no hay EKU asociados al certificado. En el caso de que haya varios productos y servicios de un solo proveedor de antimalware que se ejecute en el mismo sistema, el proveedor de antimalware puede usar la propiedad EKU del certificado de entidad de certificación privada para diferenciar un servicio de otro.</span><span class="sxs-lookup"><span data-stu-id="8c892-190">This is optional and “\\0” should be specified if no EKUs are associated with the cert. In a case where there are multiple products and services from a single anti-malware vendor running on the same system, the anti-malware vendor can use the EKU property of the private CA certificate to differentiate one service from another.</span></span> <span data-ttu-id="8c892-191">Por ejemplo, si hay dos servicios que se ejecutan en el sistema desde el mismo proveedor de protección contra malware y están firmados por la misma CA, el servicio que debe iniciarse como protegido puede firmarse con un certificado emitido por una CA que contenga un EKU especial.</span><span class="sxs-lookup"><span data-stu-id="8c892-191">For example, if there are two services running on the system from the same anti-malware vendor and signed by the same CA, the service that needs to be launched as protected can be signed with a cert issued by CA that contains a special EKU.</span></span> <span data-ttu-id="8c892-192">Este EKU debe agregarse a la sección de recursos.</span><span class="sxs-lookup"><span data-stu-id="8c892-192">This EKU must be added to the resource section.</span></span> <span data-ttu-id="8c892-193">Después, el sistema registra el EKU y se empareja con el hash del certificado para validar e iniciar el servicio como protegido.</span><span class="sxs-lookup"><span data-stu-id="8c892-193">The EKU is then registered by the system and paired with the certificate hash for validating and launching the service as protected.</span></span>

<span data-ttu-id="8c892-194">Tenga en cuenta que la cadena de certificados debe incluir el EKU de firma de código (1.3.6.1.5.5.7.3.3), pero este EKU no debe incluirse en la sección de recursos del controlador ELAM.</span><span class="sxs-lookup"><span data-stu-id="8c892-194">Note that the certificate chain must include the Code Signing EKU (1.3.6.1.5.5.7.3.3), but this EKU must not be included in the resource section of the ELAM driver.</span></span>

> [!Note]  
> <span data-ttu-id="8c892-195">Si se incluye información de EKU en la información del certificado para el controlador ELAM, se debe usar el mismo EKU al firmar los archivos binarios.</span><span class="sxs-lookup"><span data-stu-id="8c892-195">If EKU information is included in certificate information for the ELAM driver, then the same EKU must be used when signing your binaries.</span></span>

 

### <a name="count"></a><span data-ttu-id="8c892-196">Count</span><span class="sxs-lookup"><span data-stu-id="8c892-196">Count</span></span>

<span data-ttu-id="8c892-197">Si el binario del servicio antimalware está firmado con el certificado Authenticode y el certificado de entidad de certificación privada, solo se debe agregar la información del certificado de entidad de certificación privada en la sección de recursos.</span><span class="sxs-lookup"><span data-stu-id="8c892-197">If the anti-malware service binary is signed with the Authenticode certificate as well as the private CA certificate, only the private CA certificate information must be added in the resource section.</span></span>

## <a name="launching-anti-malware-services-as-protected"></a><span data-ttu-id="8c892-198">Inicio de servicios antimalware protegidos</span><span class="sxs-lookup"><span data-stu-id="8c892-198">Launching anti-malware services as protected</span></span>

### <a name="registering-the-service"></a><span data-ttu-id="8c892-199">Registrar el servicio</span><span class="sxs-lookup"><span data-stu-id="8c892-199">Registering the service</span></span>

<span data-ttu-id="8c892-200">El servicio antimalware debe estar registrado con el sistema para que se pueda iniciar como protegido.</span><span class="sxs-lookup"><span data-stu-id="8c892-200">The anti-malware service must be registered with the system before it can be started as protected.</span></span> <span data-ttu-id="8c892-201">Durante la instalación del software antimalware, el instalador puede instalar el controlador ELAM y reiniciar el sistema para registrar automáticamente el servicio.</span><span class="sxs-lookup"><span data-stu-id="8c892-201">During the installation of the anti-malware software, the installer can install the ELAM driver and reboot the system to automatically register the service.</span></span> <span data-ttu-id="8c892-202">El sistema registrará el servicio en el momento del arranque mediante la extracción de la información del certificado del archivo de recursos mencionado anteriormente que está vinculado al controlador ELAM.</span><span class="sxs-lookup"><span data-stu-id="8c892-202">The system will register the service at boot time by extracting the certificate information from the aforementioned resource file that is linked into the ELAM driver.</span></span>

<span data-ttu-id="8c892-203">Durante la fase de instalación, se recomienda encarecidamente reiniciar el sistema para que se cargue el controlador ELAM y se valide el estado del sistema.</span><span class="sxs-lookup"><span data-stu-id="8c892-203">During the installation phase, it is highly recommended that the system is restarted in order for the ELAM driver to get loaded and validate the state of the system.</span></span> <span data-ttu-id="8c892-204">Sin embargo, para los casos en los que se debe evitar un reinicio, Windows también expone un mecanismo para que el instalador antimalware registre el servicio como protegido mediante una API.</span><span class="sxs-lookup"><span data-stu-id="8c892-204">However, for cases where a reboot must be avoided, Windows also exposes a mechanism for the anti-malware installer to register the service as protected using an API.</span></span>

### <a name="registering-the-service-without-rebooting-the-system"></a><span data-ttu-id="8c892-205">Registro del servicio sin reiniciar el sistema</span><span class="sxs-lookup"><span data-stu-id="8c892-205">Registering the service without rebooting the system</span></span>

<span data-ttu-id="8c892-206">Durante la instalación, un instalador de software antimalware puede llamar a la API [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo) y proporcionar un identificador al archivo del controlador Elam.</span><span class="sxs-lookup"><span data-stu-id="8c892-206">During the installation, an anti-malware software installer can call the [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo) API and provide a handle to the ELAM driver file.</span></span> <span data-ttu-id="8c892-207">El sistema abre el controlador ELAM, llama a las rutinas internas para asegurarse de que el controlador ELAM está firmado correctamente y extrae la información del certificado de la sección de recursos asociada al controlador ELAM.</span><span class="sxs-lookup"><span data-stu-id="8c892-207">The system opens the ELAM driver, calls internal routines to make sure the ELAM driver is signed properly, and extracts the certificate information from the resource section associated with the ELAM driver.</span></span> <span data-ttu-id="8c892-208">Para ver la sintaxis de la función, vea [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo).</span><span class="sxs-lookup"><span data-stu-id="8c892-208">For function syntax see [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo).</span></span>

<span data-ttu-id="8c892-209">Ejemplo de código:</span><span class="sxs-lookup"><span data-stu-id="8c892-209">Code example:</span></span>


```C++
HANDLE FileHandle = NULL;

FileHandle = CreateFile(<Insert Elam driver file name>,
                        FILE_READ_DATA,
                        FILE_SHARE_READ,
                        NULL,
                        OPEN_EXISTING,
                        FILE_ATTRIBUTE_NORMAL,
                        NULL
                        );

if (InstallElamCertificateInfo(FileHandle) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}
```



### <a name="starting-the-service-as-protected"></a><span data-ttu-id="8c892-210">Iniciar el servicio como protegido</span><span class="sxs-lookup"><span data-stu-id="8c892-210">Starting the service as protected</span></span>

<span data-ttu-id="8c892-211">El instalador puede seguir estos pasos para crear, configurar e iniciar el servicio como protegido:</span><span class="sxs-lookup"><span data-stu-id="8c892-211">The installer can follow these steps to create, configure, and start the service as protected:</span></span>

1.  <span data-ttu-id="8c892-212">Llame a la API [**CreateService**](/windows/desktop/api/Winsvc/nf-winsvc-createservicea) para crear un objeto de servicio y agregarlo a la base de datos del administrador de control de servicios (SCM).</span><span class="sxs-lookup"><span data-stu-id="8c892-212">Call the [**CreateService**](/windows/desktop/api/Winsvc/nf-winsvc-createservicea) API to create a service object and add it to the service control manager (SCM) database.</span></span>
2.  <span data-ttu-id="8c892-213">Llame a la API [**SetServiceObjectSecurity**](/windows/desktop/api/winsvc/nf-winsvc-setserviceobjectsecurity) para establecer el descriptor de seguridad del objeto de servicio creado en el paso 1.</span><span class="sxs-lookup"><span data-stu-id="8c892-213">Call the [**SetServiceObjectSecurity**](/windows/desktop/api/winsvc/nf-winsvc-setserviceobjectsecurity) API to set the security descriptor of the service object created in step 1.</span></span>
3.  <span data-ttu-id="8c892-214">Llame a la API de [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) para marcar el servicio como protegido, especificando el nuevo valor de enumeración protegido de inicio de configuración de servicio, que se ha agregado en Winsvc. h (a partir de Windows 8.1). **\_ \_ \_**</span><span class="sxs-lookup"><span data-stu-id="8c892-214">Call the [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) API to mark the service as protected, specifying the new **SERVICE\_CONFIG\_LAUNCH\_PROTECTED** enumeration value, which has been added in Winsvc.h (as of Windows 8.1).</span></span>

    <span data-ttu-id="8c892-215">Ejemplo de código:</span><span class="sxs-lookup"><span data-stu-id="8c892-215">Code example:</span></span>

    ```C++
    SERVICE_LAUNCH_PROTECTED_INFO Info;
    SC_HANDLE hService;

    Info.dwLaunchProtected = SERVICE_LAUNCH_PROTECTED_ANTIMALWARE_LIGHT;

    hService = CreateService (/* ... */);

    if (ChangeServiceConfig2(hService,
                             SERVICE_CONFIG_LAUNCH_PROTECTED,
                             &Info) == FALSE)
    {
        Result = GetLastError();
    }
    ```

    

4.  <span data-ttu-id="8c892-216">Llame a la API de [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) para iniciar el servicio.</span><span class="sxs-lookup"><span data-stu-id="8c892-216">Call the [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) API to start the service.</span></span> <span data-ttu-id="8c892-217">Al iniciar el servicio como protegido, SCM comprueba con el subsistema de integridad de código (CI) para validar la información del certificado.</span><span class="sxs-lookup"><span data-stu-id="8c892-217">When starting the service as protected, SCM checks with Code Integrity (CI) subsystem to validate the certificate information.</span></span> <span data-ttu-id="8c892-218">Una vez que el CI valida la información del certificado, SCM inicia el servicio como protegido.</span><span class="sxs-lookup"><span data-stu-id="8c892-218">After the certificate information is validated by CI, SCM launches the service as protected.</span></span>
    1.  <span data-ttu-id="8c892-219">Tenga en cuenta que en este paso se produce un error si no ha registrado el servicio mediante una llamada a la API [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo) .</span><span class="sxs-lookup"><span data-stu-id="8c892-219">Note that this step fails if you haven’t registered the service by calling the [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo) API.</span></span>
    2.  <span data-ttu-id="8c892-220">Si el servicio se ha configurado para iniciarse automáticamente durante la fase de inicio del sistema, puede evitar este paso y simplemente reiniciar el sistema.</span><span class="sxs-lookup"><span data-stu-id="8c892-220">If the service has been configured to start automatically during the system startup phase, you can avoid this step and simply reboot the system.</span></span> <span data-ttu-id="8c892-221">Durante un reinicio, el sistema registra automáticamente el servicio (si el controlador ELAM se inicia correctamente) e inicia el servicio en modo protegido.</span><span class="sxs-lookup"><span data-stu-id="8c892-221">During a reboot, the system automatically registers the service (if the ELAM driver starts successfully) and starts the service in protected mode.</span></span>

### <a name="launching-a-child-process-as-protected"></a><span data-ttu-id="8c892-222">Iniciar un proceso secundario como protegido</span><span class="sxs-lookup"><span data-stu-id="8c892-222">Launching a child process as protected</span></span>

<span data-ttu-id="8c892-223">El nuevo modelo de seguridad también permite que los servicios protegidos contra malware inicien procesos secundarios como protegidos.</span><span class="sxs-lookup"><span data-stu-id="8c892-223">The new security model also allows the anti-malware protected services to launch child processes as protected.</span></span> <span data-ttu-id="8c892-224">Estos procesos secundarios se ejecutarán en el mismo nivel de protección que el servicio primario y sus archivos binarios deben estar firmados con el mismo certificado que se ha registrado a través de la sección de recursos de ELAM.</span><span class="sxs-lookup"><span data-stu-id="8c892-224">These child processes will run at the same protection level as the parent service and their binaries must be signed with the same certificate that has been registered via ELAM resource section.</span></span>

<span data-ttu-id="8c892-225">Con el fin de permitir que el servicio protegido contra malware ejecute el proceso secundario como protegido, se ha expuesto una nueva clave de atributo extendido, el **nivel de protección de \_ \_ atributo \_ \_ de subprocesos**, y debe usarse con la API de [**UpdateProcThreadAttribute**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute) .</span><span class="sxs-lookup"><span data-stu-id="8c892-225">In order to allow anti-malware protected service to launch child process as protected, a new extended attribute key, **PROC\_THREAD\_ATTRIBUTE\_PROTECTION\_LEVEL**, has been exposed and must be used with the [**UpdateProcThreadAttribute**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute) API.</span></span> <span data-ttu-id="8c892-226">Un puntero al valor de atributo de **nivel de protección \_ \_ igual** debe pasarse a la API **UpdateProcThreadAttribute** .</span><span class="sxs-lookup"><span data-stu-id="8c892-226">A pointer to the attribute value of **PROTECTION\_LEVEL\_SAME** must be passed into the **UpdateProcThreadAttribute** API.</span></span>

<span data-ttu-id="8c892-227">Notas:</span><span class="sxs-lookup"><span data-stu-id="8c892-227">Notes:</span></span>

-   <span data-ttu-id="8c892-228">Para usar este nuevo atributo, el servicio también debe especificar **Create \_ Protected \_ Process** en el parámetro flags de creación de procesos de la llamada [**CreateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessa) .</span><span class="sxs-lookup"><span data-stu-id="8c892-228">In order to use this new attribute, the service must also specify **CREATE\_PROTECTED\_PROCESS** in the process creation flags parameter of the [**CreateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessa) call.</span></span>
-   <span data-ttu-id="8c892-229">Necesita que los archivos binarios del servicio estén firmados mediante el modificador/AC para incluir el certificado cruzado para encadenarlo a una CA conocida.</span><span class="sxs-lookup"><span data-stu-id="8c892-229">You need to have your service binaries signed using the /ac switch to include the cross-certificate to chain it up to a known CA.</span></span> <span data-ttu-id="8c892-230">El certificado autofirmado sin el encadenamiento adecuado a una CA raíz conocida no funcionará.</span><span class="sxs-lookup"><span data-stu-id="8c892-230">Self-signed cert without proper chaining to a known root CA will not work.</span></span>

<span data-ttu-id="8c892-231">Ejemplo de código:</span><span class="sxs-lookup"><span data-stu-id="8c892-231">Code example:</span></span>


```C++
DWORD ProtectionLevel = PROTECTION_LEVEL_SAME;
SIZE_T AttributeListSize;

STARTUPINFOEXW StartupInfoEx = { 0 };

StartupInfoEx.StartupInfo.cb = sizeof(StartupInfoEx);

if (InitializeProcThreadAttributeList(NULL,
                                      1,
                                      0,
                                      &AttributeListSize) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}

StartupInfoEx.lpAttributeList = (LPPROC_THREAD_ATTRIBUTE_LIST) HeapAlloc(
    GetProcessHeap(),
    0,
    AttributeListSize
    );

if (InitializeProcThreadAttributeList(StartupInfoEx.lpAttributeList,
                                      1,
                                      0,
                                      &AttributeListSize) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}

if (UpdateProcThreadAttribute(StartupInfoEx.lpAttributeList,
                              0,
                              PROC_THREAD_ATTRIBUTE_PROTECTION_LEVEL,
                              &ProtectionLevel,
                              sizeof(ProtectionLevel),
                              NULL,
                              NULL) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}

PROCESS_INFORMATION ProcessInformation = { 0 };

if (CreateProcessW(ApplicationName,
                   CommandLine,
                   ProcessAttributes,
                   ThreadAttributes,
                   InheritHandles,
                   EXTENDED_STARTUPINFO_PRESENT | CREATE_PROTECTED_PROCESS,
                   Environment,
                   CurrentDirectory,
                   (LPSTARTUPINFOW)&StartupInfoEx,
                   &ProcessInformation) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}
```



## <a name="updates-and-servicing"></a><span data-ttu-id="8c892-232">Actualizaciones y mantenimiento</span><span class="sxs-lookup"><span data-stu-id="8c892-232">Updates and servicing</span></span>

<span data-ttu-id="8c892-233">Después de que el servicio antimalware se inicie como protegido, otros procesos no protegidos (e incluso administradores) no podrán detener el servicio.</span><span class="sxs-lookup"><span data-stu-id="8c892-233">After the anti-malware service is launched as protected, other non-protected processes (and even admins) aren't able to stop the service.</span></span> <span data-ttu-id="8c892-234">En el caso de las actualizaciones de los archivos binarios del servicio, el servicio antimalware debe recibir una devolución de llamada desde el instalador para detenerse para que se pueda atender.</span><span class="sxs-lookup"><span data-stu-id="8c892-234">In the case of updates to the service binaries, the anti-malware service needs to receive a callback from the installer to stop itself so that it can be serviced.</span></span> <span data-ttu-id="8c892-235">Una vez detenido el servicio, el instalador antimalware puede realizar actualizaciones y, a continuación, seguir los pasos descritos anteriormente en las secciones [registrar el servicio](https://www.bing.com/search?q=Registering+the+service) e [iniciar el servicio como protegido](#starting-the-service-as-protected) para registrar el certificado e iniciar el servicio como protegido.</span><span class="sxs-lookup"><span data-stu-id="8c892-235">After the service is stopped, the anti-malware installer can perform upgrades and then follow the steps described above in the [Registering the service](https://www.bing.com/search?q=Registering+the+service) and [Starting the service as protected](#starting-the-service-as-protected) sections to register the certificate and start the service as protected.</span></span>

<span data-ttu-id="8c892-236">Tenga en cuenta que el servicio debe asegurarse de que solo los llamadores de confianza pueden detener el servicio.</span><span class="sxs-lookup"><span data-stu-id="8c892-236">Note that the service should ensure that only trusted callers can stop the service.</span></span> <span data-ttu-id="8c892-237">Permitir a los autores de llamadas que no son de confianza anula el propósito de proteger el servicio.</span><span class="sxs-lookup"><span data-stu-id="8c892-237">Allowing untrusted callers to do so defeats the purpose of protecting the service.</span></span>

### <a name="unregistering-the-service"></a><span data-ttu-id="8c892-238">Anulando el registro del servicio</span><span class="sxs-lookup"><span data-stu-id="8c892-238">Unregistering the service</span></span>

<span data-ttu-id="8c892-239">Al desinstalar un servicio protegido, el servicio debe marcarse como no protegido mediante una llamada a la API de [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) .</span><span class="sxs-lookup"><span data-stu-id="8c892-239">When you uninstall a protected service, the service must mark itself as unprotected by calling the [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) API.</span></span> <span data-ttu-id="8c892-240">Tenga en cuenta que, dado que el sistema no permite ningún proceso no protegido para modificar la configuración de un servicio protegido, el propio servicio protegido debe realizar la llamada a [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) .</span><span class="sxs-lookup"><span data-stu-id="8c892-240">Note that because the system doesn't allow any non-protected process to alter the configuration of a protected service, the call to [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) must be made by the protected service itself.</span></span> <span data-ttu-id="8c892-241">Una vez que el servicio se ha reconfigurado para ejecutarse como desprotegido, el desinstalador solo puede tomar los pasos adecuados para quitar el software antimalware del sistema.</span><span class="sxs-lookup"><span data-stu-id="8c892-241">After the service has been reconfigured to run as unprotected, the uninstaller can simply take appropriate steps to remove the anti-malware software from the system.</span></span>

## <a name="debugging-an-anti-malware-protected-service"></a><span data-ttu-id="8c892-242">Depuración de un servicio protegido contra malware</span><span class="sxs-lookup"><span data-stu-id="8c892-242">Debugging an anti-malware protected service</span></span>

<span data-ttu-id="8c892-243">Como parte del modelo de seguridad del proceso protegido, otros procesos no protegidos no pueden insertar subprocesos ni escribir en la memoria virtual del proceso protegido.</span><span class="sxs-lookup"><span data-stu-id="8c892-243">As part of the protected process security model, other non-protected processes aren't able to inject threads or write into the virtual memory of the protected process.</span></span> <span data-ttu-id="8c892-244">Sin embargo, se permite un depurador de kernel (KD) para depurar los procesos protegidos contra malware.</span><span class="sxs-lookup"><span data-stu-id="8c892-244">However a kernel debugger (KD) is allowed for debugging any anti-malware protected processes.</span></span> <span data-ttu-id="8c892-245">KD también se puede usar para comprobar si el servicio antimalware se está ejecutando como protegido o no:</span><span class="sxs-lookup"><span data-stu-id="8c892-245">The KD can also be used to check if the anti-malware service is running as protected or not:</span></span>

``` syntax
dt –r1 nt!_EPROCESS <Process Address>
+0x67a Protection       : _PS_PROTECTION
      +0x000 Level            : 0x31 '1'
      +0x000 Type             : 0y0001
      +0x000 Signer           : 0y0011
```

<span data-ttu-id="8c892-246">Si el valor del miembro de *tipo* es 0y0001, el servicio se está ejecutando como protegido.</span><span class="sxs-lookup"><span data-stu-id="8c892-246">If the value of the *Type* member is 0y0001, the service is running as protected.</span></span>

<span data-ttu-id="8c892-247">Además, solo se permiten los siguientes comandos de SC en el servicio protegido contra malware:</span><span class="sxs-lookup"><span data-stu-id="8c892-247">In addition, only the following SC commands are allowed on anti-malware protected service:</span></span>

-   `sc config start=Auto`
-   `sc qc`
-   `sc start`
-   `sc interrogate`
-   `sc sdshow`

<span data-ttu-id="8c892-248">Si el depurador está asociado, use la siguiente marca del registro para interrumpir el depurador cuando se carguen binarios sin firmar (o firmados incorrectamente) en el servicio protegido contra malware.</span><span class="sxs-lookup"><span data-stu-id="8c892-248">If the debugger is attached, use the following flag in the registry to break in the debugger when unsigned (or inappropriately signed) binaries are loaded into the anti-malware protected service.</span></span>

``` syntax
Key:   HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\CI
Value: DebugFlags      REG_DWORD
```

<span data-ttu-id="8c892-249">Establezca el valor en **00000400** para interrumpir el depurador cuando se produzca un error en la validación de la firma.</span><span class="sxs-lookup"><span data-stu-id="8c892-249">Set the value to **00000400** to break in the debugger when the signature validation fails.</span></span>

> [!Note]  
> <span data-ttu-id="8c892-250">Limitaciones del proceso protegido:</span><span class="sxs-lookup"><span data-stu-id="8c892-250">Protected Process limitations:</span></span>
>
> 1.  <span data-ttu-id="8c892-251">Los procesos que tienen interfaz de usuario o GUI no se pueden proteger debido a la manera en que el kernel bloquea un proceso en la memoria y no permite escribir en él.</span><span class="sxs-lookup"><span data-stu-id="8c892-251">Processes that have UI or a GUI cannot be protected because of the way the kernel locks a process in memory and does not allow writes to it.</span></span>
> 2.  <span data-ttu-id="8c892-252">Antes de Windows 10, versión 1703 (Creators Update), los procesos protegidos no pueden usar los protocolos de comunicación TLS o SSL debido a las limitaciones del uso compartido de certificados entre la autoridad de seguridad local (LSA) y un proceso protegido.</span><span class="sxs-lookup"><span data-stu-id="8c892-252">Prior to Windows 10, version 1703 (the Creators update), protected processes cannot use the TLS or SSL communication protocols due to limitations of certificate sharing between the Local Security Authority (LSA) and a protected process.</span></span>

 

## <a name="resources"></a><span data-ttu-id="8c892-253">Recursos</span><span class="sxs-lookup"><span data-stu-id="8c892-253">Resources</span></span>

<span data-ttu-id="8c892-254">Para obtener más información, consulta:</span><span class="sxs-lookup"><span data-stu-id="8c892-254">For more info, see:</span></span>

-   [<span data-ttu-id="8c892-255">Antimalware de inicio temprano</span><span class="sxs-lookup"><span data-stu-id="8c892-255">Early launch antimalware</span></span>](/windows/desktop/w8cookbook/secured-boot)
-   <span data-ttu-id="8c892-256">[Procesos protegidos en Windows Vista](/previous-versions/windows/hardware/download/dn550976(v=vs.85))</span><span class="sxs-lookup"><span data-stu-id="8c892-256">[Protected Processes in Windows Vista](/previous-versions/windows/hardware/download/dn550976(v=vs.85))</span></span>
-   <span data-ttu-id="8c892-257">[Configuración de una entidad de certificación](/previous-versions/windows/desktop/ms755466(v=vs.85))</span><span class="sxs-lookup"><span data-stu-id="8c892-257">[Setting Up a Certificate Authority](/previous-versions/windows/desktop/ms755466(v=vs.85))</span></span>
-   <span data-ttu-id="8c892-258">[Instalar la entidad de certificación](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj125375(v=ws.11))</span><span class="sxs-lookup"><span data-stu-id="8c892-258">[Install the Certification Authority](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj125375(v=ws.11))</span></span>
-   [<span data-ttu-id="8c892-259">Recurso definido por el usuario</span><span class="sxs-lookup"><span data-stu-id="8c892-259">User-Defined Resource</span></span>](/windows/desktop/menurc/user-defined-resource)

<span data-ttu-id="8c892-260">En este artículo se hace referencia a estas funciones de la API de Windows:</span><span class="sxs-lookup"><span data-stu-id="8c892-260">These Windows API functions are referenced in this article:</span></span>

-   [<span data-ttu-id="8c892-261">**ChangeServiceConfig2**</span><span class="sxs-lookup"><span data-stu-id="8c892-261">**ChangeServiceConfig2**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a)
-   [<span data-ttu-id="8c892-262">**CreateProcess**</span><span class="sxs-lookup"><span data-stu-id="8c892-262">**CreateProcess**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessa)
-   [<span data-ttu-id="8c892-263">**CreateService**</span><span class="sxs-lookup"><span data-stu-id="8c892-263">**CreateService**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-createservicea)
-   [<span data-ttu-id="8c892-264">**InitializeProcThreadAttributeList**</span><span class="sxs-lookup"><span data-stu-id="8c892-264">**InitializeProcThreadAttributeList**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-initializeprocthreadattributelist)
-   [<span data-ttu-id="8c892-265">**InstallELAMCertificateInfo**</span><span class="sxs-lookup"><span data-stu-id="8c892-265">**InstallELAMCertificateInfo**</span></span>](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo)
-   [<span data-ttu-id="8c892-266">**SetServiceObjectSecurity**</span><span class="sxs-lookup"><span data-stu-id="8c892-266">**SetServiceObjectSecurity**</span></span>](/windows/desktop/api/winsvc/nf-winsvc-setserviceobjectsecurity)
-   [<span data-ttu-id="8c892-267">**StartService**</span><span class="sxs-lookup"><span data-stu-id="8c892-267">**StartService**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-startservicea)
-   [<span data-ttu-id="8c892-268">**UpdateProcThreadAttribute**</span><span class="sxs-lookup"><span data-stu-id="8c892-268">**UpdateProcThreadAttribute**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute)

 

 
