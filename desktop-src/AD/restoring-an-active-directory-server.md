---
title: Restauración de un servidor de Active Directory
description: Los servidores Active Directory deben restaurarse sin conexión.
ms.assetid: 91fbbdc1-0e84-4b89-8a38-4c8d0268992b
ms.tgt_platform: multiple
keywords:
- Restaurar Active Directory Active Directory
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 273d02fd50d6b3bd68a055a6a783566e4ebddcf7
ms.sourcegitcommit: 803f3ccd65bdefe36bd851b9c6e7280be9489016
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/17/2020
ms.locfileid: "103904471"
---
# <a name="restoring-an-active-directory-server"></a><span data-ttu-id="771a4-104">Restauración de un servidor de Active Directory</span><span class="sxs-lookup"><span data-stu-id="771a4-104">Restoring an Active Directory Server</span></span>

<span data-ttu-id="771a4-105">Los servidores Active Directory deben restaurarse sin conexión.</span><span class="sxs-lookup"><span data-stu-id="771a4-105">Active Directory servers must be restored offline.</span></span> <span data-ttu-id="771a4-106">El sistema debe reiniciarse en el modo de restauración de servicios de directorio.</span><span class="sxs-lookup"><span data-stu-id="771a4-106">The system must be restarted in Directory Services Restore mode.</span></span> <span data-ttu-id="771a4-107">En este modo, el sistema operativo se ejecuta sin Active Directory Domain Services y toda la validación de usuarios se produce a través del administrador de cuentas de seguridad (SAM) en el registro.</span><span class="sxs-lookup"><span data-stu-id="771a4-107">In this mode, the operating system is running without Active Directory Domain Services and all user validation occurs through the Security Accounts Manager (SAM) in the registry.</span></span> <span data-ttu-id="771a4-108">Para restaurar Active Directory Domain Services, use las credenciales de un administrador local en el controlador de dominio que se restaura.</span><span class="sxs-lookup"><span data-stu-id="771a4-108">To restore Active Directory Domain Services, use the credentials of a local administrator on the domain controller that is restored.</span></span>

<span data-ttu-id="771a4-109">El autor de la llamada de las funciones restore debe tener el privilegio de acceso de **\_ \_ nombre de restauración se** .</span><span class="sxs-lookup"><span data-stu-id="771a4-109">The caller of the restore functions must have the **SE\_RESTORE\_NAME** access privilege.</span></span> <span data-ttu-id="771a4-110">Utilice la función [**DsSetAuthIdentity**](dssetauthidentity.md) para establecer el contexto de seguridad en el que se llama a las funciones de copia de seguridad y restauración de directorios.</span><span class="sxs-lookup"><span data-stu-id="771a4-110">Use the [**DsSetAuthIdentity**](dssetauthidentity.md) function to set the security context under which the directory backup and restore functions are called.</span></span>

<span data-ttu-id="771a4-111">Tenga en cuenta que al restaurar Active Directory Domain Services, también debe restaurar los demás componentes de estado del sistema.</span><span class="sxs-lookup"><span data-stu-id="771a4-111">Be aware that when you restore Active Directory Domain Services, you must also restore the other system state components.</span></span>

<span data-ttu-id="771a4-112">**Para restaurar Active Directory Domain Services**</span><span class="sxs-lookup"><span data-stu-id="771a4-112">**To restore Active Directory Domain Services**</span></span>

1.  <span data-ttu-id="771a4-113">Llame a la función [**DsIsNTDSOnline**](dsisntdsonline.md) para determinar si Active Directory Domain Services se están ejecutando.</span><span class="sxs-lookup"><span data-stu-id="771a4-113">Call the [**DsIsNTDSOnline**](dsisntdsonline.md) function to determine if Active Directory Domain Services are running.</span></span>
2.  <span data-ttu-id="771a4-114">Si Active Directory Domain Services no se están ejecutando, se llama a la función [**DsRestorePrepare**](dsrestoreprepare.md) para inicializar la operación de restauración y obtener un identificador de contexto de copia de seguridad.</span><span class="sxs-lookup"><span data-stu-id="771a4-114">If Active Directory Domain Services are not running, the [**DsRestorePrepare**](dsrestoreprepare.md) function is called to initialize the restore operation and obtain a backup context handle.</span></span> <span data-ttu-id="771a4-115">Si Active Directory Domain Services se están ejecutando, no se puede restaurar y la aplicación de restauración no debe realizar la operación de restauración.</span><span class="sxs-lookup"><span data-stu-id="771a4-115">If Active Directory Domain Services are running, it cannot be restored and the restore application must fail the restore operation.</span></span> <span data-ttu-id="771a4-116">La función **DsRestorePrepare** requiere que el token de expiración se obtenga de la función [**DsBackupPrepare**](dsbackupprepare.md) durante la operación de copia de seguridad.</span><span class="sxs-lookup"><span data-stu-id="771a4-116">The **DsRestorePrepare** function requires that the expiry token be obtained from the [**DsBackupPrepare**](dsbackupprepare.md) function during the backup operation.</span></span>
3.  <span data-ttu-id="771a4-117">Llame a la función [**DsRestoreGetDatabaseLocations**](dsrestoregetdatabaselocations.md) para determinar los directorios en los que se van a restaurar los archivos.</span><span class="sxs-lookup"><span data-stu-id="771a4-117">Call the [**DsRestoreGetDatabaseLocations**](dsrestoregetdatabaselocations.md) function to determine the directories where the files are to be restored.</span></span> <span data-ttu-id="771a4-118">Si se produce un error en esta función, restaure los datos de nuevo en el directorio de origen de la copia de seguridad original. es el directorio desde el que se realizó la copia de seguridad de los datos.</span><span class="sxs-lookup"><span data-stu-id="771a4-118">If this function fails, restore the data back to the original backup source directory; that is the directory from which the data was backed up.</span></span>
4.  <span data-ttu-id="771a4-119">Llame a la función [**DsRestoreRegister**](dsrestoreregister.md) para preparar el servidor de Active Directory para la operación de restauración y bloquear los directorios de restauración.</span><span class="sxs-lookup"><span data-stu-id="771a4-119">Call the [**DsRestoreRegister**](dsrestoreregister.md) function to prepare the Active Directory server for the restore operation and lock the restore directories.</span></span>
5.  <span data-ttu-id="771a4-120">Utilice las funciones estándar de Win32 para restaurar los archivos.</span><span class="sxs-lookup"><span data-stu-id="771a4-120">Use standard Win32 functions to restore the files.</span></span> <span data-ttu-id="771a4-121">En primer lugar, elimine todos los archivos del directorio de destino; a continuación, copie los archivos de copia de seguridad en el directorio de destino.</span><span class="sxs-lookup"><span data-stu-id="771a4-121">First, delete all files in the destination directory; then copy the backup files to the destination directory.</span></span>
6.  <span data-ttu-id="771a4-122">Llame a la función [**DsRestoreRegisterComplete**](dsrestoreregistercomplete.md) para indicar que la restauración se ha completado.</span><span class="sxs-lookup"><span data-stu-id="771a4-122">Call the [**DsRestoreRegisterComplete**](dsrestoreregistercomplete.md) function to indicate that the restore has completed.</span></span>
7.  <span data-ttu-id="771a4-123">Llame a la función [**DsRestoreEnd**](dsrestoreend.md) para liberar todos los recursos asociados al contexto.</span><span class="sxs-lookup"><span data-stu-id="771a4-123">Call the [**DsRestoreEnd**](dsrestoreend.md) function to release any resources associated with the context.</span></span>

<span data-ttu-id="771a4-124">Después de una restauración en el modo de restauración de servicios de directorio, el controlador de dominio debe reiniciarse en modo normal.</span><span class="sxs-lookup"><span data-stu-id="771a4-124">After a restore in Directory Services Restore mode, the domain controller should be restarted in normal mode.</span></span> <span data-ttu-id="771a4-125">Cuando se inicia el servicio de directorio, el controlador de dominio realizará la comprobación de coherencia normal y el directorio restaurado estará en línea.</span><span class="sxs-lookup"><span data-stu-id="771a4-125">When the directory service starts, the domain controller will perform the normal consistency check and the restored directory will then be online.</span></span>

<span data-ttu-id="771a4-126">Tenga en cuenta que la restauración de un servidor de Active Directory siempre es una operación de dos partes.</span><span class="sxs-lookup"><span data-stu-id="771a4-126">Be aware that restoring an Active Directory server is always a two-part operation.</span></span> <span data-ttu-id="771a4-127">En primer lugar, restaure la base de datos a una hora en la que se realizó la copia de seguridad.</span><span class="sxs-lookup"><span data-stu-id="771a4-127">First, restore the database to a time when the backup was taken.</span></span> <span data-ttu-id="771a4-128">En segundo lugar, replique el directorio, donde el DSA recién restaurado Replica las actualizaciones posteriores a la copia de seguridad de otros DSA en el dominio y el bosque de la empresa.</span><span class="sxs-lookup"><span data-stu-id="771a4-128">Second, replicate the directory, where the newly restored DSA replicates post-backup updates from other DSAs in the domain and enterprise forest.</span></span>

<span data-ttu-id="771a4-129">Un equipo que se ejecuta en Windows 2000 o Windows Server 2003, que contiene una réplica del servicio de directorio, es un controlador de dominio.</span><span class="sxs-lookup"><span data-stu-id="771a4-129">A computer running on Windows 2000 or Windows Server 2003, that contains a replica of the directory service, is a domain controller.</span></span>

<span data-ttu-id="771a4-130">La función [**DsRestoreRegister**](dsrestoreregister.md) agrega datos al registro que deben sobrevivir al proceso de restauración del registro para que la restauración funcione correctamente.</span><span class="sxs-lookup"><span data-stu-id="771a4-130">The [**DsRestoreRegister**](dsrestoreregister.md) function adds data to the registry that must survive the registry restoration process for the restoration to work correctly.</span></span> <span data-ttu-id="771a4-131">Para asegurarse de que se conservan los datos del registro, restaure Active Directory Domain Services con las funciones **DsRestore \*** antes de reiniciar el equipo después de llamar a la función [**RegReplaceKey**](/windows/desktop/api/winreg/nf-winreg-regreplacekeya) .</span><span class="sxs-lookup"><span data-stu-id="771a4-131">To ensure this registry data is preserved, restore Active Directory Domain Services with the **DsRestore\*** functions prior to restarting the computer after the [**RegReplaceKey**](/windows/desktop/api/winreg/nf-winreg-regreplacekeya) function is called.</span></span> <span data-ttu-id="771a4-132">Este proceso funciona porque **RegReplaceKey** no reemplaza realmente el subárbol del registro hasta que se reinicia el equipo y los datos del registro agregados por la función **DsRestoreRegister** se excluyen específicamente de la sustitución durante una operación de restauración del registro.</span><span class="sxs-lookup"><span data-stu-id="771a4-132">This process works because **RegReplaceKey** does not actually replace the registry hive until the computer is restarted and the registry data added by the **DsRestoreRegister** function is specifically excluded from being replaced during a registry restore operation.</span></span>

 

 