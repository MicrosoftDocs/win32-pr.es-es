---
title: Procesos, subprocesos y apartamentos
description: Un proceso es una colección de espacio de memoria virtual, código, datos y recursos del sistema.
ms.assetid: cb62412a-d079-40f9-89dc-cce0bf3889af
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d598fc9d7dd39ab070b58aa7ba45a6e2fcae90db
ms.sourcegitcommit: 5f33645661bf8c825a7a2e73950b1f4ea0f1cd82
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/21/2020
ms.locfileid: "104421447"
---
# <a name="processes-threads-and-apartments"></a><span data-ttu-id="b2a7e-103">Procesos, subprocesos y apartamentos</span><span class="sxs-lookup"><span data-stu-id="b2a7e-103">Processes, Threads, and Apartments</span></span>

<span data-ttu-id="b2a7e-104">Un *proceso* es una colección de espacio de memoria virtual, código, datos y recursos del sistema.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-104">A *process* is a collection of virtual memory space, code, data, and system resources.</span></span> <span data-ttu-id="b2a7e-105">Un *subproceso* es código que se ejecutará en serie dentro de un proceso.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-105">A *thread* is code that is to be serially executed within a process.</span></span> <span data-ttu-id="b2a7e-106">Un procesador ejecuta subprocesos, no procesos, por lo que cada aplicación tiene al menos un proceso y un proceso siempre tiene al menos un subproceso de ejecución, conocido como el subproceso principal.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-106">A processor executes threads, not processes, so each application has at least one process, and a process always has at least one thread of execution, known as the primary thread.</span></span> <span data-ttu-id="b2a7e-107">Un proceso puede tener varios subprocesos además del subproceso principal.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-107">A process can have multiple threads in addition to the primary thread.</span></span>

<span data-ttu-id="b2a7e-108">Los procesos se comunican entre sí a través de mensajes, mediante la tecnología de llamada a procedimiento remoto (RPC) de Microsoft para pasar información entre sí.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-108">Processes communicate with one another through messages, using Microsoft's Remote Procedure Call (RPC) technology to pass information to one another.</span></span> <span data-ttu-id="b2a7e-109">No hay ninguna diferencia con el autor de la llamada entre una llamada procedente de un proceso en un equipo remoto y una llamada procedente de otro proceso en el mismo equipo.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-109">There is no difference to the caller between a call coming from a process on a remote machine and a call coming from another process on the same machine.</span></span>

<span data-ttu-id="b2a7e-110">Cuando un subproceso empieza a ejecutarse, continúa hasta que se elimina o hasta que lo interrumpe un subproceso con mayor prioridad (por una acción del usuario o el programador de subprocesos del kernel).</span><span class="sxs-lookup"><span data-stu-id="b2a7e-110">When a thread begins to execute, it continues until it is killed or until it is interrupted by a thread with higher priority (by a user action or the kernel's thread scheduler).</span></span> <span data-ttu-id="b2a7e-111">Cada subproceso puede ejecutar secciones de código independientes, o varios subprocesos pueden ejecutar la misma sección de código.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-111">Each thread can run separate sections of code, or multiple threads can execute the same section of code.</span></span> <span data-ttu-id="b2a7e-112">Los subprocesos que ejecutan el mismo bloque de código mantienen pilas independientes.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-112">Threads executing the same block of code maintain separate stacks.</span></span> <span data-ttu-id="b2a7e-113">Cada subproceso de un proceso comparte las variables y los recursos globales de ese proceso.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-113">Each thread in a process shares that process's global variables and resources.</span></span>

<span data-ttu-id="b2a7e-114">El programador de subprocesos determina cuándo y con qué frecuencia se ejecuta un subproceso, de acuerdo con una combinación del atributo de clase de prioridad del proceso y la prioridad base del subproceso.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-114">The thread scheduler determines when and how often to execute a thread, according to a combination of the process's priority class attribute and the thread's base priority.</span></span> <span data-ttu-id="b2a7e-115">Establezca el atributo de clase de prioridad de un proceso llamando a la función [**SetPriorityClass**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setpriorityclass) y establezca la prioridad base de un subproceso con una llamada a [**SetThreadPriority**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setthreadpriority).</span><span class="sxs-lookup"><span data-stu-id="b2a7e-115">You set a process's priority class attribute by calling the [**SetPriorityClass**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setpriorityclass) function , and you set a thread's base priority with a call to [**SetThreadPriority**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setthreadpriority).</span></span>

<span data-ttu-id="b2a7e-116">Las aplicaciones multiproceso deben evitar dos problemas de subprocesos: *interbloqueos* y *carreras*.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-116">Multithreaded applications must avoid two threading problems: *deadlocks* and *races*.</span></span> <span data-ttu-id="b2a7e-117">Un interbloqueo se produce cuando cada subproceso está esperando a que el otro haga algo.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-117">A deadlock occurs when each thread is waiting for the other to do something.</span></span> <span data-ttu-id="b2a7e-118">El control de llamada COM ayuda a evitar los interbloqueos en las llamadas entre objetos.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-118">The COM call control helps prevent deadlocks in calls between objects.</span></span> <span data-ttu-id="b2a7e-119">Una condición de carrera se produce cuando un subproceso finaliza antes que otro en el que depende, lo que hace que el primero use un valor no inicializado porque el último no ha proporcionado todavía uno válido.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-119">A race condition occurs when one thread finishes before another on which it depends, causing the former to use an uninitialized value because the latter has not yet supplied a valid one.</span></span> <span data-ttu-id="b2a7e-120">COM proporciona algunas funciones diseñadas específicamente para ayudar a evitar condiciones de carrera en servidores fuera de proceso.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-120">COM supplies some functions specifically designed to help avoid race conditions in out-of-process servers.</span></span> <span data-ttu-id="b2a7e-121">(Consulte [aplicaciones auxiliares de implementación de servidor fuera de proceso](out-of-process-server-implementation-helpers.md)).</span><span class="sxs-lookup"><span data-stu-id="b2a7e-121">(See [Out-of-Process Server Implementation Helpers](out-of-process-server-implementation-helpers.md).)</span></span>

## <a name="the-apartment-and-the-com-threading-architecture"></a><span data-ttu-id="b2a7e-122">El apartamento y la arquitectura de subprocesos COM</span><span class="sxs-lookup"><span data-stu-id="b2a7e-122">The Apartment and the COM Threading Architecture</span></span>

<span data-ttu-id="b2a7e-123">Aunque COM admite el modelo de un solo subproceso por proceso antes de la introducción de varios subprocesos de ejecución, puede escribir código para aprovecharse de varios subprocesos, lo que da lugar a aplicaciones más eficaces, ya que permite que un subproceso se ejecute mientras otro subproceso espera a que se complete una operación que consume mucho tiempo.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-123">While COM supports the single-thread-per-process model prevalent before the introduction of multiple threads of execution, you can write code to take advantage of multiple threads, resulting in more efficient applications, by allowing one thread to be executed while another thread waits for some time-consuming operation to complete.</span></span>

> [!Note]  
> <span data-ttu-id="b2a7e-124">El uso de varios subprocesos no garantiza un mejor rendimiento.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-124">Using multiple threads is not a guarantee of better performance.</span></span> <span data-ttu-id="b2a7e-125">De hecho, dado que la factorización de subprocesos es un problema difícil, el uso de varios subprocesos suele causar problemas de rendimiento.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-125">In fact, because thread factoring is a difficult problem, using multiple threads often causes performance problems.</span></span> <span data-ttu-id="b2a7e-126">La clave consiste en usar varios subprocesos solo si está seguro de lo que está haciendo.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-126">The key is to use multiple threads only if you are very sure of what you are doing.</span></span>

 

<span data-ttu-id="b2a7e-127">En general, la manera más sencilla de ver la arquitectura de subprocesos COM es pensar en que todos los objetos COM del proceso se dividen en grupos denominados *apartamentos*.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-127">In general, the simplest way to view the COM threading architecture is to think of all the COM objects in the process as divided into groups called *apartments*.</span></span> <span data-ttu-id="b2a7e-128">Un objeto COM reside exactamente en un apartamento, en el sentido de que solo un subproceso que pertenece a ese apartamento puede llamar legalmente a sus métodos.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-128">A COM object lives in exactly one apartment, in the sense that its methods can legally be directly called only by a thread that belongs to that apartment.</span></span> <span data-ttu-id="b2a7e-129">Cualquier otro subproceso que desee llamar al objeto debe pasar por un proxy.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-129">Any other thread that wants to call the object must go through a proxy.</span></span>

<span data-ttu-id="b2a7e-130">Hay dos tipos de apartamentos: [apartamentos de un solo subproceso](single-threaded-apartments.md)y [apartamentos multiproceso](multithreaded-apartments.md).</span><span class="sxs-lookup"><span data-stu-id="b2a7e-130">There are two types of apartments: [single-threaded apartments](single-threaded-apartments.md), and [multithreaded apartments](multithreaded-apartments.md).</span></span>

-   <span data-ttu-id="b2a7e-131">Los apartamentos de un solo subproceso constan exactamente de un subproceso, por lo que todos los objetos COM que se encuentran en un apartamento de un solo subproceso pueden recibir llamadas a métodos solo desde el subproceso que pertenece a ese apartamento.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-131">Single-threaded apartments consist of exactly one thread, so all COM objects that live in a single-threaded apartment can receive method calls only from the one thread that belongs to that apartment.</span></span> <span data-ttu-id="b2a7e-132">Todas las llamadas a métodos a un objeto COM en un contenedor uniproceso se sincronizan con la cola de mensajes de Windows para el subproceso del contenedor uniproceso.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-132">All method calls to a COM object in a single-threaded apartment are synchronized with the windows message queue for the single-threaded apartment's thread.</span></span> <span data-ttu-id="b2a7e-133">Un proceso con un único subproceso de ejecución es simplemente un caso especial de este modelo.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-133">A process with a single thread of execution is simply a special case of this model.</span></span>
-   <span data-ttu-id="b2a7e-134">Los apartamentos multiproceso se componen de uno o más subprocesos, por lo que todos los objetos COM que se encuentran en un apartamento multiproceso pueden recibir llamadas al método directamente desde cualquiera de los subprocesos que pertenecen al apartamento multiproceso.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-134">Multithreaded apartments consist of one or more threads, so all COM objects that live in an multithreaded apartment can receive method calls directly from any of the threads that belong to the multithreaded apartment.</span></span> <span data-ttu-id="b2a7e-135">Los subprocesos de un apartamento multiproceso utilizan un modelo denominado *subprocesamiento libre*.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-135">Threads in a multithreaded apartment use a model called *free-threading*.</span></span> <span data-ttu-id="b2a7e-136">Los propios objetos sincronizan las llamadas a objetos COM de un apartamento multiproceso.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-136">Calls to COM objects in a multithreaded apartment are synchronized by the objects themselves.</span></span>

> [!Note]  
> <span data-ttu-id="b2a7e-137">Para obtener una descripción de la comunicación entre apartamentos de un solo subproceso y apartamentos multiproceso en el mismo proceso, vea comunicación multiproceso [y](single-threaded-and-multithreaded-communication.md)multiproceso.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-137">For a description of communication between single-threaded apartments and multithreaded apartments within the same process, see [Single-Threaded and Multithreaded Communication](single-threaded-and-multithreaded-communication.md).</span></span>

 

<span data-ttu-id="b2a7e-138">Un proceso puede tener cero o más apartamentos de un solo subproceso y cero o un apartamento multiproceso.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-138">A process can have zero or more single-threaded apartments and zero or one multithreaded apartment.</span></span>

<span data-ttu-id="b2a7e-139">En un proceso, el apartamento principal es el primero que se va a inicializar.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-139">In a process, the main apartment is the first to be initialized.</span></span> <span data-ttu-id="b2a7e-140">En un proceso de un solo subproceso, este es el único apartamento.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-140">In a single-threaded process, this is the only apartment.</span></span> <span data-ttu-id="b2a7e-141">Se calculan las referencias de los parámetros de llamada entre apartamentos y COM controla la sincronización a través de la mensajería.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-141">Call parameters are marshaled between apartments, and COM handles the synchronization through messaging.</span></span> <span data-ttu-id="b2a7e-142">Si designa varios subprocesos en un proceso para que sean de subprocesamiento libre, todos los subprocesos libres residen en un único apartamento, los parámetros se pasan directamente a cualquier subproceso del apartamento y debe controlar toda la sincronización.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-142">If you designate multiple threads in a process to be free-threaded, all free threads reside in a single apartment, parameters are passed directly to any thread in the apartment, and you must handle all synchronization.</span></span> <span data-ttu-id="b2a7e-143">En un proceso con subprocesamiento libre y subprocesamiento de apartamento, todos los subprocesos libres residen en un único apartamento y todos los demás apartamentos son apartamentos de un solo subproceso.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-143">In a process with both free-threading and apartment threading, all free threads reside in a single apartment and all other apartments are single-threaded apartments.</span></span> <span data-ttu-id="b2a7e-144">Un proceso que realiza el trabajo COM es una colección de apartamentos con, como máximo, un apartamento multiproceso, pero cualquier número de apartamentos de un solo subproceso.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-144">A process that does COM work is a collection of apartments with, at most, one multithreaded apartment but any number of single-threaded apartments.</span></span>

<span data-ttu-id="b2a7e-145">Los modelos de subprocesos de COM proporcionan el mecanismo para que los clientes y servidores que utilizan distintas arquitecturas de subprocesos funcionen juntos.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-145">The threading models in COM provide the mechanism for clients and servers that use different threading architectures to work together.</span></span> <span data-ttu-id="b2a7e-146">Las llamadas entre objetos con diferentes modelos de subprocesos en distintos procesos se admiten de forma natural.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-146">Calls among objects with different threading models in different processes are naturally supported.</span></span> <span data-ttu-id="b2a7e-147">Desde la perspectiva del objeto que realiza la llamada, todas las llamadas a objetos fuera de un proceso se comportan de manera idéntica, independientemente de cómo se procese el objeto que se está llamando.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-147">From the perspective of the calling object, all calls to objects outside a process behave identically, no matter how the object being called is threaded.</span></span> <span data-ttu-id="b2a7e-148">Del mismo modo, desde la perspectiva del objeto al que se llama, las llamadas de llegada se comportan de manera idéntica, independientemente del modelo de subprocesos del llamador.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-148">Likewise, from the perspective of the object being called, arriving calls behave identically, regardless of the threading model of the caller.</span></span>

<span data-ttu-id="b2a7e-149">La interacción entre un cliente y un objeto fuera de proceso es sencilla, incluso cuando utilizan diferentes modelos de subprocesos porque el cliente y el objeto se encuentran en procesos diferentes.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-149">Interaction between a client and an out-of-process object is straightforward, even when they use different threading models because the client and object are in different processes.</span></span> <span data-ttu-id="b2a7e-150">COM, interposed entre el cliente y el servidor, puede proporcionar el código para que los modelos de subprocesos interoperen, mediante el cálculo de referencias estándar y RPC.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-150">COM, interposed between the client and the server, can provide the code for the threading models to interoperate, using standard marshaling and RPC.</span></span> <span data-ttu-id="b2a7e-151">Por ejemplo, si varios clientes de subprocesamiento libre llaman simultáneamente a un objeto de un solo subproceso, las llamadas se sincronizarán mediante COM colocando los mensajes de ventana correspondientes en la cola de mensajes del servidor.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-151">For example, if a single-threaded object is called simultaneously by multiple free-threaded clients, the calls will be synchronized by COM by placing corresponding window messages in the server's message queue.</span></span> <span data-ttu-id="b2a7e-152">El apartamento del objeto recibirá una llamada cada vez que recupere y envíe mensajes.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-152">The object's apartment will receive one call each time it retrieves and dispatches messages.</span></span> <span data-ttu-id="b2a7e-153">Sin embargo, se debe tener cuidado para asegurarse de que los servidores en proceso interactúen correctamente con sus clientes.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-153">However, some care must be taken to ensure that in-process servers interact properly with their clients.</span></span> <span data-ttu-id="b2a7e-154">(Vea [problemas de subprocesos de servidor en proceso](in-process-server-threading-issues.md)).</span><span class="sxs-lookup"><span data-stu-id="b2a7e-154">(See [In-Process Server Threading Issues](in-process-server-threading-issues.md).)</span></span>

<span data-ttu-id="b2a7e-155">El problema más importante en la programación con un modelo multiproceso es hacer que el código sea seguro para subprocesos, de modo que los mensajes destinados a un subproceso determinado vayan solo a ese subproceso y se proteja el acceso a los subprocesos.</span><span class="sxs-lookup"><span data-stu-id="b2a7e-155">The most important issue in programming with a multithreaded model is to make your code thread-safe so that messages intended for a particular thread go only to that thread and access to threads is protected.</span></span>

<span data-ttu-id="b2a7e-156">Para obtener más información, vea los temas siguientes:</span><span class="sxs-lookup"><span data-stu-id="b2a7e-156">For more information, see the following topics:</span></span>

-   [<span data-ttu-id="b2a7e-157">Elegir el modelo de subprocesos</span><span class="sxs-lookup"><span data-stu-id="b2a7e-157">Choosing the Threading Model</span></span>](choosing-the-threading-model.md)
-   [<span data-ttu-id="b2a7e-158">Apartamentos de un solo subproceso</span><span class="sxs-lookup"><span data-stu-id="b2a7e-158">Single-Threaded Apartments</span></span>](single-threaded-apartments.md)
-   [<span data-ttu-id="b2a7e-159">Apartamentos multiproceso</span><span class="sxs-lookup"><span data-stu-id="b2a7e-159">Multithreaded Apartments</span></span>](multithreaded-apartments.md)
-   [<span data-ttu-id="b2a7e-160">Comunicación multiproceso y de un solo subproceso</span><span class="sxs-lookup"><span data-stu-id="b2a7e-160">Single-Threaded and Multithreaded Communication</span></span>](single-threaded-and-multithreaded-communication.md)
-   [<span data-ttu-id="b2a7e-161">Problemas de subprocesos de servidor en proceso</span><span class="sxs-lookup"><span data-stu-id="b2a7e-161">In-Process Server Threading Issues</span></span>](in-process-server-threading-issues.md)
-   [<span data-ttu-id="b2a7e-162">Acceso a interfaces entre apartamentos</span><span class="sxs-lookup"><span data-stu-id="b2a7e-162">Accessing Interfaces Across Apartments</span></span>](accessing-interfaces-across-apartments.md)

 

 