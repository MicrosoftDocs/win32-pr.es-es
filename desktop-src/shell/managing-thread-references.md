---
description: Este artículo contiene información sobre la administración de las referencias de subprocesos mediante funciones de las funciones de utilidad de Shell ligero.
ms.assetid: d8d479fd-c45a-4dfa-b496-76abc7c09a42
title: Administrar referencias de subprocesos
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: b629cd97c99e3b30e66810b5f54720d0dbb1c87d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/08/2021
ms.locfileid: "104985655"
---
# <a name="managing-thread-references"></a><span data-ttu-id="54a29-103">Administrar referencias de subprocesos</span><span class="sxs-lookup"><span data-stu-id="54a29-103">Managing Thread References</span></span>

<span data-ttu-id="54a29-104">Este artículo contiene información sobre la administración de las referencias de subprocesos mediante funciones de las funciones de utilidad de Shell ligero.</span><span class="sxs-lookup"><span data-stu-id="54a29-104">This article contains information about the management of thread references using functions from the Shell lightweight utility functions.</span></span>


<span data-ttu-id="54a29-105">Surgen situaciones en las que un subproceso primario debe mantenerse activo mientras dure un subproceso secundario.</span><span class="sxs-lookup"><span data-stu-id="54a29-105">Situations arise when a parent thread must be kept active for the lifetime of a child thread.</span></span> <span data-ttu-id="54a29-106">Por ejemplo, si se crea un objeto de modelo de objetos componentes (COM) en el subproceso primario y se calculan las referencias al subproceso secundario, ese subproceso primario no puede finalizar antes del subproceso secundario.</span><span class="sxs-lookup"><span data-stu-id="54a29-106">For instance, if a Component Object Model (COM) object is created on the parent thread and marshaled to the child thread, that parent thread cannot terminate before the child thread.</span></span> <span data-ttu-id="54a29-107">Para ello, el Shell proporciona estas funciones.</span><span class="sxs-lookup"><span data-stu-id="54a29-107">To accomplish this, the Shell provides these functions.</span></span>

-   [<span data-ttu-id="54a29-108">**SHCreateThreadRef**</span><span class="sxs-lookup"><span data-stu-id="54a29-108">**SHCreateThreadRef**</span></span>](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref)
-   [<span data-ttu-id="54a29-109">**SHSetThreadRef**</span><span class="sxs-lookup"><span data-stu-id="54a29-109">**SHSetThreadRef**</span></span>](/windows/desktop/api/Shlwapi/nf-shlwapi-shsetthreadref)
-   [<span data-ttu-id="54a29-110">**SHGetThreadRef**</span><span class="sxs-lookup"><span data-stu-id="54a29-110">**SHGetThreadRef**</span></span>](/windows/desktop/api/Shlwapi/nf-shlwapi-shgetthreadref)

<span data-ttu-id="54a29-111">Use estas funciones en el subproceso primario como se describe aquí.</span><span class="sxs-lookup"><span data-stu-id="54a29-111">Use these functions in your parent thread as outlined here.</span></span>

1.  <span data-ttu-id="54a29-112">Declare un procedimiento de subproceso definido por la aplicación según la forma de la función [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) .</span><span class="sxs-lookup"><span data-stu-id="54a29-112">Declare an application-defined thread procedure following the form of the [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) function.</span></span>

    ``` syntax
    DWORD WINAPI ThreadProc(LPVOID lpParameter);
    ```

2.  <span data-ttu-id="54a29-113">En [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)), llame a [**SHCreateThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref) para crear una referencia al subproceso.</span><span class="sxs-lookup"><span data-stu-id="54a29-113">In your [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)), call [**SHCreateThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref) to create a reference to the thread.</span></span> <span data-ttu-id="54a29-114">Esto proporciona un puntero a una instancia de [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown).</span><span class="sxs-lookup"><span data-stu-id="54a29-114">This provides a pointer to an instance of [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown).</span></span> <span data-ttu-id="54a29-115">Este **IUnknown** usa el valor al que apunta *pcRef* para mantener un recuento de referencias.</span><span class="sxs-lookup"><span data-stu-id="54a29-115">This **IUnknown** uses the value pointed to by *pcRef* to maintain a reference count.</span></span> <span data-ttu-id="54a29-116">Siempre que este recuento sea mayor que 0, el subproceso permanece activo.</span><span class="sxs-lookup"><span data-stu-id="54a29-116">As long as this count is greater than 0, the thread remains active.</span></span>
3.  <span data-ttu-id="54a29-117">Con ese puntero a [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown), llame a [**SHSetThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shsetthreadref) en [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)).</span><span class="sxs-lookup"><span data-stu-id="54a29-117">Using that pointer to [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown), call [**SHSetThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shsetthreadref) in your [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)).</span></span> <span data-ttu-id="54a29-118">Esto establece la referencia para que las llamadas subsiguientes a [**SHGetThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shgetthreadref) tengan algo que recuperar.</span><span class="sxs-lookup"><span data-stu-id="54a29-118">This sets the reference so that subsequent calls to [**SHGetThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shgetthreadref) have something to retrieve.</span></span>
4.  <span data-ttu-id="54a29-119">Si su [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) crea otro subproceso, *ThreadProc* del subproceso puede llamar a [**SHGetThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shgetthreadref) con el puntero a [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) obtenido por [**SHCreateThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref).</span><span class="sxs-lookup"><span data-stu-id="54a29-119">If your [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) creates another thread, that thread's *ThreadProc* can call [**SHGetThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shgetthreadref) with the pointer to [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) obtained by [**SHCreateThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref).</span></span> <span data-ttu-id="54a29-120">Esto incrementa el recuento de referencias al que apunta el parámetro *pcRef* en **SHCreateThreadRef**.</span><span class="sxs-lookup"><span data-stu-id="54a29-120">This increments the reference count pointed to by the *pcRef* parameter in **SHCreateThreadRef**.</span></span>
5.  <span data-ttu-id="54a29-121">Cree el subproceso.</span><span class="sxs-lookup"><span data-stu-id="54a29-121">Create the thread.</span></span> <span data-ttu-id="54a29-122">Esto se suele hacer llamando a [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread), pasando un puntero a [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) en el parámetro *pfnThreadProc* .</span><span class="sxs-lookup"><span data-stu-id="54a29-122">This is usually done by calling [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread), passing a pointer to your [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) in the *pfnThreadProc* parameter.</span></span> <span data-ttu-id="54a29-123">También se pasa la \_ marca de referencia del subproceso CTF \_ en el parámetro *dwFlags* .</span><span class="sxs-lookup"><span data-stu-id="54a29-123">Also pass the CTF\_THREAD\_REF flag in the *dwFlags* parameter.</span></span> <span data-ttu-id="54a29-124">El subproceso está activo siempre que se ejecute *ThreadProc* .</span><span class="sxs-lookup"><span data-stu-id="54a29-124">The thread is active as long as *ThreadProc* is executing.</span></span>
6.  <span data-ttu-id="54a29-125">Cuando se crea un subproceso secundario, pase la marca de **\_ \_ recuento de referencia de CTF** en el parámetro *dwFlags* en la llamada a su [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread).</span><span class="sxs-lookup"><span data-stu-id="54a29-125">When a child thread is created, pass the **CTF\_REF\_COUNTED** flag in the *dwFlags* parameter in the call to its [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread).</span></span>
7.  <span data-ttu-id="54a29-126">A medida que se completan los subprocesos secundarios y se liberan, se reduce el valor al que apunta el *pcRef* del subproceso primario.</span><span class="sxs-lookup"><span data-stu-id="54a29-126">As child threads complete and are released, the value pointed to by the parent thread's *pcRef* decreases.</span></span> <span data-ttu-id="54a29-127">Una vez completados todos los subprocesos secundarios, el valor de [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) original puede completarse y liberar la referencia de subproceso final, quitando el recuento de referencias a 0.</span><span class="sxs-lookup"><span data-stu-id="54a29-127">Once all child threads are complete, the original [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) can complete and release the final thread reference, dropping the reference count to 0.</span></span> <span data-ttu-id="54a29-128">En ese momento, se libera la referencia al subproceso original abierto por [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread) y el subproceso se completa.</span><span class="sxs-lookup"><span data-stu-id="54a29-128">At that point, the reference to the original thread opened by [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread) is released and the thread completed.</span></span>

<span data-ttu-id="54a29-129">Otra función relacionada es [**SHReleaseThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shreleasethreadref).</span><span class="sxs-lookup"><span data-stu-id="54a29-129">Another related function is [**SHReleaseThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shreleasethreadref).</span></span> <span data-ttu-id="54a29-130">[*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) llama a esta función si el subproceso se ha creado con [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread) con la marca **de \_ \_ referencia de subproceso CTF** .</span><span class="sxs-lookup"><span data-stu-id="54a29-130">This function is called by the [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) if the thread has been created using [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread) with the **CTF\_THREAD\_REF** flag.</span></span> <span data-ttu-id="54a29-131">Sin embargo, no es necesario que *ThreadProc* lo haga implícitamente.</span><span class="sxs-lookup"><span data-stu-id="54a29-131">However, the *ThreadProc* is not required to do so implicitly.</span></span> <span data-ttu-id="54a29-132">Llamar a [**IUnknown:: Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) en el puntero a [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) obtenido a través de [**SHCreateThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref) es todo lo que hay que hacer.</span><span class="sxs-lookup"><span data-stu-id="54a29-132">Calling [**IUnknown::Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) on the pointer to [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) obtained through [**SHCreateThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref) is all that needs to be done.</span></span>

 

 
