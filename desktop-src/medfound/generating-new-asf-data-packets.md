---
description: Generación de nuevos paquetes de datos ASF
ms.assetid: 7afa9694-c965-40e2-8549-e32ff48def2a
title: Generación de nuevos paquetes de datos ASF
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 78f3432ecf34c58247a1533adb202b75f59d770c
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/07/2021
ms.locfileid: "104496805"
---
# <a name="generating-new-asf-data-packets"></a><span data-ttu-id="980a9-103">Generación de nuevos paquetes de datos ASF</span><span class="sxs-lookup"><span data-stu-id="980a9-103">Generating New ASF Data Packets</span></span>

<span data-ttu-id="980a9-104">El *multiplexor* ASF es un componente de nivel WMContainer que funciona con el [objeto de datos ASF](asf-file-structure.md) y proporciona a una aplicación la capacidad de generar paquetes de datos ASF para una secuencia que coincida con los requisitos definidos en el objeto ContentInfo.</span><span class="sxs-lookup"><span data-stu-id="980a9-104">The ASF *multiplexer* is a WMContainer layer component that works with the [ASF Data Object](asf-file-structure.md) and gives an application the ability to generate ASF data packets for a stream that match the requirements defined in the ContentInfo object.</span></span>

<span data-ttu-id="980a9-105">El multiplexor tiene una entrada y una salida.</span><span class="sxs-lookup"><span data-stu-id="980a9-105">The multiplexer has one input and one output.</span></span> <span data-ttu-id="980a9-106">Recibe un ejemplo de secuencia que contiene datos multimedia digitales y genera uno o más paquetes de datos que se pueden escribir en un contenedor ASF.</span><span class="sxs-lookup"><span data-stu-id="980a9-106">It receives a stream sample that contains digital media data and produces one or more data packet that can be written to an ASF container.</span></span>

<span data-ttu-id="980a9-107">En la lista siguiente se resume el proceso de generación de paquetes de datos ASF:</span><span class="sxs-lookup"><span data-stu-id="980a9-107">The following list summarizes the process of generating ASF data packets:</span></span>

1.  <span data-ttu-id="980a9-108">Pase los datos de entrada al multiplexor en [**IMFASFMultiplexer::P rocesssample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span><span class="sxs-lookup"><span data-stu-id="980a9-108">Pass input data to the multiplexer in [**IMFASFMultiplexer::ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span></span>
2.  <span data-ttu-id="980a9-109">Recopile los paquetes de datos mediante una llamada a [**IMFASFMultiplexer:: GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) en un bucle hasta que se hayan recuperado todos los paquetes completos.</span><span class="sxs-lookup"><span data-stu-id="980a9-109">Collect the data packets by calling [**IMFASFMultiplexer::GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) in a loop until all the complete packets have been retrieved.</span></span>
3.  <span data-ttu-id="980a9-110">Una vez que los datos de entrada se han convertido en paquetes completos, es posible que haya algunos datos pendientes en el multiplexor, que no se recuperaron mediante [**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket).</span><span class="sxs-lookup"><span data-stu-id="980a9-110">After the input data has been converted into complete packets there might be some pending data in the multiplexer, which was not retrieved by [**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket).</span></span> <span data-ttu-id="980a9-111">Llame a [**IMFASFMultiplexer:: Flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush) para agrupar los ejemplos pendientes y recopilarlos del multiplexor llamando de nuevo a **GetNextPacket** .</span><span class="sxs-lookup"><span data-stu-id="980a9-111">Call [**IMFASFMultiplexer::Flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush) to packetize the pending samples and collect them from the multiplexer by calling **GetNextPacket** again.</span></span>
4.  <span data-ttu-id="980a9-112">Actualice los objetos de encabezado ASF asociados llamando a [**IMFASFMultiplexer:: end**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) para reflejar los cambios realizados por el multiplexor durante la generación de paquetes de datos.</span><span class="sxs-lookup"><span data-stu-id="980a9-112">Update the associated ASF Header Objects by calling [**IMFASFMultiplexer::End**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) to reflect changes made by the multiplexer during data packet generation.</span></span>

<span data-ttu-id="980a9-113">En el diagrama siguiente se ilustra la generación de paquetes de datos para un archivo ASF a través del multiplexor.</span><span class="sxs-lookup"><span data-stu-id="980a9-113">The following diagram illustrates data packet generation for an ASF file through the multiplexer.</span></span>

![diagrama que muestra la generación de paquetes de datos para un archivo ASF](images/packet.gif)

## <a name="asf-data-packet-creation"></a><span data-ttu-id="980a9-115">Creación de paquetes de datos ASF</span><span class="sxs-lookup"><span data-stu-id="980a9-115">ASF Data Packet Creation</span></span>

<span data-ttu-id="980a9-116">Después de crear e inicializar el multiplexor tal y como se describe en [crear el objeto multiplexor](creating-the-multiplexer-object.md), llame a [**IMFASFMultiplexer::P rocesssample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) para pasar datos de entrada al multiplexor para su procesamiento en paquetes de datos.</span><span class="sxs-lookup"><span data-stu-id="980a9-116">After creating and initializing the multiplexer as described in [Creating the Multiplexer Object](creating-the-multiplexer-object.md), call [**IMFASFMultiplexer::ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) to pass input data to the multiplexer for processing into data packets.</span></span> <span data-ttu-id="980a9-117">La entrada especificada debe estar en un ejemplo multimedia (interfaz [**IMFSample**](/windows/desktop/api/mfobjects/nn-mfobjects-imfsample) ) que pueda tener uno o más búferes multimedia (interfaz [**IMFMediaBuffer**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediabuffer) ) que contenga los datos de una secuencia.</span><span class="sxs-lookup"><span data-stu-id="980a9-117">The specified input must be in a media sample ([**IMFSample**](/windows/desktop/api/mfobjects/nn-mfobjects-imfsample) interface) that can have one or more media buffers ([**IMFMediaBuffer**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediabuffer) interface) containing the data for a stream.</span></span> <span data-ttu-id="980a9-118">En el caso de la transcodificación ASF a ASF, el ejemplo de medios de entrada se puede generar a partir del divisor que crea ejemplos de secuencias de paquetes.</span><span class="sxs-lookup"><span data-stu-id="980a9-118">In case of ASF-to-ASF transcoding, the input media sample can be generated from the splitter that creates packetized stream samples.</span></span> <span data-ttu-id="980a9-119">Para obtener más información, consulte separador [ASF](asf-splitter.md).</span><span class="sxs-lookup"><span data-stu-id="980a9-119">For more information, see [ASF Splitter](asf-splitter.md).</span></span>

<span data-ttu-id="980a9-120">Antes de llamar a [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample), asegúrese de que la marca de tiempo del ejemplo de medios de entrada es un tiempo de presentación válido; de lo contrario, **ProcessSample** produce un error y devuelve el código de marca de tiempo MF \_ e \_ no \_ \_ .</span><span class="sxs-lookup"><span data-stu-id="980a9-120">Before calling [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample), make sure that the time stamp of the input media sample is a valid presentation time; otherwise **ProcessSample** fails and returns the MF\_E\_NO\_SAMPLE\_TIMESTAMP code.</span></span>

<span data-ttu-id="980a9-121">El multiplexor puede aceptar la entrada como muestras de medios comprimidos o sin comprimir a través de [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span><span class="sxs-lookup"><span data-stu-id="980a9-121">The multiplexer can accept input as compressed or uncompressed media samples through [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span></span> <span data-ttu-id="980a9-122">El multiplexor asigna horas de envío a estos ejemplos en función del uso de ancho de banda de la secuencia.</span><span class="sxs-lookup"><span data-stu-id="980a9-122">The multiplexer assigns send times to these samples depending on the bandwidth usage of the stream.</span></span> <span data-ttu-id="980a9-123">Durante este proceso, el multiplexor comprueba los parámetros del depósito de fugas (velocidad de bits y uso de la ventana de búfer) y puede rechazar ejemplos que no se adhieren a esos valores.</span><span class="sxs-lookup"><span data-stu-id="980a9-123">During this process, the multiplexer checks the leaky bucket parameters (bit rate and buffer window utilization) and can reject samples that do not adhere to those values.</span></span> <span data-ttu-id="980a9-124">El ejemplo de medio de entrada puede producir un error en la comprobación de ancho de banda por alguno de los siguientes motivos:</span><span class="sxs-lookup"><span data-stu-id="980a9-124">The input media sample can fail the bandwidth check for either of the following reasons:</span></span>

-   <span data-ttu-id="980a9-125">Si el ejemplo de medio de entrada llega tarde porque la última hora de envío asignada es mayor que la marca de tiempo de este ejemplo multimedia.</span><span class="sxs-lookup"><span data-stu-id="980a9-125">If the input media sample arrived late because the last-assigned send time is greater than the time stamp on this media sample.</span></span> <span data-ttu-id="980a9-126">[**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) produce un error y devuelve el código de error de **\_ ejemplo MF e en \_ tiempo de ejecución \_** .</span><span class="sxs-lookup"><span data-stu-id="980a9-126">[**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) fails and returns the **MF\_E\_LATE\_SAMPLE** error code.</span></span>
-   <span data-ttu-id="980a9-127">Si la marca de tiempo en el ejemplo de medio de entrada es anterior a la hora de envío asignada (esto indica el desbordamiento del búfer).</span><span class="sxs-lookup"><span data-stu-id="980a9-127">If the time stamp on the input media sample is earlier than the assigned send time (this indicates buffer overflow).</span></span> <span data-ttu-id="980a9-128">El multiplexor puede omitir esta situación si está configurada para ajustar la velocidad de bits mediante el establecimiento de la marca de velocidad de bits **\_ \_ autoajuste \_ del multiplexor de MFASF** durante la inicialización del multiplexor.</span><span class="sxs-lookup"><span data-stu-id="980a9-128">The multiplexer can ignore this situation if it is configured to adjust the bit rate by setting the **MFASF\_MULTIPLEXER\_AUTOADJUST\_BITRATE** flag during multiplexer initialization.</span></span> <span data-ttu-id="980a9-129">Para obtener más información, vea "configuración de la inicialización del multiplexor y del depósito de fugas" en [crear el objeto multiplexor](creating-the-multiplexer-object.md).</span><span class="sxs-lookup"><span data-stu-id="980a9-129">For more information, see "Multiplexer Initialization and Leaky Bucket Settings" in [Creating the Multiplexer Object](creating-the-multiplexer-object.md).</span></span> <span data-ttu-id="980a9-130">Si no se establece esta marca y el multiplexor detecta la saturación del ancho de banda, [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) produce un error y devuelve el código de error de saturación de **ancho de banda de MF \_ E \_ \_** .</span><span class="sxs-lookup"><span data-stu-id="980a9-130">If this flag is not set and the multiplexer encounters bandwidth overrun, [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) fails and returns the **MF\_E\_BANDWIDTH\_OVERRUN** error code.</span></span>

<span data-ttu-id="980a9-131">Una vez que el multiplexor asigna la hora de envío, el ejemplo de medio de entrada se agrega a la *ventana de envío*: una lista de ejemplos de medios de entrada ordenados por horas de envío y listas para su procesamiento en paquetes de datos.</span><span class="sxs-lookup"><span data-stu-id="980a9-131">After the multiplexer assigns the send time, the input media sample is added to the *send window*—a list of input media samples ordered by send times and ready to be processed into data packets.</span></span> <span data-ttu-id="980a9-132">Durante la construcción de paquetes de datos, se analiza el ejemplo de medios de entrada y los datos relevantes se escriben en un paquete de datos como carga.</span><span class="sxs-lookup"><span data-stu-id="980a9-132">During data packet construction, the input media sample is parsed and relevant data is written to a data packet as payload.</span></span> <span data-ttu-id="980a9-133">Un paquete de datos completo puede contener datos de uno o más ejemplos de medios de entrada.</span><span class="sxs-lookup"><span data-stu-id="980a9-133">A complete data packet can contain data from one or more input media samples.</span></span>

<span data-ttu-id="980a9-134">Cuando llegan los nuevos ejemplos de medios de entrada en la ventana de envío, se agregan a una cola hasta que hay suficientes ejemplos de medios para formar un paquete completo.</span><span class="sxs-lookup"><span data-stu-id="980a9-134">When new input media samples arrive in the send window, they are added to a queue until there are enough media samples to form one complete packet.</span></span> <span data-ttu-id="980a9-135">Los datos de los búferes multimedia contenidos en el ejemplo de medios de entrada no se copian en el paquete de datos generado.</span><span class="sxs-lookup"><span data-stu-id="980a9-135">The data in media buffers contained by the input media sample are not copied to the generated data packet.</span></span> <span data-ttu-id="980a9-136">El paquete de datos mantiene referencias a los búferes de los medios de entrada hasta que el ejemplo de medios de entrada se ha descargado por completo y se ha recopilado el paquete completo del multiplexor.</span><span class="sxs-lookup"><span data-stu-id="980a9-136">The data packet hold references to the input media buffers until the input media sample has been fully packetized and the complete packet have been collected from the multiplexer.</span></span>

<span data-ttu-id="980a9-137">Cuando hay un paquete de datos completo disponible, se puede recuperar llamando a [**IMFASFMultiplexer:: GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket).</span><span class="sxs-lookup"><span data-stu-id="980a9-137">When a complete data packet is available, it can be retrieved by calling [**IMFASFMultiplexer::GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket).</span></span> <span data-ttu-id="980a9-138">Si llama a [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) mientras hay paquetes completos listos para su recuperación, se produce un error y se devuelve el código de error **MF \_ e \_ NOTACCEPTING** .</span><span class="sxs-lookup"><span data-stu-id="980a9-138">If you call [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) while there are complete packets ready for retrieval, it fails and returns the **MF\_E\_NOTACCEPTING** error code.</span></span> <span data-ttu-id="980a9-139">Esto indica que el multiplexor no puede aceptar más entradas y debe llamar a **GetNextPacket** para recuperar los paquetes en espera.</span><span class="sxs-lookup"><span data-stu-id="980a9-139">This indicates that the multiplexer cannot accept more input and you must call **GetNextPacket** to retrieve the waiting packets.</span></span> <span data-ttu-id="980a9-140">Idealmente, todas las llamadas a **ProcessSample** deben ir seguidas de una o varias llamadas de **GetNextPacket** para obtener los paquetes de datos completos.</span><span class="sxs-lookup"><span data-stu-id="980a9-140">Ideally, every **ProcessSample** call should be followed by one or more **GetNextPacket** calls to get the complete data packets.</span></span> <span data-ttu-id="980a9-141">Puede tomar más de un ejemplo de medios de entrada para crear un paquete de datos completo.</span><span class="sxs-lookup"><span data-stu-id="980a9-141">It may take more than one input media sample to create a complete data packet.</span></span> <span data-ttu-id="980a9-142">Por el contrario, los datos de un ejemplo de medios de entrada pueden abarcar varios paquetes.</span><span class="sxs-lookup"><span data-stu-id="980a9-142">Conversely, data in one input media sample might span multiple packets.</span></span> <span data-ttu-id="980a9-143">Por lo tanto, no todas las llamadas a **ProcessSample** producirán ejemplos de medios de salida.</span><span class="sxs-lookup"><span data-stu-id="980a9-143">Therefore, not all calls to **ProcessSample** will yield output media samples.</span></span>

<span data-ttu-id="980a9-144">Si el ejemplo de medio de entrada contiene un fotograma clave indicado por el atributo [**\_ CleanPoint de MFSampleExtension**](mfsampleextension-cleanpoint-attribute.md) , el multiplexor copia el atributo en el paquete.</span><span class="sxs-lookup"><span data-stu-id="980a9-144">If the input media sample contains a key frame indicated by the [**MFSampleExtension\_CleanPoint**](mfsampleextension-cleanpoint-attribute.md) attribute, the multiplexer copies the attribute to the packet.</span></span>

## <a name="getting-asf-data-packets"></a><span data-ttu-id="980a9-145">Obtener paquetes de datos ASF</span><span class="sxs-lookup"><span data-stu-id="980a9-145">Getting ASF Data Packets</span></span>

<span data-ttu-id="980a9-146">Para recopilar los ejemplos de medios de salida de un paquete de datos completo generado por el multiplexor, llame a [**IMFASFMultiplexer:: GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) en un bucle hasta que no queden más muestras de medios de salida para el paquete.</span><span class="sxs-lookup"><span data-stu-id="980a9-146">To collect the output media samples for a complete data packet generated by the multiplexer, call [**IMFASFMultiplexer::GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) in a loop until there are no more output media samples left for the packet.</span></span> <span data-ttu-id="980a9-147">A continuación se enumeran los casos de éxito:</span><span class="sxs-lookup"><span data-stu-id="980a9-147">The following lists the success cases:</span></span>

-   <span data-ttu-id="980a9-148">Si hay un paquete de datos completo disponible, [**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) recibe la marca **ASF \_ status \_ Flags \_ incompleta** en el parámetro *pdwStatusFlags* ; el parámetro *ppIPacket* recibe un puntero al primer paquete de datos.</span><span class="sxs-lookup"><span data-stu-id="980a9-148">If there is a complete data packet available, [**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) receives the **ASF\_STATUS\_FLAGS\_INCOMPLETE** flag in the *pdwStatusFlags* parameter; the *ppIPacket* parameter receives a pointer to the first data packet.</span></span> <span data-ttu-id="980a9-149">Debe llamar a este método siempre que reciba esta marca.</span><span class="sxs-lookup"><span data-stu-id="980a9-149">You must call this method as long it receives this flag.</span></span> <span data-ttu-id="980a9-150">Con cada iteración, *ppIPacket* apunta al siguiente paquete de la cola.</span><span class="sxs-lookup"><span data-stu-id="980a9-150">With every iteration, *ppIPacket* points to the next packet in the queue.</span></span>
-   <span data-ttu-id="980a9-151">Si solo hay un paquete de datos, *ppIPacket* apunta a él y no se recibe la marca de **marcas de estado de ASF \_ \_ \_ incompletas** en *pdwStatusFlags*.</span><span class="sxs-lookup"><span data-stu-id="980a9-151">If there is only one data packet, *ppIPacket* points to it and the **ASF\_STATUS\_FLAGS\_INCOMPLETE** flag is not received in *pdwStatusFlags*.</span></span>
-   <span data-ttu-id="980a9-152">[**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) puede realizarse sin producir paquetes de datos si el multiplexor todavía está en proceso de paquetes y agregando paquetes de datos.</span><span class="sxs-lookup"><span data-stu-id="980a9-152">[**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) can succeed without yielding any data packets if the multiplexer is still in the process of packetizing and adding data packets.</span></span> <span data-ttu-id="980a9-153">En este caso, *ppIPacket* apunta a **null**.</span><span class="sxs-lookup"><span data-stu-id="980a9-153">In this case, *ppIPacket* points to **NULL**.</span></span> <span data-ttu-id="980a9-154">Para continuar, debe proporcionar al multiplexor más ejemplos de medios de entrada mediante una llamada a [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span><span class="sxs-lookup"><span data-stu-id="980a9-154">To proceed, you must provide the multiplexer with more input media samples by calling [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span></span>

<span data-ttu-id="980a9-155">En el ejemplo de código siguiente se muestra una función que genera paquetes de datos mediante el multiplexor.</span><span class="sxs-lookup"><span data-stu-id="980a9-155">The following example code shows a function that generates data packets by using the multiplexer.</span></span> <span data-ttu-id="980a9-156">El contenido del paquete de datos generado se escribirá en la secuencia de bytes de datos asignada por el llamador.</span><span class="sxs-lookup"><span data-stu-id="980a9-156">The generated data packet contents will be written to the data byte stream allocated by the caller.</span></span>


```C++
//-------------------------------------------------------------------
// GenerateASFDataPackets
// 
// Gets data packets from the mux. This function is called after 
// calling IMFASFMultiplexer::ProcessSample. 
//-------------------------------------------------------------------

HRESULT GenerateASFDataPackets( 
    IMFASFMultiplexer *pMux, 
    IMFByteStream *pDataStream
    )
{
    HRESULT hr = S_OK;

    IMFSample *pOutputSample = NULL;
    IMFMediaBuffer *pDataPacketBuffer = NULL;

    DWORD dwMuxStatus = ASF_STATUSFLAGS_INCOMPLETE;

    while (dwMuxStatus & ASF_STATUSFLAGS_INCOMPLETE)
    {
        hr = pMux->GetNextPacket(&dwMuxStatus, &pOutputSample);

        if (FAILED(hr))
        {
            break;
        }

        if (pOutputSample)
        {
            //Convert to contiguous buffer
            hr = pOutputSample->ConvertToContiguousBuffer(&pDataPacketBuffer);
            
            if (FAILED(hr))
            {
                break;
            }

            //Write buffer to byte stream
            hr = WriteBufferToByteStream(pDataStream, pDataPacketBuffer, NULL);

            if (FAILED(hr))
            {
                break;
            }
        }

        SafeRelease(&pDataPacketBuffer);
        SafeRelease(&pOutputSample);
    }

    SafeRelease(&pOutputSample);
    SafeRelease(&pDataPacketBuffer);
    return hr;
}
```



<span data-ttu-id="980a9-157">La `WriteBufferToByteStream` función se muestra en el tema [**IMFByteStream:: Write**](/windows/desktop/api/mfobjects/nf-mfobjects-imfbytestream-write).</span><span class="sxs-lookup"><span data-stu-id="980a9-157">The `WriteBufferToByteStream` function is shown in the topic [**IMFByteStream::Write**](/windows/desktop/api/mfobjects/nf-mfobjects-imfbytestream-write).</span></span>

<span data-ttu-id="980a9-158">Para ver una aplicación completa que utiliza este ejemplo de código, vea [Tutorial: copiar secuencias ASF de un archivo a otro](tutorial--copying-asf-streams-from-one-file-to-another.md).</span><span class="sxs-lookup"><span data-stu-id="980a9-158">To see a complete application that uses this code example, see [Tutorial: Copying ASF Streams from One File to Another](tutorial--copying-asf-streams-from-one-file-to-another.md).</span></span>

## <a name="post-packet-generation-calls"></a><span data-ttu-id="980a9-159">Llamadas Packet-Generation posteriores</span><span class="sxs-lookup"><span data-stu-id="980a9-159">Post Packet-Generation Calls</span></span>

<span data-ttu-id="980a9-160">Para asegurarse de que no haya paquetes de datos completos en espera en el multiplexor, llame a [**IMFASFMultiplexer:: Flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush).</span><span class="sxs-lookup"><span data-stu-id="980a9-160">To make sure that there are no complete data packets waiting in the multiplexer, call [**IMFASFMultiplexer::Flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush).</span></span> <span data-ttu-id="980a9-161">Esto obliga al multiplexor a paquetes a todos los ejemplos de medios que están en curso.</span><span class="sxs-lookup"><span data-stu-id="980a9-161">This forces the multiplexer to packetize all the media samples that are in progress.</span></span> <span data-ttu-id="980a9-162">La aplicación puede recopilar estos paquetes en forma de muestras de medios a través de **GetNextPacket** en un bucle hasta que no quedan más paquetes para recuperar.</span><span class="sxs-lookup"><span data-stu-id="980a9-162">The application can collect these packets in form of media samples through **GetNextPacket** in a loop until there are no more packets left to be retrieved.</span></span>

<span data-ttu-id="980a9-163">Una vez generados todos los ejemplos de medios, llame a [**IMFASFMultiplexer:: end**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) para actualizar el objeto de encabezado ASF que está asociado a estos paquetes de datos.</span><span class="sxs-lookup"><span data-stu-id="980a9-163">After all the media samples are generated, call [**IMFASFMultiplexer::End**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) to update the ASF Header Object that is associated with these data packets.</span></span> <span data-ttu-id="980a9-164">El objeto de encabezado se especifica pasando el objeto ContentInfo que se usó para inicializar el multiplexor.</span><span class="sxs-lookup"><span data-stu-id="980a9-164">The Header Object is specified by passing the ContentInfo object that was used to initialize the multiplexer.</span></span> <span data-ttu-id="980a9-165">Esta llamada actualiza varios objetos de encabezado para reflejar los cambios realizados por el multiplexor durante la generación de paquetes de datos.</span><span class="sxs-lookup"><span data-stu-id="980a9-165">This call updates various Header Objects to reflect changes made by the multiplexer during data packet generation.</span></span> <span data-ttu-id="980a9-166">Esta información incluye el número de paquetes, la duración del envío, la duración de la reproducción y los números de secuencia de todos los flujos.</span><span class="sxs-lookup"><span data-stu-id="980a9-166">This information includes packet count, send duration, play duration, and stream numbers of all the streams.</span></span> <span data-ttu-id="980a9-167">También se actualiza el tamaño total del encabezado.</span><span class="sxs-lookup"><span data-stu-id="980a9-167">The overall header size is also updated.</span></span>

<span data-ttu-id="980a9-168">Debe asegurarse de que se llama a [**End**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) una vez recuperados todos los paquetes de datos.</span><span class="sxs-lookup"><span data-stu-id="980a9-168">You must ensure that [**End**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) is called after all the data packets have been retrieved.</span></span> <span data-ttu-id="980a9-169">Si hay paquetes en espera en el multiplexor, **End** producirá un error y devolverá el código de error de **\_ vaciado de MF E \_ \_ necesario** .</span><span class="sxs-lookup"><span data-stu-id="980a9-169">If there are any packets waiting in the multiplexer, **End** will fail and return the **MF\_E\_FLUSH\_NEEDED** error code.</span></span> <span data-ttu-id="980a9-170">En este caso, obtenga el paquete en espera llamando a [**Flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush) y [**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) en un bucle.</span><span class="sxs-lookup"><span data-stu-id="980a9-170">In this case, get the waiting packet by calling [**Flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush) and [**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) in a loop.</span></span>

> [!Note]  
> <span data-ttu-id="980a9-171">En el caso de la codificación VBR, después de llamar a **End**, debe establecer las estadísticas de codificación en las propiedades de codificación del objeto ContentInfo.</span><span class="sxs-lookup"><span data-stu-id="980a9-171">For VBR encoding, after calling **End**, you must set the encoding statistics in the ContentInfo object's encoding properties.</span></span> <span data-ttu-id="980a9-172">Para obtener información sobre este proceso, vea "configurar el objeto ContentInfo con la configuración del codificador" en [establecer propiedades en el objeto ContentInfo](setting-properties-in-the-contentinfo-object.md).</span><span class="sxs-lookup"><span data-stu-id="980a9-172">For information about this process, see "Configuring the ContentInfo Object with Encoder Settings" in [Setting Properties in the ContentInfo Object](setting-properties-in-the-contentinfo-object.md).</span></span> <span data-ttu-id="980a9-173">En la lista siguiente se muestran las propiedades específicas que se deben establecer:</span><span class="sxs-lookup"><span data-stu-id="980a9-173">The following list shows the specific properties to set:</span></span>
>
> -   <span data-ttu-id="980a9-174">[**MFPKEY \_ RAVG**](mfpkey-ravgproperty.md) es la velocidad de bits promedio del contenido de VBR.</span><span class="sxs-lookup"><span data-stu-id="980a9-174">[**MFPKEY\_RAVG**](mfpkey-ravgproperty.md) is the average bit rate of the VBR content.</span></span>
> -   <span data-ttu-id="980a9-175">[**MFPKEY \_ BAVG**](mfpkey-bavgproperty.md) es la ventana de búfer para la velocidad de bits media.</span><span class="sxs-lookup"><span data-stu-id="980a9-175">[**MFPKEY\_BAVG**](mfpkey-bavgproperty.md) is the buffer window for the average bit rate.</span></span>
> -   <span data-ttu-id="980a9-176">[**MFPKEY \_ RMAX**](mfpkey-rmaxproperty.md) es la velocidad de bits máxima del contenido de VBR.</span><span class="sxs-lookup"><span data-stu-id="980a9-176">[**MFPKEY\_RMAX**](mfpkey-rmaxproperty.md) is the peak bit rate of the VBR content.</span></span>
> -   <span data-ttu-id="980a9-177">[**MFPKEY \_ BMAX**](mfpkey-bmaxproperty.md) es la ventana de búfer máximo.</span><span class="sxs-lookup"><span data-stu-id="980a9-177">[**MFPKEY\_BMAX**](mfpkey-bmaxproperty.md) is the peak buffer window.</span></span>

 

## <a name="related-topics"></a><span data-ttu-id="980a9-178">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="980a9-178">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="980a9-179">Multiplexor ASF</span><span class="sxs-lookup"><span data-stu-id="980a9-179">ASF Multiplexer</span></span>](asf-multiplexer.md)
</dt> <dt>

[<span data-ttu-id="980a9-180">Tutorial: copiar secuencias ASF de un archivo a otro</span><span class="sxs-lookup"><span data-stu-id="980a9-180">Tutorial: Copying ASF Streams from One File to Another</span></span>](tutorial--copying-asf-streams-from-one-file-to-another.md)
</dt> <dt>

[<span data-ttu-id="980a9-181">Tutorial: escribir un archivo WMA con codificación CBR</span><span class="sxs-lookup"><span data-stu-id="980a9-181">Tutorial: Writing a WMA File by Using CBR Encoding</span></span>](tutorial--writing-a-wma-file-by-using-cbr-encoding.md)
</dt> </dl>

 

 



