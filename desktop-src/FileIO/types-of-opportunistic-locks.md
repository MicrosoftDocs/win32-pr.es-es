---
description: Describe los bloqueos oportunistas de nivel 1, nivel 2, Batch y Filter.
ms.assetid: 06136348-0c08-4e9c-9c96-fd3af33cbdc0
title: Tipos de bloqueos oportunistas
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a755a6ff766f5d19e13d4b269c1ba4bb9803e934
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/08/2021
ms.locfileid: "103912309"
---
# <a name="types-of-opportunistic-locks"></a><span data-ttu-id="4f764-103">Tipos de bloqueos oportunistas</span><span class="sxs-lookup"><span data-stu-id="4f764-103">Types of Opportunistic Locks</span></span>

<span data-ttu-id="4f764-104">Las operaciones de bloqueo oportunista funcionan con cuatro tipos de bloqueos oportunistas: nivel 1, nivel 2, lote y filtro.</span><span class="sxs-lookup"><span data-stu-id="4f764-104">The opportunistic lock operations work with four types of opportunistic locks: level 1, level 2, batch, and filter.</span></span> <span data-ttu-id="4f764-105">Los *bloqueos oportunistas exclusivos* son los bloqueos de nivel 1, lote y filtro.</span><span class="sxs-lookup"><span data-stu-id="4f764-105">*Exclusive opportunistic locks* are level 1, batch, and filter locks.</span></span> <span data-ttu-id="4f764-106">Si un subproceso tiene cualquier tipo de bloqueo exclusivo en un archivo, tampoco puede tener un bloqueo de nivel 2 en el mismo archivo.</span><span class="sxs-lookup"><span data-stu-id="4f764-106">If a thread has any type of exclusive lock on a file, it cannot also have a level 2 lock on the same file.</span></span>

## <a name="level-1-opportunistic-locks"></a><span data-ttu-id="4f764-107">Bloqueos oportunistas de nivel 1</span><span class="sxs-lookup"><span data-stu-id="4f764-107">Level 1 Opportunistic Locks</span></span>

<span data-ttu-id="4f764-108">Un bloqueo oportunista de nivel 1 en un archivo permite a un cliente leer con anterioridad en el archivo y almacenar en caché datos de lectura y escritura desde el archivo localmente.</span><span class="sxs-lookup"><span data-stu-id="4f764-108">A level 1 opportunistic lock on a file allows a client to read ahead in the file and cache both read-ahead and write data from the file locally.</span></span> <span data-ttu-id="4f764-109">Siempre que el cliente tenga acceso único a un archivo, no habrá ningún peligro en la coherencia de los datos al proporcionar un bloqueo oportunista de nivel 1.</span><span class="sxs-lookup"><span data-stu-id="4f764-109">As long as the client has sole access to a file, there is no danger to data coherency in providing a level 1 opportunistic lock.</span></span>

<span data-ttu-id="4f764-110">El cliente puede solicitar un bloqueo oportunista de nivel 1 después de abrir un archivo.</span><span class="sxs-lookup"><span data-stu-id="4f764-110">The client can request a level 1 opportunistic lock after opening a file.</span></span> <span data-ttu-id="4f764-111">Si ningún otro cliente (o ningún otro subproceso en el mismo cliente) tiene abierto el archivo, el servidor puede conceder el bloqueo oportunista.</span><span class="sxs-lookup"><span data-stu-id="4f764-111">If no other client (or no other thread on the same client) has the file open, the server may grant the opportunistic lock.</span></span> <span data-ttu-id="4f764-112">Después, el cliente puede almacenar en caché los datos de lectura y escritura del archivo localmente.</span><span class="sxs-lookup"><span data-stu-id="4f764-112">The client can then cache read and write data from the file locally.</span></span> <span data-ttu-id="4f764-113">Si otro cliente ha abierto el archivo, el servidor rechaza el bloqueo oportunista y el cliente no realiza almacenamiento en caché local.</span><span class="sxs-lookup"><span data-stu-id="4f764-113">If another client has opened the file, then the server refuses the opportunistic lock and the client does no local caching.</span></span> <span data-ttu-id="4f764-114">(El servidor puede rechazar el bloqueo oportunista por otras razones, como no admitir bloqueos oportunistas).</span><span class="sxs-lookup"><span data-stu-id="4f764-114">(The server may refuse the opportunistic lock for other reasons as well, such as not supporting opportunistic locks.)</span></span>

<span data-ttu-id="4f764-115">Cuando el servidor abre un archivo que ya tiene un bloqueo oportunista de nivel 1 en él, el servidor examina el estado de uso compartido del archivo antes de interrumpir el bloqueo oportunista de nivel 1.</span><span class="sxs-lookup"><span data-stu-id="4f764-115">When the server opens a file that already has a level 1 opportunistic lock on it, the server examines the sharing state of the file before it breaks the level 1 opportunistic lock.</span></span> <span data-ttu-id="4f764-116">Si el servidor interrumpe el bloqueo después de este examen, el tiempo que el cliente con el bloqueo anterior invierte en la caché de escritura es el momento en que el cliente que solicita el archivo debe esperar.</span><span class="sxs-lookup"><span data-stu-id="4f764-116">If the server breaks the lock after this examination, the time the client with the former lock spends flushing its write cache is time the client requesting the file must wait.</span></span> <span data-ttu-id="4f764-117">Este gasto de tiempo significa que los bloqueos oportunistas de nivel 1 deben evitarse en los archivos que muchos clientes abren.</span><span class="sxs-lookup"><span data-stu-id="4f764-117">This time expenditure means that level 1 opportunistic locks should be avoided on files that many clients open.</span></span>

<span data-ttu-id="4f764-118">Sin embargo, dado que el servidor comprueba el estado de uso compartido antes de que interrumpa el bloqueo, en el caso en el que el servidor denegaría una solicitud abierta debido a un conflicto de uso compartido, el servidor no interrumpirá el bloqueo.</span><span class="sxs-lookup"><span data-stu-id="4f764-118">However, because the server checks the sharing state before it breaks the lock, in the case where the server would deny an open request due to a sharing conflict the server does not break the lock.</span></span> <span data-ttu-id="4f764-119">Por ejemplo, si ha abierto un archivo, ha denegado el uso compartido de las operaciones de escritura y ha obtenido un bloqueo de nivel 1, el servidor deniega la solicitud de otro cliente para abrir el archivo para su escritura antes de que incluso examine el bloqueo en el archivo.</span><span class="sxs-lookup"><span data-stu-id="4f764-119">For example, if you have opened a file, denied sharing for write operations, and obtained a level 1 lock, the server denies another client's request to open the file for writing before it even examines your lock on the file.</span></span> <span data-ttu-id="4f764-120">En esta instancia, el bloqueo oportunista no se interrumpe.</span><span class="sxs-lookup"><span data-stu-id="4f764-120">In this instance, your opportunistic lock is not broken.</span></span>

<span data-ttu-id="4f764-121">Para ver un ejemplo de cómo funciona un bloqueo oportunista de nivel 1, consulte el ejemplo de bloqueo oportunista de nivel 1.</span><span class="sxs-lookup"><span data-stu-id="4f764-121">For an example of how a level 1 opportunistic lock works, see Level 1 Opportunistic Lock Example.</span></span> <span data-ttu-id="4f764-122">Para obtener más información sobre cómo interrumpir los bloqueos oportunistas, vea [romper bloqueos oportunistas](breaking-opportunistic-locks.md).</span><span class="sxs-lookup"><span data-stu-id="4f764-122">For more information on breaking opportunistic locks, see [Breaking Opportunistic Locks](breaking-opportunistic-locks.md).</span></span>

## <a name="level-2-opportunistic-locks"></a><span data-ttu-id="4f764-123">Bloqueos oportunistas de nivel 2</span><span class="sxs-lookup"><span data-stu-id="4f764-123">Level 2 Opportunistic Locks</span></span>

<span data-ttu-id="4f764-124">Un bloqueo oportunista de nivel 2 informa a un cliente de que hay varios clientes simultáneos de un archivo y que ninguno lo ha modificado todavía.</span><span class="sxs-lookup"><span data-stu-id="4f764-124">A level 2 opportunistic lock informs a client that there are multiple concurrent clients of a file and that none has yet modified it.</span></span> <span data-ttu-id="4f764-125">Este bloqueo permite al cliente realizar operaciones de lectura y obtener atributos de archivo mediante la información local en caché o de lectura previa, pero el cliente debe enviar al servidor todas las demás solicitudes (por ejemplo, para las operaciones de escritura).</span><span class="sxs-lookup"><span data-stu-id="4f764-125">This lock allows the client to perform read operations and obtain file attributes using cached or read-ahead local information, but the client must send all other requests (such as for write operations) to the server.</span></span> <span data-ttu-id="4f764-126">La aplicación debe usar el bloqueo oportunista de nivel 2 cuando espera que otras aplicaciones escriban en el archivo de forma aleatoria o lean el archivo de forma aleatoria o secuencial.</span><span class="sxs-lookup"><span data-stu-id="4f764-126">Your application should use the level 2 opportunistic lock when you expect other applications to write to the file at random or read the file at random or sequentially.</span></span>

<span data-ttu-id="4f764-127">Un bloqueo oportunista de nivel 2 es muy similar a un bloqueo oportunista de filtro.</span><span class="sxs-lookup"><span data-stu-id="4f764-127">A level 2 opportunistic lock is very similar to a filter opportunistic lock.</span></span> <span data-ttu-id="4f764-128">En la mayoría de los casos, la aplicación debe usar el bloqueo oportunista de nivel 2.</span><span class="sxs-lookup"><span data-stu-id="4f764-128">In most situations, your application should use the level 2 opportunistic lock.</span></span> <span data-ttu-id="4f764-129">Use solo el bloqueo de filtro si no desea que las operaciones de lectura estén abiertas para que se produzcan infracciones del modo de uso compartido en el intervalo de tiempo entre la aplicación que abre el archivo y recibe el bloqueo.</span><span class="sxs-lookup"><span data-stu-id="4f764-129">Only use the filter lock if you do not want open operations for reading to cause sharing-mode violations in the time span between your application's opening the file and receiving the lock.</span></span> <span data-ttu-id="4f764-130">Para obtener más información, vea filtrar bloqueos oportunistas y [respuesta del servidor para abrir solicitudes en archivos bloqueados](server-response-to-open-requests-on-locked-files.md).</span><span class="sxs-lookup"><span data-stu-id="4f764-130">For more information, see Filter Opportunistic Locks and [Server Response to Open Requests on Locked Files](server-response-to-open-requests-on-locked-files.md).</span></span>

<span data-ttu-id="4f764-131">Para obtener más información sobre cómo interrumpir los bloqueos oportunistas, vea [romper bloqueos oportunistas](breaking-opportunistic-locks.md).</span><span class="sxs-lookup"><span data-stu-id="4f764-131">For more information on breaking opportunistic locks, see [Breaking Opportunistic Locks](breaking-opportunistic-locks.md).</span></span>

## <a name="batch-opportunistic-locks"></a><span data-ttu-id="4f764-132">Bloqueos oportunistas por lotes</span><span class="sxs-lookup"><span data-stu-id="4f764-132">Batch Opportunistic Locks</span></span>

<span data-ttu-id="4f764-133">Un bloqueo oportunista por lotes manipula las aperturas de archivos y los cierres.</span><span class="sxs-lookup"><span data-stu-id="4f764-133">A batch opportunistic lock manipulates file openings and closings.</span></span> <span data-ttu-id="4f764-134">Por ejemplo, en la ejecución de un archivo por lotes, el archivo por lotes se puede abrir y cerrar una vez por cada línea del archivo.</span><span class="sxs-lookup"><span data-stu-id="4f764-134">For example, in the execution of a batch file, the batch file may be opened and closed once for each line of the file.</span></span> <span data-ttu-id="4f764-135">Un bloqueo oportunista por lotes abre el archivo por lotes en el servidor y lo mantiene abierto.</span><span class="sxs-lookup"><span data-stu-id="4f764-135">A batch opportunistic lock opens the batch file on the server and keeps it open.</span></span> <span data-ttu-id="4f764-136">Cuando el procesador de comandos "se abre" y "cierra" el archivo por lotes, el redirector de red intercepta los comandos de apertura y cierre.</span><span class="sxs-lookup"><span data-stu-id="4f764-136">As the command processor "opens" and "closes" the batch file, the network redirector intercepts the open and close commands.</span></span> <span data-ttu-id="4f764-137">Todas las recepciones de servidor son los comandos de búsqueda y lectura.</span><span class="sxs-lookup"><span data-stu-id="4f764-137">All the server receives are the seek and read commands.</span></span> <span data-ttu-id="4f764-138">Si el cliente también está leyendo de antemano, el servidor recibe una solicitud de lectura determinada al menos una vez.</span><span class="sxs-lookup"><span data-stu-id="4f764-138">If the client is also reading ahead, the server receives a particular read request at most one time.</span></span>

<span data-ttu-id="4f764-139">Al abrir un archivo que ya tiene un bloqueo oportunista de lotes, el servidor comprueba el estado de uso compartido del archivo después de interrumpir el bloqueo.</span><span class="sxs-lookup"><span data-stu-id="4f764-139">When opening a file that already has a batch opportunistic lock, the server checks the sharing state of the file after breaking the lock.</span></span> <span data-ttu-id="4f764-140">Esta comprobación proporciona al titular del bloqueo una oportunidad para completar el vaciado de su memoria caché y cerrar el identificador de archivo.</span><span class="sxs-lookup"><span data-stu-id="4f764-140">This check gives the holder of the lock a chance to complete flushing its cache and to close the file handle.</span></span> <span data-ttu-id="4f764-141">Una operación de apertura intentada durante la comprobación de uso compartido no hace que se produzca un error en la comprobación de uso compartido si el titular del bloqueo libera el bloqueo.</span><span class="sxs-lookup"><span data-stu-id="4f764-141">An open operation attempted during the sharing check does not cause the sharing check to fail if the lock holder releases the lock.</span></span>

<span data-ttu-id="4f764-142">Para ver un ejemplo de cómo funciona un bloqueo oportunista de batch, consulte ejemplo de bloqueo oportunista de batch.</span><span class="sxs-lookup"><span data-stu-id="4f764-142">For an example of how a batch opportunistic lock works, see Batch Opportunistic Lock Example.</span></span> <span data-ttu-id="4f764-143">Para obtener más información sobre cómo interrumpir los bloqueos oportunistas, vea [romper bloqueos oportunistas](breaking-opportunistic-locks.md).</span><span class="sxs-lookup"><span data-stu-id="4f764-143">For more information on breaking opportunistic locks, see [Breaking Opportunistic Locks](breaking-opportunistic-locks.md).</span></span>

## <a name="filter-opportunistic-locks"></a><span data-ttu-id="4f764-144">Filtrar bloqueos oportunistas</span><span class="sxs-lookup"><span data-stu-id="4f764-144">Filter Opportunistic Locks</span></span>

<span data-ttu-id="4f764-145">Un bloqueo oportunista de filtro bloquea un archivo para que no se pueda abrir para el acceso de escritura o eliminación.</span><span class="sxs-lookup"><span data-stu-id="4f764-145">A filter opportunistic lock locks a file so that it cannot be opened for either write or delete access.</span></span> <span data-ttu-id="4f764-146">Todos los clientes deben poder compartir el archivo.</span><span class="sxs-lookup"><span data-stu-id="4f764-146">All clients must be able to share the file.</span></span> <span data-ttu-id="4f764-147">Los bloqueos de filtro permiten a las aplicaciones realizar operaciones de filtrado no intrusivo en los datos de archivo (por ejemplo, un compilador que abra código fuente o un programa de catalogación).</span><span class="sxs-lookup"><span data-stu-id="4f764-147">Filter locks allow applications to perform nonintrusive filtering operations on file data (for example, a compiler opening source code or a cataloging program).</span></span>

<span data-ttu-id="4f764-148">Un bloqueo oportunista de filtro difiere de un bloqueo oportunista de nivel 2 en que permite que se produzcan operaciones de lectura sin infracciones del modo de uso compartido en el intervalo de tiempo entre la aplicación que abre el archivo y la recepción del bloqueo.</span><span class="sxs-lookup"><span data-stu-id="4f764-148">A filter opportunistic lock differs from a level 2 opportunistic lock in that it allows open operations for reading to occur without sharing-mode violations in the time span between your application's opening the file and receiving the lock.</span></span> <span data-ttu-id="4f764-149">El bloqueo oportunista de filtro es el mejor bloqueo que se puede usar cuando es importante permitir que otros clientes lean el acceso.</span><span class="sxs-lookup"><span data-stu-id="4f764-149">The filter opportunistic lock is the best lock to use when it is important to allow other clients reading access.</span></span> <span data-ttu-id="4f764-150">En otros casos, la aplicación debe usar un bloqueo oportunista de nivel 2.</span><span class="sxs-lookup"><span data-stu-id="4f764-150">In other cases, your application should use a level 2 opportunistic lock.</span></span> <span data-ttu-id="4f764-151">Un bloqueo oportunista de filtro difiere de un bloqueo oportunista de batch en que no permite que el redirector de red controle varias aperturas y cierres para que el redirector de la red lo lleve a cabo un bloqueo oportunista de batch.</span><span class="sxs-lookup"><span data-stu-id="4f764-151">A filter opportunistic lock differs from a batch opportunistic lock in that it does not allow multiple openings and closings to be handled by the network redirector the way a batch opportunistic lock does.</span></span>

<span data-ttu-id="4f764-152">La aplicación debe solicitar un bloqueo oportunista de filtro en un archivo en tres pasos:</span><span class="sxs-lookup"><span data-stu-id="4f764-152">Your application should request a filter opportunistic lock on a file in three steps:</span></span>

1.  <span data-ttu-id="4f764-153">Use la función [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) para abrir un identificador para el archivo con el parámetro *DesiredAccess* establecido en cero, lo que indica que no hay acceso y el parámetro *dwShareMode* establecido en la marca **\_ \_ Read del recurso compartido de archivos** para permitir el uso compartido para la lectura.</span><span class="sxs-lookup"><span data-stu-id="4f764-153">Use the [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) function to open a handle to the file with the *DesiredAccess* parameter set to zero, indicating no access, and the *dwShareMode* parameter set to the **FILE\_SHARE\_READ** flag to allow sharing for reading.</span></span> <span data-ttu-id="4f764-154">El identificador obtenido en este punto se denomina identificador de bloqueo.</span><span class="sxs-lookup"><span data-stu-id="4f764-154">The handle obtained at this point is called the locking handle.</span></span>
2.  <span data-ttu-id="4f764-155">Solicite un bloqueo en este identificador con el código de control de [**\_ \_ \_ bloqueo oportunista del filtro de solicitud de FSCTL**](/windows/win32/api/winioctl/ni-winioctl-fsctl_request_filter_oplock) .</span><span class="sxs-lookup"><span data-stu-id="4f764-155">Request a lock on this handle with the [**FSCTL\_REQUEST\_FILTER\_OPLOCK**](/windows/win32/api/winioctl/ni-winioctl-fsctl_request_filter_oplock) control code.</span></span>
3.  <span data-ttu-id="4f764-156">Cuando se concede el bloqueo, use [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) para volver a abrir el archivo con *DesiredAccess* establecido en la marca de **\_ lectura genérica** .</span><span class="sxs-lookup"><span data-stu-id="4f764-156">When the lock is granted, use [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) to open the file again with *DesiredAccess* set to the **GENERIC\_READ** flag.</span></span> <span data-ttu-id="4f764-157">Establezca *dwShareMode* en la marca de **\_ \_ lectura del recurso compartido de archivos** para que otros usuarios puedan leer el archivo mientras está abierto, la marca de **\_ \_ eliminación del recurso compartido de archivos** para permitir que otros usuarios marquen el archivo para su eliminación mientras está abierto, o ambos.</span><span class="sxs-lookup"><span data-stu-id="4f764-157">Set *dwShareMode* to the **FILE\_SHARE\_READ** flag to allow others to read the file while you have it open, the **FILE\_SHARE\_DELETE** flag to allow others to mark the file for deletion while you have it open, or both.</span></span> <span data-ttu-id="4f764-158">El identificador obtenido en este punto se denomina controlador de lectura.</span><span class="sxs-lookup"><span data-stu-id="4f764-158">The handle obtained at this point is called the read handle.</span></span>

<span data-ttu-id="4f764-159">Use el controlador de lectura para leer el contenido del archivo o escribir en él.</span><span class="sxs-lookup"><span data-stu-id="4f764-159">Use the read handle to read from or write to the contents of the file.</span></span>

<span data-ttu-id="4f764-160">Al abrir un archivo que ya tiene un bloqueo oportunista de filtro, el servidor interrumpe el bloqueo y, a continuación, comprueba el estado de uso compartido del archivo.</span><span class="sxs-lookup"><span data-stu-id="4f764-160">When opening a file that already has a filter opportunistic lock, the server breaks the lock and then checks the sharing state of the file.</span></span> <span data-ttu-id="4f764-161">Esta comprobación proporciona al cliente que mantuvo el anterior bloqueo oportunista una oportunidad de abandonar los datos almacenados en caché y confirmar la interrupción.</span><span class="sxs-lookup"><span data-stu-id="4f764-161">This check gives the client that held the former opportunistic lock a chance to abandon any cached data and acknowledge the break.</span></span> <span data-ttu-id="4f764-162">Una operación de apertura intentada durante esta comprobación de uso compartido no hace que se produzca un error en la comprobación de uso compartido si el titular del bloqueo anterior libera el bloqueo.</span><span class="sxs-lookup"><span data-stu-id="4f764-162">An open operation attempted during this sharing check does not cause the sharing check to fail if the former lock holder releases the lock.</span></span> <span data-ttu-id="4f764-163">El sistema de archivos mantiene en abeyance la operación de apertura hasta que el propietario del bloqueo cierra tanto el controlador de lectura como el identificador de bloqueo.</span><span class="sxs-lookup"><span data-stu-id="4f764-163">The file system holds in abeyance the open operation until the lock's owner closes both the read handle and then the locking handle.</span></span> <span data-ttu-id="4f764-164">Una vez hecho esto, la solicitud de apertura de otro cliente puede continuar.</span><span class="sxs-lookup"><span data-stu-id="4f764-164">After this is done, the other client's open request can proceed.</span></span>

<span data-ttu-id="4f764-165">Para obtener más información sobre cómo interrumpir los bloqueos oportunistas, vea [romper bloqueos oportunistas](breaking-opportunistic-locks.md).</span><span class="sxs-lookup"><span data-stu-id="4f764-165">For more information on breaking opportunistic locks, see [Breaking Opportunistic Locks](breaking-opportunistic-locks.md).</span></span>

 

 
