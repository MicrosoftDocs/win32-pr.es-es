---
description: El proceso de creación de instantáneas
ms.assetid: ca484eec-31c6-4790-9232-3ed67263f6fb
title: El proceso de creación de instantáneas
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: dae0d0cff8e4afdbecb5c61a934be1a9c9b731cbdbee8778afd714f6802ca2ae
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/11/2021
ms.locfileid: "119056363"
---
# <a name="the-shadow-copy-creation-process"></a>El proceso de creación de instantáneas

A continuación se muestra una descripción detallada del rol del proveedor de hardware en la creación de un conjunto de instantáneas. Para obtener un diagrama de este proceso, vea [Creación de instantáneas para proveedores.](shadow-copy-creation-for-providers.md)

1.  A medida que el solicitante agrega cada volumen al conjunto de instantáneas, VSS determina los LUN asociados. Por ejemplo, un volumen abarcado podría estar compuesto de varios LUN. VSS crea una información [**de LUN de VDS \_ \_ inicial**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) mediante la información del dispositivo físico para cada LUN.
2.  VSS llama [**a AreLunsSupported**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported) para determinar si el proveedor admite una instantánea para ese LUN. El proveedor de hardware usa [**VDS \_ LUN \_ INFORMATION**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) para determinar si se admiten los LUN. Esta determinación debe ser todo o nada: el mismo proveedor de hardware debe admitir todos los LUN que contribuyen a un volumen específico. En el ejemplo de volumen abarcado, el proveedor no puede indicar que solo admite uno de los LUN que componen el volumen.
3.  Para cada volumen del conjunto de instantáneas, VSS llama a [**IVssHardwareSnapshotProvider::BeginPrepareSnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot) con la misma matriz de estructuras [**VDS \_ LUN \_ INFORMATION.**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) Dentro de una sola llamada, todos los LUN de la matriz son únicos, pero el mismo LUN puede aparecer en una llamada posterior siempre que el mismo LUN contribuya a varios volúmenes. El proveedor debe controlar ese caso correctamente.
4.  Inmediatamente después [**de IVssProviderCreateSnapshotSet::EndPrepareSnapshots,**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots)VSS establecerá las marcas de solo lectura, ocultas, sin letra de unidad y instantáneas en todos los LUN afectados. Las marcas se implementan mediante sectores ocultos en discos MBR o bits específicos del sistema operativo en la entrada de encabezado de partición en discos GPT. Las marcas harán que todos los volúmenes de los discos afectados se afiescien en los equipos receptores como de solo lectura y ocultos. Tenga en cuenta que los LUN copiados en la sombra no se han confirmado en esta fase, por lo que en caso de un bloqueo del sistema, las marcas se borrarán y el LUN original no se verá afectado. Es decir, todos los volúmenes del LUN original se tratarán como normales y mantendrán sus asignaciones originales de letra de unidad, carpetas montadas y estado de lectura y escritura.
    > [!Note]  
    > Los proveedores no deben intentar modificar ninguna de las marcas LUN.

     

5.  En [**CommitSnapshots,**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots)se confirman los LUN de instantáneas. **CommitSnapshots debe** devolverse en unos segundos o probablemente se producirá un error en todo el proceso de creación de instantáneas.
6.  Después [**de CommitSnapshots,**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots)VSS borra las marcas en todos los LUN originales implicados en la instantánea. Puesto que los LUN de instantáneas se han confirmado en este momento, los LUN de instantáneas conservan estas marcas.
7.  Después [**de IVssProviderCreateSnapshotSet::P ostCommitSnapshots,**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots)VSS borra las marcas LUN (que se establecen después de [**IVssProviderCreateSnapshotSet::EndPrepareSnapshots)**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots)y notifica a los escritores que se descongelen. A continuación, VSS llama a los [**métodos IVssProviderCreateSnapshotSet::P reFinalCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-prefinalcommitsnapshots) e [**IVssProviderCreateSnapshotSet::P ostFinalCommitSnapshots.**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postfinalcommitsnapshots)
8.  VSS recupera una matriz de estructuras DE INFORMACIÓN DE LUN de [**VDS, \_ \_**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) una para cada LUN de instantánea recién creada, mediante una llamada a [**IVssHardwareSnapshotProvider::GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns). El proveedor debe proporcionar suficiente información para permitir que VSS y el proveedor identifiquen las instantáneas en cualquier momento posterior y en cualquier sistema conectado al subsistema. En este momento, los LUN de instantáneas deben ser inaccesibles para esta máquina: el proveedor debe usar algún mecanismo que no sea simplemente leer la información del LUN.
9.  En el caso de las instantáneas transportables, VSS anexa lo siguiente al documento componentes de copia de seguridad que describe el conjunto de instantáneas:
    1.  Matriz original DE [**INFORMACIÓN DE LUN VDS \_ \_ LUN.**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information)
    2.  Nueva matriz DE INFORMACIÓN DE [**LUN VDS \_ \_ de instantáneas.**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information)
    3.  Extensiones de disco para cada volumen del conjunto de instantáneas.
10. En el caso de las instantáneas de importación automática, comienza el proceso de importación. En [**IVssHardwareSnapshotProvider::LocateLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-locateluns), al proveedor se le dará la información de LUN de [**VDS \_ \_**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) generada en [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) en el momento de la creación. Durante **LocateLuns,** el proveedor debe hacer que esos LUN de instantáneas sean visibles para el sistema. El proveedor no debe hacer que se vuelva a examinar un bus. VSS hará que PNP vuelva a examinar y enumerar para permitir que PNP descubra los LUN y que los volúmenes se en línea.
11. VSS llama [**a IVssHardwareSnapshotProvider::FillInLunInfo**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-fillinluninfo) para los discos recién llegados en el sistema. VSS usa la matriz shadow copy LUN [**VDS \_ LUN \_ INFORMATION**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) de **FillInLunInfo,** comparándolo con la información de LUN de **VDS \_ \_** generada durante la creación en [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) y las extensiones de disco de cada volumen del conjunto de instantáneas para identificar los LUN de instantáneas recién llegados.
12. En este momento, todos los volúmenes contenidos en los LUN de instantáneas se montan ocultos y de solo lectura, y VSS tiene una asignación del volumen original al volumen de instantáneas.

Dado que un solo LUN puede contener partes de varios volúmenes, el conjunto de LUN de instantáneas puede incluir volúmenes "adicionales". Esos volúmenes no forman parte del conjunto de instantáneas y no deben usarse, ya que no se garantiza que sean coherentes.

Después de la importación, se puede acceder a la instantánea a través [**del método IVssBackupComponents::Query.**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-query) Una instantánea también se puede exponer como una letra de unidad, una carpeta montada o un recurso compartido [**mediante IVssBackupComponents::ExposeSnapshot**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-exposesnapshot). Un conjunto de instantáneas también se puede convertir en un LUN normal mediante el método [**IVssBackupComponents::BreakSnapshotSet.**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-breaksnapshotset) Desde allí, las aplicaciones de administración pueden usar las API de administración de discos adecuadas para administrar aún más el LUN (por ejemplo, cambiar los atributos de lectura y escritura).

### <a name="transportable-shadow-copies-on-a-san"></a>Instantáneas transportables en una SAN

A partir de Windows Server 2003, Datacenter Edition y Windows Server 2003, Enterprise Edition, VSS permite conjuntos de instantáneas transportables en una SAN. Desde el punto de vista de un proveedor capaz de transportar LUN entre hosts, hay poca o ninguna diferencia entre un conjunto de instantáneas no transportable y un conjunto de instantáneas transportable.

**Windows Server 2003, Standard Edition, Windows Server 2003, Web Edition y Windows XP:** No se admiten conjuntos de instantáneas transportables. Todas las ediciones de Windows Server 2003 con Service Pack 1 (SP1) admiten conjuntos de instantáneas transportables.

Los conjuntos de instantáneas transportables deben crearse con el atributo **\_ VSS VOLSNAP \_ ATTR \_ TRANSPORTABLE** agregado al contexto de instantánea descrito por la enumeración ATRIBUTOS DE INSTANTÁNEAS DE VOLUMEN DE [**\_ VSS. \_ \_ \_**](/windows/desktop/api/Vss/ne-vss-vss_volume_snapshot_attributes) Todos los volúmenes del conjunto deben ser transportables. Al devolver el resultado correcto de [**IVssHardwareSnapshotProvider::AreLunsSupported,**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported)el proveedor indica que no solo admite el LUN, sino que también puede transportar el LUN. La creación de un conjunto de instantáneas transportable concluye cuando VSS registra la información de LUN en el documento componentes de copia de seguridad. Un conjunto de instantáneas solo se puede importar una vez después de la creación inicial.

En el equipo receptor, el solicitante importa el conjunto de instantáneas. El [**método IVssBackupComponents::ImportSnapshots**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-importsnapshots) usa el documento componentes de copia de seguridad que describe el conjunto de instantáneas como entrada. La importación continúa mediante:

1.  VSS construye una matriz de estructuras DE INFORMACIÓN DE LUN de VDS de instantáneas a partir del documento componentes de copia de seguridad. [**\_ \_**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information)
2.  Cuando VSS llama a [**IVssHardwareSnapshotProvider::LocateLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-locateluns), la matriz de estructuras DE INFORMACIÓN DE LUN de [**VDS \_ \_**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) generadas en [**IVssHardwareSnapshotProvider::GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) se pasará al proveedor. Al procesar este método, el proveedor debe hacer que esos LUN de instantáneas sean visibles para el sistema. El proveedor no debe hacer que se vuelva a examinar un bus. VSS desencadenará el nuevo análisis y la enumeración para permitir que PNP descubra los LUN y que los volúmenes entren en línea.
3.  VSS llama [**a IVssHardwareSnapshotProvider::FillInLunInfo**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-fillinluninfo) para los discos recién llegados en el sistema. VSS usa la matriz LUN de instantáneas de estructuras [**VDS \_ LUN \_ INFORMATION**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) de **FillInLunInfo,** comparándolo con la información de LUN de **VDS \_ \_** generada durante la creación del conjunto de instantáneas en [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) y las extensiones de disco de cada volumen del conjunto de instantáneas para identificar los LUN de instantáneas recién llegados.
4.  En este momento, todos los volúmenes contenidos en los LUN transportados se montan ocultos y de solo lectura y VSS tiene una asignación del volumen original al volumen de instantáneas.

Tanto para el equipo único como para el caso transportable, la secuencia es similar a partir del punto al que se llama a [**GetTargetLuns.**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) Para la importación automática, los pasos se realizarán directamente después de la creación.

 

 
