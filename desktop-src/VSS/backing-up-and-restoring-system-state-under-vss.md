---
description: 'Nota: este tema solo se aplica a Windows Server 2003 R2 y Windows Server 2003 con Service Pack 1 (SP1).'
ms.assetid: a192d9a7-1c65-4251-acb1-4df03ebfe910
title: Copia de seguridad y restauración del estado del sistema en Windows Server 2003 R2 y Windows Server 2003 SP1
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: de2fdb50e3f719a5208c2894f5659f927bcc922d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/08/2021
ms.locfileid: "104002951"
---
# <a name="backing-up-and-restoring-system-state-in-windows-server-2003-r2-and-windows-server-2003-sp1"></a><span data-ttu-id="03b10-103">Copia de seguridad y restauración del estado del sistema en Windows Server 2003 R2 y Windows Server 2003 SP1</span><span class="sxs-lookup"><span data-stu-id="03b10-103">Backing Up and Restoring System State in Windows Server 2003 R2 and Windows Server 2003 SP1</span></span>

> [!Note]  
> <span data-ttu-id="03b10-104">Este tema solo se aplica a Windows Server 2003 R2 y Windows Server 2003 con Service Pack 1 (SP1).</span><span class="sxs-lookup"><span data-stu-id="03b10-104">This topic only applies to Windows Server 2003 R2 and Windows Server 2003 with Service Pack 1 (SP1).</span></span> <span data-ttu-id="03b10-105">Para obtener información acerca de otras versiones de sistema operativo, consulte [copia de seguridad y restauración del estado del sistema](locating-additional-system-files.md).</span><span class="sxs-lookup"><span data-stu-id="03b10-105">For information about other operating system versions, see [Backing Up and Restoring System State](locating-additional-system-files.md).</span></span>

 

> [!Note]  
> <span data-ttu-id="03b10-106">Microsoft no proporciona soporte técnico para desarrolladores o profesionales de TI para implementar restauraciones de estado del sistema en línea en Windows (todas las versiones).</span><span class="sxs-lookup"><span data-stu-id="03b10-106">Microsoft does not provide developer or IT professional technical support for implementing online system state restores on Windows (all releases).</span></span> <span data-ttu-id="03b10-107">Para obtener información sobre el uso de las API y los procedimientos proporcionados por Microsoft para implementar restauraciones de estado del sistema en línea, consulte los recursos de la comunidad disponibles en [MSDN Community Center](https://msdn.microsoft.com/community/default.aspx).</span><span class="sxs-lookup"><span data-stu-id="03b10-107">For information about using Microsoft-provided APIs and procedures to implement online system state restores, see the community resources available at the [MSDN Community Center](https://msdn.microsoft.com/community/default.aspx).</span></span>

 

<span data-ttu-id="03b10-108">Al realizar una copia de seguridad o restauración de VSS, el estado del sistema de Windows se define como una colección de varios elementos clave del sistema operativo y sus archivos.</span><span class="sxs-lookup"><span data-stu-id="03b10-108">When performing a VSS backup or restore, the Windows system state is defined as being a collection of several key operating system elements and their files.</span></span> <span data-ttu-id="03b10-109">Estos elementos se deben tratar siempre mediante operaciones de copia de seguridad y restauración como una unidad.</span><span class="sxs-lookup"><span data-stu-id="03b10-109">These elements should always be treated by backup and restore operations as a unit.</span></span>

<span data-ttu-id="03b10-110">En Windows Server 2003 R2 y Windows Server 2003 con SP1, no hay ninguna API de Windows diseñada para tratar estos objetos como uno, por lo que se recomienda que los solicitantes tengan su propio objeto de estado del sistema para que puedan procesar estos componentes de una manera coherente.</span><span class="sxs-lookup"><span data-stu-id="03b10-110">In Windows Server 2003 R2 and Windows Server 2003 with SP1, there is no Windows API designed to treat these objects as one, so it is recommended that requesters have their own system state object so that they can process these components in a consistent manner.</span></span>

<span data-ttu-id="03b10-111">Dado que VSS se ejecuta en versiones de Windows en las que [*protección de archivos del sistema*](vssgloss-s.md) (WFP) protege los archivos de estado del sistema de daños, se necesitan pasos especiales para realizar copias de seguridad y restaurar el estado del sistema.</span><span class="sxs-lookup"><span data-stu-id="03b10-111">Because VSS runs on versions of Windows where [*System File Protection*](vssgloss-s.md) (WFP) protects system state files from corruption, special steps are needed to back up and restore system state.</span></span>

<span data-ttu-id="03b10-112">El estado del sistema consta de lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="03b10-112">System state consists of the following:</span></span>

-   <span data-ttu-id="03b10-113">Todos los archivos protegidos por WFP, archivos de arranque, como NTLDR, Ntdetect y configuraciones de contador de rendimiento</span><span class="sxs-lookup"><span data-stu-id="03b10-113">All files protected by WFP, boot files including ntldr, ntdetect, and performance counter configurations</span></span>
-   <span data-ttu-id="03b10-114">El Active Directory (ADSI) (en los sistemas que son controladores de dominio)</span><span class="sxs-lookup"><span data-stu-id="03b10-114">The Active Directory (ADSI) (on systems that are domain controllers)</span></span>
-   <span data-ttu-id="03b10-115">La carpeta de volumen del sistema (SYSVOL) replicada por el servicio de replicación de archivos (FRS) (en sistemas que son controladores de dominio)</span><span class="sxs-lookup"><span data-stu-id="03b10-115">The System Volume Folder (SYSVOL) that is replicated by the File Replication Service (FRS) (on systems that are domain controllers)</span></span>
-   <span data-ttu-id="03b10-116">Servidor de certificados (en sistemas que proporcionan una entidad de certificación)</span><span class="sxs-lookup"><span data-stu-id="03b10-116">Certificate server (on systems that provide Certification Authority)</span></span>
-   <span data-ttu-id="03b10-117">Base de datos de clúster (en sistemas que son un nodo de un clúster de Windows)</span><span class="sxs-lookup"><span data-stu-id="03b10-117">Cluster database (on systems that are a node of a Windows cluster)</span></span>
-   <span data-ttu-id="03b10-118">Servicio del Registro</span><span class="sxs-lookup"><span data-stu-id="03b10-118">Registry service</span></span>
-   <span data-ttu-id="03b10-119">Base de datos de registro de clase COM+</span><span class="sxs-lookup"><span data-stu-id="03b10-119">COM+ class registration database</span></span>

<span data-ttu-id="03b10-120">Se puede realizar una copia de seguridad del estado del sistema en cualquier orden.</span><span class="sxs-lookup"><span data-stu-id="03b10-120">The system state can be backed up in any order.</span></span>

<span data-ttu-id="03b10-121">Sin embargo, la restauración del estado del sistema debe reemplazar primero los archivos de arranque y confirmar la sección del sistema (Hive) del registro como último paso del proceso y puede producirse en el siguiente orden:</span><span class="sxs-lookup"><span data-stu-id="03b10-121">However, the restoration of the system state should replace boot files first and commit the system section (hive) of the registry as a final step in the process, and might occur in the following order:</span></span>

1.  <span data-ttu-id="03b10-122">Restaure los archivos de arranque.</span><span class="sxs-lookup"><span data-stu-id="03b10-122">Restore the boot files.</span></span>
2.  <span data-ttu-id="03b10-123">Base de datos de registro de clase COM+</span><span class="sxs-lookup"><span data-stu-id="03b10-123">COM+ class registration database</span></span>
3.  <span data-ttu-id="03b10-124">Restaure SYSVOL, el servidor de certificados y las bases de datos de clúster (si es necesario).</span><span class="sxs-lookup"><span data-stu-id="03b10-124">Restore SYSVOL, Certificate Server, and Cluster databases (if needed).</span></span>
4.  <span data-ttu-id="03b10-125">Restaure Active Directory (si es necesario).</span><span class="sxs-lookup"><span data-stu-id="03b10-125">Restore Active Directory (if needed).</span></span>
5.  <span data-ttu-id="03b10-126">Restaure el registro.</span><span class="sxs-lookup"><span data-stu-id="03b10-126">Restore the registry.</span></span>

<span data-ttu-id="03b10-127">Algunos servicios del sistema, como la entidad de certificación, tienen escritores de VSS convencionales y siguen los algoritmos de copia de seguridad y restauración de VSS.</span><span class="sxs-lookup"><span data-stu-id="03b10-127">Some system services, such as the Certification Authority, have conventional VSS writers and follow the VSS backup and restore algorithms.</span></span> <span data-ttu-id="03b10-128">Otros, como el registro, requieren operaciones personalizadas de copia de seguridad o restauración; para obtener más información, consulte [copias de seguridad y restauraciones personalizadas](custom-backups-and-restores.md).</span><span class="sxs-lookup"><span data-stu-id="03b10-128">Others, such as the registry, require custom backup or restore operations; for more information, see [Custom Backups and Restores](custom-backups-and-restores.md).</span></span>

## <a name="vss-backup-and-restores-of-boot-and-system-files"></a><span data-ttu-id="03b10-129">Copias de seguridad y restauraciones de VSS de archivos de arranque y del sistema</span><span class="sxs-lookup"><span data-stu-id="03b10-129">VSS Backup and Restores of Boot and System Files</span></span>

<span data-ttu-id="03b10-130">Se debe realizar una copia de seguridad y restaurar los archivos de sistema y de arranque solo como una entidad única.</span><span class="sxs-lookup"><span data-stu-id="03b10-130">The boot and system files should be backed up and restored only as a single entity.</span></span>

<span data-ttu-id="03b10-131">Un solicitante puede usar de forma segura las versiones de instantáneas de estos archivos, y debe asegurarse de que el volumen del sistema y el dispositivo de arranque son [*instantáneas*](vssgloss-s.md).</span><span class="sxs-lookup"><span data-stu-id="03b10-131">A requester can safely use shadow-copied versions of these files, and should be sure that the system volume and boot device are [*shadow copied*](vssgloss-s.md).</span></span>

<span data-ttu-id="03b10-132">Los archivos de sistema y de arranque incluyen:</span><span class="sxs-lookup"><span data-stu-id="03b10-132">The system and boot files include:</span></span>

-   <span data-ttu-id="03b10-133">Los archivos de arranque principales:</span><span class="sxs-lookup"><span data-stu-id="03b10-133">The core boot files:</span></span> <dl> <span data-ttu-id="03b10-134">NtLdr.exe</span><span class="sxs-lookup"><span data-stu-id="03b10-134">NtLdr.exe</span></span>  
    <span data-ttu-id="03b10-135">Boot.ini</span><span class="sxs-lookup"><span data-stu-id="03b10-135">Boot.ini</span></span>  
    <span data-ttu-id="03b10-136">NtDetect.com</span><span class="sxs-lookup"><span data-stu-id="03b10-136">NtDetect.com</span></span>  
    <span data-ttu-id="03b10-137">NtBootDD.sys (si existe)</span><span class="sxs-lookup"><span data-stu-id="03b10-137">NtBootDD.sys (if present)</span></span>  
    </dl>
-   The WFP service catalog file must be backed up prior to backing up the WFP files, and it is found under: <dl> <span data-ttu-id="03b10-138">% SystemRoot% \\ system32 \\ CatRoot \\ {F750E6C3-38EE-11D1-85E5-00C04FC295EE}</span><span class="sxs-lookup"><span data-stu-id="03b10-138">%SystemRoot%\\System32\\CatRoot\\{F750E6C3-38EE-11D1-85E5-00C04FC295EE}</span></span> </dl><span data-ttu-id="03b10-139">
-   Todos los archivos protegidos por [\*protección de archivos del sistema*](vssgloss-s.md) y enumerados por [\*\*SFCGETNEXTPROTECTEDFILE**](/windows/win32/api/sfc/nf-sfc-sfcgetnextprotectedfile) (vea VSS restore Operations of WFP Protected files) -   The performance Counter Configuration Files:</span><span class="sxs-lookup"><span data-stu-id="03b10-139">
-   All files protected by [\*System File Protection*](vssgloss-s.md) and enumerated by [\*\*SfcGetNextProtectedFile**](/windows/win32/api/sfc/nf-sfc-sfcgetnextprotectedfile) (see VSS Restore Operations of WFP Protected Files) -   The Performance Counter Configuration files:</span></span> <dl> <span data-ttu-id="03b10-140">% SystemRoot% \\ system32 \\ Perf? 00?. incrementa</span><span class="sxs-lookup"><span data-stu-id="03b10-140">%SystemRoot%\\System32\\Perf?00?.dat</span></span>  
    <span data-ttu-id="03b10-141">% SystemRoot% \\ system32 \\ Perf? 00?. Bak</span><span class="sxs-lookup"><span data-stu-id="03b10-141">%SystemRoot%\\System32\\Perf?00?.bak</span></span> </dl><span data-ttu-id="03b10-142">
-   Si está presente, el archivo de la metabase de Internet Information Server (IIS) debe incluirse en las operaciones de copia de seguridad y restauración, ya que contiene el estado utilizado por Microsoft Exchange y otras aplicaciones de red.</span><span class="sxs-lookup"><span data-stu-id="03b10-142">
-   If present, the Internet Information Server (IIS) metabase file should be included in backup and restore operations because it contains state that is used by Microsoft Exchange and other network applications.</span></span> <span data-ttu-id="03b10-143">Este archivo se encuentra en:</span><span class="sxs-lookup"><span data-stu-id="03b10-143">This file can be found at:</span></span> <dl> <span data-ttu-id="03b10-144">% SystemRoot% \\ system32 \\ InetSrv \\ metabase. bin</span><span class="sxs-lookup"><span data-stu-id="03b10-144">%SystemRoot%\\System32\\InetSrv\\Metabase.bin</span></span> </dl><span data-ttu-id="03b10-145">
-   Si se realiza una copia de seguridad del archivo de metabase de IIS, las claves para permitir que las aplicaciones lean ciertas entradas cifradas deben restaurarse como parte del estado del sistema.</span><span class="sxs-lookup"><span data-stu-id="03b10-145">
-   If the IIS metabase file is backed up, keys to enable applications to read certain encrypted entries should be restored as part of the system state.</span></span> <span data-ttu-id="03b10-146">Los archivos pueden encontrarse en:</span><span class="sxs-lookup"><span data-stu-id="03b10-146">The files can be found under:</span></span> <dl> <span data-ttu-id="03b10-147">% SystemRoot% \\ system32 \\ Microsoft \\ Protect\\\*</span><span class="sxs-lookup"><span data-stu-id="03b10-147">%SystemRoot%\\System32\\Microsoft\\Protect\\\*</span></span>  
    <span data-ttu-id="03b10-148">% AllUsersProfile% \\ Microsoft \\ Crypto \\ RSA \\ MachineKeys\\\*</span><span class="sxs-lookup"><span data-stu-id="03b10-148">%AllUsersProfile%\\Microsoft\\Crypto\\RSA\\MachineKeys\\\*</span></span> </dl><span data-ttu-id="03b10-149">
-Al realizar copias de seguridad de los archivos de arranque y del sistema, puede ser necesario determinar el dispositivo de arranque de dos haciendo lo siguiente: 1. Busque la partición del sistema en \*\*HKEY \_ local \_ Machine*\* \\ \*\*System*\* \\ \*\*setup*\* \\ \*\*SystemPartition\**.</span><span class="sxs-lookup"><span data-stu-id="03b10-149">
-   When backing up boot and system files, it may become necessary to determine the DOS boot device by doing the following: 1.  Find the system partition under \*\*HKEY\_LOCAL\_MACHINE\*\*\\*\*System\*\*\\*\*Setup\*\*\\*\*SystemPartition\**.</span></span>
    <span data-ttu-id="03b10-150">2.  Pasar la variable de entorno raíz del sistema (% SystemRoot%) al administrador de montaje para obtener el nombre del dispositivo NT.</span><span class="sxs-lookup"><span data-stu-id="03b10-150">2.  Pass the System Root environment variable (%SystemRoot%) to the mount manager to obtain the NT device name.</span></span>

## <a name="vss-restore-operations-of-wfp-protected-files"></a><span data-ttu-id="03b10-151">Operaciones de restauración de VSS de archivos protegidos con WFP</span><span class="sxs-lookup"><span data-stu-id="03b10-151">VSS Restore Operations of WFP Protected Files</span></span>

<span data-ttu-id="03b10-152">El servicio WFP está diseñado para evitar la sustitución accidental o por etapas de los archivos del sistema.</span><span class="sxs-lookup"><span data-stu-id="03b10-152">The WFP service is designed to prevent accidental or piecemeal replacement of system files.</span></span> <span data-ttu-id="03b10-153">Por lo tanto, es necesario llevar a cabo pasos especiales para restaurar los datos de WFP.</span><span class="sxs-lookup"><span data-stu-id="03b10-153">Therefore, special steps need to be undertaken to restore WFP data.</span></span>

<span data-ttu-id="03b10-154">Lo que significa que el escritor de WFP debe especificar el método de restauración de la restauración **\_ \_ de RME en el \_ \_ reinicio** al definir su documento de metadatos del escritor.</span><span class="sxs-lookup"><span data-stu-id="03b10-154">The means the WFP writer should specify the **VSS\_RME\_RESTORE\_AT\_REBOOT** restore method when defining its Writer Metadata Document.</span></span> <span data-ttu-id="03b10-155">Si un solicitante determina que el escritor de WFP no ha podido especificar este método de restauración, indica un error del escritor.</span><span class="sxs-lookup"><span data-stu-id="03b10-155">If a requester determines that the WFP writer has failed to specify this restore method, it indicates a writer error.</span></span>

<span data-ttu-id="03b10-156">Un solicitante debe implementar un método de restauración de la **restauración de RME de VSS en el \_ \_ \_ \_ reinicio** mediante la función de Win32 [**MoveFileEx**](/windows/win32/api/winbase/nf-winbase-movefileexa) con el parámetro de **retardo de MOVEFILE \_ hasta el \_ \_ reinicio** para reemplazar los archivos del sistema.</span><span class="sxs-lookup"><span data-stu-id="03b10-156">A requester should implement a restore method of **VSS\_RME\_RESTORE\_AT\_REBOOT** using the Win32 function [**MoveFileEx**](/windows/win32/api/winbase/nf-winbase-movefileexa) with the **MOVEFILE\_DELAY\_UNTIL\_REBOOT** parameter to replace system files.</span></span> <span data-ttu-id="03b10-157">Los archivos restaurados no se copian en los directorios de archivos del sistema reales hasta después del reinicio del sistema.</span><span class="sxs-lookup"><span data-stu-id="03b10-157">The restored files are not copied into the actual system file directories until after system reboot.</span></span> <span data-ttu-id="03b10-158">La sobrescritura de archivos de sistema protegidos solo se producirá si el valor de la siguiente entrada de registro de **reg \_ Word** está establecido en 1:</span><span class="sxs-lookup"><span data-stu-id="03b10-158">The overwriting of protected system files will occur only if the value of the following **REG\_WORD** registry entry is set to 1:</span></span>

<span data-ttu-id="03b10-159">**HKEY \_ \_** \\ **Sistema del** equipo local \\ **CurrentControlSet** \\ **control** \\ **Session Manager** \\ **AllowProtectedRenames** = 1</span><span class="sxs-lookup"><span data-stu-id="03b10-159">**HKEY\_LOCAL\_MACHINE**\\**System**\\**CurrentControlSet**\\**Control**\\**Session Manager**\\**AllowProtectedRenames** = 1</span></span>

<span data-ttu-id="03b10-160">Este valor debe establecerse antes que cualquier arranque en el que los archivos protegidos se reemplacen a través de [**MoveFileEx**](/windows/win32/api/winbase/nf-winbase-movefileexa) y se elimine después del reinicio.</span><span class="sxs-lookup"><span data-stu-id="03b10-160">This value must be set before any boot where protected files are to be replaced via [**MoveFileEx**](/windows/win32/api/winbase/nf-winbase-movefileexa) and is deleted after reboot.</span></span>

<span data-ttu-id="03b10-161">También se debe hacer una copia de seguridad o restaurar el directorio dllcache del sistema, con copias de seguridad y restauración del volumen de arranque, y se encuentra examinando la entrada del registro **\_ \_ Expand de reg** :</span><span class="sxs-lookup"><span data-stu-id="03b10-161">The system dllcache directory should also be backed up or restored, with boot volume backup and restore, and is located by examining the **REG\_EXPAND\_SZ** registry entry:</span></span>

<span data-ttu-id="03b10-162">**HKEY \_ Software de \_ equipo local** \\  \\ **Microsoft** \\ **Windows NT** \\ **CurrentVersion** \\ **Winlogon** \\ **SfcDllCache**</span><span class="sxs-lookup"><span data-stu-id="03b10-162">**HKEY\_LOCAL\_MACHINE**\\**Software**\\**Microsoft**\\**Windows NT**\\**CurrentVersion**\\**WinLogon**\\**SfcDllCache**</span></span><dl> <dt>

                  Data type
</dt> <dd>                  <span data-ttu-id="03b10-163">REG \_ expandir \_ SZ</span><span class="sxs-lookup"><span data-stu-id="03b10-163">REG\_EXPAND\_SZ</span></span></dd> </dl>

<span data-ttu-id="03b10-164">El contenido del directorio dllcache del sistema se vuelve a generar con el comprobador de archivos de sistema (SFC) desde el símbolo del sistema:</span><span class="sxs-lookup"><span data-stu-id="03b10-164">The contents of the system dllcache directory are rebuilt by using the System File Checker (SFC) from the command prompt:</span></span>

-   <span data-ttu-id="03b10-165">La opción **/scanonce** examina todos los archivos protegidos en el siguiente arranque del sistema.</span><span class="sxs-lookup"><span data-stu-id="03b10-165">The **/SCANONCE** option scans all protected files at the next system boot.</span></span>
-   <span data-ttu-id="03b10-166">La opción **/scannow** examina inmediatamente todos los archivos protegidos.</span><span class="sxs-lookup"><span data-stu-id="03b10-166">The **/SCANNOW** option scans all protected files immediately.</span></span>

<span data-ttu-id="03b10-167">Se examinarán todos los archivos protegidos, y las versiones que no sean válidas se reemplazarán en el directorio y en la ubicación de dllcache.</span><span class="sxs-lookup"><span data-stu-id="03b10-167">All protected files will be scanned, and any versions that are not valid will be replaced in both the directory and dllcache location.</span></span>

<span data-ttu-id="03b10-168">Hay cuatro archivos que forman parte de la WFP que no se pueden restaurar con los archivos WFP:</span><span class="sxs-lookup"><span data-stu-id="03b10-168">There are four files that are part of the WFP that cannot be restored with the WFP files:</span></span>

<dl> <span data-ttu-id="03b10-169">Ctl3dv2.dll</span><span class="sxs-lookup"><span data-stu-id="03b10-169">Ctl3dv2.dll</span></span>  
<span data-ttu-id="03b10-170">DtcSetup.exe</span><span class="sxs-lookup"><span data-stu-id="03b10-170">DtcSetup.exe</span></span>  
<span data-ttu-id="03b10-171">NtDll.dll</span><span class="sxs-lookup"><span data-stu-id="03b10-171">NtDll.dll</span></span>  
<span data-ttu-id="03b10-172">Smss.exe</span><span class="sxs-lookup"><span data-stu-id="03b10-172">Smss.exe</span></span>  
</dl>

<span data-ttu-id="03b10-173">Estos archivos ayudan en el proceso de restauración de los archivos WFP y, como tal, hay una dependencia circular.</span><span class="sxs-lookup"><span data-stu-id="03b10-173">These files help in the process of restoring the WFP files and as such there is a circular dependency.</span></span> <span data-ttu-id="03b10-174">Actualmente, no hay ninguna manera de restaurar estos archivos excepto reinstalar Windows.</span><span class="sxs-lookup"><span data-stu-id="03b10-174">Currently, there is no way to restore these files except to reinstall Windows.</span></span>

 

 
