---
description: Una vez que WMI finaliza con un proveedor, descarga el proveedor de la memoria.
ms.assetid: 6116769f-3402-42b3-835d-9bdb0fc27ce0
ms.tgt_platform: multiple
title: Descargar un proveedor
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 123d8c4f6b9d9155cdc22dc435635466956bdb0a
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/07/2021
ms.locfileid: "104544646"
---
# <a name="unloading-a-provider"></a><span data-ttu-id="a0db9-103">Descargar un proveedor</span><span class="sxs-lookup"><span data-stu-id="a0db9-103">Unloading a Provider</span></span>

<span data-ttu-id="a0db9-104">Una vez que WMI finaliza con un proveedor, descarga el proveedor de la memoria.</span><span class="sxs-lookup"><span data-stu-id="a0db9-104">After WMI is finished with a provider, it unloads the provider from memory.</span></span> <span data-ttu-id="a0db9-105">La razón principal por la que WMI descarga un proveedor es conservar los recursos del sistema.</span><span class="sxs-lookup"><span data-stu-id="a0db9-105">The primary reason WMI unloads a provider is to conserve system resources.</span></span> <span data-ttu-id="a0db9-106">Por lo tanto, debe agregar código que permita a WMI descargar el proveedor de una manera eficaz.</span><span class="sxs-lookup"><span data-stu-id="a0db9-106">Therefore, you must add code that allows WMI to unload your provider in an efficient manner.</span></span> <span data-ttu-id="a0db9-107">Tarda desde el intervalo especificado en el control de caché hasta el doble de ese intervalo para que WMI Descargue un proveedor.</span><span class="sxs-lookup"><span data-stu-id="a0db9-107">It takes anywhere from the interval specified in the cache control to twice that interval for WMI to unload a provider.</span></span>

<span data-ttu-id="a0db9-108">WMI descarga un proveedor de una de las siguientes maneras:</span><span class="sxs-lookup"><span data-stu-id="a0db9-108">WMI unloads a provider in one of the following ways:</span></span>

-   <span data-ttu-id="a0db9-109">Descargar un proveedor una vez que el proveedor finaliza las tareas que se le han dado.</span><span class="sxs-lookup"><span data-stu-id="a0db9-109">Unload a provider after the provider finishes the tasks given to it.</span></span>
-   <span data-ttu-id="a0db9-110">Descargue rápidamente todos los proveedores cuando el usuario apague el sistema.</span><span class="sxs-lookup"><span data-stu-id="a0db9-110">Quickly unload all providers when the user shuts down the system.</span></span> <span data-ttu-id="a0db9-111">Tenga en cuenta que WMI descarga los proveedores en proceso cuando se cierra el servicio WMI desde la línea de comandos.</span><span class="sxs-lookup"><span data-stu-id="a0db9-111">Note that WMI unloads in-process providers when the WMI service is shut down from the command line.</span></span>

<span data-ttu-id="a0db9-112">Aunque el primer escenario es más común, debe escribir el proveedor para ambas posibilidades.</span><span class="sxs-lookup"><span data-stu-id="a0db9-112">While the first scenario is more common, you must write your provider for both possibilities.</span></span>

<span data-ttu-id="a0db9-113">En este tema se describen las siguientes secciones:</span><span class="sxs-lookup"><span data-stu-id="a0db9-113">The following sections are discussed in this topic:</span></span>

-   [<span data-ttu-id="a0db9-114">Descargar un proveedor inactivo</span><span class="sxs-lookup"><span data-stu-id="a0db9-114">Unloading an Idle Provider</span></span>](#unloading-an-idle-provider)
-   [<span data-ttu-id="a0db9-115">Obtener acceso al tiempo de inactividad de un proveedor</span><span class="sxs-lookup"><span data-stu-id="a0db9-115">Accessing the Idle Time for a Provider</span></span>](#accessing-the-idle-time-for-a-provider)
-   [<span data-ttu-id="a0db9-116">Descargar un proveedor que también es un cliente WMI</span><span class="sxs-lookup"><span data-stu-id="a0db9-116">Unloading a Provider That Is Also a WMI Client</span></span>](#unloading-a-provider-that-is-also-a-wmi-client)
-   [<span data-ttu-id="a0db9-117">Descargar un proveedor durante el cierre</span><span class="sxs-lookup"><span data-stu-id="a0db9-117">Unloading a Provider During Shutdown</span></span>](#unloading-a-provider-during-shutdown)
-   [<span data-ttu-id="a0db9-118">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="a0db9-118">Related topics</span></span>](#related-topics)

## <a name="unloading-an-idle-provider"></a><span data-ttu-id="a0db9-119">Descargar un proveedor inactivo</span><span class="sxs-lookup"><span data-stu-id="a0db9-119">Unloading an Idle Provider</span></span>

<span data-ttu-id="a0db9-120">WMI realiza las siguientes acciones cuando descarga un proveedor inactivo:</span><span class="sxs-lookup"><span data-stu-id="a0db9-120">WMI performs the following actions when it unloads an idle provider:</span></span>

-   <span data-ttu-id="a0db9-121">Determina si el proveedor está inactivo.</span><span class="sxs-lookup"><span data-stu-id="a0db9-121">Determines if the provider is idle.</span></span>

    <span data-ttu-id="a0db9-122">WMI utiliza la propiedad **ClearAfter** para determinar cuánto tiempo un proveedor puede permanecer inactivo antes de descargar ese proveedor.</span><span class="sxs-lookup"><span data-stu-id="a0db9-122">WMI uses the **ClearAfter** property to determine how long a provider may stay idle before unloading that provider.</span></span> <span data-ttu-id="a0db9-123">Para obtener más información, vea [obtener acceso al tiempo de inactividad de un proveedor](#accessing-the-idle-time-for-a-provider).</span><span class="sxs-lookup"><span data-stu-id="a0db9-123">For more information, see [Accessing the Idle Time for a Provider](#accessing-the-idle-time-for-a-provider).</span></span>

-   <span data-ttu-id="a0db9-124">Llama al método de [**versión**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) del proveedor.</span><span class="sxs-lookup"><span data-stu-id="a0db9-124">Calls the [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) method of the provider.</span></span>

    <span data-ttu-id="a0db9-125">Si el proveedor era un proveedor puro, [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) quita completamente el proveedor de la memoria activa.</span><span class="sxs-lookup"><span data-stu-id="a0db9-125">If the provider was a pure provider, then [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) completely removes the provider from active memory.</span></span> <span data-ttu-id="a0db9-126">Sin embargo, un proveedor no puro puede continuar ejecutándose después de que WMI llame a **Release**.</span><span class="sxs-lookup"><span data-stu-id="a0db9-126">However, a nonpure provider may continue to run after WMI calls **Release**.</span></span>

## <a name="accessing-the-idle-time-for-a-provider"></a><span data-ttu-id="a0db9-127">Obtener acceso al tiempo de inactividad de un proveedor</span><span class="sxs-lookup"><span data-stu-id="a0db9-127">Accessing the Idle Time for a Provider</span></span>

<span data-ttu-id="a0db9-128">La cantidad mínima de tiempo que un proveedor permanece activo viene determinada por la propiedad **ClearAfter** .</span><span class="sxs-lookup"><span data-stu-id="a0db9-128">The minimum amount of time a provider remains active is determined by the **ClearAfter** property.</span></span> <span data-ttu-id="a0db9-129">Puede encontrar **ClearAfter** en instancias de clases derivadas de la clase del sistema WMI [**\_ \_ CacheControl**](--cachecontrol.md) en el \\ espacio de nombres raíz.</span><span class="sxs-lookup"><span data-stu-id="a0db9-129">You can find **ClearAfter** in instances of classes derived from the WMI system class [**\_\_CacheControl**](--cachecontrol.md) in the \\root namespace.</span></span>

<span data-ttu-id="a0db9-130">En la lista siguiente se describen las clases que se derivan de [**\_ \_ CacheControl**](--cachecontrol.md), que controla la descarga del proveedor:</span><span class="sxs-lookup"><span data-stu-id="a0db9-130">The following list describes the classes that are derived from [**\_\_CacheControl**](--cachecontrol.md), which controls provider unloading:</span></span>

-   [<span data-ttu-id="a0db9-131">**\_\_EventConsumerProviderCacheControl**</span><span class="sxs-lookup"><span data-stu-id="a0db9-131">**\_\_EventConsumerProviderCacheControl**</span></span>](--eventconsumerprovidercachecontrol.md)
-   [<span data-ttu-id="a0db9-132">**\_\_EventProviderCacheControl**</span><span class="sxs-lookup"><span data-stu-id="a0db9-132">**\_\_EventProviderCacheControl**</span></span>](--eventprovidercachecontrol.md)
-   [<span data-ttu-id="a0db9-133">**\_\_EventSinkCacheControl**</span><span class="sxs-lookup"><span data-stu-id="a0db9-133">**\_\_EventSinkCacheControl**</span></span>](--eventsinkcachecontrol.md)
-   [<span data-ttu-id="a0db9-134">**\_\_ObjectProviderCacheControl**</span><span class="sxs-lookup"><span data-stu-id="a0db9-134">**\_\_ObjectProviderCacheControl**</span></span>](--objectprovidercachecontrol.md)
-   [<span data-ttu-id="a0db9-135">**\_\_PropertyProviderCacheControl**</span><span class="sxs-lookup"><span data-stu-id="a0db9-135">**\_\_PropertyProviderCacheControl**</span></span>](--propertyprovidercachecontrol.md)

<span data-ttu-id="a0db9-136">Puede cambiar la cantidad mínima de tiempo que WMI permite que un proveedor permanezca inactivo editando la propiedad **ClearAfter** en la instancia de control de caché para un tipo específico de proveedor.</span><span class="sxs-lookup"><span data-stu-id="a0db9-136">You can change the minimum amount of time that WMI allows a provider to remain inactive by editing the **ClearAfter** property in the cache control instance for a specific type of provider.</span></span> <span data-ttu-id="a0db9-137">Por ejemplo, para limitar la cantidad de tiempo que un proveedor de propiedades puede permanecer inactivo, debe modificar la propiedad **ClearAfter** de una instancia de [**\_ \_ PropertyProviderCacheControl**](--propertyprovidercachecontrol.md) en el \\ espacio de nombres raíz.</span><span class="sxs-lookup"><span data-stu-id="a0db9-137">For example, to limit the amount of time a property provider can remain idle, you would edit the **ClearAfter** property of a [**\_\_PropertyProviderCacheControl**](--propertyprovidercachecontrol.md) instance in the \\root namespace.</span></span>

## <a name="unloading-a-provider-that-is-also-a-wmi-client"></a><span data-ttu-id="a0db9-138">Descargar un proveedor que también es un cliente WMI</span><span class="sxs-lookup"><span data-stu-id="a0db9-138">Unloading a Provider That Is Also a WMI Client</span></span>

<span data-ttu-id="a0db9-139">Es posible que el proveedor deba seguir siendo un cliente de WMI después de haber completado las funciones de proveedor a las que se llamó.</span><span class="sxs-lookup"><span data-stu-id="a0db9-139">Your provider may need to remain a client of WMI after it has completed the provider functions it was called to perform.</span></span> <span data-ttu-id="a0db9-140">Por ejemplo, un proveedor de inserciones puede necesitar emitir consultas a WMI.</span><span class="sxs-lookup"><span data-stu-id="a0db9-140">For example, a push provider may need to issue queries to WMI.</span></span> <span data-ttu-id="a0db9-141">Para obtener más información, vea [determinar el estado de inserción o extracción](determining-push-or-pull-status.md).</span><span class="sxs-lookup"><span data-stu-id="a0db9-141">For more information, see [Determining Push or Pull Status](determining-push-or-pull-status.md).</span></span> <span data-ttu-id="a0db9-142">En este caso, la propiedad **pura** de la instancia de [**\_ \_ Win32Provider**](--win32provider.md) que representa el proveedor debe establecerse en **true**.</span><span class="sxs-lookup"><span data-stu-id="a0db9-142">In this case, the **Pure** property of the [**\_\_Win32Provider**](--win32provider.md) instance that represents the provider should be set to **TRUE**.</span></span> <span data-ttu-id="a0db9-143">Si la propiedad **Pure** está establecida en **false**, el proveedor se prepara para la descarga llamando a [**IUnknown:: Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) en todos los puntos de interfaz pendientes cuando WMI llama al método de versión de su interfaz principal.</span><span class="sxs-lookup"><span data-stu-id="a0db9-143">If the **Pure** property is set to **FALSE**, the provider prepares to unload by calling [**IUnknown::Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) on all outstanding interface points when WMI calls the Release method of its primary interface.</span></span> <span data-ttu-id="a0db9-144">Para obtener más información, vea la sección Comentarios en [**\_ \_ Win32Provider**](--win32provider.md).</span><span class="sxs-lookup"><span data-stu-id="a0db9-144">For more information, see the Remarks section in [**\_\_Win32Provider**](--win32provider.md).</span></span>

<span data-ttu-id="a0db9-145">En el procedimiento siguiente se describe cómo implementar un método de versión para la interfaz principal de su proveedor.</span><span class="sxs-lookup"><span data-stu-id="a0db9-145">The following procedure describes how to implement a release method for the primary interface of your provider.</span></span>

<span data-ttu-id="a0db9-146">**Para descargar un proveedor**</span><span class="sxs-lookup"><span data-stu-id="a0db9-146">**To unload a provider**</span></span>

1.  <span data-ttu-id="a0db9-147">Libera todos los punteros de interfaz que se mantienen en WMI cuando WMI llama al método de [**versión**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) de la interfaz principal de su proveedor.</span><span class="sxs-lookup"><span data-stu-id="a0db9-147">Release all interface pointers held against WMI when WMI calls the [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) method of the primary interface of your provider.</span></span>

    <span data-ttu-id="a0db9-148">Normalmente, un proveedor contiene punteros a las interfaces [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) y [**IWbemContext**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemcontext) proporcionadas en [**IWbemProviderInit:: Initialize**](/windows/desktop/api/Wbemprov/nf-wbemprov-iwbemproviderinit-initialize).</span><span class="sxs-lookup"><span data-stu-id="a0db9-148">Typically, a provider holds pointers to the [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) and [**IWbemContext**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemcontext) interfaces supplied in [**IWbemProviderInit::Initialize**](/windows/desktop/api/Wbemprov/nf-wbemprov-iwbemproviderinit-initialize).</span></span>

2.  <span data-ttu-id="a0db9-149">Si la propiedad **pura** de la instancia de [**\_ \_ Win32Provider**](--win32provider.md) asociada está establecida en **false**, el proveedor puede realizar la transición al rol de la aplicación cliente después de que WMI llame a [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release).</span><span class="sxs-lookup"><span data-stu-id="a0db9-149">If the **Pure** property in the associated [**\_\_Win32Provider**](--win32provider.md) instance is set to **FALSE**, the provider can transition to the role of client application after WMI calls [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release).</span></span> <span data-ttu-id="a0db9-150">Sin embargo, WMI no puede descargar un proveedor que funciona como sistema cliente, lo que aumenta la sobrecarga del sistema.</span><span class="sxs-lookup"><span data-stu-id="a0db9-150">However, WMI cannot unload a provider that is operating as a client system, which increases the system overhead.</span></span>

    <span data-ttu-id="a0db9-151">Un proveedor con **Pure** establecido en **true** solo existe para las solicitudes de servicio.</span><span class="sxs-lookup"><span data-stu-id="a0db9-151">A provider with **Pure** set to **TRUE** exists only to service requests.</span></span> <span data-ttu-id="a0db9-152">Por lo tanto, este tipo de proveedor no puede asumir el rol de una aplicación cliente y WMI puede descargarlo.</span><span class="sxs-lookup"><span data-stu-id="a0db9-152">Therefore, this type of provider cannot take on the role of a client application and WMI can unload it.</span></span>

## <a name="unloading-a-provider-during-shutdown"></a><span data-ttu-id="a0db9-153">Descargar un proveedor durante el cierre</span><span class="sxs-lookup"><span data-stu-id="a0db9-153">Unloading a Provider During Shutdown</span></span>

<span data-ttu-id="a0db9-154">En circunstancias normales, el uso de las instrucciones de [descarga de un proveedor que también es un cliente WMI](#unloading-a-provider-that-is-also-a-wmi-client) permite a WMI descargar el proveedor correctamente.</span><span class="sxs-lookup"><span data-stu-id="a0db9-154">Under normal circumstances, using the guidelines in [Unloading a Provider That is Also a WMI Client](#unloading-a-provider-that-is-also-a-wmi-client) allows WMI to unload your provider properly.</span></span> <span data-ttu-id="a0db9-155">Sin embargo, es posible que se ejecuten situaciones en las que WMI no pueda establecer los procedimientos de descarga normales, como cuando el usuario elige apagar el sistema.</span><span class="sxs-lookup"><span data-stu-id="a0db9-155">However, you may run into situations where WMI is unable to instigate the normal unloading procedures, such as when the user chooses to shut the system down.</span></span> <span data-ttu-id="a0db9-156">Mediante el uso de un modelo de transacción de almacenamiento de datos, además de implementar una buena estrategia de limpieza, puede asegurarse de que el proveedor se ha descargado correctamente.</span><span class="sxs-lookup"><span data-stu-id="a0db9-156">By using a transaction model of data storage, in addition to implementing a good cleanup strategy, you can ensure that your provider is properly unloaded.</span></span>

<span data-ttu-id="a0db9-157">El usuario puede detener WMI en cualquier momento.</span><span class="sxs-lookup"><span data-stu-id="a0db9-157">The user may stop WMI at any time.</span></span> <span data-ttu-id="a0db9-158">En tal situación, WMI no descarga ningún proveedor o llama al punto de entrada de [**DllCanUnloadNow**](/windows/win32/api/combaseapi/nf-combaseapi-dllcanunloadnow) en cualquier proveedor en proceso.</span><span class="sxs-lookup"><span data-stu-id="a0db9-158">In such a situation, WMI does not unload any providers or call the [**DllCanUnloadNow**](/windows/win32/api/combaseapi/nf-combaseapi-dllcanunloadnow) entry point on any in-process provider.</span></span> <span data-ttu-id="a0db9-159">Además, si un proveedor en proceso está en medio de una llamada al método en el momento del cierre, WMI puede terminar el subproceso en medio de la llamada.</span><span class="sxs-lookup"><span data-stu-id="a0db9-159">Moreover, if an in-process provider is in the middle of a method call at the time of the shutdown, WMI can possibly terminate the executing thread in the middle of the call.</span></span> <span data-ttu-id="a0db9-160">En este caso, WMI no llama a rutinas que normalmente controlan la limpieza, como un destructor de objeto.</span><span class="sxs-lookup"><span data-stu-id="a0db9-160">In this circumstance, WMI does not call routines that normally handle cleanup, such as an object destructor.</span></span> <span data-ttu-id="a0db9-161">Como máximo, WMI llamará solo a [**DllMain**](/windows/desktop/Dlls/dllmain) .</span><span class="sxs-lookup"><span data-stu-id="a0db9-161">At most, WMI will call [**DllMain**](/windows/desktop/Dlls/dllmain) only.</span></span>

<span data-ttu-id="a0db9-162">Cuando el sistema operativo apaga WMI, el sistema libera automáticamente toda la memoria asignada a un proveedor en proceso.</span><span class="sxs-lookup"><span data-stu-id="a0db9-162">When the operating system shuts down WMI, the system automatically releases all memory allocated to an in-process provider.</span></span> <span data-ttu-id="a0db9-163">El sistema operativo también cierra la mayoría de los recursos que mantiene el proveedor, como los identificadores de archivo, los identificadores de ventana, etc.</span><span class="sxs-lookup"><span data-stu-id="a0db9-163">The operating system also closes most resources held by the provider, such as file handles, window handles, and so on.</span></span> <span data-ttu-id="a0db9-164">No es necesario que el proveedor realice ninguna acción específica para que esto suceda.</span><span class="sxs-lookup"><span data-stu-id="a0db9-164">The provider does not need to take any specific action to make this happen.</span></span>

<span data-ttu-id="a0db9-165">Dado que WMI puede cerrarse en medio de una llamada, un proveedor no debe dejar los orígenes de datos en un estado incoherente.</span><span class="sxs-lookup"><span data-stu-id="a0db9-165">Because WMI may shut down in the middle of a call, a provider should not leave data sources in an inconsistent state.</span></span> <span data-ttu-id="a0db9-166">La salida de los datos en un estado incoherente no es un problema para los proveedores de solo lectura.</span><span class="sxs-lookup"><span data-stu-id="a0db9-166">Leaving your data in an inconsistent state is not a problem for read-only providers.</span></span> <span data-ttu-id="a0db9-167">Sin embargo, los proveedores con capacidades de escritura pueden querer implementar algún tipo de modelo de transacción para permitir una reversión segura después de una terminación brusca.</span><span class="sxs-lookup"><span data-stu-id="a0db9-167">However, providers with write capabilities may want to implement some sort of transaction model to allow a safe rollback after an abrupt termination.</span></span>

<span data-ttu-id="a0db9-168">Aunque el sistema operativo puede liberar algunos recursos generales del sistema, el sistema no libera automáticamente todos los recursos.</span><span class="sxs-lookup"><span data-stu-id="a0db9-168">While the operating system may release some general system resources, the system does not automatically release all resources.</span></span> <span data-ttu-id="a0db9-169">Por ejemplo, el sistema operativo puede no liberar un socket o una conexión de base de datos.</span><span class="sxs-lookup"><span data-stu-id="a0db9-169">For example, the operating system may not release a socket or a database connection.</span></span> <span data-ttu-id="a0db9-170">En su lugar, es posible que el proveedor tenga que limpiar estos recursos manualmente.</span><span class="sxs-lookup"><span data-stu-id="a0db9-170">Instead, the provider may need to manually clean up such resources.</span></span> <span data-ttu-id="a0db9-171">Para evitar estos problemas, puede implementar el proveedor fuera de proceso, o bien puede Agregar el código de limpieza.</span><span class="sxs-lookup"><span data-stu-id="a0db9-171">To avoid these problems, you can either implement your provider out-of-process, or you can add cleanup code.</span></span>

<span data-ttu-id="a0db9-172">La solución más sencilla consiste en implementar el proveedor fuera de proceso.</span><span class="sxs-lookup"><span data-stu-id="a0db9-172">The simplest solution is to implement your provider out-of-process.</span></span> <span data-ttu-id="a0db9-173">Un proveedor fuera de proceso no se elimina cuando WMI se cierra, aunque WMI liberará al proveedor después de un tiempo de espera de COM.</span><span class="sxs-lookup"><span data-stu-id="a0db9-173">An out-of-process provider is not killed when WMI shuts down, although WMI will release the provider after a COM timeout.</span></span> <span data-ttu-id="a0db9-174">Los proveedores para los que los problemas de solidez de la limpieza y terminación son más importantes que el rendimiento puede estar fuera del proceso.</span><span class="sxs-lookup"><span data-stu-id="a0db9-174">Providers for whom cleanup and termination robustness issues are more important than performance may be out-of-process.</span></span>

<span data-ttu-id="a0db9-175">Si debe colocar el código de limpieza en el proveedor, tiene dos opciones.</span><span class="sxs-lookup"><span data-stu-id="a0db9-175">If you must place cleanup code in your provider, you have two options.</span></span> <span data-ttu-id="a0db9-176">Un lugar para realizar este tipo de limpieza es [**DllMain**](/windows/desktop/Dlls/dllmain), la función de punto de entrada de dll a la que llama el sistema operativo al descargar el archivo dll.</span><span class="sxs-lookup"><span data-stu-id="a0db9-176">One place to perform this sort of cleanup is [**DllMain**](/windows/desktop/Dlls/dllmain), the DLL entry point function the operating system calls when unloading the DLL.</span></span> <span data-ttu-id="a0db9-177">El código de limpieza se puede agregar directamente a **DllMain** y ejecutarlo en respuesta a la **\_ \_ desasociación del proceso dll**.</span><span class="sxs-lookup"><span data-stu-id="a0db9-177">Cleanup code can be added directly into **DllMain**, executing it in response to **DLL\_PROCESS\_DETACH**.</span></span> <span data-ttu-id="a0db9-178">Implementar el código de limpieza en **DllMain** puede ser algo difícil de organizar, especialmente en entornos de programación como MFC o ATL.</span><span class="sxs-lookup"><span data-stu-id="a0db9-178">Implementing cleanup code in **DllMain** can be somewhat difficult to arrange, especially in programming environments such as MFC or ATL.</span></span> <span data-ttu-id="a0db9-179">Para obtener más información, vea el artículo de Microsoft Knowledge Base Q148791, "How to representate *Your Own in a MFC normal dll".*</span><span class="sxs-lookup"><span data-stu-id="a0db9-179">For more information, see the Microsoft Knowledge Base article Q148791, "*How to Provide Your Own DllMain in an MFC Regular DLL.*"</span></span> <span data-ttu-id="a0db9-180">(Es posible que este recurso no esté disponible en algunos idiomas y países o regiones).</span><span class="sxs-lookup"><span data-stu-id="a0db9-180">(This resource may not be available in some languages and countries or regions.)</span></span>

<span data-ttu-id="a0db9-181">Como alternativa, también puede colocar el código de limpieza en el destructor de una clase global.</span><span class="sxs-lookup"><span data-stu-id="a0db9-181">Alternately, you could also place the cleanup code in the destructor of a global class.</span></span> <span data-ttu-id="a0db9-182">Para obtener más información, vea descargar un proveedor.</span><span class="sxs-lookup"><span data-stu-id="a0db9-182">For more information, see Unloading a Provider.</span></span> <span data-ttu-id="a0db9-183">El sistema operativo Windows no asigna objetos globales en el montón.</span><span class="sxs-lookup"><span data-stu-id="a0db9-183">The Windows operating system does not allocate global objects on the heap.</span></span> <span data-ttu-id="a0db9-184">En su lugar, el sistema operativo llama a los destructores durante la descarga del archivo DLL.</span><span class="sxs-lookup"><span data-stu-id="a0db9-184">Instead, the operating system calls the destructors during DLL unload.</span></span>

<span data-ttu-id="a0db9-185">A continuación se facilita un procedimiento de limpieza sencillo que podría caber dentro de un objeto global para WMI.</span><span class="sxs-lookup"><span data-stu-id="a0db9-185">The following is a simple cleanup procedure that could fit inside a global object for WMI.</span></span>


```C++
class CMyCleanup
{
    ~CMyCleanup()
    {
        CloseHandle(m_hOpenFile);
        CloseDatabaseConnection(g_hDatabase);
    }
} g_Cleanup;
```



<span data-ttu-id="a0db9-186">Hay muchas restricciones en cuanto a lo que se puede hacer en el código de limpieza con cualquier enfoque.</span><span class="sxs-lookup"><span data-stu-id="a0db9-186">There are many restrictions as to what can be done in the cleanup code with either approach.</span></span> <span data-ttu-id="a0db9-187">Por ejemplo, no se puede tener acceso a ninguno de los subprocesos ni a los archivos DLL que no estén vinculados de forma implícita.</span><span class="sxs-lookup"><span data-stu-id="a0db9-187">For example, neither threads nor any DLLs that are not implicitly linked may be accessed in any way.</span></span> <span data-ttu-id="a0db9-188">Además, no puede realizar llamadas COM en ningún caso.</span><span class="sxs-lookup"><span data-stu-id="a0db9-188">Further, you cannot make COM calls under any circumstances.</span></span>

## <a name="related-topics"></a><span data-ttu-id="a0db9-189">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="a0db9-189">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="a0db9-190">Configuración de descriptores de seguridad de espacio</span><span class="sxs-lookup"><span data-stu-id="a0db9-190">Setting Namepace Security Descriptors</span></span>](setting-namespace-security-descriptors.md)
</dt> <dt>

[<span data-ttu-id="a0db9-191">Protección del proveedor</span><span class="sxs-lookup"><span data-stu-id="a0db9-191">Securing Your Provider</span></span>](securing-your-provider.md)
</dt> <dt>

[<span data-ttu-id="a0db9-192">Desarrollar un proveedor WMI</span><span class="sxs-lookup"><span data-stu-id="a0db9-192">Developing a WMI Provider</span></span>](developing-a-wmi-provider.md)
</dt> </dl>

 

 
