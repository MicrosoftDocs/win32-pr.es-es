---
title: Mapas de instantáneas en cascada
description: Los mapas de sombras en cascada (CSMs) son la mejor manera de combatir uno de los errores más frecuentes con el alias de perspectiva de sombreado.
ms.assetid: d3570d0a-74e0-5b9c-6586-c933f630c4ee
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ae70433f97f33c3cc28af8e282b14ea1f513cf4d
ms.sourcegitcommit: 54db9e6a00a5c8f68e7c1a16b8c6d4943374498c
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 04/01/2021
ms.locfileid: "106165525"
---
# <a name="cascaded-shadow-maps"></a><span data-ttu-id="08f11-103">Mapas de instantáneas en cascada</span><span class="sxs-lookup"><span data-stu-id="08f11-103">Cascaded Shadow Maps</span></span>

<span data-ttu-id="08f11-104">Los mapas de sombras en cascada (CSMs) son la mejor manera de combatir uno de los errores más frecuentes con el sombreado: el alias de perspectiva.</span><span class="sxs-lookup"><span data-stu-id="08f11-104">Cascaded shadow maps (CSMs) are the best way to combat one of the most prevalent errors with shadowing: perspective aliasing.</span></span> <span data-ttu-id="08f11-105">En este artículo técnico, en el que se da por supuesto que el lector está familiarizado con la asignación de instantáneas, aborda el tema de CSMs.</span><span class="sxs-lookup"><span data-stu-id="08f11-105">This technical article, which assumes the reader is familiar with shadow mapping, tackles the topic of CSMs.</span></span> <span data-ttu-id="08f11-106">Concretamente:</span><span class="sxs-lookup"><span data-stu-id="08f11-106">Specifically, it:</span></span>

-   <span data-ttu-id="08f11-107">explica la complejidad de CSMs;</span><span class="sxs-lookup"><span data-stu-id="08f11-107">explains the complexity of CSMs;</span></span>
-   <span data-ttu-id="08f11-108">proporciona detalles sobre las posibles variaciones de los algoritmos de CSM;</span><span class="sxs-lookup"><span data-stu-id="08f11-108">gives details on the possible variations of the CSM algorithms;</span></span>
-   <span data-ttu-id="08f11-109">describe las dos técnicas de filtrado más comunes: el filtrado de porcentaje más cercano (PCF) y el filtrado con mapas de instantáneas de varianza (VSMs).</span><span class="sxs-lookup"><span data-stu-id="08f11-109">describes the two most common filtering techniques—percentage closer filtering (PCF) and filtering with variance shadow maps (VSMs);</span></span>
-   <span data-ttu-id="08f11-110">identifica y aborda algunos de los problemas comunes asociados a la adición de filtrado a CSMs; etc</span><span class="sxs-lookup"><span data-stu-id="08f11-110">identifies and addresses some of the common pitfalls associated with adding filtering to CSMs; and</span></span>
-   <span data-ttu-id="08f11-111">muestra cómo asignar CSMs a Direct3D 10 a través de hardware de Direct3D 11.</span><span class="sxs-lookup"><span data-stu-id="08f11-111">shows how to map CSMs to Direct3D 10 through Direct3D 11 hardware.</span></span>

<span data-ttu-id="08f11-112">El código que se usa en este artículo se puede encontrar en el kit de desarrollo de software (SDK) de DirectX, en los ejemplos de CascadedShadowMaps11 y VarianceShadows11.</span><span class="sxs-lookup"><span data-stu-id="08f11-112">The code used in this article can be found in the DirectX Software Development Kit (SDK) in the CascadedShadowMaps11 and VarianceShadows11 samples.</span></span> <span data-ttu-id="08f11-113">Este artículo resultará de gran utilidad después de implementar las técnicas que se describen en el artículo técnico, se implementan [técnicas comunes para mejorar las asignaciones de profundidad](/windows/desktop/DxTechArts/common-techniques-to-improve-shadow-depth-maps)de la sombra.</span><span class="sxs-lookup"><span data-stu-id="08f11-113">This article will prove most useful after implementing the techniques covered in the technical article, [Common Techniques to Improve Shadow Depth Maps](/windows/desktop/DxTechArts/common-techniques-to-improve-shadow-depth-maps), are implemented.</span></span>

## <a name="cascaded-shadow-maps-and-perspective-aliasing"></a><span data-ttu-id="08f11-114">Mapas de sombras en cascada y alias de perspectiva</span><span class="sxs-lookup"><span data-stu-id="08f11-114">Cascaded Shadow Maps and Perspective Aliasing</span></span>

<span data-ttu-id="08f11-115">El alias de perspectiva de un mapa de sombras es uno de los problemas más difíciles de superar.</span><span class="sxs-lookup"><span data-stu-id="08f11-115">Perspective aliasing in a shadow map is one of the most difficult problems to overcome.</span></span> <span data-ttu-id="08f11-116">En el artículo técnico, técnicas comunes para mejorar las asignaciones de profundidad de sombra, se describe el alias de perspectiva y se identifican algunos enfoques para mitigar el problema.</span><span class="sxs-lookup"><span data-stu-id="08f11-116">In the technical article, Common Techniques to Improve Shadow Depth Maps, perspective aliasing is described and some approaches to mitigate the problem are identified.</span></span> <span data-ttu-id="08f11-117">En la práctica, CSMs tiende a ser la mejor solución y se suele emplear en juegos modernos.</span><span class="sxs-lookup"><span data-stu-id="08f11-117">In practice, CSMs tend to be the best solution, and are commonly employed in modern games.</span></span>

<span data-ttu-id="08f11-118">El concepto básico de CSMs es fácil de entender.</span><span class="sxs-lookup"><span data-stu-id="08f11-118">The basic concept of CSMs is easy to understand.</span></span> <span data-ttu-id="08f11-119">Las distintas áreas del frustum de la cámara requieren mapas de sombras con distintas resoluciones.</span><span class="sxs-lookup"><span data-stu-id="08f11-119">Different areas of the camera frustum require shadow maps with different resolutions.</span></span> <span data-ttu-id="08f11-120">Los objetos más cercanos al ojo requieren una resolución mayor que los objetos más lejanos.</span><span class="sxs-lookup"><span data-stu-id="08f11-120">Objects nearest the eye require a higher resolution than do more distant objects.</span></span> <span data-ttu-id="08f11-121">De hecho, cuando el ojo se desplaza muy cerca de la geometría, los píxeles más cercanos al ojo pueden requerir tanta resolución que incluso una asignación sombra 4096 × 4096 sea insuficiente.</span><span class="sxs-lookup"><span data-stu-id="08f11-121">In fact, when the eye moves very close to the geometry, the pixels nearest the eye can require so much resolution that even a 4096 × 4096 shadow map is insufficient.</span></span>

<span data-ttu-id="08f11-122">La idea básica de CSMs es particionar el frustum en varios Frusta.</span><span class="sxs-lookup"><span data-stu-id="08f11-122">The basic idea of CSMs is to partition the frustum into multiple frusta.</span></span> <span data-ttu-id="08f11-123">Se representa un mapa de sombras para cada subfrustum; a continuación, el sombreador de píxeles muestrea el mapa que más se aproxime a la resolución necesaria (Figura 2).</span><span class="sxs-lookup"><span data-stu-id="08f11-123">A shadow map is rendered for each subfrustum; the pixel shader then samples from the map that most closely matches the required resolution (Figure 2).</span></span>

<span data-ttu-id="08f11-124">**Figura 1. Cobertura de mapas de sombras**</span><span class="sxs-lookup"><span data-stu-id="08f11-124">**Figure 1. Shadow map coverage**</span></span>

![cobertura de mapas de sombras](images/shadow-map-coverage.png)

<span data-ttu-id="08f11-126">En la figura 1, se muestra la calidad (de izquierda a derecha) de mayor a menor.</span><span class="sxs-lookup"><span data-stu-id="08f11-126">In Figure 1, quality is shown (left to right) from highest to lowest.</span></span> <span data-ttu-id="08f11-127">La serie de cuadrículas que representan las asignaciones de sombra con un frustum de vista (cono invertido en rojo) muestra cómo se ve afectada la cobertura de píxeles con mapas de sombras de resolución diferentes.</span><span class="sxs-lookup"><span data-stu-id="08f11-127">The series of grids representing shadow maps with a view frustum (inverted cone in red) shows how pixel coverage is affected with different resolution shadow maps.</span></span> <span data-ttu-id="08f11-128">Las sombras tienen la máxima calidad (píxeles blancos) cuando hay una relación de 1:1 píxeles en el espacio claro para textura en el mapa de instantáneas.</span><span class="sxs-lookup"><span data-stu-id="08f11-128">Shadows are of the highest quality (white pixels) when there is a 1:1 ratio mapping pixels in light space to texels in the shadow map.</span></span> <span data-ttu-id="08f11-129">El alias de perspectiva se produce en forma de grandes mapas de texturas de bloque (imagen izquierda) cuando hay demasiados píxeles asignados a la misma sombra textura.</span><span class="sxs-lookup"><span data-stu-id="08f11-129">Perspective aliasing occurs in the form of large, blocky texture maps (left image) when too many pixels map to the same shadow texel.</span></span> <span data-ttu-id="08f11-130">Cuando el mapa de sombras es demasiado grande, se muestra en el ejemplo.</span><span class="sxs-lookup"><span data-stu-id="08f11-130">When the shadow map is too large, it is under sampled.</span></span> <span data-ttu-id="08f11-131">En este caso, se omiten los textura, se introducen los artefactos de Shimmering y el rendimiento se ve afectado.</span><span class="sxs-lookup"><span data-stu-id="08f11-131">In this case, texels are skipped, shimmering artifacts are introduced, and performance is affected.</span></span>

<span data-ttu-id="08f11-132">**Figura 2. Calidad de sombra CSM**</span><span class="sxs-lookup"><span data-stu-id="08f11-132">**Figure 2. CSM shadow quality**</span></span>

![calidad de sombra CSM](images/csm-shadow-quality.png)

<span data-ttu-id="08f11-134">En la figura 2 se muestran recortes de la sección de mayor calidad de cada mapa de sombras de la ilustración 1.</span><span class="sxs-lookup"><span data-stu-id="08f11-134">Figure 2 shows cutouts from the highest quality section in each shadow map in Figure 1.</span></span> <span data-ttu-id="08f11-135">El mapa de sombra con los píxeles más estrechamente colocados (en el vértice) es más cercano a la vista.</span><span class="sxs-lookup"><span data-stu-id="08f11-135">The shadow map with the most closely placed pixels (at the apex) is nearest the eye.</span></span> <span data-ttu-id="08f11-136">Técnicamente, se trata de mapas del mismo tamaño, con blanco y gris usados para ejemplificar el éxito de la asignación de instantáneas en cascada.</span><span class="sxs-lookup"><span data-stu-id="08f11-136">Technically, these are maps of the same size, with white and grey used to exemplify the success of the cascaded shadow map.</span></span> <span data-ttu-id="08f11-137">El blanco es idóneo porque muestra una buena cobertura, una relación 1:1 para los píxeles de espacio ocular y el textura de mapa de sombras.</span><span class="sxs-lookup"><span data-stu-id="08f11-137">White is ideal because it shows good coverage—a 1:1 ratio for eye-space pixels and shadow-map texels.</span></span>

<span data-ttu-id="08f11-138">CSMs requiere los siguientes pasos por fotograma.</span><span class="sxs-lookup"><span data-stu-id="08f11-138">CSMs require the following steps per frame.</span></span>

1.  <span data-ttu-id="08f11-139">Divida el frustum en subfrusta.</span><span class="sxs-lookup"><span data-stu-id="08f11-139">Partition the frustum into subfrusta.</span></span>
2.  <span data-ttu-id="08f11-140">Calcule una proyección ortográfica para cada subfrustum.</span><span class="sxs-lookup"><span data-stu-id="08f11-140">Compute an orthographic projection for each subfrustum.</span></span>
3.  <span data-ttu-id="08f11-141">Representar un mapa de instantáneas para cada subfrustum.</span><span class="sxs-lookup"><span data-stu-id="08f11-141">Render a shadow map for each subfrustum.</span></span>
4.  <span data-ttu-id="08f11-142">Representar la escena.</span><span class="sxs-lookup"><span data-stu-id="08f11-142">Render the scene.</span></span>

    1.  <span data-ttu-id="08f11-143">Enlazar los mapas de sombras y representar.</span><span class="sxs-lookup"><span data-stu-id="08f11-143">Bind the shadow maps and render.</span></span>
    2.  <span data-ttu-id="08f11-144">El sombreador de vértices hace lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="08f11-144">The vertex shader does the following:</span></span>

        -   <span data-ttu-id="08f11-145">Calcula las coordenadas de textura para cada subfrustum claro (a menos que la coordenada de textura necesaria se calcule en el sombreador de píxeles).</span><span class="sxs-lookup"><span data-stu-id="08f11-145">Computes texture coordinates for each light subfrustum (unless the needed texture coordinate is calculated in the pixel shader).</span></span>
        -   <span data-ttu-id="08f11-146">Transforma y ilumina el vértice, y así sucesivamente.</span><span class="sxs-lookup"><span data-stu-id="08f11-146">Transforms and lights the vertex, and so on.</span></span>

    3.  <span data-ttu-id="08f11-147">El sombreador de píxeles hace lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="08f11-147">The pixel shader does the following:</span></span>

        -   <span data-ttu-id="08f11-148">Determina la asignación de instantáneas adecuada.</span><span class="sxs-lookup"><span data-stu-id="08f11-148">Determines the proper shadow map.</span></span>
        -   <span data-ttu-id="08f11-149">Transforma las coordenadas de textura si es necesario.</span><span class="sxs-lookup"><span data-stu-id="08f11-149">Transforms the texture coordinates if necessary.</span></span>
        -   <span data-ttu-id="08f11-150">Muestrea la cascada.</span><span class="sxs-lookup"><span data-stu-id="08f11-150">Samples the cascade.</span></span>
        -   <span data-ttu-id="08f11-151">Enciende el píxel.</span><span class="sxs-lookup"><span data-stu-id="08f11-151">Lights the pixel.</span></span>

## <a name="partitioning-the-frustum"></a><span data-ttu-id="08f11-152">Crear particiones del frustum</span><span class="sxs-lookup"><span data-stu-id="08f11-152">Partitioning the Frustum</span></span>

<span data-ttu-id="08f11-153">La creación de particiones del frustum es el acto de crear subfrusta.</span><span class="sxs-lookup"><span data-stu-id="08f11-153">Partitioning the frustum is the act of creating subfrusta.</span></span> <span data-ttu-id="08f11-154">Una técnica para dividir el frustum es calcular los intervalos del cero al 100 por ciento en la dirección Z.</span><span class="sxs-lookup"><span data-stu-id="08f11-154">One technique for splitting the frustum is to calculate intervals from zero percent to one hundred percent in the Z-direction.</span></span> <span data-ttu-id="08f11-155">Cada intervalo representa después un plano cercano y un plano lejano como un porcentaje del eje Z.</span><span class="sxs-lookup"><span data-stu-id="08f11-155">Each interval then represents a near plane and a far plane as a percentage of the Z-axis.</span></span>

<span data-ttu-id="08f11-156">**Figura 3. Ver Frustums con particiones arbitrariamente**</span><span class="sxs-lookup"><span data-stu-id="08f11-156">**Figure 3. View frustums partitioned arbitrarily**</span></span>

![Ver Frustums con particiones arbitrariamente](images/view-frustums-partitioned-arbitrarily.png)

<span data-ttu-id="08f11-158">En la práctica, el recálculo de las divisiones del frustum por fotogramas provoca que los bordes de la sombra se Shimmer.</span><span class="sxs-lookup"><span data-stu-id="08f11-158">In practice, recalculating the frustum splits per frame causes shadow edges to shimmer.</span></span> <span data-ttu-id="08f11-159">La práctica generalmente aceptada es usar un conjunto estático de intervalos en cascada por escenario.</span><span class="sxs-lookup"><span data-stu-id="08f11-159">The generally accepted practice is to use a static set of cascade intervals per scenario.</span></span> <span data-ttu-id="08f11-160">En este escenario, el intervalo a lo largo del eje Z se usa para describir un subfrustum que se produce al particionar el frustum.</span><span class="sxs-lookup"><span data-stu-id="08f11-160">In this scenario, the interval along the Z-axis is used to describe a subfrustum that occurs when partitioning the frustum.</span></span> <span data-ttu-id="08f11-161">La determinación de los intervalos de tamaño correctos para una determinada escena depende de varios factores.</span><span class="sxs-lookup"><span data-stu-id="08f11-161">Determining the correct size intervals for a given scene depends upon several factors.</span></span>

### <a name="orientation-of-the-scene-geometry"></a><span data-ttu-id="08f11-162">Orientación de la geometría de la escena</span><span class="sxs-lookup"><span data-stu-id="08f11-162">Orientation of the Scene Geometry</span></span>

<span data-ttu-id="08f11-163">Con respecto a la geometría de la escena, la orientación de la cámara afecta a la selección del intervalo en cascada.</span><span class="sxs-lookup"><span data-stu-id="08f11-163">With respect to scene geometry, camera orientation affects cascade interval selection.</span></span> <span data-ttu-id="08f11-164">Por ejemplo, una cámara muy cerca del suelo, como una cámara de fondo en un juego de fútbol, tiene un conjunto estático de intervalos en cascada diferente al de una cámara del cielo.</span><span class="sxs-lookup"><span data-stu-id="08f11-164">For example, a camera very near the ground, such as a ground camera in a football game, has a different static set of cascade intervals than a camera in the sky.</span></span>

<span data-ttu-id="08f11-165">La figura 4 muestra algunas cámaras diferentes y sus respectivas particiones.</span><span class="sxs-lookup"><span data-stu-id="08f11-165">Figure 4 shows some different cameras and their respective partitions.</span></span> <span data-ttu-id="08f11-166">Cuando el intervalo Z de la escena es muy grande, se necesitan más planos divididos.</span><span class="sxs-lookup"><span data-stu-id="08f11-166">When the scene's Z-range is very large, more split planes are required.</span></span> <span data-ttu-id="08f11-167">Por ejemplo, cuando el ojo está muy cerca del plano básico, pero los objetos lejanos siguen siendo visibles, pueden ser necesarias varias cascadas.</span><span class="sxs-lookup"><span data-stu-id="08f11-167">For example, when the eye is very near the ground plane, but distant objects are still visible, multiple cascades can be necessary.</span></span> <span data-ttu-id="08f11-168">Dividir el frustum de modo que haya más divisiones cerca del ojo (donde el alias de perspectiva cambia el más rápido) también es útil.</span><span class="sxs-lookup"><span data-stu-id="08f11-168">Dividing the frustum so that more splits are near the eye (where perspective aliasing is changing the fastest) is also valuable.</span></span> <span data-ttu-id="08f11-169">Cuando la mayor parte de la geometría se agrupa en una pequeña sección (como una vista de sobrecarga o un simulador de vuelos) del frustum de vista, se necesitan menos cascadas.</span><span class="sxs-lookup"><span data-stu-id="08f11-169">When most of the geometry is clumped into a small section (such as an overhead view or a flight simulator) of the view frustum, fewer cascades are necessary.</span></span>

<span data-ttu-id="08f11-170">**Figura 4. Distintas configuraciones requieren diferentes divisiones de frustum**</span><span class="sxs-lookup"><span data-stu-id="08f11-170">**Figure 4. Different configurations require different frustum splits**</span></span>

![distintas configuraciones requieren diferentes divisiones de frustum](images/different-configurations-require-different-frustum-splits.png)

<span data-ttu-id="08f11-172">Salido Cuando Geometry tiene un intervalo dinámico alto en Z, se necesitan muchos en cascada.</span><span class="sxs-lookup"><span data-stu-id="08f11-172">(Left) When geometry has a high dynamic range in Z, lots of cascades are required.</span></span> <span data-ttu-id="08f11-173">Centro Cuando la geometría tiene un intervalo dinámico bajo en Z, hay pocas ventajas de varios Frustums.</span><span class="sxs-lookup"><span data-stu-id="08f11-173">(Center) When the geometry has low dynamic range in Z, there is little benefit from multiple frustums.</span></span> <span data-ttu-id="08f11-174">Correcta Solo se necesitan tres particiones cuando el intervalo dinámico es medio.</span><span class="sxs-lookup"><span data-stu-id="08f11-174">(Right) Only three partitions are needed when the dynamic range is medium.</span></span>

### <a name="orientation-of-the-light-and-the-camera"></a><span data-ttu-id="08f11-175">Orientación de la luz y la cámara</span><span class="sxs-lookup"><span data-stu-id="08f11-175">Orientation of the Light and the Camera</span></span>

<span data-ttu-id="08f11-176">Cada matriz de proyección en cascada se ajusta en torno a su subfrustum correspondiente.</span><span class="sxs-lookup"><span data-stu-id="08f11-176">Each cascade's projection matrix is fit tightly around its corresponding subfrustum.</span></span> <span data-ttu-id="08f11-177">En las configuraciones en las que la cámara de la vista y las direcciones de la luz son ortogonales, los valores en cascada pueden ajustarse con poca superposición.</span><span class="sxs-lookup"><span data-stu-id="08f11-177">In configurations where the view camera and the light directions are orthogonal, the cascades can be fit tightly with little overlap.</span></span> <span data-ttu-id="08f11-178">La superposición es mayor a medida que la luz y la cámara de la vista pasan a la alineación paralela (Figura 5).</span><span class="sxs-lookup"><span data-stu-id="08f11-178">The overlap becomes larger as the light and the view camera move into parallel alignment (Figure 5).</span></span> <span data-ttu-id="08f11-179">Cuando la luz y la cámara de la vista son casi paralelas, se denomina "dueling Frusta" y es un escenario muy difícil de la mayoría de los algoritmos de sombreado.</span><span class="sxs-lookup"><span data-stu-id="08f11-179">When the light and the view camera are nearly parallel, it is called a "dueling frusta," and is a very hard scenario for most shadowing algorithms.</span></span> <span data-ttu-id="08f11-180">No es raro restringir la luz y la cámara para que no se produzca este escenario.</span><span class="sxs-lookup"><span data-stu-id="08f11-180">It is not uncommon to constrain the light and camera so that this scenario does not occur.</span></span> <span data-ttu-id="08f11-181">Sin embargo, CSMs funcionan mucho mejor que muchos otros algoritmos en este escenario.</span><span class="sxs-lookup"><span data-stu-id="08f11-181">CSMs, however, perform much better than many other algorithms in this scenario.</span></span>

<span data-ttu-id="08f11-182">**Figura 5. La superposición en cascada aumenta a medida que la dirección clara se vuelve paralela a la dirección de la cámara**</span><span class="sxs-lookup"><span data-stu-id="08f11-182">**Figure 5. Cascade overlap increases as light direction becomes parallel with camera direction**</span></span>

![la superposición en cascada aumenta a medida que la dirección clara se vuelve paralela a la dirección de la cámara](images/cascade-overlap-increases-as-light-direction-becomes.jpg)

<span data-ttu-id="08f11-184">Muchas implementaciones de CSM usan Frusta de tamaño fijo.</span><span class="sxs-lookup"><span data-stu-id="08f11-184">Many CSM implementations use fixed-size frusta.</span></span> <span data-ttu-id="08f11-185">El sombreador de píxeles puede usar la profundidad Z para indexar en la matriz de valores en cascada cuando el frustum se divide en intervalos de tamaño fijo.</span><span class="sxs-lookup"><span data-stu-id="08f11-185">The pixel shader can use the Z-depth to index into the array of cascades when the frustum is split in fixed-size intervals.</span></span>

## <a name="calculating-a-view-frustum-bound"></a><span data-ttu-id="08f11-186">Calcular un View-Frustum enlazado</span><span class="sxs-lookup"><span data-stu-id="08f11-186">Calculating a View-Frustum Bound</span></span>

<span data-ttu-id="08f11-187">Una vez seleccionados los intervalos de frustum, los subfrusta se crean con uno de los dos: ajustar a la escena y ajustar a la cascada.</span><span class="sxs-lookup"><span data-stu-id="08f11-187">Once the frustum intervals are selected, the subfrusta are created using one of two: fit to scene and fit to cascade.</span></span>

### <a name="fit-to-scene"></a><span data-ttu-id="08f11-188">Ajustar a la escena</span><span class="sxs-lookup"><span data-stu-id="08f11-188">Fit to Scene</span></span>

<span data-ttu-id="08f11-189">Todas las Frusta se pueden crear con el mismo plano próximo.</span><span class="sxs-lookup"><span data-stu-id="08f11-189">All of the frusta can be created with the same near plane.</span></span> <span data-ttu-id="08f11-190">Esto obliga a que las cascadas se superpongan.</span><span class="sxs-lookup"><span data-stu-id="08f11-190">This forces the cascades to overlap.</span></span> <span data-ttu-id="08f11-191">El ejemplo CascadedShadowMaps11 llama a esta técnica ajustada a la escena.</span><span class="sxs-lookup"><span data-stu-id="08f11-191">The CascadedShadowMaps11 sample calls this technique fit to scene.</span></span>

### <a name="fit-to-cascade"></a><span data-ttu-id="08f11-192">Ajustar a cascada</span><span class="sxs-lookup"><span data-stu-id="08f11-192">Fit to Cascade</span></span>

<span data-ttu-id="08f11-193">Como alternativa, se puede crear Frusta con el intervalo de partición real que se usa como plano Near y Far.</span><span class="sxs-lookup"><span data-stu-id="08f11-193">Alternatively, frusta can be created with the actual partition interval being used as near and far planes.</span></span> <span data-ttu-id="08f11-194">Esto hace que el ajuste sea más estrecho, pero se desgenera para ajustarse a la escena en el caso de Dueling Frusta.</span><span class="sxs-lookup"><span data-stu-id="08f11-194">This causes a tighter fit, but degenerates to fit to scene in the case of dueling frusta.</span></span> <span data-ttu-id="08f11-195">Los ejemplos de CascadedShadowMaps11 llama a esta técnica en cascada.</span><span class="sxs-lookup"><span data-stu-id="08f11-195">The CascadedShadowMaps11 samples calls this technique fit to cascade.</span></span>

<span data-ttu-id="08f11-196">Estos dos métodos se muestran en la figura 6.</span><span class="sxs-lookup"><span data-stu-id="08f11-196">These two methods are shown in Figure 6.</span></span> <span data-ttu-id="08f11-197">Ajustarse a los residuos en cascada menos resolución.</span><span class="sxs-lookup"><span data-stu-id="08f11-197">Fit to cascade wastes less resolution.</span></span> <span data-ttu-id="08f11-198">El problema de encajar en cascada es que la proyección ortográfica aumenta y disminuye en función de la orientación del frustum de vista.</span><span class="sxs-lookup"><span data-stu-id="08f11-198">The problem with fit to cascade is that the orthographic projection grows and shrinks based on the orientation of the view frustum.</span></span> <span data-ttu-id="08f11-199">La técnica ajustar a la escena rellena la proyección ortográfica por el tamaño máximo del frustum de la vista quitando los artefactos que aparecen cuando se mueve la cámara de vista.</span><span class="sxs-lookup"><span data-stu-id="08f11-199">The fit to scene technique pads the orthographic projection by the max size of the view frustum removing the artifacts that appear when the view-camera moves.</span></span> <span data-ttu-id="08f11-200">Las [técnicas comunes para mejorar las asignaciones de profundidad de sombra](/windows/desktop/DxTechArts/common-techniques-to-improve-shadow-depth-maps) se redirigen a los artefactos que aparecen cuando la luz se mueve en la sección "mover la luz en incrementos de tamaño de textura".</span><span class="sxs-lookup"><span data-stu-id="08f11-200">[Common Techniques to Improve Shadow Depth Maps](/windows/desktop/DxTechArts/common-techniques-to-improve-shadow-depth-maps) addresses the artifacts that appear when the light moves in the section "Moving the light in texel sized increments."</span></span>

<span data-ttu-id="08f11-201">**Figura 6. Ajustar a la escena y ajustarse a la cascada**</span><span class="sxs-lookup"><span data-stu-id="08f11-201">**Figure 6. Fit to scene vs. fit to cascade**</span></span>

![ajustar a la escena en lugar de ajustarse a la cascada](images/fit-to-scene-vs-fit-to-cascade.png)

## <a name="render-the-shadow-map"></a><span data-ttu-id="08f11-203">Representar la instantánea</span><span class="sxs-lookup"><span data-stu-id="08f11-203">Render the Shadow Map</span></span>

<span data-ttu-id="08f11-204">El ejemplo CascadedShadowMaps11 representa las asignaciones de instantáneas en un búfer de gran tamaño.</span><span class="sxs-lookup"><span data-stu-id="08f11-204">The CascadedShadowMaps11 sample renders the shadow maps into one large buffer.</span></span> <span data-ttu-id="08f11-205">Esto se debe a que PCF en las matrices de textura es una característica de Direct3D 10,1.</span><span class="sxs-lookup"><span data-stu-id="08f11-205">This is because PCF on texture arrays is a Direct3D 10.1 feature.</span></span> <span data-ttu-id="08f11-206">Para cada cascada, se crea una ventanilla que cubre la sección del búfer de profundidad correspondiente a esa cascada.</span><span class="sxs-lookup"><span data-stu-id="08f11-206">For every cascade, a viewport is created that covers the section of the depth buffer corresponding to that cascade.</span></span> <span data-ttu-id="08f11-207">Un sombreador de píxeles nulo se enlaza porque solo se necesita la profundidad.</span><span class="sxs-lookup"><span data-stu-id="08f11-207">A null pixel shader is bound because only the depth is needed.</span></span> <span data-ttu-id="08f11-208">Por último, se establecen la ventanilla y la matriz de instantáneas correctas para cada cascada, ya que las asignaciones de profundidad se representan de una en una en el búfer de la sombra principal.</span><span class="sxs-lookup"><span data-stu-id="08f11-208">Finally, the correct viewport and shadow matrix are set for each cascade as the depth maps are rendered one at a time into the main shadow buffer.</span></span>

## <a name="render-the-scene"></a><span data-ttu-id="08f11-209">Representación de la escena</span><span class="sxs-lookup"><span data-stu-id="08f11-209">Render the Scene</span></span>

<span data-ttu-id="08f11-210">El búfer que contiene las sombras se enlaza ahora al sombreador de píxeles.</span><span class="sxs-lookup"><span data-stu-id="08f11-210">The buffer containing the shadows is now bound to the pixel shader.</span></span> <span data-ttu-id="08f11-211">Hay dos métodos para seleccionar la implementación en cascada en el ejemplo CascadedShadowMaps11.</span><span class="sxs-lookup"><span data-stu-id="08f11-211">There are two methods for selecting the cascade implemented in the CascadedShadowMaps11 sample.</span></span> <span data-ttu-id="08f11-212">Estos dos métodos se explican con el código del sombreador.</span><span class="sxs-lookup"><span data-stu-id="08f11-212">These two methods are explained with shader code.</span></span>

### <a name="interval-based-cascade-selection"></a><span data-ttu-id="08f11-213">Selección en cascada Interval-Based</span><span class="sxs-lookup"><span data-stu-id="08f11-213">Interval-Based Cascade Selection</span></span>

<span data-ttu-id="08f11-214">**Figura 7. Selección en cascada basada en intervalos**</span><span class="sxs-lookup"><span data-stu-id="08f11-214">**Figure 7. Interval-based cascade selection**</span></span>

![selección en cascada basada en intervalos](images/interval-based-cascade-selection.jpg)

<span data-ttu-id="08f11-216">En la selección basada en intervalos (Figura 7), el sombreador de vértices calcula la posición en el espacio universal del vértice.</span><span class="sxs-lookup"><span data-stu-id="08f11-216">In interval-based selection (Figure 7), the vertex shader computes the position in world-space of the vertex.</span></span>


```C++
Output.vDepth = mul( Input.vPosition, m_mWorldView ).z;
```



<span data-ttu-id="08f11-217">El sombreador de píxeles recibe la profundidad interpolada.</span><span class="sxs-lookup"><span data-stu-id="08f11-217">The pixel shader receives the interpolated depth.</span></span>


```C++
fCurrentPixelDepth = Input.vDepth;
```



<span data-ttu-id="08f11-218">La selección en cascada basada en intervalos usa una comparación de vectores y un producto de punto para determinar el cacade correcto.</span><span class="sxs-lookup"><span data-stu-id="08f11-218">Interval-based cascade selection uses a vector comparison and a dot product to determine the correct cacade.</span></span> <span data-ttu-id="08f11-219">La \_ marca de recuento en cascada \_ especifica el número de cascadas.</span><span class="sxs-lookup"><span data-stu-id="08f11-219">The CASCADE\_COUNT\_FLAG specifies the number of cascades.</span></span> <span data-ttu-id="08f11-220">Los datos de m \_ fCascadeFrustumsEyeSpaceDepths \_ restringen las particiones de frustum de vista.</span><span class="sxs-lookup"><span data-stu-id="08f11-220">The m\_fCascadeFrustumsEyeSpaceDepths\_data constrains the view frustum partitions.</span></span> <span data-ttu-id="08f11-221">Después de la comparación, fComparison contiene un valor de 1, donde el píxel actual es mayor que la barrera y un valor de 0 cuando la cascada actual es menor.</span><span class="sxs-lookup"><span data-stu-id="08f11-221">After the comparison, the fComparison contains a value of 1 where the current pixel is larger than the barrier, and a value of 0 when the current cascade is smaller.</span></span> <span data-ttu-id="08f11-222">Un producto de punto suma estos valores en un índice de matriz.</span><span class="sxs-lookup"><span data-stu-id="08f11-222">A dot product sums these values into an array index.</span></span>


```C++
        float4 vCurrentPixelDepth = Input.vDepth;
        float4 fComparison = ( vCurrentPixelDepth > m_fCascadeFrustumsEyeSpaceDepths_data[0]);
        float fIndex = dot(
        float4( CASCADE_COUNT_FLAG > 0,
        CASCADE_COUNT_FLAG > 1,
        CASCADE_COUNT_FLAG > 2,
        CASCADE_COUNT_FLAG > 3)
        , fComparison );

        fIndex = min( fIndex, CASCADE_COUNT_FLAG );
        iCurrentCascadeIndex = (int)fIndex;
```



<span data-ttu-id="08f11-223">Una vez seleccionada la opción Cascade, la coordenada de textura debe transformarse en cascada correcta.</span><span class="sxs-lookup"><span data-stu-id="08f11-223">Once the cascade is selected, the texture coordinate must be transformed to the correct cascade.</span></span>


```C++
vShadowTexCoord = mul( InterpolatedPosition, m_mShadow[iCascadeIndex] );
```



<span data-ttu-id="08f11-224">Esta coordenada de textura se usa para muestrear la textura con la coordenada X y la coordenada Y.</span><span class="sxs-lookup"><span data-stu-id="08f11-224">This texture coordinate is then used to sample the texture with the X-coordinate and the Y-coordinate.</span></span> <span data-ttu-id="08f11-225">La coordenada Z se usa para realizar la comparación de profundidad final.</span><span class="sxs-lookup"><span data-stu-id="08f11-225">The Z-coordinate is used to do the final depth comparison.</span></span>

### <a name="map-based-cascade-selection"></a><span data-ttu-id="08f11-226">Selección en cascada Map-Based</span><span class="sxs-lookup"><span data-stu-id="08f11-226">Map-Based Cascade Selection</span></span>

<span data-ttu-id="08f11-227">La selección basada en mapas (Figura 8) realiza pruebas en los cuatro lados de las cascadas para buscar el mapa más estrecho que cubre el píxel específico.</span><span class="sxs-lookup"><span data-stu-id="08f11-227">Map-based selection (Figure 8) tests against the four sides of the cascades to find the tightest map that covers the specific pixel.</span></span> <span data-ttu-id="08f11-228">En lugar de calcular la posición en el espacio universal, el sombreador de vértices calcula la posición del espacio de la vista para cada cascada.</span><span class="sxs-lookup"><span data-stu-id="08f11-228">Instead of calculating the position in world space, the vertex shader calculates the view-space position for every cascade.</span></span> <span data-ttu-id="08f11-229">El sombreador de píxeles itera en las cascadas para escalar y desplazar las coordenadas de textura de modo que indexen la cascada actual.</span><span class="sxs-lookup"><span data-stu-id="08f11-229">The pixel shader iterates over the cascades in order to scale and shift the texture coordinates so that they index the current cascade.</span></span> <span data-ttu-id="08f11-230">A continuación, se prueba la coordenada de textura con los límites de textura.</span><span class="sxs-lookup"><span data-stu-id="08f11-230">The texture coordinate is then tested against the texture bounds.</span></span> <span data-ttu-id="08f11-231">Cuando los valores X e y de la coordenada de textura se encuentran dentro de una cascada, se usan para muestrear la textura.</span><span class="sxs-lookup"><span data-stu-id="08f11-231">When the X and Y values of the texture coordinate fall inside a cascade, they are used to sample the texture.</span></span> <span data-ttu-id="08f11-232">La coordenada Z se usa para realizar la comparación de profundidad final.</span><span class="sxs-lookup"><span data-stu-id="08f11-232">The Z-coordinate is used to do the final depth comparison.</span></span>

<span data-ttu-id="08f11-233">**Ilustración 8. Selección en cascada basada en mapas**</span><span class="sxs-lookup"><span data-stu-id="08f11-233">**Figure 8. Map-based cascade selection**</span></span>

![selección en cascada basada en mapas](images/map-based-cascade-selection.jpg)

### <a name="interval-based-selection-vs-map-based-selection"></a><span data-ttu-id="08f11-235">Interval-Based selección frente a Map-Based selección</span><span class="sxs-lookup"><span data-stu-id="08f11-235">Interval-Based Selection vs. Map-Based Selection</span></span>

<span data-ttu-id="08f11-236">La selección basada en intervalos es ligeramente más rápida que la selección basada en asignación, ya que la selección en cascada se puede realizar directamente.</span><span class="sxs-lookup"><span data-stu-id="08f11-236">Interval-based selection is slightly faster than map-based selection because the cascade selection can be done directly.</span></span> <span data-ttu-id="08f11-237">La selección basada en mapas debe intersectar la coordenada de textura con los límites en cascada.</span><span class="sxs-lookup"><span data-stu-id="08f11-237">Map-based selection must intersect the texture coordinate with the cascade bounds.</span></span>

<span data-ttu-id="08f11-238">La selección basada en mapas usa la cascada de forma más eficaz cuando las asignaciones de sombras no se alinean perfectamente (vea la figura 8).</span><span class="sxs-lookup"><span data-stu-id="08f11-238">Map-based selection uses the cascade more efficiently when shadow maps do not align perfectly (see Figure 8).</span></span>

## <a name="blend-between-cascades"></a><span data-ttu-id="08f11-239">Blend entre cascadas</span><span class="sxs-lookup"><span data-stu-id="08f11-239">Blend between Cascades</span></span>

<span data-ttu-id="08f11-240">VSMs (que se describe más adelante en este artículo) y técnicas de filtrado como PCF se pueden usar con CSMs de baja resolución para producir sombras flexibles.</span><span class="sxs-lookup"><span data-stu-id="08f11-240">VSMs (discussed later in this article) and filtering techniques such as PCF can be used with low-resolution CSMs to produce soft shadows.</span></span> <span data-ttu-id="08f11-241">Desafortunadamente, esto da como resultado una costura visible (Figura 9) entre las capas en cascada porque no coincide con la resolución.</span><span class="sxs-lookup"><span data-stu-id="08f11-241">Unfortunately, this results in a visible seam (Figure 9) between cascade layers because the resolution does not match.</span></span> <span data-ttu-id="08f11-242">La solución consiste en crear una banda entre los mapas de instantáneas donde se realiza la prueba de sombra para ambos en cascada.</span><span class="sxs-lookup"><span data-stu-id="08f11-242">The solution is to create a band between shadow maps where the shadow test is performed for both cascades.</span></span> <span data-ttu-id="08f11-243">A continuación, el sombreador se interpola linealmente entre los dos valores en función de la ubicación del píxel en la banda de mezcla.</span><span class="sxs-lookup"><span data-stu-id="08f11-243">The shader then linearly interpolates between the two values based on the pixel's location in the blend band.</span></span> <span data-ttu-id="08f11-244">Los ejemplos CascadedShadowMaps11 y VarianceShadows11 proporcionan un control deslizante de la interfaz gráfica de usuario que se puede usar para aumentar y disminuir esta banda de desenfoque.</span><span class="sxs-lookup"><span data-stu-id="08f11-244">The samples CascadedShadowMaps11 and VarianceShadows11 provide a GUI slider that can be used to increase and decrease this blur band.</span></span> <span data-ttu-id="08f11-245">El sombreador realiza una bifurcación dinámica para que la mayoría de los píxeles solo se lean de la cascada actual.</span><span class="sxs-lookup"><span data-stu-id="08f11-245">The shader performs a dynamic branch so that the vast majority of pixels only read from the current cascade.</span></span>

<span data-ttu-id="08f11-246">**Ilustración 9. Costuras en cascada**</span><span class="sxs-lookup"><span data-stu-id="08f11-246">**Figure 9. Cascade seams**</span></span>

![costuras en cascada](images/cascade-seams.jpg)

<span data-ttu-id="08f11-248">Salido Se pueden ver las costuras visibles donde se superponen las cascadas.</span><span class="sxs-lookup"><span data-stu-id="08f11-248">(Left) A visible seam can be seen where cascades overlap.</span></span> <span data-ttu-id="08f11-249">Correcta Cuando se mezclan las cascadas entre, no se produce ninguna costura.</span><span class="sxs-lookup"><span data-stu-id="08f11-249">(Right) When the cascades are blended between, no seam occurs.</span></span>

## <a name="filtering-shadow-maps"></a><span data-ttu-id="08f11-250">Filtrar mapas de instantáneas</span><span class="sxs-lookup"><span data-stu-id="08f11-250">Filtering Shadow Maps</span></span>

### <a name="pcf"></a><span data-ttu-id="08f11-251">PCF</span><span class="sxs-lookup"><span data-stu-id="08f11-251">PCF</span></span>

<span data-ttu-id="08f11-252">El filtrado de mapas de sombras normales no produce sombras desenfocadas y suavizadas.</span><span class="sxs-lookup"><span data-stu-id="08f11-252">Filtering ordinary shadow maps does not produce soft, blurred shadows.</span></span> <span data-ttu-id="08f11-253">El hardware de filtrado desenfoca los valores de profundidad y, a continuación, compara los valores desenfocados con el espacio de textura.</span><span class="sxs-lookup"><span data-stu-id="08f11-253">The filtering hardware blurs the depth values, and then compares those blurred values to the light space texel.</span></span> <span data-ttu-id="08f11-254">El margen duro resultante de la prueba de superación o error sigue existiendo.</span><span class="sxs-lookup"><span data-stu-id="08f11-254">The hard edge resulting from the pass/fail test still exists.</span></span> <span data-ttu-id="08f11-255">Desenfocar mapas de sombra solo sirve para trasladar erróneamente el borde duro.</span><span class="sxs-lookup"><span data-stu-id="08f11-255">Blurring shadow maps only serves to erroneously move the hard edge.</span></span> <span data-ttu-id="08f11-256">PCF permite filtrar en mapas de instantáneas.</span><span class="sxs-lookup"><span data-stu-id="08f11-256">PCF enables filtering on shadow maps.</span></span> <span data-ttu-id="08f11-257">La idea general de PCF es calcular un porcentaje del píxel en la sombra en función del número de submuestras que superan la prueba de profundidad sobre el número total de submuestras.</span><span class="sxs-lookup"><span data-stu-id="08f11-257">The general idea of PCF is to calculate a percentage of the pixel in shadow based on the number of subsamples that pass the depth test over the total number of subsamples.</span></span>

<span data-ttu-id="08f11-258">El hardware de Direct3D 10 y Direct3D 11 puede realizar PCF.</span><span class="sxs-lookup"><span data-stu-id="08f11-258">Direct3D 10 and Direct3D 11 hardware can perform PCF.</span></span> <span data-ttu-id="08f11-259">La entrada a un muestreador PCF consta de la coordenada de textura y un valor de profundidad de comparación.</span><span class="sxs-lookup"><span data-stu-id="08f11-259">The input to a PCF sampler consists of the texture-coordinate and a comparison depth value.</span></span> <span data-ttu-id="08f11-260">Para simplificar, PCF se explica con un filtro de cuatro punteos.</span><span class="sxs-lookup"><span data-stu-id="08f11-260">For simplicity, PCF is explained with a four-tap filter.</span></span> <span data-ttu-id="08f11-261">La muestra de textura lee la textura cuatro veces, de forma similar a un filtro estándar.</span><span class="sxs-lookup"><span data-stu-id="08f11-261">The texture sampler reads the texture four times, similar to a standard filter.</span></span> <span data-ttu-id="08f11-262">Sin embargo, el resultado devuelto es un porcentaje de los píxeles que superaron la prueba de profundidad.</span><span class="sxs-lookup"><span data-stu-id="08f11-262">However, the returned result is a percentage of the pixels that passed the depth test.</span></span> <span data-ttu-id="08f11-263">En la figura 10 se muestra cómo un píxel que pasa una de las cuatro pruebas de profundidad es el 25 por ciento de la sombra.</span><span class="sxs-lookup"><span data-stu-id="08f11-263">Figure 10 shows how a pixel that passes one of the four depth tests is 25 percent in shadow.</span></span> <span data-ttu-id="08f11-264">El valor real devuelto es una interpolación lineal basada en las coordenadas subtexel de las lecturas de textura para producir un degradado suave.</span><span class="sxs-lookup"><span data-stu-id="08f11-264">The actual value returned is a linear interpolation based on the subtexel coordinates of the texture reads to produce a smooth gradient.</span></span> <span data-ttu-id="08f11-265">Sin esta interpolación lineal, el PCF de cuatro punteos solo podría devolver cinco valores: {0,0, 0,25, 0,5, 0,75, 1,0}.</span><span class="sxs-lookup"><span data-stu-id="08f11-265">Without this linear interpolation, the four-tap PCF would only be able to return five values: { 0.0, 0.25, 0.5, 0.75, 1.0 }.</span></span>

<span data-ttu-id="08f11-266">**Figura 10. Imagen filtrada PCF, con el 25 por ciento del píxel seleccionado incluido**</span><span class="sxs-lookup"><span data-stu-id="08f11-266">**Figure 10. PCF filtered image, with 25 percent of the selected pixel covered**</span></span>

![imagen filtrada PCF, con el 25 por ciento del píxel seleccionado incluido](images/pcf-filtered-image.png)

<span data-ttu-id="08f11-268">También es posible hacer PCF sin compatibilidad de hardware o extender PCF a kernels más grandes.</span><span class="sxs-lookup"><span data-stu-id="08f11-268">It is also possible to do PCF without hardware support or extend PCF to larger kernels.</span></span> <span data-ttu-id="08f11-269">Algunas técnicas incluso muestra con un kernel ponderado.</span><span class="sxs-lookup"><span data-stu-id="08f11-269">Some techniques even sample with a weighted kernel.</span></span> <span data-ttu-id="08f11-270">Para ello, cree un kernel (por ejemplo, un gaussiano) para una cuadrícula N × N.</span><span class="sxs-lookup"><span data-stu-id="08f11-270">To do this, create a kernel (such as a Gaussian) for an N × N grid.</span></span> <span data-ttu-id="08f11-271">Los pesos deben agregar hasta 1.</span><span class="sxs-lookup"><span data-stu-id="08f11-271">The weights must add up to 1.</span></span> <span data-ttu-id="08f11-272">A continuación, la textura se muestrea en horas N2.</span><span class="sxs-lookup"><span data-stu-id="08f11-272">The texture is then sampled N2 times.</span></span> <span data-ttu-id="08f11-273">Cada ejemplo se escala según los pesos correspondientes en el kernel.</span><span class="sxs-lookup"><span data-stu-id="08f11-273">Each sample is scaled by the corresponding weights in the kernel.</span></span> <span data-ttu-id="08f11-274">En el ejemplo CascadedShadowMaps11 se usa este enfoque.</span><span class="sxs-lookup"><span data-stu-id="08f11-274">The CascadedShadowMaps11 sample uses this approach.</span></span>

### <a name="depth-bias"></a><span data-ttu-id="08f11-275">Tendencia de profundidad</span><span class="sxs-lookup"><span data-stu-id="08f11-275">Depth Bias</span></span>

<span data-ttu-id="08f11-276">La diferencia de profundidad es incluso más importante cuando se usan kernels PCF grandes.</span><span class="sxs-lookup"><span data-stu-id="08f11-276">Depth bias becomes even more important when large PCF kernels are used.</span></span> <span data-ttu-id="08f11-277">Solo es válido para comparar la profundidad de espacio claro de un píxel con el píxel al que se asigna en el mapa de profundidad.</span><span class="sxs-lookup"><span data-stu-id="08f11-277">It is only valid to compare a pixel's light-space depth against the pixel it maps to in the depth map.</span></span> <span data-ttu-id="08f11-278">Los vecinos del textura de mapa de profundidad hacen referencia a una posición diferente.</span><span class="sxs-lookup"><span data-stu-id="08f11-278">The depth map texel's neighbors refer to a different position.</span></span> <span data-ttu-id="08f11-279">Es probable que esta profundidad sea similar, pero puede ser muy diferente en función de la escena.</span><span class="sxs-lookup"><span data-stu-id="08f11-279">This depth is likely to be similar, but can be very different depending on the scene.</span></span> <span data-ttu-id="08f11-280">En la figura 11 se resaltan los artefactos que se producen.</span><span class="sxs-lookup"><span data-stu-id="08f11-280">Figure 11 highlights the artifacts that occur.</span></span> <span data-ttu-id="08f11-281">Una sola profundidad se compara con tres texturas vecinos en el mapa de instantáneas.</span><span class="sxs-lookup"><span data-stu-id="08f11-281">A single depth is compared to three neighboring texels in the shadow map.</span></span> <span data-ttu-id="08f11-282">Una de las pruebas de profundidad produce un error errónea porque su profundidad no se correlaciona con la profundidad calculada de espacio claro de la geometría actual.</span><span class="sxs-lookup"><span data-stu-id="08f11-282">One of the depth tests erroneously fails because its depth does not correlate to the computed light-space depth of the current geometry.</span></span> <span data-ttu-id="08f11-283">La solución recomendada para este problema es usar un desplazamiento mayor.</span><span class="sxs-lookup"><span data-stu-id="08f11-283">The recommended solution to this problem is to use a larger offset.</span></span> <span data-ttu-id="08f11-284">Pero es demasiado grande de un desplazamiento. sin embargo, se puede producir la panorámica de Peter.</span><span class="sxs-lookup"><span data-stu-id="08f11-284">Too large of an offset, however, can result in Peter Panning.</span></span> <span data-ttu-id="08f11-285">Calcular un plano cerca y un plano lejano ayuda a reducir los efectos del uso de un desplazamiento.</span><span class="sxs-lookup"><span data-stu-id="08f11-285">Calculating a tight near plane and far plane helps reduce the effects of using an offset.</span></span>

<span data-ttu-id="08f11-286">**Figura 11. Sombra automática errónea**</span><span class="sxs-lookup"><span data-stu-id="08f11-286">**Figure 11. Erroneous self-shadowing**</span></span>

![sombra automática errónea](images/erroneous-self-shadowing.png)

<span data-ttu-id="08f11-288">Los resultados de la ocultación automática erróneos de la comparación de los píxeles de la profundidad del espacio claro con el textura en el mapa de instantáneas que no se correlacionan.</span><span class="sxs-lookup"><span data-stu-id="08f11-288">The erroneous self-shadowing results from comparing pixels in the light-space depth to the texels in the shadow map that do not correlate.</span></span> <span data-ttu-id="08f11-289">La profundidad en el espacio claro se correlaciona con Shadow textura 2 en el mapa de profundidad.</span><span class="sxs-lookup"><span data-stu-id="08f11-289">The depth in light-space correlates to shadow texel 2 in the depth map.</span></span> <span data-ttu-id="08f11-290">Textura 1 es mayor que la profundidad de espacio claro, mientras que 2 es igual y 3 es menor.</span><span class="sxs-lookup"><span data-stu-id="08f11-290">Texel 1 is greater than the light-space depth while 2 is equal and 3 is less.</span></span> <span data-ttu-id="08f11-291">Textura 2 y 3 superan la prueba de profundidad, mientras que textura 1 produce un error.</span><span class="sxs-lookup"><span data-stu-id="08f11-291">Texels 2 and 3 pass the depth test, while Texel 1 fails.</span></span>

### <a name="calculating-a-per-texel-depth-bias-with-ddx-and-ddy-for-large-pcfs"></a><span data-ttu-id="08f11-292">Calcular una diferencia de profundidad de Per-Texel con DDX y DDY para PCFs grandes</span><span class="sxs-lookup"><span data-stu-id="08f11-292">Calculating a Per-Texel Depth Bias with DDX and DDY for Large PCFs</span></span>

<span data-ttu-id="08f11-293">Calcular una desviación de profundidad por textura con **DDX** y **DDY** para PCFs grande es una técnica que calcula la diferencia de profundidad correcta, suponiendo que la superficie es plana, para el textura de mapa de sombra adyacente.</span><span class="sxs-lookup"><span data-stu-id="08f11-293">Calculating a per texel depth bias with **ddx** and **ddy** for large PCFs is a technique that calculates the correct depth bias—assuming the surface is planar—for the adjacent shadow map texel.</span></span>

<span data-ttu-id="08f11-294">Esta técnica ajusta la profundidad de comparación a un plano mediante la información derivada.</span><span class="sxs-lookup"><span data-stu-id="08f11-294">This technique fits the comparison depth to a plane using the derivative information.</span></span> <span data-ttu-id="08f11-295">Dado que esta técnica es complejamente compleja, solo debe usarse cuando una GPU tiene ciclos de proceso para la reserva.</span><span class="sxs-lookup"><span data-stu-id="08f11-295">Because this technique is computationally complex, it should be used only when a GPU has compute cycles to spare.</span></span> <span data-ttu-id="08f11-296">Cuando se usan kernels muy grandes, esta puede ser la única técnica que se usa para quitar los artefactos de sombra automática sin causar la panorámica de Peter.</span><span class="sxs-lookup"><span data-stu-id="08f11-296">When very large kernels are used, this may be the only technique that works to remove self-shadowing artifacts without causing Peter Panning.</span></span>

<span data-ttu-id="08f11-297">En la ilustración 12 se destaca el problema.</span><span class="sxs-lookup"><span data-stu-id="08f11-297">Figure 12 highlights the problem.</span></span> <span data-ttu-id="08f11-298">La profundidad en el espacio claro se conoce para el textura que se está comparando.</span><span class="sxs-lookup"><span data-stu-id="08f11-298">The depth in light-space is known for the one texel that is being compared.</span></span> <span data-ttu-id="08f11-299">Se desconocen las profundidades de espacio claro que se corresponden con el textura vecino en el mapa de profundidad.</span><span class="sxs-lookup"><span data-stu-id="08f11-299">The light-space depths that correspond to the neighboring texels in the depth map are unknown.</span></span>

<span data-ttu-id="08f11-300">**Figura 12. Mapa de profundidad y escena**</span><span class="sxs-lookup"><span data-stu-id="08f11-300">**Figure 12. Scene and depth map**</span></span>

![mapa de profundidad y escena](images/scene-and-depth-map.png)

<span data-ttu-id="08f11-302">La escena representada se muestra a la izquierda y el mapa de profundidad con un bloque textura de ejemplo se muestra a la derecha.</span><span class="sxs-lookup"><span data-stu-id="08f11-302">The rendered scene is shown at left, and the depth map with a sample texel block is shown at right.</span></span> <span data-ttu-id="08f11-303">El textura de espacio de ojo se asigna al píxel con la etiqueta D en el centro del bloque.</span><span class="sxs-lookup"><span data-stu-id="08f11-303">The eye-space texel maps to the pixel labeled D in the center of the block.</span></span> <span data-ttu-id="08f11-304">Esta comparación es precisa.</span><span class="sxs-lookup"><span data-stu-id="08f11-304">This comparison is accurate.</span></span> <span data-ttu-id="08f11-305">La profundidad correcta en el espacio ocular en correlación con los píxeles en que se desconoce el vecino D.</span><span class="sxs-lookup"><span data-stu-id="08f11-305">The correct depth in eye space correlating to the pixels that neighbor D is unknown.</span></span> <span data-ttu-id="08f11-306">Solo es posible asignar el textura adyacente al espacio ocular si se supone que el píxel pertenece al mismo triángulo que D.</span><span class="sxs-lookup"><span data-stu-id="08f11-306">Mapping the neighboring texels back to eye space is possible only if we assume the pixel pertains to the same triangle as D.</span></span>

<span data-ttu-id="08f11-307">La profundidad se conoce para el textura que se correlaciona con la posición de espacio claro.</span><span class="sxs-lookup"><span data-stu-id="08f11-307">The depth is known for the texel that correlates with the light-space position.</span></span> <span data-ttu-id="08f11-308">La profundidad es desconocida para los texturas vecinos en el mapa de profundidad.</span><span class="sxs-lookup"><span data-stu-id="08f11-308">The depth is unknown for the neighboring texels in the depth map.</span></span>

<span data-ttu-id="08f11-309">En un nivel alto, esta técnica usa las operaciones HLSL **DDX** y **DDY** para buscar el derivado de la posición de espacio claro.</span><span class="sxs-lookup"><span data-stu-id="08f11-309">At a high level, this technique uses the **ddx** and **ddy** HLSL operations to find the derivative of the light-space position.</span></span> <span data-ttu-id="08f11-310">Esto no es trivial porque las operaciones derivadas devuelven el degradado de la profundidad del espacio claro con respecto al espacio de la pantalla.</span><span class="sxs-lookup"><span data-stu-id="08f11-310">This is nontrivial because the derivative operations return the gradient of the light-space depth with respect to screen space.</span></span> <span data-ttu-id="08f11-311">Para convertir esto en un degradado de la profundidad del espacio claro con respecto al espacio de luz, se debe calcular una matriz de conversión.</span><span class="sxs-lookup"><span data-stu-id="08f11-311">To convert this to a gradient of the light-space depth with respect to light space, a conversion matrix must be calculated.</span></span>

### <a name="explanation-with-shader-code"></a><span data-ttu-id="08f11-312">Explicación con el código del sombreador</span><span class="sxs-lookup"><span data-stu-id="08f11-312">Explanation with Shader Code</span></span>

<span data-ttu-id="08f11-313">Los detalles del resto del algoritmo se proporcionan como una explicación del código del sombreador que realiza esta operación.</span><span class="sxs-lookup"><span data-stu-id="08f11-313">The details of the rest of the algorithm are given as an explanation of the shader code that performs this operation.</span></span> <span data-ttu-id="08f11-314">Este código se puede encontrar en el ejemplo CascadedShadowMaps11.</span><span class="sxs-lookup"><span data-stu-id="08f11-314">This code can be found in the CascadedShadowMaps11 sample.</span></span> <span data-ttu-id="08f11-315">En la figura 13 se muestra cómo se asignan las coordenadas de textura de espacio claro a la asignación de profundidad y cómo se pueden usar los derivados en X e y para crear una matriz de transformación.</span><span class="sxs-lookup"><span data-stu-id="08f11-315">Figure 13 shows how the light-space texture coordinates map to the depth map and how the derivatives in X and Y can be used to create a transformation matrix.</span></span>

<span data-ttu-id="08f11-316">**Figura 13. Espacio de pantalla para la matriz de espacio claro**</span><span class="sxs-lookup"><span data-stu-id="08f11-316">**Figure 13. Screen-space to light-space matrix**</span></span>

![espacio de pantalla para la matriz de espacio claro](images/screen-space-to-light-space-matrix.png)

<span data-ttu-id="08f11-318">Los derivados de la posición de espacio claro en X e y se usan para crear esta matriz.</span><span class="sxs-lookup"><span data-stu-id="08f11-318">The derivatives of the light-space position in X and Y are used to create this matrix.</span></span>

<span data-ttu-id="08f11-319">El primer paso es calcular el derivado de la posición del espacio de la vista clara.</span><span class="sxs-lookup"><span data-stu-id="08f11-319">The first step is to calculate the derivative of the light-view-space position.</span></span>


```C++
          float3 vShadowTexDDX = ddx (vShadowMapTextureCoordViewSpace);
          float3 vShadowTexDDY = ddy (vShadowMapTextureCoordViewSpace);
```



<span data-ttu-id="08f11-320">Las GPU de clase de Direct3D 11 calculan estos derivados ejecutando 2 × 2 cuádruple de píxeles en paralelo y restando las coordenadas de textura del vecino en X para **DDX** y del vecino en y para **DDY**.</span><span class="sxs-lookup"><span data-stu-id="08f11-320">Direct3D 11 class GPUs calculate these derivatives by running 2 × 2 quad of pixels in parallel and subtracting the texture coordinates from the neighbor in X for **ddx** and from the neighbor in Y for **ddy**.</span></span> <span data-ttu-id="08f11-321">Estos dos derivados forman las filas de una matriz de 2 × 2.</span><span class="sxs-lookup"><span data-stu-id="08f11-321">These two derivatives make up the rows of a 2 × 2 matrix.</span></span> <span data-ttu-id="08f11-322">En su forma actual, esta matriz se puede usar para convertir los píxeles adyacentes del espacio de pantalla en las pendientes de espacio ligero.</span><span class="sxs-lookup"><span data-stu-id="08f11-322">In its current form, this matrix could be used to convert screen-space neighboring pixels to light-space slopes.</span></span> <span data-ttu-id="08f11-323">Sin embargo, se necesita el inverso de esta matriz.</span><span class="sxs-lookup"><span data-stu-id="08f11-323">However, the inverse of this matrix is needed.</span></span> <span data-ttu-id="08f11-324">Matriz que transforma los píxeles adyacentes de espacio claro en las pendientes de espacio de pantalla.</span><span class="sxs-lookup"><span data-stu-id="08f11-324">A matrix that transforms light-space neighboring pixels to screen-space slopes is needed.</span></span>


```C++
          float2x2 matScreentoShadow = float2x2( vShadowTexDDX.xy, vShadowTexDDY.xy );
          float fInvDeterminant = 1.0f / fDeterminant;

          float2x2 matShadowToScreen = float2x2 (
          matScreentoShadow._22 * fInvDeterminant,
          matScreentoShadow._12 * -fInvDeterminant,
          matScreentoShadow._21 * -fInvDeterminant,
          matScreentoShadow._11 * fInvDeterminant );
```



<span data-ttu-id="08f11-325">**Figura 14. Espacio claro en el espacio de pantalla**</span><span class="sxs-lookup"><span data-stu-id="08f11-325">**Figure 14. Light-space to screen-space**</span></span>

![espacio claro en el espacio de pantalla](images/light-space-to-screen-space.png)

<span data-ttu-id="08f11-327">A continuación, esta matriz se usa para transformar los dos textura por encima y a la derecha de la textura actual.</span><span class="sxs-lookup"><span data-stu-id="08f11-327">This matrix is then used to transform the two texels above and to the right of the current texel.</span></span> <span data-ttu-id="08f11-328">Estos vecinos se representan como un desplazamiento desde el textura actual.</span><span class="sxs-lookup"><span data-stu-id="08f11-328">These neighbors are represented as an offset from the current texel.</span></span>


```C++
          float2 vRightShadowTexelLocation = float2( m_fTexelSize, 0.0f );
          float2 vUpShadowTexelLocation = float2( 0.0f, m_fTexelSize );
          float2 vRightTexelDepthRatio = mul( vRightShadowTexelLocation,
          matShadowToScreen );
          float2 vUpTexelDepthRatio = mul( vUpShadowTexelLocation,
          matShadowToScreen );
```



<span data-ttu-id="08f11-329">Por último, la relación que crea la matriz se multiplica por los derivados de profundidad para calcular los desplazamientos de profundidad para los píxeles circundantes.</span><span class="sxs-lookup"><span data-stu-id="08f11-329">The ratio that the matrix creates is finally multiplied by the depth derivatives to calculate the depth offsets for the neighboring pixels.</span></span>


```C++
            float fUpTexelDepthDelta =
            vUpTexelDepthRatio.x * vShadowTexDDX.z
            + vUpTexelDepthRatio.y * vShadowTexDDY.z;
            float fRightTexelDepthDelta =
            vRightTexelDepthRatio.x * vShadowTexDDX.z
            + vRightTexelDepthRatio.y * vShadowTexDDY.z;
```



<span data-ttu-id="08f11-330">Estos pesos se pueden usar ahora en un bucle PCF para agregar un desplazamiento a la posición.</span><span class="sxs-lookup"><span data-stu-id="08f11-330">These weights can now be used in a PCF loop to add an offset to the position.</span></span>


```C++
    for( int x = m_iPCFBlurForLoopStart; x < m_iPCFBlurForLoopEnd; ++x ) 
    {
        for( int y = m_iPCFBlurForLoopStart; y < m_iPCFBlurForLoopEnd; ++y )
            {
            if ( USE_DERIVATIVES_FOR_DEPTH_OFFSET_FLAG )
            {
            depthcompare += fRightTexelDepthDelta * ( (float) x ) +
            fUpTexelDepthDelta * ( (float) y );
            }
            // Compare the transformed pixel depth to the depth read
            // from the map.
            fPercentLit += g_txShadow.SampleCmpLevelZero( g_samShadow,
            float2(
            vShadowTexCoord.x + ( ( (float) x ) * m_fNativeTexelSizeInX ) ,
            vShadowTexCoord.y + ( ( (float) y ) * m_fTexelSize )
            ),
            depthcompare
            );
            }
     }
```



## <a name="pcf-and-csms"></a><span data-ttu-id="08f11-331">PCF y CSMs</span><span class="sxs-lookup"><span data-stu-id="08f11-331">PCF and CSMs</span></span>

<span data-ttu-id="08f11-332">PCF no funciona en las matrices de texturas en Direct3D 10.</span><span class="sxs-lookup"><span data-stu-id="08f11-332">PCF does not work on texture arrays in Direct3D 10.</span></span> <span data-ttu-id="08f11-333">Para usar PCF, todas las cascadas se almacenan en un Atlas de textura grande.</span><span class="sxs-lookup"><span data-stu-id="08f11-333">To use PCF, all of the cascades are stored in one large texture atlas.</span></span>

### <a name="derivative-based-offset"></a><span data-ttu-id="08f11-334">Derivative-Based desplazamiento</span><span class="sxs-lookup"><span data-stu-id="08f11-334">Derivative-Based Offset</span></span>

<span data-ttu-id="08f11-335">La adición de los desplazamientos basados en derivado para CSMs presenta algunos desafíos.</span><span class="sxs-lookup"><span data-stu-id="08f11-335">Adding the derivative based offsets for CSMs presents some challenges.</span></span> <span data-ttu-id="08f11-336">Esto se debe a un cálculo derivado dentro del control de flujo divergente.</span><span class="sxs-lookup"><span data-stu-id="08f11-336">This is due to a derivative calculation within divergent flow control.</span></span> <span data-ttu-id="08f11-337">El problema se produce debido a una forma fundamental de usar las GPU.</span><span class="sxs-lookup"><span data-stu-id="08f11-337">The problem occurs because of a fundamental way that GPUs operate.</span></span> <span data-ttu-id="08f11-338">Las GPU de Direct3D 11 funcionan en 2 × 2 cuádruples de píxeles.</span><span class="sxs-lookup"><span data-stu-id="08f11-338">Direct3D11 GPUs operate on 2 × 2 quads of pixels.</span></span> <span data-ttu-id="08f11-339">Para realizar una derivada, las GPU generalmente restan la copia del píxel actual de una variable de la copia del píxel adyacente de esa misma variable.</span><span class="sxs-lookup"><span data-stu-id="08f11-339">To perform a derivative, GPUs generally subtract the current pixel's copy of a variable from the neighboring pixel's copy of that same variable.</span></span> <span data-ttu-id="08f11-340">La forma en que esto ocurre varía de una GPU a una GPU.</span><span class="sxs-lookup"><span data-stu-id="08f11-340">How this happens varies from GPU to GPU.</span></span> <span data-ttu-id="08f11-341">Las coordenadas de textura se determinan mediante la selección en cascada basada en el mapa o en el intervalo.</span><span class="sxs-lookup"><span data-stu-id="08f11-341">The texture coordinates are determined by map-based or interval-based cascade selection.</span></span> <span data-ttu-id="08f11-342">Algunos píxeles de un píxel cuádruple eligen una en cascada diferente que el resto de los píxeles.</span><span class="sxs-lookup"><span data-stu-id="08f11-342">Some pixels in a pixel quad choose a different cascade than the rest of the pixels.</span></span> <span data-ttu-id="08f11-343">Esto da como resultado las costuras visibles entre los mapas de instantáneas, ya que los desplazamientos basados en el derivado ahora están completamente incorrectos.</span><span class="sxs-lookup"><span data-stu-id="08f11-343">This results in visible seams between shadow maps because the derivative-based offsets are now completely wrong.</span></span> <span data-ttu-id="08f11-344">La solución consiste en realizar el derivado de las coordenadas de textura del espacio de vista clara.</span><span class="sxs-lookup"><span data-stu-id="08f11-344">The solution is to perform the derivative on light-view space texture coordinates.</span></span> <span data-ttu-id="08f11-345">Estas coordenadas son las mismas para cada cascada.</span><span class="sxs-lookup"><span data-stu-id="08f11-345">These coordinates are the same for every cascade.</span></span>

### <a name="padding-for-pcf-kernels"></a><span data-ttu-id="08f11-346">Relleno de kernels PCF</span><span class="sxs-lookup"><span data-stu-id="08f11-346">Padding for PCF Kernels</span></span>

<span data-ttu-id="08f11-347">El índice de kernels PCF está fuera de una partición en cascada si no se rellena el búfer de la sombra.</span><span class="sxs-lookup"><span data-stu-id="08f11-347">PCF kernels index outside of a cascade partition if the shadow buffer is not padded.</span></span> <span data-ttu-id="08f11-348">La solución consiste en rellenar el borde exterior de la cascada en la mitad del tamaño del kernel PCF.</span><span class="sxs-lookup"><span data-stu-id="08f11-348">The solution is to pad the outer rim of the cascade by one-half the size of the PCF kernel.</span></span> <span data-ttu-id="08f11-349">Esto se debe implementar en el sombreador que selecciona la cascada y en la matriz de proyección que deben representar la cascada lo suficientemente grande como para conservar el borde.</span><span class="sxs-lookup"><span data-stu-id="08f11-349">This must be implemented in the shader that selects the cascade and in the projection matrix that must render the cascade large enough that the border is preserved.</span></span>

## <a name="variance-shadow-maps"></a><span data-ttu-id="08f11-350">Mapas de instantáneas de varianza</span><span class="sxs-lookup"><span data-stu-id="08f11-350">Variance Shadow Maps</span></span>

<span data-ttu-id="08f11-351">VSMs (consulte las [asignaciones sombra](https://portal.acm.org/citation.cfm?doid=1111411.1111440) de la varianza de Donnelly y Lauritzen para obtener más información) habilitación del filtrado de mapas de instantáneas directos.</span><span class="sxs-lookup"><span data-stu-id="08f11-351">VSMs (see [Variance shadow maps](https://portal.acm.org/citation.cfm?doid=1111411.1111440) by Donnelly and Lauritzen for more information) enable direct shadow map filtering.</span></span> <span data-ttu-id="08f11-352">Al usar VSMs, se puede usar toda la eficacia del hardware de filtrado de texturas.</span><span class="sxs-lookup"><span data-stu-id="08f11-352">When using VSMs, all of the power of the texture-filtering hardware can be used.</span></span> <span data-ttu-id="08f11-353">Se puede usar el filtrado trilineal y anisotrópico (Figura 15).</span><span class="sxs-lookup"><span data-stu-id="08f11-353">Trilinear and anisotropic (Figure 15) filtering can be used.</span></span> <span data-ttu-id="08f11-354">Además, VSMs se puede desenfocar directamente a través de circunvolución.</span><span class="sxs-lookup"><span data-stu-id="08f11-354">Additionally, VSMs can be blurred directly through convolution.</span></span> <span data-ttu-id="08f11-355">VSMs tienen algunas desventajas; deben almacenarse dos canales de datos de profundidad (profundidad y profundidad).</span><span class="sxs-lookup"><span data-stu-id="08f11-355">VSMs do have some drawbacks; two channels of depth data must be stored (depth and depth squared).</span></span> <span data-ttu-id="08f11-356">Cuando las sombras se superponen, es común la claridad.</span><span class="sxs-lookup"><span data-stu-id="08f11-356">When shadows overlap, light-bleeding is common.</span></span> <span data-ttu-id="08f11-357">Sin embargo, funcionan bien con resoluciones más bajas y se pueden combinar con CSMs.</span><span class="sxs-lookup"><span data-stu-id="08f11-357">They work well, however, with lower resolutions and can be combined with CSMs.</span></span>

<span data-ttu-id="08f11-358">**Figura 15. Filtrado anisotrópico**</span><span class="sxs-lookup"><span data-stu-id="08f11-358">**Figure 15. Anisotropic filtering**</span></span>

![filtrado anisotrópico](images/anisotropic-filtering.png)

### <a name="algorithm-details"></a><span data-ttu-id="08f11-360">Detalles del algoritmo</span><span class="sxs-lookup"><span data-stu-id="08f11-360">Algorithm Details</span></span>

<span data-ttu-id="08f11-361">VSMs el trabajo mediante la representación de la profundidad y la profundidad al cuadrado de una asignación de sombra de dos canales.</span><span class="sxs-lookup"><span data-stu-id="08f11-361">VSMs work by rendering the depth and the depth squared to a two-channel shadow map.</span></span> <span data-ttu-id="08f11-362">Esta asignación de instantáneas de dos canales se puede Desenfocar y filtrar como una textura normal.</span><span class="sxs-lookup"><span data-stu-id="08f11-362">This two-channel shadow map can then be blurred and filtered just like a normal texture.</span></span> <span data-ttu-id="08f11-363">A continuación, el algoritmo utiliza la desigualdad de Chebychev en el sombreador de píxeles para calcular la fracción del área de píxeles que pasaría la prueba de profundidad.</span><span class="sxs-lookup"><span data-stu-id="08f11-363">The algorithm then uses Chebychev's Inequality in the pixel shader to estimate the fraction of pixel area that would pass the depth test.</span></span>

<span data-ttu-id="08f11-364">El sombreador de píxeles captura los valores de profundidad y de profundidad.</span><span class="sxs-lookup"><span data-stu-id="08f11-364">The pixel shader fetches the depth and depth-squared values.</span></span>


```C++
        float  fAvgZ  = mapDepth.x; // Filtered z
        float  fAvgZ2 = mapDepth.y; // Filtered z-squared
```



<span data-ttu-id="08f11-365">Se realiza la comparación de profundidad.</span><span class="sxs-lookup"><span data-stu-id="08f11-365">The depth comparison is performed.</span></span>


```C++
        if ( fDepth <= fAvgZ )
        {
        fPercentLit = 1;
        }
```



<span data-ttu-id="08f11-366">Si se produce un error en la comparación de profundidad, se calcula el porcentaje del píxel que está iluminado.</span><span class="sxs-lookup"><span data-stu-id="08f11-366">If the depth comparison fails, the percentage of the pixel that is lit is estimated.</span></span> <span data-ttu-id="08f11-367">La varianza se calcula como promedio de cuadrados menos el cuadrado del promedio.</span><span class="sxs-lookup"><span data-stu-id="08f11-367">Variance is calculated as average-of-squares minus square-of-average.</span></span>


```C++
        float variance = ( fAvgZ2 ) − ( fAvgZ * fAvgZ );
        variance = min( 1.0f, max( 0.0f, variance + 0.00001f ) );
```



<span data-ttu-id="08f11-368">El valor fPercentLit se calcula con la desigualdad de Chebychev.</span><span class="sxs-lookup"><span data-stu-id="08f11-368">The fPercentLit value is estimated with Chebychev's Inequality.</span></span>


```C++
        float mean           = fAvgZ;
        float d              = fDepth - mean;
        float fPercentLit    = variance / ( variance + d*d );
```



## <a name="light-bleeding"></a><span data-ttu-id="08f11-369">Sangrado claro</span><span class="sxs-lookup"><span data-stu-id="08f11-369">Light Bleeding</span></span>

<span data-ttu-id="08f11-370">El mayor inconveniente de VSMs es la dessangrado ligera (Figura 16).</span><span class="sxs-lookup"><span data-stu-id="08f11-370">The biggest drawback to VSMs is light bleeding (Figure 16).</span></span> <span data-ttu-id="08f11-371">La purga de luz se produce cuando varios convertidores de sombras se tapaban entre sí a lo largo de los bordes.</span><span class="sxs-lookup"><span data-stu-id="08f11-371">Light bleeding occurs when multiple shadow casters occlude each other along edges.</span></span> <span data-ttu-id="08f11-372">VSMs sombrear los bordes de las sombras en función de las disparidades de profundidad.</span><span class="sxs-lookup"><span data-stu-id="08f11-372">VSMs shade the edges of shadows based on depth disparities.</span></span> <span data-ttu-id="08f11-373">Cuando las sombras se superponen entre sí, existe una disparidad de profundidad en el centro de una región que se debe sombrear.</span><span class="sxs-lookup"><span data-stu-id="08f11-373">When shadows overlap each other, a depth disparity exists in the center of a region that should be shadowed.</span></span> <span data-ttu-id="08f11-374">Se trata de un problema con el uso del algoritmo de VSM.</span><span class="sxs-lookup"><span data-stu-id="08f11-374">This is a problem with using the VSM algorithm.</span></span>

<span data-ttu-id="08f11-375">**Figura 16. Sangrado claro de VSM**</span><span class="sxs-lookup"><span data-stu-id="08f11-375">**Figure 16. VSM light bleeding**</span></span>

![sangrado claro de VSM](images/vsm-light-bleeding.png)

<span data-ttu-id="08f11-377">Una solución parcial al problema es elevar el fPercentLit a una potencia.</span><span class="sxs-lookup"><span data-stu-id="08f11-377">A partial solution to the problem is to raise the fPercentLit to a power.</span></span> <span data-ttu-id="08f11-378">Esto tiene el efecto de atenuar el desenfoque, lo que puede producir artefactos donde la disparidad de profundidad es pequeña.</span><span class="sxs-lookup"><span data-stu-id="08f11-378">This has the effect of dampening the blur, which can cause artifacts where depth disparity is small.</span></span> <span data-ttu-id="08f11-379">A veces existe un valor mágico que soluciona el problema.</span><span class="sxs-lookup"><span data-stu-id="08f11-379">Sometimes there exists a magical value that alleviates the problem.</span></span>


```C++
fPercentLit = pow( p_max, MAGIC_NUMBER );
```



<span data-ttu-id="08f11-380">Una alternativa a aumentar el porcentaje de iluminación a una potencia es evitar las configuraciones en las que las sombras se superponen.</span><span class="sxs-lookup"><span data-stu-id="08f11-380">An alternative to raising the percent lit to a power is to avoid configurations where shadows overlap.</span></span> <span data-ttu-id="08f11-381">Incluso las configuraciones de sombra muy ajustadas tienen varias restricciones en la luz, la cámara y la geometría.</span><span class="sxs-lookup"><span data-stu-id="08f11-381">Even highly tuned shadow configurations have several constraints on light, camera, and geometry.</span></span> <span data-ttu-id="08f11-382">La sangrado de luz también se reduce mediante el uso de texturas de mayor resolución.</span><span class="sxs-lookup"><span data-stu-id="08f11-382">Light bleeding is also lessened by using higher resolution textures.</span></span>

<span data-ttu-id="08f11-383">Los mapas de sombras de la varianza por capas (LVSMs) resuelven el problema a costa de romper el frustum en capas que son perpendiculares a la luz.</span><span class="sxs-lookup"><span data-stu-id="08f11-383">Layered variance shadow maps (LVSMs) solve the problem at the expense of breaking the frustum into layers that are perpendicular to the light.</span></span> <span data-ttu-id="08f11-384">El número de asignaciones necesario sería bastante grande cuando también se usan CSMs.</span><span class="sxs-lookup"><span data-stu-id="08f11-384">The number of maps required would be quite large when CSMs are also being used.</span></span>

<span data-ttu-id="08f11-385">Además, Andrew Lauritzen, coautor of the Paper on VSMs, and Author of a Paper in LVSMs, se ha explicado la combinación de mapas de sombra exponencial (ESMs) con VSMs para contrarrestar la combinación de luz en un [Foro de Beyond3D](https://forum.beyond3d.com/showthread.php?t=47427).</span><span class="sxs-lookup"><span data-stu-id="08f11-385">Additionally, Andrew Lauritzen, co-author of the paper on VSMs, and author of a paper on LVSMs, discussed combining exponential shadow maps (ESMs) with VSMs to counteract light blending in a [Beyond3D Forum](https://forum.beyond3d.com/showthread.php?t=47427).</span></span>

## <a name="vsms-with-csms"></a><span data-ttu-id="08f11-386">VSMs con CSMs</span><span class="sxs-lookup"><span data-stu-id="08f11-386">VSMs with CSMs</span></span>

<span data-ttu-id="08f11-387">El VarianceShadow11 de ejemplo combina VSMs y CSMs.</span><span class="sxs-lookup"><span data-stu-id="08f11-387">The sample VarianceShadow11 combines VSMs and CSMs.</span></span> <span data-ttu-id="08f11-388">La combinación es bastante sencilla.</span><span class="sxs-lookup"><span data-stu-id="08f11-388">The combination is fairly straightforward.</span></span> <span data-ttu-id="08f11-389">El ejemplo sigue los mismos pasos que el ejemplo CascadedShadowMaps11.</span><span class="sxs-lookup"><span data-stu-id="08f11-389">The sample follows the same steps as the CascadedShadowMaps11 sample.</span></span> <span data-ttu-id="08f11-390">Dado que no se usa PCF, las sombras se desdibujan en una circunvolución separable de dos pasos.</span><span class="sxs-lookup"><span data-stu-id="08f11-390">Because PCF is not used, the shadows are blurred in a two-pass separable convolution.</span></span> <span data-ttu-id="08f11-391">El uso de PCF también permite que el ejemplo use matrices de textura en lugar de un Atlas de textura.</span><span class="sxs-lookup"><span data-stu-id="08f11-391">Not using PCF also enables the sample to use texture arrays instead of a texture atlas.</span></span> <span data-ttu-id="08f11-392">PCF en las matrices de textura es una característica de Direct3D 10,1.</span><span class="sxs-lookup"><span data-stu-id="08f11-392">PCF on texture arrays is a Direct3D 10.1 feature.</span></span>

### <a name="gradients-with-csms"></a><span data-ttu-id="08f11-393">Degradados con CSMs</span><span class="sxs-lookup"><span data-stu-id="08f11-393">Gradients with CSMs</span></span>

<span data-ttu-id="08f11-394">El uso de degradados con CSMs puede producir un límite a lo largo del borde entre dos cascadas, como se aprecia en la figura 17.</span><span class="sxs-lookup"><span data-stu-id="08f11-394">Using gradients with CSMs can produce a seam along the border between two cascades as seen in Figure 17.</span></span> <span data-ttu-id="08f11-395">La instrucción de ejemplo utiliza derivados entre píxeles para calcular información, como el nivel de mipmap, que necesita el filtro.</span><span class="sxs-lookup"><span data-stu-id="08f11-395">The sample instruction uses derivatives between pixels to calculate information, such as the mipmap level, needed by the filter.</span></span> <span data-ttu-id="08f11-396">Esto provoca un problema en particular para la selección de mipmap o el filtrado anisotrópico.</span><span class="sxs-lookup"><span data-stu-id="08f11-396">This causes a problem in particular for mipmap selection or anisotropic filtering.</span></span> <span data-ttu-id="08f11-397">Cuando los píxeles de una cuádruple toman ramas diferentes del sombreador, los derivados calculados por el hardware de la GPU no son válidos.</span><span class="sxs-lookup"><span data-stu-id="08f11-397">When pixels in a quad take different branches in the shader, the derivatives calculated by the GPU hardware are invalid.</span></span> <span data-ttu-id="08f11-398">Esto da como resultado un límite escalonado a lo largo de la instantánea.</span><span class="sxs-lookup"><span data-stu-id="08f11-398">This results in a jagged seam along the shadow map.</span></span>

<span data-ttu-id="08f11-399">**Figura 17. Costuras en los bordes en cascada debido al filtrado anisotrópico con control de flujo divergente**</span><span class="sxs-lookup"><span data-stu-id="08f11-399">**Figure 17. Seams on cascade borders due to anisotropic filtering with divergent flow control**</span></span>

![costuras en los bordes en cascada debido al filtrado anisotrópico con control de flujo divergente](images/seams-on-cascade-borders-due-to-anisotropic.jpg)

<span data-ttu-id="08f11-401">Este problema se resuelve calculando los derivados de la posición en el espacio de vista clara; la coordenada de espacio de la vista clara no es específica de la cascada seleccionada.</span><span class="sxs-lookup"><span data-stu-id="08f11-401">This problem is solved by computing the derivatives on the position in light-view space; the light-view space coordinate is not specific to the selected cascade.</span></span> <span data-ttu-id="08f11-402">Los derivados calculados se pueden escalar por la parte de la escala de la matriz de textura de proyección al nivel de mipmap adecuado.</span><span class="sxs-lookup"><span data-stu-id="08f11-402">The computed derivatives can be scaled by the scale portion of the projection-texture matrix to the correct mipmap level.</span></span>


```C++
        float3 vShadowTexCoordDDX = ddx( vShadowMapTextureCoordViewSpace );
        vShadowTexCoordDDX *= m_vCascadeScale[iCascade].xyz;
        float3 vShadowTexCoordDDY = ddy( vShadowMapTextureCoordViewSpace );
        vShadowTexCoordDDY *= m_vCascadeScale[iCascade].xyz;

        mapDepth += g_txShadow.SampleGrad( g_samShadow, vShadowTexCoord.xyz,
        vShadowTexCoordDDX, vShadowTexCoordDDY );
```



## <a name="vsms-compared-to-standard-shadows-with-pcf"></a><span data-ttu-id="08f11-403">VSMs en comparación con las sombras estándar con PCF</span><span class="sxs-lookup"><span data-stu-id="08f11-403">VSMs Compared to Standard Shadows with PCF</span></span>

<span data-ttu-id="08f11-404">Tanto VSMs como PCF intentan aproximar la fracción del área de píxeles que pasaría la prueba de profundidad.</span><span class="sxs-lookup"><span data-stu-id="08f11-404">Both VSMs and PCF attempt to approximate the fraction of pixel area that would pass the depth test.</span></span> <span data-ttu-id="08f11-405">VSMs trabajar con el hardware de filtrado y se puede desenfocar con kernels separables.</span><span class="sxs-lookup"><span data-stu-id="08f11-405">VSMs work with filtering hardware and can be blurred with separable kernels.</span></span> <span data-ttu-id="08f11-406">Los kernels de circunvolución separables son considerablemente más baratos de implementar que un kernel completo.</span><span class="sxs-lookup"><span data-stu-id="08f11-406">Separable convolution kernels are considerably cheaper to implement than a full kernel.</span></span> <span data-ttu-id="08f11-407">Además, VSMs compara una profundidad de espacio claro con un valor en el mapa de profundidad del espacio claro.</span><span class="sxs-lookup"><span data-stu-id="08f11-407">Additionally, VSMs compare one light-space depth against one value in the light-space depth map.</span></span> <span data-ttu-id="08f11-408">Esto significa que VSMs no tienen los mismos problemas de desplazamiento que PCF.</span><span class="sxs-lookup"><span data-stu-id="08f11-408">This means that VSMs do not have the same offset problems as PCF.</span></span> <span data-ttu-id="08f11-409">Técnicamente, VSMs son la profundidad de muestreo en un área mayor, así como la realización de un análisis estadístico.</span><span class="sxs-lookup"><span data-stu-id="08f11-409">Technically, VSMs are sampling depth over a greater area, as well as performing a statistical analysis.</span></span> <span data-ttu-id="08f11-410">Es menos preciso que PCF.</span><span class="sxs-lookup"><span data-stu-id="08f11-410">This is less precise than PCF.</span></span> <span data-ttu-id="08f11-411">En la práctica, VSMs realiza un trabajo muy bueno de la combinación, lo que hace que sea necesario un desplazamiento inferior.</span><span class="sxs-lookup"><span data-stu-id="08f11-411">In practice, VSMs do a very good job of blending, which results in less offset being necessary.</span></span> <span data-ttu-id="08f11-412">Tal y como se ha descrito anteriormente, el número uno de los inconvenientes de VSMs es la sangrado ligera.</span><span class="sxs-lookup"><span data-stu-id="08f11-412">As described above, the number one drawback to VSMs is light bleeding.</span></span>

<span data-ttu-id="08f11-413">VSMs y PCF representan un equilibrio entre la potencia de proceso de GPU y el ancho de banda de textura de GPU.</span><span class="sxs-lookup"><span data-stu-id="08f11-413">VSMs and PCF represent a trade-off between GPU compute power and GPU texture bandwidth.</span></span> <span data-ttu-id="08f11-414">VSMs requiere que se realicen más cálculos para calcular la varianza.</span><span class="sxs-lookup"><span data-stu-id="08f11-414">VSMs require more math to be performed to calculate the variance.</span></span> <span data-ttu-id="08f11-415">PCF requiere más ancho de banda de memoria de textura.</span><span class="sxs-lookup"><span data-stu-id="08f11-415">PCF requires more texture memory bandwidth.</span></span> <span data-ttu-id="08f11-416">Los kernels PCF grandes se pueden poner en cuellos de botella rápidamente en el ancho de banda de textura.</span><span class="sxs-lookup"><span data-stu-id="08f11-416">Large PCF kernels can quickly become bottlenecked by texture bandwidth.</span></span> <span data-ttu-id="08f11-417">Con la potencia de cálculo de GPU que crece más rápidamente que el ancho de banda de GPU, los VSMs se convierten en los dos algoritmos más prácticos.</span><span class="sxs-lookup"><span data-stu-id="08f11-417">With GPU computation power growing more rapidly than GPU bandwidth, VSMs are becoming the more practical of the two algorithms.</span></span> <span data-ttu-id="08f11-418">VSMs también es mejor con las sombras de resolución más bajas debido a la mezcla y el filtrado.</span><span class="sxs-lookup"><span data-stu-id="08f11-418">VSMs also look better with lower resolution shadow maps due to blending and filtering.</span></span>

## <a name="summary"></a><span data-ttu-id="08f11-419">Resumen</span><span class="sxs-lookup"><span data-stu-id="08f11-419">Summary</span></span>

<span data-ttu-id="08f11-420">CSMs ofrecen una solución al problema de los alias de perspectiva.</span><span class="sxs-lookup"><span data-stu-id="08f11-420">CSMs offer a solution to the perspective aliasing problem.</span></span> <span data-ttu-id="08f11-421">Hay varias configuraciones posibles para obtener la fidelidad visual necesaria para un título.</span><span class="sxs-lookup"><span data-stu-id="08f11-421">There are several possible configurations to get the needed visual fidelity for a title.</span></span> <span data-ttu-id="08f11-422">PCF y VSMs se usan ampliamente y deben combinarse con CSMs para reducir el alias.</span><span class="sxs-lookup"><span data-stu-id="08f11-422">PCF and VSMs are widely used and should be combined with CSMs to reduce aliasing.</span></span>

## <a name="references"></a><span data-ttu-id="08f11-423">Referencias</span><span class="sxs-lookup"><span data-stu-id="08f11-423">References</span></span>

<span data-ttu-id="08f11-424">Donnelly, [W. y](https://portal.acm.org/citation.cfm?doid=1111411.1111440)Lauritzen, a.</span><span class="sxs-lookup"><span data-stu-id="08f11-424">Donnelly, W. and Lauritzen, A. [Variance shadow maps](https://portal.acm.org/citation.cfm?doid=1111411.1111440).</span></span> <span data-ttu-id="08f11-425">En SI3D ' 06: procedimientos del 2006 Symposium en gráficos y juegos de 3D interactivos.</span><span class="sxs-lookup"><span data-stu-id="08f11-425">In SI3D '06: Proceedings of the 2006 symposium on Interactive 3D graphics and games.</span></span> <span data-ttu-id="08f11-426">2006.</span><span class="sxs-lookup"><span data-stu-id="08f11-426">2006.</span></span> <span data-ttu-id="08f11-427">PP. 161:165.</span><span class="sxs-lookup"><span data-stu-id="08f11-427">pp. 161–165.</span></span> <span data-ttu-id="08f11-428">Nueva York, NY, EE. UU.: ACM Press.</span><span class="sxs-lookup"><span data-stu-id="08f11-428">New York, NY, USA: ACM Press.</span></span>

<span data-ttu-id="08f11-429">Lauritzen, Andrew y McCool, Michael.</span><span class="sxs-lookup"><span data-stu-id="08f11-429">Lauritzen, Andrew and McCool, Michael.</span></span> <span data-ttu-id="08f11-430">[Mapas de sombras de varianza por capas](https://portal.acm.org/citation.cfm?id=1375714.1375739&coll=GUIDE&dl=GUIDE&CFID=45360327&CFTOKEN=34578992).</span><span class="sxs-lookup"><span data-stu-id="08f11-430">[Layered variance shadow maps](https://portal.acm.org/citation.cfm?id=1375714.1375739&coll=GUIDE&dl=GUIDE&CFID=45360327&CFTOKEN=34578992).</span></span> <span data-ttu-id="08f11-431">Procedimientos de la interfaz de gráficos 2008, de 28 a 30, 2008, Windsor, Ontario y Canadá.</span><span class="sxs-lookup"><span data-stu-id="08f11-431">Proceedings of graphics interface 2008, May 28–30, 2008, Windsor, Ontario, Canada.</span></span>

<span data-ttu-id="08f11-432">Engel, Woflgang F. sección 4.</span><span class="sxs-lookup"><span data-stu-id="08f11-432">Engel, Woflgang F. Section 4.</span></span> <span data-ttu-id="08f11-433">Mapas de instantáneas en cascada.</span><span class="sxs-lookup"><span data-stu-id="08f11-433">Cascaded Shadow Maps.</span></span> <span data-ttu-id="08f11-434">ShaderX5, técnicas de representación avanzadas, Wolfgang F. Engel, Ed.</span><span class="sxs-lookup"><span data-stu-id="08f11-434">ShaderX5 , Advanced Rendering Techniques, Wolfgang F. Engel, Ed.</span></span> <span data-ttu-id="08f11-435">Charles River media, Boston, Massachusetts.</span><span class="sxs-lookup"><span data-stu-id="08f11-435">Charles River Media, Boston, Massachusetts.</span></span> <span data-ttu-id="08f11-436">2006.</span><span class="sxs-lookup"><span data-stu-id="08f11-436">2006.</span></span> <span data-ttu-id="08f11-437">PP. 197:206.</span><span class="sxs-lookup"><span data-stu-id="08f11-437">pp. 197–206.</span></span>

 

 